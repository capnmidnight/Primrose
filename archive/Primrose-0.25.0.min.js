"use strict";function axis(t,e){var n=hub();return put(brick(16711680,t,e,e)).on(n),put(brick(65280,e,t,e)).on(n),put(brick(255,e,e,t)).on(n),n}function box(t,e,n){return void 0===e&&(e=t),void 0===n&&(n=t),cache("BoxGeometry("+t+", "+e+", "+n+")",function(){return new THREE.BoxGeometry(t,e,n)})}function brick(t,e,n,r){return textured(box(e||1,n||1,r||1),t,{txtRepeatS:e,txtRepeatT:r})}function clone(t){return JSON.parse(JSON.stringify(t))}function cloud(t,e,n){for(var r=new THREE.Geometry,i=0;i<t.length;++i)r.vertices.push(t[i]);var o=cache("PointsMaterial("+e+", "+n+")",function(){return new THREE.PointsMaterial({color:e,size:n})});return new THREE.Points(r,o)}function copyObject(t,e){for(var n=[{dest:t,source:e}];n.length>0;){var r=n.pop();e=r.source,t=r.dest;for(var i in e)e.hasOwnProperty(i)&&("object"!==_typeof(e[i])?t[i]=e[i]:(t[i]||(t[i]={}),n.push({dest:t[i],source:e[i]})))}}function cylinder(t,e,n,r,i,o,s,a){return void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===n&&(n=1),cache("CylinderGeometry("+t+", "+e+", "+n+", "+r+", "+i+", "+o+", "+s+", "+a+")",function(){return new THREE.CylinderGeometry(t,e,n,r,i,o,s,a)})}function emit(t,e){for(var n=this.listeners&&this.listeners[t]||this._listeners&&this._listeners[t],r=0;n&&r<n.length;++r)n[r](e)}function findProperty(t,e){for(var n=0;n<e.length;++n)if(void 0!==t[e[n]])return e[n]}function sigfig(t,e){var n=Math.pow(10,e),r=(Math.round(t*n)/n).toString();if(e>0){var i=r.indexOf(".");for(-1===i&&(r+=".",i=r.length-1);r.length-i-1<e;)r+="0"}return r}function getSetting(t,e){if(window.localStorage){var n=window.localStorage.getItem(t);if(n)try{return JSON.parse(n)}catch(r){console.error("getSetting",t,n,"undefined"==typeof n?"undefined":_typeof(n),r),console.error(r),console.error("getSetting",t,n,"undefined"==typeof n?"undefined":_typeof(n))}}return e}function setSetting(t,e){if(window.localStorage&&e)try{window.localStorage.setItem(t,JSON.stringify(e))}catch(n){console.error("setSetting",t,e,"undefined"==typeof e?"undefined":_typeof(e),n)}}function deleteSetting(t){window.localStorage&&window.localStorage.removeItem(t)}function readForm(t){var e={};if(t)for(var n in t){var r=t[n];"INPUT"!==r.tagName&&"SELECT"!==r.tagName||r.dataset&&r.dataset.skipcache||("text"===r.type||"password"===r.type||"SELECT"===r.tagName?e[n]=r.value:"checkbox"!==r.type&&"radio"!==r.type||(e[n]=r.checked))}return e}function writeForm(t,e){if(e)for(var n in t){var r=t[n];null===e[n]||void 0===e[n]||"INPUT"!==r.tagName&&"SELECT"!==r.tagName||r.dataset&&r.dataset.skipcache||("text"===r.type||"password"===r.type||"SELECT"===r.tagName?r.value=e[n]:"checkbox"!==r.type&&"radio"!==r.type||(r.checked=e[n]))}}function hub(){var t=new THREE.Object3D;return t.addToBrowserEnvironment=function(e,n){n.add(t),t.appendChild=function(n){return n.addToBrowserEnvironment?n.addToBrowserEnvironment(e,t):(t.add(n),e.registerPickableObject(n),n)}},t}function InsideSphereGeometry(t,e,n,r,i,o,s){THREE.Geometry.call(this),this.type="InsideSphereGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:n,phiStart:r,phiLength:i,thetaStart:o,thetaLength:s},t=t||50,e=Math.max(3,Math.floor(e)||8),n=Math.max(2,Math.floor(n)||6),r=void 0!==r?r:0,i=void 0!==i?i:2*Math.PI,o=void 0!==o?o:0,s=void 0!==s?s:Math.PI;var a,u,c=[],l=[];for(u=0;n>=u;u++){var h=[],d=[];for(a=e;a>=0;a--){var f=a/e,m=u/n,p=new THREE.Vector3;p.x=-t*Math.cos(r+f*i)*Math.sin(o+m*s),p.y=t*Math.cos(o+m*s),p.z=t*Math.sin(r+f*i)*Math.sin(o+m*s),this.vertices.push(p),h.push(this.vertices.length-1),d.push(new THREE.Vector2(1-f,1-m))}c.push(h),l.push(d)}for(u=0;n>u;u++)for(a=0;e>a;a++){var y=c[u][a+1],g=c[u][a],v=c[u+1][a],b=c[u+1][a+1],x=this.vertices[y].clone().normalize(),w=this.vertices[g].clone().normalize(),E=this.vertices[v].clone().normalize(),P=this.vertices[b].clone().normalize(),_=l[u][a+1].clone(),C=l[u][a].clone(),T=l[u+1][a].clone(),R=l[u+1][a+1].clone();Math.abs(this.vertices[y].y)===t?(_.x=(_.x+C.x)/2,this.faces.push(new THREE.Face3(y,v,b,[x,E,P])),this.faceVertexUvs[0].push([_,T,R])):Math.abs(this.vertices[v].y)===t?(T.x=(T.x+R.x)/2,this.faces.push(new THREE.Face3(y,g,v,[x,w,E])),this.faceVertexUvs[0].push([_,C,T])):(this.faces.push(new THREE.Face3(y,g,b,[x,w,P])),this.faceVertexUvs[0].push([_,C,R]),this.faces.push(new THREE.Face3(g,v,b,[w.clone(),E,P.clone()])),this.faceVertexUvs[0].push([C.clone(),T,R.clone()]))}this.computeFaceNormals();for(var k=0;k<this.faces.length;++k){var M=this.faces[k];M.normal.multiplyScalar(-1);for(var S=0;S<M.vertexNormals.length;++S)M.vertexNormals[S].multiplyScalar(-1)}this.boundingSphere=new THREE.Sphere(new THREE.Vector3,t)}function light(t,e,n,r){return new THREE.PointLight(t,e,n,r)}function overwrite(t,e){t=t||{};for(var n in e)t[n]=e[n];return t}function patch(t,e){t=t||{};for(var n in e)void 0!==t[n]&&null!==t[n]||(t[n]=e[n]);return t}function put(t){var e=function(e,n,r){return t.position.set(e,n,r),t},n=function(n,r,i){return t.rotation.set(n,r,i),{at:e}};return{on:function(r){return r.add(t),{at:e,rot:n}}}}function quad(t,e,n,r){return void 0===e&&(e=t),cache("PlaneBufferGeometry("+t+", "+e+", "+n+", "+r+")",function(){return new THREE.PlaneBufferGeometry(t,e,n,r)})}function range(t,e,n,r){for(var i=n&&t||0,o=n&&e||t,s=r&&n||1,a=r||n||e,u=i;o>u;u+=s)a(u)}function shell(t,e,n,r,i){var o=.45;void 0===r&&(r=Math.PI*o),void 0===i&&(i=Math.PI*o*.6);var s=1.5*Math.PI-.5*r,a=.5*(Math.PI-i);return cache("InsideSphereGeometry("+t+", "+e+", "+n+", "+r+", "+i+")",function(){return new InsideSphereGeometry(t,e,n,s,r,a,i,!0)})}function sphere(t,e,n){return cache("SphereGeometry("+t+", "+e+", "+n+")",function(){return new THREE.SphereGeometry(t,e,n)})}function v3(t,e,n){return new THREE.Vector3(t,e,n)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var setFalse=function(t){return t.returnValue=!1};window.Primrose=function(){var t={};return t.Controls={},t.DOM={},t.HTTP={},t.Input={},t.Network={},t.Output={},t.Random={},t.Text={},t.Text.CodePages={},t.Text.CommandPacks={},t.Text.Controls={},t.Text.Grammars={},t.Text.OperatingSystems={},t.Text.Renderers={},t.Text.Themes={},t.X={},t.SYS_FONTS="-apple-system, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif",t.SKINS=["#FFDFC4","#F0D5BE","#EECEB3","#E1B899","#E5C298","#FFDCB2","#E5B887","#E5A073","#E79E6D","#DB9065","#CE967C","#C67856","#BA6C49","#A57257","#F0C8C9","#DDA8A0","#B97C6D","#A8756C","#AD6452","#5C3836","#CB8442","#BD723C","#704139","#A3866A","#870400","#710101","#430000","#5B0001","#302E2E"],t.SKIN_VALUES=t.SKINS.map(function(t){return parseInt(t.substring(1),16)}),window.isInIFrame=window.self!==window.top,window.isGearVR=navigator.userAgent.indexOf("Mobile VR")>-1,window.isiOS=/iP(hone|od|ad)/.test(navigator.userAgent||""),window.isOSX=/Macintosh/.test(navigator.userAgent||""),window.isWindows=/Windows/.test(navigator.userAgent||""),window.isOpera=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,window.isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,window.isChrome=!!window.chrome&&!window.isOpera,window.isFirefox="undefined"!=typeof window.InstallTrigger,window.isWebKit=window.isiOS||window.isOpera||window.isChrome,window.isIE=!!document.documentMode,t.RESOLUTION_SCALES=[.5,.25,.333333,.5,1],isMobile||t.RESOLUTION_SCALES.push(2),t.Quality={NONE:0,VERYLOW:1,LOW:2,MEDIUM:3,HIGH:4,MAXIMUM:t.RESOLUTION_SCALES.length-1},t}();var cache=function(){var t={};return function(e,n){return t[e]||(t[e]=n()),t[e]}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},fmt=function(){function t(t,e){return e.replace(/( AM| PM|$)/,function(e,n){return(t.getMilliseconds()/1e3).toString().substring(1)+n})}function e(e){var r=arguments;return"string"!=typeof e&&(e=e.toString()),e.replace(n,function(e,n,i,o){if(i=parseInt(i,10),i>=0&&i<r.length){var s=r[i];if(null!==s&&void 0!==s){if(s instanceof Date&&o){switch(o.length){case 1:s=s.getYear()+1900;break;case 2:s=s.getMonth()+1+"/"+(s.getYear()+1900);break;case 3:s=s.toLocaleDateString();break;case 4:s=t(s,s.toLocaleTimeString());break;case 5:case 6:s=s.toLocaleString();break;default:s=t(s,s.toLocaleString())}return s}if(s=o&&o.length>0?sigfig(s,o.length):s.toString(),n&&n.length>0)for(var a=new RegExp("^\\d{"+(n.length+1)+"}(\\.\\d+)?");!a.test(s);)s="0"+s;return s}}})}var n=/\$(0*)(\d+)(?:\.(0+))?/g;return e}(),px=fmt.bind(void 0,"$1px"),pct=fmt.bind(void 0,"$1%"),ems=fmt.bind(void 0,"$1em"),rems=fmt.bind(void 0,"$1rem"),vws=fmt.bind(void 0,"$1vw"),rgb=fmt.bind(void 0,"rgb($1, $2, $3)"),rgba=fmt.bind(void 0,"rgba($1, $2, $3, $4)"),hsl=fmt.bind(void 0,"hsl($1, $2%, $3%)"),hsla=fmt.bind(void 0,"hsla($1, $2%, $3%, $4)"),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};"undefined"!=typeof window.THREE&&(InsideSphereGeometry.prototype=Object.create(THREE.Geometry.prototype),InsideSphereGeometry.prototype.constructor=InsideSphereGeometry);var textured=function(){function t(t,e,r){r=r||{},void 0===r.opacity&&(r.opacity=1),void 0===r.txtRepeatS&&(r.txtRepeatS=1),void 0===r.txtRepeatT&&(r.txtRepeatT=1),void 0===r.roughness&&(r.roughness=.5),void 0===r.metalness&&(r.metalness=0),r.unshaded=!!r.unshaded,r.wireframe=!!r.wireframe;var i=null;if(e instanceof THREE.Material)i=e,e=null;else{var o=(e.id||e).toString(),s="Primrose.textured("+o+", "+r.txtRepeatS+", "+r.txtRepeatT+")",a="Primrose.material("+s+", "+r.unshaded+", "+r.opacity+", "+r.roughness+", "+r.metalness+", "+r.wireframe+", "+r.emissive+")";i=cache(a,function(){var t={transparent:r.opacity<1,opacity:r.opacity,side:THREE.DoubleSide},e=THREE.MeshStandardMaterial;return r.unshaded?(t.shading=THREE.FlatShading,e=THREE.MeshBasicMaterial):(t.roughness=r.roughness,t.metalness=r.metalness,void 0!==r.emissive&&(t.emissive=r.emissive)),new e(t)})}i.wireframe=r.wireframe;var u=null;if(t.type.indexOf("Geometry")>-1?u=new THREE.Mesh(t,i):t instanceof THREE.Object3D&&(u=t,u.material=i),"number"==typeof e||e instanceof Number)i.color.set(e);else if(e){i.color.set(16777215);var c=function(e){var o;if(e instanceof Primrose.Surface&&(o=e,e=o.texture,!r.scaleTextureWidth||!r.scaleTextureHeight)){var a=o.imageWidth,u=o.imageHeight,c=Math.ceil(Math.log(a)/Math.LN2),l=Math.ceil(Math.log(u)/Math.LN2),h=Math.pow(2,c),d=Math.pow(2,l),f=a/h,m=u/d;1===f&&1===m||(1!==f&&(r.scaleTextureWidth=f),1!==m&&(r.scaleTextureHeight=m),o.bounds.width=h,o.bounds.height=d,o.resize(),o.render(!0))}if(r.txtRepeatS*r.txtRepeatT>1&&(e.wrapS=e.wrapT=THREE.RepeatWrapping,e.repeat.set(r.txtRepeatS,r.txtRepeatT)),r.scaleTextureWidth||r.scaleTextureHeight)if(t.attributes&&t.attributes.uv&&t.attributes.uv.array){var p,y=t.attributes.uv,g=y.array;if(r.scaleTextureWidth)for(p=0;p<g.length;p+=y.itemSize)g[p]*=r.scaleTextureWidth;if(r.scaleTextureHeight)for(p=1;p<g.length;p+=y.itemSize)g[p]=1-(1-g[p])*r.scaleTextureHeight}else console.trace(t);n[s]=e,i.map=e,i.needsUpdate=!0,e.needsUpdate=!0};n[s]?c(n[s]):e instanceof Primrose.Surface?(e._material=i,Primrose.Entity.registerEntity(e),c(e),u.surface=e):"string"==typeof e?Primrose.loadTexture(e).then(c)["catch"](console.error.bind(console,"Error loading texture",e)):c(e instanceof Primrose.Text.Controls.TextBox?e.renderer.texture:e instanceof HTMLCanvasElement?new THREE.Texture(e):e)}return u}var e=null,n={};return Primrose.loadTexture=function(t){return e||(e=new THREE.TextureLoader),e.setCrossOrigin(THREE.ImageUtils.crossOrigin),cache("Image("+t+")",function(){return new Promise(function(n,r){return e.load(t,n,null,r)})})},t}();Primrose.Angle=function(){function t(t){if("number"!=typeof t)throw new Error("Angle must be initialized with a number. Initial value was: "+t);var e,n,r,i=t,o=0;Object.defineProperty(this,"degrees",{set:function(t){do e=t+o-i,n=Math.abs(e+360),r=Math.abs(e-360),e=Math.abs(e),e>n&&r>n?o+=360:e>r&&(o-=360);while(e>n||e>r);i=t+o},get:function(){return i}})}var e=Math.PI/180,n=180/Math.PI;return Object.defineProperty(t.prototype,"radians",{get:function(){return this.degrees*e},set:function(t){this.degrees=t*n}}),t}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.BaseControl=function(){var t=1,e="([+-]?(?:(?:\\d+(?:\\.\\d*)?)|(?:\\.\\d+)))",n="\\s*,\\s*",r="(?:em|px)",i=new RegExp("translate3d\\s*\\(\\s*"+e+r+n+e+r+n+e+r+"\\s*\\)","i"),o=new RegExp("rotate3d\\s*\\(\\s*"+e+n+e+n+e+n+e+"rad\\s*\\)","i"),s=function(){function e(){_classCallCheck(this,e),this.controlID=t++,this.focused=!1,this.listeners={focus:[],blur:[]}}return _createClass(e,[{key:"addEventListener",value:function(t,e){this.listeners[t]&&this.listeners[t].push(e)}},{key:"focus",value:function(){this.focused=!0,emit.call(this,"focus",{target:this})}},{key:"blur",value:function(){this.focused=!1,emit.call(this,"blur",{target:this})}},{key:"copyElement",value:function(t){if(this.element=t,t.style.transform){var e=i.exec(t.style.transform);e&&this.position.set(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])),e=o.exec(t.style.transform),e&&this.quaternion.setFromAxisAngle((new THREE.Vector3).set(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])),parseFloat(e[4]))}}}]),e}();return s}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.BrowserEnvironment=function(){function t(t){var e=t.position.clone();for(t=t.parent;null!==t;)e.applyMatrix4(t.matrix),t=t.parent;return e.toArray()}if("undefined"==typeof THREE)return function(){};var e=.001,n=new THREE.Vector3(1,0,0),r=new THREE.Vector3(0,1,0),i=new THREE.Vector3(0,0,-1),o=.02,s=10,a=["keydown","keyup","keypress","mousedown","mouseup","mousemove","wheel","touchstart","touchend","touchmove"],u=function(){function u(c,l){function h(t){for(var e="",n=0;n<t.length;++n)n>0&&(e+=","),e+=t[n];return e}function d(t){var e=t.clone(),n=e.getHSL();for(n.h=n.h+.5,n.l=1-n.l;n.h>1;)n.h-=1;return e.setHSL(n.h,n.s,n.l),e}var f=this;_classCallCheck(this,u),this.options=patch(l,u.DEFAULTS);var m=emit.bind(this);this.addEventListener=function(t,e,n){f.listeners[t]?f.listeners[t].push(e):a.indexOf(t)>=0&&window.addEventListener(t,e,n)};var p=function(){return f.currentControl&&f.currentControl.lockMovement};this.zero=function(){p()||(f.player.position.set(0,f.avatarHeight,0),f.player.velocity.set(0,0,0),f.input.zero(),f.quality===Primrose.Quality.NONE&&(f.quality=Primrose.Quality.HIGH))};var y=function(t,e){var n=t;"Object3D"!==t.type&&"Group"!==t.type||!t.children[0]||(n=t.children[0],n.name=n.name||t.name);for(var r,i=n.uuid,o=new THREE.Matrix4,s=(new THREE.Matrix4).identity(),a=!1,u=g[i],c=!1,l=!!t.disabled,d={uuid:i,name:null,inScene:null,visible:null,disabled:null,matrix:null,geometry:null},m=n;null!==m;)m.updateMatrix(),o.copy(m.matrix),o.multiply(s),r=o,o=s,s=r,m=m.parent,a=a||m===f.scene;u&&u.visible===t.visible||(c=!0,d.visible=t.visible),u&&u.disabled===l||(c=!0,d.disabled=l);var p=s.elements.subarray(0,s.elements.length),y=h(p);if(u&&u.matrix&&h(u.matrix)===y||(c=!0,d.matrix=p),u&&u.inScene===a||(c=!0,d.inScene=a),e===!0&&(c=!0,d.name=t.name,d.geometry=n.geometry),c){if(u)for(var v in d)u[v]=d[v];else g[i]=d;return d}},g={};this.registerPickableObject=function(t){if(t){var e,n,r,i,o=y(t,!0),s=o.geometry;if(s instanceof THREE.BufferGeometry){var a=s.attributes,u=a.position,c=a.uv,l=a.index;for(e=[],n=[],c&&(r=[]),i=0;i<u.count;++i)e.push([u.getX(i),u.getY(i),u.getZ(i)]),c&&r.push([c.getX(i),c.getY(i)]);if(l)for(i=0;i<l.count-2;++i)n.push([l.getX(i),l.getX(i+1),l.getX(i+2)]);else for(i=0;i<u.count;i+=3)n.push([i,i+1,i+2])}else for(e=s.vertices.map(function(t){return t.toArray()}),n=[],r=[],i=0;i<s.faces.length;++i){var h=s.faces[i],d=s.faceVertexUvs[0][i];n.push([h.a,h.b,h.c]),r[h.a]=[d[0].x,d[0].y],r[h.b]=[d[1].x,d[1].y],r[h.c]=[d[2].x,d[2].y]}o.geometry={uuid:s.uuid,vertices:e,faces:n,uvs:r},f.pickableObjects[o.uuid]=t,f.projector.setObject(o)}};var v=function(t){var e=t-I;I=t,b(e),x(),w(),E(),C(),Et(),m("update",e)},b=function(t){f.input.update();var e=f.input.getValue("heading"),i=f.input.getValue("pitch"),o=f.input.getValue("strafe"),s=f.input.getValue("drive");if(f.input.VR.getOrientation(H),F.setFromAxisAngle(n,i),f.player.isOnGround?p()||(f.player.velocity.set(o,0,s).normalize().multiplyScalar(f.walkSpeed),D.setFromAxisAngle(r,A),f.player.velocity.applyQuaternion(H),f.player.velocity.y=0,f.player.velocity.applyQuaternion(D)):f.player.velocity.y-=f.options.gravity*t,f.player.position.add(j.copy(f.player.velocity).multiplyScalar(t)),!f.player.isOnGround&&f.player.position.y<f.avatarHeight&&(f.player.isOnGround=!0,f.player.position.y=f.avatarHeight,f.player.velocity.y=0),f.inVR){var a=e-A;if(!p()&&Math.abs(a)>Math.PI/5){var u=Math.sign(a)*Math.PI/100;A+=u,e-=u,a=e-A}f.player.quaternion.setFromAxisAngle(r,A),D.setFromAxisAngle(r,a).multiply(F)}else A=e,f.player.quaternion.setFromAxisAngle(r,A),f.player.quaternion.multiply(F)},x=function(){f.sky&&f.sky.position.copy(f.player.position)},w=function(){f.ground&&(f.ground.position.set(Math.floor(f.player.position.x),0,Math.floor(f.player.position.z)),f.ground.material.needsUpdate=!0)},E=function(){f.pointer.position.copy(i),f.inVR&&!isMobile&&f.pointer.position.applyQuaternion(D),p()&&!isMobile||(f.pointer.position.add(f.camera.position),f.pointer.position.applyQuaternion(f.camera.quaternion)),f.pointer.position.applyQuaternion(f.player.quaternion),f.pointer.position.add(f.player.position)},P=function(t){if("keyboard"!==t||!p())if(N){var e=f.pickableObjects[N.objectID];if(e){var n=e.button||e.surface;m("pointerstart",N),emit.call(e,"click"),f.currentControl&&f.currentControl!==n&&(f.currentControl.blur(),f.currentControl=null),!f.currentControl&&n?(f.currentControl=n,f.currentControl.focus()):e===f.ground&&(f.player.position.copy(f.pointer.position),f.player.position.y=f.avatarHeight,f.player.isOnGround=!1),f.currentControl&&f.currentControl.startUV(N.point)}}else f.currentControl&&(f.currentControl.blur(),f.currentControl=null)},_=function(t){if(("keyboard"!==t||!p())&&N){var e=f.pickableObjects[N.objectID];if(e){e.button||e.surface;m("pointerend",L),f.currentControl&&f.currentControl.endPointer()}}},C=function(){if(f.projector.ready){f.projector.ready=!1;var e=[],n=[];for(var r in f.pickableObjects){var i=f.pickableObjects[r],a=y(i);
a&&(e.push(a),a.inScene===!1&&n.push(r))}e.length>0&&f.projector.updateObjects(e);for(var u=0;u<n.length;++u)delete f.pickableObjects[n[u]];f.projector.projectPointer([f.pointer.position.toArray(),t(f.player)])}var c=f.input.getValue("dButtons");if(N){var l=N.facePoint,h=N.faceNormal,d=f.pickableObjects[N.objectID];if(f.pointer.position.set(l[0]+h[0]*o,l[1]+h[1]*o,l[2]+h[2]*o),d===f.ground?f.pointer.scale.set(.5*s,s,.5*s):f.pointer.scale.set(.5,1,.5),f.pointer.material.color.setRGB(0,1,0),f.pointer.material.emissive.setRGB(.25,.25,.25),d){var g=f.input.getValue("buttons"),v=0!==c;d.button||d.surface;p()||(g|=f.input.Keyboard.getValue("select"),v=v||0!==f.input.Keyboard.getValue("dSelect")),!v&&g>0&&(L&&N&&L.objectID===N.objectID&&m("pointermove",N),f.currentControl&&N.point&&f.currentControl.moveUV(N.point))}}else f.pointer.material.color.setRGB(1,0,0),f.pointer.material.emissive.setRGB(.25,0,0),f.pointer.scale.set(1,1,1)},T=function _t(t){WebVRBootstrapper.dispalyPresentChangeCheck(),it(_t),v(t*e),M()},R=0,k=!1,M=function(){if(f.inVR&&f.input.VR.currentPose){f.renderer.clear(!0,!0,!0);for(var t=f.input.VR.transforms,e=0;t&&e<t.length;++e){var n=t[e],r=n.viewport,i=2*e-1;Primrose.Entity.eyeBlankAll(e),f.input.getVector3("headX","headY","headZ",f.camera.position),f.camera.projectionMatrix.copy(n.projection),z.set(0,0,0),z.applyMatrix4(n.translation),z.applyQuaternion(H),f.camera.position.add(z),f.camera.quaternion.copy(H),f.options.useNose&&(f.nose.visible=!0,f.nose.position.set(i*-.12,-.12,-.15),f.nose.rotation.z=.7*i),f.renderer.setViewport(r.left*X,r.top*X,r.width*X,r.height*X),f.renderer.render(f.scene,f.camera)}f.input.VR.currentDisplay.submitFrame(f.input.VR.currentPose)}isMobile||f.audio.setPlayer(f.camera),(!f.inVR||f.input.VR.currentDisplay.capabilities.hasExternalDisplay&&!f.options.disableMirroring)&&(k&&(R=1-R,Primrose.Entity.eyeBlankAll(R)),f.nose.visible=!1,f.camera.fov=f.options.defaultFOV,f.camera.aspect=f.renderer.domElement.width/f.renderer.domElement.height,f.camera.updateProjectionMatrix(),f.camera.position.set(0,0,0),f.camera.quaternion.copy(H),f.renderer.clear(!0,!0,!0),f.renderer.setViewport(0,0,f.renderer.domElement.width,f.renderer.domElement.height),f.renderer.render(f.scene,f.camera))},S=function(){if(ct()){var t=screen.orientation&&screen.orientation.type||screen.mozOrientation||"";-1===t.indexOf("landscape")&&(t="landscape-primary"),screen.orientation&&screen.orientation.lock?screen.orientation.lock(t):screen.mozLockOrientation&&screen.mozLockOrientation(t)}else screen.orientation&&screen.orientation.unlock?screen.orientation.unlock():screen.mozUnlockOrientation&&screen.mozUnlockOrientation()},O=function(){f.input.VR.resetTransforms(f.options.nearPlane,f.options.nearPlane+f.options.drawDistance);for(var t=f.input.VR.transforms,e=0,n=0,r=0;r<t.length;++r)e+=t[r].viewport.width,n=Math.max(n,t[r].viewport.height);e=Math.floor(e*X),n=Math.floor(n*X),f.renderer.domElement.width=e,f.renderer.domElement.height=n,f.timer||M()},I=0,L=null,N=null,A=0,F=new THREE.Quaternion,D=new THREE.Quaternion,H=new THREE.Quaternion,z=new THREE.Vector3,j=new THREE.Vector3,V=Primrose.Random.item(Primrose.SKIN_VALUES),B={monitor:this.options.fullScreenIcon,cardboard:null,scene:this.options.sceneModel,button:this.options.button&&"string"==typeof this.options.button.model&&this.options.button.model,font:this.options.font},G=null,U=null,W={"Standard Monitor":null},X=1,Y={button:Primrose.Controls.Button2D,img:Primrose.Controls.Image,div:Primrose.Controls.HtmlDoc,section:Primrose.Surface,textarea:Primrose.Text.Controls.TextBox,pre:{create:function(){return new Primrose.Text.Controls.TextBox({tokenizer:Primrose.Text.Grammars.PlainText,hideLineNumbers:!0,readOnly:!0})}}};this.createElement=function(t){return Y[t]?Y[t].create():void 0},this.appendChild=function(t){return t instanceof THREE.Mesh?(f.scene.add(t),void f.registerPickableObject(t)):t.addToBrowserEnvironment(f,f.scene)},Primrose.Input.VR.Version>0&&(B.cardboard=this.options.VRIcon);var K=function(t,e,n){var r=hub();r.add(t),t.position.z=-1,put(r).on(f.scene).at(0,f.options.avatarHeight,0);var i=75/n.length;r.rotation.set(0,Math.PI*i*(.5*(n.length-1)-e)/180,0),f.registerPickableObject(t)},q=function(t,e){var n=!(t instanceof StandardMonitorPolyfill),r=(W[t.displayName]||W["Google Cardboard"]).clone(),i=r.children[0]&&r.children[0].geometry||r.geometry,o=textured(text3D(.05,t.displayName),G),s=textured(text3D(.05,n?"VR":"Fullscreen"),G);return r.name=(t.displayName+"Icon").replace(/ /g,""),r.addEventListener("click",f.goFullScreen.bind(f,e),!1),i.computeBoundingBox(),put(s).on(r).rot(0,90*Math.PI/180,0).at(0,i.boundingBox.max.y+.01,s.geometry.boundingSphere.radius),put(o).on(r).rot(0,90*Math.PI/180,0).at(0,i.boundingBox.min.y-o.geometry.boundingBox.max.y-.01,o.geometry.boundingSphere.radius),put(r).on(f.scene).rot(0,270*Math.PI/180,0),f.registerPickableObject(r),r},Q=Primrose.ModelLoader.loadObjects(B).then(function(t){window.text3D=function(t,e,n){var r=new THREE.TextGeometry(n,{font:t,size:e,height:e/5,curveSegments:2});return r.computeBoundingSphere(),r.computeBoundingBox(),r}.bind(window,t.font),t.scene&&rt(t.scene),G=d(new THREE.Color(f.options.backgroundColor)).getHex(),t.monitor&&(W["Standard Monitor"]=new Primrose.ModelLoader(t.monitor)),t.cardboard?W["Google Cardboard"]=new Primrose.ModelLoader(t.cardboard):W["Google Cardboard"]=brick(16777215,.1,.1,.1),W["Test Icon"]=W["Oculus Rift DK2, Oculus VR"]=W["Device Motion API"]=W["Google, Inc. Cardboard v1"]=W["Google Cardboard"],U=(f.input.VR&&f.input.VR.displays||[{displayName:"Test Icon"}]).map(q),U.forEach(K),t.button?f.buttonFactory=new Primrose.ButtonFactory(t.button,f.options.button.options):f.buttonFactory=new Primrose.ButtonFactory(brick(16711680,1,1,1),{maxThrow:.1,minDeflection:10,colorUnpressed:8323072,colorPressed:32512,toggle:!0})})["catch"](function(t){console.error(t),f.buttonFactory||(f.buttonFactory=new Primrose.ButtonFactory(brick(16711680,1,1,1),{maxThrow:.1,minDeflection:10,colorUnpressed:8323072,colorPressed:32512,toggle:!0}))});this.currentControl=null,this.avatarHeight=this.options.avatarHeight,this.walkSpeed=this.options.walkSpeed,this.listeners={ready:[],update:[],gazestart:[],gazecomplete:[],gazecancel:[],pointerstart:[],pointermove:[],pointerend:[]},this.audio=new Primrose.Output.Audio3D;var Z=null,$=null;Z=this.options.ambientSound&&!isMobile?this.audio.load3DSound(this.options.ambientSound,!0,-1,1,-1).then(function(t){$=t,$.source instanceof MediaElementAudioSourceNode||($.volume.gain.value=.1,console.log($.source),$.source.start())})["catch"](console.error.bind(console,"Audio3D loadSource")):Promise.resolve();var J=null;J="complete"===document.readyState?Promise.resolve():new Promise(function(t,e){document.addEventListener("readystatechange",function(e){"complete"===document.readyState&&t()},!1)});var tt=Promise.all([Q,Z,J]);if(this.music=new Primrose.Output.Music(this.audio.context),this.pickableObjects={},this.projector=new Primrose.Workerize(Primrose.Projector),this.player=new THREE.Object3D,this.player.velocity=new THREE.Vector3,this.player.name="Player",this.player.position.set(0,this.avatarHeight,0),this.player.isOnGround=!0,this.pointer=textured(sphere(o,10,10),16711680,{emissive:4128768,opacity:.75}),this.nose=textured(sphere(.05,10,10),V),this.nose.name="Nose",this.nose.scale.set(.5,1,1),this.scene=this.options.scene||new THREE.Scene,this.options.useFog&&(this.scene.fog=new THREE.FogExp2(this.options.backgroundColor,2/this.options.drawDistance)),this.camera=new THREE.PerspectiveCamera(75,1,this.options.nearPlane,this.options.nearPlane+this.options.drawDistance),this.options.skyTexture&&(this.sky=textured(shell(this.options.drawDistance,18,9,2*Math.PI,Math.PI),this.options.skyTexture,{unshaded:!0}),this.sky.name="Sky",this.scene.add(this.sky)),this.options.groundTexture){var et=10,nt=new THREE.PlaneGeometry(5*et,5*et,et,et);this.ground=textured(nt,this.options.groundTexture,{txtRepeatS:5*et,txtRepeatT:5*et}),this.ground.rotation.x=-Math.PI/2,this.ground.name="Ground",this.scene.add(this.ground),this.registerPickableObject(this.ground)}this.camera.add(this.nose),this.player.add(this.camera),this.scene.add(this.player),this.scene.add(this.pointer),this.passthrough&&this.camera.add(this.passthrough.mesh);var rt=function(t){return t.buttons=[],t.traverse(function(e){e.isButton&&t.buttons.push(new Primrose.Controls.Button3D(e.parent,e.name)),e.name&&(t[e.name]=e)}),f.scene.add.apply(f.scene,t.children),f.scene.traverse(function(t){t.name&&(f.scene[t.name]=t)}),t.Camera&&(f.camera.position.copy(t.Camera.position),f.camera.quaternion.copy(t.Camera.quaternion)),t};put(light(16777215,1.5,50)).on(this.scene).at(0,10,10);var it=function(t){f.timer=f.input.VR.currentDisplay.requestAnimationFrame(t)};this.start=function(){tt.then(function(){f.audio.start(),I=performance.now()*e,it(T)})},this.stop=function(){f.input.VR.currentDisplay.cancelAnimationFrame(f.timer),f.audio.stop(),f.timer=null};var ot=function(t){var e;f.projector.ready=!0,L=N,N=t,L&&N&&L.objectID===N.objectID?(N.startTime=L.startTime,N.gazeFired=L.gazeFired,e=I-N.startTime,e>=f.options.gazeLength&&!N.gazeFired&&(N.gazeFired=!0,m("gazecomplete",N))):(L&&(e=I-L.startTime,e<f.options.gazeLength&&m("gazecancel",L)),N&&(N.startTime=I,N.gazeFired=!1,m("gazestart",N)))},st=function(t){if(p()||t.shiftKey||t.ctrlKey||t.altKey||t.metaKey){if(f.currentControl){var e=f.currentControl.focusedElement;if(e)if(e.execCommand){var n=f.operatingSystem._deadKeyState;e.execCommand(f._browser,f.codePage,f.operatingSystem.makeCommandName(t,f.codePage))&&t.preventDefault(),f.operatingSystem._deadKeyState===n&&(f.operatingSystem._deadKeyState="")}else e.keyDown(t)}}else t.keyCode===Primrose.Keys.E&&(k=!0,t.preventDefault())},at=function(t){f.currentControl&&f.currentControl.keyUp?f.currentControl.keyUp(t):t.shiftKey||t.ctrlKey||t.altKey||t.metaKey||t.keyCode===Primrose.Keys.E&&(k=!1)};this.goFullScreen=function(t){return ht(),f.input.VR.connect(t),f.input.VR.requestPresent([{source:f.renderer.domElement}]).then(function(t){if(1===Primrose.Input.VR.Version&&isMobile){var e=function r(){f.input.VR.currentDisplay.exitPresent(),window.removeEventListener("vrdisplaypresentchange",r)},n=function i(){window.addEventListener("vrdisplaypresentchange",e,!1),window.removeEventListener("vrdisplaypresentchange",i)};window.addEventListener("vrdisplaypresentchange",n,!1)}return t})};var ut=function(){console.log(ct()),U.forEach(function(t){t.visible=!ct(),t.disabled=ct()})};isMobile?(WebVRBootstrapper.Version>=1&&window.addEventListener("vrdisplaypresentchange",function(t){window.VRDisplay&&f.input.VR.currentDisplay instanceof VRDisplay&&(S(),ut())},!1),FullScreen.addChangeListener(function(t){window.VRDisplay&&f.input.VR.currentDisplay instanceof VRDisplay||(S(),ut())},!1)):window.addEventListener("vrdisplaypresentchange",ut,!1),Primrose.Input.Mouse.Lock.addChangeListener(function(t){Primrose.Input.Mouse.Lock.isActive||f.input.VR.currentDisplay.exitPresent()},!1),window.addEventListener("vrdisplaypresentchange",O,!1),FullScreen.addChangeListener(O,!1);var ct=function(){return FullScreen.isActive||f.input.VR.currentDisplay.isPresenting};u.createSurrogate.call(this),this.operatingSystem=this.options.os,this.codePage=this.options.language;var lt=function(t){var e=f.operatingSystem.makeCommandName(t,f.codePage);"CUT"!==e&&"COPY"!==e||(f._surrogate.style.display="block",f._surrogate.focus())},ht=function(){return(Primrose.Input.Mouse.Lock.isActive||isMobile?Promise.resolve():Primrose.Input.Mouse.Lock.request(f.renderer.domElement)).then(dt)},dt=function(){!ct()&&isMobile&&f.goFullScreen(1)},ft=function(t){return function(e){f.currentControl&&(f.currentControl[t]?f.currentControl[t](e):console.warn("Couldn't find %s on %o",t,f.currentControl))}};this._browser=isChrome?"CHROMIUM":isFirefox?"FIREFOX":isIE?"IE":isOpera?"OPERA":isSafari?"SAFARI":"UNKNOWN",window.addEventListener("keydown",st,!1),window.addEventListener("keyup",at,!1),window.addEventListener("keydown",lt,!0),window.addEventListener("beforepaste",setFalse,!1),window.addEventListener("paste",ft("readClipboard"),!1),window.addEventListener("wheel",ft("readWheel"),!1),window.addEventListener("resize",O,!1),window.addEventListener("blur",this.stop,!1),window.addEventListener("focus",this.start,!1),this.projector.addEventListener("hit",ot,!1),J.then(function(){f.options.renderer?f.renderer=f.options.renderer:(f.renderer=new THREE.WebGLRenderer({canvas:Primrose.DOM.cascadeElement(f.options.canvasElement,"canvas",HTMLCanvasElement),context:f.options.context,antialias:!isMobile,alpha:!0,logarithmicDepthBuffer:!1}),f.renderer.autoClear=!1,f.renderer.autoSortObjects=!0,f.renderer.setClearColor(f.options.backgroundColor),f.renderer.domElement.parentElement||document.body.appendChild(f.renderer.domElement)),f.renderer.domElement.addEventListener("webglcontextlost",f.stop,!1),f.renderer.domElement.addEventListener("webglcontextrestored",f.start,!1),f.input=new Primrose.Input.FPSInput(f.renderer.domElement),f.input.addEventListener("zero",f.zero,!1),f.input.addEventListener("lockpointer",ht,!1),f.input.addEventListener("pointerstart",P,!1),f.input.addEventListener("pointerend",_,!1),f.renderer.domElement.style.cursor="default",f.input.VR.init().then(function(){f.input.VR.connect(0),m("ready")})});var mt=-1,pt=0,yt=0,gt=10,vt=2e3,bt=0,xt=0,wt=0,Et=function(){if(f.options.autoScaleQuality&&f.quality!==Primrose.Quality.NONE)if(bt+vt>yt)yt=performance.now();else if(++pt,pt===gt){var t=performance.now(),e=.001*(t-yt),n=Math.round(gt/e);yt=t,pt=0,wt=xt,xt=45>n?-1:!isMobile&&f.options.autoRescaleQuality&&n>=60&&f.quality<Primrose.Quality.MAXIMUM&&-1!==wt?1:0,0!==xt&&(f.quality+=xt),bt=t}};if(Object.defineProperties(this,{hasOrientation:{get:function(){return f.input.VR.currentDisplay.hasOrientation}},inVR:{get:function(){return f.input.VR.transforms.length>1}},displays:{get:function(){return f.input.VR.displays||[]}},quality:{get:function(){return mt},set:function(t){t>=0&&t<Primrose.RESOLUTION_SCALES.length&&(mt=t,X=Primrose.RESOLUTION_SCALES[t]),tt.then(O)}}}),this.quality=this.options.quality,window.alert.toString().indexOf("native code")>-1){var Pt=function(t,e){return e||(e=function(){}),function(){ct()?e():t.apply(window,arguments)}};window.alert=Pt(window.alert),window.confirm=Pt(window.confirm),window.prompt=Pt(window.prompt)}this.start()}return _createClass(u,[{key:"operatingSystem",get:function(){return this._operatingSystem},set:function(t){this._operatingSystem=t||(isOSX?Primrose.Text.OperatingSystems.OSX:Primrose.Text.OperatingSystems.Windows)}},{key:"codePage",get:function(){return this._codePage},set:function(t){var e;if(this._codePage=t,!this._codePage){var n=navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage||navigator.browserLanguage;n&&"en"!==n||(n="en-US");for(e in Primrose.Text.CodePages)if(t=Primrose.Text.CodePages[e],t.language===n){this._codePage=t;break}this._codePage||(this._codePage=Primrose.Text.CodePages.EN_US)}}}],[{key:"createSurrogate",value:function(){var t=this,e=function(e,n){t.currentControl&&(t.currentControl[e+"SelectedText"](n),n.returnValue||n.preventDefault(),t._surrogate.style.display="none",t.currentControl.canvas.focus())};this._surrogate=Primrose.DOM.cascadeElement("primrose-surrogate-textarea","textarea",HTMLTextAreaElement),this._surrogateContainer=Primrose.DOM.makeHidingContainer("primrose-surrogate-textarea-container",this._surrogate),this._surrogateContainer.style.position="absolute",this._surrogateContainer.style.overflow="hidden",this._surrogateContainer.style.width=0,this._surrogateContainer.style.height=0,this._surrogate.addEventListener("beforecopy",setFalse,!1),this._surrogate.addEventListener("copy",e.bind(this,"copy"),!1),this._surrogate.addEventListener("beforecut",setFalse,!1),this._surrogate.addEventListener("cut",e.bind(this,"cut"),!1),document.body.insertBefore(this._surrogateContainer,document.body.children[0])}}]),u}();return u.DEFAULT_USER_NAME="CURRENT_USER_OFFLINE",u.DEFAULTS={autoScaleQuality:!0,autoRescaleQuality:!1,quality:Primrose.Quality.MAXIMUM,useNose:!1,useLeap:!1,useFog:!1,avatarHeight:1.75,walkSpeed:2,gravity:9.8,gazeLength:1,disableMirroring:!1,backgroundColor:11517951,nearPlane:.01,drawDistance:100,defaultFOV:75,dtNetworkUpdate:.125,ambientSound:null,canvasElement:"frontBuffer",renderer:null,context:null,scene:null},u}(),Primrose.ButtonFactory=function(){function t(t,e){this.options=e,this.template=t}var e=0;return t.prototype.create=function(t){var n="button"+ ++e,r=this.template.clone(),i=new Primrose.Controls.Button3D(r,n,this.options,t);return i},t}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.Entity=function(){var t=[],e=new WeakMap,n=function(){function n(t){_classCallCheck(this,n),this.id=t,this.parent=null,this.children=[],this.focused=!1,this.listeners={focus:[],blur:[],click:[],keydown:[],keyup:[],paste:[],copy:[],cut:[],wheel:[],_idchanged:[]}}return _createClass(n,null,[{key:"registerEntity",value:function(n){e.set(n.id,n),t.push(n.id),n.addEventListener("_idchanged",function(n){t.splice(t.indexOf(n.oldID),1),e["delete"](n.oldID),e.set(n.entity.id,n.entity),t.push(n.entity.id)},!1)}},{key:"eyeBlankAll",value:function(n){t.forEach(function(t){e.get(t).eyeBlank(n)})}}]),_createClass(n,[{key:"addEventListener",value:function(t,e){this.listeners[t]&&this.listeners[t].push(e)}},{key:"removeEventListener",value:function(t,e){var n=this.listeners[t];if(evt){var r=n.indexOf(e);r>=0&&r<n.length&&n.splice(r,1)}}},{key:"focus",value:function(){this.focused=!0,emit.call(this,"focus",{target:this})}},{key:"blur",value:function(){this.focused=!1;for(var t=0;t<this.children.length;++t)this.children[t].focused&&this.children[t].blur();emit.call(this,"blur",{target:this})}},{key:"appendChild",value:function(t){t&&!t.parent&&(t.parent=this,this.children.push(t))}},{key:"removeChild",value:function(t){console.log("removeChild",this.id);var e=this.children.indexOf(t);e>=0&&e<this.children.length&&(this.children.splice(e,1),t.parent=null)}},{key:"_forFocusedChild",value:function(t,e){var n=this.focusedElement;n&&n!==this&&n[t](e)}},{key:"startDOMPointer",value:function(t){for(var e=0;e<this.children.length;++e)this.children[e].startDOMPointer(t)}},{key:"eyeBlank",value:function(t){for(var e=0;e<this.children.length;++e)this.children[e].eyeBlank(t)}},{key:"moveDOMPointer",value:function(t){this._forFocusedChild("moveDOMPointer",t)}},{key:"startUV",value:function(t){this._forFocusedChild("startUV",t)}},{key:"moveUV",value:function(t){this._forFocusedChild("moveUV",t)}},{key:"endPointer",value:function(){this._forFocusedChild("endPointer")}},{key:"keyDown",value:function(t){this._forFocusedChild("keyDown",t)}},{key:"keyUp",value:function(t){this._forFocusedChild("keyUp",t)}},{key:"readClipboard",value:function(t){this._forFocusedChild("readClipboard",t)}},{key:"copySelectedText",value:function(t){this._forFocusedChild("copySelectedText",t)}},{key:"cutSelectedText",value:function(t){this._forFocusedChild("cutSelectedText",t)}},{key:"readWheel",value:function(t){this._forFocusedChild("readWheel",t)}},{key:"id",get:function(){return this._id},set:function(t){var e=this._id;this._id=new String(t),emit.call(this,"_idchanged",{oldID:e,entity:this})}},{key:"theme",get:function(){return null},set:function(t){for(var e=0;e<this.children.length;++e)this.children[e].theme=t}},{key:"lockMovement",get:function(){for(var t=!1,e=0;e<this.children.length&&!t;++e)t|=this.children[e].lockMovement;return t}},{key:"focusedElement",get:function(){if(this.focused){for(var t=0;t<this.children.length;++t){var e=this.children[t];if(e.focused)return e.focusedElement}return this}}}]),n}();return n}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.InputProcessor=function(){var t=function(){function t(e,n,r){var i=this;_classCallCheck(this,t),this.name=e,this.commands={},this.commandNames=[],this.socket=r,this.enabled=!0,this.paused=!1,this.ready=!0,this.transmitting=!0,this.receiving=!0,this.socketReady=!1,this.inPhysicalUse=!0,this.inputState={buttons:[],axes:[],ctrl:!1,alt:!1,shift:!1,meta:!1},this.lastState="",this.lastT=performance.now();var o=function(t){for(var e=0;e<Primrose.Keys.MODIFIER_KEYS.length;++e){var n=Primrose.Keys.MODIFIER_KEYS[e];i.inputState[n]=t[n+"Key"]}i.update()};window.addEventListener("keydown",o,!1),window.addEventListener("keyup",o,!1),r&&(r.on("open",function(){this.socketReady=!0,this.inPhysicalUse=!this.receiving}.bind(this)),r.on(e,function(t){this.receiving&&(this.inPhysicalUse=!1,this.decodeStateSnapshot(t),this.fireCommands())}.bind(this)),r.on("close",function(){this.inPhysicalUse=!0,this.socketReady=!1}.bind(this)));for(var s in n)this.addCommand(s,n[s]);for(var a=0;a<Primrose.Keys.MODIFIER_KEYS.length;++a)this.inputState[Primrose.Keys.MODIFIER_KEYS[a]]=!1;this.axisNames=Primrose.Input[e]&&Primrose.Input[e].AXES||[];for(var a=0;a<this.axisNames.length;++a)this.inputState.axes[a]=0}return _createClass(t,null,[{key:"defineAxisProperties",value:function(t,e){t.AXES=e,e.forEach(function(e,n){t[e]=n+1,Object.defineProperty(t.prototype,e,{get:function(){return this.getAxis(e)},set:function(t){this.setAxis(e,t)}})})}}]),_createClass(t,[{key:"addCommand",value:function(t,e){e.name=t,e=this.cloneCommand(e),"undefined"==typeof e.repetitions&&(e.repetitions=1),e.state={value:null,pressed:!1,wasPressed:!1,fireAgain:!1,lt:0,ct:0,repeatCount:0},this.commands[t]=e,this.commandNames.push(t)}},{key:"cloneCommand",value:function(t){return{name:t.name,disabled:!!t.disabled,dt:t.dt||0,deadzone:t.deadzone||0,threshold:t.threshold||0,repetitions:t.repetitions,scale:t.scale,offset:t.offset,min:t.min,max:t.max,integrate:t.integrate||!1,delta:t.delta||!1,axes:this.maybeClone(t.axes),commands:t.commands&&t.commands.slice()||[],buttons:this.maybeClone(t.buttons),metaKeys:this.maybeClone(t.metaKeys&&t.metaKeys.map(function(t){for(var e=0;e<Primrose.Keys.MODIFIER_KEYS.length;++e){var n=Primrose.Keys.MODIFIER_KEYS[e];if(Math.abs(t)===Primrose.Keys[n.toLocaleUpperCase()])return Math.sign(t)*(e+1)}}.bind(this))),commandDown:t.commandDown,commandUp:t.commandUp}}},{key:"maybeClone",value:function(t){var e=[];if(t)for(var n=0;n<t.length;++n)e[n]={index:Math.abs(t[n])-1,toggle:t[n]<0,sign:t[n]<0?-1:1};return e}},{key:"update",value:function(){var t=performance.now()/1e3,e=t-this.lastT;if(this.lastT=t,this.ready&&this.enabled&&this.inPhysicalUse&&!this.paused&&e>0){for(var n in this.commands){var r=this.commands[n];if(r.state.wasPressed=r.state.pressed,r.state.pressed=!1,!r.disabled){var i=!0;if(r.metaKeys)for(var o=0;o<r.metaKeys.length&&i;++o){var s=r.metaKeys[o];i=i&&(this.inputState[Primrose.Keys.MODIFIER_KEYS[s.index]]&&!s.toggle||!this.inputState[Primrose.Keys.MODIFIER_KEYS[s.index]]&&s.toggle)}if(i){var o,a,u=!0,c=0,l=!1;for(o in this.inputState.buttons)if(this.inputState.buttons[o]){l=!0;break}if(r.buttons)for(o=0;o<r.buttons.length;++o){var h=r.buttons[o],d=h.index+1,f=d===Primrose.Keys.ANY&&l||!!this.inputState.buttons[d];a=f?h.sign:0,u=u&&(f&&!h.toggle||!f&&h.toggle),Math.abs(a)>Math.abs(c)&&(c=a)}if(r.axes)for(o=0;o<r.axes.length;++o){var m=r.axes[o];a=m.sign*this.inputState.axes[m.index],Math.abs(a)>Math.abs(c)&&(c=a)}for(o=0;o<r.commands.length;++o)a=this.getValue(r.commands[o]),Math.abs(a)>Math.abs(c)&&(c=a);if(void 0!==r.scale&&(c*=r.scale),void 0!==r.offset&&(c+=r.offset),r.deadzone&&Math.abs(c)<r.deadzone&&(c=0),r.integrate)c=this.getValue(r.name)+c*e;else if(r.delta){var p=c;void 0!==r.state.lv&&(c=(c-r.state.lv)/e),r.state.lv=p}void 0!==r.min&&(c=Math.max(r.min,c)),void 0!==r.max&&(c=Math.min(r.max,c)),r.threshold&&(u=u&&c>r.threshold),r.state.pressed=u,r.state.value=c}r.state.lt+=e,r.state.fireAgain=r.state.pressed&&r.state.lt>=r.dt&&(-1===r.repetitions||r.state.repeatCount<r.repetitions),r.state.fireAgain?(r.state.lt=0,++r.state.repeatCount):r.state.pressed||(r.state.repeatCount=0)}}if(this.socketReady&&this.transmitting){var y=this.makeStateSnapshot();y!==this.lastState&&(this.socket.emit(this.name,y),this.lastState=y)}this.fireCommands()}}},{key:"fireCommands",value:function(){if(this.ready&&!this.paused)for(var t in this.commands){var e=this.commands[t];e.state.fireAgain&&e.commandDown&&e.commandDown(this.name),!e.state.pressed&&e.state.wasPressed&&e.commandUp&&e.commandUp(this.name)}}},{key:"makeStateSnapshot",value:function(){var t="",e=0,n=Object.keys(this.commands).length;for(var r in this.commands){var i=this.commands[r];i.state&&(t+=e<<2|(i.state.pressed?1:0)|(i.state.fireAgain?2:0)+":"+i.state.value,n-1>e&&(t+="|")),++e}return t}},{key:"decodeStateSnapshot",value:function(t){var e,n;for(n in this.commands)e=this.commands[n],e.state.wasPressed=e.state.pressed;for(var r=t.split("|"),i=0;i<r.length;++i){var o=r[i],s=o.split(":"),a=parseInt(s[0],10),u=0!==(1&a),c=0!==(2&l),l=parseInt(s[2],10);a>>=2,n=this.commandNames(a),e=this.commands[n],e.state={value:parseFloat(s[1]),pressed:u,fireAgain:c}}}},{key:"setProperty",value:function(t,e,n){this.commands[e]&&(this.commands[e][t]=n)}},{key:"setDeadzone",value:function(t,e){this.setProperty("deadzone",t,e)}},{key:"setScale",value:function(t,e){this.setProperty("scale",t,e)}},{key:"setDT",value:function(t,e){this.setProperty("dt",t,e)}},{key:"setMin",value:function(t,e){this.setProperty("min",t,e)}},{key:"setMax",value:function(t,e){this.setProperty("max",t,e)}},{key:"addToArray",value:function(t,e,n){this.commands[e]&&this.commands[e][t]&&this.commands[e][t].push(n)}},{key:"addMetaKey",value:function(t,e){this.addToArray("metaKeys",t,e)}},{key:"addAxis",value:function(t,e){this.addToArray("axes",t,e)}},{key:"addButton",value:function(t,e){this.addToArray("buttons",t,e)}},{key:"removeMetaKey",value:function(t,e){this.removeFromArray("metaKeys",t,e)}},{key:"removeAxis",value:function(t,e){this.removeFromArray("axes",t,e)}},{key:"removeButton",value:function(t,e){this.removeFromArray("buttons",t,e)}},{key:"invertAxis",value:function(t,e){this.invertInArray("axes",t,e)}},{key:"invertButton",value:function(t,e){this.invertInArray("buttons",t,e)}},{key:"invertMetaKey",value:function(t,e){this.invertInArray("metaKeys",t,e)}},{key:"removeFromArray",value:function(t,e,n){if(this.commands[e]&&this.commands[e][t]){var r=this.commands[e][t],i=r.indexOf(n);i>-1&&r.splice(i,1)}}},{key:"invertInArray",value:function(t,e,n){if(this.commands[e]&&this.commands[e][t]){var r=this.commands[e][t],i=r.indexOf(n);i>-1&&(r[i]*=-1)}}},{key:"pause",value:function(t){this.paused=t}},{key:"isPaused",value:function(){return this.paused}},{key:"enable",value:function(t,e){void 0!==e&&null!==e||(e=t,t=null),t?this.setProperty("disabled",t,!e):this.enabled=e}},{key:"isEnabled",value:function(t){return t&&this.commands[t]&&!this.commands[t].disabled}},{key:"transmit",value:function(t){this.transmitting=t}},{key:"isTransmitting",value:function(){return this.transmitting}},{key:"receive",value:function(t){this.receiving=t}},{key:"isReceiving",value:function(){return this.receiving}},{key:"getAxis",value:function(t){var e=this.axisNames.indexOf(t);if(e>-1){var n=this.inputState.axes[e]||0;return n}return null}},{key:"setAxis",value:function(t,e){var n=this.axisNames.indexOf(t);n>-1&&(this.inPhysicalUse=!0,this.inputState.axes[n]=e)}},{key:"setButton",value:function(t,e){this.inPhysicalUse=!0,this.inputState.buttons[t]=e}},{key:"getValue",value:function(t){return(this.enabled||this.receiving&&this.socketReady)&&this.isEnabled(t)&&this.commands[t].state.value||this.getAxis(t)||0}},{key:"setValue",value:function(t,e){var n=this.axisNames.indexOf(t);!this.commands[t]&&n>-1?this.setAxis(t,e):this.commands[t]&&!this.commands[t].disabled&&(this.commands[t].state.value=e)}},{key:"getVector3",value:function(t,e,n,r){return r=r||new THREE.Vector3,r.set(this.getValue(t),this.getValue(e),this.getValue(n)),r}},{key:"addVector3",value:function(t,e,n,r){return r.x+=this.getValue(t),r.y+=this.getValue(e),r.z+=this.getValue(n),r}},{key:"isDown",value:function(t){return(this.enabled||this.receiving&&this.socketReady)&&this.isEnabled(t)&&this.commands[t].state.pressed}},{key:"isUp",value:function(t){return(this.enabled||this.receiving&&this.socketReady)&&this.isEnabled(t)&&this.commands[t].state.pressed}}]),t}();return t}(),Primrose.Keys=function(){var t={ANY:Number.MAX_VALUE,MODIFIER_KEYS:["ctrl","shift","alt","meta","meta_l","meta_r"],SHIFT:16,CTRL:17,ALT:18,META:91,META_L:91,META_R:92,BACKSPACE:8,TAB:9,ENTER:13,SPACE:32,DELETE:46,PAUSEBREAK:19,CAPSLOCK:20,NUMLOCK:144,SCROLLLOCK:145,INSERT:45,ESCAPE:27,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFTARROW:37,UPARROW:38,RIGHTARROW:39,DOWNARROW:40,SELECTKEY:93,NUMBER0:48,NUMBER1:49,NUMBER2:50,NUMBER3:51,NUMBER4:52,NUMBER5:53,NUMBER6:54,NUMBER7:55,NUMBER8:56,NUMBER9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMALPOINT:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,VOLUME_DOWN:174,VOLUME_UP:175,TRACK_NEXT:176,TRACK_PREVIOUS:177};for(var e in t){var n=t[e];t.hasOwnProperty(e)&&"number"==typeof n&&(t[n]=e)}return t}(),Primrose.ModelLoader=function(){function t(t){return t.traverse(function(t){t.geometry&&(t.geometry.computeBoundingSphere(),t.geometry.computeBoundingBox())}),t}function e(t){return t.traverse(function(t){if(t instanceof THREE.Mesh)for(var e in s)t[e]=t[e]||s[e](t)}),t}function n(t){this.template=t}function r(t,e){return function(r){return n.loadObject(t[e]).then(function(t){return r[e]=t,r})}}if("undefined"==typeof THREE)return function(){};var i={".json":THREE.ObjectLoader&&new THREE.ObjectLoader,".fbx":THREE.FBXLoader&&new THREE.FBXLoader,".mtl":THREE.MTLLoader&&new THREE.MTLLoader,".obj":THREE.OBJLoader&&new THREE.OBJLoader,".stl":THREE.STLLoader&&new THREE.STLLoader,".typeface.js":THREE.FontLoader&&new THREE.FontLoader},o=/(\.(\w+))+$/,s={isButton:function(t){return t.material&&t.material.name.match(/^button\d+$/)},isSolid:function(t){return!t.name.match(/^(water|sky)/)},isGround:function(t){return t.material&&t.material.name&&t.material.name.match(/\bground\b/)}};return n.loadModel=function(t,e,r){return n.loadObject(t,e,r).then(function(t){return new n(t)})},n.prototype.clone=function(){var t=this.template.clone();return t.traverse(function(e){e instanceof THREE.SkinnedMesh&&(t.animation=new THREE.Animation(e,e.geometry.animation),!this.template.originalAnimationData&&t.animation.data&&(this.template.originalAnimationData=t.animation.data),t.animation.data||(t.animation.data=this.template.originalAnimationData))}.bind(this)),e(t),t},n.loadObject=function(r,s,a){var u=r.match(o),c=s&&"."+s||u[0];if(c){c=c.toLowerCase();var l=i[c];if(l){var h=r.substring(0,u.index),d=h+"_"+c.toLowerCase(),f=document.getElementById(d),m=Promise.resolve();if(".obj"===c){var p=r.replace(o,".mtl");m=m.then(function(){return n.loadObject(p,"mtl",a)}),m=m.then(function(t){t.preload(),l.setMaterials(t)})}if(f){var y=f.innerHTML.split(/\r?\n/g).map(function(t){return t.trim()}).join("\n");m=m.then(function(){return l.parse(y)})}else l.setCrossOrigin&&l.setCrossOrigin(THREE.ImageUtils.crossOrigin),m=m.then(function(){return new Promise(function(t,e){return l.load(r,t,a,e)})});return".json"===c&&(m=m.then(t)),".mtl"!==c&&".typeface.js"!==c&&(m=m.then(e)),m=m["catch"](console.error.bind(console,"MODEL_ERR",r))}return Promise.reject("There is no loader type for the file extension: "+c);
}return Promise.reject("File path `"+r+"` does not have a file extension, and a type was not provided as a parameter, so we can't determine the type.")},n.loadObjects=function(t){var e={},n=Promise.resolve(e);for(var i in t)t[i]&&(n=n.then(r(t,i)));return n},n}(),Primrose.Projector=function(){function t(t){!function(){"undefined"==typeof THREE&&(self.THREE={REVISION:"72dev"},void 0===Math.sign&&(Math.sign=function(t){return 0>t?-1:t>0?1:+t}),void 0===Function.prototype.name&&void 0!==Object.defineProperty&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*(\S*)\s*\(/)[1]}}),THREE.Quaternion=function(t,e,n,r){this._x=t||0,this._y=e||0,this._z=n||0,this._w=void 0!==r?r:1},THREE.Quaternion.prototype={constructor:THREE.Quaternion,get x(){return this._x},set x(t){this._x=t,this.onChangeCallback()},get y(){return this._y},set y(t){this._y=t,this.onChangeCallback()},get z(){return this._z},set z(t){this._z=t,this.onChangeCallback()},get w(){return this._w},set w(t){this._w=t,this.onChangeCallback()},set:function(t,e,n,r){return this._x=t,this._y=e,this._z=n,this._w=r,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._w)},copy:function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this.onChangeCallback(),this},setFromEuler:function(t,e){if(t instanceof THREE.Euler==!1)throw new Error("THREE.Quaternion: .setFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var n=Math.cos(t._x/2),r=Math.cos(t._y/2),i=Math.cos(t._z/2),o=Math.sin(t._x/2),s=Math.sin(t._y/2),a=Math.sin(t._z/2);return"XYZ"===t.order?(this._x=o*r*i+n*s*a,this._y=n*s*i-o*r*a,this._z=n*r*a+o*s*i,this._w=n*r*i-o*s*a):"YXZ"===t.order?(this._x=o*r*i+n*s*a,this._y=n*s*i-o*r*a,this._z=n*r*a-o*s*i,this._w=n*r*i+o*s*a):"ZXY"===t.order?(this._x=o*r*i-n*s*a,this._y=n*s*i+o*r*a,this._z=n*r*a+o*s*i,this._w=n*r*i-o*s*a):"ZYX"===t.order?(this._x=o*r*i-n*s*a,this._y=n*s*i+o*r*a,this._z=n*r*a-o*s*i,this._w=n*r*i+o*s*a):"YZX"===t.order?(this._x=o*r*i+n*s*a,this._y=n*s*i+o*r*a,this._z=n*r*a-o*s*i,this._w=n*r*i-o*s*a):"XZY"===t.order&&(this._x=o*r*i-n*s*a,this._y=n*s*i-o*r*a,this._z=n*r*a+o*s*i,this._w=n*r*i+o*s*a),e!==!1&&this.onChangeCallback(),this},setFromAxisAngle:function(t,e){var n=e/2,r=Math.sin(n);return this._x=t.x*r,this._y=t.y*r,this._z=t.z*r,this._w=Math.cos(n),this.onChangeCallback(),this},setFromRotationMatrix:function(t){var e,n=t.elements,r=n[0],i=n[4],o=n[8],s=n[1],a=n[5],u=n[9],c=n[2],l=n[6],h=n[10],d=r+a+h;return d>0?(e=.5/Math.sqrt(d+1),this._w=.25/e,this._x=(l-u)*e,this._y=(o-c)*e,this._z=(s-i)*e):r>a&&r>h?(e=2*Math.sqrt(1+r-a-h),this._w=(l-u)/e,this._x=.25*e,this._y=(i+s)/e,this._z=(o+c)/e):a>h?(e=2*Math.sqrt(1+a-r-h),this._w=(o-c)/e,this._x=(i+s)/e,this._y=.25*e,this._z=(u+l)/e):(e=2*Math.sqrt(1+h-r-a),this._w=(s-i)/e,this._x=(o+c)/e,this._y=(u+l)/e,this._z=.25*e),this.onChangeCallback(),this},setFromUnitVectors:function(){var t,e,n=1e-6;return function(r,i){return void 0===t&&(t=new THREE.Vector3),e=r.dot(i)+1,n>e?(e=0,Math.abs(r.x)>Math.abs(r.z)?t.set(-r.y,r.x,0):t.set(0,-r.z,r.y)):t.crossVectors(r,i),this._x=t.x,this._y=t.y,this._z=t.z,this._w=e,this.normalize(),this}}(),inverse:function(){return this.conjugate().normalize(),this},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this},dot:function(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this.onChangeCallback(),this},multiply:function(t,e){return void 0!==e?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(t,e)):this.multiplyQuaternions(this,t)},multiplyQuaternions:function(t,e){var n=t._x,r=t._y,i=t._z,o=t._w,s=e._x,a=e._y,u=e._z,c=e._w;return this._x=n*c+o*s+r*u-i*a,this._y=r*c+o*a+i*s-n*u,this._z=i*c+o*u+n*a-r*s,this._w=o*c-n*s-r*a-i*u,this.onChangeCallback(),this},multiplyVector3:function(t){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),t.applyQuaternion(this)},slerp:function(t,e){if(0===e)return this;if(1===e)return this.copy(t);var n=this._x,r=this._y,i=this._z,o=this._w,s=o*t._w+n*t._x+r*t._y+i*t._z;if(0>s?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,s=-s):this.copy(t),s>=1)return this._w=o,this._x=n,this._y=r,this._z=i,this;var a=Math.acos(s),u=Math.sqrt(1-s*s);if(Math.abs(u)<.001)return this._w=.5*(o+this._w),this._x=.5*(n+this._x),this._y=.5*(r+this._y),this._z=.5*(i+this._z),this;var c=Math.sin((1-e)*a)/u,l=Math.sin(e*a)/u;return this._w=o*c+this._w*l,this._x=n*c+this._x*l,this._y=r*c+this._y*l,this._z=i*c+this._z*l,this.onChangeCallback(),this},equals:function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w},fromArray:function(t,e){return void 0===e&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this.onChangeCallback(),this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t},onChange:function(t){return this.onChangeCallback=t,this},onChangeCallback:function(){}},THREE.Quaternion.slerp=function(t,e,n,r){return n.copy(t).slerp(e,r)},THREE.Vector3=function(t,e,n){this.x=t||0,this.y=e||0,this.z=n||0},THREE.Vector3.prototype={constructor:THREE.Vector3,set:function(t,e,n){return this.x=t,this.y=e,this.z=n,this},setX:function(t){return this.x=t,this},setY:function(t){return this.y=t,this},setZ:function(t){return this.z=t,this},setComponent:function(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}},getComponent:function(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},add:function(t,e){return void 0!==e?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)},addScalar:function(t){return this.x+=t,this.y+=t,this.z+=t,this},addVectors:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},addScaledVector:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this},sub:function(t,e){return void 0!==e?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this)},subScalar:function(t){return this.x-=t,this.y-=t,this.z-=t,this},subVectors:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},multiply:function(t,e){return void 0!==e?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(t,e)):(this.x*=t.x,this.y*=t.y,this.z*=t.z,this)},multiplyScalar:function(t){return this.x*=t,this.y*=t,this.z*=t,this},multiplyVectors:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this},applyEuler:function(){var t;return function(e){return e instanceof THREE.Euler==!1&&console.error("THREE.Vector3: .applyEuler() now expects a Euler rotation rather than a Vector3 and order."),void 0===t&&(t=new THREE.Quaternion),this.applyQuaternion(t.setFromEuler(e)),this}}(),applyAxisAngle:function(){var t;return function(e,n){return void 0===t&&(t=new THREE.Quaternion),this.applyQuaternion(t.setFromAxisAngle(e,n)),this}}(),applyMatrix3:function(t){var e=this.x,n=this.y,r=this.z,i=t.elements;return this.x=i[0]*e+i[3]*n+i[6]*r,this.y=i[1]*e+i[4]*n+i[7]*r,this.z=i[2]*e+i[5]*n+i[8]*r,this},applyMatrix4:function(t){var e=this.x,n=this.y,r=this.z,i=t.elements;return this.x=i[0]*e+i[4]*n+i[8]*r+i[12],this.y=i[1]*e+i[5]*n+i[9]*r+i[13],this.z=i[2]*e+i[6]*n+i[10]*r+i[14],this},applyProjection:function(t){var e=this.x,n=this.y,r=this.z,i=t.elements,o=1/(i[3]*e+i[7]*n+i[11]*r+i[15]);return this.x=(i[0]*e+i[4]*n+i[8]*r+i[12])*o,this.y=(i[1]*e+i[5]*n+i[9]*r+i[13])*o,this.z=(i[2]*e+i[6]*n+i[10]*r+i[14])*o,this},applyQuaternion:function(t){var e=this.x,n=this.y,r=this.z,i=t.x,o=t.y,s=t.z,a=t.w,u=a*e+o*r-s*n,c=a*n+s*e-i*r,l=a*r+i*n-o*e,h=-i*e-o*n-s*r;return this.x=u*a+h*-i+c*-s-l*-o,this.y=c*a+h*-o+l*-i-u*-s,this.z=l*a+h*-s+u*-o-c*-i,this},project:function(){var t;return function(e){return void 0===t&&(t=new THREE.Matrix4),t.multiplyMatrices(e.projectionMatrix,t.getInverse(e.matrixWorld)),this.applyProjection(t)}}(),unproject:function(){var t;return function(e){return void 0===t&&(t=new THREE.Matrix4),t.multiplyMatrices(e.matrixWorld,t.getInverse(e.projectionMatrix)),this.applyProjection(t)}}(),transformDirection:function(t){var e=this.x,n=this.y,r=this.z,i=t.elements;return this.x=i[0]*e+i[4]*n+i[8]*r,this.y=i[1]*e+i[5]*n+i[9]*r,this.z=i[2]*e+i[6]*n+i[10]*r,this.normalize(),this},divide:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},divideScalar:function(t){if(0!==t){var e=1/t;this.x*=e,this.y*=e,this.z*=e}else this.x=0,this.y=0,this.z=0;return this},min:function(t){return this.x>t.x&&(this.x=t.x),this.y>t.y&&(this.y=t.y),this.z>t.z&&(this.z=t.z),this},max:function(t){return this.x<t.x&&(this.x=t.x),this.y<t.y&&(this.y=t.y),this.z<t.z&&(this.z=t.z),this},clamp:function(t,e){return this.x<t.x?this.x=t.x:this.x>e.x&&(this.x=e.x),this.y<t.y?this.y=t.y:this.y>e.y&&(this.y=e.y),this.z<t.z?this.z=t.z:this.z>e.z&&(this.z=e.z),this},clampScalar:function(){var t,e;return function(n,r){return void 0===t&&(t=new THREE.Vector3,e=new THREE.Vector3),t.set(n,n,n),e.set(r,r,r),this.clamp(t,e)}}(),floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(t){var e=this.length();return 0!==e&&t!==e&&this.multiplyScalar(t/e),this},lerp:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this},lerpVectors:function(t,e,n){return this.subVectors(e,t).multiplyScalar(n).add(t),this},cross:function(t,e){if(void 0!==e)return console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(t,e);var n=this.x,r=this.y,i=this.z;return this.x=r*t.z-i*t.y,this.y=i*t.x-n*t.z,this.z=n*t.y-r*t.x,this},crossVectors:function(t,e){var n=t.x,r=t.y,i=t.z,o=e.x,s=e.y,a=e.z;return this.x=r*a-i*s,this.y=i*o-n*a,this.z=n*s-r*o,this},projectOnVector:function(){var t,e;return function(n){return void 0===t&&(t=new THREE.Vector3),t.copy(n).normalize(),e=this.dot(t),this.copy(t).multiplyScalar(e)}}(),projectOnPlane:function(){var t;return function(e){return void 0===t&&(t=new THREE.Vector3),t.copy(this).projectOnVector(e),this.sub(t)}}(),reflect:function(){var t;return function(e){return void 0===t&&(t=new THREE.Vector3),this.sub(t.copy(e).multiplyScalar(2*this.dot(e)))}}(),angleTo:function(t){var e=this.dot(t)/(this.length()*t.length());return Math.acos(THREE.Math.clamp(e,-1,1))},distanceTo:function(t){return Math.sqrt(this.distanceToSquared(t))},distanceToSquared:function(t){var e=this.x-t.x,n=this.y-t.y,r=this.z-t.z;return e*e+n*n+r*r},setEulerFromRotationMatrix:function(t,e){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},setEulerFromQuaternion:function(t,e){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},getPositionFromMatrix:function(t){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(t)},getScaleFromMatrix:function(t){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(t)},getColumnFromMatrix:function(t,e){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(t,e)},setFromMatrixPosition:function(t){return this.x=t.elements[12],this.y=t.elements[13],this.z=t.elements[14],this},setFromMatrixScale:function(t){var e=this.set(t.elements[0],t.elements[1],t.elements[2]).length(),n=this.set(t.elements[4],t.elements[5],t.elements[6]).length(),r=this.set(t.elements[8],t.elements[9],t.elements[10]).length();return this.x=e,this.y=n,this.z=r,this},setFromMatrixColumn:function(t,e){var n=4*t,r=e.elements;return this.x=r[n],this.y=r[n+1],this.z=r[n+2],this},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},fromArray:function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t},fromAttribute:function(t,e,n){return void 0===n&&(n=0),e=e*t.itemSize+n,this.x=t.array[e],this.y=t.array[e+1],this.z=t.array[e+2],this}},THREE.Matrix4=function(){this.elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},THREE.Matrix4.prototype={constructor:THREE.Matrix4,set:function(t,e,n,r,i,o,s,a,u,c,l,h,d,f,m,p){var y=this.elements;return y[0]=t,y[4]=e,y[8]=n,y[12]=r,y[1]=i,y[5]=o,y[9]=s,y[13]=a,y[2]=u,y[6]=c,y[10]=l,y[14]=h,y[3]=d,y[7]=f,y[11]=m,y[15]=p,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},clone:function(){return(new THREE.Matrix4).fromArray(this.elements)},copy:function(t){return this.elements.set(t.elements),this},extractPosition:function(t){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(t)},copyPosition:function(t){var e=this.elements,n=t.elements;return e[12]=n[12],e[13]=n[13],e[14]=n[14],this},extractBasis:function(t,e,n){var r=this.elements;return t.set(r[0],r[1],r[2]),e.set(r[4],r[5],r[6]),n.set(r[8],r[9],r[10]),this},makeBasis:function(t,e,n){return this.set(t.x,e.x,n.x,0,t.y,e.y,n.y,0,t.z,e.z,n.z,0,0,0,0,1),this},extractRotation:function(){var t;return function(e){void 0===t&&(t=new THREE.Vector3);var n=this.elements,r=e.elements,i=1/t.set(r[0],r[1],r[2]).length(),o=1/t.set(r[4],r[5],r[6]).length(),s=1/t.set(r[8],r[9],r[10]).length();return n[0]=r[0]*i,n[1]=r[1]*i,n[2]=r[2]*i,n[4]=r[4]*o,n[5]=r[5]*o,n[6]=r[6]*o,n[8]=r[8]*s,n[9]=r[9]*s,n[10]=r[10]*s,this}}(),makeRotationFromEuler:function(t){t instanceof THREE.Euler==!1&&console.error("THREE.Matrix: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var e=this.elements,n=t.x,r=t.y,i=t.z,o=Math.cos(n),s=Math.sin(n),a=Math.cos(r),u=Math.sin(r),c=Math.cos(i),l=Math.sin(i);if("XYZ"===t.order){var h=o*c,d=o*l,f=s*c,m=s*l;e[0]=a*c,e[4]=-a*l,e[8]=u,e[1]=d+f*u,e[5]=h-m*u,e[9]=-s*a,e[2]=m-h*u,e[6]=f+d*u,e[10]=o*a}else if("YXZ"===t.order){var p=a*c,y=a*l,g=u*c,v=u*l;e[0]=p+v*s,e[4]=g*s-y,e[8]=o*u,e[1]=o*l,e[5]=o*c,e[9]=-s,e[2]=y*s-g,e[6]=v+p*s,e[10]=o*a}else if("ZXY"===t.order){var p=a*c,y=a*l,g=u*c,v=u*l;e[0]=p-v*s,e[4]=-o*l,e[8]=g+y*s,e[1]=y+g*s,e[5]=o*c,e[9]=v-p*s,e[2]=-o*u,e[6]=s,e[10]=o*a}else if("ZYX"===t.order){var h=o*c,d=o*l,f=s*c,m=s*l;e[0]=a*c,e[4]=f*u-d,e[8]=h*u+m,e[1]=a*l,e[5]=m*u+h,e[9]=d*u-f,e[2]=-u,e[6]=s*a,e[10]=o*a}else if("YZX"===t.order){var b=o*a,x=o*u,w=s*a,E=s*u;e[0]=a*c,e[4]=E-b*l,e[8]=w*l+x,e[1]=l,e[5]=o*c,e[9]=-s*c,e[2]=-u*c,e[6]=x*l+w,e[10]=b-E*l}else if("XZY"===t.order){var b=o*a,x=o*u,w=s*a,E=s*u;e[0]=a*c,e[4]=-l,e[8]=u*c,e[1]=b*l+E,e[5]=o*c,e[9]=x*l-w,e[2]=w*l-x,e[6]=s*c,e[10]=E*l+b}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},setRotationFromQuaternion:function(t){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(t)},makeRotationFromQuaternion:function(t){var e=this.elements,n=t.x,r=t.y,i=t.z,o=t.w,s=n+n,a=r+r,u=i+i,c=n*s,l=n*a,h=n*u,d=r*a,f=r*u,m=i*u,p=o*s,y=o*a,g=o*u;return e[0]=1-(d+m),e[4]=l-g,e[8]=h+y,e[1]=l+g,e[5]=1-(c+m),e[9]=f-p,e[2]=h-y,e[6]=f+p,e[10]=1-(c+d),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},lookAt:function(){var t,e,n;return function(r,i,o){void 0===t&&(t=new THREE.Vector3),void 0===e&&(e=new THREE.Vector3),void 0===n&&(n=new THREE.Vector3);var s=this.elements;return n.subVectors(r,i).normalize(),0===n.length()&&(n.z=1),t.crossVectors(o,n).normalize(),0===t.length()&&(n.x+=1e-4,t.crossVectors(o,n).normalize()),e.crossVectors(n,t),s[0]=t.x,s[4]=e.x,s[8]=n.x,s[1]=t.y,s[5]=e.y,s[9]=n.y,s[2]=t.z,s[6]=e.z,s[10]=n.z,this}}(),multiply:function(t,e){return void 0!==e?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(t,e)):this.multiplyMatrices(this,t)},multiplyMatrices:function(t,e){var n=t.elements,r=e.elements,i=this.elements,o=n[0],s=n[4],a=n[8],u=n[12],c=n[1],l=n[5],h=n[9],d=n[13],f=n[2],m=n[6],p=n[10],y=n[14],g=n[3],v=n[7],b=n[11],x=n[15],w=r[0],E=r[4],P=r[8],_=r[12],C=r[1],T=r[5],R=r[9],k=r[13],M=r[2],S=r[6],O=r[10],I=r[14],L=r[3],N=r[7],A=r[11],F=r[15];return i[0]=o*w+s*C+a*M+u*L,i[4]=o*E+s*T+a*S+u*N,i[8]=o*P+s*R+a*O+u*A,i[12]=o*_+s*k+a*I+u*F,i[1]=c*w+l*C+h*M+d*L,i[5]=c*E+l*T+h*S+d*N,i[9]=c*P+l*R+h*O+d*A,i[13]=c*_+l*k+h*I+d*F,i[2]=f*w+m*C+p*M+y*L,i[6]=f*E+m*T+p*S+y*N,i[10]=f*P+m*R+p*O+y*A,i[14]=f*_+m*k+p*I+y*F,i[3]=g*w+v*C+b*M+x*L,i[7]=g*E+v*T+b*S+x*N,i[11]=g*P+v*R+b*O+x*A,i[15]=g*_+v*k+b*I+x*F,this},multiplyToArray:function(t,e,n){var r=this.elements;return this.multiplyMatrices(t,e),n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],n[4]=r[4],n[5]=r[5],n[6]=r[6],n[7]=r[7],n[8]=r[8],n[9]=r[9],n[10]=r[10],n[11]=r[11],n[12]=r[12],n[13]=r[13],n[14]=r[14],n[15]=r[15],this},multiplyScalar:function(t){var e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this},multiplyVector3:function(t){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) or vector.applyProjection( matrix ) instead."),t.applyProjection(this)},multiplyVector4:function(t){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},multiplyVector3Array:function(t){return console.warn("THREE.Matrix4: .multiplyVector3Array() has been renamed. Use matrix.applyToVector3Array( array ) instead."),this.applyToVector3Array(t)},applyToVector3Array:function(){var t;return function(e,n,r){void 0===t&&(t=new THREE.Vector3),void 0===n&&(n=0),void 0===r&&(r=e.length);for(var i=0,o=n;r>i;i+=3,o+=3)t.fromArray(e,o),t.applyMatrix4(this),t.toArray(e,o);return e}}(),applyToBuffer:function(){var t;return function(e,n,r){void 0===t&&(t=new THREE.Vector3),void 0===n&&(n=0),void 0===r&&(r=e.length/e.itemSize);for(var i=0,o=n;r>i;i++,o++)t.x=e.getX(o),t.y=e.getY(o),t.z=e.getZ(o),t.applyMatrix4(this),e.setXYZ(t.x,t.y,t.z);return e}}(),rotateAxis:function(t){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),t.transformDirection(this)},crossVector:function(t){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},determinant:function(){var t=this.elements,e=t[0],n=t[4],r=t[8],i=t[12],o=t[1],s=t[5],a=t[9],u=t[13],c=t[2],l=t[6],h=t[10],d=t[14],f=t[3],m=t[7],p=t[11],y=t[15];return f*(+i*a*l-r*u*l-i*s*h+n*u*h+r*s*d-n*a*d)+m*(+e*a*d-e*u*h+i*o*h-r*o*d+r*u*c-i*a*c)+p*(+e*u*l-e*s*d-i*o*l+n*o*d+i*s*c-n*u*c)+y*(-r*s*c-e*a*l+e*s*h+r*o*l-n*o*h+n*a*c)},transpose:function(){var t,e=this.elements;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},flattenToArrayOffset:function(t,e){var n=this.elements;return t[e]=n[0],t[e+1]=n[1],t[e+2]=n[2],t[e+3]=n[3],t[e+4]=n[4],t[e+5]=n[5],t[e+6]=n[6],t[e+7]=n[7],t[e+8]=n[8],t[e+9]=n[9],t[e+10]=n[10],t[e+11]=n[11],t[e+12]=n[12],t[e+13]=n[13],t[e+14]=n[14],t[e+15]=n[15],t},getPosition:function(){var t;return function(){void 0===t&&(t=new THREE.Vector3),console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead.");var e=this.elements;return t.set(e[12],e[13],e[14])}}(),setPosition:function(t){var e=this.elements;return e[12]=t.x,e[13]=t.y,e[14]=t.z,this},getInverse:function(t,e){var n=this.elements,r=t.elements,i=r[0],o=r[4],s=r[8],a=r[12],u=r[1],c=r[5],l=r[9],h=r[13],d=r[2],f=r[6],m=r[10],p=r[14],y=r[3],g=r[7],v=r[11],b=r[15];n[0]=l*p*g-h*m*g+h*f*v-c*p*v-l*f*b+c*m*b,n[4]=a*m*g-s*p*g-a*f*v+o*p*v+s*f*b-o*m*b,n[8]=s*h*g-a*l*g+a*c*v-o*h*v-s*c*b+o*l*b,n[12]=a*l*f-s*h*f-a*c*m+o*h*m+s*c*p-o*l*p,n[1]=h*m*y-l*p*y-h*d*v+u*p*v+l*d*b-u*m*b,n[5]=s*p*y-a*m*y+a*d*v-i*p*v-s*d*b+i*m*b,n[9]=a*l*y-s*h*y-a*u*v+i*h*v+s*u*b-i*l*b,n[13]=s*h*d-a*l*d+a*u*m-i*h*m-s*u*p+i*l*p,n[2]=c*p*y-h*f*y+h*d*g-u*p*g-c*d*b+u*f*b,n[6]=a*f*y-o*p*y-a*d*g+i*p*g+o*d*b-i*f*b,n[10]=o*h*y-a*c*y+a*u*g-i*h*g-o*u*b+i*c*b,n[14]=a*c*d-o*h*d-a*u*f+i*h*f+o*u*p-i*c*p,n[3]=l*f*y-c*m*y-l*d*g+u*m*g+c*d*v-u*f*v,n[7]=o*m*y-s*f*y+s*d*g-i*m*g-o*d*v+i*f*v,n[11]=s*c*y-o*l*y-s*u*g+i*l*g+o*u*v-i*c*v,n[15]=o*l*d-s*c*d+s*u*f-i*l*f-o*u*m+i*c*m;var x=i*n[0]+u*n[4]+d*n[8]+y*n[12];if(0===x){var w="THREE.Matrix4.getInverse(): can't invert matrix, determinant is 0";if(e)throw new Error(w);return console.warn(w),this.identity(),this}return this.multiplyScalar(1/x),this},translate:function(t){console.error("THREE.Matrix4: .translate() has been removed.")},rotateX:function(t){console.error("THREE.Matrix4: .rotateX() has been removed.")},rotateY:function(t){console.error("THREE.Matrix4: .rotateY() has been removed.")},rotateZ:function(t){console.error("THREE.Matrix4: .rotateZ() has been removed.")},rotateByAxis:function(t,e){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")},scale:function(t){var e=this.elements,n=t.x,r=t.y,i=t.z;return e[0]*=n,e[4]*=r,e[8]*=i,e[1]*=n,e[5]*=r,e[9]*=i,e[2]*=n,e[6]*=r,e[10]*=i,e[3]*=n,e[7]*=r,e[11]*=i,this},getMaxScaleOnAxis:function(){var t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],n=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],r=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,Math.max(n,r)))},makeTranslation:function(t,e,n){return this.set(1,0,0,t,0,1,0,e,0,0,1,n,0,0,0,1),this},makeRotationX:function(t){var e=Math.cos(t),n=Math.sin(t);return this.set(1,0,0,0,0,e,-n,0,0,n,e,0,0,0,0,1),this},makeRotationY:function(t){var e=Math.cos(t),n=Math.sin(t);return this.set(e,0,n,0,0,1,0,0,-n,0,e,0,0,0,0,1),this},makeRotationZ:function(t){var e=Math.cos(t),n=Math.sin(t);return this.set(e,-n,0,0,n,e,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(t,e){var n=Math.cos(e),r=Math.sin(e),i=1-n,o=t.x,s=t.y,a=t.z,u=i*o,c=i*s;return this.set(u*o+n,u*s-r*a,u*a+r*s,0,u*s+r*a,c*s+n,c*a-r*o,0,u*a-r*s,c*a+r*o,i*a*a+n,0,0,0,0,1),this},makeScale:function(t,e,n){return this.set(t,0,0,0,0,e,0,0,0,0,n,0,0,0,0,1),this},compose:function(t,e,n){return this.makeRotationFromQuaternion(e),this.scale(n),this.setPosition(t),this},decompose:function(){var t,e;return function(n,r,i){void 0===t&&(t=new THREE.Vector3),void 0===e&&(e=new THREE.Matrix4);var o=this.elements,s=t.set(o[0],o[1],o[2]).length(),a=t.set(o[4],o[5],o[6]).length(),u=t.set(o[8],o[9],o[10]).length(),c=this.determinant();0>c&&(s=-s),n.x=o[12],n.y=o[13],n.z=o[14],e.elements.set(this.elements);var l=1/s,h=1/a,d=1/u;return e.elements[0]*=l,e.elements[1]*=l,e.elements[2]*=l,e.elements[4]*=h,e.elements[5]*=h,e.elements[6]*=h,e.elements[8]*=d,e.elements[9]*=d,e.elements[10]*=d,r.setFromRotationMatrix(e),i.x=s,i.y=a,i.z=u,this}}(),makeFrustum:function(t,e,n,r,i,o){var s=this.elements,a=2*i/(e-t),u=2*i/(r-n),c=(e+t)/(e-t),l=(r+n)/(r-n),h=-(o+i)/(o-i),d=-2*o*i/(o-i);return s[0]=a,s[4]=0,s[8]=c,s[12]=0,s[1]=0,s[5]=u,s[9]=l,s[13]=0,s[2]=0,s[6]=0,s[10]=h,s[14]=d,s[3]=0,s[7]=0,s[11]=-1,s[15]=0,this},makePerspective:function(t,e,n,r){var i=n*Math.tan(THREE.Math.degToRad(.5*t)),o=-i,s=o*e,a=i*e;return this.makeFrustum(s,a,o,i,n,r)},makeOrthographic:function(t,e,n,r,i,o){var s=this.elements,a=e-t,u=n-r,c=o-i,l=(e+t)/a,h=(n+r)/u,d=(o+i)/c;return s[0]=2/a,s[4]=0,s[8]=0,s[12]=-l,s[1]=0,s[5]=2/u,s[9]=0,s[13]=-h,s[2]=0,s[6]=0,s[10]=-2/c,s[14]=-d,s[3]=0,s[7]=0,s[11]=0,s[15]=1,this},equals:function(t){for(var e=this.elements,n=t.elements,r=0;16>r;r++)if(e[r]!==n[r])return!1;return!0},fromArray:function(t){return this.elements.set(t),this},toArray:function(){var t=this.elements;return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]}},THREE.Math={generateUUID:function(){var t,e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),n=new Array(36),r=0;return function(){for(var i=0;36>i;i++)8===i||13===i||18===i||23===i?n[i]="-":14===i?n[i]="4":(2>=r&&(r=33554432+16777216*Math.random()|0),t=15&r,r>>=4,n[i]=e[19===i?3&t|8:t]);return n.join("")}}(),clamp:function(t,e,n){return e>t?e:t>n?n:t},clampBottom:function(t,e){return e>t?e:t},euclideanModulo:function(t,e){return(t%e+e)%e},mapLinear:function(t,e,n,r,i){return r+(t-e)*(i-r)/(n-e)},smoothstep:function(t,e,n){return e>=t?0:t>=n?1:(t=(t-e)/(n-e),t*t*(3-2*t))},smootherstep:function(t,e,n){return e>=t?0:t>=n?1:(t=(t-e)/(n-e),t*t*t*(t*(6*t-15)+10))},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},degToRad:function(){var t=Math.PI/180;return function(e){return e*t}}(),radToDeg:function(){var t=180/Math.PI;return function(e){return e*t}}(),isPowerOfTwo:function(t){return 0===(t&t-1)&&0!==t},nextPowerOfTwo:function(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,t++,t}})}(),this.objectIDs=[],this.objects={},this.geometryCache={},this.a=new THREE.Vector3,this.b=new THREE.Vector3,this.c=new THREE.Vector3,this.d=new THREE.Vector3,this.f=new THREE.Vector3,this.p=new THREE.Vector3,this.m=new THREE.Matrix4,this.listeners={hit:[]},this.ready=!0}return t.prototype.addEventListener=function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)},t.prototype._emit=emit,t.prototype._transform=function(t,e){return e.clone().applyMatrix4(t.matrix)},t.prototype._getVerts=function(t){for(var e=[],n=this.geometryCache[t.geomID],r=n.vertices,i=0;i<r.length;++i)e[i]=this._transform(t,r[i]);return e},t.prototype.setObject=function(t){this.objectIDs.push(t.uuid),this.objects[t.uuid]=t,t.matrix=(new THREE.Matrix4).fromArray(t.matrix);var e=t.geometry.uvs,n=Number.MAX_VALUE,r=Number.MAX_VALUE,i=Number.MIN_VALUE,o=Number.MIN_VALUE;if(e&&e.length>0)for(var s=0;s<e.length;++s){var a=e[s];if(a){var u=a[0],c=a[1];n=Math.min(n,u),i=Math.max(i,u),r=Math.min(r,c),o=Math.max(o,c)}}else n=0,i=1,r=0,o=1;if(this.setProperty(t.uuid,"minU",n),this.setProperty(t.uuid,"maxU",i),this.setProperty(t.uuid,"minV",r),this.setProperty(t.uuid,"maxV",o),this.setProperty(t.uuid,"geomID",t.geometry.uuid),!this.geometryCache[t.geometry.uuid]){this.geometryCache[t.geometry.uuid]=t.geometry;for(var l=0,h=t.geometry.vertices,d=h.length;d>l;++l)h[l]=(new THREE.Vector3).fromArray(h[l])}this.updateObjects([t])},t.prototype.updateObjects=function(t){for(var e=0;e<t.length;++e){var n=t[e];if(n.inScene!==!1){var r=this.objects[n.uuid];null!==n.matrix&&r.matrix.fromArray(n.matrix),null!==n.visible&&this.setProperty(n.uuid,"visible",n.visible),null!==n.disabled&&this.setProperty(n.uuid,"disabled",n.disabled)}else{delete this.objects[n.uuid];for(var i=!1,o=0;!i&&o<this.objectIDs.length;++o){var s=this.objects[this.objectIDs[o]];i=i||s&&s.geomID===n.geomID}i||delete this.geometryCache[n.geomID],this.objectIDs.splice(this.objectIDs.indexOf(n.uuid),1)}}},t.prototype.setProperty=function(t,e,n){for(var r=this.objects[t],i=e.split(".");i.length>1;)e=i.shift(),r[e]||(r[e]={}),r=r[e];1===i.length&&(e=i[0],r[i[0]]=n)},t.prototype.projectPointer=function(t){var e=t[0],n=t[1],r=null;this.p.fromArray(e),this.f.fromArray(n);for(var i=0;i<this.objectIDs.length;++i){var o=this.objectIDs[i],s=this.objects[o];if(!s.disabled)for(var a=this._getVerts(s),u=s.geometry.faces,c=s.geometry.uvs,l=0;l<u.length;++l){var h=u[l],d=a[h[0]%a.length],f=a[h[1]%a.length],m=a[h[2]%a.length];if(this.a.subVectors(f,d),this.b.subVectors(m,d),this.c.subVectors(this.p,this.f),this.m.set(this.a.x,this.b.x,-this.c.x,0,this.a.y,this.b.y,-this.c.y,0,this.a.z,this.b.z,-this.c.z,0,0,0,0,1),Math.abs(this.m.determinant())>1e-10&&(this.m.getInverse(this.m),this.d.subVectors(this.f,d).applyMatrix4(this.m),0<=this.d.x&&this.d.x<=1&&0<=this.d.y&&this.d.y<=1&&this.d.z>0)){this.c.multiplyScalar(this.d.z).add(this.f);var p=Math.sign(this.d.z)*this.p.distanceTo(this.c);if((!r||p<r.distance)&&(r={objectID:o,distance:p,faceIndex:l,facePoint:this.c.toArray(),faceNormal:this.d.toArray()},c)){d=c[h[0]%c.length],f=c[h[1]%c.length],m=c[h[2]%c.length];var y=this.d.x*(f[0]-d[0])+this.d.y*(m[0]-d[0])+d[0],g=this.d.x*(f[1]-d[1])+this.d.y*(m[1]-d[1])+d[1];s.minU<=y&&y<=s.maxU&&s.minV<=g&&g<s.maxV?r.point=[y,g]:r=null}}}}this._emit("hit",r)},t}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},_get=function t(e,n,r){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,n);if(void 0===i){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,r)}if("value"in i)return i.value;var s=i.get;if(void 0!==s)return s.call(r)},_createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.Surface=function(){var t=0,e=function(e){function n(e){_classCallCheck(this,n);var r=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this));if(e=patch(e,{id:"Primrose.Surface["+t++ +"]"}),r.listeners.move=[],r.bounds=e.bounds||new Primrose.Text.Rectangle,r.canvas=null,r.context=null,r._opacity=1,r.style={},Object.defineProperties(r.style,{width:{get:function(){return r.bounds.width},set:function(t){r.bounds.width=t,r.resize()}},height:{get:function(){return r.bounds.height},set:function(t){r.bounds.height=t,r.resize()}},left:{get:function(){return r.bounds.left},set:function(t){r.bounds.left=t}},top:{get:function(){return r.bounds.top},set:function(t){r.bounds.top=t}},opacity:{get:function(){return r._opacity},set:function(t){r._opacity=t}},fontSize:{get:function(){return r.fontSize},set:function(t){r.fontSize=t}},backgroundColor:{get:function(){return r.backgroundColor},set:function(t){r.backgroundColor=t}},color:{get:function(){return r.color},set:function(t){r.color=t}}
}),e.id instanceof n)throw new Error("Object is already a Surface. Please don't try to wrap them.");if(e.id instanceof CanvasRenderingContext2D?(r.context=e.id,r.canvas=r.context.canvas):e.id instanceof HTMLCanvasElement?r.canvas=e.id:("string"==typeof e.id||e.id instanceof String)&&(r.canvas=document.getElementById(e.id),null===r.canvas?(r.canvas=document.createElement("canvas"),r.canvas.id=e.id):"CANVAS"!==r.canvas.tagName&&(r.canvas=null)),null===r.canvas)throw console.error(_typeof(e.id)),console.error(e.id),new Error(e.id+" does not refer to a valid canvas element.");return r.id=r.canvas.id,0===r.bounds.width&&(r.bounds.width=r.imageWidth,r.bounds.height=r.imageHeight),r.imageWidth=r.bounds.width,r.imageHeight=r.bounds.height,null===r.context&&(r.context=r.canvas.getContext("2d")),r.canvas.style.imageRendering=isChrome?"pixelated":"optimizespeed",r.context.imageSmoothingEnabled=!1,r.context.textBaseline="top",r._texture=null,r._material=null,r}return _inherits(n,e),_createClass(n,null,[{key:"create",value:function(){return new n}}]),_createClass(n,[{key:"addToBrowserEnvironment",value:function(t,e){var n="shell"===this.className?shell(3,10,10):quad(2,2),r=textured(n,this,{opacity:this._opacity});return e.add(r),t.registerPickableObject(r),r}},{key:"invalidate",value:function(t){t?t instanceof Primrose.Text.Rectangle&&(t=t.clone()):(t=this.bounds.clone(),t.left=0,t.top=0);for(var e=0;e<this.children.length;++e){var n=this.children[e],r=t.overlap(n.bounds);if(r){var i=r.left-n.bounds.left,o=r.top-n.bounds.top;this.context.drawImage(n.canvas,i,o,r.width,r.height,r.x,r.y,r.width,r.height)}}this._texture&&(this._texture.needsUpdate=!0),this._material&&(this._material.needsUpdate=!0),this.parent&&this.parent.invalidate&&(t.left+=this.bounds.left,t.top+=this.bounds.top,this.parent.invalidate(t))}},{key:"resize",value:function(){this.setSize(this.surfaceWidth,this.surfaceHeight)}},{key:"setSize",value:function(t,e){var n=this.context.textBaseline,r=this.context.textAlign;this.imageWidth=t,this.imageHeight=e,this.context.textBaseline=n,this.context.textAlign=r}},{key:"appendChild",value:function(t){if(!(t instanceof n))throw new Error("Can only append other Surfaces to a Surface. You gave: "+t);_get(Object.getPrototypeOf(n.prototype),"appendChild",this).call(this,t),this.invalidate()}},{key:"mapUV",value:function(t){return{x:t[0]*this.imageWidth,y:(1-t[1])*this.imageHeight}}},{key:"unmapUV",value:function(t){return[t.x/this.imageWidth,1-t.y/this.imageHeight]}},{key:"_findChild",value:function(t,e,n){for(var r=this.inBounds(t,e),i=null,o=this.children.length-1;o>=0;--o){var s=this.children[o];!i&&s.inBounds(t-this.bounds.left,e-this.bounds.top)?i=s:s.focused&&s.blur()}return i||r&&this}},{key:"DOMInBounds",value:function(t,e){return this.inBounds(t*devicePixelRatio,e*devicePixelRatio)}},{key:"UVInBounds",value:function(t){return this.inBounds(t[0]*this.imageWidth,(1-t[1])*this.imageHeight)}},{key:"inBounds",value:function(t,e){return this.bounds.left<=t&&t<this.bounds.right&&this.bounds.top<=e&&e<this.bounds.bottom}},{key:"startDOMPointer",value:function(t){this.startPointer(x*devicePixelRatio,y*devicePixelRatio)}},{key:"moveDOMPointer",value:function(t){this.movePointer(x*devicePixelRatio,y*devicePixelRatio)}},{key:"startPointer",value:function(t,e){if(this.inBounds(t,e)){var n=this._findChild(t,e,function(t,e,n){return t.startPointer(e,n)});n?(this.focused||this.focus(),emit.call(this,"click",{target:n,x:t,y:e}),n!==this&&n.startPointer(t-this.bounds.left,e-this.bounds.top)):this.focused&&this.blur()}}},{key:"movePointer",value:function(t,e){var n=this._findChild(t,e,function(t,e,n){return t.startPointer(e,n)});n&&(emit.call(this,"move",{target:n,x:t,y:e}),n!==this&&n.movePointer(t-this.bounds.left,e-this.bounds.top))}},{key:"startUV",value:function(t){var e=this.mapUV(t);this.startPointer(e.x,e.y)}},{key:"moveUV",value:function(t){var e=this.mapUV(t);this.movePointer(e.x,e.y)}},{key:"imageWidth",get:function(){return this.canvas.width},set:function(t){this.canvas.width=t,this.bounds.width=t}},{key:"imageHeight",get:function(){return this.canvas.height},set:function(t){this.canvas.height=t,this.bounds.height=t}},{key:"elementWidth",get:function(){return this.canvas.clientWidth*devicePixelRatio},set:function(t){this.canvas.style.width=t/devicePixelRatio+"px"}},{key:"elementHeight",get:function(){return this.canvas.clientHeight*devicePixelRatio},set:function(t){this.canvas.style.height=t/devicePixelRatio+"px"}},{key:"surfaceWidth",get:function(){return this.canvas.parentElement?this.elementWidth:this.bounds.width}},{key:"surfaceHeight",get:function(){return this.canvas.parentElement?this.elementHeight:this.bounds.height}},{key:"resized",get:function(){return this.imageWidth!==this.surfaceWidth||this.imageHeight!==this.surfaceHeight}},{key:"texture",get:function(){return this._texture||(this._texture=new THREE.Texture(this.canvas)),this._texture}}]),n}(Primrose.Entity);return e}(),Primrose.WebRTCSocket=function(){function t(t,e){function n(t,e,n){n.fromIndex=t,n.toIndex=e,s[e].setLocalDescription(n,function(){o.emit(n.type,n)})}function r(t,e,n){if(e.fromIndex===t){var r=new RTCSessionDescription(e);s[t].setRemoteDescription(r,n)}}function i(t){function e(){a[t]=null,s[t]=null;var e=0===a.filter(function(t){return t}).length;if(e&&u.close)for(var n=0;n<u.close.length;++n){var r=u.close[n];r&&r.call(this)}}a[t].addEventListener("open",function(){if(u.open)for(var t=0;t<u.open.length;++t){var e=u.open[t];e&&e.call(this)}},!1),a[t].addEventListener("message",function(t){var e=JSON.parse(t.data),n=e.shift();if(u[n])for(var r=0;r<u[n].length;++r){var i=u[n][r];i&&i.apply(this,e)}},!1),a[t].addEventListener("error",e,!1),a[t].addEventListener("close",e,!1)}var o,s=[],a=[],u={},c=null;if("string"==typeof t)o=io.connect(t,{reconnect:!0,"reconnection delay":1e3,"max reconnection attempts":60});else{if(!(t&&t.on&&t.emit))throw console.error("proxy error",o),new Error("need a socket");o=t}this.on=function(t,e){u[t]||(u[t]=[]),u[t].push(e)},this.emit=function(t){for(var e=JSON.stringify(t),n=0;n<a.length;++n){var r=a[n];r&&"open"===r.readyState&&r.send(e)}},this.close=function(){a.forEach(function(t){t&&"open"===t.readyState&&t.close()}),s.forEach(function(t){t&&t.close()})},window.addEventListener("unload",this.close.bind(this)),this.connect=function(t){o.emit("handshake","peer"),o.on("handshakeComplete",function(e){"peer"===e&&o.emit("joinRequest",t)})},o.on("user",function(t,u){try{if(null===c&&(c=t),!s[u]){var l=new RTCPeerConnection({iceServers:["stun.l.google.com:19302","stun1.l.google.com:19302","stun2.l.google.com:19302","stun3.l.google.com:19302","stun4.l.google.com:19302"].map(function(t){return{url:"stun:"+t}})});if(s[u]=l,l.addEventListener("icecandidate",function(t){t.candidate&&(t.candidate.fromIndex=c,t.candidate.toIndex=u,o.emit("ice",t.candidate))},!1),o.on("ice",function(t){t.fromIndex===u&&s[u].addIceCandidate(new RTCIceCandidate(t))}),e===!0||void 0===e&&u>c){l.addEventListener("negotiationneeded",function(t){l.createOffer(n.bind(this,c,u),console.error.bind(console,"createOffer error"))});var h=l.createDataChannel("data-channel-"+c+"-to-"+u,{id:c,ordered:!1,maxRetransmits:0});a[u]=h,i(u),o.on("answer",function(t){t.fromIndex===u&&r(u,t)})}else(e===!1||void 0===e&&c>u)&&(l.addEventListener("datachannel",function(t){t.channel.id===u&&(a[t.channel.id]=t.channel,i(u))},!1),o.on("offer",function(t){t.fromIndex===u&&r(u,t,function(){s[u].createAnswer(n,console.error.bind(console,"createAnswer error"))})}))}}catch(d){console.error(d)}})}return Window.prototype.RTCPeerConnection=Window.prototype.RTCPeerConnection||Window.prototype.webkitRTCPeerConnection||Window.prototype.mozRTCPeerConnection||function(){},Window.prototype.RTCIceCandidate=Window.prototype.RTCIceCandidate||Window.prototype.mozRTCIceCandidate||function(){},Window.prototype.RTCSessionDescription=Window.prototype.RTCSessionDescription||Window.prototype.mozRTCSessionDescription||function(){},t}(),Primrose.Workerize=function(){function t(e){var n,r=e.toString(),i=r.match(/function\s+(\w+)\s*\(/),o=i[1];for(n in e.prototype)r+="\n\n"+o+".prototype."+n+" = "+e.prototype[n].toString()+";";r+="\n\n(function(){\n  var instance = new "+o+"(true);",r+="\n  if(instance.addEventListener){\n    self.args = [null, null];\n    for(var k in instance.listeners) {\n      instance.addEventListener(k, function(eventName, args){\n        self.args[0] = eventName;\n        self.args[1] = args;\n        postMessage(self.args);\n      }.bind(this, k));\n    }\n  }",r+="\n\n  onmessage = function(evt){\n    var f = evt.data[0],\n        t = instance[f];\n    if(t){\n      t.call(instance, evt.data[1]);\n    }\n  };\n\n})();",this.worker=t.createWorker(r,!1),this.args=[null,null],this.listeners={},this.worker.onmessage=function(t){emit.call(this,t.data[0],t.data[1])}.bind(this);for(n in e.prototype)"addEventListener"!==n&&"_"!==n[0]&&(this[n]=this.methodShim.bind(this,n));this.ready=!0}return t.prototype.methodShim=function(t,e){this.args[0]=t,this.args[1]=e,this.worker.postMessage(this.args)},t.prototype.addEventListener=function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)},t.createWorker=function(t,e){if("function"==typeof t&&(t=t.toString()),e){t=t.trim();var n=t.indexOf("{");t=t.substring(n+1,t.length-1)}var r=new Blob([t],{type:"text/javascript"}),i=URL.createObjectURL(r);return new Worker(i)},t}(),Primrose.X.LoginForm=function(){var t=0,e=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,"Primrose.X.LoginForm["+t++ +"]"));return e.listeners.login=[],e.listeners.signup=[],e.frame=new Primrose.Surface({id:e.id+"-frame",bounds:new Primrose.Text.Rectangle(0,0,512,150)}),e.labelUserName=new Primrose.Controls.Label({id:e.id+"-labelUserName",bounds:new Primrose.Text.Rectangle(0,0,256,50),fontSize:32,value:"User name:",textAlign:"right"}),e.userName=new Primrose.Text.Controls.TextInput({id:e.id+"-userName",bounds:new Primrose.Text.Rectangle(256,0,256,50),fontSize:32}),e.labelPassword=new Primrose.Controls.Label({id:e.id+"-labelPassword",bounds:new Primrose.Text.Rectangle(0,50,256,50),fontSize:32,value:"Password:",textAlign:"right"}),e.password=new Primrose.Text.Controls.TextInput({id:e.id+"-password",bounds:new Primrose.Text.Rectangle(256,50,256,50),fontSize:32,passwordCharacter:"*"}),e.signupButton=new Primrose.Controls.Button2D({id:e.id+"-signupButton",bounds:new Primrose.Text.Rectangle(0,100,256,50),fontSize:32,value:"Sign up"}),e.loginButton=new Primrose.Controls.Button2D({id:e.id+"-loginButton",bounds:new Primrose.Text.Rectangle(256,100,256,50),fontSize:32,value:"Login"}),e.loginButton.addEventListener("click",function(t){return emit.call(e,"login",{target:e})},!1),e.signupButton.addEventListener("click",function(t){return emit.call(e,"signup",{target:e})},!1),e.mesh=textured(quad(1,150/512),e.frame),e.mesh.name="LoginForm",e.frame.appendChild(e.labelUserName),e.frame.appendChild(e.userName),e.frame.appendChild(e.labelPassword),e.frame.appendChild(e.password),e.frame.appendChild(e.signupButton),e.frame.appendChild(e.loginButton),e.appendChild(e.frame),e}return _inherits(n,e),n}(Primrose.Entity);return e}(),Primrose.X.SignupForm=function(){var t=0,e=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,"Primrose.X.SignupForm["+t++ +"]"));return e.listeners.login=[],e.listeners.signup=[],e.frame=new Primrose.Surface({id:e.id+"-frame",bounds:new Primrose.Text.Rectangle(0,0,512,200)}),e.labelUserName=new Primrose.Controls.Label({id:e.id+"-labelUserName",bounds:new Primrose.Text.Rectangle(0,0,256,50),fontSize:32,value:"User name:",textAlign:"right"}),e.userName=new Primrose.Text.Controls.TextInput({id:e.id+"-userName",bounds:new Primrose.Text.Rectangle(256,0,256,50),fontSize:32}),e.labelEmail=new Primrose.Controls.Label({id:e.id+"-labelEmail",bounds:new Primrose.Text.Rectangle(0,50,256,50),fontSize:32,value:"Email:",textAlign:"center"}),e.email=new Primrose.Text.Controls.TextInput({id:e.id+"-email",bounds:new Primrose.Text.Rectangle(256,50,256,50),fontSize:32}),e.labelPassword=new Primrose.Controls.Label({id:e.id+"-labelPassword",bounds:new Primrose.Text.Rectangle(0,100,256,50),fontSize:32,value:"Password:",textAlign:"left"}),e.password=new Primrose.Text.Controls.TextInput({id:e.id+"-password",bounds:new Primrose.Text.Rectangle(256,100,256,50),fontSize:32,passwordCharacter:"*"}),e.loginButton=new Primrose.Controls.Button2D({id:e.id+"-loginButton",bounds:new Primrose.Text.Rectangle(0,150,256,50),fontSize:32,value:"Login"}),e.signupButton=new Primrose.Controls.Button2D({id:e.id+"-signupButton",bounds:new Primrose.Text.Rectangle(256,150,256,50),fontSize:32,value:"Sign up"}),e.loginButton.addEventListener("click",function(t){return emit.call(e,"login",{target:e})},!1),e.signupButton.addEventListener("click",function(t){return emit.call(e,"signup",{target:e})},!1),e.mesh=textured(quad(1,.390625),e.frame),e.mesh.name="SignupForm",e.frame.appendChild(e.labelUserName),e.frame.appendChild(e.userName),e.frame.appendChild(e.labelEmail),e.frame.appendChild(e.email),e.frame.appendChild(e.labelPassword),e.frame.appendChild(e.password),e.frame.appendChild(e.loginButton),e.frame.appendChild(e.signupButton),e.appendChild(e.frame),e}return _inherits(n,e),n}(Primrose.Entity);return e}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.Controls.Label=function(){var t=0,e=function(e){function n(e){_classCallCheck(this,n);var r=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,patch(e,{id:"Primrose.Controls.Label["+t++ +"]"})));return"string"==typeof e?r.options={value:r.options}:r.options=e||{},r._lastFont=null,r._lastText=null,r._lastCharacterWidth=null,r._lastCharacterHeight=null,r._lastPadding=null,r._lastWidth=-1,r._lastHeight=-1,r._lastTextAlign=null,r.textAlign=r.options.textAlign,r.character=new Primrose.Text.Size,r.theme=r.options.theme,r.fontSize=r.options.fontSize||16,r.refreshCharacter(),r.value=r.options.value,r.backgroundColor=r.options.backgroundColor||r.theme.regular.backColor,r.color=r.options.color||r.theme.regular.foreColor,r}return _inherits(n,e),_createClass(n,[{key:"refreshCharacter",value:function(){this.character.height=this.fontSize,this.context.font=this.character.height+"px "+this.theme.fontFamily,this.character.width=this.context.measureText("MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM").width/100}},{key:"_isChanged",value:function(){var t=this._lastText!==this.value,e=this.character.width!==this._lastCharacterWidth,n=this.character.height!==this._lastCharacterHeight,r=this.context.font!==this._lastFont,i=this.textAlign!==this._lastTextAlign,o=this.resized||t||e||n||this.resized||r||i;return o}},{key:"render",value:function(){if(this.resized&&this.resize(),this.theme&&this._isChanged){this._lastText=this.value,this._lastCharacterWidth=this.character.width,this._lastCharacterHeight=this.character.height,this._lastWidth=this.imageWidth,this._lastHeight=this.imageHeight,this._lastFont=this.context.font,this._lastTextAlign=this.textAlign,this.context.textAlign=this.textAlign||"left";var t=this.backgroundColor?"fillRect":"clearRect";if(this.theme.regular.backColor&&(this.context.fillStyle=this.backgroundColor),this.context[t](0,0,this.imageWidth,this.imageHeight),this.value)for(var e=this.value.split("\n"),n=0;n<e.length;++n){var r=e[n],i=(this.imageHeight-e.length*this.character.height)/2+n*this.character.height,o=null;switch(this.textAlign){case"right":o=this.imageWidth;break;case"center":o=this.imageWidth/2;break;default:o=0}var s=(this.theme.regular.fontWeight||"")+" "+(this.theme.regular.fontStyle||"")+" "+this.character.height+"px "+this.theme.fontFamily;this.context.font=s.trim(),this.context.fillStyle=this.color,this.context.fillText(r,o,i)}this.renderCanvasTrim(),this.invalidate()}}},{key:"renderCanvasTrim",value:function(){}},{key:"textAlign",get:function(){return this.context.textAlign},set:function(t){this.context.textAlign=t,this.render()}},{key:"value",get:function(){return this._value},set:function(t){t=t||"",this._value=t.replace(/\r\n/g,"\n"),this.render()}},{key:"theme",get:function(){return this._theme},set:function(t){this._theme=clone(t||Primrose.Text.Themes.Default),this._theme.fontSize=this.fontSize,this.refreshCharacter(),this.render()}}]),n}(Primrose.Surface);return e}();var _get=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,r)}if("value"in i)return i.value;var s=i.get;if(void 0!==s)return s.call(r)},_createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.Controls.Button2D=function(){var t=0,e=function(e){function n(e){_classCallCheck(this,n);var r=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,patch(e,{id:"Primrose.Controls.Button2D["+t++ +"]",textAlign:"center"})));return r._lastActivated=null,r}return _inherits(n,e),_createClass(n,null,[{key:"create",value:function(){return new n}}]),_createClass(n,[{key:"addToBrowserEnvironment",value:function(t,e){var n=t.buttonFactory.create();return n.listeners=this.listeners,t.appendChild(n)}},{key:"startPointer",value:function(t,e){this.focus(),this._activated=!0,this.render()}},{key:"endPointer",value:function(){this._activated&&(this._activated=!1,emit.call(this,"click",{target:this}),this.render())}},{key:"_isChanged",value:function(){var t=this._activated!==this._lastActivated,e=_get(Object.getPrototypeOf(n.prototype),"_isChanged",this)||t;return e}},{key:"renderCanvasTrim",value:function(){this.context.lineWidth=this._activated?4:2,this.context.strokeStyle=this.theme.regular.foreColor||Primrose.Text.Themes.Default.regular.foreColor,this.context.strokeRect(0,0,this.imageWidth,this.imageHeight)}}]),n}(Primrose.Controls.Label);return e}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.Controls.Button3D=function(){var t=function(t){function e(t,n,r){_classCallCheck(this,e);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this));return r=patch(r,e),r.minDeflection=Math.cos(r.minDeflection),r.colorUnpressed=new THREE.Color(r.colorUnpressed),r.colorPressed=new THREE.Color(r.colorPressed),i.listeners.click=[],i.listeners.release=[],i.base=t.children[1],i.cap=t.children[0],i.cap.name=n,i.cap.material=i.cap.material.clone(),i.cap.button=i,i.cap.base=i.base,i.container=new THREE.Object3D,i.container.add(i.base),i.container.add(i.cap),i.color=i.cap.material.color,i.name=n,i.element=null,i.startUV=function(){this.color.copy(r.colorPressed),this.element?this.element.click():emit.call(this,"click")},i.moveUV=function(){},i.endPointer=function(){this.color.copy(r.colorUnpressed),emit.call(this,"release")},i}return _inherits(e,t),_createClass(e,[{key:"addToBrowserEnvironment",value:function(t,e){return e.add(this.container),t.registerPickableObject(this.cap),this.container}},{key:"position",get:function(){return this.container.position}}]),e}(Primrose.BaseControl);return t.DEFAULTS={maxThrow:.1,minDeflection:10,colorUnpressed:8323072,colorPressed:32512,toggle:!0},t}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.Controls.HtmlDoc=function(){var t=0,e=function(e){function n(e){_classCallCheck(this,n);var r=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,patch(e,{id:"Primrose.Controls.HtmlDoc["+t++ +"]"})));return"string"==typeof e?r.options={element:r.options}:r.options=e||{},r._lastImage=null,r._image=null,r.element=r.options.element,r}return _inherits(n,e),_createClass(n,null,[{key:"create",value:function(){return new n}}]),_createClass(n,[{key:"addToBrowserEnvironment",value:function(t,e){var n=textured(quad(2,2),this);return e.add(n),t.registerPickableObject(n),n}},{key:"_render",value:function(){var t=this;html2canvas(this._element,{onrendered:function(e){t._image=e,t.setSize(e.width,e.height),t.render()}})}},{key:"render",value:function(){this._image!==this._lastImage&&(this._lastImage=this._image,this.context.fillStyle="white",this.context.fillRect(0,0,this.imageWidth,this.imageHeight),this.context.drawImage(this._image,0,0),this.invalidate())}},{key:"element",get:function(){return this._element},set:function(t){t&&(this._element=Primrose.DOM.cascadeElement(t,"DIV",HTMLDivElement),this._element.style.position="absolute",this._element.style.display="",this._element.style.width=px(this.bounds.width),this._element.style.height=px(this.bounds.height),document.body.appendChild(Primrose.DOM.makeHidingContainer(this.id+"-hider",this._element)),this._render())}},{key:"value",get:function(){return this._element.innerHTML},set:function(t){t!==this._element.innerHTML&&(this._element.innerHTML=t,this._render())}}]),n}(Primrose.Surface);return e}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.Controls.Image=function(){var t=0,e=window.Image,n={},r=function(r){function i(e){_classCallCheck(this,i),e=e||{},"string"==typeof e&&(e={value:e});var n=_possibleConstructorReturn(this,Object.getPrototypeOf(i).call(this,patch(e,{id:"Primrose.Controls.Image["+t++ +"]",bounds:new Primrose.Text.Rectangle(0,0,1,1)})));return n.listeners.load=[],n._lastWidth=-1,n._lastHeight=-1,n._lastImage=null,n._images=[],n._currentImageIndex=0,n.className="",setTimeout(function(){e.value&&(/\.stereo\./.test(e.value)?n.loadStereoImage(e.value):n.loadImage(e.value))}),n}return _inherits(i,r),_createClass(i,null,[{key:"create",value:function(){return new i}}]),_createClass(i,[{key:"addToBrowserEnvironment",value:function(t,e){var n=textured(quad(.5,.5*this.imageHeight/this.imageWidth),this);return e.add(n),t.registerPickableObject(n),n}},{key:"loadImage",value:function(t,r){var i=this;return"number"==typeof t||t instanceof Number||(r=t,t=0),new Promise(function(t,i){if(n[r])t(n[r]);else if(r){var o=new e;o.addEventListener("load",function(){n[r]=o,t(n[r])},!1),o.addEventListener("error",function(){i("error loading image")},!1),o.src=r}else i("Image was null")}).then(function(e){return i.setImage(t,e),e})["catch"](function(e){console.error("Failed to load image "+r),console.error(e),i.setImage(t,null)})}},{key:"loadStereoImage",value:function(t){var e=this;return this.loadImage(t).then(function(t){var n=new Primrose.Text.Rectangle(0,0,t.width/2,t.height),r=new Primrose.Surface({id:e.id+"-left",bounds:n}),i=new Primrose.Surface({id:e.id+"-right",bounds:n});return r.context.drawImage(t,0,0),i.context.drawImage(t,-n.width,0),e.setImage(0,r.canvas),e.setImage(1,i.canvas),e.bounds.width=n.width,e.bounds.height=n.height,e.render(),emit.call(e,"load",{target:e}),e})}},{key:"getImage",value:function(t){return this._images[t%this._images.length]}},{key:"setImage",value:function(t,e){this._images[t]=e,this.render()}},{key:"eyeBlank",value:function(t){this._currentImageIndex=t,this.render()}},{key:"render",value:function(t){(this._changed||t)&&(this.resized?this.resize():this.image!==this._lastImage&&this.context.clearRect(0,0,this.imageWidth,this.imageHeight),this.image&&this.context.drawImage(this.image,0,0),this._lastWidth=this.imageWidth,this._lastHeight=this.imageHeight,this._lastImage=this.image,this.invalidate())}},{key:"src",get:function(){return this.getImage(this._currentImageIndex).src},set:function(t){"stereo"===this.className?this.loadStereoImage(t):this.loadImage(0,src)}},{key:"image",get:function(){return this.getImage(this._currentImageIndex)},set:function(t){this.setImage(this._currentImageIndex,t)}},{key:"_changed",get:function(){return this.resized||this.image!==this._lastImage}}]),i}(Primrose.Surface);return r}(),Primrose.DOM.cascadeElement=function(t,e,n){var r=null;if(null===t?(r=document.createElement(e),r.id=t="auto_"+e+Date.now()):void 0===n||t instanceof n?r=t:"string"==typeof t&&(r=document.getElementById(t),null===r?(r=document.createElement(e),r.id=t):r.tagName!==e.toUpperCase()&&(r=null)),null===r)throw new Error(t+" does not refer to a valid "+e+" element.");return r},Primrose.DOM.findEverything=function(t,e){t=t||document,e=e||{};for(var n=t.querySelectorAll("*"),r=0;r<n.length;++r){var i=n[r];i.id&&i.id.length>0&&(e[i.id]=i,i.parentElement&&(i.parentElement[i.id]=i))}return e},Primrose.DOM.makeHidingContainer=function(t,e){var n=Primrose.DOM.cascadeElement(t,"div",window.HTMLDivElement);return n.style.position="absolute",n.style.left=0,n.style.top=0,n.style.width=0,n.style.height=0,n.style.overflow="hidden",n.appendChild(e),n},Primrose.DOM.StateList=function(){var t=function e(t,n,r,i,o){_classCallCheck(this,e);for(var s=Primrose.DOM.cascadeElement(t,"select",HTMLSelectElement),a=0;a<r.length;++a){var u=document.createElement("option");u.appendChild(document.createTextNode(r[a].name)),s.appendChild(u)}s.addEventListener("change",function(){var t=r[s.selectedIndex].values;if(void 0!==t){for(var e in t)if(t.hasOwnProperty(e)){var o=t[e];for(var a in o)o.hasOwnProperty(a)&&(n[e][a]=o[a])}i&&i()}}.bind(this),!1),this.DOMElement=s,o&&o.appendChild(this.DOMElement)};return t}(),Primrose.HTTP.get=function(t,e,n){return Primrose.HTTP.XHR("GET",t||"text",e,n)},Primrose.HTTP.getBuffer=function(t,e){return Primrose.HTTP.get("arraybuffer",t,e)},Primrose.HTTP.getObject=function(t,e){return Primrose.HTTP.get("json",t,e)},Primrose.HTTP.getText=function(t,e){return Primrose.HTTP.get("text",t,e)},Primrose.HTTP.post=function(t,e,n){return Primrose.HTTP.XHR("POST",t,e,n)},Primrose.HTTP.sendObject=function(t,e){return Primrose.HTTP.post("json",t,e)},Primrose.HTTP.XHR=function(t,e,n,r){return new Promise(function(i,o){r=r||{},r.headers=r.headers||{},"POST"===t&&(r.headers["Content-Type"]=r.headers["Content-Type"]||e);var s=new XMLHttpRequest;s.onerror=function(t){return o(new Error("Request error: "+t.message))},s.onabort=function(t){return o(new Error("Request abort: "+t.message))},s.onload=function(){s.status<400?i(s.response):o(s)},s.open(t,n),e&&(s.responseType=e),s.onprogress=r.progress;for(var a in r.headers)s.setRequestHeader(a,r.headers[a]);s.withCredentials=!!r.withCredentials,r.data?s.send(JSON.stringify(r.data)):s.send()})},Primrose.Input.Camera=function(){function t(e,n,r,i,o,s,a){MediaStreamTrack.getSources(function(t){var r=document.createElement("option");r.value="",r.innerHTML="-- select camera --",e.appendChild(r);for(var i=0;i<t.length;++i)"video"===t[i].kind&&(r=document.createElement("option"),r.value=t[i].id,r.innerHTML=fmt("[Facing: $1] [ID: $2...]",t[i].facing||"N/A",t[i].id.substring(0,8)),r.selected=t[i].id===n,e.appendChild(r))}),this.options=patch(a,t),this.videoElement=document.createElement("video"),this.buffer=document.createElement("canvas"),this.gfx=this.buffer.getContext("2d"),this.texture=new THREE.Texture(this.buffer);var u=new THREE.MeshBasicMaterial({map:this.texture,useScreenCoordinates:!1,color:16777215,shading:THREE.FlatShading});this.gfx.width=500,this.gfx.height=500,this.gfx.fillStyle="white",this.gfx.fillRect(0,0,500,500);var c=new THREE.PlaneGeometry(r,r);c.computeBoundingBox(),c.computeVertexNormals(),this.mesh=new THREE.Mesh(c,u),this.mesh.position.set(i,o,s),this.streaming=!1,this.videoElement.autoplay=1;var l=function(t,e,n){navigator.getUserMedia({video:t},function(t){streamURL=window.URL.createObjectURL(t),this.videoElement.src=streamURL,e()}.bind(this),n)}.bind(this),h=function(t,e,n){if(n=n||0,this.options.videoModes&&n<this.options.videoModes.length){var r=this.options.videoModes[n],i={optional:[{sourceId:t}]};"default"!==r&&(i.mandatory={minWidth:r.w,minHeight:r.h},r=fmt("[w:$1, h:$2]",r.w,r.h)),l(i,function(){console.log(fmt("Connected to camera at mode $1.",r))},function(e){console.error(fmt("Failed to connect at mode $1. Reason: $2",r,e)),h(t,e,n+1)})}else e("no video modes specified.")}.bind(this);this.videoElement.addEventListener("canplay",function(){this.streaming||(this.streaming=!0)}.bind(this),!1),this.videoElement.addEventListener("playing",function(){this.videoElement.height=this.buffer.height=this.videoElement.videoHeight,this.videoElement.width=this.buffer.width=this.videoElement.videoWidth;var t=this.videoElement.videoWidth/this.videoElement.videoHeight;this.mesh.scale.set(t,1,1)}.bind(this),!1),this.connect=function(t){if(this.streaming)try{window.stream&&window.stream.stop(),this.videoElement.src=null,this.streaming=!1}catch(e){console.error(e),console.error("While stopping")}h(t,function(t){console.error(fmt("Couldn't connect at requested resolutions. Reason: $1",t)),l(!0,console.log.bind(console,"Connected to camera at default resolution"),console.error.bind(console,"Final connect attempt"))})}.bind(this),n&&this.connect(n)}return Navigator.prototype.getUserMedia=Navigator.prototype.getUserMedia||Navigator.prototype.webkitGetUserMedia||Navigator.prototype.mozGetUserMedia||Navigator.prototype.msGetUserMedia||Navigator.prototype.oGetUserMedia||function(){},t.DEFAULTS={videoModes:[{w:320,h:240},{w:640,h:480},"default"]},t.prototype.update=function(){this.gfx.drawImage(this.videoElement,0,0),this.texture.needsUpdate=!0},t}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.Input.FPSInput=function(){var t=["heading","pitch","roll","pointerPitch","headX","headY","headZ"],e=(new THREE.Quaternion,function(){function e(t){var n=this;_classCallCheck(this,e),t=t||window,this.listeners={zero:[],lockpointer:[],fullscreen:[],pointerstart:[],pointerend:[]},this.managers=[new Primrose.Input.VR,new Primrose.Input.Keyboard(window,{lockPointer:{buttons:[Primrose.Keys.ANY],commandUp:emit.bind(this,"lockpointer")},fullScreen:{buttons:[Primrose.Keys.F],commandDown:emit.bind(this,"fullscreen")},strafeLeft:{buttons:[-Primrose.Keys.A,-Primrose.Keys.LEFTARROW]},strafeRight:{buttons:[Primrose.Keys.D,Primrose.Keys.RIGHTARROW]},strafe:{commands:["strafeLeft","strafeRight"]},driveForward:{buttons:[-Primrose.Keys.W,-Primrose.Keys.UPARROW]},driveBack:{buttons:[Primrose.Keys.S,Primrose.Keys.DOWNARROW]},drive:{commands:["driveForward","driveBack"]},select:{buttons:[Primrose.Keys.ENTER]},dSelect:{buttons:[Primrose.Keys.ENTER],delta:!0},zero:{buttons:[Primrose.Keys.Z],metaKeys:[-Primrose.Keys.CTRL,-Primrose.Keys.ALT,-Primrose.Keys.SHIFT,-Primrose.Keys.META],commandUp:emit.bind(this,"zero")}}),new Primrose.Input.Mouse(t,{lockPointer:{buttons:[Primrose.Keys.ANY],commandDown:emit.bind(this,"lockpointer")},pointer:{buttons:[Primrose.Keys.ANY],commandDown:emit.bind(this,"pointerstart"),commandUp:emit.bind(this,"pointerend")},buttons:{axes:[Primrose.Input.Mouse.BUTTONS]},dButtons:{axes:[Primrose.Input.Mouse.BUTTONS],delta:!0},pointerX:{axes:[Primrose.Input.Mouse.X]},pointerY:{axes:[Primrose.Input.Mouse.Y]},dx:{axes:[-Primrose.Input.Mouse.X],delta:!0,scale:.005,min:-5,max:5},heading:{commands:["dx"],
integrate:!0},dy:{axes:[-Primrose.Input.Mouse.Y],delta:!0,scale:.005,min:-5,max:5},pitch:{commands:["dy"],integrate:!0,min:.5*-Math.PI,max:.5*Math.PI},pointerPitch:{commands:["dy"],integrate:!0,min:.25*-Math.PI,max:.25*Math.PI}}),new Primrose.Input.Touch(t,{lockPointer:{buttons:[Primrose.Keys.ANY],commandUp:emit.bind(this,"lockpointer")},pointer:{buttons:[Primrose.Keys.ANY],commandDown:emit.bind(this,"pointerstart"),commandUp:emit.bind(this,"pointerend")},buttons:{axes:[Primrose.Input.Touch.FINGERS]},dButtons:{axes:[Primrose.Input.Touch.FINGERS],delta:!0},pointerX:{axes:[Primrose.Input.Touch.X0]},pointerY:{axes:[Primrose.Input.Touch.Y0]},dx:{axes:[-Primrose.Input.Touch.X0],delta:!0,scale:.005,min:-5,max:5},heading:{commands:["dx"],integrate:!0},dy:{axes:[-Primrose.Input.Touch.Y0],delta:!0,scale:.005,min:-5,max:5},pitch:{commands:["dy"],integrate:!0,min:.5*-Math.PI,max:.5*Math.PI}}),new Primrose.Input.Gamepad({pointer:{buttons:[Primrose.Input.Gamepad.XBOX_BUTTONS.A],commandDown:emit.bind(this,"pointerstart"),commandUp:emit.bind(this,"pointerend")},strafe:{axes:[Primrose.Input.Gamepad.LSX],deadzone:.2},drive:{axes:[Primrose.Input.Gamepad.LSY],deadzone:.2},heading:{axes:[-Primrose.Input.Gamepad.RSX],deadzone:.2,integrate:!0},dheading:{commands:["heading"],delta:!0},pitch:{axes:[-Primrose.Input.Gamepad.RSY],deadzone:.2,integrate:!0}})],this.managers.forEach(function(t){return n[t.name]=t})}return _createClass(e,[{key:"zero",value:function(){this.vr&&this.vr.currentDisplay&&this.vr.currentDisplay.resetPose(),this.motion&&this.motion.zeroAxes();for(var e=0;e<this.managers.length;++e)for(var n=this.managers[e],r=0;n.enabled&&r<t.length;++r)n.setValue(t[r],0)}},{key:"update",value:function(){for(var t=0;t<this.managers.length;++t){var e=this.managers[t];e.enabled&&(e.poll&&e.poll(),e.update())}}},{key:"addEventListener",value:function(t,e,n){this.listeners[t]?this.listeners[t].push(e):this.managers.forEach(function(r){r.addEventListener&&r.addEventListener(t,e,n)})}},{key:"getValue",value:function(t){for(var e=0,n=0;n<this.managers.length;++n){var r=this.managers[n];r.enabled&&(e+=r.getValue(t))}return e}},{key:"getLatestValue",value:function(t){for(var e=0,n=Number.MIN_VALUE,r=0;r<this.managers.length;++r){var i=this.managers[r];i.enabled&&i.lastT>n&&(n=i.lastT,e=i.getValue(t))}return e}},{key:"getVector3",value:function(t,e,n,r){r=r||new THREE.Vector3,r.set(0,0,0);for(var i=0;i<this.managers.length;++i){var o=this.managers[i];o.enabled&&o.addVector3(t,e,n,r)}return r}},{key:"getVector3s",value:function(t,e,n,r){r=r||[];for(var i=0;i<this.managers.length;++i){var o=this.managers[i];o.enabled&&(r[i]=o.getVector3(t,e,n,r[i]))}return r}}]),e}());return e}(),Primrose.Input.Gamepad=function(){var t=function(t){function e(t,n,r){function i(t,e){var n=t.indexOf(e);n>-1&&t.splice(n,1)}function o(t,e){for(var n=0;n<t.length;++n)t[n](e)}function s(t){o(l.gamepadconnected,t)}function a(t){o(l.gamepaddisconnected,t)}_classCallCheck(this,e);var u=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,"Gamepad",t,n)),c=[],l={gamepadconnected:[],gamepaddisconnected:[]};u.checkDevice=function(t){var n;for(n=0;n<t.buttons.length;++n)this.setButton(n,t.buttons[n].pressed);for(n=0;n<t.axes.length;++n)this.setAxis(e.AXES[n],t.axes[n])},u.poll=function(){var t,e,n=[];if(t&&0!==t.length||(navigator.getGamepads?t=navigator.getGamepads():navigator.webkitGetGamepads&&(t=navigator.webkitGetGamepads())),t)for(e=0;e<t.length;++e){var i=t[e];i&&(r||(r=i.id),-1===c.indexOf(i.id)&&(c.push(i.id),s(i.id)),i.id===r&&this.checkDevice(i),n.push(i.id))}for(e=c.length-1;e>=0;--e)-1===n.indexOf(c[e])&&(a(c[e]),c.splice(e,1))},u.getErrorMessage=function(){return errorMessage},u.setGamepad=function(t){r=t,this.inPhysicalUse=!0},u.clearGamepad=function(){r=null,this.inPhysicalUse=!1},u.isGamepadSet=function(){return!!r},u.getConnectedGamepads=function(){return c.slice()},u.addEventListener=function(t,e,n){l[t]&&l[t].push(e),"gamepadconnected"===t&&c.forEach(s)},u.removeEventListener=function(t,e,n){l[t]&&i(l[t],e)};try{u.update(),u.available=!0}catch(h){console.error(h),u.avaliable=!1,u.errorMessage=h}return u}return _inherits(e,t),e}(Primrose.InputProcessor);return Primrose.InputProcessor.defineAxisProperties(t,["LSX","LSY","RSX","RSY"]),t}(),Primrose.Input.Gamepad.XBOX_BUTTONS={A:1,B:2,X:3,Y:4,leftBumper:5,rightBumper:6,leftTrigger:7,rightTrigger:8,back:9,start:10,leftStick:11,rightStick:12,up:13,down:14,left:15,right:16},Primrose.Input.Keyboard=function(){var t=function(t){function e(t,n,r){function i(t,e){this.setButton(e.keyCode,t),this.update()}_classCallCheck(this,e);var o=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,"Keyboard",n,r));return t=t||window,t.addEventListener("keydown",i.bind(o,!0),!1),t.addEventListener("keyup",i.bind(o,!1),!1),o}return _inherits(e,t),e}(Primrose.InputProcessor);return t}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.Input.LeapMotion=function(){var t=function(t){function e(t,n){_classCallCheck(this,e);var r=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,"LeapMotion",t,n));return r.isStreaming=!1,r.controller=new Leap.Controller({enableGestures:!0}),r}return _inherits(e,t),_createClass(e,[{key:"E",value:function(t,e){e?this.controller.on(t,e):this.controller.on(t,console.log.bind(console,"Leap Motion Event: "+t))}},{key:"start",value:function(t){if(this.isEnabled()){var n=null,r=null;if(t){var i=function s(e){requestAnimationFrame(s),t(e)};r=requestAnimationFrame.bind(window,i);var o=setTimeout(r,e.CONNECTION_TIMEOUT);n=function(){clearTimeout(o),this.isStreaming=!0}.bind(this),this.E("deviceStreaming",n),this.E("streamingStarted",n),this.E("streamingStopped",r)}this.E("connect"),this.E("deviceStopped"),this.E("disconnect"),this.E("frame",this.setState.bind(this,t)),this.controller.connect()}}},{key:"setState",value:function(t,n){var r,i,o=this.controller.history.get(1);if(!o||n.hands.length!==o.hands.length)for(r=0;r<this.commands.length;++r)this.enable(this.commands[r].name,n.hands.length>0);for(r=0;r<n.hands.length;++r){var s=n.hands[r].palmPosition,a="HAND"+r;for(i=0;i<e.COMPONENTS.length;++i)this.setAxis(a+e.COMPONENTS[i],s[i])}for(r=0;r<n.fingers.length;++r){var u=n.fingers[r],c="FINGER"+r;for(i=0;i<e.FINGER_PARTS.length;++i)for(var l=u[e.FINGER_PARTS[i]+"Position"],h=c+e.FINGER_PARTS[i].toUpperCase(),d=0;d<e.COMPONENTS.length;++d)this.setAxis(h+e.COMPONENTS[d],l[d])}t&&t(.001*n.timestamp),this.update()}}]),e}(Primrose.InputProcessor);return t.COMPONENTS=["X","Y","Z"],t.NUM_HANDS=2,t.NUM_FINGERS=10,t.FINGER_PARTS=["tip","dip","pip","mcp","carp"],Primrose.InputProcessor.defineAxisProperties(t,["X0","Y0","Z0","X1","Y1","Z1","FINGER0TIPX","FINGER0TIPY","FINGER0DIPX","FINGER0DIPY","FINGER0PIPX","FINGER0PIPY","FINGER0MCPX","FINGER0MCPY","FINGER0CARPX","FINGER0CARPY","FINGER1TIPX","FINGER1TIPY","FINGER1DIPX","FINGER1DIPY","FINGER1PIPX","FINGER1PIPY","FINGER1MCPX","FINGER1MCPY","FINGER1CARPX","FINGER1CARPY","FINGER2TIPX","FINGER2TIPY","FINGER2DIPX","FINGER2DIPY","FINGER2PIPX","FINGER2PIPY","FINGER2MCPX","FINGER2MCPY","FINGER2CARPX","FINGER2CARPY","FINGER3TIPX","FINGER3TIPY","FINGER3DIPX","FINGER3DIPY","FINGER3PIPX","FINGER3PIPY","FINGER3MCPX","FINGER3MCPY","FINGER3CARPX","FINGER3CARPY","FINGER4TIPX","FINGER4TIPY","FINGER4DIPX","FINGER4DIPY","FINGER4PIPX","FINGER4PIPY","FINGER4MCPX","FINGER4MCPY","FINGER4CARPX","FINGER4CARPY","FINGER5TIPX","FINGER5TIPY","FINGER5DIPX","FINGER5DIPY","FINGER5PIPX","FINGER5PIPY","FINGER5MCPX","FINGER5MCPY","FINGER5CARPX","FINGER5CARPY","FINGER6TIPX","FINGER6TIPY","FINGER6DIPX","FINGER6DIPY","FINGER6PIPX","FINGER6PIPY","FINGER6MCPX","FINGER6MCPY","FINGER6CARPX","FINGER6CARPY","FINGER7TIPX","FINGER7TIPY","FINGER7DIPX","FINGER7DIPY","FINGER7PIPX","FINGER7PIPY","FINGER7MCPX","FINGER7MCPY","FINGER7CARPX","FINGER7CARPY","FINGER8TIPX","FINGER8TIPY","FINGER8DIPX","FINGER8DIPY","FINGER8PIPX","FINGER8PIPY","FINGER8MCPX","FINGER8MCPY","FINGER8CARPX","FINGER8CARPY","FINGER9TIPX","FINGER9TIPY","FINGER9DIPX","FINGER9DIPY","FINGER9PIPX","FINGER9PIPY","FINGER9MCPX","FINGER9MCPY","FINGER9CARPX","FINGER9CARPY"]),t.CONNECTION_TIMEOUT=5e3,t}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.Input.Location=function(){var t=function(t){function e(t,n,r){_classCallCheck(this,e);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,"Location",t,n));return i.options=patch(r,e.DEFAULTS),i.available=!!navigator.geolocation,i.available&&navigator.geolocation.watchPosition(i.setState.bind(i),function(){this.available=!1}.bind(i),i.options),i}return _inherits(e,t),_createClass(e,[{key:"setState",value:function(t){for(var n in t.coords){var r=n.toUpperCase();e.AXES.indexOf(r)>-1&&this.setAxis(r,t.coords[n])}this.update()}}]),e}(Primrose.InputProcessor);return Primrose.InputProcessor.defineAxisProperties(t,["LONGITUDE","LATITUDE","ALTITUDE","HEADING","SPEED"]),t.DEFAULTS={enableHighAccuracy:!0,maximumAge:3e4,timeout:25e3},t}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.Input.Motion=function(){function t(t,e){var n=Math.max(screen.width,screen.height),r=Math.min(screen.width,screen.height),i=Math.floor(n*devicePixelRatio/2),o=Math.floor(r*devicePixelRatio),s=(e+1)/2;window.THREE&&(t.transform=(new THREE.Matrix4).makeTranslation(.034*e,0,0)),t.viewport={x:s*i,y:0,width:i,height:o,top:0,right:(s+1)*i,bottom:o,left:s*i},t.fov=75}var e=function(t){function e(t,n){_classCallCheck(this,e);var r=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,"Motion",t,n)),i=new MotionCorrector,o=new THREE.Quaternion,s=new THREE.Quaternion,a=new THREE.Vector3(1,0,0),u=new THREE.Vector3(0,1,0),c=new THREE.Vector3(0,0,-1);return i.addEventListener("deviceorientation",function(t){for(var n=0;n<e.AXES.length;++n){var i=e.AXES[n];r.setAxis(i,t[i])}o.set(0,0,0,1).multiply(s.setFromAxisAngle(u,t.HEADING)).multiply(s.setFromAxisAngle(a,t.PITCH)).multiply(s.setFromAxisAngle(c,t.ROLL)),r.headRX=o.x,r.headRY=o.y,r.headRZ=o.z,r.headRW=o.w,r.update()}),r.zeroAxes=i.zeroAxes.bind(i),r}return _inherits(e,t),_createClass(e,[{key:"getOrientation",value:function(t){return t=t||new THREE.Quaternion,t.set(this.getValue("headRX"),this.getValue("headRY"),this.getValue("headRZ"),this.getValue("headRW")),t}}]),e}(Primrose.InputProcessor);return Primrose.InputProcessor.defineAxisProperties(e,["HEADING","PITCH","ROLL","D_HEADING","D_PITCH","D_ROLL","headAX","headAY","headAZ","headRX","headRY","headRZ","headRW"]),e.DEFAULT_TRANSFORMS=[{},{}],t(e.DEFAULT_TRANSFORMS[0],-1),t(e.DEFAULT_TRANSFORMS[1],1),e}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.Input.Mouse=function(){var t=function(t){function e(t,n,r){_classCallCheck(this,e);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,"Mouse",n,r));return t=t||window,t.addEventListener("mousedown",function(t){i.setButton(t.button,!0),i.BUTTONS=t.buttons<<10,i.update()},!1),t.addEventListener("mouseup",function(t){i.setButton(t.button,!1),i.BUTTONS=t.buttons<<10,i.update()},!1),t.addEventListener("mousemove",function(t){if(i.BUTTONS=t.buttons<<10,e.Lock.isActive){var n=t.movementX,r=t.movementY;void 0===n&&(n=t.webkitMovementX||t.mozMovementX||0,r=t.webkitMovementY||t.mozMovementY||0),i.setMovement(n,r)}else i.setLocation(t.layerX,t.layerY);i.update()},!1),t.addEventListener("wheel",function(t){isChrome?(i.W+=t.deltaX,i.Z+=t.deltaY):t.shiftKey?i.W+=t.deltaY:i.Z+=t.deltaY,t.preventDefault(),i.update()},!1),i}return _inherits(e,t),_createClass(e,[{key:"setLocation",value:function(t,e){this.X=t,this.Y=e}},{key:"setMovement",value:function(t,e){this.X+=t,this.Y+=e}}]),e}(Primrose.InputProcessor),e=findProperty(document,["pointerLockElement","mozPointerLockElement","webkitPointerLockElement"]),n=findProperty(document,["onpointerlockchange","onmozpointerlockchange","onwebkitpointerlockchange"]),r=findProperty(document,["onpointerlockerror","onmozpointerlockerror","onwebkitpointerlockerror"]),i=findProperty(document.documentElement,["requestPointerLock","mozRequestPointerLock","webkitRequestPointerLock","webkitRequestPointerLock"]),o=findProperty(document,["exitPointerLock","mozExitPointerLock","webkitExitPointerLock","webkitExitPointerLock"]);return n=n&&n.substring(2),r=r&&r.substring(2),t.Lock={addChangeListener:function(t,e){return document.addEventListener(n,t,e)},removeChangeListener:function(t){return document.removeEventListener(n,t)},addErrorListener:function(t,e){return document.addEventListener(r,t,e)},removeErrorListener:function(t){return document.removeEventListener(r,t)},withChange:function(e){return new Promise(function(n,r){var i,o,s,a=function(){s&&clearTimeout(s),t.Lock.removeChangeListener(i),t.Lock.removeErrorListener(o)};i=function(){setTimeout(a),n(t.Lock.element)},o=function(t){setTimeout(a),r(t)},t.Lock.addChangeListener(i,!1),t.Lock.addErrorListener(o,!1),e()?(a(),n()):s=setTimeout(function(){a(),r("Pointer Lock state did not change in allotted time")},1e3)})},request:function(e){return t.Lock.withChange(function(){if(!i)throw console.error("No Pointer Lock API support."),new Error("No Pointer Lock API support.");return t.Lock.isActive?!0:void e[i]()})},exit:function(){return t.Lock.withChange(function(){if(!o)throw console.error("No Pointer Lock API support."),new Error("No Pointer Lock API support.");return t.Lock.isActive?void document[o]():!0})}},Object.defineProperties(t.Lock,{element:{get:function(){return document[e]}},isActive:{get:function(){return!!t.Lock.element}}}),Primrose.InputProcessor.defineAxisProperties(t,["X","Y","Z","W","BUTTONS"]),t}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),_get=function n(t,e,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:n(o,e,r)}if("value"in i)return i.value;var s=i.get;if(void 0!==s)return s.call(r)};Primrose.Input.Speech=function(){var t=function(t){function e(t,n){function r(){var t=fmt("Failed to initialize speech engine. Reason: $1",c.message);return console.error(t),!1}function i(){return available?a?!1:(a=!0,u.start(),!0):r()}function o(){return available?a?(u.stop(),!0):!1:r()}_classCallCheck(this,e);var s=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,"Speech",t,n)),a=!1,u=null,c=null;s.check=function(){this.enabled&&!a?i():!this.enabled&&a&&o()},s.getErrorMessage=function(){return c};try{u=window.SpeechRecognition?new SpeechRecognition:new webkitSpeechRecognition,u.continuous=!0,u.interimResults=!0,u.lang="en-US";var l=!1;u.addEventListener("start",function(){console.log("speech started"),command=""}.bind(s),!0),u.addEventListener("error",function(t){l=!0,console.log("speech error",t),a=!1,command="speech error"}.bind(s),!0),u.addEventListener("end",function(){console.log("speech ended",arguments),a=!1,command="speech ended",l&&(l=!1,this.enable(!0))}.bind(s),!0),u.addEventListener("result",function(t){var e=[],n=t.results[t.resultIndex],r=0,i=-1;if(n&&n.isFinal)for(var o=0;o<n.length;++o){var s=n[o];s.confidence>r&&(r=s.confidence,i=o)}r>.85&&e.push(n[i].transcript.trim()),e=e.join(" "),e!==this.inputState&&(this.inputState.text=e),this.update()}.bind(s),!0),available=!0}catch(h){console.error(h),c=h,available=!1}return s}return _inherits(e,t),_createClass(e,[{key:"cloneCommand",value:function(t){return{name:t.name,preamble:t.preamble,keywords:e.maybeClone(t.keywords),commandUp:t.commandUp,disabled:t.disabled}}},{key:"evalCommand",value:function(t,e,n,r){if(n&&this.inputState.text)for(var i=0;i<t.keywords.length;++i)0!==this.inputState.text.indexOf(t.keywords[i])||!t.preamble&&t.keywords[i].length!==this.inputState.text.length||(e.pressed=!0,e.value=this.inputState.text.substring(t.keywords[i].length).trim(),this.inputState.text=null)}},{key:"enable",value:function(t,n){_get(Object.getPrototypeOf(e.prototype),"enable",this).call(this,t,n),this.check()}},{key:"transmit",value:function(t){_get(Object.getPrototypeOf(e.prototype),"transmit",this).call(this,t),this.check()}}],[{key:"maybeClone",value:function(t){return t&&t.slice()||[]}}]),e}(Primrose.InputProcessor);return t}(),Primrose.Input.Touch=function(){var t=function(t){function e(t,n,r){function i(t,e,n){for(var r=n.changedTouches,i=0;i<r.length;++i){var o=r[i];e?(this.setAxis("X"+o.identifier,o.pageX),this.setAxis("Y"+o.identifier,o.pageY)):(this.setAxis("LX"+o.identifier,o.pageX),this.setAxis("LY"+o.identifier,o.pageY)),this.setButton("FINGER"+o.identifier,t);var s=1<<o.identifier;t?this.FINGERS|=s:(s=~s,this.FINGERS&=s)}n.preventDefault(),this.update()}_classCallCheck(this,e);var o=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,"Touch",n,r));return t=t||window,t.addEventListener("touchstart",i.bind(o,!0,!1),!1),t.addEventListener("touchend",i.bind(o,!1,!0),!1),t.addEventListener("touchmove",i.bind(o,!0,!0),!1),o}return _inherits(e,t),e}(Primrose.InputProcessor);t.NUM_FINGERS=10;for(var e=["FINGERS"],n=0;n<t.NUM_FINGERS;++n)e.push("X"+n),e.push("Y"+n);return Primrose.InputProcessor.defineAxisProperties(t,e),t}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.Input.VR=function(){var t=function(t){function e(t,n,r,i){function o(t){for(var e=0;e<u.vrdeviceconnected.length;++e)u.vrdeviceconnected[e](t)}function s(t){return console.log("Displays found:",t.length),this.displays=t,this.displays.forEach(o),"number"==typeof i&&i>=0&&i<this.displays.length?(this.connect(i),this.currentDisplay):void 0}_classCallCheck(this,e);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,"VR",t,n));void 0!==t&&null!==t||(t=e.AXES.map(function(t){return{name:t,axes:[Primrose.Input.VR[t]]}}));var u={vrdeviceconnected:[],vrdevicelost:[]};return a.addEventListener=function(t,e,n){u[t]&&u[t].push(e),"vrdeviceconnected"===t&&Object.keys(this.displays).forEach(e)},a.displays=[],a._transforms=[],a.transforms=null,a.currentDisplayIndex=-1,a.currentPose=null,a.init=function(){return console.info("Checking for displays..."),navigator.getVRDisplays().then(s.bind(this))},a}return _inherits(e,t),_createClass(e,[{key:"requestPresent",value:function(t){return this.currentDisplay?this.currentDisplay.requestPresent(t).then(function(e){return e||t[0].source}):Promise.reject("No display")}},{key:"poll",value:function(){if(this.currentDisplay){var t=this.currentDisplay.getPose();t&&(this.currentPose=t,t.position&&(this.headX=t.position[0],this.headY=t.position[1],this.headZ=t.position[2]),t.linearVelocity&&(this.headVX=t.linearVelocity[0],this.headVY=t.linearVelocity[1],this.headVZ=t.linearVelocity[2]),t.linearAcceleration&&(this.headAX=t.linearAcceleration[0],this.headAY=t.linearAcceleration[1],this.headAZ=t.linearAcceleration[2]),t.orientation&&(this.headRX=t.orientation[0],this.headRY=t.orientation[1],this.headRZ=t.orientation[2],this.headRW=t.orientation[3]),t.angularVelocity&&(this.headRVX=t.angularVelocity[0],this.headRVY=t.angularVelocity[1],this.headRVZ=t.angularVelocity[2]),t.angularAcceleration&&(this.headRAX=t.angularAcceleration[0],this.headRAY=t.angularAcceleration[1],this.headRAZ=t.angularAcceleration[2]))}}},{key:"getOrientation",value:function(t){return t=t||new THREE.Quaternion,t.set(this.getValue("headRX"),this.getValue("headRY"),this.getValue("headRZ"),this.getValue("headRW")),t}},{key:"resetTransforms",value:function(t,e){this.currentDisplay&&(this._transforms[this.currentDisplayIndex]||(this._transforms[this.currentDisplayIndex]=new ViewCameraTransform(this.currentDisplay)),this.transforms=this._transforms[this.currentDisplayIndex].getTransforms(t,e))}},{key:"connect",value:function(t){this.currentPose=null,this.currentDisplayIndex=t}},{key:"currentDisplay",get:function(){return this.displays[this.currentDisplayIndex]}}],[{key:"Version",get:function(){return navigator.getVRDisplays?1:navigator.getVRDevices?.5:navigator.mozGetVRDevices?.4:isMobile?.1:0}}]),e}(Primrose.InputProcessor);return Primrose.InputProcessor.defineAxisProperties(t,["headX","headY","headZ","headVX","headVY","headVZ","headAX","headAY","headAZ","headRX","headRY","headRZ","headRW","headRVX","headRVY","headRVZ","headRAX","headRAY","headRAZ"]),t}(),Primrose.Output.Audio3D=function(){function t(){var t=this;try{this.context=new AudioContext,this.sampleRate=this.context.sampleRate,this.mainVolume=this.context.createGain();var e=new THREE.Vector3,n=new THREE.Vector3,r=(new THREE.Matrix4).identity(),i=(new THREE.Matrix4).identity(),o=null;this.setVelocity=this.context.listener.setVelocity.bind(this.context.listener),this.setPlayer=function(s){var a=s;for(r.identity(),i.identity();null!==a;)r.fromArray(a.matrix.elements),r.multiply(i),o=r,r=i,i=o,a=a.parent;o=r;var u=o.elements[12],c=o.elements[13],l=o.elements[14];o.elements[12]=o.elements[13]=o.elements[14]=0,t.context.listener.setPosition(u,c,l),e.set(0,0,1),e.applyProjection(i),e.normalize(),n.set(0,-1,0),n.applyProjection(i),n.normalize(),t.context.listener.setOrientation(e.x,e.y,e.z,n.x,n.y,n.z),i.elements[12]=u,i.elements[13]=c,i.elements[14]=l},this.isAvailable=!0}catch(s){console.error(s),console.error("AudioContext not available."),this.isAvailable=!1,this.setPlayer=function(){},this.setVelocity=function(){},this.start=function(){},this.stop=function(){},this.error=s}}return Window.prototype.AudioContext=Window.prototype.AudioContext||Window.prototype.webkitAudioContext||function(){},t.prototype.start=function(){this.mainVolume.connect(this.context.destination)},t.prototype.stop=function(){this.mainVolume.disconnect()},t.prototype.loadURL=function(t){var e=this;return Primrose.HTTP.getBuffer(t).then(function(t){return new Promise(function(n,r){return e.context.decodeAudioData(t,n,r)})})},t.prototype.loadURLCascadeSrcList=function(t,e){var n=this;return e=e||0,e>=t.length?Promise.reject("Failed to load a file from "+t.length+" files."):this.loadURL(t[e])["catch"](function(r){return console.error(r),n.loadURLCascadeSrcList(t,e+1)})},t.prototype.createRawSound=function(t){if(1!==t.length&&2!==t.length)throw new Error("Incorrect number of channels. Expected 1 or 2, got "+t.length);var e=t[0].length;if(t.length>1&&t[1].length!==e)throw new Error("Second channel is not the same length as the first channel. Expected "+e+", but was "+t[1].length);for(var n=this.context.createBuffer(t.length,e,this.sampleRate),r=0;r<t.length;++r)for(var i=n.getChannelData(r),o=0;e>o;++o)i[o]=t[r][o];return n},t.prototype.createSound=function(t,e){var n={volume:this.context.createGain(),source:this.context.createBufferSource()};return n.source.buffer=e,n.source.loop=t,n.source.connect(n.volume),n},t.prototype.create3DSound=function(t,e,n,r){return r.panner=this.context.createPanner(),r.panner.setPosition(t,e,n),r.panner.connect(this.mainVolume),r.volume.connect(r.panner),r},t.prototype.createFixedSound=function(t){return t.volume.connect(this.mainVolume),t},t.prototype.loadSource=function(t,e){var n=this;return new Promise(function(r,i){t instanceof Array||(t=[t]);var o=document.createElement("audio");o.autoplay=!0,o.loop=e,t.map(function(t){var e=document.createElement("source");return e.src=t,e}).forEach(o.appendChild.bind(o)),o.oncanplay=function(){if(n.context){o.oncanplay=null;var t={volume:n.context.createGain(),source:n.context.createMediaElementSource(o)};t.source.connect(t.volume)}r(t)},o.onerror=i,document.body.appendChild(o)})},t.prototype.load3DSound=function(t,e,n,r,i){return this.loadSource(t,e).then(this.create3DSound.bind(this,n,r,i))},t.prototype.loadFixedSound=function(t,e){return this.loadSource(t,e).then(this.createFixedSound.bind(this))},t.prototype.playBufferImmediate=function(t,e){var n=this,r=this.createSound(!1,t);return r=this.createFixedSound(r),r.volume.gain.value=e,r.source.addEventListener("ended",function(t){r.volume.disconnect(n.mainVolume)}),r.source.start(0),r},t}(),Primrose.Output.HapticGlove=function(){function t(e){function n(t){if(t.valid){r=t.hands.length>0;for(var n=0;n<e.hands&&n<t.hands.length;++n)for(var i=t.hands[n],o=0;o<e.fingers;++o)for(var a=i.fingers[o],u=0;u<e.joints;++u){var c=n*e.fingers*e.joints+o*e.joints+u;if(c<this.tips.length){var l=a[s[u]],h=this.tips[c];h.position.set(l[0],l[1],l[2])}}}}e.port=e.port||t.DEFAULT_PORT,e.addr=e.addr||t.DEFAULT_HOST,this.tips=[],this.numJoints=e.hands*e.fingers*e.joints;var r=!1,i=!1;Leap.loop(),this.setEnvironment=function(t){e.world=t.world,e.scene=t.scene,e.camera=t.camera,Leap.loopController.on("frame",n.bind(this))};var o,s=["tipPosition","dipPosition","pipPosition","mcpPosition","carpPosition"],a=0;80!==e.port&&(e.addr+=":"+e.port),o=io.connect(e.addr,{reconnect:!0,"reconnection delay":1e3,"max reconnection attempts":5}),o.on("connect",function(){i=!0,console.log("Connected!")}),o.on("disconnect",function(){i=!1,console.log("Disconnected!")}),this.readContacts=function(t){for(var n=0,i=0;r&&2>n&&i<t.length;++i)for(var o=t[i],s=0;s<e.hands&&2>n;++s)for(var a=0;a<e.fingers;++a){var u=this.tips[a],c=!1;o.bi===u&&o.bj.graphics&&o.bj.graphics.isSolid&&(this.setFingerState(a,!0),c=!0,++n),c||this.setFingerState(a,!1)}},this.setFingerState=function(t,e){var n=1<<t;e?a|=n:a=a&~n&31,i&&o.emit("data",a)}}return t.DEFAULT_PORT=8383,t.DEFAULT_HOST=document.location.hostname,t}(),Primrose.Output.Music=function(){function t(t){return 440*Math.pow(n,t-49)}function e(t,e,n){if(this.audio=t||new AudioContext,this.audio&&this.audio.createGain){void 0===n&&(n=r),void 0===e&&(e="sawtooth"),this.available=!0,this.mainVolume=this.audio.createGain(),this.mainVolume.connect(this.audio.destination),this.numNotes=n,this.oscillators=[];for(var i=0;i<this.numNotes;++i){var o=this.audio.createOscillator(),s=this.audio.createGain();o.type=e,o.frequency.value=0,o.connect(s),o.start(),s.connect(this.mainVolume),this.oscillators.push({osc:o,gn:s,timeout:null})}}else this.available=!1}Window.prototype.AudioContext=Window.prototype.AudioContext||Window.prototype.webkitAudioContext||function(){};var n=Math.pow(2,1/12),r=(navigator.maxTouchPoints||10)+1;return e.prototype.noteOn=function(e,n,r){if(this.available){void 0===r&&(r=0);var i=this.oscillators[r%this.numNotes],o=t(parseFloat(n)+1);return i.gn.gain.value=e,i.osc.frequency.setValueAtTime(o,0),i}},e.prototype.noteOff=function(t){if(this.available){void 0===t&&(t=0);var e=this.oscillators[t%this.numNotes];e.osc.frequency.setValueAtTime(0,0)}},e.prototype.play=function(t,e,n,r){if(this.available){"number"!=typeof r&&(r=0);var i=this.noteOn(e,t,r);i.timeout&&(clearTimeout(i.timeout),i.timeout=null),i.timeout=setTimeout(function(t,e){this.noteOff(t),e.timeout=null}.bind(this,r,i),1e3*n)}},e}(),Primrose.Output.Speech=function(){function t(t,e,n,r){return void 0===t[e]?t[e]=n+(r-n)*Math.random():t[e]=Math.min(r,Math.max(n,t[e])),t[e]}try{return function(e){e=e||{};var n=speechSynthesis.getVoices().filter(function(t){return t["default"]||t.localService}.bind(this)),r=n[Math.floor(t(e,"voice",0,n.length))];this.speak=function(n,i){var o=new SpeechSynthesisUtterance;o.voice=r,o.volume=t(e,"volume",1,1),o.rate=t(e,"rate",.1,5),o.pitch=t(e,"pitch",0,2),o.text=n,o.onend=i,speechSynthesis.speak(o)}}}catch(e){return console.error(e),function(){this.speak=function(){}}}}(),Primrose.Random["int"]=function(t,e,n){n=n||1,void 0===e&&(e=t,t=0);var r=e-t,i=Math.pow(Math.random(),n);return Math.floor(t+i*r)},Primrose.Random.item=function(t){return t[Primrose.Random["int"](t.length)]},Primrose.Random.number=function(t,e){return Math.random()*(e-t)+t},Primrose.Random.steps=function(t,e,n){return t+Primrose.Random["int"](0,(1+e-t)/n)*n};var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};Primrose.Text.CodePage=function(){function t(t,e,n){function r(t,e,n){e.selectedText=t}this.name=t,this.language=e;var i={NORMAL:{65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z"},SHIFT:{65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z"}};copyObject(i,n);for(var o,s,a,u=0;9>=u;++u)s=Primrose.Keys["NUMPAD"+u],i.NORMAL[s]=u.toString();i.NORMAL[Primrose.Keys.MULTIPLY]="*",i.NORMAL[Primrose.Keys.ADD]="+",i.NORMAL[Primrose.Keys.SUBTRACT]="-",i.NORMAL[Primrose.Keys.DECIMALPOINT]=".",i.NORMAL[Primrose.Keys.DIVIDE]="/",this.keyNames={},this.commandNames=[];for(o in Primrose.Keys)s=Primrose.Keys[o],isNaN(s)||(this.keyNames[s]=o);for(var c in i){var l=i[c];if("object"===("undefined"==typeof l?"undefined":_typeof(l)))for(s in l){if(s.indexOf("_")>-1){var h=s.split(" "),d=h[0];s=h[1],o=i.NORMAL[s],a=d+"_"+c+" "+o}else o=i.NORMAL[s],a=c+"_"+o;this.commandNames.push(a),this.keyNames[s]=o;var f=l[s];"function"!=typeof f&&(f=r.bind(null,f)),this[a]=f}}}return t.DEAD=function(t){return function(e){e.setDeadKeyState("DEAD"+t)}},t}(),Primrose.Text.CommandPack=function(){function t(t,e){this.name=t,copyObject(this,e)}return t}(),Primrose.Text.Cursor=function(){function t(t,e,n){this.i=t||0,this.x=e||0,this.y=n||0,this.moved=!0}var e=function(){function t(r){r=r.replace(e,function(e,n,r){return t(r)+n}).replace(n,"$2$1");for(var i="",o=r.length-1;o>=0;--o)i+=r[o];return i}var e=/(<%= allExceptCombiningMarks %>)(<%= combiningMarks %>+)/g,n=/(<%= highSurrogates %>)(<%= lowSurrogates %>)/g;return t}();return t.min=function(t,e){return t.i<=e.i?t:e},t.max=function(t,e){return t.i>e.i?t:e},t.prototype.clone=function(){return new t(this.i,this.x,this.y)},t.prototype.toString=function(){return"[i:"+this.i+" x:"+this.x+" y:"+this.y+"]"},t.prototype.copy=function(t){this.i=t.i,this.x=t.x,this.y=t.y,this.moved=!1},t.prototype.fullhome=function(){this.i=0,this.x=0,this.y=0,this.moved=!0},t.prototype.fullend=function(t){this.i=0;for(var e=0,n=0;n<t.length;++n){var r=t[n];e=r.length,this.i+=e}this.y=t.length-1,this.x=e,this.moved=!0},t.prototype.skipleft=function(t){if(0===this.x)this.left(t);else{var n=this.x-1,r=t[this.y],i=e(r.substring(0,n)),o=i.match(/(\s|\W)+/),s=o?o.index+o[0].length+1:i.length;this.i-=s,this.x-=s}this.moved=!0},t.prototype.left=function(t){if(this.i>0){if(--this.i,--this.x,this.x<0){--this.y;var e=t[this.y];this.x=e.length}this.reverseFromNewline(t)&&++this.i}this.moved=!0},t.prototype.skipright=function(t){var e=t[this.y];if(this.x===e.length||"\n"===e[this.x])this.right(t);else{var n=this.x+1;e=e.substring(n);var r=e.match(/(\s|\W)+/),i=r?r.index+r[0].length+1:e.length-this.x;this.i+=i,this.x+=i,this.reverseFromNewline(t)}this.moved=!0},t.prototype.fixCursor=function(t){this.x=this.i,this.y=0;for(var e=0,n=t[this.y];this.x>n.length;){if(this.x-=n.length,e+=n.length,
this.y>=t.length-1){this.i=e,this.x=n.length,this.moved=!0;break}++this.y,n=t[this.y]}return this.moved},t.prototype.right=function(t){this.advanceN(t,1)},t.prototype.advanceN=function(t,e){var n=t[this.y];(this.y<t.length-1||this.x<n.length)&&(this.i+=e,this.fixCursor(t),n=t[this.y],this.x>0&&"\n"===n[this.x-1]&&(++this.y,this.x=0)),this.moved=!0},t.prototype.home=function(){this.i-=this.x,this.x=0,this.moved=!0},t.prototype.end=function(t){var e=t[this.y],n=e.length-this.x;this.i+=n,this.x+=n,this.reverseFromNewline(t),this.moved=!0},t.prototype.up=function(t){if(this.y>0){--this.y;var e=t[this.y],n=Math.min(0,e.length-this.x);this.x+=n,this.i-=e.length-n,this.reverseFromNewline(t)}this.moved=!0},t.prototype.down=function(t){if(this.y<t.length-1){++this.y;var e=t[this.y],n=t[this.y-1],r=Math.min(0,e.length-this.x);this.x+=r,this.i+=n.length+r,this.reverseFromNewline(t)}this.moved=!0},t.prototype.incY=function(t,e){this.y=Math.max(0,Math.min(e.length-1,this.y+t));var n=e[this.y];this.x=Math.max(0,Math.min(n.length,this.x)),this.i=this.x;for(var r=0;r<this.y;++r)this.i+=e[r].length;this.reverseFromNewline(e),this.moved=!0},t.prototype.setXY=function(t,e,n){this.y=Math.max(0,Math.min(n.length-1,e));var r=n[this.y];this.x=Math.max(0,Math.min(r.length,t)),this.i=this.x;for(var i=0;i<this.y;++i)this.i+=n[i].length;this.reverseFromNewline(n),this.moved=!0},t.prototype.setI=function(t,e){this.i=t,this.fixCursor(e),this.moved=!0},t.prototype.reverseFromNewline=function(t){var e=t[this.y];return this.x>0&&"\n"===e[this.x-1]?(--this.x,--this.i,!0):!1},t}(),Primrose.Text.Grammar=function(){function t(e,n){function r(t){var e,n,r=null,i=null,o=0;for(e=0;e<t.length;++e)n=t[e],n.line=o,"newlines"===n.type&&++o,i?("stringDelim"!==n.type||n.value!==i||0!==e&&"\\"===t[e-1].value[t[e-1].value.length-1]||(i=null),"newlines"!==n.type&&(n.type="strings")):r?(("startBlockComments"===r&&"endBlockComments"===n.type||"startLineComments"===r&&"newlines"===n.type)&&(r=null),"newlines"!==n.type&&(n.type="comments")):"stringDelim"===n.type?(i=n.value,n.type="strings"):"startBlockComments"!==n.type&&"startLineComments"!==n.type||(r=n.type,n.type="comments");for(e=t.length-1;e>0;--e){var s=t[e-1];n=t[e],s.type===n.type&&"newlines"!==s.type&&(s.value+=n.value,t.splice(e,1))}}this.name=e,this.grammar=n.map(function(t){return new Primrose.Text.Rule(t[0],t[1])}),t.prototype.toHTML=function(t){for(var e=this.tokenize(t),n=document.createElement("div"),r=0;r<e.length;++r){var i=e[r];if("newlines"===i.type)n.appendChild(document.createElement("br"));else{var o=Primrose.Text.Themes.Default[i.type]||{},s=document.createElement("span");s.style.fontWeight=o.fontWeight||Primrose.Text.Themes.Default.regular.fontWeight,s.style.fontStyle=o.fontStyle||Primrose.Text.Themes.Default.regular.fontStyle||"",s.style.color=o.foreColor||Primrose.Text.Themes.Default.regular.foreColor,s.style.backgroundColor=o.backColor||Primrose.Text.Themes.Default.regular.backColor,s.style.fontFamily=o.fontFamily||Primrose.Text.Themes.Default.fontFamily,s.appendChild(document.createTextNode(i.value)),n.appendChild(s)}}return n.innerHTML},this.tokenize=function(t){for(var e=[new Primrose.Text.Token(t,"regular",0)],n=0;n<this.grammar.length;++n)for(var i=this.grammar[n],o=0;o<e.length;++o)i.carveOutMatchedToken(e,o);return r(e),e}}return t}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.Text.OperatingSystem=function(){var t=function(){function t(e,n,r,i,o,s,a,u,c,l){_classCallCheck(this,t);var h=o;o=o.length>0?o:"NORMAL",this[n+"_a"]="SELECT_ALL",this[n+"_c"]="COPY",this[n+"_x"]="CUT",this[n+"_v"]="PASTE",this[i]="REDO",this[n+"_z"]="UNDO",this[n+"_DOWNARROW"]="WINDOW_SCROLL_DOWN",this[n+"_UPARROW"]="WINDOW_SCROLL_UP",this[r+"_LEFTARROW"]="NORMAL_SKIPLEFT",this[r+"SHIFT_LEFTARROW"]="SHIFT_SKIPLEFT",this[r+"_RIGHTARROW"]="NORMAL_SKIPRIGHT",this[r+"SHIFT_RIGHTARROW"]="SHIFT_SKIPRIGHT",this[o+"_HOME"]="NORMAL_HOME",this[h+"SHIFT_HOME"]="SHIFT_HOME",this[o+"_END"]="NORMAL_END",this[h+"SHIFT_END"]="SHIFT_END",this[u+"_HOME"]="CTRL_HOME",this[u+"SHIFT_HOME"]="CTRLSHIFT_HOME",this[u+"_END"]="CTRL_END",this[u+"SHIFT_END"]="CTRLSHIFT_END",this._deadKeyState=""}return _createClass(t,[{key:"makeCommandName",value:function(t,e){var n=t.keyCode;if(n!==Primrose.Keys.CTRL&&n!==Primrose.Keys.ALT&&n!==Primrose.Keys.META_L&&n!==Primrose.Keys.META_R&&n!==Primrose.Keys.SHIFT){var r=(this._deadKeyState,this._deadKeyState);return t.ctrlKey&&(r+="CTRL"),t.altKey&&(r+="ALT"),t.metaKey&&(r+="META"),t.shiftKey&&(r+="SHIFT"),r===this._deadKeyState&&(r+="NORMAL"),r+="_"+e.keyNames[n],this[r]||r}}}]),t}();return t}(),Primrose.Text.Point=function(){function t(t,e){this.set(t||0,e||0)}return t.prototype.set=function(t,e){this.x=t,this.y=e},t.prototype.copy=function(t){t&&(this.x=t.x,this.y=t.y)},t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.toString=function(){return"(x:"+this.x+", y:"+this.y+")"},t}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.Text.Rectangle=function(){var t=function(){function t(e,n,r,i){_classCallCheck(this,t),this.point=new Primrose.Text.Point(e,n),this.size=new Primrose.Text.Size(r,i)}return _createClass(t,[{key:"set",value:function(t,e,n,r){this.point.set(t,e),this.size.set(n,r)}},{key:"copy",value:function(t){t&&(this.point.copy(t.point),this.size.copy(t.size))}},{key:"clone",value:function(){return new t(this.point.x,this.point.y,this.size.width,this.size.height)}},{key:"toString",value:function(){return"["+this.point.toString()+" x "+this.size.toString()+"]"}},{key:"overlap",value:function(e){var n=Math.max(this.left,e.left),r=Math.max(this.top,e.top),i=Math.min(this.right,e.right),o=Math.min(this.bottom,e.bottom);return i>n&&o>r?new t(n,r,i-n,o-r):void 0}},{key:"x",get:function(){return this.point.x},set:function(t){this.point.x=t}},{key:"left",get:function(){return this.point.x},set:function(t){this.point.x=t}},{key:"width",get:function(){return this.size.width},set:function(t){this.size.width=t}},{key:"right",get:function(){return this.point.x+this.size.width},set:function(t){this.point.x=t-this.size.width}},{key:"y",get:function(){return this.point.y},set:function(t){this.point.y=t}},{key:"top",get:function(){return this.point.y},set:function(t){this.point.y=t}},{key:"height",get:function(){return this.size.height},set:function(t){this.size.height=t}},{key:"bottom",get:function(){return this.point.y+this.size.height},set:function(t){this.point.y=t-this.size.height}},{key:"area",get:function(){return this.width*this.height}}]),t}();return t}(),Primrose.Text.Rule=function(){function t(t,e){this.name=t,this.test=e}return t.prototype.carveOutMatchedToken=function(t,e){var n=t[e];if("regular"===n.type){var r=this.test.exec(n.value);if(r){var i=r[r.length-1],o=r.input.indexOf(i),s=o+i.length;if(0===o){if(n.type=this.name,s<n.value.length){var a=n.splitAt(s);a.type="regular",t.splice(e+1,0,a)}}else{var u=n.splitAt(o);if(i.length<u.value.length){var c=u.splitAt(i.length);t.splice(e+1,0,c)}u.type=this.name,t.splice(e+1,0,u)}}}},t}(),Primrose.Text.Size=function(){function t(t,e){this.set(t||0,e||0)}return t.prototype.set=function(t,e){this.width=t,this.height=e},t.prototype.copy=function(t){t&&(this.width=t.width,this.height=t.height)},t.prototype.clone=function(){return new t(this.width,this.height)},t.prototype.toString=function(){return"<w:"+this.width+", h:"+this.height+">"},t}(),Primrose.Text.Terminal=function(t,e){function n(t){t.selectionStart=t.selectionEnd=t.value.length,t.scrollIntoView(t.frontCursor)}function r(){y.running&&(o(),y.running=!1,p&&(t.tokenizer=l,t.value=c),n(t))}function i(){return e.selectionStart=e.selectionEnd=0,e.value="",!0}function o(){if(m.length>0){for(var t=m.split("\n"),e=0;d>e&&t.length>0;++e)f.push(t.shift());t.length>0&&f.push(" ----- more -----"),m=t.join("\n")}}function s(t){u=t,y.waitingForInput=!0,o()}function a(t){m+=t}e=e||t;var u=null,c=null,l=null,h=0,d=40,f=[],m="",p=t===e,y=this;this.running=!1,this.waitingForInput=!1,this.sendInput=function(t){if(m.length>0)o();else{e.keyDown(t);var n=e.value.substring(h);u(n.trim()),u=null,this.waitingForInput=!1}},this.execute=function(){if(d=10,l=t.tokenizer,l&&l.interpret){this.running=!0;var n,o=function(){y.running&&setTimeout(n,1)};c=t.value,n=l.interpret(c,s,a,a,o,i,this.loadFile.bind(this),r),e.tokenizer=Primrose.Text.Grammars.PlainText,i(),o()}},this.loadFile=function(e){return Primrose.HTTP.getText(e.toLowerCase()).then(function(e){return isOSX&&(e=e.replace("CTRL+SHIFT+SPACE","CMD+OPT+E")),t.value=c=e,e})},this.update=function(){f.length>0&&(e.value+=f.shift()+"\n",n(e),h=e.selectionStart)}},Primrose.Text.Token=function(){function t(t,e,n,r){this.value=t,this.type=e,this.index=n,this.line=r}return t.prototype.clone=function(){return new t(this.value,this.type,this.index,this.line)},t.prototype.splitAt=function(e){var n=this.value.substring(e);return this.value=this.value.substring(0,e),new t(n,this.type,this.index+e,this.line)},t.prototype.toString=function(){return"["+this.type+": "+this.value+"]"},t}(),Primrose.Text.CodePages.DE_QWERTZ=function(){var t=Primrose.Text.CodePage;return new t("Deutsch: QWERTZ","de",{deadKeys:[220,221,160,192],NORMAL:{32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",60:"<",63:"",160:t.DEAD(3),163:"#",171:"+",173:"-",186:"",187:"+",188:",",189:"-",190:".",191:"#",192:t.DEAD(4),219:"",220:t.DEAD(1),221:t.DEAD(2),222:"",226:"<"},DEAD1NORMAL:{65:"",69:"",73:"",79:"",85:"",190:"."},DEAD2NORMAL:{65:"",69:"",73:"",79:"",83:"s",85:"",89:""},SHIFT:{32:" ",48:"=",49:"!",50:'"',51:"",52:"$",53:"%",54:"&",55:"/",56:"(",57:")",60:">",63:"?",163:"'",171:"*",173:"_",186:"",187:"*",188:";",189:"_",190:":",191:"'",192:"",219:"?",222:"",226:">"},CTRLALT:{48:"}",50:"",51:"",55:"{",56:"[",57:"]",60:"|",63:"\\",69:"",77:"",81:"@",171:"~",187:"~",219:"\\",226:"|"},CTRLALTSHIFT:{63:"",219:""},DEAD3NORMAL:{65:"a",69:"e",73:"i",79:"o",85:"u",190:"."},DEAD4NORMAL:{65:"a",69:"e",73:"i",79:"o",83:"s",85:"u",89:"y"}})}(),Primrose.Text.CodePages.EN_UKX=function(){var t=Primrose.Text.CodePage;return new t("English: UK Extended","en-GB",{CTRLALT:{52:"",65:"",69:"",73:"",79:"",85:"",163:"\\",192:"",222:"\\",223:""},CTRLALTSHIFT:{65:"",69:"",73:"",79:"",85:"",222:"|"},NORMAL:{32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",163:"#",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"'",219:"[",220:"\\",221:"]",222:"#",223:"`"},SHIFT:{32:" ",48:")",49:"!",50:'"',51:"",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",163:"~",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"@",219:"{",220:"|",221:"}",222:"~",223:""}})}(),Primrose.Text.CodePages.EN_US=function(){var t=Primrose.Text.CodePage;return new t("English: USA","en-US",{NORMAL:{32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'"},SHIFT:{32:" ",48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",219:"{",220:"|",221:"}",222:'"'}})}(),Primrose.Text.CodePages.FR_AZERTY=function(){var t=Primrose.Text.CodePage;return new t("Franais: AZERTY","fr",{deadKeys:[221,50,55],NORMAL:{32:" ",48:"",49:"&",50:"",51:'"',52:"'",53:"(",54:"-",55:"",56:"_",57:"",186:"$",187:"=",188:",",190:";",191:":",192:"",219:")",220:"*",221:t.DEAD(1),222:"",223:"!",226:"<"},SHIFT:{32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",186:"",187:"+",188:"?",190:".",191:"/",192:"%",219:"",220:"",223:"",226:">"},CTRLALT:{48:"@",50:t.DEAD(2),51:"#",52:"{",53:"[",54:"|",55:t.DEAD(3),56:"\\",57:"^",69:"",186:"",187:"}",219:"]"},DEAD1NORMAL:{65:"",69:"",73:"",79:"",85:""},DEAD2NORMAL:{65:"",78:"",79:""},DEAD3NORMAL:{48:"",50:"",55:"",65:"",69:"",73:"",79:"",85:""}})}(),Primrose.Text.CommandPacks.BasicTextInput=function(){var t=function(t){function e(t,n){_classCallCheck(this,e);var r={NORMAL_LEFTARROW:function(t,e){t.cursorLeft(e,t.frontCursor)},NORMAL_SKIPLEFT:function(t,e){t.cursorSkipLeft(e,t.frontCursor)},NORMAL_RIGHTARROW:function(t,e){t.cursorRight(e,t.frontCursor)},NORMAL_SKIPRIGHT:function(t,e){t.cursorSkipRight(e,t.frontCursor)},NORMAL_HOME:function(t,e){t.cursorHome(e,t.frontCursor)},NORMAL_END:function(t,e){t.cursorEnd(e,t.frontCursor)},NORMAL_BACKSPACE:function(t,e){t.frontCursor.i===t.backCursor.i&&t.frontCursor.left(e),t.selectedText="",t.scrollIntoView(t.frontCursor)},NORMAL_ENTER:function(t,e,n){emit.call(t,"change",{target:t})},NORMAL_DELETE:function(t,e){t.frontCursor.i===t.backCursor.i&&t.backCursor.right(e),t.selectedText="",t.scrollIntoView(t.frontCursor)},NORMAL_TAB:function(t,e){t.selectedText=t.tabString},SHIFT_LEFTARROW:function(t,e){t.cursorLeft(e,t.backCursor)},SHIFT_SKIPLEFT:function(t,e){t.cursorSkipLeft(e,t.backCursor)},SHIFT_RIGHTARROW:function(t,e){t.cursorRight(e,t.backCursor)},SHIFT_SKIPRIGHT:function(t,e){t.cursorSkipRight(e,t.backCursor)},SHIFT_HOME:function(t,e){t.cursorHome(e,t.backCursor)},SHIFT_END:function(t,e){t.cursorEnd(e,t.backCursor)},SHIFT_DELETE:function(t,e){t.frontCursor.i===t.backCursor.i&&(t.frontCursor.home(e),t.backCursor.end(e)),t.selectedText="",t.scrollIntoView(t.frontCursor)},CTRL_HOME:function(t,e){t.cursorFullHome(e,t.frontCursor)},CTRL_END:function(t,e){t.cursorFullEnd(e,t.frontCursor)},CTRLSHIFT_HOME:function(t,e){t.cursorFullHome(e,t.backCursor)},CTRLSHIFT_END:function(t,e){t.cursorFullEnd(e,t.backCursor)},SELECT_ALL:function(t,e){t.frontCursor.fullhome(e),t.backCursor.fullend(e)},REDO:function(t,e){t.redo(),t.scrollIntoView(t.frontCursor)},UNDO:function(t,e){t.undo(),t.scrollIntoView(t.frontCursor)}};if(n)for(var i in n)r[i]=n[i];return _possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t||"Text editor commands",r))}return _inherits(e,t),e}(Primrose.Text.CommandPack);return t}(),Primrose.Text.CommandPacks.TextEditor=function(){return new Primrose.Text.CommandPacks.BasicTextInput("Text Area input commands",{NORMAL_UPARROW:function(t,e){t.cursorUp(e,t.frontCursor)},NORMAL_DOWNARROW:function(t,e){t.cursorDown(e,t.frontCursor)},NORMAL_PAGEUP:function(t,e){t.cursorPageUp(e,t.frontCursor)},NORMAL_PAGEDOWN:function(t,e){t.cursorPageDown(e,t.frontCursor)},NORMAL_ENTER:function(t,e,n){var r="",i=e[t.frontCursor.y];i.length>0&&"whitespace"===i[0].type&&(r=i[0].value),t.selectedText="\n"+r,t.scrollIntoView(t.frontCursor)},SHIFT_UPARROW:function(t,e){t.cursorUp(e,t.backCursor)},SHIFT_DOWNARROW:function(t,e){t.cursorDown(e,t.backCursor)},SHIFT_PAGEUP:function(t,e){t.cursorPageUp(e,t.backCursor)},SHIFT_PAGEDOWN:function(t,e){t.cursorPageDown(e,t.backCursor)},WINDOW_SCROLL_DOWN:function(t,e){t.scroll.y<e.length&&++t.scroll.y},WINDOW_SCROLL_UP:function(t,e){t.scroll.y>0&&--t.scroll.y}})}(),Primrose.Text.CommandPacks.TextInput=function(){return new Primrose.Text.CommandPacks.BasicTextInput("Text Line input commands")}(),Primrose.Text.Controls.PlainText=function(){function t(t,e,n,r,i,o,s,a){t=t.replace(/\r\n/g,"\n");var u=t.split("\n");a=a||"center";var c=1e3*e,l=c*u.length,h=document.createElement("canvas"),d=h.getContext("2d");d.font=c+"px Arial";var f=d.measureText(t).width;h.width=f,h.height=l,d.font=.8*c+"px Arial","transparent"!==r&&(d.fillStyle=r,d.fillRect(0,0,h.width,h.height)),d.fillStyle=n;for(var m=0;m<u.length;++m)d.fillText(u[m],0,m*c);var p=new THREE.Texture(h);p.needsUpdate=!0;var y=new THREE.MeshBasicMaterial({map:p,transparent:"transparent"===r,useScreenCoordinates:!1,color:16777215,shading:THREE.FlatShading}),g=new THREE.PlaneGeometry(e*f/c,e*u.length);g.computeBoundingBox(),g.computeVertexNormals();var v=new THREE.Mesh(g,y);return"left"===a?i-=g.boundingBox.min.x:"right"===a&&(i+=g.boundingBox.min.x),v.position.set(i,o,s),v}return t}();var _get=function r(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:r(o,e,n)}if("value"in i)return i.value;var s=i.get;if(void 0!==s)return s.call(n)},_createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();Primrose.Text.Controls.TextBox=function(){var t=isFirefox?3:100,e=0,n=5,r=function(r){function i(t){_classCallCheck(this,i);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(i).call(this,patch(t,{id:"Primrose.Text.Controls.TextBox["+e++ +"]"})));n.listeners.change=[],"string"==typeof t?n.options={value:n.options}:n.options=t||{},n.useCaching=!isFirefox||!isMobile;var r=function(t){var e=t.toLowerCase();this["cursor"+t]=function(t,n){n[e](t),this.scrollIntoView(n)}};["Left","Right","SkipLeft","SkipRight","Up","Down","Home","End","FullHome","FullEnd"].map(r.bind(n)),n.tokens=null,n.lines=null,n._commandPack=null,n._tokenRows=null,n._tokenHashes=null,n._tabString=null,n._currentTouchID=null,n._lineCountWidth=null,n._lastFont=null,n._lastText=null,n._lastCharacterWidth=null,n._lastCharacterHeight=null,n._lastGridBounds=null,n._lastPadding=null,n._lastFrontCursor=null,n._lastBackCursor=null,n._lastWidth=-1,n._lastHeight=-1,n._lastScrollX=-1,n._lastScrollY=-1,n._lastFocused=!1,n._lastThemeName=null,n._lastPointer=new Primrose.Text.Point,n._browser=isChrome?"CHROMIUM":isFirefox?"FIREFOX":isIE?"IE":isOpera?"OPERA":isSafari?"SAFARI":"UNKNOWN",n._pointer=new Primrose.Text.Point,n._deadKeyState="",n._history=[],n._historyFrame=-1,n._topLeftGutter=new Primrose.Text.Size,n._bottomRightGutter=new Primrose.Text.Size,n._dragging=!1,n._scrolling=!1,n._wheelScrollSpeed=4;var o=new Primrose.Text.Rectangle(0,0,n.bounds.width,n.bounds.height);return n._fg=new Primrose.Surface({id:n.id+"-fore",bounds:o}),n._fgCanvas=n._fg.canvas,n._fgfx=n._fg.context,n._bg=new Primrose.Surface({id:n.id+"-back",bounds:o}),n._bgCanvas=n._bg.canvas,n._bgfx=n._bg.context,n._trim=new Primrose.Surface({id:n.id+"-trim",bounds:o}),n._trimCanvas=n._trim.canvas,n._tgfx=n._trim.context,n._rowCache={},n._VSCROLL_WIDTH=2,n.tabWidth=n.options.tabWidth,n.showLineNumbers=!n.options.hideLineNumbers,n.showScrollBars=!n.options.hideScrollBars,n.wordWrap=!n.options.disableWordWrap,n.readOnly=!!n.options.readOnly,n.multiline=!n.options.singleLine,n.gridBounds=new Primrose.Text.Rectangle,n.frontCursor=new Primrose.Text.Cursor,n.backCursor=new Primrose.Text.Cursor,n.scroll=new Primrose.Text.Point,n.character=new Primrose.Text.Size,n.theme=n.options.theme,n.fontSize=n.options.fontSize,n.tokenizer=n.options.tokenizer,n.commandPack=n.options.commands||Primrose.Text.CommandPacks.TextEditor,n.value=n.options.value,n.padding=n.options.padding||1,n.addEventListener("focus",n.render.bind(n),!1),n.addEventListener("blur",n.render.bind(n),!1),n}return _inherits(i,r),_createClass(i,null,[{key:"create",value:function(){return new i}}]),_createClass(i,[{key:"cursorPageUp",value:function(t,e){e.incY(-this.gridBounds.height,t),this.scrollIntoView(e)}},{key:"cursorPageDown",value:function(t,e){e.incY(this.gridBounds.height,t),this.scrollIntoView(e)}},{key:"setDeadKeyState",value:function(t){this._deadKeyState=t||""}},{key:"pushUndo",value:function(t){this._historyFrame<this._history.length-1&&this._history.splice(this._historyFrame+1),this._history.push(t),this._historyFrame=this._history.length-1,this.refreshTokens(),this.render()}},{key:"redo",value:function(){this._historyFrame<this._history.length-1&&++this._historyFrame,this.refreshTokens(),this.fixCursor(),this.render()}},{key:"undo",value:function(){this._historyFrame>0&&--this._historyFrame,this.refreshTokens(),this.fixCursor(),this.render()}},{key:"scrollIntoView",value:function(t){this.scroll.y+=this.minDelta(t.y,this.scroll.y,this.scroll.y+this.gridBounds.height),this.wordWrap||(this.scroll.x+=this.minDelta(t.x,this.scroll.x,this.scroll.x+this.gridBounds.width)),this.clampScroll()}},{key:"readWheel",value:function(e){this.focused&&((e.shiftKey||isChrome)&&(this.fontSize+=-e.deltaX/t),e.shiftKey&&!isChrome||(this.scroll.y+=Math.floor(e.deltaY*this._wheelScrollSpeed/t)),this.clampScroll(),this.render(),e.preventDefault())}},{key:"startPointer",value:function(t,e){_get(Object.getPrototypeOf(i.prototype),"startPointer",this).call(this,t,e)||(this._dragging=!0,this.setCursorXY(this.frontCursor,t,e))}},{key:"movePointer",value:function(t,e){this._dragging&&this.setCursorXY(this.backCursor,t,e)}},{key:"endPointer",value:function(){_get(Object.getPrototypeOf(i.prototype),"endPointer",this).call(this),this._dragging=!1,this._scrolling=!1}},{key:"bindEvents",value:function(t){var e=this;t instanceof HTMLCanvasElement&&(void 0===t.tabindex||null===t.tabindex)&&(t.tabindex=0),BrowserEnvironment.createSurrogate.call(this),t.addEventListener("wheel",this.readWheel.bind(this),!1),t.addEventListener("mousedown",this.mouseButtonDown.bind(this),!1),t.addEventListener("mousemove",this.mouseMove.bind(this),!1),t.addEventListener("mouseup",this.mouseButtonUp.bind(this),!1),t.addEventListener("touchstart",this.touchStart.bind(this),!1),t.addEventListener("touchmove",this.touchMove.bind(this),!1),t.addEventListener("touchend",this.touchEnd.bind(this),!1),t.addEventListener("keydown",this.keyDown.bind(this),!1),t.addEventListener("beforepaste",function(t){return t.returnValue=!1},!1),t.addEventListener("paste",this.readClipboard.bind(this),!1),t.addEventListener("keydown",function(t){var n=isOSX?Primrose.Text.OperatingSystems.OSX:Primrose.Text.OperatingSystems.Windows;e.focused&&n.isClipboardReadingEvent(t)&&(e._surrogate.style.display="block",e._surrogate.focus())},!0)}},{key:"copySelectedText",value:function(t){if(this.focused&&this.frontCursor.i!==this.backCursor.i){var e=t.clipboardData||window.clipboardData;e.setData(window.clipboardData?"Text":"text/plain",this.selectedText),t.returnValue=!1}}},{key:"cutSelectedText",value:function(t){this.focused&&(this.copySelectedText(t),this.readOnly||(this.selectedText=""))}},{key:"execCommand",value:function(t,e,n){if(n&&this.focused&&!this.readOnly){var r=t+"_"+n,i=this.commandPack[r]||this.commandPack[n]||e[r]||e[n];return(i instanceof String||"string"==typeof i)&&(console.log("okay"),i=this.commandPack[i]||this.commandPack[i]||i),void 0===i?!1:(this.frontCursor.moved=!1,this.backCursor.moved=!1,i instanceof Function?i(this,this.lines):(i instanceof String||"string"==typeof i)&&(console.log(i),this.selectedText=i),this.frontCursor.moved&&!this.backCursor.moved&&this.backCursor.copy(this.frontCursor),this.clampScroll(),this.render(),!0)}}},{key:"readClipboard",value:function(t){if(this.focused&&!this.readOnly){t.returnValue=!1;var e=t.clipboardData||window.clipboardData,n=e.getData(window.clipboardData?"Text":"text/plain");n&&(this.selectedText=n)}}},{key:"resize",value:function(){_get(Object.getPrototypeOf(i.prototype),"resize",this).call(this),this._bg.setSize(this.surfaceWidth,this.surfaceHeight),this._fg.setSize(this.surfaceWidth,this.surfaceHeight),this._trim.setSize(this.surfaceWidth,this.surfaceHeight),this.theme&&(this.character.height=this.fontSize,this.context.font=this.character.height+"px "+this.theme.fontFamily,this.character.width=this.context.measureText("MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM").width/100),this.render()}},{key:"pixel2cell",value:function(t){t.x*this.imageWidth/this.surfaceWidth,t.y*this.imageHeight/this.surfaceHeight;t.set(Math.round(t.x/this.character.width)+this.scroll.x-this.gridBounds.x,Math.floor(t.y/this.character.height-.25)+this.scroll.y)}},{key:"clampScroll",value:function(){if(this.scroll.y<0)this.scroll.y=0;else for(;0<this.scroll.y&&this.scroll.y>this.lines.length-this.gridBounds.height;)--this.scroll.y}},{key:"refreshTokens",value:function(){this.tokens=this.tokenizer.tokenize(this.value)}},{key:"fixCursor",value:function(){var t=this.frontCursor.fixCursor(this.lines)||this.backCursor.fixCursor(this.lines);t&&this.render()}},{key:"setCursorXY",value:function(t,e,n){e=Math.round(e),n=Math.round(n),this._pointer.set(e,n),this.pixel2cell(this._pointer,this.scroll,this.gridBounds);var r=this._pointer.x-this.scroll.x,i=this._pointer.y-this.scroll.y,o=i>=this.gridBounds.height,s=0>r,a=this._pointer.x>=this.gridBounds.width;if(this._scrolling||o||s||a){if(this._scrolling||a&&!o){this._scrolling=!0;var u=this.lines.length-this.gridBounds.height;if(i>=0&&u>=0){var c=i*u/this.gridBounds.height;this.scroll.y=Math.floor(c)}}else if(o&&!s){for(var l=0,h=0;h<this.lines.length;++h)l=Math.max(l,this.lines[h].length);var d=l-this.gridBounds.width;if(r>=0&&d>=0){var f=r*d/this.gridBounds.width;this.scroll.x=Math.floor(f)}}}else t.setXY(this._pointer.x,this._pointer.y,this.lines),this.backCursor.copy(t);this._lastPointer.copy(this._pointer),this.render()}},{key:"mouseButtonDown",value:function(t){0===t.button&&(this.startDOMPointer(t),t.preventDefault())}},{key:"mouseMove",value:function(t){this.focused&&this.moveDOMPointer(t)}},{key:"mouseButtonUp",value:function(t){this.focused&&0===t.button&&this.endPointer()}},{key:"touchStart",value:function(t){if(this.focused&&t.touches.length>0&&!this._dragging){var e=t.touches[0];this.startDOMPointer(e),this._currentTouchID=e.identifier}}},{key:"touchMove",value:function(t){for(var e=0;e<t.changedTouches.length&&this._dragging;++e){var n=t.changedTouches[e];if(n.identifier===this._currentTouchID){this.moveDOMPointer(n);break}}}},{key:"touchEnd",value:function(t){for(var e=0;e<t.changedTouches.length&&this._dragging;++e){var n=t.changedTouches[e];n.identifier===this._currentTouchID&&this.endPointer()}}},{key:"setGutter",value:function(){this.showLineNumbers?this._topLeftGutter.width=1:this._topLeftGutter.width=0,this.showScrollBars?this.wordWrap?this._bottomRightGutter.set(this._VSCROLL_WIDTH,0):this._bottomRightGutter.set(this._VSCROLL_WIDTH,1):this._bottomRightGutter.set(0,0)}},{key:"refreshGridBounds",value:function(){this._lineCountWidth=0,this.showLineNumbers&&(this._lineCountWidth=Math.max(1,Math.ceil(Math.log(this._history[this._historyFrame].length)/Math.LN10)));var t=Math.floor(this._topLeftGutter.width+this._lineCountWidth+this.padding/this.character.width),e=Math.floor(this.padding/this.character.height),n=Math.floor((this.imageWidth-2*this.padding)/this.character.width)-t-this._bottomRightGutter.width,r=Math.floor((this.imageHeight-2*this.padding)/this.character.height)-e-this._bottomRightGutter.height;this.gridBounds.set(t,e,n,r)}},{key:"performLayout",value:function(){this._tokenRows=[[]],this._tokenHashes=[""],this.lines=[""];for(var t=0,e=this.tokens.slice(),n=0;n<e.length;++n){var r=e[n].clone(),i=this.gridBounds.width-t,o=this.wordWrap&&"newlines"!==r.type&&r.value.length>i,s="newlines"===r.type||o;if(o){var a=r.value.length>this.gridBounds.width?i:0;e.splice(n+1,0,r.splitAt(a))}r.value.length>0&&(this._tokenRows[this._tokenRows.length-1].push(r),this._tokenHashes[this._tokenHashes.length-1]+=JSON.stringify(r),this.lines[this.lines.length-1]+=r.value,t+=r.value.length),s&&(this._tokenRows.push([]),this._tokenHashes.push(""),this.lines.push(""),t=0)}}},{key:"minDelta",value:function(t,e,n){var r=t-e,i=t-n+5,o=0;return(0>r||i>=0)&&(o=Math.abs(r)<Math.abs(i)?r:i),o}},{key:"fillRect",value:function(t,e,n,r,i,o){t.fillStyle=e,t.fillRect(n*this.character.width,r*this.character.height,i*this.character.width+1,o*this.character.height+1)}},{key:"strokeRect",value:function(t,e,n,r,i,o){t.strokeStyle=e,t.strokeRect(n*this.character.width,r*this.character.height,i*this.character.width+1,o*this.character.height+1)}},{key:"renderCanvasBackground",value:function(){var t=Primrose.Text.Cursor.min(this.frontCursor,this.backCursor),e=Primrose.Text.Cursor.max(this.frontCursor,this.backCursor),r=new Primrose.Text.Cursor,i=new Primrose.Text.Cursor,o=this.theme.regular.backColor?"fillRect":"clearRect",s=n/this.character.height;this.theme.regular.backColor&&(this._bgfx.fillStyle=this.theme.regular.backColor),this._bgfx[o](0,0,this.imageWidth,this.imageHeight),this._bgfx.save(),this._bgfx.translate((this.gridBounds.x-this.scroll.x)*this.character.width+this.padding,-this.scroll.y*this.character.height+this.padding),this.focused&&this.fillRect(this._bgfx,this.theme.regular.currentRowBackColor||Primrose.Text.Themes.Default.regular.currentRowBackColor,0,t.y+s,this.gridBounds.width,e.y-t.y+1);for(var a=0;a<this._tokenRows.length;++a){for(var u=this._tokenRows[a],c=0;c<u.length;++c){var l=u[c];if(i.x+=l.value.length,i.i+=l.value.length,this.scroll.y<=a&&a<this.scroll.y+this.gridBounds.height&&this.scroll.x<=i.x&&r.x<this.scroll.x+this.gridBounds.width){var h=t.i<=i.i&&r.i<e.i;if(h){var d=Primrose.Text.Cursor.max(t,r),f=Primrose.Text.Cursor.min(e,i),m=f.i-d.i;this.fillRect(this._bgfx,this.theme.regular.selectedBackColor||Primrose.Text.Themes.Default.regular.selectedBackColor,d.x,d.y+s,m,1)}}r.copy(i)}r.x=0,++r.y,i.copy(r)}if(this.focused){var p=this.theme.cursorColor||"black",y=1/this.character.width;this.fillRect(this._bgfx,p,t.x,t.y+s,y,1),this.fillRect(this._bgfx,p,e.x,e.y+s,y,1)}this._bgfx.restore()}},{key:"renderCanvasForeground",value:function(){var t=new Primrose.Text.Cursor,e=new Primrose.Text.Cursor;this._fgfx.clearRect(0,0,this.imageWidth,this.imageHeight),this._fgfx.save(),this._fgfx.translate((this.gridBounds.x-this.scroll.x)*this.character.width+this.padding,this.padding);for(var r=0;r<this._tokenRows.length;++r){for(var i=this.lines[r]+this.padding,o=this._tokenRows[r],s=!1,a=(r-this.scroll.y)*this.character.height,u=0;u<o.length;++u){var c=o[u];if(e.x+=c.value.length,e.i+=c.value.length,this.scroll.y<=r&&r<this.scroll.y+this.gridBounds.height&&this.scroll.x<=e.x&&t.x<this.scroll.x+this.gridBounds.width)if(this.useCaching&&void 0!==this._rowCache[i])0===u&&this._fgfx.putImageData(this._rowCache[i],this.padding,a+this.padding+n);else{var l=this.theme[c.type]||{},h=(l.fontWeight||this.theme.regular.fontWeight||"")+" "+(l.fontStyle||this.theme.regular.fontStyle||"")+" "+this.character.height+"px "+this.theme.fontFamily;this._fgfx.font=h.trim(),this._fgfx.fillStyle=l.foreColor||this.theme.regular.foreColor,this.drawText(this._fgfx,c.value,t.x*this.character.width,a),s=!0}t.copy(e)}t.x=0,++t.y,e.copy(t),this.useCaching&&s&&void 0===this._rowCache[i]&&(this._rowCache[i]=this._fgfx.getImageData(this.padding,a+this.padding+n,this.imageWidth-2*this.padding,this.character.height))}this._fgfx.restore()}},{key:"drawText",value:function(t,e,n,r){t.fillText(e,n,r)}},{key:"renderCanvasTrim",value:function(){var t=new Primrose.Text.Cursor,e=new Primrose.Text.Cursor,n=0;this._tgfx.clearRect(0,0,this.imageWidth,this.imageHeight),this._tgfx.save(),this._tgfx.translate(this.padding,this.padding),this._tgfx.save(),this._tgfx.lineWidth=2,this._tgfx.translate(0,-this.scroll.y*this.character.height);for(var r=0,i=-1;r<this._tokenRows.length;++r){for(var o=this._tokenRows[r],s=0;s<o.length;++s){var a=o[s];e.x+=a.value.length,e.i+=a.value.length,t.copy(e)}if(n=Math.max(n,e.x),t.x=0,++t.y,e.copy(t),this.showLineNumbers&&this.scroll.y<=r&&r<this.scroll.y+this.gridBounds.height){for(var u=o.length>0?o[0].line:i+1,c=u.toString();c.length<this._lineCountWidth;)c=" "+c;this.fillRect(this._tgfx,this.theme.regular.selectedBackColor||Primrose.Text.Themes.Default.regular.selectedBackColor,0,r,this.gridBounds.x,1),this._tgfx.font="bold "+this.character.height+"px "+this.theme.fontFamily,u>i&&(this._tgfx.fillStyle=this.theme.regular.foreColor,this._tgfx.fillText(c,0,r*this.character.height)),
i=u}}if(this._tgfx.restore(),this.showLineNumbers&&this.strokeRect(this._tgfx,this.theme.regular.foreColor||Primrose.Text.Themes.Default.regular.foreColor,0,0,this.gridBounds.x,this.gridBounds.height),this.showScrollBars){var l=this.gridBounds.width*this.character.width-this.padding,h=this.gridBounds.height*this.character.height,d=this.scroll.x*l/n+this.gridBounds.x*this.character.width,f=this.scroll.y*h/this._tokenRows.length;this._tgfx.fillStyle=this.theme.regular.selectedBackColor||Primrose.Text.Themes.Default.regular.selectedBackColor;var m;if(!this.wordWrap&&n>this.gridBounds.width){var p=l*(this.gridBounds.width/n),y=this.gridBounds.height*this.character.height;m=Math.max(this.character.width,p),this._tgfx.fillRect(d,y,m,this.character.height),this._tgfx.strokeRect(d,y,m,this.character.height)}if(this._tokenRows.length>this.gridBounds.height){var g=h*(this.gridBounds.height/this._tokenRows.length),v=this.image-this._VSCROLL_WIDTH*this.character.width-2*this.padding,b=Math.max(this.character.height,g);m=this._VSCROLL_WIDTH*this.character.width,this._tgfx.fillRect(v,f,m,b),this._tgfx.strokeRect(v,f,m,b)}}this._tgfx.lineWidth=2,this._tgfx.restore(),this._tgfx.strokeRect(1,1,this.imageWidth-2,this.imageHeight-2),this.focused||(this._tgfx.fillStyle=this.theme.regular.unfocused||Primrose.Text.Themes.Default.regular.unfocused,this._tgfx.fillRect(0,0,this.imageWidth,this.imageHeight))}},{key:"render",value:function(){if(this.tokens&&this.theme){this.refreshGridBounds();var t=this.gridBounds.toString()!==this._lastGridBounds,e=this._lastText!==this.value,n=this.character.width!==this._lastCharacterWidth,r=this.character.height!==this._lastCharacterHeight,i=this.padding!==this._lastPadding,o=!this._lastFrontCursor||!this._lastBackCursor||this.frontCursor.i!==this._lastFrontCursor.i||this._lastBackCursor.i!==this.backCursor.i,s=this.scroll.x!==this._lastScrollX||this.scroll.y!==this._lastScrollY,a=(this.context.font!==this._lastFont,this.theme.name!==this._lastThemeName),u=this.focused!==this._lastFocused,c=null,l=this.resized||t||e||n||r||i,h=l||o||s||a,d=h||e,f=h||u,m=d||h||f;if(l&&(this.performLayout(this.gridBounds),this._rowCache={}),m){if(o&&!(l||s||a||u)){var p=Math.min(this.frontCursor.y,this._lastFrontCursor.y,this.backCursor.y,this._lastBackCursor.y)-this.scroll.y+this.gridBounds.y,y=Math.max(this.frontCursor.y,this._lastFrontCursor.y,this.backCursor.y,this._lastBackCursor.y)-this.scroll.y+1;c=new Primrose.Text.Rectangle(0,p*this.character.height,this.bounds.width,(y-p)*this.character.height+2)}h&&this.renderCanvasBackground(),d&&this.renderCanvasForeground(),f&&this.renderCanvasTrim(),this.context.clearRect(0,0,this.imageWidth,this.imageHeight),this.context.drawImage(this._bgCanvas,0,0),this.context.drawImage(this._fgCanvas,0,0),this.context.drawImage(this._trimCanvas,0,0),this.invalidate(c)}this._lastGridBounds=this.gridBounds.toString(),this._lastText=this.value,this._lastCharacterWidth=this.character.width,this._lastCharacterHeight=this.character.height,this._lastWidth=this.imageWidth,this._lastHeight=this.imageHeight,this._lastPadding=this.padding,this._lastFrontCursor=this.frontCursor.clone(),this._lastBackCursor=this.backCursor.clone(),this._lastFocused=this.focused,this._lastFont=this.context.font,this._lastThemeName=this.theme.name,this._lastScrollX=this.scroll.x,this._lastScrollY=this.scroll.y}}},{key:"value",get:function(){return this._history[this._historyFrame].join("\n")},set:function(t){t=t||"",t=t.replace(/\r\n/g,"\n"),this.multiline||(t=t.replace(/\n/g,""));var e=t.split("\n");this.pushUndo(e),this.render(),emit.call(this,"change",{target:this})}},{key:"selectedText",get:function(){var t=Primrose.Text.Cursor.min(this.frontCursor,this.backCursor),e=Primrose.Text.Cursor.max(this.frontCursor,this.backCursor);return this.value.substring(t.i,e.i)},set:function(t){if(t=t||"",t=t.replace(/\r\n/g,"\n"),this.frontCursor.i!==this.backCursor.i||t.length>0){var e=Primrose.Text.Cursor.min(this.frontCursor,this.backCursor),n=Primrose.Text.Cursor.max(this.frontCursor,this.backCursor),r=this.value,i=r.substring(0,e.i),o=r.substring(n.i),s=i+t+o;this.value=s,this.refreshGridBounds(),this.performLayout(),e.advanceN(this.lines,Math.max(0,t.length)),this.scrollIntoView(n),this.clampScroll(),n.copy(e),this.render()}}},{key:"padding",get:function(){return this._padding},set:function(t){this._padding=t,this.render()}},{key:"wordWrap",get:function(){return this._wordWrap},set:function(t){this._wordWrap=t||!1,this.setGutter()}},{key:"showLineNumbers",get:function(){return this._showLineNumbers},set:function(t){this._showLineNumbers=t,this.setGutter()}},{key:"showScrollBars",get:function(){return this._showScrollBars},set:function(t){this._showScrollBars=t,this.setGutter()}},{key:"theme",get:function(){return this._theme},set:function(t){this._theme=clone(t||Primrose.Text.Themes.Default),this._theme.fontSize=this.fontSize,this._rowCache={},this.render()}},{key:"commandPack",get:function(){return this._commandPack},set:function(t){this._commandPack=t}},{key:"selectionStart",get:function(){return this.frontCursor.i},set:function(t){this.frontCursor.setI(t,this.lines)}},{key:"selectionEnd",get:function(){return this.backCursor.i},set:function(t){this.backCursor.setI(t,this.lines)}},{key:"selectionDirection",get:function(){return this.frontCursor.i<=this.backCursor.i?"forward":"backward"}},{key:"tokenizer",get:function(){return this._tokenizer},set:function(t){this._tokenizer=t||Primrose.Text.Grammars.JavaScript,this._history&&this._history.length>0&&(this.refreshTokens(),this.render())}},{key:"tabWidth",get:function(){return this._tabWidth},set:function(t){this._tabWidth=t||2,this._tabString="";for(var e=0;e<this._tabWidth;++e)this._tabString+=" "}},{key:"tabString",get:function(){return this._tabString}},{key:"fontSize",get:function(){return this._fontSize||16},set:function(t){t=t||16,this._fontSize=t,this.theme&&(this.theme.fontSize=this._fontSize,this.resize(),this.render())}},{key:"lockMovement",get:function(){return this.focused&&!this.readOnly}}]),i}(Primrose.Surface);return r}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),_set=function i(t,e,n,r){var o=Object.getOwnPropertyDescriptor(t,e);if(void 0===o){var s=Object.getPrototypeOf(t);null!==s&&i(s,e,n,r)}else if("value"in o&&o.writable)o.value=n;else{var a=o.set;void 0!==a&&a.call(r,n)}return n},_get=function o(t,e,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,e);if(void 0===r){var i=Object.getPrototypeOf(t);return null===i?void 0:o(i,e,n)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(n)};Primrose.Text.Controls.TextInput=function(){var t=0,e=function(e){function n(e){_classCallCheck(this,n);var r=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,overwrite(patch(e,{id:"Primrose.Text.Controls.TextInput["+t++ +"]",padding:5}),{singleLine:!0,disableWordWrap:!0,hideLineNumbers:!0,hideScrollBars:!0,tabWidth:1,tokenizer:Primrose.Text.Grammars.PlainText,commands:Primrose.Text.CommandPacks.TextInput})));return r.passwordCharacter=r.options.passwordCharacter,r}return _inherits(n,e),_createClass(n,[{key:"drawText",value:function(t,e,r,i){if(this.passwordCharacter){for(var o="",s=0;s<e.length;++s)o+=this.passwordCharacter;e=o}_get(Object.getPrototypeOf(n.prototype),"drawText",this).call(this,t,e,r,i)}},{key:"value",get:function(){return _get(Object.getPrototypeOf(n.prototype),"value",this)},set:function(t){t=t||"",t=t.replace(/\r?\n/g,""),_set(Object.getPrototypeOf(n.prototype),"value",t,this)}},{key:"selectedText",get:function(){return _get(Object.getPrototypeOf(n.prototype),"selectedText",this)},set:function(t){t=t||"",t=t.replace(/\r?\n/g,""),_set(Object.getPrototypeOf(n.prototype),"selectedText",t,this)}}]),n}(Primrose.Text.Controls.TextBox);return e}(),Primrose.Text.Grammars.Basic=function(){var basicGrammar=new Primrose.Text.Grammar("BASIC",[["newlines",/(?:\r\n|\r|\n)/],["lineNumbers",/^\d+\s+/],["startLineComments",/^REM\s/],["strings",/"(?:\\"|[^"])*"/],["strings",/'(?:\\'|[^'])*'/],["numbers",/-?(?:(?:\b\d*)?\.)?\b\d+\b/],["keywords",/\b(?:RESTORE|REPEAT|RETURN|LOAD|LABEL|DATA|READ|THEN|ELSE|FOR|DIM|LET|IF|TO|STEP|NEXT|WHILE|WEND|UNTIL|GOTO|GOSUB|ON|TAB|AT|END|STOP|PRINT|INPUT|RND|INT|CLS|CLK|LEN)\b/],["keywords",/^DEF FN/],["operators",/(?:\+|;|,|-|\*\*|\*|\/|>=|<=|=|<>|<|>|OR|AND|NOT|MOD|\(|\)|\[|\])/],["identifiers",/\w+\$?/]]),oldTokenize=basicGrammar.tokenize;return basicGrammar.tokenize=function(t){return oldTokenize.call(this,t.toUpperCase())},basicGrammar.interpret=function(sourceCode,input,output,errorOut,next,clearScreen,loadFile,done){function toNum(t){return new Primrose.Text.Token(t.toString(),"numbers")}function toStr(t){return new Primrose.Text.Token('"'+t.replace("\n","\\n").replace('"','\\"')+'"',"strings")}function process(t){if(t&&t.length>0){var e=t.shift();if(e){if(commands.hasOwnProperty(e.value))return commands[e.value](t);if(!isNaN(e.value))return setProgramCounter([e]);if(state[e.value]||t.length>0&&"operators"===t[0].type&&"="===t[0].value)return t.unshift(e),translate(t);error("Unknown command. >>> "+e.value)}}return pauseBeforeComplete()}function error(t){errorOut("At line "+lineNumbers[counter]+": "+t)}function getLine(t){var e=lineNumbers[t],n=program[e];return n&&n.slice()}function evaluate(line){for(var script="",i=0;i<line.length;++i){var t=line[i],nest=0;if("identifiers"===t.type&&"function"!=typeof state[t.value]&&i<line.length-1&&"("===line[i+1].value)for(var j=i+1;j<line.length;++j){var t2=line[j];if("("===t2.value?(0===nest&&(t2.value="["),++nest):")"===t2.value?(--nest,0===nest&&(t2.value="]")):","===t2.value&&1===nest&&(t2.value="]["),0===nest)break}script+=t.value}try{return eval(script)}catch(exp){console.error(exp),console.debug(line.join(", ")),console.error(script),error(exp.message+": "+script)}}function declareVariable(t){var e,n=[],r=[n],i=0;for(e=0;e<t.length;++e){var o=t[e];"("===o.value?++i:")"===o.value&&--i,0===i&&","===o.value?(n=[],r.push(n)):n.push(o)}for(e=0;e<r.length;++e){n=r[e];var s=n.shift();if("identifiers"===s.type){var a,u=null;if(s=s.value,"("===n[0].value&&")"===n[n.length-1].value){var c=[];for(a=1;a<n.length-1;++a)"numbers"===n[a].type&&c.push(0|n[a].value);if(0===c.length)u=[];else{u=new Array(c[0]);var l=[u];for(a=1;a<c.length;++a)for(var h=c[a],d=0,f=l.length;f>d;++d)for(var m=l.shift(),p=0;p<m.length;++p)m[p]=new Array(h),a<c.length-1&&l.push(m[p])}}return state[s]=u,!0}error("Identifier expected: "+s.value)}}function print(t){var e="\n",n=0;t=t.map(function(r,i){return r=r.clone(),"operators"===r.type&&(","===r.value?0===n&&(r.value='+ ", " + '):";"===r.value?(r.value='+ " "',i<t.length-1?r.value+=" + ":e=""):"("===r.value?++n:")"===r.value&&--n),r});var r=evaluate(t);return void 0===r&&(r=""),output(r+e),!0}function setProgramCounter(t){var e=parseFloat(evaluate(t));for(counter=-1;counter<lineNumbers.length-1&&lineNumbers[counter+1]<e;)++counter;return!0}function checkConditional(t){var e,n=-1,r=-1;for(e=0;e<t.length;++e)"keywords"===t[e].type&&"THEN"===t[e].value?n=e:"keywords"===t[e].type&&"ELSE"===t[e].value&&(r=e);if(-1===n)error("Expected THEN clause.");else{var i=t.slice(0,n);for(e=0;e<i.length;++e){var o=i[e];"operators"===o.type&&"="===o.value&&(o.value="==")}var s,a;if(-1===r?s=t.slice(n+1):(s=t.slice(n+1,r),a=t.slice(r+1)),evaluate(i))return process(s);if(a)return process(a)}return!0}function pauseBeforeComplete(){return output("PROGRAM COMPLETE - PRESS RETURN TO FINISH."),input(function(){isDone=!0,done&&done()}),!1}function labelLine(t){return t.push(EQUAL_SIGN),t.push(toNum(lineNumbers[counter])),translate(t)}function waitForInput(t){var e=t.pop();return t.length>0&&print(t),input(function(t){t=t.toUpperCase();var n=null;n=isNaN(t)?toStr(t):toNum(t),evaluate([e,EQUAL_SIGN,n]),next&&next()}),!1}function onStatement(t){var e=[],n=null,r=[];try{for(;t.length>0&&("keywords"!==t[0].type||"GOTO"!==t[0].value);)e.push(t.shift());if(t.length>0){t.shift();for(var i=0;i<t.length;++i){var o=t[i];"operators"===o.type&&","===o.value||r.push(o)}if(n=evaluate(e)-1,n>=0&&n<r.length)return setProgramCounter([r[n]])}}catch(s){console.error(s)}return!0}function gotoSubroutine(t){return returnStack.push(toNum(lineNumbers[counter+1])),setProgramCounter(t)}function setRepeat(){return returnStack.push(toNum(lineNumbers[counter])),!0}function conditionalReturn(t){var e=!0,n=returnStack.pop();return n&&t&&(e=setProgramCounter([n])),e}function untilLoop(t){var e=!evaluate(t);return conditionalReturn(e)}function findNext(t){for(i=counter+1;i<lineNumbers.length;++i){var e=getLine(i);if(e[0].value===t)return i}return lineNumbers.length}function whileLoop(t){var e=evaluate(t);return e?returnStack.push(toNum(lineNumbers[counter])):counter=findNext("WEND"),!0}function forLoop(t){var e=lineNumbers[counter],n=[],r=[],i=[],o=[],s=[n,r,i,o],a=0,u=0;for(u=0;u<t.length;++u){var c=t[u];c.value===FOR_LOOP_DELIMS[a]?(0===a&&n.push(c),++a):s[a].push(c)}var l=1;o.length>0&&(l=evaluate(o)),void 0===forLoopCounters[e]&&(forLoopCounters[e]=evaluate(r));var h=evaluate(i),d=forLoopCounters[e]<=h;return d?(n.push(toNum(forLoopCounters[e])),process(n),forLoopCounters[e]+=l,returnStack.push(toNum(lineNumbers[counter]))):(delete forLoopCounters[e],counter=findNext("NEXT")),!0}function stackReturn(){return conditionalReturn(!0)}function loadCodeFile(t){return loadFile(evaluate(t)).then(next),!1}function noop(){return!0}function loadData(t){for(;t.length>0;){var e=t.shift();"operators"!==e.type&&data.push(e.value)}return!0}function readData(t){if(0===data.length){var e=findNext("DATA");process(getLine(e))}var n=data[dataCounter];return++dataCounter,t.push(EQUAL_SIGN),t.push(toNum(n)),translate(t)}function restoreData(){return dataCounter=0,!0}function defineFunction(line){for(var name=line.shift().value,signature="",body="",fillSig=!0,i=0;i<line.length;++i){var t=line[i];"operators"===t.type&&"="===t.value?fillSig=!1:fillSig?signature+=t.value:body+=t.value}name="FN"+name;var script="(function "+name+signature+"{ return "+body+"; })";return state[name]=eval(script),!0}function translate(t){return evaluate(t),!0}for(var tokens=this.tokenize(sourceCode),EQUAL_SIGN=new Primrose.Text.Token("=","operators"),counter=0,isDone=!1,program={},lineNumbers=[],currentLine=[],lines=[currentLine],data=[],returnStack=[],forLoopCounters={},dataCounter=0,state={INT:function(t){return 0|t},RND:function(){return Math.random()},CLK:function(){return Date.now()/36e5},LEN:function(t){return t.length},LINE:function(){return lineNumbers[counter]},TAB:function(t){for(var e="",n=0;t>n;++n)e+=" ";return e},POW:function(t,e){return Math.pow(t,e)}},tokenMap={OR:"||",AND:"&&",NOT:"!",MOD:"%","<>":"!="};tokens.length>0;){var token=tokens.shift();"newlines"===token.type?(currentLine=[],lines.push(currentLine)):"regular"!==token.type&&"comments"!==token.type&&(token.value=tokenMap[token.value]||token.value,currentLine.push(token))}for(var i=0;i<lines.length;++i){var line=lines[i];if(line.length>0){var lastLine=lineNumbers[lineNumbers.length-1],lineNumber=line.shift();if("lineNumbers"!==lineNumber.type&&(line.unshift(lineNumber),void 0===lastLine&&(lastLine=-1),lineNumber=toNum(lastLine+1)),lineNumber=parseFloat(lineNumber.value),lastLine&&lastLine>=lineNumber)throw new Error("expected line number greater than "+lastLine+", but received "+lineNumber+".");line.length>0&&(lineNumbers.push(lineNumber),program[lineNumber]=line)}}var FOR_LOOP_DELIMS=["=","TO","STEP"],commands={DIM:declareVariable,LET:translate,PRINT:print,GOTO:setProgramCounter,IF:checkConditional,INPUT:waitForInput,END:pauseBeforeComplete,STOP:pauseBeforeComplete,REM:noop,"'":noop,CLS:clearScreen,ON:onStatement,GOSUB:gotoSubroutine,RETURN:stackReturn,LOAD:loadCodeFile,DATA:loadData,READ:readData,RESTORE:restoreData,REPEAT:setRepeat,UNTIL:untilLoop,"DEF FN":defineFunction,WHILE:whileLoop,WEND:stackReturn,FOR:forLoop,NEXT:stackReturn,LABEL:labelLine};return function(){if(!isDone)for(var t=!0;t;){var e=getLine(counter);t=process(e),++counter}}},basicGrammar}(),Primrose.Text.Grammars.JavaScript=function(){return new Primrose.Text.Grammar("JavaScript",[["newlines",/(?:\r\n|\r|\n)/],["startBlockComments",/\/\*/],["endBlockComments",/\*\//],["regexes",/(?:^|,|;|\(|\[|\{)(?:\s*)(\/(?:\\\/|[^\n\/])+\/)/],["stringDelim",/("|')/],["startLineComments",/\/\/.*$/m],["numbers",/-?(?:(?:\b\d*)?\.)?\b\d+\b/],["keywords",/\b(?:break|case|catch|const|continue|debugger|default|delete|do|else|export|finally|for|function|if|import|in|instanceof|let|new|return|super|switch|this|throw|try|typeof|var|void|while|with)\b/],["functions",/(\w+)(?:\s*\()/],["members",/(\w+)\./],["members",/((\w+\.)+)(\w+)/]])}(),Primrose.Text.Grammars.PlainText=function(){return new Primrose.Text.Grammar("PlainText",[["newlines",/(?:\r\n|\r|\n)/]])}(),Primrose.Text.Grammars.TestResults=function(){return new Primrose.Text.Grammar("TestResults",[["newlines",/(?:\r\n|\r|\n)/,!0],["numbers",/(\[)(o+)/,!0],["numbers",/(\d+ succeeded), 0 failed/,!0],["numbers",/^    Successes:/,!0],["functions",/(x+)\]/,!0],["functions",/[1-9]\d* failed/,!0],["functions",/^    Failures:/,!0],["comments",/(\d+ms:)(.*)/,!0],["keywords",/(Test results for )(\w+):/,!0],["strings",/        \w+/,!0]])}(),Primrose.Text.OperatingSystems.OSX=function(){return new Primrose.Text.OperatingSystem("OS X","META","ALT","METASHIFT_z","META","LEFTARROW","RIGHTARROW","META","UPARROW","DOWNARROW")}(),Primrose.Text.OperatingSystems.Windows=function(){return new Primrose.Text.OperatingSystem("Windows","CTRL","CTRL","CTRL_y","","HOME","END","CTRL","HOME","END")}(),Primrose.Text.Themes.Dark=function(){return{name:"Dark",fontFamily:"'Droid Sans Mono', 'Consolas', 'Lucida Console', 'Courier New', 'Courier', monospace",cursorColor:"white",fontSize:16,lineNumbers:{foreColor:"white"},regular:{backColor:"black",foreColor:"#c0c0c0",currentRowBackColor:"#202020",selectedBackColor:"#404040",unfocused:"rgba(0, 0, 255, 0.25)"},strings:{foreColor:"#aa9900",fontStyle:"italic"},regexes:{foreColor:"#aa0099",fontStyle:"italic"},numbers:{foreColor:"green"},comments:{foreColor:"yellow",fontStyle:"italic"},keywords:{foreColor:"cyan"},functions:{foreColor:"brown",fontWeight:"bold"},members:{foreColor:"green"},error:{foreColor:"red",fontStyle:"underline italic"}}}(),Primrose.Text.Themes.Default=function(){return{name:"Light",fontFamily:"'Droid Sans Mono', 'Consolas', 'Lucida Console', 'Courier New', 'Courier', monospace",cursorColor:"black",fontSize:16,lineNumbers:{foreColor:"black"},regular:{backColor:"white",foreColor:"black",currentRowBackColor:"#f0f0f0",selectedBackColor:"#c0c0c0",unfocused:"rgba(0, 0, 255, 0.25)"},strings:{foreColor:"#aa9900",fontStyle:"italic"},regexes:{foreColor:"#aa0099",fontStyle:"italic"},numbers:{foreColor:"green"},comments:{foreColor:"grey",fontStyle:"italic"},keywords:{foreColor:"blue"},functions:{foreColor:"brown",fontWeight:"bold"},members:{foreColor:"green"},error:{foreColor:"red",fontStyle:"underline italic"}}}(),Primrose.VERSION="v0.25.0",console.info("Using Primrose v0.25.0. Find out more at http://www.primrosevr.com");