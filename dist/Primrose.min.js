/*
  Primrose v0.12.3 2015-06-10
  
  Copyright (C) 2015 Sean T. McBeth <sean@seanmcbeth.com> (https://www.seanmcbeth.com)
  https://www.primroseeditor.com
  https://github.com/capnmidnight/Primrose.git
*/
function reloadPage(){document.location=document.location.href}function cascadeElement(a,b,c){var d=null;if(null===a?(d=document.createElement(b),d.id=a="auto_"+b+Date.now()):void 0===c||a instanceof c?d=a:"string"==typeof a&&(d=document.getElementById(a),null===d?(d=document.createElement(b),d.id=a):d.tagName!==b.toUpperCase()&&(d=null)),null===d)throw new Error(a+" does not refer to a valid "+b+" element.");return d.innerHTML="",d}function findEverything(a,b){a=a||document,b=b||{};for(var c=a.querySelectorAll("*"),d=0;d<c.length;++d){var e=c[d];e.id&&e.id.length>0&&(b[e.id]=e,e.parentElement&&(e.parentElement[e.id]=e))}return b}function makeHidingContainer(a,b){var c=cascadeElement(a,"div",window.HTMLDivElement);return c.style.position="absolute",c.style.left=0,c.style.top=0,c.style.width=0,c.style.height=0,c.style.overflow="hidden",c.appendChild(b),c}function arr(a,b,c){return Array.prototype.slice.call(a,b,c)}function map(a,b){return Array.prototype.map.call(a,b)}function reduce(a,b,c){return Array.prototype.reduce.call(a,b,c)}function filter(a,b){return Array.prototype.filter.call(a,b)}function ofType(a,b){return"function"==typeof b?filter(a,function(a){return a instanceof b}):filter(a,function(a){return typeof a===b})}function agg(a,b,c){return"function"!=typeof b&&(b=function(a,b){return b[a]}.bind(window,b)),a.map(b).reduce(c)}function add(a,b){return a+b}function sum(a,b){return agg(a,b,add)}function group(a,b,c){var d=[],e=a.slice();e.sort(function(a,c){var d=b?b(a):a,e=b?b(c):c;return e>d?-1:d>e?1:0});for(var f=0;f<e.length;++f){var g=e[f],h=b?b(g):g,i=c?c(g):g;(0===d.length||d[d.length-1].key!==h)&&d.push({key:h,values:[]}),d[d.length-1].values.push(i)}return d}function setupVideo(a,b,c){function d(a,c,d){navigator.getUserMedia({video:a},function(a){var d=window.URL.createObjectURL(a);b.src=d,c()},d)}function e(b,c,f){if(f=f||0,a&&f<a.length){var g=a[f],h={optional:[{sourceId:b}]};"default"!==g&&(h.mandatory={minWidth:g.w,minHeight:g.h},g=fmt("[w:$1, h:$2]",g.w,g.h)),d(h,function(){console.log(fmt("Connected to camera at mode $1.",g))},function(a){console.error(fmt("Failed to connect at mode $1. Reason: $2",g,a)),e(b,a,f+1)})}else c()}function f(a){try{g&&(window.stream&&window.stream.stop(),b.src=null,g=!1)}catch(c){console.error("While stopping",c)}e(a,function(a){console.error("Couldn't connect at requested resolutions. Reason: ",a),d(!0,console.log.bind(console,"Connected to camera at default resolution"),console.error.bind(console,"Final connect attempt"))})}var g=!1;b.autoplay=1,b.addEventListener("canplay",function(a){g||(g=!0)},!1),c&&b.addEventListener("playing",c,!1),MediaStreamTrack.getVideoTracks(function(a){f(a&&a.length>0&&a[a.length-1].id)})}function isNumber(a){return!isNaN(a)}function sigfig(a,b){var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();if(b>0){var e=d.indexOf(".");for(-1===e&&(d+=".",e=d.length-1);d.length-e-1<b;)d+="0"}return d}function getSetting(a,b){if(window.localStorage){var c=window.localStorage.getItem(a);if(c)try{return JSON.parse(c)}catch(d){console.error("getSetting",a,c,typeof c,d)}}return b}function setSetting(a,b){if(window.localStorage&&b)try{window.localStorage.setItem(a,JSON.stringify(b))}catch(c){console.error("setSetting",a,b,typeof b,c)}}function deleteSetting(a){window.localStorage&&window.localStorage.removeItem(a)}function readForm(a){var b={};if(a)for(var c in a){var d=a[c];"INPUT"!==d.tagName&&"SELECT"!==d.tagName||d.dataset&&d.dataset.skipcache||("text"===d.type||"password"===d.type||"SELECT"===d.tagName?b[c]=d.value:("checkbox"===d.type||"radio"===d.type)&&(b[c]=d.checked))}return b}function writeForm(a,b){if(b)for(var c in a){var d=a[c];null===b[c]||void 0===b[c]||"INPUT"!==d.tagName&&"SELECT"!==d.tagName||d.dataset&&d.dataset.skipcache||("text"===d.type||"password"===d.type||"SELECT"===d.tagName?d.value=b[c]:("checkbox"===d.type||"radio"===d.type)&&(d.checked=b[c]))}}function isFullScreenMode(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function requestFullScreen(a,b){b?a.webkitRequestFullscreen?a.webkitRequestFullscreen({vrDisplay:b}):a.mozRequestFullScreen&&a.mozRequestFullScreen({vrDisplay:b}):a.requestFullscreen?a.requestFullscreen():a.webkitRequestFullscreen?a.webkitRequestFullscreen(window.Element.ALLOW_KEYBOARD_INPUT):a.mozRequestFullScreen?a.mozRequestFullScreen():a.msRequestFullscreen&&a.msRequestFullscreen(),a.requestPointerLock?a.requestPointerLock():a.webkitRequestPointerLock?a.webkitRequestPointerLock():a.mozRequestPointerLock&&a.mozRequestPointerLock()}function exitFullScreen(){isFullScreenMode()&&document.exitFullscreen()}function toggleFullScreen(a,b){isFullScreenMode()?exitFullScreen():requestFullScreen(a,b)}function isPointerLocked(){return!!(document.pointerLockElement||document.webkitPointerLockElement||document.mozPointerLockElement)}function InsideSphereGeometry(a,b,c,d,e,f,g){"use strict";THREE.Geometry.call(this),this.type="SphereGeometry",this.parameters={radius:a,widthSegments:b,heightSegments:c,phiStart:d,phiLength:e,thetaStart:f,thetaLength:g},a=a||50,b=Math.max(3,Math.floor(b)||8),c=Math.max(2,Math.floor(c)||6),d=void 0!==d?d:0,e=void 0!==e?e:2*Math.PI,f=void 0!==f?f:0,g=void 0!==g?g:Math.PI;var h,i,j=[],k=[];for(i=0;c>=i;i++){var l=[],m=[];for(h=b;h>=0;h--){var n=h/b,o=i/c,p=new THREE.Vector3;p.x=-a*Math.cos(d+n*e)*Math.sin(f+o*g),p.y=a*Math.cos(f+o*g),p.z=a*Math.sin(d+n*e)*Math.sin(f+o*g),this.vertices.push(p),l.push(this.vertices.length-1),m.push(new THREE.Vector2(1-n,1-o))}j.push(l),k.push(m)}for(i=0;c>i;i++)for(h=0;b>h;h++){var q=j[i][h+1],r=j[i][h],s=j[i+1][h],t=j[i+1][h+1],u=this.vertices[q].clone().normalize(),v=this.vertices[r].clone().normalize(),w=this.vertices[s].clone().normalize(),x=this.vertices[t].clone().normalize(),y=k[i][h+1].clone(),z=k[i][h].clone(),A=k[i+1][h].clone(),B=k[i+1][h+1].clone();Math.abs(this.vertices[q].y)===a?(y.x=(y.x+z.x)/2,this.faces.push(new THREE.Face3(q,s,t,[u,w,x])),this.faceVertexUvs[0].push([y,A,B])):Math.abs(this.vertices[s].y)===a?(A.x=(A.x+B.x)/2,this.faces.push(new THREE.Face3(q,r,s,[u,v,w])),this.faceVertexUvs[0].push([y,z,A])):(this.faces.push(new THREE.Face3(q,r,t,[u,v,x])),this.faceVertexUvs[0].push([y,z,B]),this.faces.push(new THREE.Face3(r,s,t,[v.clone(),w,x.clone()])),this.faceVertexUvs[0].push([z.clone(),A,B.clone()]))}this.computeFaceNormals(),this.boundingSphere=new THREE.Sphere(new THREE.Vector3,a)}function help(a){var b={},c={},d=[];if(a){for(var e in a)0!==e.indexOf("on")||a===navigator&&"onLine"===e?"function"==typeof a[e]?b[e]=a[e]:c[e]=a[e]:d.push(e.substring(2));var f=typeof a;if("function"===f)f=a.toString().match(/(function [^(]*)/)[1];else if("object"===f)if(f=null,a.constructor&&a.constructor.name)f=a.constructor.name;else{for(var g=[{prefix:"",obj:window}],h=[];g.length>0&&null===f;){var i=g.shift();i.___traversed___=!0,h.push(i);for(e in i.obj){var j=i.obj[e];if(j)if("function"==typeof j){if(j.prototype&&a instanceof j){f=i.prefix+e;break}}else j.___tried___||g.push({prefix:i.prefix+e+".",obj:j})}}h.forEach(function(a){delete a.___traversed___})}return a={type:f,events:d,functions:b,properties:c}}console.warn("Object was falsey.")}function copyObject(a,b){for(var c=[{dest:a,source:b}];c.length>0;){var d=c.pop();b=d.source,a=d.dest;for(var e in b)b.hasOwnProperty(e)&&("object"!=typeof b[e]?a[e]=b[e]:(a[e]||(a[e]={}),c.push({dest:a[e],source:b[e]})))}}function inherit(a,b){a.prototype=Object.create(b.prototype),a.prototype.constructor=a}function makeURL(a,b){var c=[];for(var d in b)b.hasOwnProperty(d)&&"function"!=typeof b[d]&&c.push(encodeURIComponent(d)+"="+encodeURIComponent(b[d]));return a+"?"+c.join("&")}function XHR(a,b,c,d,e,f,g){var h=new XMLHttpRequest;h.onerror=e,h.onabort=e,h.onprogress=d,h.onload=function(){h.status<400?f&&f(h.response):e&&e()},h.open(b,a),c&&(h.responseType=c),g?(h.setRequestHeader("Content-Type","application/json;charset=UTF-8"),h.send(JSON.stringify(g))):h.send()}function GET(a,b,c,d,e){b=b||"text";var f=e&&d&&c,g=e&&d||d&&c,h=e||d||c;XHR(a,"GET",b,f,g,h)}function POST(a,b,c,d,e,f){var g=f&&e&&d,h=f&&e||e&&d,i=f||e||d;XHR(a,"POST",c,g,h,i)}function getObject(a,b,c,d){var e=d&&c&&b,f=d&&c||c&&b,g=d||c||b;GET(a,"json",e,f,g)}function sendObject(a,b,c,d,e){POST(a,b,"json",e&&d&&c,e&&d||d&&c,e||d||c)}var Primrose={Audio:{},Input:{},Text:{CodePages:{},CommandPacks:{},Controls:{},Grammars:{},OperatingSystems:{},Renderers:{},Themes:{}}};Primrose.Application=function(){function a(b){this.formStateKey=b+" - formState",this.formState=getSetting(this.formStateKey),this.ctrls=findEverything(),this.fullscreenElement=document.documentElement,this.options=combineDefaults(options,a),this.users={},this.chatLines=[],this.userName=a.DEFAULT_USER_NAME,this.focused=!0,this.wasFocused=!1}return a.DEFAULT_USER_NAME="CURRENT_USER_OFFLINE",a.DEFAULTS={},a}(),Primrose.Button=function(){function a(b,c,d){this.options=combineDefaults(d,a),this.options.minDeflection=Math.cos(this.options.minDeflection),this.options.colorUnpressed=new THREE.Color(this.options.colorUnpressed),this.options.colorPressed=new THREE.Color(this.options.colorPressed),this.listeners={click:[]},this.base=b,this.position=this.base.position,this.rotation=this.base.rotation,this.name=c,this.toggle=!1,this.value=!1,this.pressed=!1,this.wasPressed=!1,this.direction=new THREE.Vector3,this.testPoint=new THREE.Vector3,this.raycaster=new THREE.Raycaster(this.testPoint,this.direction,0,1);for(var e=0;e<this.base.children.length&&!this.cap;++e){var f=this.base.children[e];if(f instanceof THREE.Object3D)for(var g=0;g<f.children.length&&!this.cap;++g){var h=f.children[g];if(h.material)for(var i=0;i<h.material.materials.length&&!this.cap;++i){var j=h.material.materials[i];"button"===j.name&&(this.cap=f,this.cap.name=c,this.rest=this.cap.position.clone())}}}if(!this.cap)throw new Error(fmt("Couldn't find a cap for the button [$1: $2].",this.base.name,c));var k=this.cap.children[0];k.material=k.material.clone(),this.color=k.material.materials[0].color}return a.DEFAULTS={maxThrow:.1,minDeflection:10,colorUnpressed:8323072,colorPressed:32512,toggle:!0,minDistance:2},a.prototype.addEventListener=function(a,b){this.listeners[a]&&this.listeners[a].push(b)},a.prototype.test=function(a,b){var c=null;this.wasPressed=this.pressed,this.pressed=!1,this.cap.position.y=this.rest.y;var d=this.direction.copy(this.cap.position).add(this.position).sub(b.position).length();if(d<=this.options.minDistance){this.testPoint.copy(b.position).sub(a).normalize(),this.direction.copy(this.cap.position).add(this.position).sub(a).normalize();var e=this.direction.dot(this.testPoint);if(this.options.minDeflection<e){this.testPoint.copy(b.position),this.testPoint.y+=this.options.minDistance,this.direction.set(0,-1,0),this.raycaster.ray.origin.copy(this.testPoint),this.raycaster.ray.direction.copy(this.direction),this.raycaster.far=2*this.options.minDistance;var f=this.raycaster.intersectObject(this.cap.children[0]);if(f.length>0){var g=f[0];if(this.testPoint.copy(g.face.normal),this.testPoint.applyEuler(this.base.rotation),e=this.testPoint.dot(b.velocity),0>e){var h=g.point.y,i=Math.max(0,Math.min(this.options.maxThrow,h-b.position.y)/this.options.maxThrow);this.touched=i>0,this.cap.position.y=this.rest.y-i*this.options.maxThrow,this.pressed=1===i,c=g.point}}}}var j=function(){for(var a=0;a<this.listeners.click.length;++a)this.listeners.click[a].call(this)}.bind(this);return this.pressed&&!this.wasPressed?this.toggle?this.value=!this.value:this.value=this.pressed:this.toggle||this.pressed||(this.value=!1),this.value?(j(),this.color.copy(this.options.colorPressed)):this.color.copy(this.options.colorUnpressed),c},a}(),Primrose.ButtonFactory=function(){function a(a,b){this.options=b,Primrose.ModelLoader.loadCollada(a,function(a){this.template=a.children[0]}.bind(this))}var b=0;return a.prototype.create=function(a){var c="button"+ ++b,d=this.template.clone(),e=new Primrose.Button(d,c,this.options);return e.toggle=a,e},a}(),Primrose.ModelLoader=function(){function a(b,c){b&&a.loadCollada(b,function(a){this.template=a,c&&c(a)}.bind(this))}var b=new THREE.ColladaLoader;return b.options.convertUpAxis=!0,a.setProperties=function(a){a.traverse(function(a){for(var b=0;b<a.children.length;++b){var c=a.children[b];if(c instanceof THREE.Mesh){var d=c.material.materials;if(d)for(var e=0;e<d.length;++e)a.isSolid=a.isSolid||"solid"===d[e].name,a.isButton=a.isButton||"button"===d[e].name}}})},a.loadCollada=function(c,d){b.load(c,function(b){a.setProperties(b.scene),d&&d(b.scene)})},a.loadScene=function(b,c){a.loadCollada(b,function(a){a.buttons=[],a.traverse(function(b){b.isButton&&a.buttons.push(new Primrose.Button(b.parent,b.name)),b.name&&(a[b.name]=b)}),c&&c(a)})},a.prototype.clone=function(){var b=this.template.clone();return b.traverse(function(a){a instanceof THREE.SkinnedMesh&&(b.animation=new THREE.Animation(a,a.geometry.animation),!this.template.originalAnimationData&&b.animation.data&&(this.template.originalAnimationData=b.animation.data),b.animation.data||(b.animation.data=this.template.originalAnimationData))}.bind(this)),a.setProperties(b),b},a}(),Primrose.NetworkedInput=function(){function a(b,c,d,e){function f(b){for(var c=0;c<a.META_KEYS.length;++c){var d=a.META_KEYS[c];this.inputState[d]=b[d+"Key"]}}this.name=b,this.commandState={},this.commands=[],this.socket=d,this.oscope=e,this.enabled=!0,this.paused=!1,this.ready=!0,this.transmitting=!0,this.receiving=!0,this.socketReady=!1,this.inPhysicalUse=!0,this.inputState={},this.lastState="",window.addEventListener("keydown",f.bind(this),!1),window.addEventListener("keyup",f.bind(this),!1),d&&(d.on("open",function(){this.socketReady=!0,this.inPhysicalUse=!this.receiving}.bind(this)),d.on(b,function(a){this.receiving&&(this.inPhysicalUse=!1,this.decodeStateSnapshot(a),this.fireCommands())}.bind(this)),d.on("close",function(){this.inPhysicalUse=!0,this.socketReady=!1}.bind(this)));for(var g=0;g<c.length;++g)this.addCommand(c[g]);for(g=0;g<a.META_KEYS.length;++g)this.inputState[a.META_KEYS[g]]=!1}return a.META_KEYS=["ctrl","shift","alt","meta"],a.META_KEYS.forEach(function(b,c){a[b.toLocaleUpperCase()]=c+1}),a.prototype.addCommand=function(a){a=this.cloneCommand(a),a.repetitions=a.repetitions||1,this.commands.push(a),this.commandState[a.name]={value:null,pressed:!1,wasPressed:!1,fireAgain:!1,lt:0,ct:0,repeatCount:0}},a.prototype.cloneCommand=function(a){throw new Error("cloneCommand function must be defined in subclass")},a.prototype.update=function(b){if(this.ready&&this.enabled&&this.inPhysicalUse&&!this.paused){for(var c=0;c<this.commands.length;++c){var d=this.commands[c],e=this.commandState[d.name];if(e.wasPressed=e.pressed,e.pressed=!1,!d.disabled){var f=!0;if(d.metaKeys)for(var g=0;g<d.metaKeys.length&&f;++g){var h=d.metaKeys[g];f=f&&(this.inputState[a.META_KEYS[h.index]]&&h.toggle||!this.inputState[a.META_KEYS[h.index]]&&!h.toggle)}this.evalCommand(d,e,f,b),e.lt+=b,e.lt>=d.dt&&e.repeatCount++,e.fireAgain=e.pressed&&e.lt>=d.dt&&e.repeatCount>=d.repetitions,e.fireAgain&&(e.lt=0,e.repeatCount=0)}}if(this.socketReady&&this.transmitting){var i=this.makeStateSnapshot();i!==this.lastState&&(this.socket.emit(this.name,i),this.lastState=i)}this.fireCommands()}},a.prototype.fireCommands=function(){if(this.ready&&!this.paused)for(var a=0;a<this.commands.length;++a){var b=this.commands[a],c=this.commandState[b.name];c.fireAgain&&b.commandDown&&b.commandDown(),!c.pressed&&c.wasPressed&&b.commandUp&&b.commandUp()}},a.prototype.makeStateSnapshot=function(){for(var a="",b=0;b<this.commands.length;++b){var c=this.commands[b],d=this.commandState[c.name];d&&(a+=fmt("$1:$2",b<<2|(d.pressed?1:0)|(d.fireAgain?2:0),d.value),b<this.commands.length-1&&(a+="|"))}return a},a.prototype.decodeStateSnapshot=function(a){for(var b,c=0;c<this.commands.length;++c){b=this.commands[c];var d=this.commandState[b.name];d.wasPressed=d.pressed}for(var e=a.split("|"),f=0;f<e.length;++f){var g=e[f],h=g.split(":"),i=parseInt(h[0],10),j=0!==(1&i),k=0!==(2&l);i>>=2,b=this.commands[i];var l=parseInt(h[2],10);this.commandState[b.name]={value:parseFloat(h[1]),pressed:j,fireAgain:k}}},a.prototype.setProperty=function(a,b,c){for(var d=0;d<this.commands.length;++d)if(this.commands[d].name===b){this.commands[d][a]=c;break}},a.prototype.addToArray=function(a,b,c){for(var d=0;d<this.commands.length;++d)if(this.commands[d].name===b){this.commands[d][a].push(c);break}},a.prototype.removeFromArray=function(a,b,c){for(var d=-1,e=0;e<this.commands.length;++e){var f=this.commands[e],g=f[a];if(d=g.indexOf(c),f.name===b&&d>-1){g.splice(d,1);break}}},a.prototype.invertInArray=function(a,b,c){for(var d=-1,e=0;e<this.commands.length;++e){var f=this.commands[e],g=f[a];if(d=g.indexOf(c),f.name===b&&d>-1){g[d]*=-1;break}}},a.prototype.pause=function(a){this.paused=a},a.prototype.isPaused=function(){return this.paused},a.prototype.enable=function(a,b){(void 0===b||null===b)&&(b=a,a=null),a?this.setProperty("disabled",a,!b):this.enabled=b},a.prototype.isEnabled=function(a){if(a){for(var b=0;b<this.commands.length;++b)if(this.commands[b].name===a)return!this.commands[b].disabled;return!1}return this.enabled},a.prototype.transmit=function(a){this.transmitting=a},a.prototype.isTransmitting=function(){return this.transmitting},a.prototype.receive=function(a){this.receiving=a},a.prototype.isReceiving=function(){return this.receiving},a}(),Primrose.VRApplication=function(){function a(b,c,d,e,f,g,h,i,j,k){Primrose.Application.call(this,b),this.options=combineDefaults(k,a),this.listeners={ready:[],update:[]},this.glove=new HapticGlove,this.avatarHeight=g,this.walkSpeed=h,this.cameraMount=new THREE.Object3D,this.oculusCorrector=new THREE.Object3D,this.onground=!1,this.lt=0,this.frame=0,this.enableMousePitch=!0,this.currentUser=null,this.mainScene=null,this.speech=new Primrose.SpeechInput("speech",[{name:"options",keywords:["options"],commandUp:this.toggleOptions.bind(this)},{name:"chat",preamble:!0,keywords:["message"],commandUp:function(){this.showTyping(!0,!0,this.speech.getValue("chat"))}.bind(this)}],this.proxy),this.keyboard=new Primrose.KeyboardInput("keyboard",window,[{name:"strafeLeft",buttons:[-Primrose.KeyboardInput.A,-Primrose.KeyboardInput.LEFTARROW]},{name:"strafeRight",buttons:[Primrose.KeyboardInput.D,Primrose.KeyboardInput.RIGHT]},{name:"driveForward",buttons:[-Primrose.KeyboardInput.W,-Primrose.KeyboardInput.UPARROW]},{name:"driveBack",buttons:[Primrose.KeyboardInput.S,Primrose.KeyboardInput.DOWNARROW]},{name:"jump",buttons:[Primrose.KeyboardInput.SPACEBAR],commandDown:this.jump.bind(this),dt:.5},{name:"camera",buttons:[Primrose.KeyboardInput.C]},{name:"debug",buttons:[Primrose.KeyboardInput.X]},{name:"resetPosition",buttons:[Primrose.KeyboardInput.P],commandUp:this.resetPosition.bind(this)},{name:"chat",preamble:!0,buttons:[Primrose.KeyboardInput.T],commandUp:this.showTyping.bind(this,!0)}],this.proxy),this.keyboard.pause(!0),this.mouse=new Primrose.MouseInput("mouse",this.fullscreenElement,[{name:"dx",axes:[-Primrose.MouseInput.X],delta:!0,scale:.5},{name:"heading",commands:["dx"],metaKeys:[-Primrose.NetworkedInput.SHIFT],integrate:!0},{name:"pointerHeading",commands:["dx"],metaKeys:[Primrose.NetworkedInput.SHIFT],integrate:!0,min:.2*-Math.PI,max:.2*Math.PI},{name:"dy",axes:[-Primrose.MouseInput.Y],delta:!0,scale:.5},{name:"pitch",commands:["dy"],metaKeys:[-Primrose.NetworkedInput.SHIFT],integrate:!0,min:.5*-Math.PI,max:.5*Math.PI},{name:"pointerPitch",commands:["dy"],metaKeys:[Primrose.NetworkedInput.SHIFT],integrate:!0,min:.125*-Math.PI,max:.125*Math.PI},{name:"dz",axes:[Primrose.MouseInput.Z],delta:!0},{name:"pointerDistance",commands:["dz"],integrate:!0,scale:.1,min:0,max:10},{name:"pointerPress",buttons:[1],integrate:!0,scale:100,offset:-50,min:0,max:5}],this.proxy),this.touch=new Primrose.TouchInput("touch",this.fullscreenElement,null,[{name:"heading",axes:[Primrose.TouchInput.DX0],integrate:!0},{name:"drive",axes:[-Primrose.TouchInput.DY0]}],this.proxy),this.head=new Primrose.MotionInput("head",[{name:"pitch",axes:[Primrose.MotionInput.PITCH]},{name:"heading",axes:[-Primrose.MotionInput.HEADING]},{name:"roll",axes:[-Primrose.MotionInput.ROLL]}],this.proxy),this.vr=new Primrose.VRInput("hmd",[{name:"pitch",axes:[Primrose.VRInput.RX]},{name:"heading",axes:[Primrose.VRInput.RY]},{name:"roll",axes:[Primrose.VRInput.RZ]},{name:"homogeneous",axes:[Primrose.VRInput.RW]}],this.ctrls.hmdListing,this.formState&&this.formState.hmdListing||""),this.ctrls.hmdListing.addEventListener("change",this.changeHMD.bind(this)),this.gamepad=new Primrose.GamepadInput("gamepad",[{name:"strafe",axes:[Primrose.GamepadInput.LSX]},{name:"drive",axes:[Primrose.GamepadInput.LSY]},{name:"heading",axes:[-Primrose.GamepadInput.RSX],integrate:!0},{name:"pitch",axes:[Primrose.GamepadInput.RSY],integrate:!0},{name:"options",buttons:[9],commandUp:this.toggleOptions.bind(this)}],this.proxy),this.gamepad.addEventListener("gamepadconnected",this.connectGamepad.bind(this),!1),this.location=new Primrose.LocationInput("location",[],this.proxy),this.passthrough=new Primrose.CameraInput(this.ctrls.cameraListing,this.formState&&this.formState.cameraListing||"",1,0,0,-1),this.ctrls.cameraListing.addEventListener("change",function(){this.passthrough.connect(this.ctrls.cameraListing.value)}.bind(this));var l=[];l.push({name:"HAND0X",axes:[Primrose.LeapMotionInput.HAND0X],scale:-.015}),l.push({name:"HAND0Y",axes:[Primrose.LeapMotionInput.HAND0Y],scale:.015,offset:-4}),l.push({name:"HAND0Z",axes:[Primrose.LeapMotionInput.HAND0Z],scale:-.015,offset:3}),this.leap=new Primrose.LeapMotionInput("leap",l,this.proxy);var m="Smartphone - no HMD";this.stateList=new StateList(this.ctrls.deviceTypes,this.ctrls,[{name:"-- select device type --"},{name:"PC",values:{speechEnable:{checked:!1},speechTransmit:{checked:!1},speechReceive:{checked:!1},keyboardEnable:{checked:!0},keyboardTransmit:{checked:!0},keyboardReceive:{checked:!1},mouseEnable:{checked:!0},mouseTransmit:{checked:!0},mouseReceive:{checked:!1},gamepadEnable:{checked:!0},gamepadTransmit:{checked:!0},gamepadReceive:{checked:!1},leapEnable:{checked:!0},leapTransmit:{checked:!0},leapReceive:{checked:!1},touchEnable:{checked:!1},touchTransmit:{checked:!1},touchReceive:{checked:!0},headEnable:{checked:!1},headTransmit:{checked:!1},headReceive:{checked:!0},locationEnable:{checked:!1},locationTransmit:{checked:!1},locationReceive:{checked:!0},renderingStyle:{value:"regular"},defaultDisplay:{checked:!0}}},{name:"Smartphone HMD",values:{speechEnable:{checked:!1},speechTransmit:{checked:!1},speechReceive:{checked:!0},keyboardEnable:{checked:!1},keyboardTransmit:{checked:!1},keyboardReceive:{checked:!0},mouseEnable:{checked:!1},mouseTransmit:{checked:!1},mouseReceive:{checked:!0},gamepadEnable:{checked:!1},gamepadTransmit:{checked:!1},gamepadReceive:{checked:!0},leapEnable:{checked:!1},leapTransmit:{checked:!1},leapReceive:{checked:!0},touchEnable:{checked:!1},touchTransmit:{checked:!1},touchReceive:{checked:!0},headEnable:{checked:!0},headTransmit:{checked:!0},headReceive:{checked:!1},locationEnable:{checked:!0},locationTransmit:{checked:!0},locationReceive:{checked:!1},renderingStyle:{value:"cardboard"},defaultDisplay:{checked:!1}}},{name:m,values:{speechEnable:{checked:!1},speechTransmit:{checked:!1},speechReceive:{checked:!1},keyboardEnable:{checked:!1},keyboardTransmit:{checked:!1},keyboardReceive:{checked:!1},mouseEnable:{checked:!1},mouseTransmit:{checked:!1},mouseReceive:{checked:!1},gamepadEnable:{checked:!1},gamepadTransmit:{checked:!1},gamepadReceive:{checked:!1},leapEnable:{checked:!1},leapTransmit:{checked:!1},leapReceive:{checked:!1},touchEnable:{checked:!0},touchTransmit:{checked:!0},touchReceive:{checked:!1},headEnable:{checked:!0},headTransmit:{checked:!0},headReceive:{checked:!1},locationEnable:{checked:!0},locationTransmit:{checked:!0},locationReceive:{checked:!1},renderingStyle:{value:"regular"},defaultDisplay:{checked:!0}}}]),writeForm(this.ctrls,this.formState),window.addEventListener("beforeunload",function(){var a=readForm(this.ctrls);setSetting(this.formStateKey,a),this.speech.enable(!1)}.bind(this),!1),this.scene=new THREE.Scene,this.renderer=new THREE.WebGLRenderer({antialias:!0,canvas:this.ctrls.frontBuffer}),this.renderer.setClearColor(this.options.backgroundColor),this.testPoint=new THREE.Vector3,this.raycaster=new THREE.Raycaster(new THREE.Vector3,new THREE.Vector3,0,7),this.direction=new THREE.Vector3,this.buttonFactory=new Primrose.ButtonFactory(d,e),this.avatar=new Primrose.ModelLoader(f,function(){this.addUser({x:0,y:0,z:0,dx:0,dy:0,dz:0,heading:0,dHeading:0,userName:this.userName})}.bind(this)),this.hand=new THREE.Mesh(new THREE.SphereGeometry(.1,4,4),new THREE.MeshPhongMaterial({color:16776960,emissive:8355584})),this.hand.name="HAND0",this.hand.add(new THREE.PointLight(16776960,1,7)),this.hand.velocity=new THREE.Vector3,this.scene.add(this.hand),Primrose.ModelLoader.loadScene(c,function(a){this.mainScene=a,this.scene.add(a);var b=this.mainScene.Camera.children[0];this.scene.remove(b),this.camera=new THREE.PerspectiveCamera(b.fov,b.aspect,b.near,this.options.drawDistance)}.bind(this)),this.audio=new Audio3D,this.audio.loadBuffer(i,null,function(a){this.clickSound=a}.bind(this)),this.audio.load3DSound(j,!0,0,0,0,null,function(a){a.volume.gain.value=.07,a.source.start(0)}.bind(this)),"none"===this.ctrls.appCacheReload.style.display&&navigator.onLine&&(this.ctrls.connectButton.addEventListener("click",this.login.bind(this),!1),this.socket=io.connect(document.location.hostname,{reconnect:!0,"reconnection delay":1e3,"max reconnection attempts":60}),this.socket.on("connect",this.connectToServer.bind(this)),this.socket.on("typing",this.showTyping.bind(this,!1,!1)),this.socket.on("chat",this.showChat.bind(this)),this.socket.on("userJoin",this.addUser.bind(this)),this.socket.on("userState",this.updateUserState.bind(this,!1)),this.socket.on("userLeft",this.loseUser.bind(this)),this.socket.on("loginFailed",this.announceFailure.bind(this)),this.socket.on("userList",this.listUsers.bind(this)),this.socket.on("disconnect",this.disconnectFromServer.bind(this)),this.socket.on("handshakeFailed",console.error.bind(console,"Failed to connect to websocket server. Available socket controllers are:")),this.socket.on("handshakeComplete",this.completeHandshake.bind(this)),this.proxy=new WebRTCSocket(this.socket,this.ctrls.defaultDisplay.checked)),this.setupModuleEvents(this.leap,"leap"),this.setupModuleEvents(this.gamepad,"gamepad"),this.setupModuleEvents(this.touch,"touch"),this.setupModuleEvents(this.head,"head"),this.setupModuleEvents(this.speech,"speech"),this.setupModuleEvents(this.keyboard,"keyboard"),this.setupModuleEvents(this.mouse,"mouse"),window.addEventListener("touchend",this.showOnscreenControls.bind(this),!1),window.addEventListener("mousemove",function(){Primrose.MouseInput.isPointerLocked()||this.showOnscreenControls()}.bind(this),!1),window.addEventListener("keyup",function(a){a.keyCode===Primrose.KeyboardInput.GRAVEACCENT&&this.toggleOptions()}.bind(this),!1),window.addEventListener("resize",function(){this.setSize(window.innerWidth,window.innerHeight)}.bind(this),!1),window.addEventListener("focus",function(){this.focused=!0}.bind(this),!1),window.addEventListener("blur",function(){this.focused=!1}.bind(this),!1),document.addEventListener("focus",function(){this.focused=!0}.bind(this),!1),document.addEventListener("blur",function(){this.focused=!1}.bind(this),!1),this.fullScreen=function(){this.fullscreenElement.webkitRequestFullscreen?this.fullscreenElement.webkitRequestFullscreen({vrDisplay:this.vr.display}):this.fullscreenElement.mozRequestFullScreen&&this.fullscreenElement.mozRequestFullScreen({vrDisplay:this.vr.display})},this.ctrls.fullScreenButton.addEventListener("click",function(){this.fullScreen(),this.mouse.requestPointerLock()}.bind(this),!1),this.ctrls.menuButton.addEventListener("click",this.showOptions.bind(this),!1),this.ctrls.renderingStyle.addEventListener("change",function(){this.chooseRenderingEffect(this.ctrls.renderingStyle.value)}.bind(this),!1),this.ctrls.textEntry.addEventListener("change",function(){this.showTyping(!0,!0,this.ctrls.textEntry.value),this.ctrls.textEntry.value=""}.bind(this),!1);for(var n=document.getElementsByClassName("closeSectionButton"),o=0;o<n.length;++o)n[o].addEventListener("click",this.hideOptions.bind(this),!1)}inherit(a,Primrose.Application),a.DEFAULTS={gravity:9.8,backgroundColor:0,drawDistance:500,chatTextSize:.25,dtNetworkUpdate:.125},a.CONNECTED_TEXT="Disconnect",a.DISCONNECTED_TEXT="Connect",a.RIGHT=new THREE.Vector3(-1,0,0),a.prototype.makeButton=function(a){var b=this.buttonFactory.create(a);return this.mainScene.buttons.push(b),this.mainScene[b.name]=b,this.scene.add(b.base),b},a.prototype.addEventListener=function(a,b){this.listeners[a]&&this.listeners[a].push(b)},a.prototype.fire=function(a,b,c,d,e){for(var f=0;f<this.listeners[a].length;++f)this.listeners[a][f](b,c,d,e)},a.prototype.setupModuleEvents=function(a,b){var c=this.ctrls[b+"Enable"],d=this.ctrls[b+"Transmit"],e=this.ctrls[b+"Receive"];z=this.ctrls[b+"Zero"],c.addEventListener("change",function(){a.enable(c.checked),d.disabled=!c.checked,d.checked&&d.disabled&&(d.checked=!1)}),d.addEventListener("change",function(){a.transmit(d.checked)}),e.addEventListener("change",function(){a.receive(e.checked)}),z&&a.zeroAxes&&z.addEventListener("click",a.zeroAxes.bind(a),!1),a.enable(c.checked),a.transmit(d.checked),a.receive(e.checked),d.disabled=!c.checked,d.checked&&d.disabled&&(d.checked=!1)},a.prototype.showOptions=function(){this.ctrls.options.style.display="",this.keyboard.pause(!0),this.mouse.exitPointerLock()},a.prototype.hideOptions=function(){this.ctrls.options.style.display="none",this.fullScreen(),this.keyboard.pause(!1),this.showOnscreenControls(),this.mouse.requestPointerLock()},a.prototype.toggleOptions=function(){var a=""!==this.ctrls.options.style.display;a?this.showOptions():this.hideOptions()},a.prototype.hideOnscreenControls=function(){this.ctrls.onScreenControls.style.display="none",this.hideControlsTimeout=null},a.prototype.showOnscreenControls=function(){this.ctrls.onScreenControls.style.display="",this.hideControlsTimeout&&clearTimeout(this.hideControlsTimeout),this.hideControlsTimeout=setTimeout(this.hideOnscreenControls.bind(this),3e3)},a.prototype.chooseRenderingEffect=function(a){if(this.oculusCorrector.rotation.set(0,0,0,"XYZ"),this.lastRenderingType!==a){switch(a){case"anaglyph":this.effect=new THREE.AnaglyphEffect(this.renderer,5,window.innerWidth,window.innerHeight),this.enableMousePitch=!0;break;case"cardboard":this.effect=new THREE.OculusRiftEffect(this.renderer,{worldFactor:1,HMD:{hResolution:screen.availWidth,vResolution:screen.availHeight,hScreenSize:.126,vScreenSize:.075,interpupillaryDistance:.064,lensSeparationDistance:.064,eyeToScreenDistance:.051,distortionK:[1,.22,.06,0],chromaAbParameter:[.996,-.004,1.014,0]}}),this.enableMousePitch=!1;break;case"vr":this.effect=new THREE.VREffect(this.renderer,this.vr.display),this.enableMousePitch=!1,this.oculusCorrector.rotation.set(0,-Math.PI/3,0,"XYZ");break;default:this.effect=null,a="regular",this.enableMousePitch=!0}this.ctrls.renderingStyle.value!==a&&(this.ctrls.renderingStyle.value=a),"cardboard"!==this.lastRenderingType&&"vr"!==this.lastRenderingType||"anaglyph"!==a&&"regular"!==a||(alert("The page must reload to enable the new settings."),document.location.reload()),this.lastRenderingType=a}},a.prototype.setSize=function(a,b){this.camera&&(this.camera.aspect=a/b,this.camera.updateProjectionMatrix()),this.chooseRenderingEffect(this.ctrls.renderingStyle.value),this.renderer.setSize(a,b),this.effect&&this.effect.setSize(a,b)},a.prototype.login=function(){if(this.socket&&this.socket.connected&&this.ctrls.connectButton.classList.contains("primary"))if(this.ctrls.connectButton.innerHTML===a.DISCONNECTED_TEXT){this.userName=this.ctrls.userNameField.value;var b=this.ctrls.passwordField.value;

this.userName&&b?(this.socket.once("salt",function(a){var c=CryptoJS.SHA512(a+b).toString();this.socket.emit("hash",c)}.bind(this)),this.ctrls.connectButton.innerHTML="Connecting...",this.ctrls.connectButton.className="secondary button",this.socket.emit("login",{userName:this.userName,email:this.ctrls.emailField.value})):this.showMessage("Please complete the form.")}else this.ctrls.connectButton.innerHTML===a.CONNECTED_TEXT&&(this.socket.emit("logout"),this.ctrls.connectButton.innerHTML=a.DISCONNECTED_TEXT);else this.showMessage("No socket available.")},a.prototype.addUser=function(a,b){var c=null;if(this.users[a.userName])c=this.users[a.userName];else if(this.userName===Primrose.Application.DEFAULT_USER_NAME||a.userName!==this.userName){c=new THREE.Object3D;var d=this.avatar.clone();c.animation=d.animation,d.position.z=1.33,c.add(d),c.nameObj=new Primrose.Text.PlainText(a.userName,.5,"white","transparent",0,this.avatarHeight+2.5,0,"center"),c.add(c.nameObj),c.velocity=new THREE.Vector3,a.userName===Primrose.Application.DEFAULT_USER_NAME?this.currentUser=c:this.showMessage("$1 has joined",a.userName),this.scene.add(c)}else delete this.users[Primrose.Application.DEFAULT_USER_NAME],c=this.currentUser;this.users[a.userName]=c,this.updateUserState(!0,a),b||this.makeChatList()},a.prototype.connectToServer=function(){this.socket.emit("handshake","demo"),this.ctrls.connectButton.innerHTML=a.DISCONNECTED_TEXT,this.ctrls.connectButton.className="primary button"},a.prototype.disconnectFromServer=function(a){this.ctrls.connectButton.className="secondary button",this.ctrls.connectButton.innerHTML=fmt("Disconnected: $1",a),this.showMessage(a)},a.prototype.completeHandshake=function(a){"demo"===a&&this.ctrls.autoLogin.checked&&this.ctrls.connectButton.click()},a.prototype.announceFailure=function(){this.ctrls.connectButton.innerHTML="Login failed. Try again.",this.ctrls.connectButton.className="primary button",this.showMessage("Incorrect user name or password!")},a.prototype.listUsers=function(b){this.ctrls.connectButton.innerHTML=a.CONNECTED_TEXT,this.ctrls.connectButton.className="primary button",this.proxy.connect(this.userName),b.sort(function(a){return a.userName===this.userName?-1:1});for(var c=0;c<b.length;++c)this.addUser(b[c],!0);this.makeChatList()},a.prototype.loseUser=function(a){this.users[a]&&(this.showMessage("$1 has disconnected",a),this.scene.remove(this.users[a]),delete this.users[a],this.makeChatList())},a.prototype.updateUserState=function(a,b){var c=c||this.users[b.userName];c?a?(c.position.set(b.x,Math.max(0,b.y),b.z),c.lastHeading=c.heading=b.heading,c.dHeading=0):(c.velocity.set((b.x+b.dx*this.options.dtNetworkUpdate-c.position.x)/this.options.dtNetworkUpdate,(b.y+b.dy*this.options.dtNetworkUpdate-c.position.y)/this.options.dtNetworkUpdate,(b.z+b.dz*this.options.dtNetworkUpdate-c.position.z)/this.options.dtNetworkUpdate),c.dHeading=(b.heading+b.dHeading*this.options.dtNetworkUpdate-c.heading)/this.options.dtNetworkUpdate):setTimeout(this.addUser.bind(this,b),1)},a.prototype.makeChatList=function(){var a=[];for(var b in this.users)a.push(b);a.sort(),this.ctrls.userList.innerHTML="";for(var c=0;c<a.length;++c)if(a[c]!==Primrose.Application.DEFAULT_USER_NAME){var d=document.createElement("div");d.appendChild(document.createTextNode(a[c])),this.ctrls.userList.appendChild(d)}},a.prototype.connectGamepad=function(a){!this.gamepad.isGamepadSet()&&confirm(fmt('Would you like to use this gamepad? "$1"',a))&&this.gamepad.setGamepad(a)},a.prototype.changeHMD=function(){this.vr.connect(this.ctrls.hmdListing.value),this.ctrls.hmdListing.value&&("vr"!==this.ctrls.renderingStyle.value?this.chooseRenderingEffect("vr"):this.effect.setHMD(this.vr.display))},a.prototype.resetPosition=function(){this.currentUser.position.set(0,2,0),this.currentUser.velocity.set(0,0,0)},a.prototype.jump=function(){this.onground&&(this.currentUser.velocity.y+=10,this.onground=!1)},a.prototype.showMessage=function(){var a=fmt.apply(window,map(arguments,function(a){return a?a.toString():""}));this.currentUser?this.showChat(a):alert(a)},a.prototype.showTyping=function(a,b,c){if(this.currentUser)if(this.lastText&&(this.camera.remove(this.lastText),this.lastText=null),b)this.socket&&this.socket.emit("chat",c);else if(a&&this.socket&&this.socket.emit("typing",c),c){var d=this.putUserText(c,.125,0,0,-4,"right");this.lastText=d,this.clickSound&&this.audio.playBufferImmediate(this.clickSound,.5)}},a.prototype.shiftLines=function(){for(var a=0;a<this.chatLines.length;++a)this.chatLines[a].position.y=(this.chatLines.length-a)*this.options.chatTextSize*1.333-1},a.prototype.putUserText=function(a,b,c,d,e,f){var g=new Primrose.Text.PlainText(a,b,"white","transparent",c,d,e,f);return this.camera.add(g),g},a.prototype.showChat=function(a){if(a="string"==typeof a?a:fmt("[$1]: $2",a.userName,a.text),this.currentUser){this.userName===a.userName&&this.showTyping(!0,!1,null);var b=this.putUserText(a,this.options.chatTextSize,0,0,-5,"left");this.chatLines.push(b),this.shiftLines(),setTimeout(function(){this.camera.remove(b),this.chatLines.shift(),this.shiftLines()}.bind(this),3e3)}var c=document.createElement("div");c.appendChild(document.createTextNode(a)),this.ctrls.chatLog.appendChild(c),this.ctrls.chatLog.scrollTop=this.ctrls.chatLog.scrollHeight,!this.focused&&window.Notification&&this.makeNotification(a)},a.prototype.makeNotification=function(a){return"granted"===Notification.permission?(this.lastNote&&(a=this.lastNote.body+"\n"+a,this.lastNote.close(),this.lastNote=null),this.lastNote=new Notification(document.title,{icon:"../ico/chat.png",body:a}),this.lastNote.addEventListener("close",function(){this.lastNote=null}.bind(this),!1),this.lastNote):void 0},a.prototype.start=function(){var a=function(b){this.lt=b,this.camera&&this.mainScene&&this.currentUser&&this.buttonFactory.template?(this.setSize(window.innerWidth,window.innerHeight),this.cameraMount.position.y=this.avatarHeight,this.currentUser.add(this.cameraMount),this.cameraMount.add(this.oculusCorrector),this.oculusCorrector.add(this.camera),this.camera.add(this.passthrough.mesh),this.leap.start(),this.animate=this.animate.bind(this),this.fire("ready"),requestAnimationFrame(this.animate)):requestAnimationFrame(a)}.bind(this);requestAnimationFrame(a)};var b=null;return a.prototype.animate=function(c){requestAnimationFrame(this.animate);var d=.001*(c-this.lt);if(this.lt=c,this.wasFocused&&this.focused){THREE.AnimationHandler.update(d),this.speech.update(d),this.keyboard.update(d),this.mouse.update(d),this.head.update(d),this.vr.update(d),this.touch.update(d),this.gamepad.update(d),this.leap.update(d);var e=this.head.getValue("roll"),f=this.head.getValue("pitch");this.enableMousePitch&&(f+=this.gamepad.getValue("pitch")+this.mouse.getValue("pitch"));var g=this.head.getValue("heading")+this.gamepad.getValue("heading")+this.touch.getValue("heading")+this.mouse.getValue("heading"),h=f+this.leap.getValue("HAND0Y")+this.mouse.getValue("pointerPitch"),i=g+this.leap.getValue("HAND0X")+this.mouse.getValue("pointerHeading"),j=(this.leap.getValue("HAND0Z")+this.mouse.getValue("pointerDistance")+this.mouse.getValue("pointerPress")+2)/Math.cos(h),k=0,l=0;if(this.passthrough.mesh.visible=this.keyboard.isDown("camera"),this.passthrough.mesh.visible&&this.passthrough.update(),b&&(this.camera.remove(b),b=null),this.keyboard.isDown("debug")&&(b=this.putUserText(fmt("[nothing]"),this.options.chatTextSize,0,0,j,"left")),this.ctrls.defaultDisplay.checked){this.currentUser.dHeading=(g-this.currentUser.heading)/d,k=this.keyboard.getValue("strafeRight")+this.keyboard.getValue("strafeLeft")+this.gamepad.getValue("strafe"),l=this.keyboard.getValue("driveBack")+this.keyboard.getValue("driveForward")+this.gamepad.getValue("drive")+this.touch.getValue("drive"),(this.onground||this.currentUser.position.y<-.5)&&(this.autoWalking&&(k=0,l=-.5),o=k||l?this.walkSpeed*Math.min(1,1/Math.sqrt(l*l+k*k)):0,k*=o,l*=o,o=k*Math.cos(g)+l*Math.sin(g),l=l*Math.cos(g)-k*Math.sin(g),k=o,this.currentUser.velocity.x=.9*this.currentUser.velocity.x+.1*k,this.currentUser.velocity.z=.9*this.currentUser.velocity.z+.1*l),this.currentUser.velocity.y-=d*this.options.gravity;var m,n,o=this.currentUser.velocity.length()*d;this.direction.copy(this.currentUser.velocity),this.direction.normalize(),this.testPoint.copy(this.currentUser.position),this.testPoint.y+=this.avatarHeight/2,this.raycaster.ray.origin.copy(this.testPoint),this.raycaster.ray.direction.copy(this.direction),this.raycaster.far=o;var p=this.raycaster.intersectObject(this.scene,!0);for(n=0;n<p.length;++n)if(m=p[n],m.object.parent.isSolid){this.testPoint.copy(m.face.normal),this.testPoint.applyEuler(m.object.parent.rotation),this.currentUser.velocity.reflect(this.testPoint);var q=this.testPoint.dot(this.camera.up);q>.75&&(this.currentUser.position.y=m.point.y,this.currentUser.velocity.y=0,this.onground=!0)}this.testPoint.copy(this.currentUser.velocity).multiplyScalar(d).add(this.currentUser.position);var r=3;for(this.testPoint.y+=r,this.direction.set(0,-1,0),this.raycaster.ray.origin.copy(this.testPoint),this.raycaster.ray.direction.copy(this.direction),this.raycaster.far=2*r,p=this.raycaster.intersectObject(this.scene,!0),n=0;n<p.length;++n)m=p[n],m.object.parent.isSolid&&m.distance<r&&(this.testPoint.copy(m.face.normal),this.testPoint.applyEuler(m.object.parent.rotation),this.currentUser.position.y=m.point.y,this.currentUser.velocity.y=0,this.onground=!0);if(this.frame+=d,this.frame>this.options.dtNetworkUpdate){this.frame-=this.options.dtNetworkUpdate;var s={x:this.currentUser.position.x,y:this.currentUser.position.y,z:this.currentUser.position.z,dx:this.currentUser.velocity.x,dy:this.currentUser.velocity.y,dz:this.currentUser.velocity.z,heading:this.currentUser.heading,dHeading:(this.currentUser.heading-this.currentUser.lastHeading)/this.options.dtNetworkUpdate,isRunning:this.currentUser.velocity.length()>0};this.currentUser.lastHeading=this.currentUser.heading,this.socket&&this.socket.emit("userState",s)}}for(var t in this.users){var u=this.users[t];this.testPoint.copy(u.velocity),this.testPoint.multiplyScalar(d),u.position.add(this.testPoint),u.heading+=u.dHeading*d,u.rotation.set(0,u.heading,0,"XYZ"),u!==this.currentUser&&u.nameObj.rotation.set(0,this.currentUser.heading-u.heading,0,"XYZ"),!u.animation.isPlaying&&u.velocity.length()>=2?u.animation.play():u.animation.isPlaying&&u.velocity.length()<2&&u.animation.stop()}this.direction.set(0,0,-j).applyAxisAngle(a.RIGHT,-h).applyAxisAngle(this.camera.up,i),this.testPoint.copy(this.hand.position),this.hand.position.copy(this.currentUser.position).add(this.direction),this.hand.velocity.copy(this.hand.position).sub(this.testPoint);for(var v=0;v<this.mainScene.buttons.length;++v){var w=this.mainScene.buttons[v],x=w.test(this.currentUser.position,this.hand);x?this.hand.position.copy(x):w.test(this.currentUser.position,this.currentUser)}this.fire("update",d),this.testPoint.copy(this.currentUser.position),this.testPoint.divideScalar(10),this.audio.setPosition(this.testPoint.x,this.testPoint.y,this.testPoint.z),this.audio.setVelocity(this.currentUser.velocity.x,this.currentUser.velocity.y,this.currentUser.velocity.z),this.testPoint.normalize(),this.audio.setOrientation(this.testPoint.x,this.testPoint.y,this.testPoint.z,0,1,0),this.cameraMount.rotation.set(f,0,e,"YZX"),this.camera.quaternion.set(this.vr.getValue("pitch"),this.vr.getValue("heading"),this.vr.getValue("roll"),this.vr.getValue("homogeneous")),this.effect?this.effect.render(this.scene,this.camera):this.renderer.render(this.scene,this.camera)}this.wasFocused=this.focused},a}(),Primrose.WebRTCSocket=function(){function a(a,b){function c(a,b,c){c.fromIndex=a,c.toIndex=b,g[b].setLocalDescription(c,function(){f.emit(c.type,c)})}function d(a,b,c){if(b.fromIndex===a){var d=new RTCSessionDescription(b);g[a].setRemoteDescription(d,c)}}function e(a){function b(){h[a]=null,g[a]=null;var b=0===h.filter(function(a){return a}).length;if(b&&i.close)for(var c=0;c<i.close.length;++c){var d=i.close[c];d&&d.call(this)}}h[a].addEventListener("open",function(){if(i.open)for(var a=0;a<i.open.length;++a){var b=i.open[a];b&&b.call(this)}},!1),h[a].addEventListener("message",function(a){var b=JSON.parse(a.data),c=b.shift();if(i[c])for(var d=0;d<i[c].length;++d){var e=i[c][d];e&&e.apply(this,b)}},!1),h[a].addEventListener("error",b,!1),h[a].addEventListener("close",b,!1)}var f,g=[],h=[],i={},j=null;if("string"==typeof a)f=io.connect(a,{reconnect:!0,"reconnection delay":1e3,"max reconnection attempts":60});else{if(!(a&&a.on&&a.emit))throw console.error("proxy error",f),new Error("need a socket");f=a}this.on=function(a,b){i[a]||(i[a]=[]),i[a].push(b)},this.emit=function(){for(var a=JSON.stringify(arr(arguments)),b=0;b<h.length;++b){var c=h[b];c&&"open"===c.readyState&&c.send(a)}},this.close=function(){h.forEach(function(a){a&&"open"===a.readyState&&a.close()}),g.forEach(function(a){a&&a.close()})},window.addEventListener("unload",this.close.bind(this)),this.connect=function(a){f.emit("handshake","peer"),f.on("handshakeComplete",function(b){"peer"===b&&f.emit("joinRequest",a)})},f.on("user",function(a,i){try{if(null===j&&(j=a),!g[i]){var k=new RTCPeerConnection({iceServers:["stun.l.google.com:19302","stun1.l.google.com:19302","stun2.l.google.com:19302","stun3.l.google.com:19302","stun4.l.google.com:19302"].map(function(a){return{url:"stun:"+a}})});if(g[i]=k,k.addEventListener("icecandidate",function(a){a.candidate&&(a.candidate.fromIndex=j,a.candidate.toIndex=i,f.emit("ice",a.candidate))},!1),f.on("ice",function(a){a.fromIndex===i&&g[i].addIceCandidate(new RTCIceCandidate(a))}),b===!0||void 0===b&&i>j){k.addEventListener("negotiationneeded",function(a){k.createOffer(c.bind(this,j,i),console.error.bind(console,"createOffer error"))});var l=k.createDataChannel("data-channel-"+j+"-to-"+i,{id:j,ordered:!1,maxRetransmits:0});h[i]=l,e(i),f.on("answer",function(a){a.fromIndex===i&&d(i,a)})}else(b===!1||void 0===b&&j>i)&&(k.addEventListener("datachannel",function(a){a.channel.id===i&&(h[a.channel.id]=a.channel,e(i))},!1),f.on("offer",function(a){a.fromIndex===i&&d(i,a,function(){g[i].createAnswer(c,console.error.bind(console,"createAnswer error"))})}))}}catch(m){console.error(m)}})}return a}(),Primrose.Audio.Audio3D=function(){function a(){function a(a){return 440*Math.pow(b,a-49)}try{this.context=new AudioContext,this.sampleRate=this.context.sampleRate,this.mainVolume=this.context.createGain(),this.mainVolume.connect(this.context.destination),this.setPosition=this.context.listener.setPosition.bind(this.context.listener),this.setVelocity=this.context.listener.setVelocity.bind(this.context.listener),this.setOrientation=this.context.listener.setOrientation.bind(this.context.listener),this.isAvailable=!0;var b=Math.pow(2,1/12);this.oscillators=[];for(var c=0;88>c;++c){var d=this.context.createGain();d.gain.value=0;var e=this.context.createOscillator();e.frequency.value=a(c+1),e.type="sine",e.start(),e.connect(d),d.connect(this.mainVolume),this.oscillators.push(d)}}catch(f){this.isAvailable=!1,this.setPosition=function(){},this.setVelocity=function(){},this.setOrientation=function(){},this.error=f,console.error("AudioContext not available. Reason: ",f.message)}}return a.prototype.sawtooth=function(a,b,c){if(this.isAvailable){var d=this.oscillators[a];d&&(d.timeout&&(clearTimeout(d.timeout),d.timeout=null),d.gain.value=b,d.timeout=setTimeout(function(){d.gain.value=0,d.timeout=null},1e3*c))}},a.prototype.loadBuffer=function(a,b,c){if(!c)throw new Error("You need to provide a callback function for when the audio finishes loading");b||(b=function(){});var d=function(){b("error",a)};if(this.isAvailable){b("loading",a);var e=new XMLHttpRequest;e.open("GET",a),e.responseType="arraybuffer",e.onerror=d,e.onabort=d,e.onprogress=function(c){b("intermediate",a,c.loaded)},e.onload=function(){e.status<400?(b("success",a),this.context.decodeAudioData(e.response,c,d)):d()}.bind(this),e.send()}else d()},a.prototype.loadBufferCascadeSrcList=function(a,b,c,d){if(d=d||0,d===a.length)b&&a.forEach(function(a){b("error",a)});else{var e=c,f=b;c=function(b){if(f)for(var c=d+1;c<a.length;++c)console.log("Skipping loading alternate file ["+a[c]+"]. ["+a[d]+"] has already loaded."),f("skip",a[c],"["+a[d]+"] has already loaded.");e&&e(b)},b=function(b,c,g){f&&f(b,c,g),"error"===b&&(console.warn("Failed to decode "+a[d]),setTimeout(this.loadBufferCascadeSrcList.bind(this,a,f,e,d+1),0))},this.loadBuffer(a[d],b,c)}},a.prototype.createRawSound=function(a,b){if(1!==a.length&&2!==a.length)throw new Error("Incorrect number of channels. Expected 1 or 2, got "+a.length);var c=a[0].length;if(a.length>1&&a[1].length!==c)throw new Error("Second channel is not the same length as the first channel. Expected "+c+", but was "+a[1].length);for(var d=this.context.createBuffer(a.length,c,this.sampleRate),e=0;e<a.length;++e)for(var f=d.getChannelData(e),g=0;c>g;++g)f[g]=a[e][g];b(d)},a.prototype.createSound=function(a,b,c){var d={volume:this.context.createGain(),source:this.context.createBufferSource()};d.source.buffer=c,d.source.loop=a,d.source.connect(d.volume),b(d)},a.prototype.create3DSound=function(a,b,c,d,e){e.panner=this.context.createPanner(),e.panner.setPosition(a,b,c),e.panner.connect(this.mainVolume),e.volume.connect(e.panner),d(e)},a.prototype.createFixedSound=function(a,b){b.volume.connect(this.mainVolume),a(b)},a.prototype.loadSound=function(a,b,c,d){this.loadBuffer(a,c,this.createSound.bind(this,b,d))},a.prototype.loadSoundCascadeSrcList=function(a,b,c,d){this.loadBufferCascadeSrcList(a,c,this.createSound.bind(this,b,d))},a.prototype.load3DSound=function(a,b,c,d,e,f,g){this.loadSound(a,b,f,this.create3DSound.bind(this,c,d,e,g))},a.prototype.load3DSoundCascadeSrcList=function(a,b,c,d,e,f,g){this.loadSoundCascadeSrcList()(a,b,f,this.create3DSound.bind(this,c,d,e,g))},a.prototype.loadFixedSound=function(a,b,c,d){this.loadSound(a,b,c,this.createFixedSound.bind(this,d))},a.prototype.loadFixedSoundCascadeSrcList=function(a,b,c,d){this.loadSoundCascadeSrcList(a,b,c,this.createFixedSound.bind(this,d))},a.prototype.playBufferImmediate=function(a,b){this.createSound(!1,this.createFixedSound.bind(this,function(a){a.volume.gain.value=b,a.source.addEventListener("ended",function(b){a.volume.disconnect(this.mainVolume)}.bind(this)),a.source.start(0)}),a)},a}(),Primrose.Audio.Speech=function(){function a(a,b,c,d){return void 0===a[b]?a[b]=c+(d-c)*Math.random():a[b]=Math.min(d,Math.max(c,a[b])),a[b]}try{return{Character:function(b){b=b||{};var c=speechSynthesis.getVoices().filter(function(a){return a["default"]||a.localService}.bind(this)),d=c[Math.floor(a(b,"voice",0,c.length))];this.speak=function(c,e){var f=new SpeechSynthesisUtterance;f.voice=d,f.volume=a(b,"volume",1,1),f.rate=a(b,"rate",.1,5),f.pitch=a(b,"pitch",0,2),f.text=c,f.onend=e,speechSynthesis.speak(f)}}}}catch(b){return{Character:function(){this.speak=function(){}}}}}();var isMobile=function(a){return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substring(0,4))}(navigator.userAgent||navigator.vendor||window.opera),isiOS=/Apple-iP(hone|od|ad)/.test(navigator.userAgent||""),isOSX=/Macintosh/.test(navigator.userAgent||""),isWindows=/Windows/.test(navigator.userAgent||""),isOpera=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,isFirefox="undefined"!=typeof window.InstallTrigger,isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,isChrome=!!window.chrome&&!isOpera,isIE=!1||!!document.documentMode,fmt=function(){function a(a,b){return b.replace(/( AM| PM|$)/,function(b,c){return(a.getMilliseconds()/1e3).toString().substring(1)+c})}function b(b){var c=/\$(0*)(\d+)(?:\.(0+))?/g,d=arguments;return"string"!=typeof b&&(b=b.toString()),b.replace(c,function(b,c,e,f){if(e=parseInt(e,10),e>=0&&e<d.length){var g=d[e];if(null!==g&&void 0!==g){if(g instanceof Date&&f){switch(f.length){case 1:g=g.getYear();break;case 2:g=g.getMonth()+1+"/"+g.getYear();break;case 3:g=g.toLocaleDateString();break;case 4:g=a(g,g.toLocaleTimeString());break;case 5:case 6:g=g.toLocaleString();break;default:g=a(g,g.toLocaleString())}return g}if(g=f&&f.length>0?sigfig(g,f.length):g.toString(),c&&c.length>0)for(var h=new RegExp("^\\d{"+(c.length+1)+"}(\\.\\d+)?");!h.test(g);)g="0"+g;return g}}return void 0})}return b}(),px=fmt.bind(this,"$1px"),pct=fmt.bind(this,"$1%"),ems=fmt.bind(this,"$1em"),exitPointerLock=(document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock||function(){}).bind(document),requestPointerLock=(document.documentElement.requestPointerLock||document.documentElement.webkitRequestPointerLock||document.documentElement.mozRequestPointerLock||function(){}).bind(document.documentElement),findVR=function(){"use strict";function a(a,b){for(var c,d,e=0;e<b.length;++e){var f=b[e];if(f instanceof window.HMDVRDevice?c=f:f instanceof window.PositionSensorVRDevice&&(d=f),d&&c)break}a(c,d)}function b(b){navigator.getVRDevices?navigator.getVRDevices().then(a.bind(window,b))["catch"](b):navigator.mozGetVRDevices?navigator.mozGetVRDevices(a.bind(window,b)):b()}return b}();"undefined"!=typeof window.THREE&&(InsideSphereGeometry.prototype=Object.create(THREE.Geometry.prototype),InsideSphereGeometry.prototype.constructor=InsideSphereGeometry),navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||function(){},navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.oGetUserMedia||function(){},window.RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection||function(){},window.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||function(){},window.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||function(){},window.Element.prototype.requestPointerLock=window.Element.prototype.requestPointerLock||window.Element.prototype.webkitRequestPointerLock||window.Element.prototype.mozRequestPointerLock||function(){},window.Element.prototype.requestFullscreen=window.Element.prototype.requestFullscreen||window.Element.prototype.webkitRequestFullscreen||window.Element.prototype.mozRequestFullScreen||window.Element.prototype.msRequestFullscreen||function(){},window.Document.prototype.exitFullscreen=window.Document.prototype.exitFullscreen||window.Document.prototype.webkitExitFullscreen||window.Document.prototype.mozCancelFullScreen||window.Document.prototype.msExitFullscreen||function(){},screen.lockOrientation=screen.lockOrientation||screen.mozLockOrientation||screen.msLockOrientation||function(){};var reverse=function(){function a(d){d=d.replace(b,function(b,c,d){return a(d)+c}).replace(c,"$2$1");for(var e="",f=d.length-1;f>=0;--f)e+=d[f];return e}var b=/(<%= allExceptCombiningMarks %>)(<%= combiningMarks %>+)/g,c=/(<%= highSurrogates %>)(<%= lowSurrogates %>)/g;return a}();Primrose.Input.ButtonAndAxis=function(){function a(a,b,c,d,e,f){this.offset=e||0,Primrose.NetworkedInput.call(this,a,b,c,d),this.inputState.axes=[],this.inputState.buttons=[],this.axisNames=f||[],this.commandNames=this.commands.map(function(a){return a.name});for(var g=0;g<this.axisNames.length;++g)this.inputState.axes[g]=0;this.setDeadzone=this.setProperty.bind(this,"deadzone"),this.setScale=this.setProperty.bind(this,"scale"),this.setDT=this.setProperty.bind(this,"dt"),this.setMin=this.setProperty.bind(this,"min"),this.setMax=this.setProperty.bind(this,"max"),this.setOffset=this.setProperty.bind(this,"offset"),this.addMetaKey=this.addToArray.bind(this,"metaKeys"),this.addAxis=this.addToArray.bind(this,"axes"),this.addButton=this.addToArray.bind(this,"buttons"),this.removeMetaKey=this.removeFromArray.bind(this,"metaKeys"),this.removeAxis=this.removeFromArray.bind(this,"axes"),this.removeButton=this.removeFromArray.bind(this,"buttons"),this.invertAxis=this.invertInArray.bind(this,"axes"),this.invertButton=this.invertInArray.bind(this,"buttons"),this.invertMetaKey=this.invertInArray.bind(this,"metaKeys")}return inherit(a,Primrose.NetworkedInput),a.inherit=function(b){inherit(b,a),b.AXES&&b.AXES.forEach(function(a,c){b[a]=c+1})},a.prototype.getAxis=function(a){var b=this.axisNames.indexOf(a);if(b>-1){var c=this.inputState.axes[b]||0;return c}return null},a.prototype.setAxis=function(a,b){var c=this.axisNames.indexOf(a);c>-1&&(this.inPhysicalUse=!0,this.inputState.axes[c]=b)},a.prototype.setButton=function(a,b){this.inPhysicalUse=!0,this.inputState.buttons[a]=b},a.prototype.getValue=function(a){var b=this.commandNames.indexOf(a);return(this.enabled||this.receiving&&this.socketReady)&&b>-1&&!this.commands[b].disabled&&this.commandState[a]&&this.commandState[a].value||0},a.prototype.isDown=function(a){var b=this.commandNames.indexOf(a);return(this.enabled||this.receiving&&this.socketReady)&&b>-1&&!this.commands[b].disabled&&this.commandState[a]&&this.commandState[a].pressed},a.prototype.isUp=function(a){var b=this.commandNames.indexOf(a);return(this.enabled||this.receiving&&this.socketReady)&&b>-1&&!this.commands[b].disabled&&this.commandState[a]&&!this.commandState[a].pressed},a.prototype.maybeClone=function(a){var b=[];if(a)for(var c=0;c<a.length;++c)b[c]={index:Math.abs(a[c])-this.offset,toggle:a[c]<0,sign:a[c]<0?-1:1};return b},a.prototype.cloneCommand=function(a){return{name:a.name,disabled:!!a.disabled,dt:a.dt||0,deadzone:a.deadzone||0,threshold:a.threshold||0,repetitions:a.repetitions||1,scale:a.scale,offset:a.offset,min:a.min,max:a.max,integrate:a.integrate||!1,delta:a.delta||!1,axes:this.maybeClone(a.axes),commands:a.commands&&a.commands.slice()||[],buttons:this.maybeClone(a.buttons),metaKeys:this.maybeClone(a.metaKeys),commandDown:a.commandDown,commandUp:a.commandUp}},a.prototype.evalCommand=function(a,b,c,d){if(c){var e,f,g=!0,h=0;if(a.buttons)for(e=0;e<a.buttons.length;++e){var i=a.buttons[e],j=!!this.inputState.buttons[i.index];f=j?i.sign:0,g=g&&(j&&!i.toggle||!j&&i.toggle),Math.abs(f)>Math.abs(h)&&(h=f)}if(a.axes)for(e=0;e<a.axes.length;++e){var k=a.axes[e];f=k.sign*this.inputState.axes[k.index],Math.abs(f)>Math.abs(h)&&(h=f)}if(a.commands)for(e=0;e<a.commands.length;++e)f=this.getValue(a.commands[e]),Math.abs(f)>Math.abs(h)&&(h=f);if(void 0!==a.scale&&(h*=a.scale),void 0!==a.offset&&(h+=a.offset),a.deadzone&&Math.abs(h)<a.deadzone&&(h=0),a.integrate)h=this.getValue(a.name)+h*d;else if(a.delta){var l=h;void 0!==b.lv&&(h-=b.lv),b.lv=l}void 0!==a.min&&(h=Math.max(a.min,h)),void 0!==a.max&&(h=Math.min(a.max,h)),a.threshold&&(g=g&&h>a.threshold),b.pressed=g,b.value=h}},a}(),Primrose.Input.Camera=function(){function a(b,c,d,e,f,g,h){MediaStreamTrack.getVideoTracks(function(a){for(var d=0;d<a.length;++d){var e=document.createElement("option");e.value=a[d].id,e.innerHTML=fmt("[Facing: $1] [ID: $2...]",a[d].facing||"N/A",a[d].id.substring(0,8)),e.selected=a[d].id===c,b.appendChild(e)}}),this.options=combineDefaults(h,a),this.videoElement=document.createElement("video"),this.buffer=document.createElement("canvas"),this.gfx=this.buffer.getContext("2d"),this.texture=new THREE.Texture(this.buffer);var i=new THREE.MeshBasicMaterial({map:this.texture,useScreenCoordinates:!1,color:16777215,shading:THREE.FlatShading});this.gfx.width=500,this.gfx.height=500,this.gfx.fillStyle="white",this.gfx.fillRect(0,0,500,500);var j=new THREE.PlaneGeometry(d,d);j.computeBoundingBox(),j.computeVertexNormals(),this.mesh=new THREE.Mesh(j,i),this.mesh.position.set(e,f,g),this.streaming=!1,this.videoElement.autoplay=1;var k=function(a,b,c){navigator.getUserMedia({video:a},function(a){streamURL=window.URL.createObjectURL(a),this.videoElement.src=streamURL,b()}.bind(this),c)}.bind(this),l=function(a,b,c){if(c=c||0,this.options.videoModes&&c<this.options.videoModes.length){var d=this.options.videoModes[c],e={optional:[{sourceId:a}]};"default"!==d&&(e.mandatory={minWidth:d.w,minHeight:d.h},d=fmt("[w:$1, h:$2]",d.w,d.h)),k(e,function(){console.log(fmt("Connected to camera at mode $1.",d))},function(b){console.error(fmt("Failed to connect at mode $1. Reason: $2",d,b)),l(a,b,c+1)})}else b()}.bind(this);this.videoElement.addEventListener("canplay",function(){this.streaming||(this.streaming=!0)}.bind(this),!1),this.videoElement.addEventListener("playing",function(){this.videoElement.height=this.buffer.height=this.videoElement.videoHeight,this.videoElement.width=this.buffer.width=this.videoElement.videoWidth;var a=this.videoElement.videoWidth/this.videoElement.videoHeight;this.mesh.scale.set(a,1,1)}.bind(this),!1),this.connect=function(a){if(this.streaming)try{window.stream&&window.stream.stop(),this.videoElement.src=null,this.streaming=!1}catch(b){console.error("While stopping",b)}l(a,function(a){console.error("Couldn't connect at requested resolutions. Reason: ",a),k(!0,console.log.bind(console,"Connected to camera at default resolution"),console.error.bind(console,"Final connect attempt"))})}.bind(this),c&&this.connect(c)}return a.DEFAULTS={videoModes:[{w:320,h:240},{w:640,h:480},"default"]},a.prototype.update=function(){this.gfx.drawImage(this.videoElement,0,0),this.texture.needsUpdate=!0},a}(),Primrose.Input.Gamepad=function(){function a(b,c,d,e,f){function g(a,b){-1===a.indexOf(b)&&a.push(b)}function h(a,b){var c=a.indexOf(b);c>-1&&a.splice(c,1)}function i(a,b){for(var c=0;c<a.length;++c)a[c](b)}function j(a){i(m.gamepadconnected,a)}function k(a){i(m.gamepaddisconnected,a)}Primrose.Input.ButtonAndAxis.call(this,b,c,d,e,1,a.AXES,!0);var l=[],m={gamepadconnected:[],gamepaddisconnected:[]};this.superUpdate=this.update,this.checkDevice=function(b){var c;for(c=0;c<b.buttons.length;++c)this.setButton(c,b.buttons[c].pressed);for(c=0;c<b.axes.length;++c)this.setAxis(a.AXES[c],b.axes[c])},this.update=function(a){var b,c,d=[];if(navigator.getGamepads?b=navigator.getGamepads():navigator.webkitGetGamepads&&(b=navigator.webkitGetGamepads()),b)for(c=0;c<b.length;++c){var e=b[c];e&&(-1===l.indexOf(e.id)&&(l.push(e.id),j(e.id)),e.id===f&&this.checkDevice(e),d.push(e.id))}for(c=l.length-1;c>=0;--c)-1===d.indexOf(l[c])&&(k(l[c]),l.splice(c,1));this.superUpdate(a);

},this.getErrorMessage=function(){return errorMessage},this.setGamepad=function(a){f=a,this.inPhysicalUse=!0},this.clearGamepad=function(){f=null,this.inPhysicalUse=!1},this.isGamepadSet=function(){return!!f},this.getConnectedGamepads=function(){return l.slice()},this.addEventListener=function(a,b,c){"gamepadconnected"===a&&(m[a]&&g(m[a],b),l.forEach(j))},this.removeEventListener=function(a,b,c){m[a]&&h(m[a],b)};try{this.update(0),available=!0}catch(n){avaliable=!1,errorMessage=n}}return a.AXES=["LSX","LSY","RSX","RSY"],Primrose.Input.ButtonAndAxis.inherit(a),a}(),Primrose.Input.Keyboard=function(){function a(a,b){return function(a){textEntry=!0,text="",insertionPoint=0,onTextEntry=a,onTextEntry(!1,"|"),this.enable(!1)}.bind(a,b.commandUp)}function b(c,d,e,f,g){function h(a,c){if(k&&a)if(c.keyCode===b.ENTER||c.keyCode===b.ESCAPE)k=!1,c.keyCode===b.ENTER&&l(!0,m),l(!1,null),this.enable(!0);else{var d=c.keyCode;d===b.BACKSPACE?(m=m.substring(0,n-1)+m.substring(n),--n):d===b.DELETE?m=m.substring(0,n)+m.substring(n+1):d===b.LEFTARROW?--n:d===b.RIGHTARROW?++n:d===b.HOME?n=0:d===b.END?n=m.length:c.shiftKey&&b.UPPERCASE[d]?(m=m.substring(0,n)+b.UPPERCASE[d]+m.substring(n),++n):!c.shiftKey&&b.LOWERCASE[d]?(m=m.substring(0,n)+b.LOWERCASE[d]+m.substring(n),++n):console.log(c.keyCode),n=Math.max(0,Math.min(m.length,n)),l(!1,m.substring(0,n)+"|"+m.substring(n)),c.preventDefault()}else this.setButton(c.keyCode,a)}d=d||window;for(var i=0;i<e.length;++i){var j=e[i];j.preamble&&(j.commandUp=a(this,j.commandUp))}Primrose.Input.ButtonAndAxis.call(this,c,e,f,g,0,0);var k=!1,l=null,m=null,n=null;d.addEventListener("keydown",h.bind(this,!0),!1),d.addEventListener("keyup",h.bind(this,!1),!1)}return Primrose.Input.ButtonAndAxis.inherit(b),b.BACKSPACE=8,b.TAB=9,b.ENTER=13,b.SHIFT=16,b.CTRL=17,b.ALT=18,b.PAUSEBREAK=19,b.CAPSLOCK=20,b.ESCAPE=27,b.SPACEBAR=32,b.PAGEUP=33,b.PAGEDOWN=34,b.END=35,b.HOME=36,b.LEFTARROW=37,b.UPARROW=38,b.RIGHTARROW=39,b.DOWNARROW=40,b.INSERT=45,b.DELETE=46,b.NUMBER0=48,b.NUMBER1=49,b.NUMBER2=50,b.NUMBER3=51,b.NUMBER4=52,b.NUMBER5=53,b.NUMBER6=54,b.NUMBER7=55,b.NUMBER8=56,b.NUMBER9=57,b.A=65,b.B=66,b.C=67,b.D=68,b.E=69,b.F=70,b.G=71,b.H=72,b.I=73,b.J=74,b.K=75,b.L=76,b.M=77,b.N=78,b.O=79,b.P=80,b.Q=81,b.R=82,b.S=83,b.T=84,b.U=85,b.V=86,b.W=87,b.X=88,b.Y=89,b.Z=90,b.LEFTWINDOWKEY=91,b.RIGHTWINDOWKEY=92,b.SELECTKEY=93,b.NUMPAD0=96,b.NUMPAD1=97,b.NUMPAD2=98,b.NUMPAD3=99,b.NUMPAD4=100,b.NUMPAD5=101,b.NUMPAD6=102,b.NUMPAD7=103,b.NUMPAD8=104,b.NUMPAD9=105,b.MULTIPLY=106,b.ADD=107,b.SUBTRACT=109,b.DECIMALPOINT=110,b.DIVIDE=111,b.F1=112,b.F2=113,b.F3=114,b.F4=115,b.F5=116,b.F6=117,b.F7=118,b.F8=119,b.F9=120,b.F10=121,b.F11=122,b.F12=123,b.NUMLOCK=144,b.SCROLLLOCK=145,b.SEMICOLON=186,b.EQUALSIGN=187,b.COMMA=188,b.DASH=189,b.PERIOD=190,b.FORWARDSLASH=191,b.GRAVEACCENT=192,b.OPENBRACKET=219,b.BACKSLASH=220,b.CLOSEBRACKET=221,b.SINGLEQUOTE=222,b.LOWERCASE={},b.LOWERCASE[b.A]="a",b.LOWERCASE[b.B]="b",b.LOWERCASE[b.C]="c",b.LOWERCASE[b.D]="d",b.LOWERCASE[b.E]="e",b.LOWERCASE[b.F]="f",b.LOWERCASE[b.G]="g",b.LOWERCASE[b.H]="h",b.LOWERCASE[b.I]="i",b.LOWERCASE[b.J]="j",b.LOWERCASE[b.K]="k",b.LOWERCASE[b.L]="l",b.LOWERCASE[b.M]="m",b.LOWERCASE[b.N]="n",b.LOWERCASE[b.O]="o",b.LOWERCASE[b.P]="p",b.LOWERCASE[b.Q]="q",b.LOWERCASE[b.R]="r",b.LOWERCASE[b.S]="s",b.LOWERCASE[b.T]="t",b.LOWERCASE[b.U]="u",b.LOWERCASE[b.V]="v",b.LOWERCASE[b.W]="w",b.LOWERCASE[b.X]="x",b.LOWERCASE[b.Y]="y",b.LOWERCASE[b.Z]="z",b.LOWERCASE[b.SPACEBAR]=" ",b.LOWERCASE[b.NUMBER0]="0",b.LOWERCASE[b.NUMBER1]="1",b.LOWERCASE[b.NUMBER2]="2",b.LOWERCASE[b.NUMBER3]="3",b.LOWERCASE[b.NUMBER4]="4",b.LOWERCASE[b.NUMBER5]="5",b.LOWERCASE[b.NUMBER6]="6",b.LOWERCASE[b.NUMBER7]="7",b.LOWERCASE[b.NUMBER8]="8",b.LOWERCASE[b.NUMBER9]="9",b.LOWERCASE[b.MULTIPLY]="*",b.LOWERCASE[b.ADD]="+",b.LOWERCASE[b.SUBTRACT]="-",b.LOWERCASE[b.DECIMALPOINT]=".",b.LOWERCASE[b.DIVIDE]="/",b.LOWERCASE[b.SEMICOLON]=";",b.LOWERCASE[b.EQUALSIGN]="=",b.LOWERCASE[b.COMMA]=",",b.LOWERCASE[b.DASH]="-",b.LOWERCASE[b.PERIOD]=".",b.LOWERCASE[b.FORWARDSLASH]="/",b.LOWERCASE[b.GRAVEACCENT]="`",b.LOWERCASE[b.OPENBRACKET]="[",b.LOWERCASE[b.BACKSLASH]="\\",b.LOWERCASE[b.CLOSEBRACKET]="]",b.LOWERCASE[b.SINGLEQUOTE]="'",b.UPPERCASE={},b.UPPERCASE[b.A]="A",b.UPPERCASE[b.B]="B",b.UPPERCASE[b.C]="C",b.UPPERCASE[b.D]="D",b.UPPERCASE[b.E]="E",b.UPPERCASE[b.F]="F",b.UPPERCASE[b.G]="G",b.UPPERCASE[b.H]="H",b.UPPERCASE[b.I]="I",b.UPPERCASE[b.J]="J",b.UPPERCASE[b.K]="K",b.UPPERCASE[b.L]="L",b.UPPERCASE[b.M]="M",b.UPPERCASE[b.N]="N",b.UPPERCASE[b.O]="O",b.UPPERCASE[b.P]="P",b.UPPERCASE[b.Q]="Q",b.UPPERCASE[b.R]="R",b.UPPERCASE[b.S]="S",b.UPPERCASE[b.T]="T",b.UPPERCASE[b.U]="U",b.UPPERCASE[b.V]="V",b.UPPERCASE[b.W]="W",b.UPPERCASE[b.X]="X",b.UPPERCASE[b.Y]="Y",b.UPPERCASE[b.Z]="Z",b.UPPERCASE[b.SPACEBAR]=" ",b.UPPERCASE[b.NUMBER0]=")",b.UPPERCASE[b.NUMBER1]="!",b.UPPERCASE[b.NUMBER2]="@",b.UPPERCASE[b.NUMBER3]="#",b.UPPERCASE[b.NUMBER4]="$",b.UPPERCASE[b.NUMBER5]="%",b.UPPERCASE[b.NUMBER6]="^",b.UPPERCASE[b.NUMBER7]="&",b.UPPERCASE[b.NUMBER8]="*",b.UPPERCASE[b.NUMBER9]="(",b.UPPERCASE[b.MULTIPLY]="*",b.UPPERCASE[b.ADD]="+",b.UPPERCASE[b.SUBTRACT]="-",b.UPPERCASE[b.DECIMALPOINT]=".",b.UPPERCASE[b.DIVIDE]="/",b.UPPERCASE[b.SEMICOLON]=":",b.UPPERCASE[b.EQUALSIGN]="+",b.UPPERCASE[b.COMMA]="<",b.UPPERCASE[b.DASH]="_",b.UPPERCASE[b.PERIOD]=">",b.UPPERCASE[b.FORWARDSLASH]="?",b.UPPERCASE[b.GRAVEACCENT]="~",b.UPPERCASE[b.OPENBRACKET]="{",b.UPPERCASE[b.BACKSLASH]="|",b.UPPERCASE[b.CLOSEBRACKET]="}",b.UPPERCASE[b.SINGLEQUOTE]='"',b}(),Primrose.Input.LeapMotion=function(){function a(b,c,d,e){this.isStreaming=!1,Primrose.Input.ButtonAndAxis.call(this,b,c,d,e,1,a.AXES),this.controller=new Leap.Controller({enableGestures:!0})}return a.COMPONENTS=["X","Y","Z"],a.NUM_HANDS=2,a.NUM_FINGERS=10,a.FINGER_PARTS=["tip","dip","pip","mcp","carp"],a.AXES=["X0","Y0","Z0","X1","Y1","Z1","FINGER0TIPX","FINGER0TIPY","FINGER0DIPX","FINGER0DIPY","FINGER0PIPX","FINGER0PIPY","FINGER0MCPX","FINGER0MCPY","FINGER0CARPX","FINGER0CARPY","FINGER1TIPX","FINGER1TIPY","FINGER1DIPX","FINGER1DIPY","FINGER1PIPX","FINGER1PIPY","FINGER1MCPX","FINGER1MCPY","FINGER1CARPX","FINGER1CARPY","FINGER2TIPX","FINGER2TIPY","FINGER2DIPX","FINGER2DIPY","FINGER2PIPX","FINGER2PIPY","FINGER2MCPX","FINGER2MCPY","FINGER2CARPX","FINGER2CARPY","FINGER3TIPX","FINGER3TIPY","FINGER3DIPX","FINGER3DIPY","FINGER3PIPX","FINGER3PIPY","FINGER3MCPX","FINGER3MCPY","FINGER3CARPX","FINGER3CARPY","FINGER4TIPX","FINGER4TIPY","FINGER4DIPX","FINGER4DIPY","FINGER4PIPX","FINGER4PIPY","FINGER4MCPX","FINGER4MCPY","FINGER4CARPX","FINGER4CARPY","FINGER5TIPX","FINGER5TIPY","FINGER5DIPX","FINGER5DIPY","FINGER5PIPX","FINGER5PIPY","FINGER5MCPX","FINGER5MCPY","FINGER5CARPX","FINGER5CARPY","FINGER6TIPX","FINGER6TIPY","FINGER6DIPX","FINGER6DIPY","FINGER6PIPX","FINGER6PIPY","FINGER6MCPX","FINGER6MCPY","FINGER6CARPX","FINGER6CARPY","FINGER7TIPX","FINGER7TIPY","FINGER7DIPX","FINGER7DIPY","FINGER7PIPX","FINGER7PIPY","FINGER7MCPX","FINGER7MCPY","FINGER7CARPX","FINGER7CARPY","FINGER8TIPX","FINGER8TIPY","FINGER8DIPX","FINGER8DIPY","FINGER8PIPX","FINGER8PIPY","FINGER8MCPX","FINGER8MCPY","FINGER8CARPX","FINGER8CARPY","FINGER9TIPX","FINGER9TIPY","FINGER9DIPX","FINGER9DIPY","FINGER9PIPX","FINGER9PIPY","FINGER9MCPX","FINGER9MCPY","FINGER9CARPX","FINGER9CARPY"],Primrose.Input.ButtonAndAxis.inherit(a),a.CONNECTION_TIMEOUT=5e3,a.prototype.E=function(a,b){b?this.controller.on(a,b):this.controller.on(a,console.log.bind(console,"Leap Motion Event: "+a))},a.prototype.start=function(b){if(this.isEnabled()){var c=null,d=null;if(b){var e=function(a){requestAnimationFrame(e),b(a)};d=requestAnimationFrame.bind(window,e);var f=setTimeout(d,a.CONNECTION_TIMEOUT);c=function(){clearTimeout(f),this.isStreaming=!0}.bind(this),this.E("deviceStreaming",c),this.E("streamingStarted",c),this.E("streamingStopped",d)}this.E("connect"),this.E("deviceStopped"),this.E("disconnect"),this.E("frame",this.setState.bind(this,b)),this.controller.connect()}},a.prototype.setState=function(b,c){var d,e,f=this.controller.history.get(1);if(!f||c.hands.length!==f.hands.length)for(d=0;d<this.commands.length;++d)this.enable(this.commands[d].name,c.hands.length>0);for(d=0;d<c.hands.length;++d){var g=c.hands[d].palmPosition,h="HAND"+d;for(e=0;e<a.COMPONENTS.length;++e)this.setAxis(h+a.COMPONENTS[e],g[e])}for(d=0;d<c.fingers.length;++d){var i=c.fingers[d],j="FINGER"+d;for(e=0;e<a.FINGER_PARTS.length;++e)for(var k=i[a.FINGER_PARTS[e]+"Position"],l=j+a.FINGER_PARTS[e].toUpperCase(),m=0;m<a.COMPONENTS.length;++m)this.setAxis(l+a.COMPONENTS[m],k[m])}b&&b(.001*c.timestamp)},a}(),Primrose.Input.Location=function(){function a(b,c,d,e,f){this.options=combineDefaults(e,a),Primrose.Input.ButtonAndAxis.call(this,b,c,d,f,1,a.AXES),this.available=!!navigator.geolocation,this.available&&navigator.geolocation.watchPosition(this.setState.bind(this),function(){this.available=!1}.bind(this),this.options)}return a.AXES=["LONGITUDE","LATITUDE","ALTITUDE","HEADING","SPEED"],Primrose.Input.ButtonAndAxis.inherit(a),a.DEFAULTS={enableHighAccuracy:!0,maximumAge:3e4,timeout:25e3},a.prototype.setState=function(b){for(var c in b.coords){var d=c.toUpperCase();a.AXES.indexOf(d)>-1&&this.setAxis(d,b.coords[c])}},a}(),Primrose.Input.Motion=function(){function a(a){if("number"!=typeof a)throw new Error("Angle must be initialized with a number. Initial value was: "+a);var b,c,d,e=a,f=0,g=Math.PI/180,h=180/Math.PI;this.setDegrees=function(a){do b=a+f-e,c=Math.abs(b+360),d=Math.abs(b-360),b=Math.abs(b),b>c&&d>c?f+=360:b>d&&(f-=360);while(b>c||b>d);e=a+f},this.getDegrees=function(){return e},this.getRadians=function(){return this.getDegrees()*g},this.setRadians=function(a){this.setDegrees(a*h)}}function b(c){function d(a){for(;0>a;)a+=360;for(;a>=360;)a-=360;return a}function e(){f&&g&&(s=Math.abs(f.x),t=Math.abs(f.y),u=Math.abs(f.z),v=s>0?f.x/s:1,w=t>0?f.y/t:1,x=u>0?f.z/u:1,s>t&&s>u&&s>4.5?y=-1===v:t>u&&t>s&&t>4.5&&(y=1===w),z=c?y?g.gamma>0:g.gamma<0:1===x,i=c&&z^!y||!c&&y?270:90,y?z?(m=1,l=-90,p=-1,o=0):(c?(m=1,l=90):(m=-1,l=90),p=1,o=180):z?(m=-1,l=-90,p=1,o=0):(c?(m=-1,l=90):(m=1,l=90),p=-1,o=180),k=d(j*g.alpha+i-B.alpha),n=d(m*g.gamma+l-B.gamma)-360,-180>n&&(n+=360),q=d(p*g.beta+o-B.beta),q>180&&(q-=360))}var f,g,h,i,j,k,l,m,n,o,p,q,s,t,u,v,w,x,y,z,A={x:0,y:0,z:0},B={alpha:0,beta:0,gamma:0};j=-1,this.setAcceleration=function(a){f=a,e()},this.setOrientation=function(a){g=a,e()},this.setRotation=function(a){h=a},this.getRotation=function(){return h},this.getAcceleration=function(){return f},this.getOrientation=function(){return g},this.getHeading=function(){return k},this.getPitch=function(){return n},this.getRoll=function(){return q},this.zeroAxes=function(){f&&(A.x=f.x,A.y=f.y,A.z=f.z),g&&(B.alpha=g.alpha,B.beta=g.beta,B.gamma=g.gamma)},this.addEventListener=function(c,d,e){if("deviceorientation"!==c)throw new Error('The only event type that is supported is "deviceorientation". Type parameter was: '+c);if("function"!=typeof d)throw new Error("A function must be provided as a callback parameter. Callback parameter was: "+d);var f,g,h=new a(0),i=new a(0),j=new a(0),k=new a(0),l=new a(0),m=new a(0);this.onChange=function(){f=this.getOrientation(),g=this.getAcceleration(),r=this.getRotation(),f&&g&&r&&(h.setDegrees(this.getHeading()),i.setDegrees(this.getPitch()),j.setDegrees(this.getRoll()),k.setDegrees(r.alpha),l.setDegrees(r.beta),m.setDegrees(r.gamma),d({HEADING:h.getRadians(),PITCH:i.getRadians(),ROLL:j.getRadians(),D_HEADING:k.getRadians(),D_PITCH:l.getRadians(),D_ROLL:m.getRadians(),ACCELX:g.x-A.x,ACCELY:g.y-A.y,ACCELZ:g.z-A.z}))},this.checkOrientation=function(a){this.setOrientation(null!==a.alpha&&a),this.onChange()},this.checkMotion=function(a){a&&a.accelerationIncludingGravity&&a.accelerationIncludingGravity.x?this.setAcceleration(a.accelerationIncludingGravity):a&&a.acceleration&&a.acceleration.x&&this.setAcceleration(a.acceleration),a.rotationRate&&this.setRotation(a.rotationRate),this.onChange()},this.setAcceleration(b.ZERO_VECTOR),this.setOrientation(b.ZERO_EULER),window.addEventListener("deviceorientation",this.checkOrientation.bind(this),e),window.addEventListener("devicemotion",this.checkMotion.bind(this),e)}}function c(a,d,e,f){Primrose.Input.ButtonAndAxis.call(this,a,d,e,f,1,c.AXES);var g=new b(b.BROWSER_IS_GOOGLE_CHROME);g.addEventListener("deviceorientation",function(a){for(var b=0;b<c.AXES.length;++b){var d=c.AXES[b];this.setAxis(d,a[d])}}.bind(this)),this.zeroAxes=g.zeroAxes.bind(g)}return b.ZERO_VECTOR={x:-9.80665,y:0,z:0},b.ZERO_EULER={gamma:90,alpha:270,beta:0},b.BROWSER_IS_GOOGLE_CHROME=!!window.chrome&&!window.opera&&navigator.userAgent.indexOf(" OPR/")<0,c.AXES=["HEADING","PITCH","ROLL","D_HEADING","D_PITCH","D_ROLL","ACCELX","ACCELY","ACCELZ"],Primrose.Input.ButtonAndAxis.inherit(c),c}(),Primrose.Input.Mouse=function(){function a(b,c,d,e,f){c=c||window,Primrose.Input.ButtonAndAxis.call(this,b,d,e,f,1,a.AXES),this.setLocation=function(a,b){this.setAxis("X",a),this.setAxis("Y",b)},this.setMovement=function(a,b){this.setAxis("X",a+this.getAxis("X")),this.setAxis("Y",b+this.getAxis("Y"))},this.readEvent=function(b){a.isPointerLocked()?this.setMovement(b.webkitMovementX||b.mozMovementX||b.movementX||0,b.webkitMovementY||b.mozMovementY||b.movementY||0):this.setLocation(b.clientX,b.clientY)},c.addEventListener("mousedown",function(a){this.setButton(a.button,!0),this.readEvent(a)}.bind(this),!1),c.addEventListener("mouseup",function(a){this.setButton(a.button,!1),this.readEvent(a)}.bind(this),!1),c.addEventListener("mousemove",this.readEvent.bind(this),!1),c.addEventListener("mousewheel",function(a){this.setAxis("Z",this.getAxis("Z")+a.wheelDelta),this.readEvent(a)}.bind(this),!1),this.addEventListener=function(a,b,c){"pointerlockchange"===a&&(document.exitPointerLock?document.addEventListener("pointerlockchange",b,c):document.mozExitPointerLock?document.addEventListener("mozpointerlockchange",b,c):document.webkitExitPointerLock&&document.addEventListener("webkitpointerlockchange",b,c))},this.removeEventListener=function(a,b,c){"pointerlockchange"===a&&(document.exitPointerLock?document.removeEventListener("pointerlockchange",b,c):document.mozExitPointerLock?document.removeEventListener("mozpointerlockchange",b,c):document.webkitExitPointerLock&&document.removeEventListener("webkitpointerlockchange",b,c))},c.requestPointerLock=c.requestPointerLock||c.webkitRequestPointerLock||c.mozRequestPointerLock||function(){},this.requestPointerLock=function(){a.isPointerLocked()||c.requestPointerLock()},this.exitPointerLock=document.exitPointerLock.bind(document),this.togglePointerLock=function(){a.isPointerLocked()?this.exitPointerLock():this.requestPointerLock()}}return a.isPointerLocked=function(){return!!(document.pointerLockElement||document.webkitPointerLockElement||document.mozPointerLockElement)},a.AXES=["X","Y","Z"],Primrose.Input.ButtonAndAxis.inherit(a),a}(),Primrose.Input.Speech=function(){function a(a,b,c,d){function e(){var a=fmt("Failed to initialize speech engine. Reason: $1",j.message);return console.error(a),!1}function f(){return available?h?!1:(h=!0,i.start(),!0):e()}function g(){return available?h?(i.stop(),!0):!1:e()}Primrose.NetworkedInput.call(this,a,b,c,d);var h=!1,i=null,j=null;this.check=function(){this.enabled&&!h?f():!this.enabled&&h&&g()},this.getErrorMessage=function(){return j};try{i=window.SpeechRecognition?new SpeechRecognition:new webkitSpeechRecognition,i.continuous=!0,i.interimResults=!0,i.lang="en-US";var k=!1;i.addEventListener("start",function(){console.log("speech started"),command=""}.bind(this),!0),i.addEventListener("error",function(a){k=!0,console.log("speech error",a),h=!1,command="speech error"}.bind(this),!0),i.addEventListener("end",function(){console.log("speech ended",arguments),h=!1,command="speech ended",k&&(k=!1,this.enable(!0))}.bind(this),!0),i.addEventListener("result",function(a){var b=[],c=a.results[a.resultIndex],d=0,e=-1;if(c&&c.isFinal)for(var f=0;f<c.length;++f){var g=c[f];g.confidence>d&&(d=g.confidence,e=f)}d>.85&&b.push(c[e].transcript.trim()),b=b.join(" "),b!==this.inputState&&(this.inputState.text=b)}.bind(this),!0),available=!0}catch(l){j=l,available=!1}}return inherit(a,Primrose.NetworkedInput),a.maybeClone=function(a){return a&&a.slice()||[]},a.prototype.cloneCommand=function(b){return{name:b.name,preamble:b.preamble,keywords:a.maybeClone(b.keywords),commandUp:b.commandUp,disabled:b.disabled}},a.prototype.evalCommand=function(a,b,c,d){if(c&&this.inputState.text)for(var e=0;e<a.keywords.length;++e)0!==this.inputState.text.indexOf(a.keywords[e])||!a.preamble&&a.keywords[e].length!==this.inputState.text.length||(b.pressed=!0,b.value=this.inputState.text.substring(a.keywords[e].length).trim(),this.inputState.text=null)},a.prototype.enable=function(a,b){Primrose.NetworkedInput.prototype.enable.call(this,a,b),this.check()},a.prototype.transmit=function(a){Primrose.NetworkedInput.prototype.transmit.call(this,a),this.check()},a}(),Primrose.Input.Touch=function(){function a(b,c,d,e,f,g){function h(b,c,e){for(var f=b?e.touches:e.changedTouches,g=0;g<f.length&&g<a.NUM_FINGERS;++g){var h=f[g];if(c){for(var i=0;i<d.length;++i){this.setButton(i,!1);var j=d[i];j.x<=h.pageX&&h.pageX<j.x2&&j.y<=h.pageY&&h.pageY<j.y2&&this.setButton(i,b)}this.setAxis("X"+g,h.pageX),this.setAxis("Y"+g,h.pageY)}else this.setAxis("LX"+g,h.pageX),this.setAxis("LY"+g,h.pageY)}e.preventDefault()}c=c||window,d=d||[];for(var i=d.length-1;i>=0;--i){var j=d[i];j.x2=j.x+j.w,j.y2=j.y+j.h}Primrose.Input.ButtonAndAxis.call(this,b,e,f,g,1,a.AXES),c.addEventListener("touchstart",h.bind(this,!0,!1),!1),c.addEventListener("touchend",h.bind(this,!1,!0),!1),c.addEventListener("touchmove",h.bind(this,!0,!0),!1)}a.NUM_FINGERS=10,a.AXES=[];for(var b=0;b<a.NUM_FINGERS;++b)a.AXES.push("X"+b),a.AXES.push("Y"+b);return Primrose.Input.ButtonAndAxis.inherit(a),a}(),Primrose.Input.VR=function(){function a(b,c,d,e){Primrose.Input.ButtonAndAxis.call(this,b,c,null,null,1,a.AXES),this.devices={},this.sensor=null,this.display=null,navigator.getVRDevices?navigator.getVRDevices().then(this.enumerateVRDevices.bind(this,d,e)):navigator.mozGetVRDevices&&navigator.mozGetVRDevices(this.enumerateVRDevices.bind(this,d,e))}return a.AXES=["X","Y","Z","VX","VY","VZ","AX","AY","AZ","RX","RY","RZ","RW","RVX","RVY","RVZ","RAX","RAY","RAZ"],Primrose.Input.ButtonAndAxis.inherit(a),a.prototype.update=function(a){if(this.sensor){var b=this.sensor.getState();b.position&&(this.setAxis("X",b.position.x),this.setAxis("Y",b.position.y),this.setAxis("Z",b.position.z)),this.setAxis("VX",b.linearVelocity.x),this.setAxis("VY",b.linearVelocity.y),this.setAxis("VZ",b.linearVelocity.z),this.setAxis("AX",b.linearAcceleration.x),this.setAxis("AY",b.linearAcceleration.y),this.setAxis("AZ",b.linearAcceleration.z),b.orientation&&(this.setAxis("RX",b.orientation.x),this.setAxis("RY",b.orientation.y),this.setAxis("RZ",b.orientation.z),this.setAxis("RW",b.orientation.w)),this.setAxis("RVX",b.angularVelocity.x),this.setAxis("RVY",b.angularVelocity.y),this.setAxis("RVZ",b.angularVelocity.z),this.setAxis("RAX",b.angularAcceleration.x),this.setAxis("RAY",b.angularAcceleration.y),this.setAxis("RAZ",b.angularAcceleration.z)}Primrose.Input.ButtonAndAxis.prototype.update.call(this,a)},a.prototype.enumerateVRDevices=function(a,b,c){for(var d,e=0;e<c.length;++e){var f=c[e];d=f.hardwareUnitId,this.devices[d]||(this.devices[d]={display:null,sensor:null});var g=this.devices[d];f instanceof HMDVRDevice?g.display=f:c[e]instanceof PositionSensorVRDevice&&(g.sensor=f)}for(d in this.devices){var h=document.createElement("option");h.value=d,h.innerHTML=this.devices[d].sensor.deviceName,h.selected=b===d,a.appendChild(h)}this.connect(b)},a.prototype.connect=function(a){var b=this.devices[a];b&&(this.sensor=b.sensor,this.display=b.display)},a}(),Primrose.Text.CodePage=function(){"use strict";function a(a,b,c){this.name=a,this.language=b,copyObject(this,{NORMAL:{65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z"},SHIFT:{65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z"}}),copyObject(this,c);for(var d=0;9>=d;++d){var e=Primrose.Text.Keys["NUMPAD"+d];this.NORMAL[e]=d.toString()}this.NORMAL[Primrose.Text.Keys.MULTIPLY]="*",this.NORMAL[Primrose.Text.Keys.ADD]="+",this.NORMAL[Primrose.Text.Keys.SUBTRACT]="-",this.NORMAL[Primrose.Text.Keys.DECIMALPOINT]=".",this.NORMAL[Primrose.Text.Keys.DIVIDE]="/"}return a.DEAD=function(a){return function(b){b.setDeadKeyState("DEAD"+a)}},a}(),Primrose.Text.CommandPack=function(){"use strict";function a(a,b){this.name=a,copyObject(this,b)}return a}(),Primrose.Text.Control=function(){"use strict";function a(){for(var b=0;b<c.length;++b)c[b].render();requestAnimationFrame(a)}function b(){c.push(this),this.focused=!1,this.changed=!1}var c=[];return requestAnimationFrame(a),b.prototype.render=function(){this.changed=!1},b.prototype.update=function(){this.changed&&this.render()},b.prototype.forceUpdate=function(){this.changed=!0,this.update()},b.prototype.dispose=function(){for(var a=c.length-1;a>=0;--a)if(c[a]===this){c.splice(a,1);break}},b.prototype.focus=function(){for(var a=0;a<c.length;++a){var b=c[a];b!==this&&b.blur()}this.focused=!0,this.forceUpdate()},b.prototype.blur=function(){this.focused=!1,this.forceUpdate()},b}(),Primrose.Text.Cursor=function(){"use strict";function a(a,b,c){this.i=a||0,this.x=b||0,this.y=c||0,this.moved=!0}function b(a,b){for(var c=a[b],d="",e=0;e<c.length;++e)d+=c[e].value;return d}return a.min=function(a,b){return a.i<=b.i?a:b},a.max=function(a,b){return a.i>b.i?a:b},a.prototype.toString=function(){return fmt("[i:$1 x:$2 y:$3]",this.i,this.x,this.y)},a.prototype.copy=function(a){this.i=a.i,this.x=a.x,this.y=a.y,this.moved=!1},a.prototype.fullhome=function(a){this.i=0,this.x=0,this.y=0,this.moved=!0},a.prototype.fullend=function(a){this.i=0;for(var c=0,d=0;d<a.length;++d){var e=b(a,d);c=e.length,this.i+=c}this.y=a.length-1,this.x=c,this.moved=!0},a.prototype.skipleft=function(a){if(0===this.x)this.left(a);else{var c=this.x-1,d=b(a,this.y),e=reverse(d.substring(0,c)),f=e.match(/(\s|\W)+/),g=f?f.index+f[0].length+1:e.length;this.i-=g,this.x-=g}this.moved=!0},a.prototype.left=function(a){if(this.i>0){if(--this.i,--this.x,this.x<0){--this.y;var c=b(a,this.y);this.x=c.length}this.reverseFromNewline(a)&&++this.i}this.moved=!0},a.prototype.skipright=function(a){var c=b(a,this.y);if(this.x===c.length||"\n"===c[this.x])this.right(a);else{var d=this.x+1;c=c.substring(d);var e=c.match(/(\s|\W)+/),f=e?e.index+e[0].length+1:c.length-this.x;this.i+=f,this.x+=f,this.reverseFromNewline(a)}this.moved=!0},a.prototype.fixCursor=function(a){this.x=this.i,this.y=0;for(var c=0,d=b(a,this.y);this.x>d.length;){if(this.x-=d.length,c+=d.length,this.y>=a.length-1){this.i=c,this.x=d.length,this.moved=!0;break}++this.y,d=b(a,this.y)}return this.moved},a.prototype.right=function(a){this.advanceN(a,1)},a.prototype.advanceN=function(a,c){var d=b(a,this.y);(this.y<a.length-1||this.x<d.length)&&(this.i+=c,this.fixCursor(a),d=b(a,this.y),this.x>0&&"\n"===d[this.x-1]&&(++this.y,this.x=0)),this.moved=!0},a.prototype.home=function(a){this.i-=this.x,this.x=0,this.moved=!0},a.prototype.end=function(a){var c=b(a,this.y),d=c.length-this.x;this.i+=d,this.x+=d,this.reverseFromNewline(a),this.moved=!0},a.prototype.up=function(a){if(this.y>0){--this.y;var c=b(a,this.y),d=Math.min(0,c.length-this.x);this.x+=d,this.i-=c.length-d,this.reverseFromNewline(a)}this.moved=!0},a.prototype.down=function(a){if(this.y<a.length-1){++this.y;var c=b(a,this.y),d=b(a,this.y-1),e=Math.min(0,c.length-this.x);this.x+=e,this.i+=d.length+e,this.reverseFromNewline(a)}this.moved=!0},a.prototype.incY=function(a,c){this.y=Math.max(0,Math.min(c.length-1,this.y+a));var d=b(c,this.y);this.x=Math.max(0,Math.min(d.length,this.x)),this.i=this.x;for(var e=0;e<this.y;++e)this.i+=b(c,e).length;this.reverseFromNewline(c),this.moved=!0},a.prototype.setXY=function(a,c,d){this.y=Math.max(0,Math.min(d.length-1,c));var e=b(d,this.y);this.x=Math.max(0,Math.min(e.length,a)),this.i=this.x;for(var f=0;f<this.y;++f)this.i+=b(d,f).length;this.reverseFromNewline(d),this.moved=!0},a.prototype.setI=function(a,b){this.i=a,this.fixCursor(b),this.moved=!0},a.prototype.reverseFromNewline=function(a){var c=b(a,this.y);return this.x>0&&"\n"===c[this.x-1]?(--this.x,--this.i,!0):!1},a}(),Primrose.Text.Grammar=function(){"use strict";function a(a,b){function c(a){for(var b=!1,c=0,d=0;d<a.length;++d){var e=a[d];e.line=c,"newlines"===e.type&&++c,b?("endBlockComments"===e.type&&(b=!1),"newlines"!==e.type&&(e.type="comments")):"startBlockComments"===e.type&&(b=!0,e.type="comments")}}this.name=a,this.grammar=b.map(function(a){return new Primrose.Text.Rule(a[0],a[1])}),this.tokenize=function(a){for(var b=[new Primrose.Text.Token(a,"regular",0)],d=0;d<this.grammar.length;++d)for(var e=this.grammar[d],f=0;f<b.length;++f)e.carveOutMatchedToken(b,f);return c(b),b}}return a}(),Primrose.Text.Keys=function(){"use strict";var a={MODIFIER_KEYS:["CTRL","ALT","META","SHIFT"],SHIFT:16,CTRL:17,ALT:18,META_L:91,META_R:92,BACKSPACE:8,TAB:9,ENTER:13,SPACE:32,DELETE:46,PAUSEBREAK:19,CAPSLOCK:20,NUMLOCK:144,SCROLLLOCK:145,INSERT:45,ESCAPE:27,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFTARROW:37,UPARROW:38,RIGHTARROW:39,DOWNARROW:40,SELECTKEY:93,NUMBER0:48,NUMBER1:49,NUMBER2:50,NUMBER3:51,NUMBER4:52,NUMBER5:53,NUMBER6:54,NUMBER7:55,NUMBER8:56,NUMBER9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMALPOINT:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123};for(var b in a){var c=a[b];a.hasOwnProperty(b)&&"number"==typeof c&&(a[c]=b)}return a}(),Primrose.Text.OperatingSystem=function(){"use strict";function a(a,b,c,d,e){var f=b+"_"+c;a[f]=function(a,b){a["cursor"+d](b,a[e+"Cursor"])}}function b(b,c,d,e){a(b,c||"NORMAL",d,e,"front"),a(b,c+"SHIFT",d,e,"back")}function c(a,c,d,e,f,g,h,i,j,k){this.name=a,this[c+"_a"]=function(a,b){a.frontCursor.fullhome(b),a.backCursor.fullend(b),a.forceUpdate()},this[e]=function(a,b){a.redo(),a.scrollIntoView(a.frontCursor)},this[c+"_z"]=function(a,b){a.undo(),a.scrollIntoView(a.frontCursor)},this[c+"_DOWNARROW"]=function(a,b){a.scroll.y<b.length&&++a.scroll.y,a.forceUpdate()},this[c+"_UPARROW"]=function(a,b){a.scroll.y>0&&--a.scroll.y,a.forceUpdate()},b(this,"","LEFTARROW","Left"),b(this,"","RIGHTARROW","Right"),b(this,"","UPARROW","Up"),b(this,"","DOWNARROW","Down"),b(this,"","PAGEUP","PageUp"),b(this,"","PAGEDOWN","PageDown"),b(this,d,"LEFTARROW","SkipLeft"),b(this,d,"RIGHTARROW","SkipRight"),b(this,f,g,"Home"),b(this,f,h,"End"),b(this,i,j,"FullHome"),b(this,i,k,"FullEnd")}return c}(),Primrose.Text.PlainText=function(){function a(a,b,c,d,e,f,g,h){a=a.replace(/\r\n/g,"\n");var i=a.split("\n");h=h||"center";var j=1e3*b,k=j*i.length,l=document.createElement("canvas"),m=l.getContext("2d");m.font=j+"px Arial";var n=m.measureText(a).width;l.width=n,l.height=k,m.font=.8*j+"px Arial","transparent"!==d&&(m.fillStyle=d,m.fillRect(0,0,l.width,l.height)),m.fillStyle=c,m.textBaseline="top";for(var o=0;o<i.length;++o)m.fillText(i[o],0,o*j);var p=new THREE.Texture(l);p.needsUpdate=!0;var q=new THREE.MeshBasicMaterial({map:p,transparent:"transparent"===d,useScreenCoordinates:!1,color:16777215,shading:THREE.FlatShading}),r=new THREE.PlaneGeometry(b*n/j,b*i.length);r.computeBoundingBox(),r.computeVertexNormals();var s=new THREE.Mesh(r,q);return"left"===h?e-=r.boundingBox.min.x:"right"===h&&(e+=r.boundingBox.min.x),s.position.set(e,f,g),s}return a}(),Primrose.Text.Point=function(){"use strict";function a(a,b){this.set(a||0,b||0)}return a.prototype.set=function(a,b){this.x=a,this.y=b},a.prototype.copy=function(a){a&&(this.x=a.x,this.y=a.y)},a.prototype.clone=function(){return new a(this.x,this.y)},a.prototype.toString=function(){return fmt("(x:$1, y:$2)",this.x,this.y)},a}(),Primrose.Text.Rectangle=function(){"use strict";function a(a,b,c,d){this.point=new Primrose.Text.Point(a,b),this.size=new Primrose.Text.Size(c,d),Object.defineProperties(this,{x:{get:function(){return this.point.x},set:function(a){this.point.x=a}},left:{get:function(){return this.point.x},set:function(a){this.point.x=a}},width:{get:function(){return this.size.width},set:function(a){this.size.width=a}},right:{get:function(){return this.point.x+this.size.width},set:function(a){this.point.x=a-this.size.width}},y:{get:function(){return this.point.y},set:function(a){this.point.y=a}},top:{get:function(){return this.point.y},set:function(a){this.point.y=a}},height:{get:function(){return this.size.height},set:function(a){this.size.height=a}},bottom:{get:function(){return this.point.y+this.size.height},set:function(a){this.point.y=a-this.size.height}}})}return a.prototype.set=function(a,b,c,d){this.point.set(a,b),this.size.set(c,d)},a.prototype.copy=function(a){a&&(this.point.copy(a.point),this.size.copy(a.size))},a.prototype.clone=function(){return new a(this.point.x,this.point.y,this.size.width,this.size.height)},a.prototype.toString=function(){return fmt("[$1 x $2]",this.point.toString(),this.size.toString())},a}(),Primrose.Text.Rule=function(){"use strict";function a(a,b){this.name=a,this.test=b}return a.prototype.carveOutMatchedToken=function(a,b){var c=a[b];if("regular"===c.type){var d=this.test.exec(c.value);if(d){for(var e=d[d.length-1],f=d.index,g=1;g<d.length-1;++g)f+=d[g].length;var h=f+e.length;if(0===f){if(c.type=this.name,h<c.value.length){var i=c.splitAt(h);i.type="regular",a.splice(b+1,0,i)}}else{var j=c.splitAt(f);if(e.length<j.value.length){var k=j.splitAt(e.length);a.splice(b+1,0,k)}j.type=this.name,a.splice(b+1,0,j)}}}},a}(),Primrose.Text.Size=function(){"use strict";function a(a,b){this.set(a||0,b||0)}return a.prototype.set=function(a,b){this.width=a,this.height=b},a.prototype.copy=function(a){a&&(this.width=a.width,this.height=a.height)},a.prototype.clone=function(){return new a(this.width,this.height)},a.prototype.toString=function(){return fmt("<w:$1, h:$2>",this.width,this.height)},a}(),Primrose.Text.Terminal=function(a,b){"use strict";function c(a){a.selectionStart=a.selectionEnd=a.value.length,a.scrollIntoView(a.frontCursor),a.forceUpdate()}function d(){q.running&&(f(),q.running=!1,p&&(a.setTokenizer(k),a.value=j),c(a))}function e(){return b.selectionStart=b.selectionEnd=0,b.value="",!0}function f(){if(o.length>0){for(var a=o.split("\n"),b=0;m>b&&a.length>0;++b)n.push(a.shift());a.length>0&&n.push(" ----- more -----"),o=a.join("\n")}}function g(a){i=a,q.waitingForInput=!0,f()}function h(a){o+=a}b=b||a;var i=null,j=null,k=null,l=0,m=40,n=[],o="",p=a===b,q=this;this.running=!1,this.waitingForInput=!1,this.sendInput=function(a){if(o.length>0)f();else{b.keyDown(a);var c=b.value.substring(l);i(c.trim()),i=null,this.waitingForInput=!1}},this.execute=function(c){if(m=c?10:40,k=a.getTokenizer(),k&&k.interpret){this.running=!0;var f,i=function(){q.running&&setTimeout(f,1)};j=a.value,f=k.interpret(j,g,h,h,i,e,this.loadFile.bind(this),d),b.setTokenizer(Primrose.Text.Grammars.PlainText),e(),i()}},this.loadFile=function(b,c){GET(b.toLowerCase(),"text",function(b){isOSX&&(b=b.replace("CTRL+SHIFT+SPACE","CMD+OPT+E")),a.value=j=b,c&&c()})},this.update=function(){n.length>0&&(b.value+=n.shift()+"\n",c(b),l=b.selectionStart)}},Primrose.Text.Token=function(){"use strict";function a(a,b,c,d){this.value=a,this.type=b,this.index=c,this.line=d}return a.prototype.clone=function(){return new a(this.value,this.type,this.index,this.line)},a.prototype.splitAt=function(b){
var c=this.value.substring(b);return this.value=this.value.substring(0,b),new a(c,this.type,this.index+b,this.line)},a.prototype.toString=function(){return fmt("[$1: $2]",this.type,this.value)},a}(),Primrose.Text.CodePages.DE_QWERTZ=function(){"use strict";var a=Primrose.Text.CodePage;return new a("Deutsch: QWERTZ","de",{deadKeys:[220,221,160,192],NORMAL:{48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",60:"<",63:"",160:a.DEAD(3),163:"#",171:"+",173:"-",186:"",187:"+",188:",",189:"-",190:".",191:"#",192:a.DEAD(4),219:"",220:a.DEAD(1),221:a.DEAD(2),222:"",226:"<"},DEAD1NORMAL:{65:"",69:"",73:"",79:"",85:"",190:"."},DEAD2NORMAL:{65:"",69:"",73:"",79:"",83:"s",85:"",89:""},SHIFT:{48:"=",49:"!",50:'"',51:"",52:"$",53:"%",54:"&",55:"/",56:"(",57:")",60:">",63:"?",163:"'",171:"*",173:"_",186:"",187:"*",188:";",189:"_",190:":",191:"'",192:"",219:"?",222:"",226:">"},CTRLALT:{48:"}",50:"",51:"",55:"{",56:"[",57:"]",60:"|",63:"\\",69:"",77:"",81:"@",171:"~",187:"~",219:"\\",226:"|"},CTRLALTSHIFT:{63:"",219:""},DEAD3NORMAL:{65:"a",69:"e",73:"i",79:"o",85:"u",190:"."},DEAD4NORMAL:{65:"a",69:"e",73:"i",79:"o",83:"s",85:"u",89:"y"}})}(),Primrose.Text.CodePages.EN_UKX=function(){"use strict";var a=Primrose.Text.CodePage;return new a("English: UK Extended","en-GB",{CTRLALT:{52:"",65:"",69:"",73:"",79:"",85:"",163:"\\",192:"",222:"\\",223:""},CTRLALTSHIFT:{65:"",69:"",73:"",79:"",85:"",222:"|"},NORMAL:{48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",163:"#",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"'",219:"[",220:"\\",221:"]",222:"#",223:"`"},SHIFT:{48:")",49:"!",50:'"',51:"",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",163:"~",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"@",219:"{",220:"|",221:"}",222:"~",223:""}})}(),Primrose.Text.CodePages.EN_US=function(){"use strict";var a=Primrose.Text.CodePage;return new a("English: USA","en-US",{NORMAL:{48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'"},SHIFT:{48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",219:"{",220:"|",221:"}",222:'"'}})}(),Primrose.Text.CodePages.FR_AZERTY=function(){"use strict";var a=Primrose.Text.CodePage;return new a("Franais: AZERTY","fr",{deadKeys:[221,50,55],NORMAL:{48:"",49:"&",50:"",51:'"',52:"'",53:"(",54:"-",55:"",56:"_",57:"",186:"$",187:"=",188:",",190:";",191:":",192:"",219:")",220:"*",221:a.DEAD(1),222:"",223:"!",226:"<"},SHIFT:{48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",186:"",187:"+",188:"?",190:".",191:"/",192:"%",219:"",220:"",223:"",226:">"},CTRLALT:{48:"@",50:a.DEAD(2),51:"#",52:"{",53:"[",54:"|",55:a.DEAD(3),56:"\\",57:"^",69:"",186:"",187:"}",219:"]"},DEAD1NORMAL:{65:"",69:"",73:"",79:"",85:""},DEAD2NORMAL:{65:"",78:"",79:""},DEAD3NORMAL:{48:"",50:"",55:"",65:"",69:"",73:"",79:"",85:""}})}(),Primrose.Text.CommandPacks.TextEditor=function(){"use strict";return{name:"Basic commands",NORMAL_SPACE:" ",SHIFT_SPACE:" ",NORMAL_BACKSPACE:function(a,b){a.frontCursor.i===a.backCursor.i&&a.frontCursor.left(b),a.overwriteText(),a.scrollIntoView(a.frontCursor)},NORMAL_ENTER:function(a,b,c){var d="",e=b[a.frontCursor.y];e.length>0&&"whitespace"===e[0].type&&(d=e[0].value),a.overwriteText("\n"+d),a.scrollIntoView(a.frontCursor)},NORMAL_DELETE:function(a,b){a.frontCursor.i===a.backCursor.i&&a.backCursor.right(b),a.overwriteText(),a.scrollIntoView(a.frontCursor)},SHIFT_DELETE:function(a,b){a.frontCursor.i===a.backCursor.i&&(a.frontCursor.home(b),a.backCursor.end(b)),a.overwriteText(),a.scrollIntoView(a.frontCursor)},NORMAL_TAB:function(a,b){var c=a.getTabString();a.overwriteText(c)}}}(),Primrose.Text.CommandPacks.TextEditor=function(){"use strict";function a(a,b,c){var d={NORMAL_SPACE:" ",SHIFT_SPACE:" ",NORMAL_BACKSPACE:function(a,b){a.frontCursor.i===a.backCursor.i&&a.frontCursor.left(b),a.overwriteText(),a.scrollIntoView(a.frontCursor)},NORMAL_ENTER:function(a,b,c){var d="",e=b[a.frontCursor.y];e.length>0&&"whitespace"===e[0].type&&(d=e[0].value),a.overwriteText("\n"+d),a.scrollIntoView(a.frontCursor)},NORMAL_DELETE:function(a,b){a.frontCursor.i===a.backCursor.i&&a.backCursor.right(b),a.overwriteText(),a.scrollIntoView(a.frontCursor)},SHIFT_DELETE:function(a,b){a.frontCursor.i===a.backCursor.i&&(a.frontCursor.home(b),a.backCursor.end(b)),a.overwriteText(),a.scrollIntoView(a.frontCursor)},NORMAL_TAB:function(a,b){var c=a.getTabString();a.overwriteText(c)}},e={};copyObject(e,b),copyObject(e,a),copyObject(e,d);for(var f in e)if(e.hasOwnProperty(f)){var g=e[f];"function"!=typeof g&&(g=c.overwriteText.bind(c,g)),e[f]=g}Primrose.Text.CommandPack.call(this,"Text editor commands",e)}return inherit(a,Primrose.Text.CommandPack),a}(),Primrose.Text.Controls.Keyboard=function(){"use strict";function a(a,b){function c(a,c){if(b.pointerEventSource){m.focus();var d=b.pointerEventSource.getBoundingClientRect();m.startPointer(a-d.left,c-d.top)}}function d(a,c){if(b.pointerEventSource){var d=b.pointerEventSource.getBoundingClientRect();m.movePointer(a-d.left,c-d.top)}}function e(a){0===a.button&&(c(a.clientX,a.clientY),a.preventDefault())}function f(a){m.focused&&d(a.clientX,a.clientY)}function g(a){m.focused&&0===a.button&&m.endPointer()}function h(a){if(m.focused&&a.touches.length>0&&!w){var b=a.touches[0];c(b.clientX,b.clientY),s=b.identifier}}function i(a){for(var b=0;b<a.changedTouches.length&&w;++b){var c=a.changedTouches[b];if(c.identifier===s){d(c.clientX,c.clientY);break}}}function j(a){for(var b=0;b<a.changedTouches.length&&w;++b){var c=a.changedTouches[b];c.identifier===s&&m.endPointer()}}function k(){if(q&&o){r={};var a={NORMAL_SPACE:" ",SHIFT_SPACE:" ",NORMAL_TAB:"	"},b={};copyObject(b,n),copyObject(b,o),copyObject(b,a)}}function l(a,b,c,d,e,f,g){var h=cascadeElement(a,"select",window.HTMLSelectElement),i=[];for(var j in b)if(b.hasOwnProperty(j)){var k=b[j];if(!g||k instanceof g){k=k.name||j;var l=document.createElement("option");l.innerHTML=k,i.push(b[j]),k===c&&(l.selected="selected"),h.appendChild(l)}}"function"==typeof d[e]?h.addEventListener("change",function(){d[e](i[h.selectedIndex])}):h.addEventListener("change",function(){d[e]=i[h.selectedIndex]});var m=cascadeElement("container -"+a,"div",window.HTMLDivElement),n=cascadeElement("label-"+a,"span",window.HTMLSpanElement);return n.innerHTML=f+": ",n["for"]=h,h.title=f,h.alt=f,m.appendChild(n),m.appendChild(h),m}var m=this;b=b||{},"string"==typeof b&&(b={file:b}),Primrose.Text.Control.call(this);var n,o,p,q,r,s,t={keydown:[]},u="",v=[],w=!1,x=null;this.addEventListener=function(a,b){t.hasOwnProperty(a)&&t[a].push(b)},this.getDOMElement=function(){return x},this.setDeadKeyState=function(a){this.changed=!0,u=a||""},this.setOperatingSystem=function(a){this.changed=!0,o=a||(isOSX?Primrose.Text.OperatingSystems.OSX:Primrose.Text.OperatingSystems.Windows),k()},this.getOperatingSystem=function(){return o},this.setSize=function(a,b){},this.getWidth=function(){return null},this.getHeight=function(){return null},this.setCodePage=function(a){this.changed=!0;var b,c,d,e;if(n=a,!n){var f=navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage||navigator.browserLanguage;f&&"en"!==f||(f="en-US");for(b in Primrose.Text.CodePages)if(a=Primrose.Text.CodePages[b],a.language===f){n=a;break}n||(n=Primrose.Text.CodePages.EN_US)}v=[];for(b in Primrose.Text.Keys)c=Primrose.Text.Keys[b],isNaN(c)||(v[c]=b);q={};for(var g in n){var h=n[g];if("object"==typeof h)for(c in h){if(c.indexOf("_")>-1){var i=c.split(" "),j=i[0];c=i[1],d=n.NORMAL[c],e=j+"_"+g+" "+d}else d=n.NORMAL[c],e=g+"_"+d;v[c]=d,q[e]=h[c]}}k()},this.getCodePage=function(){return n},this.startPicking=function(a,b,c){},this.movePicking=function(a,b,c){},this.startPointer=function(a,b){},this.movePointer=function(a,b){},this.endPointer=function(){w=!1},this.bindEvents=function(a,b){a&&a.addEventListener("keydown",this.keyDown.bind(this)),b&&(b.addEventListener("mousedown",e),b.addEventListener("mousemove",f),b.addEventListener("mouseup",g),b.addEventListener("touchstart",h),b.addEventListener("touchmove",i),b.addEventListener("touchend",j))},this.keyDown=function(a){if(this.focused){a=a||event;var b=a.keyCode;if(b!==Primrose.Text.Keys.CTRL&&b!==Primrose.Text.Keys.ALT&&b!==Primrose.Text.Keys.META_L&&b!==Primrose.Text.Keys.META_R&&b!==Primrose.Text.Keys.SHIFT){var c=u,d=u;a.ctrlKey&&(d+="CTRL"),a.altKey&&(d+="ALT"),a.metaKey&&(d+="META"),a.shiftKey&&(d+="SHIFT"),d===u&&(d+="NORMAL"),d+="_"+v[b];var e=r[p+"_"+d]||r[d];e&&(this.frontCursor.moved=!1,this.backCursor.moved=!1,e(m,tokenRows),this.frontCursor.moved&&!this.backCursor.moved&&this.backCursor.copy(this.frontCursor),clampScroll(),a.preventDefault()),u===c&&(u="")}this.update()}},this.render=function(){Primrose.Text.Control.prototype.render.call(this)},p=isChrome?"CHROMIUM":isFirefox?"FIREFOX":isIE?"IE":isOpera?"OPERA":isSafari?"SAFARI":"UNKNOWN",x=cascadeElement(a,"canvas",HTMLCanvasElement),b.autoBindEvents&&(void 0===b.keyEventSource&&(b.keyEventSource=x),void 0===b.pointerEventSource&&(b.pointerEventSource=x)),this.setCodePage(b.codePage),this.setOperatingSystem(b.os),this.bindEvents(b.keyEventSource,b.pointerEventSource),this.keyboardSelect=l("primrose-keyboard-selector-"+x.id,Primrose.Text.CodePages,n.name,m,"setCodePage","Localization",Primrose.Text.CodePage),this.operatingSystemSelect=l("primrose-operating-system-selector-"+x.id,Primrose.Text.OperatingSystems,o.name,m,"setOperatingSystem","Shortcut style",Primrose.Text.OperatingSystem)}return inherit(a,Primrose.Text.Control),a}(),Primrose.Text.Controls.TextBox=function(){"use strict";function a(a,b){function c(){F=E.tokenize(x.value),x.update()}function d(){if(x.scroll.y<0)x.scroll.y=0;else for(;0<x.scroll.y&&x.scroll.y>G.length-T.height;)--x.scroll.y}function e(){if(H){var a=aa.getDOMElement().getBoundingClientRect();L.style.left=px(a.left),L.style.top=px(window.scrollY+a.top),L.style.width=0,L.style.height=0,ba.style.fontFamily=H.fontFamily;var b=aa.character.height/aa.getPixelRatio();ba.style.fontSize=px(.99*b),ba.style.lineHeight=px(b)}}function f(a,b,c){x.changed=!0,N.set(b,c),aa.pixel2cell(N,x.scroll,T);var d=N.x-x.scroll.x,e=N.y-x.scroll.y,f=e>=T.height,g=0>d,h=N.x>=T.width;if(X||f||g||h){if(X||h&&!f){X=!0;var i=G.length-T.height;if(e>=0&&i>=0){var j=e*i/T.height;x.scroll.y=Math.floor(j)}}else if(f&&!g){for(var k=0,l=0;l<G.length;++l){for(var m=G[l],n=0,o=0;o<m.length;++o)n+=m[o].value.length;k=Math.max(k,n)}var p=k-T.width;if(d>=0&&p>=0){var q=d*p/T.width;x.scroll.x=Math.floor(q)}}}else a.setXY(N.x,N.y,G),t(),x.backCursor.copy(a);O.copy(N)}function g(){var a=x.frontCursor.fixCursor(G)||x.backCursor.fixCursor(G);a&&x.render()}function h(a,c){if(b.pointerEventSource){x.focus();var d=b.pointerEventSource.getBoundingClientRect();x.startPointer(a-d.left,c-d.top)}}function i(a,c){if(b.pointerEventSource){var d=b.pointerEventSource.getBoundingClientRect();x.movePointer(a-d.left,c-d.top)}}function j(a){0===a.button&&(h(a.clientX,a.clientY),a.preventDefault())}function k(a){x.focused&&i(a.clientX,a.clientY)}function l(a){x.focused&&0===a.button&&x.endPointer()}function m(a){if(x.focused&&a.touches.length>0&&!W){var b=a.touches[0];h(b.clientX,b.clientY),K=b.identifier}}function n(a){for(var b=0;b<a.changedTouches.length&&W;++b){var c=a.changedTouches[b];if(c.identifier===K){i(c.clientX,c.clientY);break}}}function o(a){for(var b=0;b<a.changedTouches.length&&W;++b){var c=a.changedTouches[b];c.identifier===K&&x.endPointer()}}function p(){C&&z&&B&&(D=new B(z,C,x))}function q(a){var b=a.toLowerCase();x["cursor"+a]=function(a,c){x.changed=!0,c[b](a),x.scrollIntoView(c)}}function r(){var a;Y?(a=Math.max(1,Math.ceil(Math.log(x.getLineCount())/Math.LN10)),U.width=1):(a=0,U.width=0),Z?$?V.set(aa.VSCROLL_WIDTH,0):V.set(aa.VSCROLL_WIDTH,1):V.set(0,0);var b=U.width+a,c=0,d=Math.floor(x.getWidth()/aa.character.width)-b-V.width,e=Math.floor(x.getHeight()/aa.character.height)-c-V.height;T.set(b+2,c,d-2,e-2);var f=aa.character.width/aa.getPixelRatio(),g=aa.character.height/aa.getPixelRatio();ba.style.left=px(T.x*f),ba.style.top=px(T.y*g),ba.style.width=px(T.width*f),ba.style.height=px(T.height*g),G=[[]];for(var h=0,i=F.slice(),j=0;j<i.length;++j){var k=i[j].clone(),l=T.width-h,m=$&&"newlines"!==k.type&&k.value.length>l,n="newlines"===k.type||m;if(m){var o=k.value.length>T.width?l:0;i.splice(j+1,0,k.splitAt(o))}k.value.length>0&&(G[G.length-1].push(k),h+=k.value.length),n&&(G.push([]),h=0)}return a}function s(a){a.returnValue=!1}function t(){ba.selectionStart=Math.min(x.frontCursor.i,x.backCursor.i),ba.selectionEnd=Math.max(x.frontCursor.i,x.backCursor.i)}function u(a,b,c){var d=a-b,e=a-c+5,f=0;return(0>d||e>=0)&&(f=Math.abs(d)<Math.abs(e)?d:e),f}function v(a,b,c,d){var e=document.createElement("span"),f=document.createElement("input");f.type="checkbox",f.checked=b,f.id=a,e.appendChild(f);var g=document.createElement("label");return g.innerHTML=c+" ",g["for"]=a,e.appendChild(g),f.addEventListener("change",function(){x[d](f.checked)}),e}function w(a,b,c,d,e,f,g){var h=cascadeElement(a,"select",window.HTMLSelectElement),i=[];for(var j in b)if(b.hasOwnProperty(j)){var k=b[j];if(!g||k instanceof g){k=k.name||j;var l=document.createElement("option");l.innerHTML=k,i.push(b[j]),k===c&&(l.selected="selected"),h.appendChild(l)}}"function"==typeof d[e]?h.addEventListener("change",function(){d[e](i[h.selectedIndex])}):h.addEventListener("change",function(){d[e]=i[h.selectedIndex]});var m=cascadeElement("container -"+a,"div",window.HTMLDivElement),n=cascadeElement("label-"+a,"span",window.HTMLSpanElement);return n.innerHTML=f+": ",n["for"]=h,h.title=f,h.alt=f,m.appendChild(n),m.appendChild(h),m}var x=this;b=b||{},"string"==typeof b&&(b={file:b}),b.readOnly&&(b.disableClipboard=!0),Primrose.Text.Control.call(this);var y,z,A,B,C,D,E,F,G,H,I,J,K,L,M=b.renderer||Primrose.Text.Renderers.Canvas,N=new Primrose.Text.Point,O=new Primrose.Text.Point,P="",Q=[],R=[],S=-1,T=new Primrose.Text.Rectangle,U=new Primrose.Text.Size,V=new Primrose.Text.Size,W=!1,X=!1,Y=!0,Z=!0,$=!1,_=0,aa=new M(a,b),ba=cascadeElement("primrose-surrogate-textarea-"+aa.id,"textarea",window.HTMLTextAreaElement);this.frontCursor=new Primrose.Text.Cursor,this.backCursor=new Primrose.Text.Cursor,this.scroll=new Primrose.Text.Point,["Left","Right","SkipLeft","SkipRight","Up","Down","Home","End","FullHome","FullEnd"].map(q.bind(this)),this.addEventListener=function(a,c){"keydown"===a&&b.keyEventSource.addEventListener(a,c)},this.cursorPageUp=function(a,b){this.changed=!0,b.incY(-T.height,a),this.scrollIntoView(b)},this.cursorPageDown=function(a,b){this.changed=!0,b.incY(T.height,a),this.scrollIntoView(b)},this.getDOMElement=function(){return aa.getDOMElement()},this.focus=function(){ba.focus(),Primrose.Text.Control.prototype.focus.call(this)},this.blur=function(){ba.blur(),Primrose.Text.Control.prototype.blur.call(this)},this.getRenderer=function(){return aa},this.setWheelScrollSpeed=function(a){_=a||25},this.getWheelScrollSpeed=function(){return _},this.setWordWrap=function(a){$=a||!1,this.forceUpdate()},this.getWordWrap=function(){return $},this.setShowLineNumbers=function(a){Y=a,this.forceUpdate()},this.getShowLineNumbers=function(){return Y},this.setShowScrollBars=function(a){Z=a,this.forceUpdate()},this.getShowScrollBars=function(){return Z},this.setTheme=function(a){H=a||Primrose.Text.Themes.Default,aa.setTheme(H),aa.resize(),this.changed=!0,this.update()},this.getTheme=function(){return H},this.setDeadKeyState=function(a){this.changed=!0,P=a||""},this.setOperatingSystem=function(a){this.changed=!0,z=a||(isOSX?Primrose.Text.OperatingSystems.OSX:Primrose.Text.OperatingSystems.Windows),p()},this.getOperatingSystem=function(){return z},this.setCommandSystem=function(a){this.changed=!0,B=a||Primrose.Text.CommandPacks.TextEditor,p()},this.setSize=function(a,b){this.changed=aa.setSize(a,b)},this.getWidth=function(){return aa.getWidth()},this.getHeight=function(){return aa.getHeight()},this.setCodePage=function(a){this.changed=!0;var b,c,d,e;if(y=a,!y){var f=navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage||navigator.browserLanguage;f&&"en"!==f||(f="en-US");for(b in Primrose.Text.CodePages)if(a=Primrose.Text.CodePages[b],a.language===f){y=a;break}y||(y=Primrose.Text.CodePages.EN_US)}Q=[];for(b in Primrose.Text.Keys)c=Primrose.Text.Keys[b],isNaN(c)||(Q[c]=b);C={};for(var g in y){var h=y[g];if("object"==typeof h)for(c in h){if(c.indexOf("_")>-1){var i=c.split(" "),j=i[0];c=i[1],d=y.NORMAL[c],e=j+"_"+g+" "+d}else d=y.NORMAL[c],e=g+"_"+d;Q[c]=d,C[e]=h[c]}}p()},this.getCodePage=function(){return y},this.setTokenizer=function(a){this.changed=!0,E=a||Primrose.Text.Grammars.JavaScript,R&&R.length>0&&(c(),this.update())},this.getTokenizer=function(){return E},this.getLines=function(){return R[S].slice()},this.getLineCount=function(){return R[S].length},Object.defineProperties(this,{value:{get:function(){return R[S].join("\n")},set:function(a){a=a||"",a=a.replace(/\r\n/g,"\n");var b=a.split("\n");this.pushUndo(b),this.update(),ba.value=a,t()}},selectionStart:{get:function(){return this.frontCursor.i},set:function(a){this.frontCursor.setI(a,G)}},selectionEnd:{get:function(){return this.backCursor.i},set:function(a){this.backCursor.setI(a,G)}},selectionDirection:{get:function(){return this.frontCursor.i<=this.backCursor.i?"forward":"backward"}}}),this.pushUndo=function(a){S<R.length-1&&R.splice(S+1),R.push(a),S=R.length-1,c(),this.forceUpdate()},this.redo=function(){this.changed=!0,S<R.length-1&&++S,c(),g()},this.undo=function(){this.changed=!0,S>0&&--S,c(),g()},this.setTabWidth=function(a){I=a||4,J="";for(var b=0;I>b;++b)J+=" "},this.getTabWidth=function(){return I},this.getTabString=function(){return J},this.scrollIntoView=function(a){this.scroll.y+=u(a.y,this.scroll.y,this.scroll.y+T.height),$||(this.scroll.x+=u(a.x,this.scroll.x,this.scroll.x+T.width)),d()},this.increaseFontSize=function(){++H.fontSize,this.changed=aa.resize()},this.decreaseFontSize=function(){H.fontSize>1&&(--H.fontSize,this.changed=aa.resize())},this.setFontSize=function(a){H.fontSize=a,this.changed=aa.resize()},this.cell2i=function(a,b){for(var c=0,d=0;b>d;++d){for(var e=G[d],f=0;f<e.length;++f)c+=e[f].value.length;++c}return c+=a},this.i2cell=function(a){for(var b=0;b<G.length;++b){for(var c=G[b],d=0,e=0;e<c.length;++e)d+=c[e].value.length;if(d>=a)return{x:a,y:b};a-=d-1}},this.readWheel=function(a){this.scroll.y+=Math.floor(a.deltaY/_),d(),a.preventDefault(),this.forceUpdate()},this.startPicking=function(a,b,c){var d=aa.getPixelIndex(a,b,c);this.startPointer(d.x,d.y)},this.movePicking=function(a,b,c){var d=aa.getPixelIndex(a,b,c);this.movePointer(d.x,d.y)},this.startPointer=function(a,b){f(this.frontCursor,a,b),W=!0,this.update()},this.movePointer=function(a,b){W&&(f(this.backCursor,a,b),this.update())},this.endPointer=function(){W=!1,X=!1,ba.focus()},this.bindEvents=function(a,b,c,d){a&&a.addEventListener("keydown",this.keyDown.bind(this)),b&&(b.addEventListener("wheel",this.readWheel.bind(this)),b.addEventListener("mousedown",j),b.addEventListener("mousemove",k),b.addEventListener("mouseup",l),b.addEventListener("touchstart",m),b.addEventListener("touchmove",n),b.addEventListener("touchend",o)),c&&c.addEventListener("wheel",this.readWheel.bind(this)),d&&(ba.addEventListener("beforecopy",s),ba.addEventListener("copy",this.copySelectedText.bind(this)),ba.addEventListener("beforecut",s),ba.addEventListener("cut",this.cutSelectedText.bind(this)),a&&(a.addEventListener("beforepaste",s),a.addEventListener("paste",this.readClipboard.bind(this))))},this.overwriteText=function(a){if(a=a||"",a=a.replace(/\r\n/g,"\n"),this.frontCursor.i!==this.backCursor.i||a.length>0){var b=Primrose.Text.Cursor.min(this.frontCursor,this.backCursor),c=Primrose.Text.Cursor.max(this.frontCursor,this.backCursor),e=this.value,f=e.substring(0,b.i),g=e.substring(c.i);this.value=f+a+g,b.advanceN(G,Math.max(0,a.length)),this.scrollIntoView(c),d(),c.copy(b),this.render()}},this.copySelectedText=function(a){if(a.returnValue=!1,this.frontCursor.i!==this.backCursor.i){var b=Primrose.Text.Cursor.min(this.frontCursor,this.backCursor),c=Primrose.Text.Cursor.max(this.frontCursor,this.backCursor),d=this.value,e=d.substring(b.i,c.i),f=a.clipboardData||window.clipboardData;f.setData(window.clipboardData?"Text":"text/plain",e)}a.preventDefault()},this.cutSelectedText=function(a){this.copySelectedText(a),this.overwriteText(),this.update()},this.readClipboard=function(a){a.returnValue=!1;var b=a.clipboardData||window.clipboardData,c=b.getData(window.clipboardData?"Text":"text/plain");c&&this.overwriteText(c)},this.keyDown=function(a){if(this.focused){a=a||event;var b=a.keyCode;if(b!==Primrose.Text.Keys.CTRL&&b!==Primrose.Text.Keys.ALT&&b!==Primrose.Text.Keys.META_L&&b!==Primrose.Text.Keys.META_R&&b!==Primrose.Text.Keys.SHIFT){var c=P,e=P;a.ctrlKey&&(e+="CTRL"),a.altKey&&(e+="ALT"),a.metaKey&&(e+="META"),a.shiftKey&&(e+="SHIFT"),e===P&&(e+="NORMAL"),e+="_"+Q[b];var f=D[A+"_"+e]||D[e];f&&(this.frontCursor.moved=!1,this.backCursor.moved=!1,f(x,G),this.frontCursor.moved&&!this.backCursor.moved&&this.backCursor.copy(this.frontCursor),d(),a.preventDefault()),P===c&&(P="")}this.update()}},this.update=function(){aa.hasResized()&&(this.changed=aa.resize(),e()),Primrose.Text.Control.prototype.update.call(this)},this.render=function(){if(F){var a=r();aa.render(G,this.frontCursor,this.backCursor,T,this.scroll,this.focused,Y,Z,$,a),t(),Primrose.Text.Control.prototype.render.call(this)}},this.appendControls=function(a){a.appendChild(this.lineNumberToggler),a.appendChild(this.wordWrapToggler),a.appendChild(this.scrollBarToggler),a.appendChild(this.operatingSystemSelect),a.appendChild(this.keyboardSelect),a.appendChild(this.commandSystemSelect),a.appendChild(this.tokenizerSelect),a.appendChild(this.themeSelect)},A=isChrome?"CHROMIUM":isFirefox?"FIREFOX":isIE?"IE":isOpera?"OPERA":isSafari?"SAFARI":"UNKNOWN",ba.style.position="absolute",ba.addEventListener("blur",this.blur.bind(this)),L=makeHidingContainer("primrose-surrogate-textarea-container-"+aa.id,ba),document.body.insertBefore(L,document.body.children[0]),this.readOnly=!!b.readOnly,(b.autoBindEvents||aa.autoBindEvents)&&(b.readOnly||void 0!==b.keyEventSource||(b.keyEventSource=ba),void 0===b.pointerEventSource&&(b.pointerEventSource=aa.getDOMElement()),void 0===b.wheelEventSource&&(b.wheelEventSource=aa.getDOMElement())),this.setWheelScrollSpeed(b.wheelScrollSpeed),this.setWordWrap(!b.disableWordWrap),this.setShowLineNumbers(!b.hideLineNumbers),this.setShowScrollBars(!b.hideScrollBars),this.setTabWidth(b.tabWidth),this.setTheme(b.theme),this.setFontSize(b.fontSize||14),this.setTokenizer(b.tokenizer),this.setCodePage(b.codePage),this.setOperatingSystem(b.os),this.setCommandSystem(b.commands),this.value=b.file,this.bindEvents(b.keyEventSource,b.pointerEventSource,b.wheelEventSource,!b.disableClipboard),this.lineNumberToggler=v("primrose-line-number-toggler-"+aa.id,!b.hideLineNumbers,"Line numbers","setShowLineNumbers"),this.wordWrapToggler=v("primrose-word-wrap-toggler-"+aa.id,!b.disableWordWrap,"Line wrap","setWordWrap"),this.scrollBarToggler=v("primrose-scrollbar-toggler-"+aa.id,!b.hideScrollBars,"Scroll bars","setShowScrollBars"),this.themeSelect=w("primrose-theme-selector-"+aa.id,Primrose.Text.Themes,H.name,x,"setTheme","theme"),this.commandSystemSelect=w("primrose-command-system-selector-"+aa.id,Primrose.Text.Commands,B.name,x,"setCommandSystem","Command system"),this.tokenizerSelect=w("primrose-tokenizer-selector-"+aa.id,Primrose.Text.Grammars,E.name,x,"setTokenizer","Language syntax",Primrose.Text.Grammar),this.keyboardSelect=w("primrose-keyboard-selector-"+aa.id,Primrose.Text.CodePages,y.name,x,"setCodePage","Localization",Primrose.Text.CodePage),this.operatingSystemSelect=w("primrose-operating-system-selector-"+aa.id,Primrose.Text.OperatingSystems,z.name,x,"setOperatingSystem","Shortcut style",Primrose.Text.OperatingSystem),e()}return inherit(a,Primrose.Text.Control),a}(),Primrose.Text.Grammars.Basic=function(){var grammar=new Primrose.Text.Grammar("BASIC",[["newlines",/(?:\r\n|\r|\n)/],["lineNumbers",/^\d+\s+/],["comments",/^REM.*$/],["strings",/"(?:\\"|[^"])*"/],["strings",/'(?:\\'|[^'])*'/],["numbers",/-?(?:(?:\b\d*)?\.)?\b\d+\b/],["keywords",/\b(?:RESTORE|REPEAT|RETURN|LOAD|LABEL|DATA|READ|THEN|ELSE|FOR|DIM|LET|IF|TO|STEP|NEXT|WHILE|WEND|UNTIL|GOTO|GOSUB|ON|TAB|AT|END|STOP|PRINT|INPUT|RND|INT|CLS|CLK|LEN)\b/],["keywords",/^DEF FN/],["operators",/(?:\+|;|,|-|\*\*|\*|\/|>=|<=|=|<>|<|>|OR|AND|NOT|MOD|\(|\)|\[|\])/],["identifiers",/\w+\$?/]]),oldTokenize=grammar.tokenize;return grammar.tokenize=function(a){return oldTokenize.call(this,a.toUpperCase())},grammar.interpret=function(sourceCode,input,output,errorOut,next,clearScreen,loadFile,done){function toNum(a){return new Primrose.Text.Token(a.toString(),"numbers")}function toStr(a){return new Primrose.Text.Token('"'+a.replace("\n","\\n").replace('"','\\"')+'"',"strings")}function process(a){if(a&&a.length>0){var b=a.shift();if(b){if(commands.hasOwnProperty(b.value))return commands[b.value](a);if(isNumber(b.value))return setProgramCounter([b]);if(state[b.value]||a.length>0&&"operators"===a[0].type&&"="===a[0].value)return a.unshift(b),translate(a);error("Unknown command. >>> "+b.value)}}return pauseBeforeComplete()}function error(a){errorOut("At line "+lineNumbers[counter]+": "+a)}function getLine(a){var b=lineNumbers[a],c=program[b];return c&&c.slice()}function evaluate(line){for(var script="",i=0;i<line.length;++i){var t=line[i],nest=0;if("identifiers"===t.type&&"function"!=typeof state[t.value]&&i<line.length-1&&"("===line[i+1].value)for(var j=i+1;j<line.length;++j){var t2=line[j];if("("===t2.value?(0===nest&&(t2.value="["),++nest):")"===t2.value?(--nest,0===nest&&(t2.value="]")):","===t2.value&&1===nest&&(t2.value="]["),0===nest)break}script+=t.value}with(state)try{return eval(script)}catch(exp){console.debug(line.join(", ")),console.error(exp),console.error(script),error(exp.message+": "+script)}}function declareVariable(a){var b,c=[],d=[c],e=0;for(b=0;b<a.length;++b){var f=a[b];"("===f.value?++e:")"===f.value&&--e,0===e&&","===f.value?(c=[],d.push(c)):c.push(f)}for(b=0;b<d.length;++b){c=d[b];var g=c.shift();if("identifiers"===g.type){var h,i=null;if(g=g.value,"("===c[0].value&&")"===c[c.length-1].value){var j=[];for(h=1;h<c.length-1;++h)"numbers"===c[h].type&&j.push(0|c[h].value);if(0===j.length)i=[];else{i=new Array(j[0]);var k=[i];for(h=1;h<j.length;++h)for(var l=j[h],m=0,n=k.length;n>m;++m)for(var o=k.shift(),p=0;p<o.length;++p)o[p]=new Array(l),h<j.length-1&&k.push(o[p])}}return state[g]=i,!0}error("Identifier expected: "+g.value)}}function print(a){var b="\n",c=0;a=a.map(function(d,e){return d=d.clone(),"operators"===d.type&&(","===d.value?0===c&&(d.value='+ ", " + '):";"===d.value?(d.value='+ " "',e<a.length-1?d.value+=" + ":b=""):"("===d.value?++c:")"===d.value&&--c),d});var d=evaluate(a);return void 0===d&&(d=""),output(d+b),!0}function setProgramCounter(a){var b=parseFloat(evaluate(a));for(counter=-1;counter<lineNumbers.length-1&&lineNumbers[counter+1]<b;)++counter;return!0}function checkConditional(a){var b,c=-1,d=-1;for(b=0;b<a.length;++b)"keywords"===a[b].type&&"THEN"===a[b].value?c=b:"keywords"===a[b].type&&"ELSE"===a[b].value&&(d=b);if(-1===c)error("Expected THEN clause.");else{var e=a.slice(0,c);for(b=0;b<e.length;++b){var f=e[b];"operators"===f.type&&"="===f.value&&(f.value="==")}var g,h;if(-1===d?g=a.slice(c+1):(g=a.slice(c+1,d),h=a.slice(d+1)),evaluate(e))return process(g);if(h)return process(h)}return!0}function pauseBeforeComplete(){return output("PROGRAM COMPLETE - PRESS RETURN TO FINISH."),input(function(){isDone=!0,done&&done()}),!1}function labelLine(a){return a.push(EQUAL_SIGN),a.push(toNum(lineNumbers[counter])),translate(a)}function waitForInput(a){var b=a.pop();return a.length>0&&print(a),input(function(a){a=a.toUpperCase();var c=null;c=isNumber(a)?toNum(a):toStr(a),evaluate([b,EQUAL_SIGN,c]),next&&next()}),!1}function onStatement(a){var b=[],c=null,d=[];try{for(;a.length>0&&("keywords"!==a[0].type||"GOTO"!==a[0].value);)b.push(a.shift());if(a.length>0){a.shift();for(var e=0;e<a.length;++e){var f=a[e];("operators"!==f.type||","!==f.value)&&d.push(f)}if(c=evaluate(b)-1,c>=0&&c<d.length)return setProgramCounter([d[c]])}}catch(g){console.error(g)}return!0}function gotoSubroutine(a){return returnStack.push(toNum(lineNumbers[counter+1])),setProgramCounter(a)}function setRepeat(){return returnStack.push(toNum(lineNumbers[counter])),!0}function conditionalReturn(a){var b=!0,c=returnStack.pop();return c&&a&&(b=setProgramCounter([c])),b}function untilLoop(a){var b=!evaluate(a);return conditionalReturn(b)}function findNext(a){for(i=counter+1;i<lineNumbers.length;++i){var b=getLine(i);if(b[0].value===a)return i}return lineNumbers.length}function whileLoop(a){var b=evaluate(a);return b?returnStack.push(toNum(lineNumbers[counter])):counter=findNext("WEND"),!0}function forLoop(a){var b=lineNumbers[counter],c=[],d=[],e=[],f=[],g=[c,d,e,f],h=0,i=0;for(i=0;i<a.length;++i){var j=a[i];j.value===FOR_LOOP_DELIMS[h]?(0===h&&c.push(j),++h):g[h].push(j)}var k=1;f.length>0&&(k=evaluate(f)),void 0===forLoopCounters[b]&&(forLoopCounters[b]=evaluate(d));var l=evaluate(e),m=forLoopCounters[b]<=l;return m?(c.push(toNum(forLoopCounters[b])),process(c),forLoopCounters[b]+=k,returnStack.push(toNum(lineNumbers[counter]))):(delete forLoopCounters[b],counter=findNext("NEXT")),!0}function stackReturn(){return conditionalReturn(!0)}function loadCodeFile(a){return loadFile(evaluate(a),function(){next&&next()}),!1}function noop(){return!0}function loadData(a){for(;a.length>0;){var b=a.shift();"operators"!==b.type&&data.push(b.value)}return!0}function readData(a){if(0===data.length){var b=findNext("DATA");process(getLine(b))}var c=data[dataCounter];return++dataCounter,a.push(EQUAL_SIGN),a.push(toNum(c)),translate(a)}function restoreData(){return dataCounter=0,!0}function defineFunction(line){for(var name=line.shift().value,signature="",body="",fillSig=!0,i=0;i<line.length;++i){var t=line[i];"operators"===t.type&&"="===t.value?fillSig=!1:fillSig?signature+=t.value:body+=t.value}name="FN"+name;var script="(function "+name+signature+"{ return "+body+"; })";return state[name]=eval(script),!0}function translate(a){return evaluate(a),!0}for(var tokens=this.tokenize(sourceCode),EQUAL_SIGN=new Primrose.Text.Token("=","operators"),counter=0,isDone=!1,program={},lineNumbers=[],currentLine=[],lines=[currentLine],data=[],returnStack=[],forLoopCounters={},dataCounter=0,state={INT:function(a){return 0|a},RND:function(){return Math.random()},CLK:function(){return Date.now()/36e5},LEN:function(a){return a.length},LINE:function(){return lineNumbers[counter]},TAB:function(a){for(var b="",c=0;a>c;++c)b+=" ";return b},POW:function(a,b){return Math.pow(a,b)}},tokenMap={OR:"||",AND:"&&",NOT:"!",MOD:"%","<>":"!="};tokens.length>0;){var token=tokens.shift();"newlines"===token.type?(currentLine=[],lines.push(currentLine)):"regular"!==token.type&&"comments"!==token.type&&(token.value=tokenMap[token.value]||token.value,currentLine.push(token))}for(var i=0;i<lines.length;++i){var line=lines[i];if(line.length>0){var lastLine=lineNumbers[lineNumbers.length-1],lineNumber=line.shift();if("lineNumbers"!==lineNumber.type&&(line.unshift(lineNumber),void 0===lastLine&&(lastLine=-1),lineNumber=toNum(lastLine+1)),lineNumber=parseFloat(lineNumber.value),lastLine&&lastLine>=lineNumber)throw new Error("expected line number greater than "+lastLine+", but received "+lineNumber+".");line.length>0&&(lineNumbers.push(lineNumber),program[lineNumber]=line)}}var FOR_LOOP_DELIMS=["=","TO","STEP"],commands={DIM:declareVariable,LET:translate,PRINT:print,GOTO:setProgramCounter,IF:checkConditional,
INPUT:waitForInput,END:pauseBeforeComplete,STOP:pauseBeforeComplete,REM:noop,"'":noop,CLS:clearScreen,ON:onStatement,GOSUB:gotoSubroutine,RETURN:stackReturn,LOAD:loadCodeFile,DATA:loadData,READ:readData,RESTORE:restoreData,REPEAT:setRepeat,UNTIL:untilLoop,"DEF FN":defineFunction,WHILE:whileLoop,WEND:stackReturn,FOR:forLoop,NEXT:stackReturn,LABEL:labelLine};return function(){if(!isDone)for(var a=!0;a;){var b=getLine(counter);a=process(b),++counter}}},grammar}(),Primrose.Text.Grammars.JavaScript=function(){"use strict";return new Primrose.Text.Grammar("JavaScript",[["newlines",/(?:\r\n|\r|\n)/],["comments",/\/\/.*$/],["startBlockComments",/\/\*/],["endBlockComments",/\*\//],["strings",/"(?:\\"|[^"])*"/],["strings",/'(?:\\'|[^'])*'/],["strings",/\/(?:\\\/|[^/])*\/\w*/],["numbers",/-?(?:(?:\b\d*)?\.)?\b\d+\b/],["keywords",/\b(?:break|case|catch|const|continue|debugger|default|delete|do|else|export|finally|for|function|if|import|in|instanceof|let|new|return|super|switch|this|throw|try|typeof|var|void|while|with)\b/],["functions",/(\w+)(?:\s*\()/],["members",/(?:(?:\w+\.)+)(\w+)/]])}(),Primrose.Text.Grammars.PlainText=function(){"use strict";return new Primrose.Text.Grammar("PlainText",[["newlines",/(?:\r\n|\r|\n)/]])}(),Primrose.Text.Grammars.TestResults=function(){"use strict";return new Primrose.Text.Grammar("TestResults",[["newlines",/(?:\r\n|\r|\n)/,!0],["numbers",/(\[)(o+)/,!0],["numbers",/(\d+ succeeded), 0 failed/,!0],["numbers",/^    Successes:/,!0],["functions",/(x+)\]/,!0],["functions",/[1-9]\d* failed/,!0],["functions",/^    Failures:/,!0],["comments",/(\d+ms:)(.*)/,!0],["keywords",/(Test results for )(\w+):/,!0],["strings",/        \w+/,!0]])}(),Primrose.Text.OperatingSystems.OSX=function(){"use strict";return new Primrose.Text.OperatingSystem("OS X","META","ALT","METASHIFT_z","META","LEFTARROW","RIGHTARROW","META","UPARROW","DOWNARROW")}(),Primrose.Text.OperatingSystems.Windows=function(){"use strict";return new Primrose.Text.OperatingSystem("Windows","CTRL","CTRL","CTRL_y","","HOME","END","CTRL","HOME","END")}(),Primrose.Text.Renderers.Canvas=function(){"use strict";return function(a,b){function c(a,b,c,d,e,f){a.fillStyle=b,a.fillRect(c*g.character.width,d*g.character.height,e*g.character.width+1,f*g.character.height+1)}function d(a,b,d,e,f,i){var j=Primrose.Text.Cursor.min(b,d),k=Primrose.Text.Cursor.max(b,d),l=new Primrose.Text.Cursor,m=new Primrose.Text.Cursor,o=p.regular.backColor?"fillRect":"clearRect";p.regular.backColor&&(n.fillStyle=p.regular.backColor),n[o](0,0,h.width,h.height),n.save(),n.translate((e.x-f.x)*g.character.width,-f.y*g.character.height),i&&c(n,p.regular.currentRowBackColor||Primrose.Text.Themes.Default.regular.currentRowBackColor,0,j.y+.2,e.width,k.y-j.y+1);for(var q=0;q<a.length;++q){for(var r=a[q],s=0;s<r.length;++s){var t=r[s];if(m.x+=t.value.length,m.i+=t.value.length,f.y<=q&&q<f.y+e.height&&f.x<=m.x&&l.x<f.x+e.width){var u=j.i<=m.i&&l.i<k.i;if(u){var v=Primrose.Text.Cursor.max(j,l),w=Primrose.Text.Cursor.min(k,m),x=w.i-v.i;c(n,p.regular.selectedBackColor||Primrose.Text.Themes.Default.regular.selectedBackColor,v.x,v.y+.2,x,1)}}l.copy(m)}l.x=0,++l.y,m.copy(l)}if(i){var y=p.cursorColor||"black",z=1/g.character.width;c(n,y,j.x,j.y,z,1),c(n,y,k.x,k.y,z,1)}n.restore()}function e(a,b,c){var d=new Primrose.Text.Cursor,e=new Primrose.Text.Cursor,f=0;m.clearRect(0,0,h.width,h.height),m.save(),m.translate((b.x-c.x)*g.character.width,-c.y*g.character.height);for(var i=0;i<a.length;++i){for(var j=a[i],k=0;k<j.length;++k){var l=j[k];if(e.x+=l.value.length,e.i+=l.value.length,c.y<=i&&i<c.y+b.height&&c.x<=e.x&&d.x<c.x+b.width){var n=p[l.type]||{},o=(n.fontWeight||p.regular.fontWeight||"")+" "+(n.fontStyle||p.regular.fontStyle||"")+" "+g.character.height+"px "+p.fontFamily;m.font=o.trim(),m.fillStyle=n.foreColor||p.regular.foreColor,m.fillText(l.value,d.x*g.character.width,(i+1)*g.character.height)}d.copy(e)}f=Math.max(f,e.x),d.x=0,++d.y,e.copy(d)}return m.restore(),f}function f(a,b,d,e,f,i,j,k){if(o.clearRect(0,0,h.width,h.height),o.save(),o.translate(0,-d.y*g.character.height),e)for(var l=d.y,m=-1;l<d.y+b.height&&l<a.length;++l){for(var n=a[l],q=n.length>0?n[0].line:m+1,r=q.toString();r.length<j;)r=" "+r;c(o,p.regular.selectedBackColor||Primrose.Text.Themes.Default.regular.selectedBackColor,0,l+.2,b.x,1),o.font="bold "+g.character.height+"px "+p.fontFamily,q>m&&(o.fillStyle=p.regular.foreColor,o.fillText(r,0,(l+1)*g.character.height)),m=q}if(o.restore(),f){var s=b.width*g.character.width,t=b.height*g.character.height,u=d.x*s/k+b.x*g.character.width,v=d.y*t/a.length+b.y*g.character.height;if(o.fillStyle=p.regular.selectedBackColor||Primrose.Text.Themes.Default.regular.selectedBackColor,!i&&k>b.width){var w=s*(b.width/k);o.fillRect(u,(b.height+.25)*g.character.height,Math.max(g.character.width,w),g.character.height)}if(a.length>b.height){var x=t*(b.height/a.length);o.fillRect(h.width-g.VSCROLL_WIDTH*g.character.width,v,g.VSCROLL_WIDTH*g.character.width,Math.max(g.character.height,x))}}}var g=this,h=cascadeElement(a,"canvas",window.HTMLCanvasElement),i=cascadeElement(h.id+"-back","canvas",window.HTMLCanvasElement),j=cascadeElement(h.id+"-front","canvas",window.HTMLCanvasElement),k=cascadeElement(h.id+"-trim","canvas",window.HTMLCanvasElement),l=h.getContext("2d"),m=j.getContext("2d"),n=i.getContext("2d"),o=k.getContext("2d"),p=null,q=null,r=null,s=null,t=b.size;this.VSCROLL_WIDTH=2,this.character=new Primrose.Text.Size,this.id=h.id,this.autoBindEvents=!0,this.setTheme=function(a){p=a},this.pixel2cell=function(a,b,c){var d=this.getPixelRatio(),e=a.x*h.width/h.clientWidth,f=a.y*h.height/h.clientHeight;a.set(Math.round(e*d/this.character.width)+b.x-c.x,Math.floor(f*d/this.character.height-.25)+b.y)},this.hasResized=function(){var a=this.getPixelRatio(),b=h.width,c=h.height,d=h.clientWidth*a,e=h.clientHeight*a;return b!==d||c!==e},this.resize=function(){var a=!1;if(p){var b=this.getPixelRatio(),c=this.character.width,d=this.character.height,e=h.width,f=h.height,g=t&&t.width||h.clientWidth*b,m=t&&t.height||h.clientHeight*b,n=l.font;this.character.height=p.fontSize*b,l.font=this.character.height+"px "+p.fontFamily,this.character.width=l.measureText("MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM").width/100,a=c!==this.character.width||d!==this.character.height||n!==l.font,g>0&&m>0&&(i.width=j.width=k.width=h.width=g,i.height=j.height=k.height=h.height=m,a=a||e!==g||f!==g)}return a},this.setSize=function(a,b){return h.style.width=a+"px",h.style.height=b+"px",this.resize()},this.getWidth=function(){return h.width},this.getHeight=function(){return h.height},this.render=function(a,b,c,g,m,n,o,r,s,t){if(p){var u=0;d(a,b,c,g,m,n),u=e(a,g,m),f(a,g,m,o,r,s,t,u),l.clearRect(0,0,h.width,h.height),l.drawImage(i,0,0),l.drawImage(j,0,0),l.drawImage(k,0,0),q&&(q.needsUpdate=!0)}},this.getDOMElement=function(){return h},this.getTexture=function(){return"undefined"==typeof window.THREE||q||(q=new THREE.Texture(h),q.needsUpdate=!0),q},this.getPickingTexture=function(){if(!r){var a=document.createElement("canvas"),b=this.getWidth(),c=this.getHeight();a.width=b,a.height=c;for(var d=a.getContext("2d"),e=d.createImageData(b,c),f=0,g=0,h=b*c;h>f;++f,g+=4)e.data[g]=(16711680&f)>>16,e.data[g+1]=(65280&f)>>8,e.data[g+2]=(255&f)>>0,e.data[g+3]=255;d.putImageData(e,0,0),r=new THREE.Texture(a,THREE.UVMapping,THREE.RepeatWrapping,THREE.RepeatWrapping,THREE.NearestFilter,THREE.NearestMipMapNearestFilter,THREE.RGBAFormat,THREE.UnsignedByteType,0),r.needsUpdate=!0}return r},this.getPixelRatio=function(){return window.devicePixelRatio||1},this.getPixelIndex=function(a,b,c){s||(s=new Uint8Array(4)),a.readPixels(b,c,1,1,a.RGBA,a.UNSIGNED_BYTE,s);var d=s[0]<<16|s[1]<<8|s[2]<<0;return{x:d%h.clientWidth,y:d/h.clientWidth}},a instanceof window.HTMLCanvasElement||!t||(h.style.position="absolute",h.style.width=t.width,h.style.height=t.height),h.parentElement||(this.autoBindEvents=!1,document.body.appendChild(makeHidingContainer("primrose-container-"+h.id,h)))}}(),Primrose.Text.Renderers.DOM=function(){"use strict";function a(a){function c(a){a.style.font=d.font,a.style.lineHeight=px(parseInt(d.font,10)),a.style.padding="0",a.style.margin="0"}var d=this;this.font=null,this.fillStyle=null;var e=[new Point];this.measureText=function(a){var d=document.createElement("div");c(d),d.style.position="absolute",d.style.visibility="hidden",d.innerHTML=a,document.body.appendChild(d);var e=new b(d.clientWidth,d.clientHeight);return document.body.removeChild(d),e},this.clearRect=function(){a.innerHTML=""},this.drawImage=function(b,c,d){var f=e[e.length-1];b.style.position="absolute",b.style.left=px(c+f.x),b.style.top=px(d+f.y),a.appendChild(b)},this.fillRect=function(b,c,d,f){var g=e[e.length-1],h=document.createElement("div");h.style.position="absolute",h.style.left=px(b+g.x),h.style.top=px(c+g.y),h.style.width=px(d),h.style.height=px(f),h.style.backgroundColor=this.fillStyle,a.appendChild(h)},this.fillText=function(b,d,f){var g=e[e.length-1],h=document.createElement("span");h.style.position="absolute",h.style.left=px(d+g.x),h.style.top=px(f+g.y),c(h),h.style.color=this.fillStyle,h.appendChild(document.createTextNode(b)),a.appendChild(h)},this.save=function(){var a=e[e.length-1];e.push(a.clone())},this.restore=function(){e.pop()},this.translate=function(a,b){var c=e[e.length-1];c.x+=a,c.y+=b}}var b=Primrose.Text.Size,c=Primrose.Text.Cursor,d=Primrose.Text.Themes.Default;return window.HTMLDivElement.prototype.getContext=function(b){if("2d"!==b)throw new Exception("type parameter needs to be '2d'.");return this.style.width=pct(100),this.style.height=pct(100),new a(this)},function(a,e){function f(a,b,c,d,e,f){a.fillStyle=b,a.fillRect(c*j.character.width,d*j.character.height,e*j.character.width+1,f*j.character.height+1)}function g(a,b,e,g,h,i){var k=c.min(b,e),m=c.max(b,e),n=new c,o=new c;s.regular.backColor&&(q.fillStyle=s.regular.backColor,l.style.backgroundColor=s.regular.backColor),q.clearRect(0,0,t,u),q.save(),q.translate((g.x-h.x)*j.character.width,-h.y*j.character.height),i&&f(q,s.regular.currentRowBackColor||d.regular.currentRowBackColor,0,k.y+.2,g.width,m.y-k.y+1);for(var p=0;p<a.length;++p){for(var r=a[p],v=0;v<r.length;++v){var w=r[v];if(o.x+=w.value.length,o.i+=w.value.length,h.y<=p&&p<h.y+g.height&&h.x<=o.x&&n.x<h.x+g.width){var x=k.i<=o.i&&n.i<m.i;if(x){var y=c.max(k,n),z=c.min(m,o),A=z.i-y.i;f(q,s.regular.selectedBackColor||d.regular.selectedBackColor,y.x,y.y+.2,A,1)}}n.copy(o)}n.x=0,++n.y,o.copy(n)}if(i){var B=s.cursorColor||"black",C=1/j.character.width;f(q,B,k.x,k.y,C,1),f(q,B,m.x,m.y,C,1)}q.restore()}function h(a,b,d){var e=new c,f=new c,g=0;p.clearRect(0,0,t,u),p.save(),p.translate((b.x-d.x)*j.character.width,-d.y*j.character.height);for(var h=0;h<a.length;++h){for(var i=a[h],k=0;k<i.length;++k){var l=i[k];if(f.x+=l.value.length,f.i+=l.value.length,d.y<=h&&h<d.y+b.height&&d.x<=f.x&&e.x<d.x+b.width){var m=s[l.type]||{},n=(m.fontWeight||s.regular.fontWeight||"")+" "+(m.fontStyle||s.regular.fontStyle||"")+" "+j.character.height+"px "+s.fontFamily;p.font=n.trim(),p.fillStyle=m.foreColor||s.regular.foreColor,p.fillText(l.value,e.x*j.character.width,h*j.character.height)}e.copy(f)}g=Math.max(g,f.x),e.x=0,++e.y,f.copy(e)}return p.restore(),g}function i(a,b,c,e,g,h,i,k){if(r.clearRect(0,0,t,u),r.save(),r.translate(0,-c.y*j.character.height),e)for(var l=c.y,m=-1;l<c.y+b.height&&l<a.length;++l){for(var n=a[l],o=n.length>0?n[0].line:m+1,p=o.toString();p.length<i;)p=" "+p;f(r,s.regular.selectedBackColor||d.regular.selectedBackColor,0,l+.2,b.x,1),r.font="bold "+j.character.height+"px "+s.fontFamily,o>m&&(r.fillStyle=s.regular.foreColor,r.fillText(p,0,l*j.character.height)),m=o}if(r.restore(),g){var q=b.width*j.character.width,v=b.height*j.character.height,w=c.x*q/k+b.x*j.character.width,x=c.y*v/a.length+b.y*j.character.height;if(r.fillStyle=s.regular.selectedBackColor||d.regular.selectedBackColor,!h&&k>b.width){var y=q*(b.width/k);r.fillRect(w,(b.height+.25)*j.character.height,Math.max(j.character.width,y),j.character.height)}if(a.length>b.height){var z=v*(b.height/a.length);r.fillRect(t-j.VSCROLL_WIDTH*j.character.width,x,j.VSCROLL_WIDTH*j.character.width,Math.max(j.character.height,z))}}}var j=this,k=cascadeElement(a,"div",window.HTMLDivElement),l=cascadeElement(k.id+"-back","div",window.HTMLDivElement),m=cascadeElement(k.id+"-front","div",window.HTMLDivElement),n=cascadeElement(k.id+"-trim","div",window.HTMLDivElement),o=k.getContext("2d"),p=m.getContext("2d"),q=l.getContext("2d"),r=n.getContext("2d"),s=null,t=null,u=null;this.VSCROLL_WIDTH=2,this.character=new b,this.id=k.id,this.autoBindEvents=!0,this.setTheme=function(a){s=a},this.pixel2cell=function(a,b,c){a.set(Math.round(a.x/this.character.width)+b.x-c.x,Math.floor(a.y/this.character.height-.25)+b.y)},this.hasResized=function(){var a=k.clientWidth,b=k.clientHeight;return t!==a||u!==b},this.resize=function(){var a=!1;if(s){var b=this.character.width,c=this.character.height,d=k.clientWidth,e=k.clientHeight,f=o.font;this.character.height=s.fontSize,o.font=px(this.character.height)+" "+s.fontFamily,this.character.width=o.measureText("MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM").width/100,a=b!==this.character.width||c!==this.character.height||f!==o.font,d>0&&e>0&&(l.width=m.width=n.width=d,l.height=m.height=n.height=e,a=a||t!==d||u!==d,t=d,u=e)}return a},this.setSize=function(a,b){return k.style.width=px(a),k.style.height=px(b),this.resize()},this.getWidth=function(){return t},this.getHeight=function(){return u},this.render=function(a,b,c,d,e,f,j,k,p,q){var r=0;g(a,b,c,d,e,f),r=h(a,d,e),i(a,d,e,j,k,p,q,r),o.clearRect(0,0,t,u),o.drawImage(l,0,0),o.drawImage(m,0,0),o.drawImage(n,0,0)},this.getDOMElement=function(){return k},this.getPixelRatio=function(){return 1},a instanceof window.HTMLDivElement||!e.width||!e.height||(k.style.position="absolute",k.style.width=e.width,k.style.height=e.height),k.parentElement||(this.autoBindEvents=!1,document.body.appendChild(makeHidingContainer("primrose-container-"+k.id,k)))}},Primrose.Text.Themes.Dark=function(){"use strict";return{name:"Dark",fontFamily:"monospace",cursorColor:"white",fontSize:14,lineNumbers:{foreColor:"white"},regular:{backColor:"black",foreColor:"#c0c0c0",currentRowBackColor:"#202020",selectedBackColor:"#404040"},strings:{foreColor:"#aa9900",fontStyle:"italic"},numbers:{foreColor:"green"},comments:{foreColor:"yellow",fontStyle:"italic"},keywords:{foreColor:"cyan"},functions:{foreColor:"brown",fontWeight:"bold"},members:{foreColor:"green"},error:{foreColor:"red",fontStyle:"underline italic"}}}(),Primrose.Text.Themes.Default=function(){"use strict";return{name:"Light",fontFamily:"monospace",cursorColor:"black",fontSize:14,regular:{backColor:"white",foreColor:"black",currentRowBackColor:"#f0f0f0",selectedBackColor:"#c0c0c0"},strings:{foreColor:"#aa9900",fontStyle:"italic"},numbers:{foreColor:"green"},comments:{foreColor:"grey",fontStyle:"italic"},keywords:{foreColor:"blue"},functions:{foreColor:"brown",fontWeight:"bold"},members:{foreColor:"green"},error:{foreColor:"red",fontStyle:"underline italic"}}}(),Primrose.VERSION="v0.12.3";