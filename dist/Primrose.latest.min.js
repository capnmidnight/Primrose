/*! Primrose 2015-01-12
Copyright (C) 2015 Sean T. McBeth
https://github.com/capnmidnight/Primrose*/
var Keys={};Keys.BACKSPACE=8,Keys.TAB=9,Keys.ENTER=13,Keys.SHIFT=16,Keys.CTRL=17,Keys.ALT=18,Keys.PAUSEBREAK=19,Keys.CAPSLOCK=20,Keys.ESCAPE=27,Keys.SPACEBAR=32,Keys.PAGEUP=33,Keys.PAGEDOWN=34,Keys.END=35,Keys.HOME=36,Keys.LEFTARROW=37,Keys.UPARROW=38,Keys.RIGHTARROW=39,Keys.DOWNARROW=40,Keys.INSERT=45,Keys.DELETE=46,Keys.NUMBER0=48,Keys.NUMBER1=49,Keys.NUMBER2=50,Keys.NUMBER3=51,Keys.NUMBER4=52,Keys.NUMBER5=53,Keys.NUMBER6=54,Keys.NUMBER7=55,Keys.NUMBER8=56,Keys.NUMBER9=57,Keys.A=65,Keys.B=66,Keys.C=67,Keys.D=68,Keys.E=69,Keys.F=70,Keys.G=71,Keys.H=72,Keys.I=73,Keys.J=74,Keys.K=75,Keys.L=76,Keys.M=77,Keys.N=78,Keys.O=79,Keys.P=80,Keys.Q=81,Keys.R=82,Keys.S=83,Keys.T=84,Keys.U=85,Keys.V=86,Keys.W=87,Keys.X=88,Keys.Y=89,Keys.Z=90,Keys.LEFTWINDOWKEY=91,Keys.RIGHTWINDOWKEY=92,Keys.SELECTKEY=93,Keys.NUMPAD0=96,Keys.NUMPAD1=97,Keys.NUMPAD2=98,Keys.NUMPAD3=99,Keys.NUMPAD4=100,Keys.NUMPAD5=101,Keys.NUMPAD6=102,Keys.NUMPAD7=103,Keys.NUMPAD8=104,Keys.NUMPAD9=105,Keys.MULTIPLY=106,Keys.ADD=107,Keys.SUBTRACT=109,Keys.DECIMALPOINT=110,Keys.DIVIDE=111,Keys.F1=112,Keys.F2=113,Keys.F3=114,Keys.F4=115,Keys.F5=116,Keys.F6=117,Keys.F7=118,Keys.F8=119,Keys.F9=120,Keys.F10=121,Keys.F11=122,Keys.F12=123,Keys.NUMLOCK=144,Keys.SCROLLLOCK=145,Keys.SEMICOLON=186,Keys.EQUALSIGN=187,Keys.COMMA=188,Keys.DASH=189,Keys.PERIOD=190,Keys.FORWARDSLASH=191,Keys.GRAVEACCENT=192,Keys.OPENBRACKET=219,Keys.BACKSLASH=220,Keys.CLOSEBRACKET=221,Keys.SINGLEQUOTE=222,CodePages={};;var Commands={};Commands["NORMAL"+Keys.LEFTARROW]=function(a,b){b.left(a),this.scrollIntoView(b)},Commands["CTRL"+Keys.LEFTARROW]=function(a,b){b.skipLeft(a),this.scrollIntoView(b)},Commands["NORMAL"+Keys.RIGHTARROW]=function(a,b){b.right(a),this.scrollIntoView(b)},Commands["CTRL"+Keys.RIGHTARROW]=function(a,b){b.skipRight(a),this.scrollIntoView(b)},Commands["NORMAL"+Keys.UPARROW]=function(a,b){b.up(a),this.scrollIntoView(b)},Commands["NORMAL"+Keys.DOWNARROW]=function(a,b){b.down(a),this.scrollIntoView(b)},Commands["NORMAL"+Keys.HOME]=function(a,b){b.home(a),this.scrollIntoView(b)},Commands["CTRL"+Keys.HOME]=function(a,b){b.fullHome(a),this.scrollIntoView(b)},Commands["NORMAL"+Keys.END]=function(a,b){b.end(a),this.scrollIntoView(b)},Commands["CTRL"+Keys.END]=function(a,b){b.fullEnd(a),this.scrollIntoView(b)},Commands["CTRL"+Keys.DOWNARROW]=function(a){this.scrollTop<a.length&&++this.scrollTop},Commands["CTRL"+Keys.UPARROW]=function(){this.scrollTop>0&&--this.scrollTop},Commands["NORMAL"+Keys.PAGEUP]=function(a,b){b.incY(-this.pageSize,a),this.scrollIntoView(b)},Commands["NORMAL"+Keys.PAGEDOWN]=function(a,b){b.incY(this.pageSize,a),this.scrollIntoView(b)},Commands["CTRL"+Keys.DASH]=function(a,b){this.decreaseFontSize(),this.scrollIntoView(b)},Commands["CTRL"+Keys.EQUALSIGN]=function(a,b){this.increaseFontSize(),this.scrollIntoView(b)},Commands["NORMAL"+Keys.BACKSPACE]=function(a,b){this.frontCursor.i===this.backCursor.i&&this.frontCursor.left(a),this.deleteSelection(),this.scrollIntoView(b)},Commands["SHIFT"+Keys.DELETE]=function(a,b){this.frontCursor.i===this.backCursor.i&&(this.frontCursor.home(a),this.backCursor.end(a)),this.deleteSelection(),this.scrollIntoView(b)},Commands["NORMAL"+Keys.DELETE]=function(a,b){this.frontCursor.i===this.backCursor.i&&this.backCursor.right(a),this.deleteSelection(),this.scrollIntoView(b)},Commands["NORMAL"+Keys.ENTER]=function(a,b){for(var c="",d=0;d<a[this.frontCursor.y].length&&" "===a[this.frontCursor.y][d];++d)c+=" ";this.insertAtCursor("\n"+c),this.scrollIntoView(b)},Commands["NORMAL"+Keys.TAB]=function(a,b){if(this.frontCursor.y===this.backCursor.y)this.insertAtCursor(this.tabString);else{var c=this.getMinCursor(),d=this.getMaxCursor();c.home(a),d.end(a);for(var e=c.y;e<=d.y;++e)a[e]=this.tabString+a[e];c.setXY(0,c.y,a),d.setXY(0,d.y,a),d.end(a),this.pushUndo(a)}this.scrollIntoView(b)},Commands["SHIFT"+Keys.TAB]=function(a,b){if(this.frontCursor.y!==this.backCursor.y){var c=this.getMinCursor(),d=this.getMaxCursor();c.home(a),d.end(a);for(var e=c.y;e<=d.y;++e)a[e].substring(0,this.tabWidth)===this.tabString&&(a[e]=a[e].substring(this.tabWidth));c.setXY(0,c.y,a),d.setXY(0,d.y,a),d.end(a),this.pushUndo(a)}this.scrollIntoView(b)},Commands.CTRL_a=function(a){this.frontCursor.fullHome(a),this.backCursor.fullEnd(a)},Commands.CTRL_y=function(a,b){this.redo(),this.scrollIntoView(b)},Commands.CTRL_z=function(a,b){this.undo(),this.scrollIntoView(b)};;function Cursor(a,b,c){this.i=a||0,this.x=b||0,this.y=c||0,this.moved=!1}Cursor.min=function(a,b){return a.i<=b.i?a:b},Cursor.max=function(a,b){return a.i>b.i?a:b},Cursor.prototype.toString=function(){return fmt("[i:$1 x:$2 y:$3]",this.i,this.x,this.y)},Cursor.prototype.copy=function(a){this.i=a.i,this.x=a.x,this.y=a.y,this.moved=!1},Cursor.prototype.rectify=function(a){this.y>=a.length&&(this.y=a.length-1),this.x>a[this.y].length&&(this.x=a[this.y].length)},Cursor.prototype.left=function(a){this.i>0&&(--this.i,--this.x,this.x<0&&(--this.y,this.x=a[this.y].length)),this.moved=!0},Cursor.prototype.skipLeft=function(a){if(0===this.x)this.left(a);else{var b=this.x-1,c=reverse(a[this.y].substring(0,b)),d=c.match(/(\s|\W)+/),e=d?d.index+d[0].length+1:c.length+1;this.i-=e,this.x-=e}this.moved=!0},Cursor.prototype.right=function(a){(this.y<a.length-1||this.x<a[this.y].length)&&(++this.i,++this.x,this.x>a[this.y].length&&(this.x=0,++this.y)),this.moved=!0},Cursor.prototype.skipRight=function(a){if(this.x===a[this.y].length)this.right(a);else{var b=this.x+1,c=a[this.y].substring(b),d=c.match(/(\s|\W)+/),e=d?d.index+d[0].length+1:c.length-this.x;this.i+=e,this.x+=e}this.moved=!0},Cursor.prototype.home=function(){this.i-=this.x,this.x=0,this.moved=!0},Cursor.prototype.fullHome=function(){this.i=0,this.x=0,this.y=0,this.moved=!0},Cursor.prototype.end=function(a){var b=a[this.y].length-this.x;this.i+=b,this.x+=b,this.moved=!0},Cursor.prototype.fullEnd=function(a){for(this.i+=a[this.y].length-this.x;this.y<a.length-1;)++this.y,this.i+=a[this.y].length+1;this.x=a[this.y].length,this.moved=!0},Cursor.prototype.up=function(a){if(this.y>0){--this.y;var b=Math.min(0,a[this.y].length-this.x);this.x+=b,this.i-=a[this.y].length+1-b}this.moved=!0},Cursor.prototype.down=function(a){if(this.y<a.length-1){++this.y;var b=Math.min(0,a[this.y].length-this.x);this.x+=b,this.i+=a[this.y-1].length+1+b}this.moved=!0},Cursor.prototype.setXY=function(a,b,c){this.y=Math.max(0,Math.min(c.length-1,b)),this.x=Math.max(0,Math.min(c[this.y].length,a)),this.i=this.x;for(var d=0;d<this.y;++d)this.i+=c[d].length+1;this.moved=!0},Cursor.prototype.incY=function(a,b){this.y=Math.max(0,Math.min(b.length-1,this.y+a)),this.x=Math.max(0,Math.min(b[this.y].length,this.x)),this.i=this.x;for(var c=0;c<this.y;++c)this.i+=b[c].length+1;this.moved=!0};;function Grammar(a){this.grammar=a.map(function(a){return new Rule(a[0],a[1])})}function Rule(a,b){this.name=a,this.test=b}function Token(a,b){this.value=a,this.type=b}Grammar.prototype.tokenize=function(a){for(var b=[a],c=0;c<this.grammar.length;++c)for(var d=this.grammar[c],e=0;e<b.length;++e){var f=b[e];if(!(f instanceof Token)){var g=d.test.exec(b[e]);if(g){var h=g[g.length-1],i=g.index;2===g.length&&(i+=g[0].indexOf(h));var j=new Token(h,d.name);b.splice(e+1,0,j);var k=i+h.length;if(k<f.length){var l=f.substring(k);b.splice(e+2,0,l)}i>0?(b[e]=f.substring(0,i),++e):b.splice(e,1)}}}var m=!1;for(c=0;c<b.length;++c){var n=b[c];n instanceof Token||(b[c]=n=new Token(n,"regular")),m?("endBlockComments"===n.type&&(m=!1),"newlines"!==n.type&&(n.type="comments")):"startBlockComments"===n.type?(m=!0,n.type="comments"):"inlineComments"===n.type?n.type="comments":/^strings\d+/.test(n.type)&&(n.type="strings")}return b},Grammar.JavaScript=new Grammar([["newlines",/(?:\r\n|\r|\n)/],["inlineComments",/\/\/.+$/],["startBlockComments",/\/\*/],["endBlockComments",/\*\//],["strings1",/"(?:\\"|[^"]*)"/],["strings2",/'(?:\\'|[^']*)'/],["numbers",/\b(?:\d*\.)?\d+\b/],["keywords",/\b(?:break|case|catch|const|continue|debugger|default|delete|do|else|export|finally|for|function|if|import|in|instanceof|let|new|return|super|switch|this|throw|try|typeof|var|void|while|with)\b/],["functions",/(\w+)(?:\s*\()/],["members",/(?:(?:\w+\.)+)(\w+)/]]),Grammar.tests={captureOnlyAGroup:function(){var a='function(){ a.b.c = "asdf"; }',b=Grammar.JavaScript.tokenize(a),c=b.map(function(a){return a.value}).join("");Assert.areEqual(a,c),Assert.areEqual("c",b[2].value,"token isn't right value"),Assert.areEqual("members",b[2].type,"token types do not match")},aSimpleString:function(){var a='"a"',b=Grammar.JavaScript.tokenize(a),c=b.map(function(a){return a.value}).join("");Assert.areEqual(a,c),Assert.areEqual("strings",b[0].type,"token types do not match")},twoStrings:function(){var a='"a" b "c"',b=Grammar.JavaScript.tokenize(a),c=b.map(function(a){return a.value}).join("");Assert.areEqual(a,c),Assert.areEqual("strings",b[0].type,"0: token incorrect type"),Assert.areEqual("regular",b[1].type,"1: token incorrect type"),Assert.areEqual("strings",b[2].type,"2: token incorrect type")},singleLineBlockComment:function(){var a="/* asdf one 2 three 4 */",b=Grammar.JavaScript.tokenize(a),c=b.map(function(a){return a.value}).join("");Assert.areEqual(a,c),Assert.areEqual("comments",b[0].type,"token types do not match")},multiLineBlockComment:function(){var a="/*\n asdf one\n2 three 4\n*/",b=Grammar.JavaScript.tokenize(a),c=b.map(function(a){return a.value}).join("");Assert.areEqual(a,c),Assert.areEqual("comments",b[0].type,"token types do not match")},multipleMultiLineBlockComment:function(){var a="/*\n asdf one\n2 three 4\n*/\nfunction(){\n/*\n asdf one\n2 three 4\n*/\n}",b=Grammar.JavaScript.tokenize(a),c=b.map(function(a){return a.value}).join("");Assert.areEqual(a,c),Assert.areEqual("comments",b[0].type,"0: token types do not match"),Assert.areEqual("comments",b[4].type,"4: token types do not match."+b[5].value)},bigTest:function(){var a='function Hello (){\n    // a comment\n    function MyFunc ( ) {\n        var x = "Whatever";\n        console.log(x + " World");\n        /*\n          a longer comment\n        */\n    }\n}',b=Grammar.JavaScript.tokenize(a),c=b.map(function(a){return a.value}).join("");Assert.areEqual(a,c)}};;var Keys={MODIFIER_KEYS:["CTRL","ALT","SHIFT"],BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSEBREAK:19,CAPSLOCK:20,ESCAPE:27,SPACEBAR:32,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFTARROW:37,UPARROW:38,RIGHTARROW:39,DOWNARROW:40,INSERT:45,DELETE:46,NUMBER0:48,NUMBER1:49,NUMBER2:50,NUMBER3:51,NUMBER4:52,NUMBER5:53,NUMBER6:54,NUMBER7:55,NUMBER8:56,NUMBER9:57,LEFTWINDOWKEY:91,RIGHTWINDOWKEY:92,SELECTKEY:93,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMALPOINT:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUMLOCK:144,SCROLLLOCK:145,SEMICOLON:186,EQUALSIGN:187,COMMA:188,DASH:189,PERIOD:190,FORWARDSLASH:191,GRAVEACCENT:192,OPENBRACKET:219,BACKSLASH:220,CLOSEBRACKET:221,SINGLEQUOTE:222};CodePages={};;function Primrose(a,b){function c(a,b,c){var d=a-b,e=a-c+1,f=0;return d>=0&&0>e||(f=Math.abs(d)<Math.abs(e)?d:e),f}function d(a){var b=a.clipboardData.types.indexOf("text/plain");if(0>b)for(b=0;b<a.clipboardData.types.length&&!/^text/.test(a.clipboardData.types[b]);++b);if(b>=0){var c=a.clipboardData.types[b],d=a.clipboardData.getData(c);a.preventDefault(),this.pasteAtCursor(d)}}function e(){var a=this.getPixelRatio();this.characterHeight=z*a,console.log(k.clientWidth,k.clientHeight),k.width=k.clientWidth*a,k.height=k.clientHeight*a,l.font=this.characterHeight+"px "+A.fontFamily,this.characterWidth=l.measureText("MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM").width/100,this.drawText()}function f(a,b){var c=this.getLines(),d=this.pixel2cell(b.layerX,b.layerY);a.setXY(d.x,d.y,c)}b=b||{},this.keyboardSelect=cascadeElement("primrose-keyboard-language-selector","select",HTMLSelectElement),this.themeSelect=cascadeElement("primrose-keyboard-language-selector","select",HTMLSelectElement);var g=b.languageGrammar||Grammar.JavaScript;this.setLanguageGrammar=function(a){g=a};var h;this.setCodePage=function(a){var b=navigator.userLanguage||navigator.languages[0];if(h=a,void 0===h)for(var c in CodePages)if(a=CodePages[c],a.language===b){h=a;break}for(var d in h){var e=h[d];for(var f in e){var g=d+"_"+h.NORMAL[f];Commands[g]=this.insertAtCursor.bind(this,e[f])}}},this.setCodePage(b.codePage),makeSelectorFromObj(this.keyboardSelect,CodePages,h.name,this,"setCodePage");var i=[],j=-1;this.getLines=function(){return i[j].slice()},this.pushUndo=function(a){j<i.length-1&&i.splice(j+1),i.push(a),j=i.length-1},this.redo=function(){j<i.length-1&&++j},this.undo=function(){j>0&&--j},this.setText(b.file||""),this.frontCursor=new Cursor,this.backCursor=new Cursor;var k=cascadeElement(a,"canvas",HTMLCanvasElement),l=k.getContext("2d"),m=!1;this.scrollTop=0,this.scrollLeft=0,this.gridLeft=0;var n=1,o=1,p=1,q=0,r=0;this.pageSize=0,this.tabWidth=b.tabWidth||4,this.tabString="";for(var s=0;s<this.tabWidth;++s)this.tabString+=" ";var t=cascadeElement("primrose-surrogate-textarea","textarea",HTMLTextAreaElement);t.style.position="absolute",t.style.left=k.offsetLeft+"px",t.style.top=k.offsetTop+"px",t.style.width=k.offsetWidth+"px",t.style.height=k.offsetHeigth+"px";var u=cascadeElement("primrose-surrogate-textarea-container","div",HTMLDivElement);u.style.position="absolute",u.style.left=0,u.style.top=0,u.style.width=0,u.style.height=0,u.style.overflow="hidden",k.parentElement&&(k.parentElement.insertBefore(u,k),u.appendChild(t));var v=b.keyEventSource||t,w=b.clipboardEventSource||t,x=b.mouseEventSource||k,y={};for(s=0;s<Keys.MODIFIER_KEYS.length;++s)Keys.MODIFIER_KEYS[s]={name:Keys.MODIFIER_KEYS[s],flag:Keys.MODIFIER_KEYS[s].toLowerCase()+"Key",index:Keys[Keys.MODIFIER_KEYS[s]]},y[Keys.MODIFIER_KEYS[s].index]=0;this.editText=function(a){a=a||event;var b=a.keyCode;if(void 0!==y[b])y[b]|=a.location||1;else{for(var c="",d=0;d<Keys.MODIFIER_KEYS.length;++d){var e=Keys.MODIFIER_KEYS[d];a[e.flag]||(y[e.index]=0),c+=e.name+y[e.index]}console.log(c);var f=(a.ctrlKey&&"CTRL"||"")+(a.altKey&&"ALT"||""),g=f+(a.shiftKey&&"SHIFT"||"")||"NORMAL";f=f||"NORMAL";var i=f+b,j=g+b,k=g+"_"+h.NORMAL[b],l=Commands[j]||Commands[i]||Commands[k];if(l){this.frontCursor.moved=!1,this.backCursor.moved=!1;var m=a.shiftKey?this.backCursor:this.frontCursor,n=this.getLines();l.call(this,n,m),n=this.getLines(),this.frontCursor.moved&&!this.backCursor.moved&&this.backCursor.copy(this.frontCursor),this.frontCursor.rectify(n),this.backCursor.rectify(n),a.preventDefault()}else console.log(g,b)}this.drawText()},v.addEventListener("keydown",this.editText.bind(this)),v.addEventListener("keyup",function(a){var b=a.keyCode,c=y[b],d=a.location||1;void 0!==c&&0!==(c&d)&&(y[b]-=d)}.bind(this)),this.scrollIntoView=function(a){this.scrollTop+=c(a.y,this.scrollTop,this.scrollTop+r),this.scrollLeft+=c(a.x,this.scrollLeft,this.scrollLeft+q)},this.drawText=function(){var a,b=A.regular.backColor?"fillRect":"clearRect";A.regular.backColor&&(l.fillStyle=A.regular.backColor),l[b](0,0,l.canvas.width,l.canvas.height);for(var c=g.tokenize(this.getText()),d=[[]],e=0;e<c.length;++e)a=c[e],d[d.length-1].push(a),"newlines"===a.type&&d.push([]);var f=Math.max(1,Math.ceil(Math.log(d.length)/Math.LN10));this.gridLeft=f+n,q=Math.floor(k.width/this.characterWidth)-this.gridLeft-o;var h=this.scrollLeft+q;r=Math.floor(k.height/this.characterHeight)-p,this.pageSize=Math.floor(r);for(var i=Cursor.min(this.frontCursor,this.backCursor),j=Cursor.max(this.frontCursor,this.backCursor),m=new Cursor,s=new Cursor,t=0,u=0;u<d.length;++u){for(var v=d[u],w=0;w<v.length;++w){a=v[w];var x=a.value;if(s.x+=x.length,s.i+=x.length,this.scrollTop<=u&&u<this.scrollTop+r&&this.scrollLeft<=s.x&&m.x<h){if(i.i<=s.i&&m.i<j.i){var y=Cursor.max(i,m),z=Cursor.min(j,s),B=z.i-y.i;l.fillStyle=A.regular.selectedBackColor||Themes.DEFAULT.regular.selectedBackColor,l.fillRect((y.x-this.scrollLeft+this.gridLeft)*this.characterWidth,(y.y-this.scrollTop+.2)*this.characterHeight,B*this.characterWidth,this.characterHeight)}var C=A[a.type]||{},D=(C.fontWeight||A.regular.fontWeight||"")+" "+(C.fontStyle||A.regular.fontStyle||"")+" "+this.characterHeight+"px "+A.fontFamily;l.font=D.trim(),l.fillStyle=C.foreColor||A.regular.foreColor,l.fillText(x,(m.x-this.scrollLeft+this.gridLeft)*this.characterWidth,(m.y-this.scrollTop+1)*this.characterHeight)}m.copy(s)}if(this.scrollTop<=u&&u<this.scrollTop+r){for(var E=u.toString();E.length<f;)E=" "+E;l.fillStyle=A.regular.selectedBackColor||Themes.DEFAULT.regular.selectedBackColor,l.fillRect(0,(u-this.scrollTop+.2)*this.characterHeight,(E.length+n)*this.characterWidth,this.characterHeight),l.font="bold "+this.characterHeight+"px "+A.fontFamily,l.fillStyle=A.regular.foreColor,l.fillText(E,0,(u-this.scrollTop+1)*this.characterHeight)}t=Math.max(t,s.x),m.x=0,++m.y,s.copy(m)}l.beginPath(),l.strokeStyle=A.cursorColor||"black",l.moveTo((this.frontCursor.x-this.scrollLeft+this.gridLeft)*this.characterWidth,(this.frontCursor.y-this.scrollTop)*this.characterHeight),l.lineTo((this.frontCursor.x-this.scrollLeft+this.gridLeft)*this.characterWidth,(this.frontCursor.y-this.scrollTop+1.25)*this.characterHeight),l.moveTo((this.backCursor.x-this.scrollLeft+this.gridLeft)*this.characterWidth+1,(this.backCursor.y-this.scrollTop)*this.characterHeight),l.lineTo((this.backCursor.x-this.scrollLeft+this.gridLeft)*this.characterWidth+1,(this.backCursor.y-this.scrollTop+1.25)*this.characterHeight),l.stroke();var F=this.scrollTop*k.height/d.length,G=r*k.height/d.length-p*this.characterHeight;l.fillStyle=A.regular.selectedBackColor||Themes.DEFAULT.regular.selectedBackColor,l.fillRect(k.width-this.characterWidth,F,this.characterWidth,G);var H=this.scrollLeft*k.width/t+this.gridLeft*this.characterWidth,I=q*k.width/t-(this.gridLeft+o)*this.characterWidth;l.fillStyle=A.regular.selectedBackColor||Themes.DEFAULT.regular.selectedBackColor,l.fillRect(H,r*this.characterHeight,I,this.characterWidth)},window.addEventListener("resize",e.bind(this));var z=b.fontSize||14;this.setFontSize=function(a){z=a,e.call(this)},this.increaseFontSize=function(){++z,e.call(this)},this.decreaseFontSize=function(){z>1&&(--z,e.call(this))};var A=null;this.setTheme=function(a){A=a||Themes.DEFAULT,e.call(this)},this.setTheme(b.theme),makeSelectorFromObj(this.themeSelect,Themes,A.name,this,"setTheme"),w.addEventListener("copy",this.copySelectedText.bind(this)),w.addEventListener("cut",this.cutSelectedText.bind(this)),w.addEventListener("paste",d.bind(this)),x.addEventListener("wheel",function(a){this.scrollTop+=Math.floor(a.deltaY/this.characterHeight),this.scrollTop<0&&(this.scrollTop=0),a.preventDefault(),this.drawText()}.bind(this)),x.addEventListener("mousedown",function(a){0===a.button&&(f.call(this,this.frontCursor,a),this.backCursor.copy(this.frontCursor),m=!0,this.drawText())}.bind(this)),x.addEventListener("mouseup",function(a){0===a.button&&(m=!1),t.focus()}.bind(this)),x.addEventListener("mousemove",function(a){m&&(f.call(this,this.backCursor,a),this.drawText())}.bind(this))}Primrose.prototype.getText=function(){return this.getLines().join("\n")},Primrose.prototype.setText=function(a){a=a.replace(/\r\n/g,"\n");var b=a.split("\n");this.pushUndo(b),this.drawText&&this.drawText()},Primrose.prototype.pixel2cell=function(a,b){var c=this.getPixelRatio();return a=Math.floor(a*c/this.characterWidth)+this.scrollLeft-this.gridLeft,b=Math.floor(b*c/this.characterHeight-.25)+this.scrollTop,{x:a,y:b}},Primrose.prototype.cell2i=function(a,b){for(var c=this.getLines(),d=0,e=0;b>e;++e)d+=c[e].length+1;return d+=a},Primrose.prototype.i2cell=function(a){for(var b=this.getLines(),c=0;c<b.length;++c){if(a<=b.length)return{x:a,y:c};a-=b.length-1}},Primrose.prototype.getPixelRatio=function(){return window.devicePixelRatio||1},Primrose.prototype.deleteSelection=function(){if(this.frontCursor.i!==this.backCursor.i){var a=Cursor.min(this.frontCursor,this.backCursor),b=Cursor.max(this.frontCursor,this.backCursor),c=this.getLines(),d=c.join("\n"),e=d.substring(0,a.i),f=d.substring(b.i);d=e+f,this.setText(d),b.copy(a)}},Primrose.prototype.insertAtCursor=function(a){if(a.length>0){a=a.replace(/\r\n/g,"\n"),this.deleteSelection();var b=this.getLines(),c=a.split("\n");c[0]=b[this.frontCursor.y].substring(0,this.frontCursor.x)+c[0],c[c.length-1]+=b[this.frontCursor.y].substring(this.frontCursor.x),b.splice.bind(b,this.frontCursor.y,1).apply(b,c);for(var d=0;d<a.length;++d)this.frontCursor.right(b);this.backCursor.copy(this.frontCursor),this.scrollIntoView(this.frontCursor),this.pushUndo(b)}},Primrose.prototype.pasteAtCursor=function(a){this.insertAtCursor(a),this.drawText()},Primrose.prototype["export"]=function(){return this.getLines().map(function(a){return'"'+a.replace(/"/g,'\\"')+'\\n"'}).join("\n+ ")},Primrose.prototype.copySelectedText=function(a){if(this.frontCursor.i!==this.backCursor.i){var b=Cursor.min(this.frontCursor,this.backCursor),c=Cursor.max(this.frontCursor,this.backCursor),d=this.getLines(),e=d.join("\n"),f=e.substring(b.i,c.i);a.clipboardData.setData("text/plain",f)}a.preventDefault()},Primrose.prototype.cutSelectedText=function(a){this.copySelectedText(a),this.deleteSelection(),this.drawText()};;var Themes={DEFAULT:{name:"DEFAULT",fontFamily:"monospace",cursorColor:"black",regular:{foreColor:"black",selectedBackColor:"#c0c0c0",selectedForeColor:"#000000"},strings:{foreColor:"#aa9900",fontStyle:"italic"},numbers:{foreColor:"green"},comments:{foreColor:"grey",fontStyle:"italic"},keywords:{foreColor:"blue"},functions:{foreColor:"brown",fontWeight:"bold"},members:{foreColor:"green"},error:{foreColor:"red",fontStyle:"underline italic"}},Dark:{name:"Dark",fontFamily:"monospace",cursorColor:"white",regular:{backColor:"black",foreColor:"#c0c0c0",selectedBackColor:"#404040",selectedForeColor:"#ffffff"},strings:{foreColor:"#aa9900",fontStyle:"italic"},numbers:{foreColor:"green"},comments:{foreColor:"yellow",fontStyle:"italic"},keywords:{foreColor:"cyan"},functions:{foreColor:"brown",fontWeight:"bold"},members:{foreColor:"green"},error:{foreColor:"red",fontStyle:"underline italic"}}};;CodePages.EN_UKX={name:"EN_UKX",language:"en-GB",NORMAL:{32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"'",219:"[",221:"]",222:"#",223:"`"},SHIFT:{32:" ",48:")",49:"!",50:'"',51:"£",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"@",219:"{",221:"}",222:"~",223:"¬"},CTRLALT:{52:"€",65:"á",69:"é",73:"í",79:"ó",85:"ú",222:"\\",223:"¦"}};;CodePages.EN_US={name:"EN_US",language:"en-US",NORMAL:{32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},SHIFT:{32:" ",48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",106:"*",107:"+",109:"-",110:".",111:"/",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"~",219:"{",220:"|",221:"}",222:'"'}};;function GET(a,b,c,d,e){b=b||"text";var f=new XMLHttpRequest;f.open("GET",a),f.responseType=b,f.onerror=d,f.onabort=d,f.onprogress=c,f.onload=function(){f.status<400?e(f.response):d()},f.send()}function getObject(a,b,c,d){GET(a,"json",d&&c&&b,d&&c||c&&b,d||c||b)}function makeURL(a,b){var c=[];for(var d in b)c.push(encodeURIComponent(d)+"="+encodeURIComponent(b[d]));return a+"?"+c.join("&")}function XXX(a,b){return new Error(fmt("$1. Was given $2$3$2",a,b?'"':"",b))}function E(a,b,c){if(!a||!a.addEventListener)throw XXX("must supply an element with an addEventListener method",a);if(!b||"string"!=typeof b)throw XXX("must provide the name of an event",b);c||(c=console.log.bind(console,fmt("$1.$2",a.tagName,b))),a.addEventListener(b,c)}function arr(a,b,c){return Array.prototype.slice.call(a,b,c)}function map(a,b){return Array.prototype.map.call(a,b)}function reduce(a,b,c){return Array.prototype.reduce.call(a,b,c)}function filter(a,b){return Array.prototype.filter.call(a,b)}function ofType(a,b){return"function"==typeof b?filter(a,function(a){return a instanceof b}):filter(a,function(a){return typeof a===b})}function agg(a,b,c){return"function"!=typeof b&&(b=function(a,b){return b[a]}.bind(window,b)),a.map(b).reduce(c)}function add(a,b){return a+b}function sum(a,b){return agg(a,b,add)}function group(a,b,c){var d=[],e=a.slice();e.sort(function(a,c){var d=b?b(a):a,e=b?b(c):c;return e>d?-1:d>e?1:0});for(var f=0;f<e.length;++f){var g=e[f],h=b?b(g):g,i=c?c(g):g;(0===d.length||d[d.length-1].key!==h)&&d.push({key:h,values:[]}),d[d.length-1].values.push(i)}return d}function help(a){var b={},c={},d=[];if(a){for(var e in a)0!==e.indexOf("on")||a===navigator&&"onLine"===e?"function"==typeof a[e]?b[e]=a[e]:c[e]=a[e]:d.push(e.substring(2));var f=typeof a;if("function"===f)f=a.toString().match(/(function [^(]*)/)[1];else if("object"===f)if(f=null,a.constructor&&a.constructor.name)f=a.constructor.name;else{for(var g=[{prefix:"",obj:window}],h=[];g.length>0&&null===f;){var i=g.shift();i.___traversed___=!0,h.push(i);for(e in i.obj){var j=i.obj[e];if(j)if("function"==typeof j){if(j.prototype&&a instanceof j){f=i.prefix+e;break}}else j.___tried___||g.push({prefix:i.prefix+e+".",obj:j})}}h.forEach(function(a){delete a.___traversed___})}return a={type:f,events:d,functions:b,properties:c},console.debug(a),a}console.warn("Object was falsey.")}function cascadeElement(a,b,c){var d=null;if(null===a?d=document.createElement(b):void 0===c||a instanceof c?d=a:"string"==typeof a&&(d=document.getElementById(a),null===d?(d=document.createElement(b),d.id=a):d.tagName!==b.toUpperCase()&&(d=null)),null===d)throw new Error(a+" does not refer to a valid "+b+" element.");return d.innerHTML="",d}function fmt(a){var b=/\$(0*)(\d+)(?:\.(0+))?/g,c=arguments;return a.replace(b,function(a,b,d,e){if(d=parseInt(d,10),d>=0&&d<c.length){var f=c[d];if(null!==f&&void 0!==f){if(f instanceof Date&&e){switch(e.length){case 1:f=f.getYear();break;case 2:f=f.getMonth()+1+"/"+f.getYear();break;case 3:f=f.toLocaleDateString();break;case 4:f=fmt.addMillis(f,f.toLocaleTimeString());break;case 5:case 6:f=f.toLocaleString();break;default:f=fmt.addMillis(f,f.toLocaleString())}return f}if(f=e&&e.length>0?sigfig(f,e.length):f.toString(),b&&b.length>0)for(var g=new RegExp("^\\d{"+(b.length+1)+"}(\\.\\d+)?");!g.test(f);)f="0"+f;return f}}return void 0})}function sigfig(a,b){var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();if(b>0){var e=d.indexOf(".");for(-1===e&&(d+=".",e=d.length-1);d.length-e-1<b;)d+="0"}return d}function findEverything(a,b){a=a||document,b=b||{};for(var c=a.querySelectorAll("*"),d=0;d<c.length;++d){var e=c[d];e.id&&e.id.length>0&&(b[e.id]=e,e.parentElement&&(e.parentElement[e.id]=e))}return b}function inherit(a,b){a.prototype=Object.create(b.prototype),a.prototype.constructor=a}function getSetting(a,b){if(window.localStorage){var c=window.localStorage.getItem(a);if(c)try{return JSON.parse(c)}catch(d){console.error("getSetting",a,c,typeof c,d)}}return b}function setSetting(a,b){if(window.localStorage&&b)try{window.localStorage.setItem(a,JSON.stringify(b))}catch(c){console.error("setSetting",a,b,typeof b,c)}}function deleteSetting(a){window.localStorage&&window.localStorage.removeItem(a)}function readForm(a){var b={};if(a)for(var c in a){var d=a[c];"INPUT"!==d.tagName&&"SELECT"!==d.tagName||d.dataset&&d.dataset.skipcache||("text"===d.type||"password"===d.type||"SELECT"===d.tagName?b[c]=d.value:("checkbox"===d.type||"radio"===d.type)&&(b[c]=d.checked))}return b}function writeForm(a,b){if(b)for(var c in a){var d=a[c];null===b[c]||void 0===b[c]||"INPUT"!==d.tagName&&"SELECT"!==d.tagName||d.dataset&&d.dataset.skipcache||("text"===d.type||"password"===d.type||"SELECT"===d.tagName?d.value=b[c]:("checkbox"===d.type||"radio"===d.type)&&(d.checked=b[c]))}}function reloadPage(){document.location=document.location.href}function makeSelectorFromObj(a,b,c,d,e){for(var f in b)if(b.hasOwnProperty(f)){var g=document.createElement("option");g.innerHTML=f,f===c&&(g.selected="selected"),a.appendChild(g)}E(a,"change",function(){d[e](b[this.value])})}function isFullScreenMode(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function requestFullScreen(a){if(isFullScreenMode())a&&a();else{document.documentElement.requestFullscreen();var b=setInterval(function(){isFullScreenMode()&&(clearInterval(b),screen.lockOrientation("landscape-primary"),a&&a())},1e3)}}function exitFullScreen(){isFullScreenMode()&&document.exitFullscreen()}function toggleFullScreen(){document.documentElement.requestFullscreen&&(isFullScreenMode()?exitFullScreen():requestFullScreen())}function addFullScreenShim(){function a(){c.forEach(function(a){a.events.forEach(function(c){a.elem.removeEventListener(c,b)})})}function b(){requestFullScreen(a)}var c=arr(arguments);c=c.map(function(a){return{elem:a,events:help(a).events}}),c.forEach(function(a){a.events.forEach(function(c){c.indexOf("fullscreenerror")<0&&a.elem.addEventListener(c,b,!1)})})}var reverse=function(a){a=a.replace(reverse.combiningMarks,function(a,b,c){return reverse(c)+b}).replace(reverse.surrogatePair,"$2$1");for(var b="",c=a.length-1;c>=0;--c)b+=a[c];return b};reverse.combiningMarks=/(<%= allExceptCombiningMarks %>)(<%= combiningMarks %>+)/g,reverse.surrogatePair=/(<%= highSurrogates %>)(<%= lowSurrogates %>)/g,fmt.addMillis=function(a,b){return b.replace(/( AM| PM|$)/,function(b,c){return(a.getMilliseconds()/1e3).toString().substring(1)+c})};var px=fmt.bind(this,"$1px"),pct=fmt.bind(this,"$1%"),ems=fmt.bind(this,"$1em"),isMobile=function(a){return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substring(0,4))}(navigator.userAgent||navigator.vendor||window.opera),isiOS=/Apple-iP(hone|od|ad)/.test(navigator.userAgent||""),isOpera=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,isFirefox="undefined"!=typeof InstallTrigger,isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,isChrome=!!window.chrome&&!isOpera,isIE=!1||!!document.documentMode;navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.oGetUserMedia,window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,window.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.RTCIceCandidate,window.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.RTCSessionDescription,screen.lockOrientation=screen.lockOrientation||screen.mozLockOrientation||screen.msLockOrientation||function(){},document.documentElement.requestFullscreen||(document.documentElement.msRequestFullscreen?(document.documentElement.requestFullscreen=document.documentElement.msRequestFullscreen,document.exitFullscreen=document.msExitFullscreen):document.documentElement.mozRequestFullScreen?(document.documentElement.requestFullscreen=document.documentElement.mozRequestFullScreen,document.exitFullscreen=document.mozCancelFullScreen):document.documentElement.webkitRequestFullscreen&&(document.documentElement.requestFullscreen=function(){document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)},document.exitFullscreen=document.webkitExitFullscreen)),document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock||function(){};