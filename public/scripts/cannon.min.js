!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define,1){var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.CANNON=a()}else define([],a)}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){b.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(a,b,c){b.exports={version:a("../package.json").version,AABB:a("./collision/AABB"),ArrayCollisionMatrix:a("./collision/ArrayCollisionMatrix"),Body:a("./objects/Body"),Box:a("./shapes/Box"),Broadphase:a("./collision/Broadphase"),Constraint:a("./constraints/Constraint"),ContactEquation:a("./equations/ContactEquation"),Narrowphase:a("./world/Narrowphase"),ConeTwistConstraint:a("./constraints/ConeTwistConstraint"),ContactMaterial:a("./material/ContactMaterial"),ConvexPolyhedron:a("./shapes/ConvexPolyhedron"),Cylinder:a("./shapes/Cylinder"),DistanceConstraint:a("./constraints/DistanceConstraint"),Equation:a("./equations/Equation"),EventTarget:a("./utils/EventTarget"),FrictionEquation:a("./equations/FrictionEquation"),GSSolver:a("./solver/GSSolver"),GridBroadphase:a("./collision/GridBroadphase"),Heightfield:a("./shapes/Heightfield"),HingeConstraint:a("./constraints/HingeConstraint"),LockConstraint:a("./constraints/LockConstraint"),Mat3:a("./math/Mat3"),Material:a("./material/Material"),NaiveBroadphase:a("./collision/NaiveBroadphase"),ObjectCollisionMatrix:a("./collision/ObjectCollisionMatrix"),Pool:a("./utils/Pool"),Particle:a("./shapes/Particle"),Plane:a("./shapes/Plane"),PointToPointConstraint:a("./constraints/PointToPointConstraint"),Quaternion:a("./math/Quaternion"),Ray:a("./collision/Ray"),RaycastVehicle:a("./objects/RaycastVehicle"),RaycastResult:a("./collision/RaycastResult"),RigidVehicle:a("./objects/RigidVehicle"),RotationalEquation:a("./equations/RotationalEquation"),RotationalMotorEquation:a("./equations/RotationalMotorEquation"),SAPBroadphase:a("./collision/SAPBroadphase"),SPHSystem:a("./objects/SPHSystem"),Shape:a("./shapes/Shape"),Solver:a("./solver/Solver"),Sphere:a("./shapes/Sphere"),SplitSolver:a("./solver/SplitSolver"),Spring:a("./objects/Spring"),Trimesh:a("./shapes/Trimesh"),Vec3:a("./math/Vec3"),Vec3Pool:a("./utils/Vec3Pool"),World:a("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(a,b,c){function d(a){a=a||{},this.lowerBound=new e,a.lowerBound&&this.lowerBound.copy(a.lowerBound),this.upperBound=new e,a.upperBound&&this.upperBound.copy(a.upperBound)}{var e=a("../math/Vec3");a("../utils/Utils")}b.exports=d;var f=new e;d.prototype.setFromPoints=function(a,b,c,d){var e=this.lowerBound,g=this.upperBound,h=c;e.copy(a[0]),h&&h.vmult(e,e),g.copy(e);for(var i=1;i<a.length;i++){var j=a[i];h&&(h.vmult(j,f),j=f),j.x>g.x&&(g.x=j.x),j.x<e.x&&(e.x=j.x),j.y>g.y&&(g.y=j.y),j.y<e.y&&(e.y=j.y),j.z>g.z&&(g.z=j.z),j.z<e.z&&(e.z=j.z)}return b&&(b.vadd(e,e),b.vadd(g,g)),d&&(e.x-=d,e.y-=d,e.z-=d,g.x+=d,g.y+=d,g.z+=d),this},d.prototype.copy=function(a){return this.lowerBound.copy(a.lowerBound),this.upperBound.copy(a.upperBound),this},d.prototype.clone=function(){return(new d).copy(this)},d.prototype.extend=function(a){var b=a.lowerBound.x;this.lowerBound.x>b&&(this.lowerBound.x=b);var c=a.upperBound.x;this.upperBound.x<c&&(this.upperBound.x=c);var b=a.lowerBound.y;this.lowerBound.y>b&&(this.lowerBound.y=b);var c=a.upperBound.y;this.upperBound.y<c&&(this.upperBound.y=c);var b=a.lowerBound.z;this.lowerBound.z>b&&(this.lowerBound.z=b);var c=a.upperBound.z;this.upperBound.z<c&&(this.upperBound.z=c)},d.prototype.overlaps=function(a){var b=this.lowerBound,c=this.upperBound,d=a.lowerBound,e=a.upperBound;return(d.x<=c.x&&c.x<=e.x||b.x<=e.x&&e.x<=c.x)&&(d.y<=c.y&&c.y<=e.y||b.y<=e.y&&e.y<=c.y)&&(d.z<=c.z&&c.z<=e.z||b.z<=e.z&&e.z<=c.z)},d.prototype.contains=function(a){var b=this.lowerBound,c=this.upperBound,d=a.lowerBound,e=a.upperBound;return b.x<=d.x&&c.x>=e.x&&b.y<=d.y&&c.y>=e.y&&b.z<=d.z&&c.z>=e.z},d.prototype.getCorners=function(a,b,c,d,e,f,g,h){var i=this.lowerBound,j=this.upperBound;a.copy(i),b.set(j.x,i.y,i.z),c.set(j.x,j.y,i.z),d.set(i.x,j.y,j.z),e.set(j.x,i.y,i.z),f.set(i.x,j.y,i.z),g.set(i.x,i.y,j.z),h.copy(j)};var g=[new e,new e,new e,new e,new e,new e,new e,new e];d.prototype.toLocalFrame=function(a,b){var c=g,d=c[0],e=c[1],f=c[2],h=c[3],i=c[4],j=c[5],k=c[6],l=c[7];this.getCorners(d,e,f,h,i,j,k,l);for(var m=0;8!==m;m++){var n=c[m];a.pointToLocal(n,n)}return b.setFromPoints(c)},d.prototype.toWorldFrame=function(a,b){var c=g,d=c[0],e=c[1],f=c[2],h=c[3],i=c[4],j=c[5],k=c[6],l=c[7];this.getCorners(d,e,f,h,i,j,k,l);for(var m=0;8!==m;m++){var n=c[m];a.pointToWorld(n,n)}return b.setFromPoints(c)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(a,b,c){function d(){this.matrix=[]}b.exports=d,d.prototype.get=function(a,b){if(a=a.index,b=b.index,b>a){var c=b;b=a,a=c}return this.matrix[(a*(a+1)>>1)+b-1]},d.prototype.set=function(a,b,c){if(a=a.index,b=b.index,b>a){var d=b;b=a,a=d}this.matrix[(a*(a+1)>>1)+b-1]=c?1:0},d.prototype.reset=function(){for(var a=0,b=this.matrix.length;a!==b;a++)this.matrix[a]=0},d.prototype.setNumObjects=function(a){this.matrix.length=a*(a-1)>>1}},{}],5:[function(a,b,c){function d(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}{var e=a("../objects/Body"),f=a("../math/Vec3"),g=a("../math/Quaternion");a("../shapes/Shape"),a("../shapes/Plane")}b.exports=d,d.prototype.collisionPairs=function(a,b,c){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var h=e.STATIC|e.KINEMATIC;d.prototype.needBroadphaseCollision=function(a,b){return 0===(a.collisionFilterGroup&b.collisionFilterMask)||0===(b.collisionFilterGroup&a.collisionFilterMask)?!1:0===(a.type&h)&&a.sleepState!==e.SLEEPING||0===(b.type&h)&&b.sleepState!==e.SLEEPING?!0:!1},d.prototype.intersectionTest=function(a,b,c,d){this.useBoundingBoxes?this.doBoundingBoxBroadphase(a,b,c,d):this.doBoundingSphereBroadphase(a,b,c,d)};{var i=new f;new f,new g,new f}d.prototype.doBoundingSphereBroadphase=function(a,b,c,d){var e=i;b.position.vsub(a.position,e);var f=Math.pow(a.boundingRadius+b.boundingRadius,2),g=e.norm2();f>g&&(c.push(a),d.push(b))},d.prototype.doBoundingBoxBroadphase=function(a,b,c,d){a.aabbNeedsUpdate&&a.computeAABB(),b.aabbNeedsUpdate&&b.computeAABB(),a.aabb.overlaps(b.aabb)&&(c.push(a),d.push(b))};var j={keys:[]},k=[],l=[];d.prototype.makePairsUnique=function(a,b){for(var c=j,d=k,e=l,f=a.length,g=0;g!==f;g++)d[g]=a[g],e[g]=b[g];a.length=0,b.length=0;for(var g=0;g!==f;g++){var h=d[g].id,i=e[g].id,m=i>h?h+","+i:i+","+h;c[m]=g,c.keys.push(m)}for(var g=0;g!==c.keys.length;g++){var m=c.keys.pop(),n=c[m];a.push(d[n]),b.push(e[n]),delete c[m]}},d.prototype.setWorld=function(a){};var m=new f;d.boundingSphereCheck=function(a,b){var c=m;return a.position.vsub(b.position,c),Math.pow(a.shape.boundingSphereRadius+b.shape.boundingSphereRadius,2)>c.norm2()},d.prototype.aabbQuery=function(a,b,c){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(a,b,c){function d(a,b,c,d,g){e.apply(this),this.nx=c||10,this.ny=d||10,this.nz=g||10,this.aabbMin=a||new f(100,100,100),this.aabbMax=b||new f(-100,-100,-100);var h=this.nx*this.ny*this.nz;if(0>=h)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=h,this.binLengths.length=h;for(var i=0;h>i;i++)this.bins[i]=[],this.binLengths[i]=0}b.exports=d;var e=a("./Broadphase"),f=a("../math/Vec3"),g=a("../shapes/Shape");d.prototype=new e,d.prototype.constructor=d;{var h=new f;new f}d.prototype.collisionPairs=function(a,b,c){function d(a,b,c,d,e,f,g){var h=(a-t)*w|0,i=(b-u)*x|0,j=(c-v)*y|0,q=K((d-t)*w),r=K((e-u)*x),s=K((f-v)*y);0>h?h=0:h>=k&&(h=k-1),0>i?i=0:i>=l&&(i=l-1),0>j?j=0:j>=m&&(j=m-1),0>q?q=0:q>=k&&(q=k-1),0>r?r=0:r>=l&&(r=l-1),0>s?s=0:s>=m&&(s=m-1),h*=n,i*=o,j*=p,q*=n,r*=o,s*=p;for(var z=h;q>=z;z+=n)for(var A=i;r>=A;A+=o)for(var B=j;s>=B;B+=p){var C=z+A+B;G[C][H[C]++]=g}}for(var e=a.numObjects(),f=a.bodies,i=this.aabbMax,j=this.aabbMin,k=this.nx,l=this.ny,m=this.nz,n=l*m,o=m,p=1,q=i.x,r=i.y,s=i.z,t=j.x,u=j.y,v=j.z,w=k/(q-t),x=l/(r-u),y=m/(s-v),z=(q-t)/k,A=(r-u)/l,B=(s-v)/m,C=.5*Math.sqrt(z*z+A*A+B*B),D=g.types,E=D.SPHERE,F=D.PLANE,G=(D.BOX,D.COMPOUND,D.CONVEXPOLYHEDRON,this.bins),H=this.binLengths,I=this.bins.length,J=0;J!==I;J++)H[J]=0;for(var K=Math.ceil,j=Math.min,i=Math.max,J=0;J!==e;J++){var L=f[J],M=L.shape;switch(M.type){case E:var N=L.position.x,O=L.position.y,P=L.position.z,Q=M.radius;d(N-Q,O-Q,P-Q,N+Q,O+Q,P+Q,L);break;case F:M.worldNormalNeedsUpdate&&M.computeWorldNormal(L.quaternion);var R=M.worldNormal,S=t+.5*z-L.position.x,T=u+.5*A-L.position.y,U=v+.5*B-L.position.z,V=h;V.set(S,T,U);for(var W=0,X=0;W!==k;W++,X+=n,V.y=T,V.x+=z)for(var Y=0,Z=0;Y!==l;Y++,Z+=o,V.z=U,V.y+=A)for(var $=0,_=0;$!==m;$++,_+=p,V.z+=B)if(V.dot(R)<C){var aa=X+Z+_;G[aa][H[aa]++]=L}break;default:L.aabbNeedsUpdate&&L.computeAABB(),d(L.aabb.lowerBound.x,L.aabb.lowerBound.y,L.aabb.lowerBound.z,L.aabb.upperBound.x,L.aabb.upperBound.y,L.aabb.upperBound.z,L)}}for(var J=0;J!==I;J++){var ba=H[J];if(ba>1)for(var ca=G[J],W=0;W!==ba;W++)for(var L=ca[W],Y=0;Y!==W;Y++){var da=ca[Y];this.needBroadphaseCollision(L,da)&&this.intersectionTest(L,da,b,c)}}this.makePairsUnique(b,c)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(a,b,c){function d(){e.apply(this)}b.exports=d;var e=a("./Broadphase"),f=a("./AABB");d.prototype=new e,d.prototype.constructor=d,d.prototype.collisionPairs=function(a,b,c){var d,e,f,g,h=a.bodies,i=h.length;for(d=0;d!==i;d++)for(e=0;e!==d;e++)f=h[d],g=h[e],this.needBroadphaseCollision(f,g)&&this.intersectionTest(f,g,b,c)};new f;d.prototype.aabbQuery=function(a,b,c){c=c||[];for(var d=0;d<a.bodies.length;d++){var e=a.bodies[d];e.aabbNeedsUpdate&&e.computeAABB(),e.aabb.overlaps(b)&&c.push(e)}return c}},{"./AABB":3,"./Broadphase":5}],8:[function(a,b,c){function d(){this.matrix={}}b.exports=d,d.prototype.get=function(a,b){if(a=a.id,b=b.id,b>a){var c=b;b=a,a=c}return a+"-"+b in this.matrix},d.prototype.set=function(a,b,c){if(a=a.id,b=b.id,b>a){var d=b;b=a,a=d}c?this.matrix[a+"-"+b]=!0:delete this.matrix[a+"-"+b]},d.prototype.reset=function(){this.matrix={}},d.prototype.setNumObjects=function(a){}},{}],9:[function(a,b,c){function d(a,b){this.from=a?a.clone():new g,this.to=b?b.clone():new g,this._direction=new g,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=d.ANY,this.result=new j,this.hasHit=!1,this.callback=function(a){}}function e(a,b,c,d){d.vsub(b,J),c.vsub(b,o),a.vsub(b,p);var e,f,g=J.dot(J),h=J.dot(o),i=J.dot(p),j=o.dot(o),k=o.dot(p);return(e=j*i-h*k)>=0&&(f=g*k-h*i)>=0&&g*j-h*h>e+f}function f(a,b,c){c.vsub(a,J);var d=J.dot(b);b.mult(d,K),K.vadd(a,K);var e=c.distanceTo(K);return e}b.exports=d;var g=a("../math/Vec3"),h=a("../math/Quaternion"),i=a("../math/Transform"),j=(a("../shapes/ConvexPolyhedron"),a("../shapes/Box"),a("../collision/RaycastResult")),k=a("../shapes/Shape"),l=a("../collision/AABB");d.prototype.constructor=d,d.CLOSEST=1,d.ANY=2,d.ALL=4;var m=new l,n=[];d.prototype.intersectWorld=function(a,b){return this.mode=b.mode||d.ANY,this.result=b.result||new j,this.skipBackfaces=!!b.skipBackfaces,this.collisionFilterMask="undefined"!=typeof b.collisionFilterMask?b.collisionFilterMask:-1,this.collisionFilterGroup="undefined"!=typeof b.collisionFilterGroup?b.collisionFilterGroup:-1,b.from&&this.from.copy(b.from),b.to&&this.to.copy(b.to),this.callback=b.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(m),n.length=0,a.broadphase.aabbQuery(a,m,n),this.intersectBodies(n),this.hasHit};var o=new g,p=new g;d.pointInTriangle=e;var q=new g,r=new h;d.prototype.intersectBody=function(a,b){b&&(this.result=b,this._updateDirection());var c=this.checkCollisionResponse;if((!c||a.collisionResponse)&&0!==(this.collisionFilterGroup&a.collisionFilterMask)&&0!==(a.collisionFilterGroup&this.collisionFilterMask))for(var d=q,e=r,f=0,g=a.shapes.length;g>f;f++){var h=a.shapes[f];if((!c||h.collisionResponse)&&(a.quaternion.mult(a.shapeOrientations[f],e),a.quaternion.vmult(a.shapeOffsets[f],d),d.vadd(a.position,d),this.intersectShape(h,e,d,a),this.result._shouldStop))break}},d.prototype.intersectBodies=function(a,b){b&&(this.result=b,this._updateDirection());for(var c=0,d=a.length;!this.result._shouldStop&&d>c;c++)this.intersectBody(a[c])},d.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},d.prototype.intersectShape=function(a,b,c,d){var e=this.from,g=f(e,this._direction,c);if(!(g>a.boundingSphereRadius)){var h=this[a.type];h&&h.call(this,a,b,c,d)}};{var s=(new g,new g,new g),t=new g,u=new g,v=new g;new g,new j}d.prototype.intersectBox=function(a,b,c,d){return this.intersectConvex(a.convexPolyhedronRepresentation,b,c,d)},d.prototype[k.types.BOX]=d.prototype.intersectBox,d.prototype.intersectPlane=function(a,b,c,d){var e=this.from,f=this.to,h=this._direction,i=new g(0,0,1);b.vmult(i,i);var j=new g;e.vsub(c,j);var k=j.dot(i);f.vsub(c,j);var l=j.dot(i);if(!(k*l>0||e.distanceTo(f)<k)){var m=i.dot(h);if(!(Math.abs(m)<this.precision)){var n=new g,o=new g,p=new g;e.vsub(c,n);var q=-i.dot(n)/m;h.scale(q,o),e.vadd(o,p),this.reportIntersection(i,p,a,d,-1)}}},d.prototype[k.types.PLANE]=d.prototype.intersectPlane,d.prototype.getAABB=function(a){var b=this.to,c=this.from;a.lowerBound.x=Math.min(b.x,c.x),a.lowerBound.y=Math.min(b.y,c.y),a.lowerBound.z=Math.min(b.z,c.z),a.upperBound.x=Math.max(b.x,c.x),a.upperBound.y=Math.max(b.y,c.y),a.upperBound.z=Math.max(b.z,c.z)};var w={faceList:[0]};d.prototype.intersectHeightfield=function(a,b,c,e){var f=(a.data,a.elementSize,new g),h=new d(this.from,this.to);i.pointToLocalFrame(c,b,h.from,h.from),i.pointToLocalFrame(c,b,h.to,h.to);var j=[],k=null,l=null,m=null,n=null,o=a.getIndexOfPosition(h.from.x,h.from.y,j,!1);if(o&&(k=j[0],l=j[1],m=j[0],n=j[1]),o=a.getIndexOfPosition(h.to.x,h.to.y,j,!1),o&&((null===k||j[0]<k)&&(k=j[0]),(null===m||j[0]>m)&&(m=j[0]),(null===l||j[1]<l)&&(l=j[1]),(null===n||j[1]>n)&&(n=j[1])),null!==k){var p=[];a.getRectMinMax(k,l,m,n,p);for(var q=(p[0],p[1],k);m>=q;q++)for(var r=l;n>=r;r++){if(this.result._shouldStop)return;if(a.getConvexTrianglePillar(q,r,!1),i.pointToWorldFrame(c,b,a.pillarOffset,f),this.intersectConvex(a.pillarConvex,b,f,e,w),this.result._shouldStop)return;a.getConvexTrianglePillar(q,r,!0),i.pointToWorldFrame(c,b,a.pillarOffset,f),this.intersectConvex(a.pillarConvex,b,f,e,w)}}},d.prototype[k.types.HEIGHTFIELD]=d.prototype.intersectHeightfield;var x=new g,y=new g;d.prototype.intersectSphere=function(a,b,c,d){var e=this.from,f=this.to,g=a.radius,h=Math.pow(f.x-e.x,2)+Math.pow(f.y-e.y,2)+Math.pow(f.z-e.z,2),i=2*((f.x-e.x)*(e.x-c.x)+(f.y-e.y)*(e.y-c.y)+(f.z-e.z)*(e.z-c.z)),j=Math.pow(e.x-c.x,2)+Math.pow(e.y-c.y,2)+Math.pow(e.z-c.z,2)-Math.pow(g,2),k=Math.pow(i,2)-4*h*j,l=x,m=y;if(!(0>k))if(0===k)e.lerp(f,k,l),l.vsub(c,m),m.normalize(),this.reportIntersection(m,l,a,d,-1);else{var n=(-i-Math.sqrt(k))/(2*h),o=(-i+Math.sqrt(k))/(2*h);if(n>=0&&1>=n&&(e.lerp(f,n,l),l.vsub(c,m),m.normalize(),this.reportIntersection(m,l,a,d,-1)),this.result._shouldStop)return;o>=0&&1>=o&&(e.lerp(f,o,l),l.vsub(c,m),m.normalize(),this.reportIntersection(m,l,a,d,-1))}},d.prototype[k.types.SPHERE]=d.prototype.intersectSphere;var z=new g,A=(new g,new g,new g);d.prototype.intersectConvex=function(a,b,c,d,f){for(var g=z,h=A,i=f&&f.faceList||null,j=a.faces,k=a.vertices,l=a.faceNormals,m=this._direction,n=this.from,o=this.to,p=n.distanceTo(o),q=i?i.length:j.length,r=this.result,w=0;!r._shouldStop&&q>w;w++){var x=i?i[w]:w,y=j[x],B=l[x],C=b,D=c;h.copy(k[y[0]]),C.vmult(h,h),h.vadd(D,h),h.vsub(n,h),C.vmult(B,g);var E=m.dot(g);if(!(Math.abs(E)<this.precision)){var F=g.dot(h)/E;if(!(0>F)){m.mult(F,s),s.vadd(n,s),t.copy(k[y[0]]),C.vmult(t,t),D.vadd(t,t);for(var G=1;!r._shouldStop&&G<y.length-1;G++){u.copy(k[y[G]]),v.copy(k[y[G+1]]),C.vmult(u,u),C.vmult(v,v),D.vadd(u,u),D.vadd(v,v);var H=s.distanceTo(n);!e(s,t,u,v)&&!e(s,u,t,v)||H>p||this.reportIntersection(g,s,a,d,x)}}}}},d.prototype[k.types.CONVEXPOLYHEDRON]=d.prototype.intersectConvex;var B=new g,C=new g,D=new g,E=new g,F=new g,G=new g,H=(new l,[]),I=new i;d.prototype.intersectTrimesh=function(a,b,c,d,f){var g=B,h=H,j=I,k=A,l=C,m=D,n=E,o=G,p=F,q=(f&&f.faceList||null,a.indices),r=(a.vertices,a.faceNormals,this.from),w=this.to,x=this._direction;j.position.copy(c),j.quaternion.copy(b),i.vectorToLocalFrame(c,b,x,l),i.pointToLocalFrame(c,b,r,m),i.pointToLocalFrame(c,b,w,n);var y=m.distanceSquared(n);a.tree.rayQuery(this,j,h);for(var z=0,J=h.length;!this.result._shouldStop&&z!==J;z++){var K=h[z];a.getNormal(K,g),a.getVertex(q[3*K],t),t.vsub(m,k);var L=l.dot(g),M=g.dot(k)/L;if(!(0>M)){l.scale(M,s),s.vadd(m,s),a.getVertex(q[3*K+1],u),a.getVertex(q[3*K+2],v);var N=s.distanceSquared(m);!e(s,u,t,v)&&!e(s,t,u,v)||N>y||(i.vectorToWorldFrame(b,g,p),i.pointToWorldFrame(c,b,s,o),this.reportIntersection(p,o,a,d,K))}}h.length=0},d.prototype[k.types.TRIMESH]=d.prototype.intersectTrimesh,d.prototype.reportIntersection=function(a,b,c,e,f){var g=this.from,h=this.to,i=g.distanceTo(b),j=this.result;if(!(this.skipBackfaces&&a.dot(this._direction)>0))switch(j.hitFaceIndex="undefined"!=typeof f?f:-1,this.mode){case d.ALL:this.hasHit=!0,j.set(g,h,a,b,c,e,i),j.hasHit=!0,this.callback(j);break;case d.CLOSEST:(i<j.distance||!j.hasHit)&&(this.hasHit=!0,j.hasHit=!0,j.set(g,h,a,b,c,e,i));break;case d.ANY:this.hasHit=!0,j.hasHit=!0,j.set(g,h,a,b,c,e,i),j._shouldStop=!0}};var J=new g,K=new g},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(a,b,c){function d(){this.rayFromWorld=new e,this.rayToWorld=new e,this.hitNormalWorld=new e,this.hitPointWorld=new e,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}var e=a("../math/Vec3");b.exports=d,d.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},d.prototype.abort=function(){this._shouldStop=!0},d.prototype.set=function(a,b,c,d,e,f,g){this.rayFromWorld.copy(a),this.rayToWorld.copy(b),this.hitNormalWorld.copy(c),this.hitPointWorld.copy(d),this.shape=e,this.body=f,this.distance=g}},{"../math/Vec3":30}],11:[function(a,b,c){function d(a){e.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var b=this.axisList;this._addBodyHandler=function(a){b.push(a.body)},this._removeBodyHandler=function(a){var c=b.indexOf(a.body);-1!==c&&b.splice(c,1)},a&&this.setWorld(a)}var e=(a("../shapes/Shape"),a("../collision/Broadphase"));b.exports=d,d.prototype=new e,d.prototype.setWorld=function(a){this.axisList.length=0;for(var b=0;b<a.bodies.length;b++)this.axisList.push(a.bodies[b]);a.removeEventListener("addBody",this._addBodyHandler),a.removeEventListener("removeBody",this._removeBodyHandler),a.addEventListener("addBody",this._addBodyHandler),a.addEventListener("removeBody",this._removeBodyHandler),this.world=a,this.dirty=!0},d.insertionSortX=function(a){for(var b=1,c=a.length;c>b;b++){for(var d=a[b],e=b-1;e>=0&&!(a[e].aabb.lowerBound.x<=d.aabb.lowerBound.x);e--)a[e+1]=a[e];a[e+1]=d}return a},d.insertionSortY=function(a){for(var b=1,c=a.length;c>b;b++){for(var d=a[b],e=b-1;e>=0&&!(a[e].aabb.lowerBound.y<=d.aabb.lowerBound.y);e--)a[e+1]=a[e];a[e+1]=d}return a},d.insertionSortZ=function(a){for(var b=1,c=a.length;c>b;b++){for(var d=a[b],e=b-1;e>=0&&!(a[e].aabb.lowerBound.z<=d.aabb.lowerBound.z);e--)a[e+1]=a[e];a[e+1]=d}return a},d.prototype.collisionPairs=function(a,b,c){var e,f,g=this.axisList,h=g.length,i=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),e=0;e!==h;e++){var j=g[e];for(f=e+1;h>f;f++){var k=g[f];if(this.needBroadphaseCollision(j,k)){if(!d.checkBounds(j,k,i))break;this.intersectionTest(j,k,b,c)}}}},d.prototype.sortList=function(){for(var a=this.axisList,b=this.axisIndex,c=a.length,e=0;e!==c;e++){var f=a[e];f.aabbNeedsUpdate&&f.computeAABB()}0===b?d.insertionSortX(a):1===b?d.insertionSortY(a):2===b&&d.insertionSortZ(a)},d.checkBounds=function(a,b,c){var d,e;0===c?(d=a.position.x,e=b.position.x):1===c?(d=a.position.y,e=b.position.y):2===c&&(d=a.position.z,e=b.position.z);var f=a.boundingRadius,g=b.boundingRadius,h=d+f,i=e-g;return h>i},d.prototype.autoDetectAxis=function(){for(var a=0,b=0,c=0,d=0,e=0,f=0,g=this.axisList,h=g.length,i=1/h,j=0;j!==h;j++){var k=g[j],l=k.position.x;a+=l,b+=l*l;var m=k.position.y;c+=m,d+=m*m;var n=k.position.z;e+=n,f+=n*n}var o=b-a*a*i,p=d-c*c*i,q=f-e*e*i;o>p?o>q?this.axisIndex=0:this.axisIndex=2:p>q?this.axisIndex=1:this.axisIndex=2},d.prototype.aabbQuery=function(a,b,c){c=c||[],this.dirty&&(this.sortList(),this.dirty=!1);var d=this.axisIndex,e="x";1===d&&(e="y"),2===d&&(e="z");for(var f=this.axisList,g=(b.lowerBound[e],b.upperBound[e],0);g<f.length;g++){var h=f[g];h.aabbNeedsUpdate&&h.computeAABB(),h.aabb.overlaps(b)&&c.push(h)}return c}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(a,b,c){function d(a,b,c){c=c||{};var d="undefined"!=typeof c.maxForce?c.maxForce:1e6,i=c.pivotA?c.pivotA.clone():new h,j=c.pivotB?c.pivotB.clone():new h;this.axisA=c.axisA?c.axisA.clone():new h,this.axisB=c.axisB?c.axisB.clone():new h,e.call(this,a,i,b,j,d),this.collideConnected=!!c.collideConnected,this.angle="undefined"!=typeof c.angle?c.angle:0;var k=this.coneEquation=new f(a,b,c),l=this.twistEquation=new g(a,b,c);this.twistAngle="undefined"!=typeof c.twistAngle?c.twistAngle:0,k.maxForce=0,k.minForce=-d,l.maxForce=0,l.minForce=-d,this.equations.push(k,l)}b.exports=d;var e=(a("./Constraint"),a("./PointToPointConstraint")),f=a("../equations/ConeEquation"),g=a("../equations/RotationalEquation"),h=(a("../equations/ContactEquation"),a("../math/Vec3"));d.prototype=new e,d.constructor=d;new h,new h;d.prototype.update=function(){var a=this.bodyA,b=this.bodyB,c=this.coneEquation,d=this.twistEquation;e.prototype.update.call(this),a.vectorToWorldFrame(this.axisA,c.axisA),b.vectorToWorldFrame(this.axisB,c.axisB),this.axisA.tangents(d.axisA,d.axisA),a.vectorToWorldFrame(d.axisA,d.axisA),this.axisB.tangents(d.axisB,d.axisB),b.vectorToWorldFrame(d.axisB,d.axisB),c.angle=this.angle,d.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(a,b,c){function d(a,b,c){c=e.defaults(c,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=a,this.bodyB=b,this.id=d.idCounter++,this.collideConnected=c.collideConnected,c.wakeUpBodies&&(a&&a.wakeUp(),b&&b.wakeUp())}b.exports=d;var e=a("../utils/Utils");d.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},d.prototype.enable=function(){for(var a=this.equations,b=0;b<a.length;b++)a[b].enabled=!0},d.prototype.disable=function(){for(var a=this.equations,b=0;b<a.length;b++)a[b].enabled=!1},d.idCounter=0},{"../utils/Utils":53}],14:[function(a,b,c){function d(a,b,c,d){e.call(this,a,b),"undefined"==typeof c&&(c=a.position.distanceTo(b.position)),"undefined"==typeof d&&(d=1e6),this.distance=c;var g=this.distanceEquation=new f(a,b);this.equations.push(g),g.minForce=-d,g.maxForce=d}b.exports=d;var e=a("./Constraint"),f=a("../equations/ContactEquation");d.prototype=new e,d.prototype.update=function(){var a=this.bodyA,b=this.bodyB,c=this.distanceEquation,d=.5*this.distance,e=c.ni;b.position.vsub(a.position,e),e.normalize(),e.mult(d,c.ri),e.mult(-d,c.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(a,b,c){function d(a,b,c){c=c||{};var d="undefined"!=typeof c.maxForce?c.maxForce:1e6,i=c.pivotA?c.pivotA.clone():new h,j=c.pivotB?c.pivotB.clone():new h;e.call(this,a,i,b,j,d);var k=this.axisA=c.axisA?c.axisA.clone():new h(1,0,0);k.normalize();var l=this.axisB=c.axisB?c.axisB.clone():new h(1,0,0);l.normalize();var m=this.rotationalEquation1=new f(a,b,c),n=this.rotationalEquation2=new f(a,b,c),o=this.motorEquation=new g(a,b,d);o.enabled=!1,this.equations.push(m,n,o)}b.exports=d;var e=(a("./Constraint"),a("./PointToPointConstraint")),f=a("../equations/RotationalEquation"),g=a("../equations/RotationalMotorEquation"),h=(a("../equations/ContactEquation"),a("../math/Vec3"));d.prototype=new e,d.constructor=d,d.prototype.enableMotor=function(){this.motorEquation.enabled=!0},d.prototype.disableMotor=function(){this.motorEquation.enabled=!1},d.prototype.setMotorSpeed=function(a){this.motorEquation.targetVelocity=a},d.prototype.setMotorMaxForce=function(a){this.motorEquation.maxForce=a,this.motorEquation.minForce=-a};var i=new h,j=new h;d.prototype.update=function(){var a=this.bodyA,b=this.bodyB,c=this.motorEquation,d=this.rotationalEquation1,f=this.rotationalEquation2,g=i,h=j,k=this.axisA,l=this.axisB;e.prototype.update.call(this),a.quaternion.vmult(k,g),b.quaternion.vmult(l,h),g.tangents(d.axisA,f.axisA),d.axisB.copy(h),f.axisB.copy(h),this.motorEquation.enabled&&(a.quaternion.vmult(this.axisA,c.axisA),b.quaternion.vmult(this.axisB,c.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(a,b,c){function d(a,b,c){c=c||{};var d="undefined"!=typeof c.maxForce?c.maxForce:1e6,h=new g,i=new g,j=new g;a.position.vadd(b.position,j),j.scale(.5,j),b.pointToLocalFrame(j,i),a.pointToLocalFrame(j,h),e.call(this,a,h,b,i,d);var k=this.rotationalEquation1=new f(a,b,c),l=this.rotationalEquation2=new f(a,b,c),m=this.rotationalEquation3=new f(a,b,c);this.equations.push(k,l,m)}b.exports=d;var e=(a("./Constraint"),a("./PointToPointConstraint")),f=a("../equations/RotationalEquation"),g=(a("../equations/RotationalMotorEquation"),a("../equations/ContactEquation"),a("../math/Vec3"));d.prototype=new e,d.constructor=d;new g,new g;d.prototype.update=function(){var a=this.bodyA,b=this.bodyB,c=(this.motorEquation,this.rotationalEquation1),d=this.rotationalEquation2,f=this.rotationalEquation3;e.prototype.update.call(this),a.vectorToWorldFrame(g.UNIT_X,c.axisA),b.vectorToWorldFrame(g.UNIT_Y,c.axisB),a.vectorToWorldFrame(g.UNIT_Y,d.axisA),b.vectorToWorldFrame(g.UNIT_Z,d.axisB),a.vectorToWorldFrame(g.UNIT_Z,f.axisA),b.vectorToWorldFrame(g.UNIT_X,f.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(a,b,c){function d(a,b,c,d,h){e.call(this,a,c),h="undefined"!=typeof h?h:1e6,this.pivotA=b?b.clone():new g,this.pivotB=d?d.clone():new g;var i=this.equationX=new f(a,c),j=this.equationY=new f(a,c),k=this.equationZ=new f(a,c);this.equations.push(i,j,k),i.minForce=j.minForce=k.minForce=-h,i.maxForce=j.maxForce=k.maxForce=h,i.ni.set(1,0,0),j.ni.set(0,1,0),k.ni.set(0,0,1)}b.exports=d;var e=a("./Constraint"),f=a("../equations/ContactEquation"),g=a("../math/Vec3");d.prototype=new e,d.prototype.update=function(){var a=this.bodyA,b=this.bodyB,c=this.equationX,d=this.equationY,e=this.equationZ;a.quaternion.vmult(this.pivotA,c.ri),b.quaternion.vmult(this.pivotB,c.rj),d.ri.copy(c.ri),d.rj.copy(c.rj),e.ri.copy(c.ri),e.rj.copy(c.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(a,b,c){function d(a,b,c){c=c||{};var d="undefined"!=typeof c.maxForce?c.maxForce:1e6;f.call(this,a,b,-d,d),this.axisA=c.axisA?c.axisA.clone():new e(1,0,0),this.axisB=c.axisB?c.axisB.clone():new e(0,1,0),this.angle="undefined"!=typeof c.angle?c.angle:0}b.exports=d;var e=a("../math/Vec3"),f=(a("../math/Mat3"),a("./Equation"));d.prototype=new f,d.prototype.constructor=d;var g=new e,h=new e;d.prototype.computeB=function(a){var b=this.a,c=this.b,d=this.axisA,e=this.axisB,f=g,i=h,j=this.jacobianElementA,k=this.jacobianElementB;d.cross(e,f),e.cross(d,i),j.rotational.copy(i),k.rotational.copy(f);var l=Math.cos(this.angle)-d.dot(e),m=this.computeGW(),n=this.computeGiMf(),o=-l*b-m*c-a*n;return o}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(a,b,c){function d(a,b,c){c="undefined"!=typeof c?c:1e6,e.call(this,a,b,0,c),this.restitution=0,this.ri=new f,this.rj=new f,this.ni=new f}b.exports=d;{var e=a("./Equation"),f=a("../math/Vec3");a("../math/Mat3")}d.prototype=new e,d.prototype.constructor=d;var g=new f,h=new f,i=new f;d.prototype.computeB=function(a){var b=this.a,c=this.b,d=this.bi,e=this.bj,f=this.ri,j=this.rj,k=g,l=h,m=d.velocity,n=d.angularVelocity,o=(d.force,d.torque,e.velocity),p=e.angularVelocity,q=(e.force,e.torque,i),r=this.jacobianElementA,s=this.jacobianElementB,t=this.ni;f.cross(t,k),j.cross(t,l),t.negate(r.spatial),k.negate(r.rotational),s.spatial.copy(t),s.rotational.copy(l),q.copy(e.position),q.vadd(j,q),q.vsub(d.position,q),q.vsub(f,q);var u=t.dot(q),v=this.restitution+1,w=v*o.dot(t)-v*m.dot(t)+p.dot(l)-n.dot(k),x=this.computeGiMf(),y=-u*b-w*c-a*x;return y};var j=new f,k=new f,l=new f,m=new f,n=new f;d.prototype.getImpactVelocityAlongNormal=function(){var a=j,b=k,c=l,d=m,e=n;return this.bi.position.vadd(this.ri,c),this.bj.position.vadd(this.rj,d),this.bi.getVelocityAtWorldPoint(c,a),this.bj.getVelocityAtWorldPoint(d,b),a.vsub(b,e),this.ni.dot(e)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20
}],20:[function(a,b,c){function d(a,b,c,f){this.id=d.id++,this.minForce="undefined"==typeof c?-1e6:c,this.maxForce="undefined"==typeof f?1e6:f,this.bi=a,this.bj=b,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new e,this.jacobianElementB=new e,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}b.exports=d;var e=a("../math/JacobianElement"),f=a("../math/Vec3");d.prototype.constructor=d,d.id=0,d.prototype.setSpookParams=function(a,b,c){var d=b,e=a,f=c;this.a=4/(f*(1+4*d)),this.b=4*d/(1+4*d),this.eps=4/(f*f*e*(1+4*d))},d.prototype.computeB=function(a,b,c){var d=this.computeGW(),e=this.computeGq(),f=this.computeGiMf();return-e*a-d*b-f*c},d.prototype.computeGq=function(){var a=this.jacobianElementA,b=this.jacobianElementB,c=this.bi,d=this.bj,e=c.position,f=d.position;return a.spatial.dot(e)+b.spatial.dot(f)};var g=new f;d.prototype.computeGW=function(){var a=this.jacobianElementA,b=this.jacobianElementB,c=this.bi,d=this.bj,e=c.velocity,f=d.velocity,h=c.angularVelocity||g,i=d.angularVelocity||g;return a.multiplyVectors(e,h)+b.multiplyVectors(f,i)},d.prototype.computeGWlambda=function(){var a=this.jacobianElementA,b=this.jacobianElementB,c=this.bi,d=this.bj,e=c.vlambda,f=d.vlambda,h=c.wlambda||g,i=d.wlambda||g;return a.multiplyVectors(e,h)+b.multiplyVectors(f,i)};var h=new f,i=new f,j=new f,k=new f;d.prototype.computeGiMf=function(){var a=this.jacobianElementA,b=this.jacobianElementB,c=this.bi,d=this.bj,e=c.force,f=c.torque,g=d.force,l=d.torque,m=c.invMassSolve,n=d.invMassSolve;return c.invInertiaWorldSolve?c.invInertiaWorldSolve.vmult(f,j):j.set(0,0,0),d.invInertiaWorldSolve?d.invInertiaWorldSolve.vmult(l,k):k.set(0,0,0),e.mult(m,h),g.mult(n,i),a.multiplyVectors(h,j)+b.multiplyVectors(i,k)};var l=new f;d.prototype.computeGiMGt=function(){var a=this.jacobianElementA,b=this.jacobianElementB,c=this.bi,d=this.bj,e=c.invMassSolve,f=d.invMassSolve,g=c.invInertiaWorldSolve,h=d.invInertiaWorldSolve,i=e+f;return g&&(g.vmult(a.rotational,l),i+=l.dot(a.rotational)),h&&(h.vmult(b.rotational,l),i+=l.dot(b.rotational)),i};{var m=new f;new f,new f,new f,new f,new f}d.prototype.addToWlambda=function(a){var b=this.jacobianElementA,c=this.jacobianElementB,d=this.bi,e=this.bj,f=m;b.spatial.mult(d.invMassSolve*a,f),d.vlambda.vadd(f,d.vlambda),c.spatial.mult(e.invMassSolve*a,f),e.vlambda.vadd(f,e.vlambda),d.invInertiaWorldSolve&&(d.invInertiaWorldSolve.vmult(b.rotational,f),f.mult(a,f),d.wlambda.vadd(f,d.wlambda)),e.invInertiaWorldSolve&&(e.invInertiaWorldSolve.vmult(c.rotational,f),f.mult(a,f),e.wlambda.vadd(f,e.wlambda))},d.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(a,b,c){function d(a,b,c){e.call(this,a,b,-c,c),this.ri=new f,this.rj=new f,this.t=new f}b.exports=d;{var e=a("./Equation"),f=a("../math/Vec3");a("../math/Mat3")}d.prototype=new e,d.prototype.constructor=d;var g=new f,h=new f;d.prototype.computeB=function(a){var b=(this.a,this.b),c=(this.bi,this.bj,this.ri),d=this.rj,e=g,f=h,i=this.t;c.cross(i,e),d.cross(i,f);var j=this.jacobianElementA,k=this.jacobianElementB;i.negate(j.spatial),e.negate(j.rotational),k.spatial.copy(i),k.rotational.copy(f);var l=this.computeGW(),m=this.computeGiMf(),n=-l*b-a*m;return n}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(a,b,c){function d(a,b,c){c=c||{};var d="undefined"!=typeof c.maxForce?c.maxForce:1e6;f.call(this,a,b,-d,d),this.axisA=c.axisA?c.axisA.clone():new e(1,0,0),this.axisB=c.axisB?c.axisB.clone():new e(0,1,0),this.maxAngle=Math.PI/2}b.exports=d;var e=a("../math/Vec3"),f=(a("../math/Mat3"),a("./Equation"));d.prototype=new f,d.prototype.constructor=d;var g=new e,h=new e;d.prototype.computeB=function(a){var b=this.a,c=this.b,d=this.axisA,e=this.axisB,f=g,i=h,j=this.jacobianElementA,k=this.jacobianElementB;d.cross(e,f),e.cross(d,i),j.rotational.copy(i),k.rotational.copy(f);var l=Math.cos(this.maxAngle)-d.dot(e),m=this.computeGW(),n=this.computeGiMf(),o=-l*b-m*c-a*n;return o}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(a,b,c){function d(a,b,c){c="undefined"!=typeof c?c:1e6,f.call(this,a,b,-c,c),this.axisA=new e,this.axisB=new e,this.targetVelocity=0}b.exports=d;var e=a("../math/Vec3"),f=(a("../math/Mat3"),a("./Equation"));d.prototype=new f,d.prototype.constructor=d,d.prototype.computeB=function(a){var b=(this.a,this.b),c=(this.bi,this.bj,this.axisA),d=this.axisB,e=this.jacobianElementA,f=this.jacobianElementB;e.rotational.copy(c),d.negate(f.rotational);var g=this.computeGW()-this.targetVelocity,h=this.computeGiMf(),i=-g*b-a*h;return i}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(a,b,c){function d(a,b,c){c=e.defaults(c,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=d.idCounter++,this.materials=[a,b],this.friction=c.friction,this.restitution=c.restitution,this.contactEquationStiffness=c.contactEquationStiffness,this.contactEquationRelaxation=c.contactEquationRelaxation,this.frictionEquationStiffness=c.frictionEquationStiffness,this.frictionEquationRelaxation=c.frictionEquationRelaxation}var e=a("../utils/Utils");b.exports=d,d.idCounter=0},{"../utils/Utils":53}],25:[function(a,b,c){function d(a){var b="";a=a||{},"string"==typeof a?(b=a,a={}):"object"==typeof a&&(b=""),this.name=b,this.id=d.idCounter++,this.friction="undefined"!=typeof a.friction?a.friction:-1,this.restitution="undefined"!=typeof a.restitution?a.restitution:-1}b.exports=d,d.idCounter=0},{}],26:[function(a,b,c){function d(){this.spatial=new e,this.rotational=new e}b.exports=d;var e=a("./Vec3");d.prototype.multiplyElement=function(a){return a.spatial.dot(this.spatial)+a.rotational.dot(this.rotational)},d.prototype.multiplyVectors=function(a,b){return a.dot(this.spatial)+b.dot(this.rotational)}},{"./Vec3":30}],27:[function(a,b,c){function d(a){a?this.elements=a:this.elements=[0,0,0,0,0,0,0,0,0]}b.exports=d;var e=a("./Vec3");d.prototype.identity=function(){var a=this.elements;a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1},d.prototype.setZero=function(){var a=this.elements;a[0]=0,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=0,a[6]=0,a[7]=0,a[8]=0},d.prototype.setTrace=function(a){var b=this.elements;b[0]=a.x,b[4]=a.y,b[8]=a.z},d.prototype.getTrace=function(a){var a=a||new e,b=this.elements;a.x=b[0],a.y=b[4],a.z=b[8]},d.prototype.vmult=function(a,b){b=b||new e;var c=this.elements,d=a.x,f=a.y,g=a.z;return b.x=c[0]*d+c[1]*f+c[2]*g,b.y=c[3]*d+c[4]*f+c[5]*g,b.z=c[6]*d+c[7]*f+c[8]*g,b},d.prototype.smult=function(a){for(var b=0;b<this.elements.length;b++)this.elements[b]*=a},d.prototype.mmult=function(a,b){for(var c=b||new d,e=0;3>e;e++)for(var f=0;3>f;f++){for(var g=0,h=0;3>h;h++)g+=a.elements[e+3*h]*this.elements[h+3*f];c.elements[e+3*f]=g}return c},d.prototype.scale=function(a,b){b=b||new d;for(var c=this.elements,e=b.elements,f=0;3!==f;f++)e[3*f+0]=a.x*c[3*f+0],e[3*f+1]=a.y*c[3*f+1],e[3*f+2]=a.z*c[3*f+2];return b},d.prototype.solve=function(a,b){b=b||new e;for(var c=3,d=4,f=[],g=0;c*d>g;g++)f.push(0);var g,h;for(g=0;3>g;g++)for(h=0;3>h;h++)f[g+d*h]=this.elements[g+3*h];f[3]=a.x,f[7]=a.y,f[11]=a.z;var i,j,k=3,l=k,m=4;do{if(g=l-k,0===f[g+d*g])for(h=g+1;l>h;h++)if(0!==f[g+d*h]){i=m;do j=m-i,f[j+d*g]+=f[j+d*h];while(--i);break}if(0!==f[g+d*g])for(h=g+1;l>h;h++){var n=f[g+d*h]/f[g+d*g];i=m;do j=m-i,f[j+d*h]=g>=j?0:f[j+d*h]-f[j+d*g]*n;while(--i)}}while(--k);if(b.z=f[2*d+3]/f[2*d+2],b.y=(f[1*d+3]-f[1*d+2]*b.z)/f[1*d+1],b.x=(f[0*d+3]-f[0*d+2]*b.z-f[0*d+1]*b.y)/f[0*d+0],isNaN(b.x)||isNaN(b.y)||isNaN(b.z)||b.x===1/0||b.y===1/0||b.z===1/0)throw"Could not solve equation! Got x=["+b.toString()+"], b=["+a.toString()+"], A=["+this.toString()+"]";return b},d.prototype.e=function(a,b,c){return void 0===c?this.elements[b+3*a]:void(this.elements[b+3*a]=c)},d.prototype.copy=function(a){for(var b=0;b<a.elements.length;b++)this.elements[b]=a.elements[b];return this},d.prototype.toString=function(){for(var a="",b=",",c=0;9>c;c++)a+=this.elements[c]+b;return a},d.prototype.reverse=function(a){a=a||new d;for(var b=3,c=6,e=[],f=0;b*c>f;f++)e.push(0);var f,g;for(f=0;3>f;f++)for(g=0;3>g;g++)e[f+c*g]=this.elements[f+3*g];e[3]=1,e[9]=0,e[15]=0,e[4]=0,e[10]=1,e[16]=0,e[5]=0,e[11]=0,e[17]=1;var h,i,j=3,k=j,l=c;do{if(f=k-j,0===e[f+c*f])for(g=f+1;k>g;g++)if(0!==e[f+c*g]){h=l;do i=l-h,e[i+c*f]+=e[i+c*g];while(--h);break}if(0!==e[f+c*f])for(g=f+1;k>g;g++){var m=e[f+c*g]/e[f+c*f];h=l;do i=l-h,e[i+c*g]=f>=i?0:e[i+c*g]-e[i+c*f]*m;while(--h)}}while(--j);f=2;do{g=f-1;do{var m=e[f+c*g]/e[f+c*f];h=c;do i=c-h,e[i+c*g]=e[i+c*g]-e[i+c*f]*m;while(--h)}while(g--)}while(--f);f=2;do{var m=1/e[f+c*f];h=c;do i=c-h,e[i+c*f]=e[i+c*f]*m;while(--h)}while(f--);f=2;do{g=2;do{if(i=e[b+g+c*f],isNaN(i)||i===1/0)throw"Could not reverse! A=["+this.toString()+"]";a.e(f,g,i)}while(g--)}while(f--);return a},d.prototype.setRotationFromQuaternion=function(a){var b=a.x,c=a.y,d=a.z,e=a.w,f=b+b,g=c+c,h=d+d,i=b*f,j=b*g,k=b*h,l=c*g,m=c*h,n=d*h,o=e*f,p=e*g,q=e*h,r=this.elements;return r[0]=1-(l+n),r[1]=j-q,r[2]=k+p,r[3]=j+q,r[4]=1-(i+n),r[5]=m-o,r[6]=k-p,r[7]=m+o,r[8]=1-(i+l),this},d.prototype.transpose=function(a){a=a||new d;for(var b=a.elements,c=this.elements,e=0;3!==e;e++)for(var f=0;3!==f;f++)b[3*e+f]=c[3*f+e];return a}},{"./Vec3":30}],28:[function(a,b,c){function d(a,b,c,d){this.x=void 0!==a?a:0,this.y=void 0!==b?b:0,this.z=void 0!==c?c:0,this.w=void 0!==d?d:1}b.exports=d;var e=a("./Vec3");d.prototype.set=function(a,b,c,d){this.x=a,this.y=b,this.z=c,this.w=d},d.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},d.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},d.prototype.setFromAxisAngle=function(a,b){var c=Math.sin(.5*b);this.x=a.x*c,this.y=a.y*c,this.z=a.z*c,this.w=Math.cos(.5*b)},d.prototype.toAxisAngle=function(a){a=a||new e,this.normalize();var b=2*Math.acos(this.w),c=Math.sqrt(1-this.w*this.w);return.001>c?(a.x=this.x,a.y=this.y,a.z=this.z):(a.x=this.x/c,a.y=this.y/c,a.z=this.z/c),[a,b]};var f=new e,g=new e;d.prototype.setFromVectors=function(a,b){if(a.isAntiparallelTo(b)){var c=f,d=g;a.tangents(c,d),this.setFromAxisAngle(c,Math.PI)}else{var e=a.cross(b);this.x=e.x,this.y=e.y,this.z=e.z,this.w=Math.sqrt(Math.pow(a.norm(),2)*Math.pow(b.norm(),2))+a.dot(b),this.normalize()}};var h=new e,i=new e,j=new e;d.prototype.mult=function(a,b){b=b||new d;var c=this.w,e=h,f=i,g=j;return e.set(this.x,this.y,this.z),f.set(a.x,a.y,a.z),b.w=c*a.w-e.dot(f),e.cross(f,g),b.x=c*f.x+a.w*e.x+g.x,b.y=c*f.y+a.w*e.y+g.y,b.z=c*f.z+a.w*e.z+g.z,b},d.prototype.inverse=function(a){var b=this.x,c=this.y,e=this.z,f=this.w;a=a||new d,this.conjugate(a);var g=1/(b*b+c*c+e*e+f*f);return a.x*=g,a.y*=g,a.z*=g,a.w*=g,a},d.prototype.conjugate=function(a){return a=a||new d,a.x=-this.x,a.y=-this.y,a.z=-this.z,a.w=this.w,a},d.prototype.normalize=function(){var a=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===a?(this.x=0,this.y=0,this.z=0,this.w=0):(a=1/a,this.x*=a,this.y*=a,this.z*=a,this.w*=a)},d.prototype.normalizeFast=function(){var a=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===a?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=a,this.y*=a,this.z*=a,this.w*=a)},d.prototype.vmult=function(a,b){b=b||new e;var c=a.x,d=a.y,f=a.z,g=this.x,h=this.y,i=this.z,j=this.w,k=j*c+h*f-i*d,l=j*d+i*c-g*f,m=j*f+g*d-h*c,n=-g*c-h*d-i*f;return b.x=k*j+n*-g+l*-i-m*-h,b.y=l*j+n*-h+m*-g-k*-i,b.z=m*j+n*-i+k*-h-l*-g,b},d.prototype.copy=function(a){return this.x=a.x,this.y=a.y,this.z=a.z,this.w=a.w,this},d.prototype.toEuler=function(a,b){b=b||"YZX";var c,d,e,f=this.x,g=this.y,h=this.z,i=this.w;switch(b){case"YZX":var j=f*g+h*i;if(j>.499&&(c=2*Math.atan2(f,i),d=Math.PI/2,e=0),-.499>j&&(c=-2*Math.atan2(f,i),d=-Math.PI/2,e=0),isNaN(c)){var k=f*f,l=g*g,m=h*h;c=Math.atan2(2*g*i-2*f*h,1-2*l-2*m),d=Math.asin(2*j),e=Math.atan2(2*f*i-2*g*h,1-2*k-2*m)}break;default:throw new Error("Euler order "+b+" not supported yet.")}a.y=c,a.z=d,a.x=e},d.prototype.setFromEuler=function(a,b,c,d){d=d||"XYZ";var e=Math.cos(a/2),f=Math.cos(b/2),g=Math.cos(c/2),h=Math.sin(a/2),i=Math.sin(b/2),j=Math.sin(c/2);return"XYZ"===d?(this.x=h*f*g+e*i*j,this.y=e*i*g-h*f*j,this.z=e*f*j+h*i*g,this.w=e*f*g-h*i*j):"YXZ"===d?(this.x=h*f*g+e*i*j,this.y=e*i*g-h*f*j,this.z=e*f*j-h*i*g,this.w=e*f*g+h*i*j):"ZXY"===d?(this.x=h*f*g-e*i*j,this.y=e*i*g+h*f*j,this.z=e*f*j+h*i*g,this.w=e*f*g-h*i*j):"ZYX"===d?(this.x=h*f*g-e*i*j,this.y=e*i*g+h*f*j,this.z=e*f*j-h*i*g,this.w=e*f*g+h*i*j):"YZX"===d?(this.x=h*f*g+e*i*j,this.y=e*i*g+h*f*j,this.z=e*f*j-h*i*g,this.w=e*f*g-h*i*j):"XZY"===d&&(this.x=h*f*g-e*i*j,this.y=e*i*g-h*f*j,this.z=e*f*j+h*i*g,this.w=e*f*g+h*i*j),this},d.prototype.clone=function(){return new d(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(a,b,c){function d(a){a=a||{},this.position=new e,a.position&&this.position.copy(a.position),this.quaternion=new f,a.quaternion&&this.quaternion.copy(a.quaternion)}var e=a("./Vec3"),f=a("./Quaternion");b.exports=d;var g=new f;d.pointToLocalFrame=function(a,b,c,d){var d=d||new e;return c.vsub(a,d),b.conjugate(g),g.vmult(d,d),d},d.prototype.pointToLocal=function(a,b){return d.pointToLocalFrame(this.position,this.quaternion,a,b)},d.pointToWorldFrame=function(a,b,c,d){var d=d||new e;return b.vmult(c,d),d.vadd(a,d),d},d.prototype.pointToWorld=function(a,b){return d.pointToWorldFrame(this.position,this.quaternion,a,b)},d.prototype.vectorToWorldFrame=function(a,b){var b=b||new e;return this.quaternion.vmult(a,b),b},d.vectorToWorldFrame=function(a,b,c){return a.vmult(b,c),c},d.vectorToLocalFrame=function(a,b,c,d){var d=d||new e;return b.w*=-1,b.vmult(c,d),b.w*=-1,d}},{"./Quaternion":28,"./Vec3":30}],30:[function(a,b,c){function d(a,b,c){this.x=a||0,this.y=b||0,this.z=c||0}b.exports=d;var e=a("./Mat3");d.ZERO=new d(0,0,0),d.UNIT_X=new d(1,0,0),d.UNIT_Y=new d(0,1,0),d.UNIT_Z=new d(0,0,1),d.prototype.cross=function(a,b){var c=a.x,e=a.y,f=a.z,g=this.x,h=this.y,i=this.z;return b=b||new d,b.x=h*f-i*e,b.y=i*c-g*f,b.z=g*e-h*c,b},d.prototype.set=function(a,b,c){return this.x=a,this.y=b,this.z=c,this},d.prototype.setZero=function(){this.x=this.y=this.z=0},d.prototype.vadd=function(a,b){return b?(b.x=a.x+this.x,b.y=a.y+this.y,b.z=a.z+this.z,void 0):new d(this.x+a.x,this.y+a.y,this.z+a.z)},d.prototype.vsub=function(a,b){return b?(b.x=this.x-a.x,b.y=this.y-a.y,b.z=this.z-a.z,void 0):new d(this.x-a.x,this.y-a.y,this.z-a.z)},d.prototype.crossmat=function(){return new e([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},d.prototype.normalize=function(){var a=this.x,b=this.y,c=this.z,d=Math.sqrt(a*a+b*b+c*c);if(d>0){var e=1/d;this.x*=e,this.y*=e,this.z*=e}else this.x=0,this.y=0,this.z=0;return d},d.prototype.unit=function(a){a=a||new d;var b=this.x,c=this.y,e=this.z,f=Math.sqrt(b*b+c*c+e*e);return f>0?(f=1/f,a.x=b*f,a.y=c*f,a.z=e*f):(a.x=1,a.y=0,a.z=0),a},d.prototype.norm=function(){var a=this.x,b=this.y,c=this.z;return Math.sqrt(a*a+b*b+c*c)},d.prototype.length=d.prototype.norm,d.prototype.norm2=function(){return this.dot(this)},d.prototype.lengthSquared=d.prototype.norm2,d.prototype.distanceTo=function(a){var b=this.x,c=this.y,d=this.z,e=a.x,f=a.y,g=a.z;return Math.sqrt((e-b)*(e-b)+(f-c)*(f-c)+(g-d)*(g-d))},d.prototype.distanceSquared=function(a){var b=this.x,c=this.y,d=this.z,e=a.x,f=a.y,g=a.z;return(e-b)*(e-b)+(f-c)*(f-c)+(g-d)*(g-d)},d.prototype.mult=function(a,b){b=b||new d;var c=this.x,e=this.y,f=this.z;return b.x=a*c,b.y=a*e,b.z=a*f,b},d.prototype.scale=d.prototype.mult,d.prototype.dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z},d.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},d.prototype.negate=function(a){return a=a||new d,a.x=-this.x,a.y=-this.y,a.z=-this.z,a};var f=new d,g=new d;d.prototype.tangents=function(a,b){var c=this.norm();if(c>0){var d=f,e=1/c;d.set(this.x*e,this.y*e,this.z*e);var h=g;Math.abs(d.x)<.9?(h.set(1,0,0),d.cross(h,a)):(h.set(0,1,0),d.cross(h,a)),d.cross(a,b)}else a.set(1,0,0),b.set(0,1,0)},d.prototype.toString=function(){return this.x+","+this.y+","+this.z},d.prototype.toArray=function(){return[this.x,this.y,this.z]},d.prototype.copy=function(a){return this.x=a.x,this.y=a.y,this.z=a.z,this},d.prototype.lerp=function(a,b,c){var d=this.x,e=this.y,f=this.z;c.x=d+(a.x-d)*b,c.y=e+(a.y-e)*b,c.z=f+(a.z-f)*b},d.prototype.almostEquals=function(a,b){return void 0===b&&(b=1e-6),Math.abs(this.x-a.x)>b||Math.abs(this.y-a.y)>b||Math.abs(this.z-a.z)>b?!1:!0},d.prototype.almostZero=function(a){return void 0===a&&(a=1e-6),Math.abs(this.x)>a||Math.abs(this.y)>a||Math.abs(this.z)>a?!1:!0};var h=new d;d.prototype.isAntiparallelTo=function(a,b){return this.negate(h),h.almostEquals(a,b)},d.prototype.clone=function(){return new d(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(a,b,c){function d(a){a=a||{},e.apply(this),this.id=d.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new f,this.collisionFilterGroup="number"==typeof a.collisionFilterGroup?a.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof a.collisionFilterMask?a.collisionFilterMask:1,this.collisionResponse=!0,this.position=new f,a.position&&this.position.copy(a.position),this.previousPosition=new f,this.initPosition=new f,this.velocity=new f,a.velocity&&this.velocity.copy(a.velocity),this.initVelocity=new f,this.force=new f;var b="number"==typeof a.mass?a.mass:0;this.mass=b,this.invMass=b>0?1/b:0,this.material=a.material||null,this.linearDamping="number"==typeof a.linearDamping?a.linearDamping:.01,this.type=0>=b?d.STATIC:d.DYNAMIC,typeof a.type==typeof d.STATIC&&(this.type=a.type),this.allowSleep="undefined"!=typeof a.allowSleep?a.allowSleep:!0,this.sleepState=0,this.sleepSpeedLimit="undefined"!=typeof a.sleepSpeedLimit?a.sleepSpeedLimit:.1,this.sleepTimeLimit="undefined"!=typeof a.sleepTimeLimit?a.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new f,this.quaternion=new h,a.quaternion&&this.quaternion.copy(a.quaternion),this.initQuaternion=new h,this.angularVelocity=new f,a.angularVelocity&&this.angularVelocity.copy(a.angularVelocity),this.initAngularVelocity=new f,this.interpolatedPosition=new f,this.interpolatedQuaternion=new h,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new f,this.invInertia=new f,this.invInertiaWorld=new g,this.invMassSolve=0,this.invInertiaSolve=new f,this.invInertiaWorldSolve=new g,this.fixedRotation="undefined"!=typeof a.fixedRotation?a.fixedRotation:!1,this.angularDamping="undefined"!=typeof a.angularDamping?a.angularDamping:.01,this.aabb=new i,this.aabbNeedsUpdate=!0,this.wlambda=new f,a.shape&&this.addShape(a.shape),this.updateMassProperties()}b.exports=d;var e=a("../utils/EventTarget"),f=(a("../shapes/Shape"),a("../math/Vec3")),g=a("../math/Mat3"),h=a("../math/Quaternion"),i=(a("../material/Material"),a("../collision/AABB")),j=a("../shapes/Box");d.prototype=new e,d.prototype.constructor=d,d.DYNAMIC=1,d.STATIC=2,d.KINEMATIC=4,d.AWAKE=0,d.SLEEPY=1,d.SLEEPING=2,d.idCounter=0,d.prototype.wakeUp=function(){var a=this.sleepState;this.sleepState=0,a===d.SLEEPING&&this.dispatchEvent({type:"wakeup"})},d.prototype.sleep=function(){this.sleepState=d.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},d.sleepyEvent={type:"sleepy"},d.sleepEvent={type:"sleep"},d.prototype.sleepTick=function(a){if(this.allowSleep){var b=this.sleepState,c=this.velocity.norm2()+this.angularVelocity.norm2(),e=Math.pow(this.sleepSpeedLimit,2);b===d.AWAKE&&e>c?(this.sleepState=d.SLEEPY,this.timeLastSleepy=a,this.dispatchEvent(d.sleepyEvent)):b===d.SLEEPY&&c>e?this.wakeUp():b===d.SLEEPY&&a-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(d.sleepEvent))}},d.prototype.updateSolveMassProperties=function(){this.sleepState===d.SLEEPING||this.type===d.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},d.prototype.pointToLocalFrame=function(a,b){var b=b||new f;return a.vsub(this.position,b),this.quaternion.conjugate().vmult(b,b),b},d.prototype.vectorToLocalFrame=function(a,b){var b=b||new f;return this.quaternion.conjugate().vmult(a,b),b},d.prototype.pointToWorldFrame=function(a,b){var b=b||new f;return this.quaternion.vmult(a,b),b.vadd(this.position,b),b},d.prototype.vectorToWorldFrame=function(a,b){var b=b||new f;return this.quaternion.vmult(a,b),b};var k=new f,l=new h;d.prototype.addShape=function(a,b,c){var d=new f,e=new h;return b&&d.copy(b),c&&e.copy(c),this.shapes.push(a),this.shapeOffsets.push(d),this.shapeOrientations.push(e),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},d.prototype.updateBoundingRadius=function(){for(var a=this.shapes,b=this.shapeOffsets,c=a.length,d=0,e=0;e!==c;e++){var f=a[e];f.updateBoundingSphereRadius();var g=b[e].norm(),h=f.boundingSphereRadius;g+h>d&&(d=g+h)}this.boundingRadius=d};var m=new i;d.prototype.computeAABB=function(){for(var a=this.shapes,b=this.shapeOffsets,c=this.shapeOrientations,d=a.length,e=k,f=l,g=this.quaternion,h=this.aabb,i=m,j=0;j!==d;j++){var n=a[j];c[j].mult(g,f),f.vmult(b[j],e),e.vadd(this.position,e),n.calculateWorldAABB(e,f,i.lowerBound,i.upperBound),0===j?h.copy(i):h.extend(i)}this.aabbNeedsUpdate=!1};{var n=new g,o=new g;new g}d.prototype.updateInertiaWorld=function(a){var b=this.invInertia;if(b.x!==b.y||b.y!==b.z||a){var c=n,d=o;c.setRotationFromQuaternion(this.quaternion),c.transpose(d),c.scale(b,c),c.mmult(d,this.invInertiaWorld)}else;};var p=new f,q=new f;d.prototype.applyForce=function(a,b){if(this.type===d.DYNAMIC){var c=p;b.vsub(this.position,c);var e=q;c.cross(a,e),this.force.vadd(a,this.force),this.torque.vadd(e,this.torque)}};var r=new f,s=new f;d.prototype.applyLocalForce=function(a,b){if(this.type===d.DYNAMIC){var c=r,e=s;this.vectorToWorldFrame(a,c),this.pointToWorldFrame(b,e),this.applyForce(c,e)}};var t=new f,u=new f,v=new f;d.prototype.applyImpulse=function(a,b){if(this.type===d.DYNAMIC){var c=t;b.vsub(this.position,c);var e=u;e.copy(a),e.mult(this.invMass,e),this.velocity.vadd(e,this.velocity);var f=v;c.cross(a,f),this.invInertiaWorld.vmult(f,f),this.angularVelocity.vadd(f,this.angularVelocity)}};var w=new f,x=new f;d.prototype.applyLocalImpulse=function(a,b){if(this.type===d.DYNAMIC){var c=w,e=x;this.vectorToWorldFrame(a,c),this.pointToWorldFrame(b,e),this.applyImpulse(c,e)}};var y=new f;d.prototype.updateMassProperties=function(){var a=y;this.invMass=this.mass>0?1/this.mass:0;var b=this.inertia,c=this.fixedRotation;this.computeAABB(),a.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),j.calculateInertia(a,this.mass,b),this.invInertia.set(b.x>0&&!c?1/b.x:0,b.y>0&&!c?1/b.y:0,b.z>0&&!c?1/b.z:0),this.updateInertiaWorld(!0)},d.prototype.getVelocityAtWorldPoint=function(a,b){var c=new f;return a.vsub(this.position,c),this.angularVelocity.cross(c,b),this.velocity.vadd(b,b),b}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(a,b,c){function d(a){this.chassisBody=a.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis="undefined"!=typeof a.indexRightAxis?a.indexRightAxis:1,this.indexForwardAxis="undefined"!=typeof a.indexForwardAxis?a.indexForwardAxis:0,this.indexUpAxis="undefined"!=typeof a.indexUpAxis?a.indexUpAxis:2}function e(a,b,c,d,e){var g=0,h=c,i=v,j=w,k=x;a.getVelocityAtWorldPoint(h,i),b.getVelocityAtWorldPoint(h,j),i.vsub(j,k);var l=d.dot(k),m=f(a,c,d),n=f(b,c,d),o=1,p=o/(m+n);return g=-l*p,g>e&&(g=e),-e>g&&(g=-e),g}function f(a,b,c){var d=y,e=z,f=A,g=B;return b.vsub(a.position,d),d.cross(c,e),a.invInertiaWorld.vmult(e,g),g.cross(d,f),a.invMass+c.dot(f)}function g(a,b,c,d,e,f){var g=e.norm2();if(g>1.1)return 0;var h=C,i=D,j=E;a.getVelocityAtWorldPoint(b,h),c.getVelocityAtWorldPoint(d,i),h.vsub(i,j);var k=e.dot(j),l=.2,m=1/(a.invMass+c.invMass),f=-l*k*m;return f}var h=(a("./Body"),a("../math/Vec3")),i=a("../math/Quaternion"),j=(a("../collision/RaycastResult"),a("../collision/Ray")),k=a("../objects/WheelInfo");b.exports=d;{var l=(new h,new h,new h,new h),m=new h,n=new h;new j}d.prototype.addWheel=function(a){a=a||{};var b=new k(a),c=this.wheelInfos.length;return this.wheelInfos.push(b),c},d.prototype.setSteeringValue=function(a,b){var c=this.wheelInfos[b];c.steering=a};new h;d.prototype.applyEngineForce=function(a,b){this.wheelInfos[b].engineForce=a},d.prototype.setBrake=function(a,b){this.wheelInfos[b].brake=a},d.prototype.addToWorld=function(a){this.constraints;a.add(this.chassisBody);var b=this;this.preStepCallback=function(){b.updateVehicle(a.dt)},a.addEventListener("preStep",this.preStepCallback),this.world=a},d.prototype.getVehicleAxisWorld=function(a,b){b.set(0===a?1:0,1===a?1:0,2===a?1:0),this.chassisBody.vectorToWorldFrame(b,b)},d.prototype.updateVehicle=function(a){for(var b=this.wheelInfos,c=b.length,d=this.chassisBody,e=0;c>e;e++)this.updateWheelTransform(e);this.currentVehicleSpeedKmHour=3.6*d.velocity.norm();var f=new h;this.getVehicleAxisWorld(this.indexForwardAxis,f),f.dot(d.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(var e=0;c>e;e++)this.castRay(b[e]);this.updateSuspension(a);for(var g=new h,i=new h,e=0;c>e;e++){var j=b[e],k=j.suspensionForce;k>j.maxSuspensionForce&&(k=j.maxSuspensionForce),j.raycastResult.hitNormalWorld.scale(k*a,g),j.raycastResult.hitPointWorld.vsub(d.position,i),d.applyImpulse(g,j.raycastResult.hitPointWorld)}this.updateFriction(a);var l=new h,m=new h,n=new h;for(e=0;c>e;e++){var j=b[e];d.getVelocityAtWorldPoint(j.chassisConnectionPointWorld,n);var o=1;switch(this.indexUpAxis){case 1:o=-1}if(j.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,m);var p=m.dot(j.raycastResult.hitNormalWorld);j.raycastResult.hitNormalWorld.scale(p,l),m.vsub(l,m);var q=m.dot(n);j.deltaRotation=o*q*a/j.radius}!j.sliding&&j.isInContact||0===j.engineForce||!j.useCustomSlidingRotationalSpeed||(j.deltaRotation=(j.engineForce>0?1:-1)*j.customSlidingRotationalSpeed*a),Math.abs(j.brake)>Math.abs(j.engineForce)&&(j.deltaRotation=0),j.rotation+=j.deltaRotation,j.deltaRotation*=.99}},d.prototype.updateSuspension=function(a){for(var b=this.chassisBody,c=b.mass,d=this.wheelInfos,e=d.length,f=0;e>f;f++){var g=d[f];if(g.isInContact){var h,i=g.suspensionRestLength,j=g.suspensionLength,k=i-j;h=g.suspensionStiffness*k*g.clippedInvContactDotSuspension;var l,m=g.suspensionRelativeVelocity;l=0>m?g.dampingCompression:g.dampingRelaxation,h-=l*m,g.suspensionForce=h*c,g.suspensionForce<0&&(g.suspensionForce=0)}else g.suspensionForce=0}},d.prototype.removeFromWorld=function(a){this.constraints;a.remove(this.chassisBody),a.removeEventListener("preStep",this.preStepCallback),this.world=null};var o=new h,p=new h;d.prototype.castRay=function(a){var b=o,c=p;this.updateWheelTransformWorld(a);var d=this.chassisBody,e=-1,f=a.suspensionRestLength+a.radius;a.directionWorld.scale(f,b);var g=a.chassisConnectionPointWorld;g.vadd(b,c);var i=a.raycastResult;i.reset();var j=d.collisionResponse;d.collisionResponse=!1,this.world.rayTest(g,c,i),d.collisionResponse=j;var k=i.body;if(a.raycastResult.groundObject=0,k){e=i.distance,a.raycastResult.hitNormalWorld=i.hitNormalWorld,a.isInContact=!0;var l=i.distance;a.suspensionLength=l-a.radius;var m=a.suspensionRestLength-a.maxSuspensionTravel,n=a.suspensionRestLength+a.maxSuspensionTravel;a.suspensionLength<m&&(a.suspensionLength=m),a.suspensionLength>n&&(a.suspensionLength=n,a.raycastResult.reset());var q=a.raycastResult.hitNormalWorld.dot(a.directionWorld),r=new h;d.getVelocityAtWorldPoint(a.raycastResult.hitPointWorld,r);var s=a.raycastResult.hitNormalWorld.dot(r);if(q>=-.1)a.suspensionRelativeVelocity=0,a.clippedInvContactDotSuspension=10;else{var t=-1/q;a.suspensionRelativeVelocity=s*t,a.clippedInvContactDotSuspension=t}}else a.suspensionLength=a.suspensionRestLength+0*a.maxSuspensionTravel,a.suspensionRelativeVelocity=0,a.directionWorld.scale(-1,a.raycastResult.hitNormalWorld),a.clippedInvContactDotSuspension=1;return e},d.prototype.updateWheelTransformWorld=function(a){a.isInContact=!1;var b=this.chassisBody;b.pointToWorldFrame(a.chassisConnectionPointLocal,a.chassisConnectionPointWorld),b.vectorToWorldFrame(a.directionLocal,a.directionWorld),b.vectorToWorldFrame(a.axleLocal,a.axleWorld)},d.prototype.updateWheelTransform=function(a){var b=l,c=m,d=n,e=this.wheelInfos[a];this.updateWheelTransformWorld(e),e.directionLocal.scale(-1,b),c.copy(e.axleLocal),b.cross(c,d),d.normalize(),c.normalize();var f=e.steering,g=new i;g.setFromAxisAngle(b,f);var h=new i;h.setFromAxisAngle(c,e.rotation);var j=e.worldTransform.quaternion;this.chassisBody.quaternion.mult(g,j),j.mult(h,j),j.normalize();var k=e.worldTransform.position;k.copy(e.directionWorld),k.scale(e.suspensionLength,k),k.vadd(e.chassisConnectionPointWorld,k)};var q=[new h(1,0,0),new h(0,1,0),new h(0,0,1)];d.prototype.getWheelTransformWorld=function(a){return this.wheelInfos[a].worldTransform};var r=new h,s=[],t=[],u=1;d.prototype.updateFriction=function(a){for(var b=r,c=this.wheelInfos,d=c.length,f=this.chassisBody,i=t,j=s,k=0,l=0;d>l;l++){var m=c[l],n=m.raycastResult.body;n&&k++,m.sideImpulse=0,m.forwardImpulse=0,i[l]||(i[l]=new h),j[l]||(j[l]=new h)}for(var l=0;d>l;l++){var m=c[l],n=m.raycastResult.body;if(n){var o=j[l],p=this.getWheelTransformWorld(l);p.vectorToWorldFrame(q[this.indexRightAxis],o);var v=m.raycastResult.hitNormalWorld,w=o.dot(v);v.scale(w,b),o.vsub(b,o),o.normalize(),v.cross(o,i[l]),i[l].normalize(),m.sideImpulse=g(f,m.raycastResult.hitPointWorld,n,m.raycastResult.hitPointWorld,o),m.sideImpulse*=u}}var x=1,y=.5;this.sliding=!1;for(var l=0;d>l;l++){var m=c[l],n=m.raycastResult.body,z=0;if(m.slipInfo=1,n){var A=0,B=m.brake?m.brake:A;z=e(f,n,m.raycastResult.hitPointWorld,i[l],B),z+=m.engineForce*a;var C=B/z;m.slipInfo*=C}if(m.forwardImpulse=0,m.skidInfo=1,n){m.skidInfo=1;var D=m.suspensionForce*a*m.frictionSlip,E=D,F=D*E;m.forwardImpulse=z;var G=m.forwardImpulse*y,H=m.sideImpulse*x,I=G*G+H*H;if(m.sliding=!1,I>F){this.sliding=!0,m.sliding=!0;var C=D/Math.sqrt(I);m.skidInfo*=C}}}if(this.sliding)for(var l=0;d>l;l++){var m=c[l];0!==m.sideImpulse&&m.skidInfo<1&&(m.forwardImpulse*=m.skidInfo,m.sideImpulse*=m.skidInfo)}for(var l=0;d>l;l++){var m=c[l],J=new h;if(J.copy(m.raycastResult.hitPointWorld),0!==m.forwardImpulse){var K=new h;i[l].scale(m.forwardImpulse,K),f.applyImpulse(K,J)}if(0!==m.sideImpulse){var n=m.raycastResult.body,L=new h;L.copy(m.raycastResult.hitPointWorld);var M=new h;j[l].scale(m.sideImpulse,M),f.pointToLocalFrame(J,J),J["xyz"[this.indexUpAxis]]*=m.rollInfluence,f.pointToWorldFrame(J,J),f.applyImpulse(M,J),M.scale(-1,M),n.applyImpulse(M,L)}}};var v=new h,w=new h,x=new h,y=new h,z=new h,A=new h,B=new h,C=new h,D=new h,E=new h},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(a,b,c){function d(a){if(this.wheelBodies=[],this.coordinateSystem="undefined"==typeof a.coordinateSystem?new h(1,2,3):a.coordinateSystem.clone(),this.chassisBody=a.chassisBody,!this.chassisBody){var b=new g(new h(5,2,.5));this.chassisBody=new e(1,b)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}var e=a("./Body"),f=a("../shapes/Sphere"),g=a("../shapes/Box"),h=a("../math/Vec3"),i=a("../constraints/HingeConstraint");b.exports=d,d.prototype.addWheel=function(a){a=a||{};var b=a.body;b||(b=new e(1,new f(1.2))),this.wheelBodies.push(b),this.wheelForces.push(0);var c=(new h,"undefined"!=typeof a.position?a.position.clone():new h),d=new h;this.chassisBody.pointToWorldFrame(c,d),b.position.set(d.x,d.y,d.z);var g="undefined"!=typeof a.axis?a.axis.clone():new h(0,1,0);this.wheelAxes.push(g);var j=new i(this.chassisBody,b,{pivotA:c,axisA:g,pivotB:h.ZERO,axisB:g,collideConnected:!1});return this.constraints.push(j),
this.wheelBodies.length-1},d.prototype.setSteeringValue=function(a,b){var c=this.wheelAxes[b],d=Math.cos(a),e=Math.sin(a),f=c.x,g=c.y;this.constraints[b].axisA.set(d*f-e*g,e*f+d*g,0)},d.prototype.setMotorSpeed=function(a,b){var c=this.constraints[b];c.enableMotor(),c.motorTargetVelocity=a},d.prototype.disableMotor=function(a){var b=this.constraints[a];b.disableMotor()};var j=new h;d.prototype.setWheelForce=function(a,b){this.wheelForces[b]=a},d.prototype.applyWheelForce=function(a,b){var c=this.wheelAxes[b],d=this.wheelBodies[b],e=d.torque;c.scale(a,j),d.vectorToWorldFrame(j,j),e.vadd(j,e)},d.prototype.addToWorld=function(a){for(var b=this.constraints,c=this.wheelBodies.concat([this.chassisBody]),d=0;d<c.length;d++)a.add(c[d]);for(var d=0;d<b.length;d++)a.addConstraint(b[d]);a.addEventListener("preStep",this._update.bind(this))},d.prototype._update=function(){for(var a=this.wheelForces,b=0;b<a.length;b++)this.applyWheelForce(a[b],b)},d.prototype.removeFromWorld=function(a){for(var b=this.constraints,c=this.wheelBodies.concat([this.chassisBody]),d=0;d<c.length;d++)a.remove(c[d]);for(var d=0;d<b.length;d++)a.removeConstraint(b[d])};var k=new h;d.prototype.getWheelSpeed=function(a){var b=this.wheelAxes[a],c=this.wheelBodies[a],d=c.angularVelocity;return this.chassisBody.vectorToWorldFrame(b,k),d.dot(k)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(a,b,c){function d(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}b.exports=d;{var e=(a("../shapes/Shape"),a("../math/Vec3"));a("../math/Quaternion"),a("../shapes/Particle"),a("../objects/Body"),a("../material/Material")}d.prototype.add=function(a){this.particles.push(a),this.neighbors.length<this.particles.length&&this.neighbors.push([])},d.prototype.remove=function(a){var b=this.particles.indexOf(a);-1!==b&&(this.particles.splice(b,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var f=new e;d.prototype.getNeighbors=function(a,b){for(var c=this.particles.length,d=a.id,e=this.smoothingRadius*this.smoothingRadius,g=f,h=0;h!==c;h++){var i=this.particles[h];i.position.vsub(a.position,g),d!==i.id&&g.norm2()<e&&b.push(i)}};var g=new e,h=new e,i=new e,j=new e,k=new e,l=new e;d.prototype.update=function(){for(var a=this.particles.length,b=g,c=this.speedOfSound,d=this.eps,e=0;e!==a;e++){var f=this.particles[e],m=this.neighbors[e];m.length=0,this.getNeighbors(f,m),m.push(this.particles[e]);for(var n=m.length,o=0,p=0;p!==n;p++){f.position.vsub(m[p].position,b);var q=b.norm(),r=this.w(q);o+=m[p].mass*r}this.densities[e]=o,this.pressures[e]=c*c*(this.densities[e]-this.density)}for(var s=h,t=i,u=j,v=k,w=l,e=0;e!==a;e++){var x=this.particles[e];s.set(0,0,0),t.set(0,0,0);for(var y,z,m=this.neighbors[e],n=m.length,p=0;p!==n;p++){var A=m[p];x.position.vsub(A.position,v);var B=v.norm();y=-A.mass*(this.pressures[e]/(this.densities[e]*this.densities[e]+d)+this.pressures[p]/(this.densities[p]*this.densities[p]+d)),this.gradw(v,u),u.mult(y,u),s.vadd(u,s),A.velocity.vsub(x.velocity,w),w.mult(1/(1e-4+this.densities[e]*this.densities[p])*this.viscosity*A.mass,w),z=this.nablaw(B),w.mult(z,w),t.vadd(w,t)}t.mult(x.mass,t),s.mult(x.mass,s),x.force.vadd(t,x.force),x.force.vadd(s,x.force)}},d.prototype.w=function(a){var b=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(b,9))*Math.pow(b*b-a*a,3)},d.prototype.gradw=function(a,b){var c=a.norm(),d=this.smoothingRadius;a.mult(945/(32*Math.PI*Math.pow(d,9))*Math.pow(d*d-c*c,2),b)},d.prototype.nablaw=function(a){var b=this.smoothingRadius,c=945/(32*Math.PI*Math.pow(b,9))*(b*b-a*a)*(7*a*a-3*b*b);return c}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(a,b,c){function d(a,b,c){c=c||{},this.restLength="number"==typeof c.restLength?c.restLength:1,this.stiffness=c.stiffness||100,this.damping=c.damping||1,this.bodyA=a,this.bodyB=b,this.localAnchorA=new e,this.localAnchorB=new e,c.localAnchorA&&this.localAnchorA.copy(c.localAnchorA),c.localAnchorB&&this.localAnchorB.copy(c.localAnchorB),c.worldAnchorA&&this.setWorldAnchorA(c.worldAnchorA),c.worldAnchorB&&this.setWorldAnchorB(c.worldAnchorB)}var e=a("../math/Vec3");b.exports=d,d.prototype.setWorldAnchorA=function(a){this.bodyA.pointToLocalFrame(a,this.localAnchorA)},d.prototype.setWorldAnchorB=function(a){this.bodyB.pointToLocalFrame(a,this.localAnchorB)},d.prototype.getWorldAnchorA=function(a){this.bodyA.pointToWorldFrame(this.localAnchorA,a)},d.prototype.getWorldAnchorB=function(a){this.bodyB.pointToWorldFrame(this.localAnchorB,a)};var f=new e,g=new e,h=new e,i=new e,j=new e,k=new e,l=new e,m=new e,n=new e,o=new e,p=new e;d.prototype.applyForce=function(){var a=this.stiffness,b=this.damping,c=this.restLength,d=this.bodyA,e=this.bodyB,q=f,r=g,s=h,t=i,u=p,v=j,w=k,x=l,y=m,z=n,A=o;this.getWorldAnchorA(v),this.getWorldAnchorB(w),v.vsub(d.position,x),w.vsub(e.position,y),w.vsub(v,q);var B=q.norm();r.copy(q),r.normalize(),e.velocity.vsub(d.velocity,s),e.angularVelocity.cross(y,u),s.vadd(u,s),d.angularVelocity.cross(x,u),s.vsub(u,s),r.mult(-a*(B-c)-b*s.dot(r),t),d.force.vsub(t,d.force),e.force.vadd(t,e.force),x.cross(t,z),y.cross(t,A),d.torque.vsub(z,d.torque),e.torque.vadd(A,e.torque)}},{"../math/Vec3":30}],36:[function(a,b,c){function d(a){a=h.defaults(a,{chassisConnectionPointLocal:new e,chassisConnectionPointWorld:new e,directionLocal:new e,directionWorld:new e,axleLocal:new e,axleWorld:new e,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=a.maxSuspensionTravel,this.customSlidingRotationalSpeed=a.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=a.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=a.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=a.chassisConnectionPointWorld.clone(),this.directionLocal=a.directionLocal.clone(),this.directionWorld=a.directionWorld.clone(),this.axleLocal=a.axleLocal.clone(),this.axleWorld=a.axleWorld.clone(),this.suspensionRestLength=a.suspensionRestLength,this.suspensionMaxLength=a.suspensionMaxLength,this.radius=a.radius,this.suspensionStiffness=a.suspensionStiffness,this.dampingCompression=a.dampingCompression,this.dampingRelaxation=a.dampingRelaxation,this.frictionSlip=a.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=a.rollInfluence,this.maxSuspensionForce=a.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=a.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new g,this.worldTransform=new f,this.isInContact=!1}var e=a("../math/Vec3"),f=a("../math/Transform"),g=a("../collision/RaycastResult"),h=a("../utils/Utils");b.exports=d;var i=new e,j=new e,i=new e;d.prototype.updateWheel=function(a){var b=this.raycastResult;if(this.isInContact){var c=b.hitNormalWorld.dot(b.directionWorld);b.hitPointWorld.vsub(a.position,j),a.getVelocityAtWorldPoint(j,i);var d=b.hitNormalWorld.dot(i);if(c>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var e=-1/c;this.suspensionRelativeVelocity=d*e,this.clippedInvContactDotSuspension=e}}else b.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,b.directionWorld.scale(-1,b.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(a,b,c){function d(a){e.call(this),this.type=e.types.BOX,this.halfExtents=a,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}b.exports=d;var e=a("./Shape"),f=a("../math/Vec3"),g=a("./ConvexPolyhedron");d.prototype=new e,d.prototype.constructor=d,d.prototype.updateConvexPolyhedronRepresentation=function(){var a=this.halfExtents.x,b=this.halfExtents.y,c=this.halfExtents.z,d=f,e=[new d(-a,-b,-c),new d(a,-b,-c),new d(a,b,-c),new d(-a,b,-c),new d(-a,-b,c),new d(a,-b,c),new d(a,b,c),new d(-a,b,c)],h=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],i=([new d(0,0,1),new d(0,1,0),new d(1,0,0)],new g(e,h));this.convexPolyhedronRepresentation=i,i.material=this.material},d.prototype.calculateLocalInertia=function(a,b){return b=b||new f,d.calculateInertia(this.halfExtents,a,b),b},d.calculateInertia=function(a,b,c){var d=a;c.x=1/12*b*(2*d.y*2*d.y+2*d.z*2*d.z),c.y=1/12*b*(2*d.x*2*d.x+2*d.z*2*d.z),c.z=1/12*b*(2*d.y*2*d.y+2*d.x*2*d.x)},d.prototype.getSideNormals=function(a,b){var c=a,d=this.halfExtents;if(c[0].set(d.x,0,0),c[1].set(0,d.y,0),c[2].set(0,0,d.z),c[3].set(-d.x,0,0),c[4].set(0,-d.y,0),c[5].set(0,0,-d.z),void 0!==b)for(var e=0;e!==c.length;e++)b.vmult(c[e],c[e]);return c},d.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},d.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};{var h=new f;new f}d.prototype.forEachWorldCorner=function(a,b,c){for(var d=this.halfExtents,e=[[d.x,d.y,d.z],[-d.x,d.y,d.z],[-d.x,-d.y,d.z],[-d.x,-d.y,-d.z],[d.x,-d.y,-d.z],[d.x,d.y,-d.z],[-d.x,d.y,-d.z],[d.x,-d.y,d.z]],f=0;f<e.length;f++)h.set(e[f][0],e[f][1],e[f][2]),b.vmult(h,h),a.vadd(h,h),c(h.x,h.y,h.z)};var i=[new f,new f,new f,new f,new f,new f,new f,new f];d.prototype.calculateWorldAABB=function(a,b,c,d){var e=this.halfExtents;i[0].set(e.x,e.y,e.z),i[1].set(-e.x,e.y,e.z),i[2].set(-e.x,-e.y,e.z),i[3].set(-e.x,-e.y,-e.z),i[4].set(e.x,-e.y,-e.z),i[5].set(e.x,e.y,-e.z),i[6].set(-e.x,e.y,-e.z),i[7].set(e.x,-e.y,e.z);var f=i[0];b.vmult(f,f),a.vadd(f,f),d.copy(f),c.copy(f);for(var g=1;8>g;g++){var f=i[g];b.vmult(f,f),a.vadd(f,f);var h=f.x,j=f.y,k=f.z;h>d.x&&(d.x=h),j>d.y&&(d.y=j),k>d.z&&(d.z=k),h<c.x&&(c.x=h),j<c.y&&(c.y=j),k<c.z&&(c.z=k)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(a,b,c){function d(a,b,c){e.call(this),this.type=e.types.CONVEXPOLYHEDRON,this.vertices=a||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=b||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=c?c.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}b.exports=d;var e=a("./Shape"),f=a("../math/Vec3"),g=(a("../math/Quaternion"),a("../math/Transform"));d.prototype=new e,d.prototype.constructor=d;var h=new f;d.prototype.computeEdges=function(){var a=this.faces,b=this.vertices,c=(b.length,this.uniqueEdges);c.length=0;for(var d=h,e=0;e!==a.length;e++)for(var f=a[e],g=f.length,i=0;i!==g;i++){var j=(i+1)%g;b[f[i]].vsub(b[f[j]],d),d.normalize();for(var k=!1,l=0;l!==c.length;l++)if(c[l].almostEquals(d)||c[l].almostEquals(d)){k=!0;break}k||c.push(d.clone())}},d.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var a=0;a<this.faces.length;a++){for(var b=0;b<this.faces[a].length;b++)if(!this.vertices[this.faces[a][b]])throw new Error("Vertex "+this.faces[a][b]+" not found!");var c=this.faceNormals[a]||new f;this.getFaceNormal(a,c),c.negate(c),this.faceNormals[a]=c;var d=this.vertices[this.faces[a][0]];if(c.dot(d)<0){console.error(".faceNormals["+a+"] = Vec3("+c.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var b=0;b<this.faces[a].length;b++)console.warn(".vertices["+this.faces[a][b]+"] = Vec3("+this.vertices[this.faces[a][b]].toString()+")")}}};var i=new f,j=new f;d.computeNormal=function(a,b,c,d){b.vsub(a,j),c.vsub(b,i),i.cross(j,d),d.isZero()||d.normalize()},d.prototype.getFaceNormal=function(a,b){var c=this.faces[a],e=this.vertices[c[0]],f=this.vertices[c[1]],g=this.vertices[c[2]];return d.computeNormal(e,f,g,b)};var k=new f;d.prototype.clipAgainstHull=function(a,b,c,d,e,g,h,i,j){for(var l=k,m=-1,n=-Number.MAX_VALUE,o=0;o<c.faces.length;o++){l.copy(c.faceNormals[o]),e.vmult(l,l);var p=l.dot(g);p>n&&(n=p,m=o)}for(var q=[],r=c.faces[m],s=r.length,t=0;s>t;t++){var u=c.vertices[r[t]],v=new f;v.copy(u),e.vmult(v,v),d.vadd(v,v),q.push(v)}m>=0&&this.clipFaceAgainstHull(g,a,b,q,h,i,j)};var l=new f,m=new f,n=new f,o=new f,p=new f,q=new f;d.prototype.findSeparatingAxis=function(a,b,c,d,e,f,g,h){var i=l,j=m,k=n,r=o,s=p,t=q,u=Number.MAX_VALUE,v=this,w=0;if(v.uniqueAxes)for(var x=0;x!==v.uniqueAxes.length;x++){c.vmult(v.uniqueAxes[x],i);var y=v.testSepAxis(i,a,b,c,d,e);if(y===!1)return!1;u>y&&(u=y,f.copy(i))}else for(var z=g?g.length:v.faces.length,x=0;z>x;x++){var A=g?g[x]:x;i.copy(v.faceNormals[A]),c.vmult(i,i);var y=v.testSepAxis(i,a,b,c,d,e);if(y===!1)return!1;u>y&&(u=y,f.copy(i))}if(a.uniqueAxes)for(var x=0;x!==a.uniqueAxes.length;x++){e.vmult(a.uniqueAxes[x],j),w++;var y=v.testSepAxis(j,a,b,c,d,e);if(y===!1)return!1;u>y&&(u=y,f.copy(j))}else for(var B=h?h.length:a.faces.length,x=0;B>x;x++){var A=h?h[x]:x;j.copy(a.faceNormals[A]),e.vmult(j,j),w++;var y=v.testSepAxis(j,a,b,c,d,e);if(y===!1)return!1;u>y&&(u=y,f.copy(j))}for(var C=0;C!==v.uniqueEdges.length;C++){c.vmult(v.uniqueEdges[C],r);for(var D=0;D!==a.uniqueEdges.length;D++)if(e.vmult(a.uniqueEdges[D],s),r.cross(s,t),!t.almostZero()){t.normalize();var E=v.testSepAxis(t,a,b,c,d,e);if(E===!1)return!1;u>E&&(u=E,f.copy(t))}}return d.vsub(b,k),k.dot(f)>0&&f.negate(f),!0};var r=[],s=[];d.prototype.testSepAxis=function(a,b,c,e,f,g){var h=this;d.project(h,a,c,e,r),d.project(b,a,f,g,s);var i=r[0],j=r[1],k=s[0],l=s[1];if(l>i||j>k)return!1;var m=i-l,n=k-j,o=n>m?m:n;return o};var t=new f,u=new f;d.prototype.calculateLocalInertia=function(a,b){this.computeLocalAABB(t,u);var c=u.x-t.x,d=u.y-t.y,e=u.z-t.z;b.x=1/12*a*(2*d*2*d+2*e*2*e),b.y=1/12*a*(2*c*2*c+2*e*2*e),b.z=1/12*a*(2*d*2*d+2*c*2*c)},d.prototype.getPlaneConstantOfFace=function(a){var b=this.faces[a],c=this.faceNormals[a],d=this.vertices[b[0]],e=-c.dot(d);return e};var v=new f,w=new f,x=new f,y=new f,z=new f,A=new f,B=new f,C=new f;d.prototype.clipFaceAgainstHull=function(a,b,c,d,e,f,g){for(var h=v,i=w,j=x,k=y,l=z,m=A,n=B,o=C,p=this,q=[],r=d,s=q,t=-1,u=Number.MAX_VALUE,D=0;D<p.faces.length;D++){h.copy(p.faceNormals[D]),c.vmult(h,h);var E=h.dot(a);u>E&&(u=E,t=D)}if(!(0>t)){var F=p.faces[t];F.connectedFaces=[];for(var G=0;G<p.faces.length;G++)for(var H=0;H<p.faces[G].length;H++)-1!==F.indexOf(p.faces[G][H])&&G!==t&&-1===F.connectedFaces.indexOf(G)&&F.connectedFaces.push(G);for(var I=(r.length,F.length),J=0;I>J;J++){var K=p.vertices[F[J]],L=p.vertices[F[(J+1)%I]];K.vsub(L,i),j.copy(i),c.vmult(j,j),b.vadd(j,j),k.copy(this.faceNormals[t]),c.vmult(k,k),b.vadd(k,k),j.cross(k,l),l.negate(l),m.copy(K),c.vmult(m,m),b.vadd(m,m);var M,N=(-m.dot(l),F.connectedFaces[J]);n.copy(this.faceNormals[N]);var O=this.getPlaneConstantOfFace(N);o.copy(n),c.vmult(o,o);var M=O-o.dot(b);for(this.clipFaceAgainstPlane(r,s,o,M);r.length;)r.shift();for(;s.length;)r.push(s.shift())}n.copy(this.faceNormals[t]);var O=this.getPlaneConstantOfFace(t);o.copy(n),c.vmult(o,o);for(var M=O-o.dot(b),G=0;G<r.length;G++){var P=o.dot(r[G])+M;if(e>=P&&(console.log("clamped: depth="+P+" to minDist="+(e+"")),P=e),f>=P){var Q=r[G];if(0>=P){var R={point:Q,normal:o,depth:P};g.push(R)}}}}},d.prototype.clipFaceAgainstPlane=function(a,b,c,d){var e,g,h=a.length;if(2>h)return b;var i=a[a.length-1],j=a[0];e=c.dot(i)+d;for(var k=0;h>k;k++){if(j=a[k],g=c.dot(j)+d,0>e)if(0>g){var l=new f;l.copy(j),b.push(l)}else{var l=new f;i.lerp(j,e/(e-g),l),b.push(l)}else if(0>g){var l=new f;i.lerp(j,e/(e-g),l),b.push(l),b.push(j)}i=j,e=g}return b},d.prototype.computeWorldVertices=function(a,b){for(var c=this.vertices.length;this.worldVertices.length<c;)this.worldVertices.push(new f);for(var d=this.vertices,e=this.worldVertices,g=0;g!==c;g++)b.vmult(d[g],e[g]),a.vadd(e[g],e[g]);this.worldVerticesNeedsUpdate=!1};new f;d.prototype.computeLocalAABB=function(a,b){var c=this.vertices.length,d=this.vertices;a.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),b.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var e=0;c>e;e++){var f=d[e];f.x<a.x?a.x=f.x:f.x>b.x&&(b.x=f.x),f.y<a.y?a.y=f.y:f.y>b.y&&(b.y=f.y),f.z<a.z?a.z=f.z:f.z>b.z&&(b.z=f.z)}},d.prototype.computeWorldFaceNormals=function(a){for(var b=this.faceNormals.length;this.worldFaceNormals.length<b;)this.worldFaceNormals.push(new f);for(var c=this.faceNormals,d=this.worldFaceNormals,e=0;e!==b;e++)a.vmult(c[e],d[e]);this.worldFaceNormalsNeedsUpdate=!1},d.prototype.updateBoundingSphereRadius=function(){for(var a=0,b=this.vertices,c=0,d=b.length;c!==d;c++){var e=b[c].norm2();e>a&&(a=e)}this.boundingSphereRadius=Math.sqrt(a)};var D=new f;d.prototype.calculateWorldAABB=function(a,b,c,d){for(var e,f,g,h,i,j,k=this.vertices.length,l=this.vertices,m=0;k>m;m++){D.copy(l[m]),b.vmult(D,D),a.vadd(D,D);var n=D;n.x<e||void 0===e?e=n.x:(n.x>h||void 0===h)&&(h=n.x),n.y<f||void 0===f?f=n.y:(n.y>i||void 0===i)&&(i=n.y),n.z<g||void 0===g?g=n.z:(n.z>j||void 0===j)&&(j=n.z)}c.set(e,f,g),d.set(h,i,j)},d.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},d.prototype.getAveragePointLocal=function(a){a=a||new f;for(var b=this.vertices.length,c=this.vertices,d=0;b>d;d++)a.vadd(c[d],a);return a.mult(1/b,a),a},d.prototype.transformAllPoints=function(a,b){var c=this.vertices.length,d=this.vertices;if(b){for(var e=0;c>e;e++){var f=d[e];b.vmult(f,f)}for(var e=0;e<this.faceNormals.length;e++){var f=this.faceNormals[e];b.vmult(f,f)}}if(a)for(var e=0;c>e;e++){var f=d[e];f.vadd(a,f)}};var E=new f,F=new f,G=new f;d.prototype.pointIsInside=function(a){var b=this.vertices.length,c=this.vertices,d=this.faces,e=this.faceNormals,f=null,g=this.faces.length,h=E;this.getAveragePointLocal(h);for(var i=0;g>i;i++){var b=(this.faces[i].length,e[i]),j=c[d[i][0]],k=F;a.vsub(j,k);var l=b.dot(k),m=G;h.vsub(j,m);var n=b.dot(m);if(0>l&&n>0||l>0&&0>n)return!1}return f?1:-1};var H=(new f,new f),I=new f;d.project=function(a,b,c,d,e){var f=a.vertices.length,h=H,i=0,j=0,k=I,l=a.vertices;k.setZero(),g.vectorToLocalFrame(c,d,b,h),g.pointToLocalFrame(c,d,k,k);var m=k.dot(h);j=i=l[0].dot(h);for(var n=1;f>n;n++){var o=l[n].dot(h);o>i&&(i=o),j>o&&(j=o)}if(j-=m,i-=m,j>i){var p=j;j=i,i=p}e[0]=i,e[1]=j}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(a,b,c){function d(a,b,c,d){var h=d,i=[],j=[],k=[],l=[],m=[],n=Math.cos,o=Math.sin;i.push(new f(b*n(0),b*o(0),.5*-c)),l.push(0),i.push(new f(a*n(0),a*o(0),.5*c)),m.push(1);for(var p=0;h>p;p++){var q=2*Math.PI/h*(p+1),r=2*Math.PI/h*(p+.5);h-1>p?(i.push(new f(b*n(q),b*o(q),.5*-c)),l.push(2*p+2),i.push(new f(a*n(q),a*o(q),.5*c)),m.push(2*p+3),k.push([2*p+2,2*p+3,2*p+1,2*p])):k.push([0,1,2*p+1,2*p]),(h%2===1||h/2>p)&&j.push(new f(n(r),o(r),0))}k.push(m),j.push(new f(0,0,1));for(var s=[],p=0;p<l.length;p++)s.push(l[l.length-p-1]);k.push(s),this.type=e.types.CONVEXPOLYHEDRON,g.call(this,i,k,j)}b.exports=d;var e=a("./Shape"),f=a("../math/Vec3"),g=(a("../math/Quaternion"),a("./ConvexPolyhedron"));d.prototype=new g},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(a,b,c){function d(a,b){b=h.defaults(b,{maxValue:null,minValue:null,elementSize:1}),this.data=a,this.maxValue=b.maxValue,this.minValue=b.minValue,this.elementSize=b.elementSize,null===b.minValue&&this.updateMinValue(),null===b.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,e.call(this),this.pillarConvex=new f,this.pillarOffset=new g,this.type=e.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}var e=a("./Shape"),f=a("./ConvexPolyhedron"),g=a("../math/Vec3"),h=a("../utils/Utils");b.exports=d,d.prototype=new e,d.prototype.update=function(){this._cachedPillars={}},d.prototype.updateMinValue=function(){for(var a=this.data,b=a[0][0],c=0;c!==a.length;c++)for(var d=0;d!==a[c].length;d++){var e=a[c][d];b>e&&(b=e)}this.minValue=b},d.prototype.updateMaxValue=function(){for(var a=this.data,b=a[0][0],c=0;c!==a.length;c++)for(var d=0;d!==a[c].length;d++){var e=a[c][d];e>b&&(b=e)}this.maxValue=b},d.prototype.setHeightValueAtIndex=function(a,b,c){var d=this.data;d[a][b]=c,this.clearCachedConvexTrianglePillar(a,b,!1),a>0&&(this.clearCachedConvexTrianglePillar(a-1,b,!0),this.clearCachedConvexTrianglePillar(a-1,b,!1)),b>0&&(this.clearCachedConvexTrianglePillar(a,b-1,!0),this.clearCachedConvexTrianglePillar(a,b-1,!1)),b>0&&a>0&&this.clearCachedConvexTrianglePillar(a-1,b-1,!0)},d.prototype.getRectMinMax=function(a,b,c,d,e){e=e||[];for(var f=this.data,g=this.minValue,h=a;c>=h;h++)for(var i=b;d>=i;i++){var j=f[h][i];j>g&&(g=j)}e[0]=this.minValue,e[1]=g},d.prototype.getIndexOfPosition=function(a,b,c,d){var e=this.elementSize,f=this.data,g=Math.floor(a/e),h=Math.floor(b/e);return c[0]=g,c[1]=h,d&&(0>g&&(g=0),0>h&&(h=0),g>=f.length-1&&(g=f.length-1),h>=f[0].length-1&&(h=f[0].length-1)),0>g||0>h||g>=f.length-1||h>=f[0].length-1?!1:!0},d.prototype.getHeightAt=function(a,b,c){var d=[];this.getIndexOfPosition(a,b,d,c);var e=[];return this.getRectMinMax(d[0],d[1]+1,d[0],d[1]+1,e),(e[0]+e[1])/2},d.prototype.getCacheConvexTrianglePillarKey=function(a,b,c){return a+"_"+b+"_"+(c?1:0)},d.prototype.getCachedConvexTrianglePillar=function(a,b,c){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(a,b,c)]},d.prototype.setCachedConvexTrianglePillar=function(a,b,c,d,e){this._cachedPillars[this.getCacheConvexTrianglePillarKey(a,b,c)]={convex:d,offset:e}},d.prototype.clearCachedConvexTrianglePillar=function(a,b,c){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(a,b,c)]},d.prototype.getConvexTrianglePillar=function(a,b,c){var d=this.pillarConvex,e=this.pillarOffset;if(this.cacheEnabled){var h=this.getCachedConvexTrianglePillar(a,b,c);if(h)return this.pillarConvex=h.convex,void(this.pillarOffset=h.offset);d=new f,e=new g,this.pillarConvex=d,this.pillarOffset=e}var h=this.data,i=this.elementSize,j=d.faces;d.vertices.length=6;for(var k=0;6>k;k++)d.vertices[k]||(d.vertices[k]=new g);j.length=5;for(var k=0;5>k;k++)j[k]||(j[k]=[]);var l=d.vertices,m=(Math.min(h[a][b],h[a+1][b],h[a][b+1],h[a+1][b+1])-this.minValue)/2+this.minValue;c?(e.set((a+.75)*i,(b+.75)*i,m),l[0].set(.25*i,.25*i,h[a+1][b+1]-m),l[1].set(-.75*i,.25*i,h[a][b+1]-m),l[2].set(.25*i,-.75*i,h[a+1][b]-m),l[3].set(.25*i,.25*i,-m-1),l[4].set(-.75*i,.25*i,-m-1),l[5].set(.25*i,-.75*i,-m-1),j[0][0]=0,j[0][1]=1,j[0][2]=2,j[1][0]=5,j[1][1]=4,j[1][2]=3,j[2][0]=2,j[2][1]=5,j[2][2]=3,j[2][3]=0,j[3][0]=3,j[3][1]=4,j[3][2]=1,j[3][3]=0,j[4][0]=1,j[4][1]=4,j[4][2]=5,j[4][3]=2):(e.set((a+.25)*i,(b+.25)*i,m),l[0].set(-.25*i,-.25*i,h[a][b]-m),l[1].set(.75*i,-.25*i,h[a+1][b]-m),l[2].set(-.25*i,.75*i,h[a][b+1]-m),l[3].set(-.25*i,-.25*i,-m-1),l[4].set(.75*i,-.25*i,-m-1),l[5].set(-.25*i,.75*i,-m-1),j[0][0]=0,j[0][1]=1,j[0][2]=2,j[1][0]=5,j[1][1]=4,j[1][2]=3,j[2][0]=0,j[2][1]=2,j[2][2]=5,j[2][3]=3,j[3][0]=1,j[3][1]=0,j[3][2]=3,j[3][3]=4,j[4][0]=4,j[4][1]=5,j[4][2]=2,j[4][3]=1),d.computeNormals(),d.computeEdges(),d.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(a,b,c,d,e)},d.prototype.calculateLocalInertia=function(a,b){return b=b||new g,b.set(0,0,0),b},d.prototype.volume=function(){return Number.MAX_VALUE},d.prototype.calculateWorldAABB=function(a,b,c,d){c.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),d.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},d.prototype.updateBoundingSphereRadius=function(){var a=this.data,b=this.elementSize;this.boundingSphereRadius=new g(a.length*b,a[0].length*b,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(a,b,c){function d(){e.call(this),this.type=e.types.PARTICLE}b.exports=d;var e=a("./Shape"),f=a("../math/Vec3");d.prototype=new e,d.prototype.constructor=d,d.prototype.calculateLocalInertia=function(a,b){return b=b||new f,b.set(0,0,0),b},d.prototype.volume=function(){return 0},d.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},d.prototype.calculateWorldAABB=function(a,b,c,d){c.copy(a),d.copy(a)}},{"../math/Vec3":30,"./Shape":43}],42:[function(a,b,c){function d(){e.call(this),this.type=e.types.PLANE,this.worldNormal=new f,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}b.exports=d;var e=a("./Shape"),f=a("../math/Vec3");d.prototype=new e,d.prototype.constructor=d,d.prototype.computeWorldNormal=function(a){var b=this.worldNormal;b.set(0,0,1),a.vmult(b,b),this.worldNormalNeedsUpdate=!1},d.prototype.calculateLocalInertia=function(a,b){return b=b||new f},d.prototype.volume=function(){return Number.MAX_VALUE};var g=new f;d.prototype.calculateWorldAABB=function(a,b,c,d){g.set(0,0,1),b.vmult(g,g);var e=Number.MAX_VALUE;c.set(-e,-e,-e),d.set(e,e,e),1===g.x&&(d.x=a.x),1===g.y&&(d.y=a.y),1===g.z&&(d.z=a.z),-1===g.x&&(c.x=a.x),-1===g.y&&(c.y=a.y),-1===g.z&&(c.z=a.z)},d.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(a,b,c){function d(){this.id=d.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}b.exports=d;{var d=a("./Shape");a("../math/Vec3"),a("../math/Quaternion"),a("../material/Material")}d.prototype.constructor=d,d.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},d.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},d.prototype.calculateLocalInertia=function(a,b){throw"calculateLocalInertia() not implemented for shape type "+this.type},d.idCounter=0,d.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(a,b,c){function d(a){if(e.call(this),this.radius=void 0!==a?Number(a):1,this.type=e.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}b.exports=d;var e=a("./Shape"),f=a("../math/Vec3");d.prototype=new e,d.prototype.constructor=d,d.prototype.calculateLocalInertia=function(a,b){b=b||new f;var c=2*a*this.radius*this.radius/5;return b.x=c,b.y=c,b.z=c,b},d.prototype.volume=function(){return 4*Math.PI*this.radius/3},d.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},d.prototype.calculateWorldAABB=function(a,b,c,d){for(var e=this.radius,f=["x","y","z"],g=0;g<f.length;g++){var h=f[g];c[h]=a[h]-e,d[h]=a[h]+e}}},{"../math/Vec3":30,"./Shape":43}],45:[function(a,b,c){function d(a,b){e.call(this),this.type=e.types.TRIMESH,this.vertices=new Float32Array(a),this.indices=new Int16Array(b),this.normals=new Float32Array(b.length),this.aabb=new h,this.edges=null,this.scale=new f(1,1,1),this.tree=new i,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}b.exports=d;var e=a("./Shape"),f=a("../math/Vec3"),g=(a("../math/Quaternion"),a("../math/Transform")),h=a("../collision/AABB"),i=a("../utils/Octree");d.prototype=new e,d.prototype.constructor=d;var j=new f;d.prototype.updateTree=function(){var a=this.tree;a.reset(),a.aabb.copy(this.aabb);var b=this.scale;a.aabb.lowerBound.x*=1/b.x,a.aabb.lowerBound.y*=1/b.y,a.aabb.lowerBound.z*=1/b.z,a.aabb.upperBound.x*=1/b.x,a.aabb.upperBound.y*=1/b.y,a.aabb.upperBound.z*=1/b.z;for(var c=new h,d=new f,e=new f,g=new f,i=[d,e,g],j=0;j<this.indices.length/3;j++){var k=3*j;this._getUnscaledVertex(this.indices[k],d),this._getUnscaledVertex(this.indices[k+1],e),this._getUnscaledVertex(this.indices[k+2],g),c.setFromPoints(i),a.insert(c,j)}a.removeEmptyNodes()};var k=new h;d.prototype.getTrianglesInAABB=function(a,b){k.copy(a);var c=this.scale,d=c.x,e=c.y,f=c.z,g=k.lowerBound,h=k.upperBound;return g.x/=d,g.y/=e,g.z/=f,h.x/=d,h.y/=e,h.z/=f,this.tree.aabbQuery(k,b)},d.prototype.setScale=function(a){var b=this.scale.x===this.scale.y===this.scale.z,c=a.x===a.y===a.z;b&&c||this.updateNormals(),this.scale.copy(a),this.updateAABB(),this.updateBoundingSphereRadius()},d.prototype.updateNormals=function(){for(var a=j,b=this.normals,c=0;c<this.indices.length/3;c++){var e=3*c,f=this.indices[e],g=this.indices[e+1],h=this.indices[e+2];this.getVertex(f,p),this.getVertex(g,q),this.getVertex(h,r),d.computeNormal(q,p,r,a),b[e]=a.x,b[e+1]=a.y,b[e+2]=a.z}},d.prototype.updateEdges=function(){for(var a={},b=function(b,c){var d=f>e?e+"_"+f:f+"_"+e;a[d]=!0},c=0;c<this.indices.length/3;c++){var d=3*c,e=this.indices[d],f=this.indices[d+1],g=this.indices[d+2];b(e,f),b(f,g),b(g,e)}var h=Object.keys(a);this.edges=new Int16Array(2*h.length);for(var c=0;c<h.length;c++){var i=h[c].split("_");this.edges[2*c]=parseInt(i[0],10),this.edges[2*c+1]=parseInt(i[1],10)}},d.prototype.getEdgeVertex=function(a,b,c){var d=this.edges[2*a+(b?1:0)];this.getVertex(d,c)};var l=new f,m=new f;d.prototype.getEdgeVector=function(a,b){var c=l,d=m;this.getEdgeVertex(a,0,c),this.getEdgeVertex(a,1,d),d.vsub(c,b)};var n=new f,o=new f;d.computeNormal=function(a,b,c,d){b.vsub(a,o),c.vsub(b,n),n.cross(o,d),d.isZero()||d.normalize()};var p=new f,q=new f,r=new f;d.prototype.getVertex=function(a,b){var c=this.scale;return this._getUnscaledVertex(a,b),b.x*=c.x,b.y*=c.y,b.z*=c.z,b},d.prototype._getUnscaledVertex=function(a,b){var c=3*a,d=this.vertices;return b.set(d[c],d[c+1],d[c+2])},d.prototype.getWorldVertex=function(a,b,c,d){return this.getVertex(a,d),g.pointToWorldFrame(b,c,d,d),d},d.prototype.getTriangleVertices=function(a,b,c,d){var e=3*a;this.getVertex(this.indices[e],b),this.getVertex(this.indices[e+1],c),this.getVertex(this.indices[e+2],d)},d.prototype.getNormal=function(a,b){var c=3*a;return b.set(this.normals[c],this.normals[c+1],this.normals[c+2])};var s=new h;d.prototype.calculateLocalInertia=function(a,b){this.computeLocalAABB(s);var c=s.upperBound.x-s.lowerBound.x,d=s.upperBound.y-s.lowerBound.y,e=s.upperBound.z-s.lowerBound.z;return b.set(1/12*a*(2*d*2*d+2*e*2*e),1/12*a*(2*c*2*c+2*e*2*e),1/12*a*(2*d*2*d+2*c*2*c))};var t=new f;d.prototype.computeLocalAABB=function(a){var b=a.lowerBound,c=a.upperBound,d=this.vertices.length,e=(this.vertices,t);this.getVertex(0,e),b.copy(e),c.copy(e);for(var f=0;f!==d;f++)this.getVertex(f,e),e.x<b.x?b.x=e.x:e.x>c.x&&(c.x=e.x),e.y<b.y?b.y=e.y:e.y>c.y&&(c.y=e.y),e.z<b.z?b.z=e.z:e.z>c.z&&(c.z=e.z)},d.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},d.prototype.updateBoundingSphereRadius=function(){for(var a=0,b=this.vertices,c=new f,d=0,e=b.length/3;d!==e;d++){this.getVertex(d,c);var g=c.norm2();g>a&&(a=g)}this.boundingSphereRadius=Math.sqrt(a)};var u=(new f,new g),v=new h;d.prototype.calculateWorldAABB=function(a,b,c,d){var e=u,f=v;e.position=a,e.quaternion=b,this.aabb.toWorldFrame(e,f),c.copy(f.lowerBound),d.copy(f.upperBound)},d.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},d.createTorus=function(a,b,c,e,f){a=a||1,b=b||.5,c=c||8,e=e||6,f=f||2*Math.PI;for(var g=[],h=[],i=0;c>=i;i++)for(var j=0;e>=j;j++){var k=j/e*f,l=i/c*Math.PI*2,m=(a+b*Math.cos(l))*Math.cos(k),n=(a+b*Math.cos(l))*Math.sin(k),o=b*Math.sin(l);g.push(m,n,o)}for(var i=1;c>=i;i++)for(var j=1;e>=j;j++){var p=(e+1)*i+j-1,q=(e+1)*(i-1)+j-1,r=(e+1)*(i-1)+j,s=(e+1)*i+j;h.push(p,q,s),h.push(q,r,s)}return new d(g,h)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(a,b,c){function d(){e.call(this),this.iterations=10,
this.tolerance=1e-7}b.exports=d;var e=(a("../math/Vec3"),a("../math/Quaternion"),a("./Solver"));d.prototype=new e;var f=[],g=[],h=[];d.prototype.solve=function(a,b){var c,d,e,i,j,k,l=0,m=this.iterations,n=this.tolerance*this.tolerance,o=this.equations,p=o.length,q=b.bodies,r=q.length,s=a;if(0!==p)for(var t=0;t!==r;t++)q[t].updateSolveMassProperties();var u=g,v=h,w=f;u.length=p,v.length=p,w.length=p;for(var t=0;t!==p;t++){var x=o[t];w[t]=0,v[t]=x.computeB(s),u[t]=1/x.computeC()}if(0!==p){for(var t=0;t!==r;t++){var y=q[t],z=y.vlambda,A=y.wlambda;z.set(0,0,0),A&&A.set(0,0,0)}for(l=0;l!==m;l++){i=0;for(var B=0;B!==p;B++){var x=o[B];c=v[B],d=u[B],k=w[B],j=x.computeGWlambda(),e=d*(c-j-x.eps*k),k+e<x.minForce?e=x.minForce-k:k+e>x.maxForce&&(e=x.maxForce-k),w[B]+=e,i+=e>0?e:-e,x.addToWlambda(e)}if(n>i*i)break}for(var t=0;t!==r;t++){var y=q[t],C=y.velocity,D=y.angularVelocity;C.vadd(y.vlambda,C),D&&D.vadd(y.wlambda,D)}}return l}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(a,b,c){function d(){this.equations=[]}b.exports=d,d.prototype.solve=function(a,b){return 0},d.prototype.addEquation=function(a){a.enabled&&this.equations.push(a)},d.prototype.removeEquation=function(a){var b=this.equations,c=b.indexOf(a);-1!==c&&b.splice(c,1)},d.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(a,b,c){function d(a){for(i.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=a,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}function e(a){for(var b=a.length,c=0;c!==b;c++){var d=a[c];if(!(d.visited||d.body.type&n))return d}return!1}function f(a,b,c,d){for(o.push(a),a.visited=!0,b(a,c,d);o.length;)for(var f,g=o.pop();f=e(g.children);)f.visited=!0,b(f,c,d),o.push(f)}function g(a,b,c){b.push(a.body);for(var d=a.eqs.length,e=0;e!==d;e++){var f=a.eqs[e];-1===c.indexOf(f)&&c.push(f)}}function h(a,b){return b.id-a.id}b.exports=d;var i=(a("../math/Vec3"),a("../math/Quaternion"),a("./Solver")),j=a("../objects/Body");d.prototype=new i;var k=[],l=[],m={bodies:[]},n=j.STATIC,o=[];d.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},d.prototype.solve=function(a,b){for(var c=k,d=this.nodePool,i=b.bodies,j=this.equations,n=j.length,o=i.length,p=this.subsolver;d.length<o;)d.push(this.createNode());c.length=o;for(var q=0;o>q;q++)c[q]=d[q];for(var q=0;q!==o;q++){var r=c[q];r.body=i[q],r.children.length=0,r.eqs.length=0,r.visited=!1}for(var s=0;s!==n;s++){var t=j[s],q=i.indexOf(t.bi),u=i.indexOf(t.bj),v=c[q],w=c[u];v.children.push(w),v.eqs.push(t),w.children.push(v),w.eqs.push(t)}var x,y=0,z=l;p.tolerance=this.tolerance,p.iterations=this.iterations;for(var A=m;x=e(c);){z.length=0,A.bodies.length=0,f(x,g,A.bodies,z);var B=z.length;z=z.sort(h);for(var q=0;q!==B;q++)p.addEquation(z[q]);{p.solve(a,A)}p.removeAllEquations(),y++}return y}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(a,b,c){var d=function(){};b.exports=d,d.prototype={constructor:d,addEventListener:function(a,b){void 0===this._listeners&&(this._listeners={});var c=this._listeners;return void 0===c[a]&&(c[a]=[]),-1===c[a].indexOf(b)&&c[a].push(b),this},hasEventListener:function(a,b){if(void 0===this._listeners)return!1;var c=this._listeners;return void 0!==c[a]&&-1!==c[a].indexOf(b)?!0:!1},removeEventListener:function(a,b){if(void 0===this._listeners)return this;var c=this._listeners;if(void 0===c[a])return this;var d=c[a].indexOf(b);return-1!==d&&c[a].splice(d,1),this},dispatchEvent:function(a){if(void 0===this._listeners)return this;var b=this._listeners,c=b[a.type];if(void 0!==c){a.target=this;for(var d=0,e=c.length;e>d;d++)c[d].call(this,a)}return this}}},{}],50:[function(a,b,c){function d(a){a=a||{},this.root=a.root||null,this.aabb=a.aabb?a.aabb.clone():new f,this.data=[],this.children=[]}function e(a,b){b=b||{},b.root=null,b.aabb=a,d.call(this,b),this.maxDepth="undefined"!=typeof b.maxDepth?b.maxDepth:8}var f=a("../collision/AABB"),g=a("../math/Vec3");b.exports=e,e.prototype=new d,d.prototype.reset=function(a,b){this.children.length=this.data.length=0},d.prototype.insert=function(a,b,c){var d=this.data;if(c=c||0,!this.aabb.contains(a))return!1;var e=this.children;if(c<(this.maxDepth||this.root.maxDepth)){var f=!1;e.length||(this.subdivide(),f=!0);for(var g=0;8!==g;g++)if(e[g].insert(a,b,c+1))return!0;f&&(e.length=0)}return d.push(b),!0};var h=new g;d.prototype.subdivide=function(){var a=this.aabb,b=a.lowerBound,c=a.upperBound,e=this.children;e.push(new d({aabb:new f({lowerBound:new g(0,0,0)})}),new d({aabb:new f({lowerBound:new g(1,0,0)})}),new d({aabb:new f({lowerBound:new g(1,1,0)})}),new d({aabb:new f({lowerBound:new g(1,1,1)})}),new d({aabb:new f({lowerBound:new g(0,1,1)})}),new d({aabb:new f({lowerBound:new g(0,0,1)})}),new d({aabb:new f({lowerBound:new g(1,0,1)})}),new d({aabb:new f({lowerBound:new g(0,1,0)})})),c.vsub(b,h),h.scale(.5,h);for(var i=this.root||this,j=0;8!==j;j++){var k=e[j];k.root=i;var l=k.aabb.lowerBound;l.x*=h.x,l.y*=h.y,l.z*=h.z,l.vadd(b,l),l.vadd(h,k.aabb.upperBound)}},d.prototype.aabbQuery=function(a,b){for(var c=(this.data,this.children,[this]);c.length;){var d=c.pop();d.aabb.overlaps(a)&&Array.prototype.push.apply(b,d.data),Array.prototype.push.apply(c,d.children)}return b};var i=new f;d.prototype.rayQuery=function(a,b,c){return a.getAABB(i),i.toLocalFrame(b,i),this.aabbQuery(i,c),c},d.prototype.removeEmptyNodes=function(){for(var a=[this];a.length;){for(var b=a.pop(),c=b.children.length-1;c>=0;c--)b.children[c].data.length||b.children.splice(c,1);Array.prototype.push.apply(a,b.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(a,b,c){function d(){this.objects=[],this.type=Object}b.exports=d,d.prototype.release=function(){for(var a=arguments.length,b=0;b!==a;b++)this.objects.push(arguments[b])},d.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},d.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(a,b,c){function d(){this.data={keys:[]}}b.exports=d,d.prototype.get=function(a,b){if(a>b){var c=b;b=a,a=c}return this.data[a+"-"+b]},d.prototype.set=function(a,b,c){if(a>b){var d=b;b=a,a=d}var e=a+"-"+b;this.get(a,b)||this.data.keys.push(e),this.data[e]=c},d.prototype.reset=function(){for(var a=this.data,b=a.keys;b.length>0;){var c=b.pop();delete a[c]}}},{}],53:[function(a,b,c){function d(){}b.exports=d,d.defaults=function(a,b){a=a||{};for(var c in b)c in a||(a[c]=b[c]);return a}},{}],54:[function(a,b,c){function d(){f.call(this),this.type=e}b.exports=d;var e=a("../math/Vec3"),f=a("./Pool");d.prototype=new f,d.prototype.constructObject=function(){return new e}},{"../math/Vec3":30,"./Pool":51}],55:[function(a,b,c){function d(a){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new l,this.world=a,this.currentContactMaterial=null,this.enableFrictionReduction=!1}function e(a,b,c){for(var d=null,e=a.length,f=0;f!==e;f++){var g=a[f],h=P;a[(f+1)%e].vsub(g,h);var i=Q;h.cross(b,i);var j=R;c.vsub(g,j);var k=i.dot(j);if(!(null===d||k>0&&d===!0||0>=k&&d===!1))return!1;null===d&&(d=k>0)}return!0}b.exports=d;var f=a("../collision/AABB"),g=a("../shapes/Shape"),h=a("../collision/Ray"),i=a("../math/Vec3"),j=a("../math/Transform"),k=(a("../shapes/ConvexPolyhedron"),a("../math/Quaternion")),l=(a("../solver/Solver"),a("../utils/Vec3Pool")),m=a("../equations/ContactEquation"),n=a("../equations/FrictionEquation");d.prototype.createContactEquation=function(a,b,c,d,e,f){var g;this.contactPointPool.length?(g=this.contactPointPool.pop(),g.bi=a,g.bj=b):g=new m(a,b),g.enabled=a.collisionResponse&&b.collisionResponse&&c.collisionResponse&&d.collisionResponse;var h=this.currentContactMaterial;g.restitution=h.restitution,g.setSpookParams(h.contactEquationStiffness,h.contactEquationRelaxation,this.world.dt);var i=c.material||a.material,j=d.material||b.material;return i&&j&&i.restitution>=0&&j.restitution>=0&&(g.restitution=i.restitution*j.restitution),g.si=e||c,g.sj=f||d,g},d.prototype.createFrictionEquationsFromContact=function(a,b){var c=a.bi,d=a.bj,e=a.si,f=a.sj,g=this.world,h=this.currentContactMaterial,i=h.friction,j=e.material||c.material,k=f.material||d.material;if(j&&k&&j.friction>=0&&k.friction>=0&&(i=j.friction*k.friction),i>0){var l=i*g.gravity.length(),m=c.invMass+d.invMass;m>0&&(m=1/m);var o=this.frictionEquationPool,p=o.length?o.pop():new n(c,d,l*m),q=o.length?o.pop():new n(c,d,l*m);return p.bi=q.bi=c,p.bj=q.bj=d,p.minForce=q.minForce=-l*m,p.maxForce=q.maxForce=l*m,p.ri.copy(a.ri),p.rj.copy(a.rj),q.ri.copy(a.ri),q.rj.copy(a.rj),a.ni.tangents(p.t,q.t),p.setSpookParams(h.frictionEquationStiffness,h.frictionEquationRelaxation,g.dt),q.setSpookParams(h.frictionEquationStiffness,h.frictionEquationRelaxation,g.dt),p.enabled=q.enabled=a.enabled,b.push(p,q),!0}return!1};var o=new i,p=new i,q=new i;d.prototype.createFrictionFromAverage=function(a){var b=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(b,this.frictionResult)&&1!==a){var c=this.frictionResult[this.frictionResult.length-2],d=this.frictionResult[this.frictionResult.length-1];o.setZero(),p.setZero(),q.setZero();for(var e=b.bi,f=(b.bj,0);f!==a;f++)b=this.result[this.result.length-1-f],b.bodyA!==e?(o.vadd(b.ni,o),p.vadd(b.ri,p),q.vadd(b.rj,q)):(o.vsub(b.ni,o),p.vadd(b.rj,p),q.vadd(b.ri,q));var g=1/a;p.scale(g,c.ri),q.scale(g,c.rj),d.ri.copy(c.ri),d.rj.copy(c.rj),o.normalize(),o.tangents(c.t,d.t)}};var r=new i,s=new i,t=new k,u=new k;d.prototype.getContacts=function(a,b,c,d,e,f,g){this.contactPointPool=e,this.frictionEquationPool=g,this.result=d,this.frictionResult=f;for(var h=t,i=u,j=r,k=s,l=0,m=a.length;l!==m;l++){var n=a[l],o=b[l],p=null;n.material&&o.material&&(p=c.getContactMaterial(n.material,o.material)||null);for(var q=0;q<n.shapes.length;q++){n.quaternion.mult(n.shapeOrientations[q],h),n.quaternion.vmult(n.shapeOffsets[q],j),j.vadd(n.position,j);for(var v=n.shapes[q],w=0;w<o.shapes.length;w++){o.quaternion.mult(o.shapeOrientations[w],i),o.quaternion.vmult(o.shapeOffsets[w],k),k.vadd(o.position,k);var x=o.shapes[w];if(!(j.distanceTo(k)>v.boundingSphereRadius+x.boundingSphereRadius)){var y=null;v.material&&x.material&&(y=c.getContactMaterial(v.material,x.material)||null),this.currentContactMaterial=y||p||c.defaultContactMaterial;var z=this[v.type|x.type];z&&(v.type<x.type?z.call(this,v,x,j,k,h,i,n,o,v,x):z.call(this,x,v,k,j,i,h,o,n,v,x))}}}}};d.prototype[g.types.BOX|g.types.BOX]=d.prototype.boxBox=function(a,b,c,d,e,f,g,h){a.convexPolyhedronRepresentation.material=a.material,b.convexPolyhedronRepresentation.material=b.material,a.convexPolyhedronRepresentation.collisionResponse=a.collisionResponse,b.convexPolyhedronRepresentation.collisionResponse=b.collisionResponse,this.convexConvex(a.convexPolyhedronRepresentation,b.convexPolyhedronRepresentation,c,d,e,f,g,h,a,b)},d.prototype[g.types.BOX|g.types.CONVEXPOLYHEDRON]=d.prototype.boxConvex=function(a,b,c,d,e,f,g,h){a.convexPolyhedronRepresentation.material=a.material,a.convexPolyhedronRepresentation.collisionResponse=a.collisionResponse,this.convexConvex(a.convexPolyhedronRepresentation,b,c,d,e,f,g,h,a,b)},d.prototype[g.types.BOX|g.types.PARTICLE]=d.prototype.boxParticle=function(a,b,c,d,e,f,g,h){a.convexPolyhedronRepresentation.material=a.material,a.convexPolyhedronRepresentation.collisionResponse=a.collisionResponse,this.convexParticle(a.convexPolyhedronRepresentation,b,c,d,e,f,g,h,a,b)},d.prototype[g.types.SPHERE]=d.prototype.sphereSphere=function(a,b,c,d,e,f,g,h){var i=this.createContactEquation(g,h,a,b);d.vsub(c,i.ni),i.ni.normalize(),i.ri.copy(i.ni),i.rj.copy(i.ni),i.ri.mult(a.radius,i.ri),i.rj.mult(-b.radius,i.rj),i.ri.vadd(c,i.ri),i.ri.vsub(g.position,i.ri),i.rj.vadd(d,i.rj),i.rj.vsub(h.position,i.rj),this.result.push(i),this.createFrictionEquationsFromContact(i,this.frictionResult)};var v=new i,w=new i,x=new i;d.prototype[g.types.PLANE|g.types.TRIMESH]=d.prototype.planeTrimesh=function(a,b,c,d,e,f,g,h){var k=new i,l=v;l.set(0,0,1),e.vmult(l,l);for(var m=0;m<b.vertices.length/3;m++){b.getVertex(m,k);var n=new i;n.copy(k),j.pointToWorldFrame(d,f,n,k);var o=w;k.vsub(c,o);var p=l.dot(o);if(0>=p){var q=this.createContactEquation(g,h,a,b);q.ni.copy(l);var r=x;l.scale(o.dot(l),r),k.vsub(r,r),q.ri.copy(r),q.ri.vsub(g.position,q.ri),q.rj.copy(k),q.rj.vsub(h.position,q.rj),this.result.push(q),this.createFrictionEquationsFromContact(q,this.frictionResult)}}};var y=new i,z=new i,A=(new i,new i),B=new i,C=new i,D=new i,E=new i,F=new i,G=new i,H=new i,I=new i,J=new i,K=new i,L=new f,M=[];d.prototype[g.types.SPHERE|g.types.TRIMESH]=d.prototype.sphereTrimesh=function(a,b,c,d,e,f,g,i){var k=C,l=D,m=E,n=F,o=G,p=H,q=L,r=B,s=z,t=M;j.pointToLocalFrame(d,f,c,o);var u=a.radius;q.lowerBound.set(o.x-u,o.y-u,o.z-u),q.upperBound.set(o.x+u,o.y+u,o.z+u),b.getTrianglesInAABB(q,t);for(var v=A,w=a.radius*a.radius,x=0;x<t.length;x++)for(var N=0;3>N;N++)if(b.getVertex(b.indices[3*t[x]+N],v),v.vsub(o,s),s.norm2()<=w){r.copy(v),j.pointToWorldFrame(d,f,r,v),v.vsub(c,s);var O=this.createContactEquation(g,i,a,b);O.ni.copy(s),O.ni.normalize(),O.ri.copy(O.ni),O.ri.scale(a.radius,O.ri),O.ri.vadd(c,O.ri),O.ri.vsub(g.position,O.ri),O.rj.copy(v),O.rj.vsub(i.position,O.rj),this.result.push(O),this.createFrictionEquationsFromContact(O,this.frictionResult)}for(var x=0;x<t.length;x++)for(var N=0;3>N;N++){b.getVertex(b.indices[3*t[x]+N],k),b.getVertex(b.indices[3*t[x]+(N+1)%3],l),l.vsub(k,m),o.vsub(l,p);var P=p.dot(m);o.vsub(k,p);var Q=p.dot(m);if(Q>0&&0>P){o.vsub(k,p),n.copy(m),n.normalize(),Q=p.dot(n),n.scale(Q,p),p.vadd(k,p);var R=p.distanceTo(o);if(R<a.radius){var O=this.createContactEquation(g,i,a,b);p.vsub(o,O.ni),O.ni.normalize(),O.ni.scale(a.radius,O.ri),j.pointToWorldFrame(d,f,p,p),p.vsub(i.position,O.rj),j.vectorToWorldFrame(f,O.ni,O.ni),j.vectorToWorldFrame(f,O.ri,O.ri),this.result.push(O),this.createFrictionEquationsFromContact(O,this.frictionResult)}}}for(var S=I,T=J,U=K,V=y,x=0,W=t.length;x!==W;x++){b.getTriangleVertices(t[x],S,T,U),b.getNormal(t[x],V),o.vsub(S,p);var R=p.dot(V);if(V.scale(R,p),o.vsub(p,p),R=p.distanceTo(o),h.pointInTriangle(p,S,T,U)&&R<a.radius){var O=this.createContactEquation(g,i,a,b);p.vsub(o,O.ni),O.ni.normalize(),O.ni.scale(a.radius,O.ri),j.pointToWorldFrame(d,f,p,p),p.vsub(i.position,O.rj),j.vectorToWorldFrame(f,O.ni,O.ni),j.vectorToWorldFrame(f,O.ri,O.ri),this.result.push(O),this.createFrictionEquationsFromContact(O,this.frictionResult)}}t.length=0};var N=new i,O=new i;d.prototype[g.types.SPHERE|g.types.PLANE]=d.prototype.spherePlane=function(a,b,c,d,e,f,g,h){var i=this.createContactEquation(g,h,a,b);if(i.ni.set(0,0,1),f.vmult(i.ni,i.ni),i.ni.negate(i.ni),i.ni.normalize(),i.ni.mult(a.radius,i.ri),c.vsub(d,N),i.ni.mult(i.ni.dot(N),O),N.vsub(O,i.rj),-N.dot(i.ni)<=a.radius){var j=i.ri,k=i.rj;j.vadd(c,j),j.vsub(g.position,j),k.vadd(d,k),k.vsub(h.position,k),this.result.push(i),this.createFrictionEquationsFromContact(i,this.frictionResult)}};var P=new i,Q=new i,R=new i,S=new i,T=new i,U=new i,V=new i,W=[new i,new i,new i,new i,new i,new i],X=new i,Y=new i,Z=new i,$=new i;d.prototype[g.types.SPHERE|g.types.BOX]=d.prototype.sphereBox=function(a,b,c,d,e,f,g,h){var i=this.v3pool,j=W;c.vsub(d,S),b.getSideNormals(j,f);for(var k=a.radius,l=!1,m=Y,n=Z,o=$,p=null,q=0,r=0,s=0,t=null,u=0,v=j.length;u!==v&&l===!1;u++){var w=T;w.copy(j[u]);var x=w.norm();w.normalize();var y=S.dot(w);if(x+k>y&&y>0){var z=U,A=V;z.copy(j[(u+1)%3]),A.copy(j[(u+2)%3]);var B=z.norm(),C=A.norm();z.normalize(),A.normalize();var D=S.dot(z),E=S.dot(A);if(B>D&&D>-B&&C>E&&E>-C){var F=Math.abs(y-x-k);(null===t||t>F)&&(t=F,r=D,s=E,p=x,m.copy(w),n.copy(z),o.copy(A),q++)}}}if(q){l=!0;var G=this.createContactEquation(g,h,a,b);m.mult(-k,G.ri),G.ni.copy(m),G.ni.negate(G.ni),m.mult(p,m),n.mult(r,n),m.vadd(n,m),o.mult(s,o),m.vadd(o,G.rj),G.ri.vadd(c,G.ri),G.ri.vsub(g.position,G.ri),G.rj.vadd(d,G.rj),G.rj.vsub(h.position,G.rj),this.result.push(G),this.createFrictionEquationsFromContact(G,this.frictionResult)}for(var H=i.get(),I=X,J=0;2!==J&&!l;J++)for(var K=0;2!==K&&!l;K++)for(var L=0;2!==L&&!l;L++)if(H.set(0,0,0),J?H.vadd(j[0],H):H.vsub(j[0],H),K?H.vadd(j[1],H):H.vsub(j[1],H),L?H.vadd(j[2],H):H.vsub(j[2],H),d.vadd(H,I),I.vsub(c,I),I.norm2()<k*k){l=!0;var G=this.createContactEquation(g,h,a,b);G.ri.copy(I),G.ri.normalize(),G.ni.copy(G.ri),G.ri.mult(k,G.ri),G.rj.copy(H),G.ri.vadd(c,G.ri),G.ri.vsub(g.position,G.ri),G.rj.vadd(d,G.rj),G.rj.vsub(h.position,G.rj),this.result.push(G),this.createFrictionEquationsFromContact(G,this.frictionResult)}i.release(H),H=null;for(var M=i.get(),N=i.get(),G=i.get(),O=i.get(),F=i.get(),P=j.length,J=0;J!==P&&!l;J++)for(var K=0;K!==P&&!l;K++)if(J%3!==K%3){j[K].cross(j[J],M),M.normalize(),j[J].vadd(j[K],N),G.copy(c),G.vsub(N,G),G.vsub(d,G);var Q=G.dot(M);M.mult(Q,O);for(var L=0;L===J%3||L===K%3;)L++;F.copy(c),F.vsub(O,F),F.vsub(N,F),F.vsub(d,F);var R=Math.abs(Q),_=F.norm();if(R<j[L].norm()&&k>_){l=!0;var aa=this.createContactEquation(g,h,a,b);N.vadd(O,aa.rj),aa.rj.copy(aa.rj),F.negate(aa.ni),aa.ni.normalize(),aa.ri.copy(aa.rj),aa.ri.vadd(d,aa.ri),aa.ri.vsub(c,aa.ri),aa.ri.normalize(),aa.ri.mult(k,aa.ri),aa.ri.vadd(c,aa.ri),aa.ri.vsub(g.position,aa.ri),aa.rj.vadd(d,aa.rj),aa.rj.vsub(h.position,aa.rj),this.result.push(aa),this.createFrictionEquationsFromContact(aa,this.frictionResult)}}i.release(M,N,G,O,F)};var _=new i,aa=new i,ba=new i,ca=new i,da=new i,ea=new i,fa=new i,ga=new i,ha=new i,ia=new i;d.prototype[g.types.SPHERE|g.types.CONVEXPOLYHEDRON]=d.prototype.sphereConvex=function(a,b,c,d,f,g,h,i){var j=this.v3pool;c.vsub(d,_);for(var k=b.faceNormals,l=b.faces,m=b.vertices,n=a.radius,o=0;o!==m.length;o++){var p=m[o],q=da;g.vmult(p,q),d.vadd(q,q);var r=ca;if(q.vsub(c,r),r.norm2()<n*n){t=!0;var s=this.createContactEquation(h,i,a,b);return s.ri.copy(r),s.ri.normalize(),s.ni.copy(s.ri),s.ri.mult(n,s.ri),q.vsub(d,s.rj),s.ri.vadd(c,s.ri),s.ri.vsub(h.position,s.ri),s.rj.vadd(d,s.rj),s.rj.vsub(i.position,s.rj),this.result.push(s),void this.createFrictionEquationsFromContact(s,this.frictionResult)}}for(var t=!1,o=0,u=l.length;o!==u&&t===!1;o++){var v=k[o],w=l[o],x=ea;g.vmult(v,x);var y=fa;g.vmult(m[w[0]],y),y.vadd(d,y);var z=ga;x.mult(-n,z),c.vadd(z,z);var A=ha;z.vsub(y,A);var B=A.dot(x),C=ia;if(c.vsub(y,C),0>B&&C.dot(x)>0){for(var D=[],E=0,F=w.length;E!==F;E++){var G=j.get();g.vmult(m[w[E]],G),d.vadd(G,G),D.push(G)}if(e(D,x,c)){t=!0;var s=this.createContactEquation(h,i,a,b);x.mult(-n,s.ri),x.negate(s.ni);var H=j.get();x.mult(-B,H);var I=j.get();x.mult(-n,I),c.vsub(d,s.rj),s.rj.vadd(I,s.rj),s.rj.vadd(H,s.rj),s.rj.vadd(d,s.rj),s.rj.vsub(i.position,s.rj),s.ri.vadd(c,s.ri),s.ri.vsub(h.position,s.ri),j.release(H),j.release(I),this.result.push(s),this.createFrictionEquationsFromContact(s,this.frictionResult);for(var E=0,J=D.length;E!==J;E++)j.release(D[E]);return}for(var E=0;E!==w.length;E++){var K=j.get(),L=j.get();g.vmult(m[w[(E+1)%w.length]],K),g.vmult(m[w[(E+2)%w.length]],L),d.vadd(K,K),d.vadd(L,L);var M=aa;L.vsub(K,M);var N=ba;M.unit(N);var O=j.get(),P=j.get();c.vsub(K,P);var Q=P.dot(N);N.mult(Q,O),O.vadd(K,O);var R=j.get();if(O.vsub(c,R),Q>0&&Q*Q<M.norm2()&&R.norm2()<n*n){var s=this.createContactEquation(h,i,a,b);O.vsub(d,s.rj),O.vsub(c,s.ni),s.ni.normalize(),s.ni.mult(n,s.ri),s.rj.vadd(d,s.rj),s.rj.vsub(i.position,s.rj),s.ri.vadd(c,s.ri),s.ri.vsub(h.position,s.ri),this.result.push(s),this.createFrictionEquationsFromContact(s,this.frictionResult);for(var E=0,J=D.length;E!==J;E++)j.release(D[E]);return j.release(K),j.release(L),j.release(O),j.release(R),void j.release(P)}j.release(K),j.release(L),j.release(O),j.release(R),j.release(P)}for(var E=0,J=D.length;E!==J;E++)j.release(D[E])}}};new i,new i;d.prototype[g.types.PLANE|g.types.BOX]=d.prototype.planeBox=function(a,b,c,d,e,f,g,h){b.convexPolyhedronRepresentation.material=b.material,b.convexPolyhedronRepresentation.collisionResponse=b.collisionResponse,this.planeConvex(a,b.convexPolyhedronRepresentation,c,d,e,f,g,h)};var ja=new i,ka=new i,la=new i,ma=new i;d.prototype[g.types.PLANE|g.types.CONVEXPOLYHEDRON]=d.prototype.planeConvex=function(a,b,c,d,e,f,g,h){var i=ja,j=ka;j.set(0,0,1),e.vmult(j,j);for(var k=0,l=la,m=0;m!==b.vertices.length;m++){i.copy(b.vertices[m]),f.vmult(i,i),d.vadd(i,i),i.vsub(c,l);var n=j.dot(l);if(0>=n){var o=this.createContactEquation(g,h,a,b),p=ma;j.mult(j.dot(l),p),i.vsub(p,p),p.vsub(c,o.ri),o.ni.copy(j),i.vsub(d,o.rj),o.ri.vadd(c,o.ri),o.ri.vsub(g.position,o.ri),o.rj.vadd(d,o.rj),o.rj.vsub(h.position,o.rj),this.result.push(o),k++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(o,this.frictionResult)}}this.enableFrictionReduction&&k&&this.createFrictionFromAverage(k)};var na=new i,oa=new i;d.prototype[g.types.CONVEXPOLYHEDRON]=d.prototype.convexConvex=function(a,b,c,d,e,f,g,h,i,j,k,l){var m=na;if(!(c.distanceTo(d)>a.boundingSphereRadius+b.boundingSphereRadius)&&a.findSeparatingAxis(b,c,e,d,f,m,k,l)){var n=[],o=oa;a.clipAgainstHull(c,e,b,d,f,m,-100,100,n);for(var p=0,q=0;q!==n.length;q++){var r=this.createContactEquation(g,h,a,b,i,j),s=r.ri,t=r.rj;m.negate(r.ni),n[q].normal.negate(o),o.mult(n[q].depth,o),n[q].point.vadd(o,s),t.copy(n[q].point),s.vsub(c,s),t.vsub(d,t),s.vadd(c,s),s.vsub(g.position,s),t.vadd(d,t),t.vsub(h.position,t),this.result.push(r),p++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(r,this.frictionResult)}this.enableFrictionReduction&&p&&this.createFrictionFromAverage(p)}};var pa=new i,qa=new i,ra=new i;d.prototype[g.types.PLANE|g.types.PARTICLE]=d.prototype.planeParticle=function(a,b,c,d,e,f,g,h){var i=pa;i.set(0,0,1),g.quaternion.vmult(i,i);var j=qa;d.vsub(g.position,j);var k=i.dot(j);if(0>=k){var l=this.createContactEquation(h,g,b,a);l.ni.copy(i),l.ni.negate(l.ni),l.ri.set(0,0,0);var m=ra;i.mult(i.dot(d),m),d.vsub(m,m),l.rj.copy(m),this.result.push(l),this.createFrictionEquationsFromContact(l,this.frictionResult)}};var sa=new i;d.prototype[g.types.PARTICLE|g.types.SPHERE]=d.prototype.sphereParticle=function(a,b,c,d,e,f,g,h){var i=sa;i.set(0,0,1),d.vsub(c,i);var j=i.norm2();if(j<=a.radius*a.radius){var k=this.createContactEquation(h,g,b,a);i.normalize(),k.rj.copy(i),k.rj.mult(a.radius,k.rj),k.ni.copy(i),k.ni.negate(k.ni),k.ri.set(0,0,0),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult)}};var ta=new k,ua=new i,va=(new i,new i),wa=new i,xa=new i;d.prototype[g.types.PARTICLE|g.types.CONVEXPOLYHEDRON]=d.prototype.convexParticle=function(a,b,c,d,e,f,g,h){var i=-1,j=va,k=xa,l=null,m=0,n=ua;if(n.copy(d),n.vsub(c,n),e.conjugate(ta),ta.vmult(n,n),a.pointIsInside(n)){a.worldVerticesNeedsUpdate&&a.computeWorldVertices(c,e),a.worldFaceNormalsNeedsUpdate&&a.computeWorldFaceNormals(e);for(var o=0,p=a.faces.length;o!==p;o++){var q=[a.worldVertices[a.faces[o][0]]],r=a.worldFaceNormals[o];d.vsub(q[0],wa);var s=-r.dot(wa);(null===l||Math.abs(s)<Math.abs(l))&&(l=s,i=o,j.copy(r),m++)}if(-1!==i){var t=this.createContactEquation(h,g,b,a);j.mult(l,k),k.vadd(d,k),k.vsub(c,k),t.rj.copy(k),j.negate(t.ni),t.ri.set(0,0,0);var u=t.ri,v=t.rj;u.vadd(d,u),u.vsub(h.position,u),v.vadd(c,v),v.vsub(g.position,v),this.result.push(t),this.createFrictionEquationsFromContact(t,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},d.prototype[g.types.BOX|g.types.HEIGHTFIELD]=d.prototype.boxHeightfield=function(a,b,c,d,e,f,g,h){a.convexPolyhedronRepresentation.material=a.material,a.convexPolyhedronRepresentation.collisionResponse=a.collisionResponse,this.convexHeightfield(a.convexPolyhedronRepresentation,b,c,d,e,f,g,h)};var ya=new i,za=new i,Aa=[0];d.prototype[g.types.CONVEXPOLYHEDRON|g.types.HEIGHTFIELD]=d.prototype.convexHeightfield=function(a,b,c,d,e,f,g,h){var i=b.data,k=b.elementSize,l=a.boundingSphereRadius,m=za,n=Aa,o=ya;j.pointToLocalFrame(d,f,c,o);var p=Math.floor((o.x-l)/k)-1,q=Math.ceil((o.x+l)/k)+1,r=Math.floor((o.y-l)/k)-1,s=Math.ceil((o.y+l)/k)+1;if(!(0>q||0>s||p>i.length||r>i[0].length)){0>p&&(p=0),0>q&&(q=0),0>r&&(r=0),0>s&&(s=0),p>=i.length&&(p=i.length-1),q>=i.length&&(q=i.length-1),s>=i[0].length&&(s=i[0].length-1),r>=i[0].length&&(r=i[0].length-1);var t=[];b.getRectMinMax(p,r,q,s,t);var u=t[0],v=t[1];if(!(o.z-l>v||o.z+l<u))for(var w=p;q>w;w++)for(var x=r;s>x;x++)b.getConvexTrianglePillar(w,x,!1),j.pointToWorldFrame(d,f,b.pillarOffset,m),c.distanceTo(m)<b.pillarConvex.boundingSphereRadius+a.boundingSphereRadius&&this.convexConvex(a,b.pillarConvex,c,m,e,f,g,h,null,null,n,null),b.getConvexTrianglePillar(w,x,!0),j.pointToWorldFrame(d,f,b.pillarOffset,m),c.distanceTo(m)<b.pillarConvex.boundingSphereRadius+a.boundingSphereRadius&&this.convexConvex(a,b.pillarConvex,c,m,e,f,g,h,null,null,n,null)}};var Ba=new i,Ca=new i;d.prototype[g.types.SPHERE|g.types.HEIGHTFIELD]=d.prototype.sphereHeightfield=function(a,b,c,d,e,f,g,h){var i=b.data,k=a.radius,l=b.elementSize,m=Ca,n=Ba;j.pointToLocalFrame(d,f,c,n);var o=Math.floor((n.x-k)/l)-1,p=Math.ceil((n.x+k)/l)+1,q=Math.floor((n.y-k)/l)-1,r=Math.ceil((n.y+k)/l)+1;if(!(0>p||0>r||o>i.length||r>i[0].length)){0>o&&(o=0),0>p&&(p=0),0>q&&(q=0),0>r&&(r=0),o>=i.length&&(o=i.length-1),p>=i.length&&(p=i.length-1),r>=i[0].length&&(r=i[0].length-1),q>=i[0].length&&(q=i[0].length-1);var s=[];b.getRectMinMax(o,q,p,r,s);var t=s[0],u=s[1];if(!(n.z-k>u||n.z+k<t))for(var v=this.result,w=o;p>w;w++)for(var x=q;r>x;x++){var y=v.length;b.getConvexTrianglePillar(w,x,!1),j.pointToWorldFrame(d,f,b.pillarOffset,m),c.distanceTo(m)<b.pillarConvex.boundingSphereRadius+a.boundingSphereRadius&&this.sphereConvex(a,b.pillarConvex,c,m,e,f,g,h),b.getConvexTrianglePillar(w,x,!0),j.pointToWorldFrame(d,f,b.pillarOffset,m),c.distanceTo(m)<b.pillarConvex.boundingSphereRadius+a.boundingSphereRadius&&this.sphereConvex(a,b.pillarConvex,c,m,e,f,g,h);var z=v.length-y;if(z>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(a,b,c){function d(){j.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new f,this.broadphase=new s,this.bodies=[],this.solver=new h,this.constraints=[],this.narrowphase=new i(this),this.collisionMatrix=new k,this.collisionMatrixPrevious=new k,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new o,this.defaultMaterial=new l("default"),this.defaultContactMaterial=new m(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}b.exports=d;var e=a("../shapes/Shape"),f=a("../math/Vec3"),g=a("../math/Quaternion"),h=a("../solver/GSSolver"),i=(a("../utils/Vec3Pool"),a("../equations/ContactEquation"),a("../equations/FrictionEquation"),a("./Narrowphase")),j=a("../utils/EventTarget"),k=a("../collision/ArrayCollisionMatrix"),l=a("../material/Material"),m=a("../material/ContactMaterial"),n=a("../objects/Body"),o=a("../utils/TupleDictionary"),p=a("../collision/RaycastResult"),q=a("../collision/AABB"),r=a("../collision/Ray"),s=a("../collision/NaiveBroadphase");d.prototype=new j;var t=(new q,new r);if(d.prototype.getContactMaterial=function(a,b){return this.contactMaterialTable.get(a.id,b.id)},d.prototype.numObjects=function(){return this.bodies.length},d.prototype.collisionMatrixTick=function(){var a=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=a,this.collisionMatrix.reset()},d.prototype.add=d.prototype.addBody=function(a){-1===this.bodies.indexOf(a)&&(a.index=this.bodies.length,this.bodies.push(a),a.world=this,a.initPosition.copy(a.position),a.initVelocity.copy(a.velocity),a.timeLastSleepy=this.time,a instanceof n&&(a.initAngularVelocity.copy(a.angularVelocity),a.initQuaternion.copy(a.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=a,this.dispatchEvent(this.addBodyEvent))},d.prototype.addConstraint=function(a){this.constraints.push(a)},d.prototype.removeConstraint=function(a){var b=this.constraints.indexOf(a);-1!==b&&this.constraints.splice(b,1)},d.prototype.rayTest=function(a,b,c){c instanceof p?this.raycastClosest(a,b,{skipBackfaces:!0},c):this.raycastAll(a,b,{skipBackfaces:!0},c)},d.prototype.raycastAll=function(a,b,c,d){return c.mode=r.ALL,c.from=a,c.to=b,c.callback=d,t.intersectWorld(this,c)},d.prototype.raycastAny=function(a,b,c,d){return c.mode=r.ANY,c.from=a,c.to=b,c.result=d,t.intersectWorld(this,c)},d.prototype.raycastClosest=function(a,b,c,d){return c.mode=r.CLOSEST,c.from=a,c.to=b,c.result=d,t.intersectWorld(this,c)},d.prototype.remove=function(a){a.world=null;var b=this.bodies.length-1,c=this.bodies,d=c.indexOf(a);if(-1!==d){c.splice(d,1);for(var e=0;e!==c.length;e++)c[e].index=e;this.collisionMatrix.setNumObjects(b),this.removeBodyEvent.body=a,this.dispatchEvent(this.removeBodyEvent)}},d.prototype.removeBody=d.prototype.remove,d.prototype.addMaterial=function(a){this.materials.push(a)},d.prototype.addContactMaterial=function(a){this.contactmaterials.push(a),this.contactMaterialTable.set(a.materials[0].id,a.materials[1].id,a)},"undefined"==typeof performance&&(performance={}),!performance.now){var u=Date.now();performance.timing&&performance.timing.navigationStart&&(u=performance.timing.navigationStart),performance.now=function(){return Date.now()-u}}var v=new f;d.prototype.step=function(a,b,c){if(c=c||10,b=b||0,0===b)this.internalStep(a),this.time+=a;else{var d=Math.floor((this.time+b)/a)-Math.floor(this.time/a);d=Math.min(d,c);for(var e=performance.now(),f=0;f!==d&&(this.internalStep(a),!(performance.now()-e>1e3*a));f++);this.time+=b;for(var g=this.time%a,h=g/a,i=v,j=this.bodies,k=0;k!==j.length;k++){var l=j[k];l.type!==n.STATIC&&l.sleepState!==n.SLEEPING?(l.position.vsub(l.previousPosition,i),i.scale(h,i),l.position.vadd(i,l.interpolatedPosition)):(l.interpolatedPosition.copy(l.position),l.interpolatedQuaternion.copy(l.quaternion))}}};var w={type:"postStep"},x={type:"preStep"},y={type:"collide",body:null,contact:null},z=[],A=[],B=[],C=[],D=(new f,new f,new f,new f,new f,new f,new f,new f,new f,new g,new g),E=new g,F=new f;d.prototype.internalStep=function(a){this.dt=a;var b,c=this.contacts,d=B,f=C,g=this.numObjects(),h=this.bodies,i=this.solver,j=this.gravity,k=this.doProfiling,l=this.profile,m=n.DYNAMIC,o=this.constraints,p=A,q=(j.norm(),j.x),r=j.y,s=j.z,t=0;for(k&&(b=performance.now()),t=0;t!==g;t++){var u=h[t];if(u.type&m){var v=u.force,G=u.mass;v.x+=G*q,v.y+=G*r,v.z+=G*s}}for(var t=0,H=this.subsystems.length;t!==H;t++)this.subsystems[t].update();k&&(b=performance.now()),d.length=0,f.length=0,this.broadphase.collisionPairs(this,d,f),k&&(l.broadphase=performance.now()-b);var I=o.length;for(t=0;t!==I;t++){var J=o[t];if(!J.collideConnected)for(var K=d.length-1;K>=0;K-=1)(J.bodyA===d[K]&&J.bodyB===f[K]||J.bodyB===d[K]&&J.bodyA===f[K])&&(d.splice(K,1),f.splice(K,1))}this.collisionMatrixTick(),k&&(b=performance.now());var L=z,M=c.length;for(t=0;t!==M;t++)L.push(c[t]);c.length=0;var N=this.frictionEquations.length;for(t=0;t!==N;t++)p.push(this.frictionEquations[t]);this.frictionEquations.length=0,this.narrowphase.getContacts(d,f,this,c,L,this.frictionEquations,p),k&&(l.narrowphase=performance.now()-b),k&&(b=performance.now());for(var t=0;t<this.frictionEquations.length;t++)i.addEquation(this.frictionEquations[t]);for(var O=c.length,P=0;P!==O;P++){{var Q,J=c[P],u=J.bi,R=J.bj;J.si,J.sj}Q=u.material&&R.material?this.getContactMaterial(u.material,R.material)||this.defaultContactMaterial:this.defaultContactMaterial;
var S=Q.friction;if(u.material&&R.material&&(u.material.friction>=0&&R.material.friction>=0&&(S=u.material.friction*R.material.friction),u.material.restitution>=0&&R.material.restitution>=0&&(J.restitution=u.material.restitution*R.material.restitution)),i.addEquation(J),u.allowSleep&&u.type===n.DYNAMIC&&u.sleepState===n.SLEEPING&&R.sleepState===n.AWAKE&&R.type!==n.STATIC){var T=R.velocity.norm2()+R.angularVelocity.norm2(),U=Math.pow(R.sleepSpeedLimit,2);T>=2*U&&(u._wakeUpAfterNarrowphase=!0)}if(R.allowSleep&&R.type===n.DYNAMIC&&R.sleepState===n.SLEEPING&&u.sleepState===n.AWAKE&&u.type!==n.STATIC){var V=u.velocity.norm2()+u.angularVelocity.norm2(),W=Math.pow(u.sleepSpeedLimit,2);V>=2*W&&(R._wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(u,R,!0),this.collisionMatrixPrevious.get(u,R)||(y.body=R,y.contact=J,u.dispatchEvent(y),y.body=u,R.dispatchEvent(y))}for(k&&(l.makeContactConstraints=performance.now()-b,b=performance.now()),t=0;t!==g;t++){var u=h[t];u._wakeUpAfterNarrowphase&&(u.wakeUp(),u._wakeUpAfterNarrowphase=!1)}var I=o.length;for(t=0;t!==I;t++){var J=o[t];J.update();for(var K=0,X=J.equations.length;K!==X;K++){var Y=J.equations[K];i.addEquation(Y)}}i.solve(a,this),k&&(l.solve=performance.now()-b),i.removeAllEquations();var Z=Math.pow;for(t=0;t!==g;t++){var u=h[t];if(u.type&m){var $=Z(1-u.linearDamping,a),_=u.velocity;_.mult($,_);var aa=u.angularVelocity;if(aa){var ba=Z(1-u.angularDamping,a);aa.mult(ba,aa)}}}for(this.dispatchEvent(x),t=0;t!==g;t++){var u=h[t];u.preStep&&u.preStep.call(u)}k&&(b=performance.now());{var ca=D,da=E,ea=this.stepnumber,fa=n.DYNAMIC|n.KINEMATIC,ga=ea%(this.quatNormalizeSkip+1)===0,ha=this.quatNormalizeFast,ia=.5*a;e.types.PLANE,e.types.CONVEXPOLYHEDRON}for(t=0;t!==g;t++){var ja=h[t],ka=ja.force,la=ja.torque;if(ja.type&fa&&ja.sleepState!==n.SLEEPING){var ma=ja.velocity,na=ja.angularVelocity,oa=ja.position,pa=ja.quaternion,qa=ja.invMass,ra=ja.invInertiaWorld;ma.x+=ka.x*qa*a,ma.y+=ka.y*qa*a,ma.z+=ka.z*qa*a,ja.angularVelocity&&(ra.vmult(la,F),F.mult(a,F),F.vadd(na,na)),oa.x+=ma.x*a,oa.y+=ma.y*a,oa.z+=ma.z*a,ja.angularVelocity&&(ca.set(na.x,na.y,na.z,0),ca.mult(pa,da),pa.x+=ia*da.x,pa.y+=ia*da.y,pa.z+=ia*da.z,pa.w+=ia*da.w,ga&&(ha?pa.normalizeFast():pa.normalize())),ja.aabb&&(ja.aabbNeedsUpdate=!0),ja.updateInertiaWorld&&ja.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,k&&(l.integrate=performance.now()-b),this.time+=a,this.stepnumber+=1,this.dispatchEvent(w),t=0;t!==g;t++){var u=h[t],sa=u.postStep;sa&&sa.call(u)}if(this.allowSleep)for(t=0;t!==g;t++)h[t].sleepTick(this.time)},d.prototype.clearForces=function(){for(var a=this.bodies,b=a.length,c=0;c!==b;c++){{var d=a[c];d.force,d.torque}d.force.set(0,0,0),d.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)});