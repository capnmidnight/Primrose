!function(){"use strict";function t(t,e,n,i,r,o,s){THREE.Geometry.call(this),this.type="InsideSphereGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:n,phiStart:i,phiLength:r,thetaStart:o,thetaLength:s},t=t||50,e=Math.max(3,Math.floor(e)||8),n=Math.max(2,Math.floor(n)||6),i=void 0!==i?i:0,r=void 0!==r?r:2*Math.PI,o=void 0!==o?o:0,s=void 0!==s?s:Math.PI;var a,u,c=[],h=[];for(u=0;u<=n;u++){var l=[],f=[];for(a=e;a>=0;a--){var d=a/e,m=u/n,p=new THREE.Vector3;p.x=-t*Math.cos(i+d*r)*Math.sin(o+m*s),p.y=t*Math.cos(o+m*s),p.z=t*Math.sin(i+d*r)*Math.sin(o+m*s),this.vertices.push(p),l.push(this.vertices.length-1),f.push(new THREE.Vector2(1-d,1-m))}c.push(l),h.push(f)}for(u=0;u<n;u++)for(a=0;a<e;a++){var y=c[u][a+1],g=c[u][a],v=c[u+1][a],w=c[u+1][a+1],b=this.vertices[y].clone().normalize(),x=this.vertices[g].clone().normalize(),P=this.vertices[v].clone().normalize(),E=this.vertices[w].clone().normalize(),T=h[u][a+1].clone(),_=h[u][a].clone(),R=h[u+1][a].clone(),k=h[u+1][a+1].clone();Math.abs(this.vertices[y].y)===t?(T.x=(T.x+_.x)/2,this.faces.push(new THREE.Face3(y,v,w,[b,P,E])),this.faceVertexUvs[0].push([T,R,k])):Math.abs(this.vertices[v].y)===t?(R.x=(R.x+k.x)/2,this.faces.push(new THREE.Face3(y,g,v,[b,x,P])),this.faceVertexUvs[0].push([T,_,R])):(this.faces.push(new THREE.Face3(y,g,w,[b,x,E])),this.faceVertexUvs[0].push([T,_,k]),this.faces.push(new THREE.Face3(g,v,w,[x.clone(),P,E.clone()])),this.faceVertexUvs[0].push([_.clone(),R,k.clone()]))}this.computeFaceNormals();for(var C=0;C<this.faces.length;++C){var M=this.faces[C];M.normal.multiplyScalar(-1);for(var O=0;O<M.vertexNormals.length;++O)M.vertexNormals[O].multiplyScalar(-1)}this.boundingSphere=new THREE.Sphere(new THREE.Vector3,t)}"undefined"!=typeof window.THREE&&(t.prototype=Object.create(THREE.Geometry.prototype),t.prototype.constructor=t),window.InsideSphereGeometry=t}(),function(){"use strict";var t=[.5,.25,.333333,.5,1];window.PIXEL_SCALES=t}(),function(){"use strict";var t={};window.Primrose=t}(),function(){"use strict";var t={NONE:0,VERYLOW:1,LOW:2,MEDIUM:3,HIGH:4,MAXIMUM:PIXEL_SCALES.length-1};window.Quality=t}(),function(){"use strict";function t(t,e){var n=hub();return put(brick(16711680,t,e,e)).on(n),put(brick(65280,e,t,e)).on(n),put(brick(255,e,e,t)).on(n),n}window.axis=t}(),function(){"use strict";function t(t,e,n){return void 0===e&&(e=t),void 0===n&&(n=t),cache("BoxGeometry("+t+", "+e+", "+n+")",function(){return new THREE.BoxGeometry(t,e,n)})}window.box=t}(),function(){"use strict";function t(t,e,n,i){return textured(box(e||1,n||1,i||1),t,{txtRepeatS:e,txtRepeatT:i})}window.brick=t}(),function(){"use strict";var t=function(){var t={};return function(e,n){return t[e]||(t[e]=n()),t[e]}}();window.cache=t}(),function(){"use strict";function t(t){return JSON.parse(JSON.stringify(t))}window.clone=t}(),function(){"use strict";function t(t,e,n){for(var i=new THREE.Geometry,r=0;r<t.length;++r)i.vertices.push(t[r]);var o=cache("PointsMaterial("+e+", "+n+")",function(){return new THREE.PointsMaterial({color:e,size:n})});return new THREE.Points(i,o)}window.cloud=t}(),function(){"use strict";function t(t,n,i){for(var r=[{dest:t,source:n}];r.length>0;){var o=r.pop();n=o.source,t=o.dest;for(var s in n)i||"object"!==e(n[s])||n[s]instanceof String?t[s]=n[s]:(t[s]||(t[s]={}),r.push({dest:t[s],source:n[s]}))}return t}var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};window.copyObject=t}(),function(){"use strict";function t(t,e,n,i,r,o,s,a){return void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===n&&(n=1),cache("CylinderGeometry("+t+", "+e+", "+n+", "+i+", "+r+", "+o+", "+s+", "+a+")",function(){return new THREE.CylinderGeometry(t,e,n,i,r,o,s,a)})}window.cylinder=t}(),function(){"use strict";function t(t){window.localStorage&&window.localStorage.removeItem(t)}window.deleteSetting=t}(),function(){"use strict";function t(t,e){for(var n=this.listeners&&this.listeners[t]||this._listeners&&this._listeners[t],i=0;n&&i<n.length;++i)n[i](e)}window.emit=t}(),function(){"use strict";function t(t,e){for(var n=0;n<e.length;++n)if(void 0!==t[e[n]])return e[n]}window.findProperty=t}(),function(){"use strict";function t(t,n){if(window.localStorage){var i=window.localStorage.getItem(t);if(i)try{return JSON.parse(i)}catch(n){console.error("getSetting",t,i,"undefined"==typeof i?"undefined":e(i),n),console.error(n),console.error("getSetting",t,i,"undefined"==typeof i?"undefined":e(i))}}return n}var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};window.getSetting=t}(),function(){"use strict";function t(){return new THREE.Object3D}window.hub=t}(),function(){"use strict";function t(t){return t}window.identity=t}(),function(){"use strict";var t=!!window.chrome&&!window.isOpera;window.isChrome=t}(),function(){"use strict";var t="undefined"!=typeof window.InstallTrigger;window.isFirefox=t}(),function(){"use strict";var t=navigator.userAgent.indexOf("Mobile VR")>-1;window.isGearVR=t}(),function(){"use strict";var t=!!document.documentMode;window.isIE=t}(),function(){"use strict";var t=window.self!==window.top;window.isInIFrame=t}(),function(){"use strict";var t=function(t){return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od|ad)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substring(0,4))}(navigator.userAgent||navigator.vendor||window.opera);window.isMobile=t}(),function(){"use strict";var t=/Macintosh/.test(navigator.userAgent||"");window.isOSX=t}(),function(){"use strict";var t=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0;window.isOpera=t}(),function(){"use strict";var t=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0;window.isSafari=t}(),function(){"use strict";var t=!/iP(hone|od|ad)/.test(navigator.userAgent||"")||isOpera||isChrome;window.isWebKit=t}(),function(){"use strict";var t=/Windows/.test(navigator.userAgent||"");window.isWindows=t}(),function(){"use strict";var t=/iP(hone|od|ad)/.test(navigator.userAgent||"");window.isiOS=t}(),function(){"use strict";function t(t,e,n,i){return new THREE.PointLight(t,e,n,i)}window.light=t}(),function(){"use strict";function t(t,e){t=t||{};for(var n in e)void 0!==t[n]&&null!==t[n]||(t[n]=e[n]);return t}window.patch=t}(),function(){"use strict";function t(t){var e={on:null,at:null,rot:null,scale:null,obj:function(){return t}},n=function(n){return n.appendChild?n.appendChild(t):n.add(t),e.on=null,e.at||e.rot||e.scale?e:t},i=function(n,i,r){return t.position.set(n,i,r),e.at=null,e.on||e.rot||e.scale?e:t},r=function(n,i,r){return t.rotation.set(n,i,r),e.rot=null,e.on||e.at||e.scale?e:t},o=function(n,i,r){return t.scale.set(n,i,r),e.scale=null,e.on||e.at||e.rot?e:t};return e.on=n,e.at=i,e.rot=r,e.scale=o,e}window.put=t}(),function(){"use strict";function t(t,e,n,i){return void 0===e&&(e=t),cache("PlaneBufferGeometry("+t+", "+e+", "+n+", "+i+")",function(){return new THREE.PlaneBufferGeometry(t,e,n,i)})}window.quad=t}(),function(){"use strict";function t(t,e,n,i){for(var r=n&&t||0,o=n&&e||t,s=i&&n||1,a=i||n||e,u=r;u<o;u+=s)a(u)}window.range=t}(),function(){"use strict";function t(t){var e={};if(t)for(var n in t){var i=t[n];"INPUT"!==i.tagName&&"SELECT"!==i.tagName||i.dataset&&i.dataset.skipcache||("text"===i.type||"password"===i.type||"SELECT"===i.tagName?e[n]=i.value:"checkbox"!==i.type&&"radio"!==i.type||(e[n]=i.checked))}return e}window.readForm=t}(),function(){"use strict";function t(t){t.returnValue=!1}window.setFalse=t}(),function(){"use strict";function t(t,n){if(window.localStorage&&n)try{window.localStorage.setItem(t,JSON.stringify(n))}catch(i){console.error("setSetting",t,n,"undefined"==typeof n?"undefined":e(n),i)}}var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};window.setSetting=t}(),function(){"use strict";function t(t,e,n,i,r){var o=.45;void 0===i&&(i=Math.PI*o),void 0===r&&(r=Math.PI*o*.6);var s=1.5*Math.PI-.5*i,a=.5*(Math.PI-r);return cache("InsideSphereGeometry("+t+", "+e+", "+n+", "+i+", "+r+")",function(){return new InsideSphereGeometry(t,e,n,s,i,a,r,(!0))})}window.shell=t}(),function(){"use strict";function t(t,e,n){return cache("SphereGeometry("+t+", "+e+", "+n+")",function(){return new THREE.SphereGeometry(t,e,n)})}window.sphere=t}(),function(){"use strict";function t(t,e,i){i=i||{},void 0===i.opacity&&(i.opacity=1),void 0===i.txtRepeatS&&(i.txtRepeatS=1),void 0===i.txtRepeatT&&(i.txtRepeatT=1),void 0===i.roughness&&(i.roughness=.5),void 0===i.metalness&&(i.metalness=0),i.unshaded=!!i.unshaded,i.wireframe=!!i.wireframe;var r=null;if(e instanceof THREE.Material)r=e,e=null;else{var o=(e.id||e).toString(),s="Primrose.textured("+o+", "+i.txtRepeatS+", "+i.txtRepeatT+")",a="Primrose.material("+s+", "+i.unshaded+", "+i.opacity+", "+i.roughness+", "+i.metalness+", "+i.wireframe+", "+i.emissive+")";r=cache(a,function(){var t={transparent:i.opacity<1,opacity:i.opacity,side:i.side||THREE.FrontSide},e=THREE.MeshStandardMaterial;return i.unshaded?(t.shading=THREE.FlatShading,e=THREE.MeshBasicMaterial):(t.roughness=i.roughness,t.metalness=i.metalness,void 0!==i.emissive&&(t.emissive=i.emissive)),new e(t)})}r.wireframe=i.wireframe;var u=null;if(t.type.indexOf("Geometry")>-1?u=new THREE.Mesh(t,r):t instanceof THREE.Object3D&&(u=t,u.material=r),"number"==typeof e||e instanceof Number)r.color.set(e);else if(e){r.color.set(16777215);var c=function(e){var o;if(e instanceof Primrose.Surface&&(o=e,e=o.texture,!i.scaleTextureWidth||!i.scaleTextureHeight)){var a=o.imageWidth,u=o.imageHeight,c=Math.ceil(Math.log(a)/Math.LN2),h=Math.ceil(Math.log(u)/Math.LN2),l=Math.pow(2,c),f=Math.pow(2,h),d=a/l,m=u/f;1===d&&1===m||(1!==d&&(i.scaleTextureWidth=d),1!==m&&(i.scaleTextureHeight=m),o.bounds.width=l,o.bounds.height=f,o.resize(),o.render(!0))}if(i.txtRepeatS*i.txtRepeatT>1&&(e.wrapS=e.wrapT=THREE.RepeatWrapping,e.repeat.set(i.txtRepeatS,i.txtRepeatT)),i.scaleTextureWidth||i.scaleTextureHeight)if(t.attributes&&t.attributes.uv&&t.attributes.uv.array){var p,y=t.attributes.uv,g=y.array;if(i.scaleTextureWidth)for(p=0;p<g.length;p+=y.itemSize)g[p]*=i.scaleTextureWidth;if(i.scaleTextureHeight)for(p=1;p<g.length;p+=y.itemSize)g[p]=1-(1-g[p])*i.scaleTextureHeight}else console.trace(t);n[s]=e,r.map=e,r.needsUpdate=!0,e.needsUpdate=!0};n[s]?c(n[s]):e instanceof Primrose.Surface?(e._material=r,Primrose.Entity.registerEntity(e),c(e),u.surface=e):"string"==typeof e?Primrose.loadTexture(e).then(c).catch(console.error.bind(console,"Error loading texture",e)):c(e instanceof Primrose.Text.Controls.TextBox?e.renderer.texture:e instanceof HTMLCanvasElement?new THREE.Texture(e):e)}return u}var e=null,n={};Primrose.loadTexture=function(t){return e||(e=new THREE.TextureLoader),e.setCrossOrigin(THREE.ImageUtils.crossOrigin),cache("Image("+t+")",function(){return new Promise(function(n,i){return e.load(t,n,null,i)})})},window.textured=t}(),function(){"use strict";function t(t,e,n){return new THREE.Vector3(t,e,n)}window.v3=t}(),function(){"use strict";function t(t,e){if(e)for(var n in t){var i=t[n];null===e[n]||void 0===e[n]||"INPUT"!==i.tagName&&"SELECT"!==i.tagName||i.dataset&&i.dataset.skipcache||("text"===i.type||"password"===i.type||"SELECT"===i.tagName?i.value=e[n]:"checkbox"!==i.type&&"radio"!==i.type||(i.checked=e[n]))}}window.writeForm=t}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var e=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),n=function(){function n(){t(this,n),this._handlers={}}return e(n,[{key:"addEventListener",value:function(t,e){this._handlers[t]||(this._handlers[t]=[]),this._handlers[t].push(e)}},{key:"removeEventListener",value:function(t,e){if(this._handlers[t]){var n=this._handlers[t].indexOf(e);n>-1&&this._handlers[t].splice(n,1)}}},{key:"emit",value:function(t,e){if(this._handlers[t])for(var n=0;n<this._handlers[t].length;++n)this._handlers[t][n](e)}}]),n}();window.Primrose.AbstractEventEmitter=n}(),function(){"use strict";function t(t){if("number"!=typeof t)throw new Error("Angle must be initialized with a number. Initial value was: "+t);var e,n,i,r=t,o=0;Object.defineProperty(this,"degrees",{set:function(t){do e=t+o-r,n=Math.abs(e+360),i=Math.abs(e-360),e=Math.abs(e),n<e&&n<i?o+=360:i<e&&(o-=360);while(e>n||e>i);r=t+o},get:function(){return r}})}var e=Math.PI/180,n=180/Math.PI;Object.defineProperty(t.prototype,"radians",{get:function(){return this.degrees*e},set:function(t){this.degrees=t*n}}),window.Primrose.Angle=t}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=1,o="([+-]?(?:(?:\\d+(?:\\.\\d*)?)|(?:\\.\\d+)))",s="\\s*,\\s*",a="(?:em|px)",u=new RegExp("translate3d\\s*\\(\\s*"+o+a+s+o+a+s+o+a+"\\s*\\)","i"),c=new RegExp("rotate3d\\s*\\(\\s*"+o+s+o+s+o+s+o+"rad\\s*\\)","i"),h=function(o){function s(){t(this,s);var n=e(this,Object.getPrototypeOf(s).call(this));return n.controlID=r++,n.focused=!1,n}return n(s,o),i(s,[{key:"focus",value:function(){this.focused=!0,this.emit("focus",{target:this})}},{key:"blur",value:function(){this.focused=!1,emit.call(this,"blur",{target:this})}},{key:"copyElement",value:function(t){if(this.element=t,t.style.transform){var e=u.exec(t.style.transform);e&&this.position.set(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])),e=c.exec(t.style.transform),e&&this.quaternion.setFromAxisAngle((new THREE.Vector3).set(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])),parseFloat(e[4]))}}}]),s}(Primrose.AbstractEventEmitter);window.Primrose.BaseControl=h}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=.001,o=function(o){function s(n){function i(t){for(var e="",n=0;n<t.length;++n)n>0&&(e+=","),e+=t[n];return e}function o(t){var e=t.clone(),n=e.getHSL();for(n.h=n.h+.5,n.l=1-n.l;n.h>1;)n.h-=1;return e.setHSL(n.h,n.s,n.l),e}var a=arguments;t(this,s);var u=e(this,Object.getPrototypeOf(s).call(this));u.options=patch(n,s.DEFAULTS),u.options.foregroundColor=u.options.foregroundColor||o(new THREE.Color(u.options.backgroundColor)).getHex(),u.zero=function(){u.input.lockMovement||(u.input.zero(),u.quality===Quality.NONE&&(u.quality=Quality.HIGH))};var c=function(t,e){var n=t;"Object3D"!==t.type&&"Group"!==t.type||!t.children[0]||(n=t.children[0],n.name=n.name||t.name);for(var r,o=n.uuid,s=new THREE.Matrix4,a=(new THREE.Matrix4).identity(),c=!1,l=h[o],f=!1,d=!!t.disabled,m={uuid:o,name:null,inScene:null,visible:null,disabled:null,matrix:null,geometry:null},p=n;null!==p;)p.updateMatrix(),s.copy(p.matrix),s.multiply(a),r=s,s=a,a=r,p=p.parent,c=c||p===u.scene;l&&l.visible===t.visible||(f=!0,m.visible=t.visible),l&&l.disabled===d||(f=!0,m.disabled=d);var y=a.elements.subarray(0,a.elements.length),g=i(y);if(l&&l.matrix&&i(l.matrix)===g||(f=!0,m.matrix=y),l&&l.inScene===c||(f=!0,m.inScene=c),e===!0&&(f=!0,m.name=t.name,m.geometry=n.geometry),f){if(l)for(var v in m)l[v]=m[v];else h[o]=m;return m}},h={};u.registerPickableObject=function(t){if(t){var e,n,i,r,o=c(t,!0),s=o.geometry;if(s instanceof THREE.BufferGeometry){var a=s.attributes,h=a.position,l=a.uv,f=a.index;for(e=[],n=[],l&&(i=[]),r=0;r<h.count;++r)e.push([h.getX(r),h.getY(r),h.getZ(r)]),l&&i.push([l.getX(r),l.getY(r)]);if(f)for(r=0;r<f.count-2;++r)n.push([f.getX(r),f.getX(r+1),f.getX(r+2)]);else for(r=0;r<h.count;r+=3)n.push([r,r+1,r+2])}else for(e=s.vertices.map(function(t){return t.toArray()}),n=[],i=[],r=0;r<s.faces.length;++r){var d=s.faces[r],m=s.faceVertexUvs[0][r];n.push([d.a,d.b,d.c]),i[d.a]=[m[0].x,m[0].y],i[d.b]=[m[1].x,m[1].y],i[d.c]=[m[2].x,m[2].y]}o.geometry={uuid:s.uuid,vertices:e,faces:n,uvs:i},u.pickableObjects[o.uuid]=t,u.projector.setObject(o)}};var l=null,f={},d=function(t){u.projector.ready=!0,l=f,f=t},m=function(t){var e=t-x;x=t,p(e),u.input.resolvePicking(f,l,u.pickableObjects),y(),g(),u.network.update(e),W(),u.emit("update",e)},p=function(t){if(u.input.update(t),u.projector.ready){u.projector.ready=!1;var e=[],n=[];for(var i in u.pickableObjects){var r=u.pickableObjects[i],o=c(r);o&&(e.push(o),o.inScene===!1&&n.push(i))}e.length>0&&u.projector.updateObjects(e);for(var s=0;s<n.length;++s)delete u.pickableObjects[n[s]];u.projector.projectPointers(u.input.segments)}},y=function(){u.sky&&u.sky.position.copy(u.input.head.position)},g=function(){u.ground&&(u.ground.position.set(Math.floor(u.input.head.position.x),-.02,Math.floor(u.input.head.position.z)),u.ground.material.needsUpdate=!0)},v=function t(e){m(e*r),w(),N(t)},w=function(){if(u.camera.position.set(0,0,0),u.camera.quaternion.set(0,0,0,1),u.audio.setPlayer(u.input.head.mesh),u.input.VR.isPresenting){u.renderer.clear(!0,!0,!0);for(var t=u.input.VR.getTransforms(u.options.nearPlane,u.options.nearPlane+u.options.drawDistance),e=0;t&&e<t.length;++e){var n=t[e],i=n.viewport;Primrose.Entity.eyeBlankAll(e),u.camera.projectionMatrix.copy(n.projection),u.camera.translateOnAxis(n.translation,1),u.renderer.setViewport(i.left*E,i.top*E,i.width*E,i.height*E),u.renderer.render(u.scene,u.camera),u.camera.translateOnAxis(n.translation,-1)}u.input.submitFrame()}(!u.input.VR.isPresenting||u.input.VR.canMirror&&!u.options.disableMirroring)&&(u.camera.fov=u.options.defaultFOV,u.camera.aspect=u.renderer.domElement.width/u.renderer.domElement.height,u.camera.updateProjectionMatrix(),u.renderer.clear(!0,!0,!0),u.renderer.setViewport(0,0,u.renderer.domElement.width,u.renderer.domElement.height),u.renderer.render(u.scene,u.camera))},b=function(){var t=u.input.VR.getTransforms(u.options.nearPlane,u.options.nearPlane+u.options.drawDistance);if(t){for(var e=0,n=0,i=0;i<t.length;++i)e+=t[i].viewport.width,n=Math.max(n,t[i].viewport.height);e=Math.floor(e*E),n=Math.floor(n*E),u.renderer.domElement.width=e,u.renderer.domElement.height=n,u.timer||w()}},x=0,P=(new THREE.Quaternion,new THREE.Vector3,new THREE.Vector3,{scene:u.options.sceneModel,avatar:u.options.avatarModel,button:u.options.button&&"string"==typeof u.options.button.model&&u.options.button.model,font:u.options.font}),E=1,T={button:Primrose.Controls.Button2D,img:Primrose.Controls.Image,div:Primrose.Controls.HtmlDoc,section:Primrose.Surface,textarea:Primrose.Text.Controls.TextBox,avatar:null,pre:{create:function(){return new Primrose.Text.Controls.TextBox({tokenizer:Primrose.Text.Grammars.PlainText,hideLineNumbers:!0,readOnly:!0})}}};u.factories=T,u.createElement=function(t){if(T[t])return T[t].create()},u.appendChild=function(t){return t instanceof THREE.Mesh?(u.scene.add(t),void u.registerPickableObject(t)):t.addToBrowserEnvironment(u,u.scene)};var _=Primrose.ModelLoader.loadObjects(P).then(function(t){window.text3D=function(t,e,n){var i=new THREE.TextGeometry(n,{font:t,size:e,height:e/5,curveSegments:2});return i.computeBoundingSphere(),i.computeBoundingBox(),i}.bind(window,t.font),t.scene&&S(t.scene),t.avatar&&(T.avatar=new Primrose.ModelLoader(t.avatar)),t.button?u.buttonFactory=new Primrose.ButtonFactory(t.button,u.options.button.options):u.buttonFactory=new Primrose.ButtonFactory(brick(16711680,1,1,1),{maxThrow:.1,minDeflection:10,colorUnpressed:8323072,colorPressed:32512,toggle:!0})}).catch(function(t){console.error(t),u.buttonFactory||(u.buttonFactory=new Primrose.ButtonFactory(brick(16711680,1,1,1),{maxThrow:.1,minDeflection:10,colorUnpressed:8323072,colorPressed:32512,toggle:!0}))});u.avatarHeight=u.options.avatarHeight,u.walkSpeed=u.options.walkSpeed,u.audio=new Primrose.Output.Audio3D;var R=null,k=null;R=u.options.ambientSound&&!isMobile?u.audio.load3DSound(u.options.ambientSound,!0,-1,1,-1).then(function(t){k=t,k.source instanceof MediaElementAudioSourceNode||(k.volume.gain.value=.1,console.log(k.source),k.source.start())}).catch(console.error.bind(console,"Audio3D loadSource")):Promise.resolve();var C=null;if(C="complete"===document.readyState?Promise.resolve("already"):new Promise(function(t,e){document.addEventListener("readystatechange",function(e){"complete"===document.readyState&&t("had to wait for it")},!1)}),u.music=new Primrose.Output.Music(u.audio.context),u.pickableObjects={},u.projector=new Primrose.Workerize(Primrose.Projector),u.options.scene=u.scene=u.options.scene||new THREE.Scene,u.options.useFog&&(u.scene.fog=new THREE.FogExp2(u.options.backgroundColor,2/u.options.drawDistance)),u.camera=new THREE.PerspectiveCamera(75,1,u.options.nearPlane,u.options.nearPlane+u.options.drawDistance),void 0!==u.options.skyTexture&&(u.sky=textured(shell(u.options.drawDistance,18,9,2*Math.PI,Math.PI),u.options.skyTexture,{unshaded:!0}),u.sky.name="Sky",u.scene.add(u.sky)),void 0!==u.options.groundTexture){var M=10,O=new THREE.PlaneGeometry(5*M,5*M,M,M);u.ground=textured(O,u.options.groundTexture,{txtRepeatS:5*M,txtRepeatT:5*M}),void 0!==u.options.sceneModel&&(u.ground.position.y=-.02),u.ground.rotation.x=-Math.PI/2,u.ground.name="Ground",u.scene.add(u.ground),u.registerPickableObject(u.ground)}u.passthrough&&u.camera.add(u.passthrough.mesh);var S=function(t){return t.buttons=[],t.traverse(function(e){e.isButton&&t.buttons.push(new Primrose.Controls.Button3D(e.parent,e.name)),e.name&&(t[e.name]=e)}),u.scene.add.apply(u.scene,t.children),u.scene.traverse(function(t){u.options.disableDefaultLighting&&t.material&&t.material.map&&textured(t,t.material.map,{unshaded:!0}),t.name&&(u.scene[t.name]=t)}),t.Camera&&(u.camera.position.copy(t.Camera.position),u.camera.quaternion.copy(t.Camera.quaternion)),t};put(light(16777215,1.5,50)).on(u.scene).at(0,10,10);var I=null;u.timer=0;var N=function(t){I=u.input.VR.currentDevice||window,null!==u.timer&&(u.timer=I.requestAnimationFrame(t))};u.goFullScreen=function(t,e){"Gaze"!==e&&(u.input.VR.connect(t),u.input.VR.requestPresent([{source:u.renderer.domElement}]).catch(function(t){return console.error("whaaat",t)}).then(function(){return u.renderer.domElement.focus()}))};var A=function(t){u.scene.add(t.stage),u.scene.add(t.head)},D=function(t){u.scene.remove(t.stage),u.scene.remove(t.head)},F=function(){for(var t=u.input.VR.isPresenting,e=u.renderer.domElement.nextElementSibling;e;)t?(e.dataset.originaldisplay=e.style.display,e.style.display="none"):e.style.display=e.dataset.originaldisplay,e=e.nextElementSibling},L=function(){u.input.VR.isPresenting&&!PointerLock.isActive&&PointerLock.request(u.input.VR.currentCanvas)};window.addEventListener("keydown",function(t){u.input.VR.isPresenting&&(t.keyCode!==Primrose.Keys.ESCAPE||u.input.VR.isPolyfilled?L():u.input.VR.cancel())}),PointerLock.addChangeListener(function(t){u.input.VR.isPresenting&&!PointerLock.isActive&&u.input.VR.cancel()}),window.addEventListener("mousedown",L),window.addEventListener("vrdisplaypresentchange",function(t){u.input.VR.isPresenting||u.input.VR.cancel(),F(),b()}),window.addEventListener("resize",b,!1),window.addEventListener("blur",u.stop,!1),window.addEventListener("focus",u.start,!1),u.projector.addEventListener("hit",d,!1),C=C.then(function(){return u.options.renderer?u.renderer=u.options.renderer:(u.renderer=new THREE.WebGLRenderer({canvas:Primrose.DOM.cascadeElement(u.options.canvasElement,"canvas",HTMLCanvasElement),context:u.options.context,antialias:u.options.antialias,alpha:!0,logarithmicDepthBuffer:!1}),u.renderer.autoClear=!1,u.renderer.sortObjects=!0,u.renderer.setClearColor(u.options.backgroundColor),u.renderer.domElement.parentElement||document.body.appendChild(u.renderer.domElement)),u.renderer.domElement.addEventListener("webglcontextlost",u.stop,!1),u.renderer.domElement.addEventListener("webglcontextrestored",u.start,!1),u.input=new Primrose.Input.FPSInput(u.renderer.domElement,u.options),u.input.addEventListener("zero",u.zero,!1),window.addEventListener("paste",u.input.Keyboard.withCurrentControl("readClipboard"),!1),window.addEventListener("wheel",u.input.Keyboard.withCurrentControl("readWheel"),!1),u.input.Keyboard.operatingSystem=u.options.os,u.input.Keyboard.codePage=u.options.language,u.input.head.add(u.camera),u.network=new Primrose.Network.Manager(u.input,u.audio,T,u.options),u.network.addEventListener("addavatar",A),u.network.addEventListener("removeavatar",D),u.input.ready});var H=0,j=0,z=10,U=2e3,B=0,G=0,V=0,W=function(){if(u.options.autoScaleQuality&&u.quality!==Quality.NONE)if(j<B+U)j=performance.now();else if(++H,H===z){var t=performance.now(),e=.001*(t-j),n=Math.round(z/e);j=t,H=0,V=G,G=n<45?-1:!isMobile&&u.options.autoRescaleQuality&&n>=60&&u.quality<Quality.MAXIMUM&&V!==-1?1:0,0!==G&&(u.quality+=G),B=t}},X=Promise.all([_,R,C]).then(function(){u.renderer.domElement.style.cursor="default",u.input.VR.displays[0].DOMElement=u.renderer.domElement,u.input.VR.connect(0),u.emit("ready")});if(u.start=function(){X.then(function(){u.audio.start(),x=performance.now()*r,N(v)})},u.stop=function(){I&&(I.cancelAnimationFrame(u.timer),u.audio.stop(),u.timer=null)},Object.defineProperties(u,{quality:{get:function(){return u.options.quality},set:function(t){0<=t&&t<PIXEL_SCALES.length&&(u.options.quality=t,E=PIXEL_SCALES[t],"WebVRConfig"in window&&(WebVRConfig.BUFFER_SCALE=E)),X.then(b)}}}),u.quality=u.options.quality,window.alert.toString().indexOf("native code")>-1){var K=function(t,e){return e||(e=function(){}),function(){u.input.VR.isPresenting?e():t.apply(window,a)}};window.alert=K(window.alert),window.confirm=K(window.confirm),window.prompt=K(window.prompt)}return u.start(),u}return n(s,o),i(s,[{key:"connect",value:function(t,e){return this.network&&this.network.connect(t,e)}},{key:"disconnect",value:function(){return this.network&&this.network.disconnect()}},{key:"displays",get:function(){return this.input.VR.displays}}]),s}(Primrose.AbstractEventEmitter);o.DEFAULTS={antialias:!0,autoScaleQuality:!0,autoRescaleQuality:!1,quality:Quality.MAXIMUM,useLeap:!1,useFog:!1,avatarHeight:1.65,walkSpeed:2,gravity:9.8,gazeLength:1,disableMirroring:!1,disableDefaultLighting:!1,backgroundColor:11517951,nearPlane:.01,drawDistance:100,defaultFOV:75,ambientSound:null,canvasElement:"frontBuffer",renderer:null,context:null,scene:null},window.Primrose.BrowserEnvironment=o}(),function(){"use strict";function t(t,e){this.options=e,this.template=t}var e=0;t.prototype.create=function(t){var n="button"+ ++e,i=this.template.clone(),r=new Primrose.Controls.Button3D(i,n,this.options,t);return r},window.Primrose.ButtonFactory=t}(),function(){"use strict";var t={};window.Primrose.Controls=t}(),function(){"use strict";var t={};window.Primrose.DOM=t}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var e=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),n=[],i=new WeakMap,r=function(){function r(e){t(this,r),this.id=e,this.parent=null,this.children=[],this.focused=!1,this.focusable=!0,this.listeners={focus:[],blur:[],click:[],keydown:[],keyup:[],paste:[],copy:[],cut:[],wheel:[],_idchanged:[]}}return e(r,null,[{key:"registerEntity",value:function(t){i.set(t.id,t),n.push(t.id),t.addEventListener("_idchanged",function(t){n.splice(n.indexOf(t.oldID),1),i.delete(t.oldID),i.set(t.entity.id,t.entity),n.push(t.entity.id)},!1)}},{key:"eyeBlankAll",value:function(t){n.forEach(function(e){i.get(e).eyeBlank(t)})}}]),e(r,[{key:"addEventListener",value:function(t,e){this.listeners[t]&&this.listeners[t].push(e)}},{key:"removeEventListener",value:function(t,e){var n=this.listeners[t];if(evt){var i=n.indexOf(e);0<=i&&i<n.length&&n.splice(i,1)}}},{key:"focus",value:function(){this.focusable&&(this.focused=!0,emit.call(this,"focus",{target:this}))}},{key:"blur",value:function(){if(this.focused){this.focused=!1;for(var t=0;t<this.children.length;++t)this.children[t].focused&&this.children[t].blur();emit.call(this,"blur",{target:this})}}},{key:"appendChild",value:function(t){t&&!t.parent&&(t.parent=this,this.children.push(t))}},{key:"removeChild",value:function(t){var e=this.children.indexOf(t);0<=e&&e<this.children.length&&(this.children.splice(e,1),t.parent=null)}},{key:"eyeBlank",value:function(t){for(var e=0;e<this.children.length;++e)this.children[e].eyeBlank(t)}},{key:"_forFocusedChild",value:function(t,e){var n=this.focusedElement;n&&n!==this&&n[t](e)}},{key:"startDOMPointer",value:function(t){for(var e=0;e<this.children.length;++e)this.children[e].startDOMPointer(t);
}},{key:"moveDOMPointer",value:function(t){this._forFocusedChild("moveDOMPointer",t)}},{key:"startUV",value:function(t){this._forFocusedChild("startUV",t)}},{key:"moveUV",value:function(t){this._forFocusedChild("moveUV",t)}},{key:"endPointer",value:function(){this._forFocusedChild("endPointer")}},{key:"keyDown",value:function(t){this._forFocusedChild("keyDown",t)}},{key:"keyUp",value:function(t){this._forFocusedChild("keyUp",t)}},{key:"readClipboard",value:function(t){this._forFocusedChild("readClipboard",t)}},{key:"copySelectedText",value:function(t){this._forFocusedChild("copySelectedText",t)}},{key:"cutSelectedText",value:function(t){this._forFocusedChild("cutSelectedText",t)}},{key:"readWheel",value:function(t){this._forFocusedChild("readWheel",t)}},{key:"id",get:function(){return this._id},set:function(t){var e=this._id;this._id=new String(t),emit.call(this,"_idchanged",{oldID:e,entity:this})}},{key:"theme",get:function(){return null},set:function(t){for(var e=0;e<this.children.length;++e)this.children[e].theme=t}},{key:"lockMovement",get:function(){for(var t=!1,e=0;e<this.children.length&&!t;++e)t|=this.children[e].lockMovement;return t}},{key:"focusedElement",get:function(){for(var t=null,e=this;e&&e.focused;){t=e;var n=e.children;e=null;for(var i=0;i<n.length;++i){var r=n[i];r.focused&&(e=r)}}return t}}]),r}();window.Primrose.Entity=r}(),function(){"use strict";var t={};window.Primrose.HTTP=t}(),function(){"use strict";var t={};window.Primrose.Input=t}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var e=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),n=["heading","pitch","roll","pointerPitch","headX","headY","headZ"],i=(new THREE.Vector3(0,0,(-1)),new THREE.Vector3(0,0,0),function(){function i(e,n,r,o,s){var a=this;t(this,i),this.name=e,this.parent=n,this.commands={},this.commandNames=[],this.socket=o,this.enabled=!0,this.paused=!1,this.ready=!0,this.transmitting=!0,this.receiving=!0,this.socketReady=!1,this.inPhysicalUse=!1,this.inputState={buttons:[],axes:[],ctrl:!1,alt:!1,shift:!1,meta:!1},this.lastState="",this.listeners={teleport:[]};var u=function(t){for(var e=0;e<Primrose.Keys.MODIFIER_KEYS.length;++e){var n=Primrose.Keys.MODIFIER_KEYS[e];a.inputState[n]=t[n+"Key"]}};window.addEventListener("keydown",u,!1),window.addEventListener("keyup",u,!1),o&&(o.on("open",function(){a.socketReady=!0,a.inPhysicalUse=!a.receiving}),o.on(e,function(t){a.receiving&&(a.inPhysicalUse=!1,a.decodeStateSnapshot(t),a.fireCommands())}),o.on("close",function(){a.inPhysicalUse=!0,a.socketReady=!1}));for(var c in r)this.addCommand(c,r[c]);for(var h=0;h<Primrose.Keys.MODIFIER_KEYS.length;++h)this.inputState[Primrose.Keys.MODIFIER_KEYS[h]]=!1;this.axisNames=s||Primrose.Input[e]&&Primrose.Input[e].AXES||[];for(var h=0;h<this.axisNames.length;++h)this.inputState.axes[h]=0}return e(i,null,[{key:"defineAxisProperties",value:function(t,e){t.AXES=e,e.forEach(function(e,n){t[e]=n+1,Object.defineProperty(t.prototype,e,{get:function(){return this.getAxis(e)},set:function(t){this.setAxis(e,t)}})})}}]),e(i,[{key:"addCommand",value:function(t,e){e.name=t,e=this.cloneCommand(e),"undefined"==typeof e.repetitions&&(e.repetitions=1),e.state={value:null,pressed:!1,wasPressed:!1,fireAgain:!1,lt:0,ct:0,repeatCount:0},this.commands[t]=e,this.commandNames.push(t)}},{key:"addEventListener",value:function(t,e,n){this.listeners[t]&&this.listeners[t].push(e)}},{key:"cloneCommand",value:function(t){return{name:t.name,disabled:!!t.disabled,dt:t.dt||0,deadzone:t.deadzone||0,threshold:t.threshold||0,repetitions:t.repetitions,scale:t.scale,offset:t.offset,min:t.min,max:t.max,integrate:t.integrate||!1,delta:t.delta||!1,axes:this.maybeClone(t.axes),commands:t.commands&&t.commands.slice()||[],buttons:this.maybeClone(t.buttons),metaKeys:this.maybeClone(t.metaKeys&&t.metaKeys.map(function(t){for(var e=0;e<Primrose.Keys.MODIFIER_KEYS.length;++e){var n=Primrose.Keys.MODIFIER_KEYS[e];if(Math.abs(t)===Primrose.Keys[n.toLocaleUpperCase()])return Math.sign(t)*(e+1)}})),commandDown:t.commandDown,commandUp:t.commandUp}}},{key:"maybeClone",value:function(t){var e=[];if(t)for(var n=0;n<t.length;++n)e[n]={index:Math.abs(t[n])-1,toggle:t[n]<0,sign:t[n]<0?-1:1};return e}},{key:"update",value:function(t){if(this.enabled&&this.ready&&this.enabled&&this.inPhysicalUse&&!this.paused&&t>0){for(var e in this.commands){var n=this.commands[e];if(n.state.wasPressed=n.state.pressed,n.state.pressed=!1,!n.disabled){var i=!0;if(n.metaKeys)for(var r=0;r<n.metaKeys.length&&i;++r){var o=n.metaKeys[r];i=i&&(this.inputState[Primrose.Keys.MODIFIER_KEYS[o.index]]&&!o.toggle||!this.inputState[Primrose.Keys.MODIFIER_KEYS[o.index]]&&o.toggle)}if(i){var r,s,a=!0,u=0,c=!1;for(r in this.inputState.buttons)if(this.inputState.buttons[r]){c=!0;break}if(n.buttons)for(r=0;r<n.buttons.length;++r){var h=n.buttons[r],l=h.index+1,f=l===Primrose.Keys.ANY&&c||!!this.inputState.buttons[l];s=f?h.sign:0,a=a&&(f&&!h.toggle||!f&&h.toggle),Math.abs(s)>Math.abs(u)&&(u=s)}if(n.axes)for(r=0;r<n.axes.length;++r){var d=n.axes[r];s=d.sign*this.inputState.axes[d.index],Math.abs(s)>Math.abs(u)&&(u=s)}for(r=0;r<n.commands.length;++r)s=this.getValue(n.commands[r]),Math.abs(s)>Math.abs(u)&&(u=s);if(void 0!==n.scale&&(u*=n.scale),void 0!==n.offset&&(u+=n.offset),n.deadzone&&Math.abs(u)<n.deadzone&&(u=0),n.integrate)u=this.getValue(n.name)+u*t;else if(n.delta){var m=u;void 0!==n.state.lv&&(u=(u-n.state.lv)/t),n.state.lv=m}void 0!==n.min&&(u=Math.max(n.min,u)),void 0!==n.max&&(u=Math.min(n.max,u)),n.threshold&&(a=a&&u>n.threshold),n.state.pressed=a,n.state.value=u}n.state.lt+=t,n.state.fireAgain=n.state.pressed&&n.state.lt>=n.dt&&(n.repetitions===-1||n.state.repeatCount<n.repetitions),n.state.fireAgain?(n.state.lt=0,++n.state.repeatCount):n.state.pressed||(n.state.repeatCount=0)}}if(this.socketReady&&this.transmitting){var p=this.makeStateSnapshot();p!==this.lastState&&(this.socket.emit(this.name,p),this.lastState=p)}this.fireCommands()}}},{key:"zero",value:function(){for(var t=0;this.enabled&&t<n.length;++t)this.setValue(n[t],0)}},{key:"fireCommands",value:function(){if(this.ready&&!this.paused)for(var t in this.commands){var e=this.commands[t];e.state.fireAgain&&e.commandDown&&e.commandDown(this.name),!e.state.pressed&&e.state.wasPressed&&e.commandUp&&e.commandUp(this.name)}}},{key:"makeStateSnapshot",value:function(){var t="",e=0,n=Object.keys(this.commands).length;for(var i in this.commands){var r=this.commands[i];r.state&&(t+=e<<2|(r.state.pressed?1:0)|(r.state.fireAgain?2:0)+":"+r.state.value,e<n-1&&(t+="|")),++e}return t}},{key:"decodeStateSnapshot",value:function(t){var e,n;for(n in this.commands)e=this.commands[n],e.state.wasPressed=e.state.pressed;for(var i=t.split("|"),r=0;r<i.length;++r){var o=i[r],s=o.split(":"),a=parseInt(s[0],10),u=0!==(1&a),c=0!==(2&h),h=parseInt(s[2],10);a>>=2,n=this.commandNames(a),e=this.commands[n],e.state={value:parseFloat(s[1]),pressed:u,fireAgain:c}}}},{key:"setProperty",value:function(t,e,n){this.commands[e]&&(this.commands[e][t]=n)}},{key:"setDeadzone",value:function(t,e){this.setProperty("deadzone",t,e)}},{key:"setScale",value:function(t,e){this.setProperty("scale",t,e)}},{key:"setDT",value:function(t,e){this.setProperty("dt",t,e)}},{key:"setMin",value:function(t,e){this.setProperty("min",t,e)}},{key:"setMax",value:function(t,e){this.setProperty("max",t,e)}},{key:"addToArray",value:function(t,e,n){this.commands[e]&&this.commands[e][t]&&this.commands[e][t].push(n)}},{key:"addMetaKey",value:function(t,e){this.addToArray("metaKeys",t,e)}},{key:"addAxis",value:function(t,e){this.addToArray("axes",t,e)}},{key:"addButton",value:function(t,e){this.addToArray("buttons",t,e)}},{key:"removeMetaKey",value:function(t,e){this.removeFromArray("metaKeys",t,e)}},{key:"removeAxis",value:function(t,e){this.removeFromArray("axes",t,e)}},{key:"removeButton",value:function(t,e){this.removeFromArray("buttons",t,e)}},{key:"invertAxis",value:function(t,e){this.invertInArray("axes",t,e)}},{key:"invertButton",value:function(t,e){this.invertInArray("buttons",t,e)}},{key:"invertMetaKey",value:function(t,e){this.invertInArray("metaKeys",t,e)}},{key:"removeFromArray",value:function(t,e,n){if(this.commands[e]&&this.commands[e][t]){var i=this.commands[e][t],r=i.indexOf(n);r>-1&&i.splice(r,1)}}},{key:"invertInArray",value:function(t,e,n){if(this.commands[e]&&this.commands[e][t]){var i=this.commands[e][t],r=i.indexOf(n);r>-1&&(i[r]*=-1)}}},{key:"pause",value:function(t){this.paused=t}},{key:"isPaused",value:function(){return this.paused}},{key:"enable",value:function(t,e){void 0!==e&&null!==e||(e=t,t=null),t?this.setProperty("disabled",t,!e):this.enabled=e}},{key:"isEnabled",value:function(t){return t&&this.commands[t]&&!this.commands[t].disabled}},{key:"transmit",value:function(t){this.transmitting=t}},{key:"isTransmitting",value:function(){return this.transmitting}},{key:"receive",value:function(t){this.receiving=t}},{key:"isReceiving",value:function(){return this.receiving}},{key:"getAxis",value:function(t){var e=this.axisNames.indexOf(t);if(e>-1){var n=this.inputState.axes[e]||0;return n}return null}},{key:"setAxis",value:function(t,e){var n=this.axisNames.indexOf(t);n>-1&&(this.inPhysicalUse=!0,this.inputState.axes[n]=e)}},{key:"setButton",value:function(t,e){this.inPhysicalUse=!0,this.inputState.buttons[t]=e}},{key:"getValue",value:function(t){return(this.enabled||this.receiving&&this.socketReady)&&this.isEnabled(t)&&this.commands[t].state.value||this.getAxis(t)||0}},{key:"setValue",value:function(t,e){var n=this.axisNames.indexOf(t);!this.commands[t]&&n>-1?this.setAxis(t,e):this.commands[t]&&!this.commands[t].disabled&&(this.commands[t].state.value=e)}},{key:"isDown",value:function(t){return(this.enabled||this.receiving&&this.socketReady)&&this.isEnabled(t)&&this.commands[t].state.pressed}},{key:"isUp",value:function(t){return(this.enabled||this.receiving&&this.socketReady)&&this.isEnabled(t)&&this.commands[t].state.pressed}}]),i}());window.Primrose.InputProcessor=i}(),function(){"use strict";var t={ANY:Number.MAX_VALUE,MODIFIER_KEYS:["ctrl","shift","alt","meta","meta_l","meta_r"],SHIFT:16,CTRL:17,ALT:18,META:91,META_L:91,META_R:92,BACKSPACE:8,TAB:9,ENTER:13,SPACE:32,DELETE:46,PAUSEBREAK:19,CAPSLOCK:20,NUMLOCK:144,SCROLLLOCK:145,INSERT:45,ESCAPE:27,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFTARROW:37,UPARROW:38,RIGHTARROW:39,DOWNARROW:40,SELECTKEY:93,NUMBER0:48,NUMBER1:49,NUMBER2:50,NUMBER3:51,NUMBER4:52,NUMBER5:53,NUMBER6:54,NUMBER7:55,NUMBER8:56,NUMBER9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMALPOINT:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,VOLUME_DOWN:174,VOLUME_UP:175,TRACK_NEXT:176,TRACK_PREVIOUS:177};for(var e in t){var n=t[e];t.hasOwnProperty(e)&&"number"==typeof n&&(t[n]=e)}window.Primrose.Keys=t}(),function(){"use strict";function t(t){return t.traverse(function(t){t.geometry&&(t.geometry.computeBoundingSphere(),t.geometry.computeBoundingBox())}),t}function e(t){return t.traverse(function(t){if(t instanceof THREE.Mesh)for(var e in a)t[e]=t[e]||a[e](t)}),t}function n(t){this.template=t}function i(t,e){return function(i){return n.loadObject(t[e]).then(function(t){return i[e]=t,i})}}var r={".json":THREE.ObjectLoader,".fbx":THREE.FBXLoader,".mtl":THREE.MTLLoader,".obj":THREE.OBJLoader,".stl":THREE.STLLoader,".typeface.js":THREE.FontLoader},o=/((?:[^\/]+\/)+)(\w+)(\.(?:\w+))$/,s=/(\.(?:\w+))+$/,a={isButton:function(t){return t.material&&t.material.name.match(/^button\d+$/)},isSolid:function(t){return!t.name.match(/^(water|sky)/)},isGround:function(t){return t.material&&t.material.name&&t.material.name.match(/\bground\b/)}};n.loadModel=function(t,e,i){return n.loadObject(t,e,i).then(function(t){return new n(t)})},n.prototype.clone=function(){var t=this,n=this.template.clone();return n.traverse(function(e){e instanceof THREE.SkinnedMesh&&(n.animation=new THREE.Animation(e,e.geometry.animation),!t.template.originalAnimationData&&n.animation.data&&(t.template.originalAnimationData=n.animation.data),n.animation.data||(n.animation.data=t.template.originalAnimationData))}),e(n),n},n.loadObject=function(i,a,u){var c=i.match(s),h=a&&"."+a||c[0];if(h){h=h.toLowerCase();var l=new r[h];if(l){var f=i.substring(0,c.index),d=f+"_"+h.toLowerCase(),m=document.getElementById(d),p=Promise.resolve();if(".obj"===h){var y=i.replace(s,".mtl");p=p.then(function(){return n.loadObject(y,"mtl",u)}).then(function(t){t.preload(),l.setMaterials(t)})}else if(".mtl"===h){var g=i.match(o),v=g[1];i=g[2]+g[3],l.setBaseUrl(v),l.setPath(v)}if(m){var w=m.innerHTML.split(/\r?\n/g).map(function(t){return t.trim()}).join("\n");p=p.then(function(){return l.parse(w)})}else l.setCrossOrigin&&l.setCrossOrigin(THREE.ImageUtils.crossOrigin),p=p.then(function(){return new Promise(function(t,e){return l.load(i,t,u,e)})});return".json"===h&&(p=p.then(t)),".mtl"!==h&&".typeface.js"!==h&&(p=p.then(e)),p=p.catch(console.error.bind(console,"MODEL_ERR",i))}return Promise.reject("There is no loader type for the file extension: "+h)}return Promise.reject("File path `"+i+"` does not have a file extension, and a type was not provided as a parameter, so we can't determine the type.")},n.loadObjects=function(t){var e={},n=Promise.resolve(e);for(var r in t)t[r]&&(n=n.then(i(t,r)));return n},window.Primrose.ModelLoader=n}(),function(){"use strict";var t={};window.Primrose.Network=t}(),function(){"use strict";var t={};window.Primrose.Output=t}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=.4,o=new THREE.Vector3(0,0,(-1)),s=5,a=s*s,u=.01,c=3*u,h=new THREE.Euler,l=new THREE.Vector3(0,0,0),f=function(f){function d(n,i,o,s,a){var h=arguments.length<=5||void 0===arguments[5]?null:arguments[5];t(this,d);var l=e(this,Object.getPrototypeOf(d).call(this));return l.name=n,l.orientationDevice=a,l.positionDevice=h||a,l._currentControl=null,l.showPointer=!0,l.color=i,l.emission=o,l.velocity=new THREE.Vector3,l.mesh=textured(box(u,u,c),l.color,{emissive:l.emission}),l.mesh.geometry.vertices.forEach(function(t){t.z-=.5*c+.5}),l.disk=textured(sphere(r,128,3),l.color,{emissive:l.emission}),l.disk.geometry.computeBoundingBox(),l.disk.geometry.vertices.forEach(function(t){return t.y-=l.disk.geometry.boundingBox.min.y}),l.disk.geometry.computeBoundingBox(),l.disk.scale.set(1,.1,1),s&&l.mesh.add(textured(box(.1,.025,.2),l.color,{emissive:l.emission})),l}return n(d,f),i(d,[{key:"add",value:function(t){this.mesh.add(t)}},{key:"addToBrowserEnvironment",value:function(t,e){e.add(this.mesh),e.add(this.disk)}},{key:"updateMatrix",value:function(){return this.mesh.updateMatrix()}},{key:"applyMatrix",value:function(t){return this.mesh.applyMatrix(t)}},{key:"update",value:function(){if(this.orientationDevice instanceof Primrose.PoseInputProcessor)this.position.copy(this.orientationDevice.position),this.quaternion.copy(this.orientationDevice.quaternion);else{for(var t=this.orientationDevice,e=0,n=0;t;)e+=t.getValue("pitch"),n+=t.getValue("heading"),t=t.parent;h.set(e,n,0,"YXZ"),this.quaternion.setFromEuler(h),this.position.copy(this.positionDevice.position)}}},{key:"resolvePicking",value:function(t,e,n){if(this.disk.visible=!1,this.mesh.visible=!1,this.orientationDevice.enabled&&this.showPointer){textured(this.mesh,this.color,{emissive:this.minorColor}),this.mesh.visible=!0;for(var i,r,o,u=0,c=0,h=t[this.name],f=(e&&e[this.name],this.orientationDevice),d=!1;f;)u+=f.getValue("buttons"),c+=f.getValue("dButtons"),f=f.parent;var m=0!==c;if(h){i=n[h.objectID],d=i&&"Ground"===i.name;var p=h.facePoint;if(o=h.point,r=i&&(i.button||i.surface),l.fromArray(p).sub(this.mesh.position),this.disk.visible=d,d){var y=l.x*l.x+l.z*l.z;if(y>a){var g=Math.sqrt(y),v=s/g,w=l.y;l.y=0,l.multiplyScalar(v),l.y=w,textured(this.mesh,16776960,{emissive:8355584})}this.disk.position.copy(this.mesh.position).add(l)}else textured(this.mesh,65280,{emissive:32512})}if(m)if(u){var b=!!this.currentControl,x=this.currentControl;this.currentControl=null,i&&(x&&x===r&&(b=!1),!this.currentControl&&r?(this.currentControl=r,this.currentControl.focus()):d&&this.emit("teleport",{name:this.name,position:this.disk.position}),this.currentControl&&this.currentControl.startUV(o)),b&&x.blur()}else this.currentControl&&this.currentControl.endPointer();else!m&&u>0&&this.currentControl&&o&&this.currentControl.moveUV(o)}}},{key:"position",get:function(){return this.mesh.position}},{key:"quaternion",get:function(){return this.mesh.quaternion}},{key:"matrix",get:function(){return this.mesh.matrix}},{key:"currentControl",get:function(){return this._currentControl},set:function(t){for(var e=this;e;)e._currentControl=t,e=e.parent}},{key:"segment",get:function(){if(this.showPointer)return o.set(0,0,-1).applyQuaternion(this.mesh.quaternion).add(this.mesh.position),[this.name,this.mesh.position.toArray(),o.toArray()]}},{key:"lockMovement",get:function(){for(var t=this;t;){if(this.currentControl&&this.currentControl.lockMovement)return!0;t=t.parent}return!1}}]),d}(Primrose.AbstractEventEmitter);window.Primrose.Pointer=f}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,i)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(i)},o={position:[0,0,0],orientation:[0,0,0,1]},s=new THREE.Vector3,a=function(a){function u(n,i,r,o,s){t(this,u);var a=e(this,Object.getPrototypeOf(u).call(this,n,i,r,o,s));return a.currentDevice=null,a.lastPose=null,a.currentPose=null,a.posePosition=new THREE.Vector3,a.poseQuaternion=new THREE.Quaternion,a.position=new THREE.Vector3,a.quaternion=new THREE.Quaternion,a.matrix=new THREE.Matrix4,a}return n(u,a),i(u,[{key:"update",value:function(t){if(r(Object.getPrototypeOf(u.prototype),"update",this).call(this,t),this.currentDevice){var e=this.currentPose||this.lastPose||o;this.lastPose=e,this.inPhysicalUse=!!this.currentPose;var n=this.currentPose&&this.currentPose.orientation,i=this.currentPose&&this.currentPose.position;n?this.poseQuaternion.fromArray(n):this.poseQuaternion.set(0,0,0,1),i?this.posePosition.fromArray(i):this.posePosition.set(0,0,0)}}},{key:"updateStage",value:function(t){this.matrix.makeRotationFromQuaternion(this.poseQuaternion),this.matrix.setPosition(this.posePosition),this.matrix.multiplyMatrices(t,this.matrix),this.matrix.decompose(this.position,this.quaternion,s)}}]),u}(Primrose.InputProcessor);window.Primrose.PoseInputProcessor=a}(),function(){"use strict";function t(t){!function(){"undefined"==typeof THREE&&(self.THREE={REVISION:"72dev"},void 0===Math.sign&&(Math.sign=function(t){return t<0?-1:t>0?1:+t}),void 0===Function.prototype.name&&void 0!==Object.defineProperty&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*(\S*)\s*\(/)[1]}}),THREE.Quaternion=function(t,e,n,i){this._x=t||0,this._y=e||0,this._z=n||0,this._w=void 0!==i?i:1},THREE.Quaternion.prototype={constructor:THREE.Quaternion,get x(){return this._x},set x(t){this._x=t,this.onChangeCallback()},get y(){return this._y},set y(t){this._y=t,this.onChangeCallback()},get z(){return this._z},set z(t){this._z=t,this.onChangeCallback()},get w(){return this._w},set w(t){this._w=t,this.onChangeCallback()},set:function(t,e,n,i){return this._x=t,this._y=e,this._z=n,this._w=i,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._w)},copy:function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this.onChangeCallback(),this},setFromEuler:function(t,e){if(t instanceof THREE.Euler==!1)throw new Error("THREE.Quaternion: .setFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var n=Math.cos(t._x/2),i=Math.cos(t._y/2),r=Math.cos(t._z/2),o=Math.sin(t._x/2),s=Math.sin(t._y/2),a=Math.sin(t._z/2);return"XYZ"===t.order?(this._x=o*i*r+n*s*a,this._y=n*s*r-o*i*a,this._z=n*i*a+o*s*r,this._w=n*i*r-o*s*a):"YXZ"===t.order?(this._x=o*i*r+n*s*a,this._y=n*s*r-o*i*a,this._z=n*i*a-o*s*r,this._w=n*i*r+o*s*a):"ZXY"===t.order?(this._x=o*i*r-n*s*a,this._y=n*s*r+o*i*a,this._z=n*i*a+o*s*r,this._w=n*i*r-o*s*a):"ZYX"===t.order?(this._x=o*i*r-n*s*a,this._y=n*s*r+o*i*a,this._z=n*i*a-o*s*r,this._w=n*i*r+o*s*a):"YZX"===t.order?(this._x=o*i*r+n*s*a,this._y=n*s*r+o*i*a,this._z=n*i*a-o*s*r,this._w=n*i*r-o*s*a):"XZY"===t.order&&(this._x=o*i*r-n*s*a,this._y=n*s*r-o*i*a,this._z=n*i*a+o*s*r,this._w=n*i*r+o*s*a),e!==!1&&this.onChangeCallback(),this},setFromAxisAngle:function(t,e){var n=e/2,i=Math.sin(n);return this._x=t.x*i,this._y=t.y*i,this._z=t.z*i,this._w=Math.cos(n),this.onChangeCallback(),this},setFromRotationMatrix:function(t){var e,n=t.elements,i=n[0],r=n[4],o=n[8],s=n[1],a=n[5],u=n[9],c=n[2],h=n[6],l=n[10],f=i+a+l;return f>0?(e=.5/Math.sqrt(f+1),this._w=.25/e,this._x=(h-u)*e,this._y=(o-c)*e,this._z=(s-r)*e):i>a&&i>l?(e=2*Math.sqrt(1+i-a-l),this._w=(h-u)/e,this._x=.25*e,this._y=(r+s)/e,this._z=(o+c)/e):a>l?(e=2*Math.sqrt(1+a-i-l),this._w=(o-c)/e,this._x=(r+s)/e,this._y=.25*e,this._z=(u+h)/e):(e=2*Math.sqrt(1+l-i-a),this._w=(s-r)/e,this._x=(o+c)/e,this._y=(u+h)/e,this._z=.25*e),this.onChangeCallback(),this},setFromUnitVectors:function(){var t,e,n=1e-6;return function(i,r){return void 0===t&&(t=new THREE.Vector3),e=i.dot(r)+1,e<n?(e=0,Math.abs(i.x)>Math.abs(i.z)?t.set(-i.y,i.x,0):t.set(0,-i.z,i.y)):t.crossVectors(i,r),this._x=t.x,this._y=t.y,this._z=t.z,this._w=e,this.normalize(),this}}(),inverse:function(){return this.conjugate().normalize(),this},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this},dot:function(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this.onChangeCallback(),this},multiply:function(t,e){return void 0!==e?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(t,e)):this.multiplyQuaternions(this,t)},multiplyQuaternions:function(t,e){var n=t._x,i=t._y,r=t._z,o=t._w,s=e._x,a=e._y,u=e._z,c=e._w;return this._x=n*c+o*s+i*u-r*a,this._y=i*c+o*a+r*s-n*u,this._z=r*c+o*u+n*a-i*s,this._w=o*c-n*s-i*a-r*u,this.onChangeCallback(),this},multiplyVector3:function(t){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),t.applyQuaternion(this)},slerp:function(t,e){if(0===e)return this;if(1===e)return this.copy(t);var n=this._x,i=this._y,r=this._z,o=this._w,s=o*t._w+n*t._x+i*t._y+r*t._z;if(s<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,s=-s):this.copy(t),s>=1)return this._w=o,this._x=n,this._y=i,this._z=r,this;var a=Math.acos(s),u=Math.sqrt(1-s*s);if(Math.abs(u)<.001)return this._w=.5*(o+this._w),this._x=.5*(n+this._x),this._y=.5*(i+this._y),this._z=.5*(r+this._z),this;var c=Math.sin((1-e)*a)/u,h=Math.sin(e*a)/u;return this._w=o*c+this._w*h,this._x=n*c+this._x*h,this._y=i*c+this._y*h,this._z=r*c+this._z*h,this.onChangeCallback(),this},equals:function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w},fromArray:function(t,e){return void 0===e&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this.onChangeCallback(),this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t},onChange:function(t){return this.onChangeCallback=t,this},onChangeCallback:function(){}},THREE.Quaternion.slerp=function(t,e,n,i){return n.copy(t).slerp(e,i)},THREE.Vector3=function(t,e,n){this.x=t||0,this.y=e||0,this.z=n||0},THREE.Vector3.prototype={constructor:THREE.Vector3,set:function(t,e,n){return this.x=t,this.y=e,this.z=n,this},setX:function(t){return this.x=t,this},setY:function(t){return this.y=t,this},setZ:function(t){return this.z=t,this},setComponent:function(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}},getComponent:function(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},add:function(t,e){return void 0!==e?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)},addScalar:function(t){return this.x+=t,this.y+=t,this.z+=t,this},addVectors:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},addScaledVector:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this},sub:function(t,e){return void 0!==e?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this)},subScalar:function(t){return this.x-=t,this.y-=t,this.z-=t,this},subVectors:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},multiply:function(t,e){return void 0!==e?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(t,e)):(this.x*=t.x,this.y*=t.y,this.z*=t.z,this)},multiplyScalar:function(t){return this.x*=t,this.y*=t,this.z*=t,this},multiplyVectors:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this},applyEuler:function(){var t;return function(e){return e instanceof THREE.Euler==!1&&console.error("THREE.Vector3: .applyEuler() now expects a Euler rotation rather than a Vector3 and order."),void 0===t&&(t=new THREE.Quaternion),this.applyQuaternion(t.setFromEuler(e)),this}}(),applyAxisAngle:function(){var t;return function(e,n){return void 0===t&&(t=new THREE.Quaternion),this.applyQuaternion(t.setFromAxisAngle(e,n)),this}}(),applyMatrix3:function(t){var e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[3]*n+r[6]*i,this.y=r[1]*e+r[4]*n+r[7]*i,this.z=r[2]*e+r[5]*n+r[8]*i,this},applyMatrix4:function(t){var e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[4]*n+r[8]*i+r[12],this.y=r[1]*e+r[5]*n+r[9]*i+r[13],this.z=r[2]*e+r[6]*n+r[10]*i+r[14],this},applyProjection:function(t){var e=this.x,n=this.y,i=this.z,r=t.elements,o=1/(r[3]*e+r[7]*n+r[11]*i+r[15]);return this.x=(r[0]*e+r[4]*n+r[8]*i+r[12])*o,this.y=(r[1]*e+r[5]*n+r[9]*i+r[13])*o,this.z=(r[2]*e+r[6]*n+r[10]*i+r[14])*o,this},applyQuaternion:function(t){var e=this.x,n=this.y,i=this.z,r=t.x,o=t.y,s=t.z,a=t.w,u=a*e+o*i-s*n,c=a*n+s*e-r*i,h=a*i+r*n-o*e,l=-r*e-o*n-s*i;return this.x=u*a+l*-r+c*-s-h*-o,this.y=c*a+l*-o+h*-r-u*-s,this.z=h*a+l*-s+u*-o-c*-r,this},project:function(){var t;return function(e){return void 0===t&&(t=new THREE.Matrix4),t.multiplyMatrices(e.projectionMatrix,t.getInverse(e.matrixWorld)),this.applyProjection(t)}}(),unproject:function(){var t;return function(e){return void 0===t&&(t=new THREE.Matrix4),t.multiplyMatrices(e.matrixWorld,t.getInverse(e.projectionMatrix)),this.applyProjection(t)}}(),transformDirection:function(t){var e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[4]*n+r[8]*i,this.y=r[1]*e+r[5]*n+r[9]*i,this.z=r[2]*e+r[6]*n+r[10]*i,this.normalize(),this},divide:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},divideScalar:function(t){if(0!==t){var e=1/t;this.x*=e,this.y*=e,this.z*=e}else this.x=0,this.y=0,this.z=0;return this},min:function(t){return this.x>t.x&&(this.x=t.x),this.y>t.y&&(this.y=t.y),this.z>t.z&&(this.z=t.z),this},max:function(t){return this.x<t.x&&(this.x=t.x),this.y<t.y&&(this.y=t.y),this.z<t.z&&(this.z=t.z),this},clamp:function(t,e){return this.x<t.x?this.x=t.x:this.x>e.x&&(this.x=e.x),this.y<t.y?this.y=t.y:this.y>e.y&&(this.y=e.y),this.z<t.z?this.z=t.z:this.z>e.z&&(this.z=e.z),this},clampScalar:function(){var t,e;return function(n,i){return void 0===t&&(t=new THREE.Vector3,e=new THREE.Vector3),t.set(n,n,n),e.set(i,i,i),this.clamp(t,e)}}(),floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(t){var e=this.length();return 0!==e&&t!==e&&this.multiplyScalar(t/e),this},lerp:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this},lerpVectors:function(t,e,n){return this.subVectors(e,t).multiplyScalar(n).add(t),this},cross:function(t,e){if(void 0!==e)return console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(t,e);var n=this.x,i=this.y,r=this.z;return this.x=i*t.z-r*t.y,this.y=r*t.x-n*t.z,this.z=n*t.y-i*t.x,this},crossVectors:function(t,e){var n=t.x,i=t.y,r=t.z,o=e.x,s=e.y,a=e.z;return this.x=i*a-r*s,this.y=r*o-n*a,this.z=n*s-i*o,this},projectOnVector:function(){var t,e;return function(n){
return void 0===t&&(t=new THREE.Vector3),t.copy(n).normalize(),e=this.dot(t),this.copy(t).multiplyScalar(e)}}(),projectOnPlane:function(){var t;return function(e){return void 0===t&&(t=new THREE.Vector3),t.copy(this).projectOnVector(e),this.sub(t)}}(),reflect:function(){var t;return function(e){return void 0===t&&(t=new THREE.Vector3),this.sub(t.copy(e).multiplyScalar(2*this.dot(e)))}}(),angleTo:function(t){var e=this.dot(t)/(this.length()*t.length());return Math.acos(THREE.Math.clamp(e,-1,1))},distanceTo:function(t){return Math.sqrt(this.distanceToSquared(t))},distanceToSquared:function(t){var e=this.x-t.x,n=this.y-t.y,i=this.z-t.z;return e*e+n*n+i*i},setEulerFromRotationMatrix:function(t,e){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},setEulerFromQuaternion:function(t,e){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},getPositionFromMatrix:function(t){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(t)},getScaleFromMatrix:function(t){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(t)},getColumnFromMatrix:function(t,e){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(t,e)},setFromMatrixPosition:function(t){return this.x=t.elements[12],this.y=t.elements[13],this.z=t.elements[14],this},setFromMatrixScale:function(t){var e=this.set(t.elements[0],t.elements[1],t.elements[2]).length(),n=this.set(t.elements[4],t.elements[5],t.elements[6]).length(),i=this.set(t.elements[8],t.elements[9],t.elements[10]).length();return this.x=e,this.y=n,this.z=i,this},setFromMatrixColumn:function(t,e){var n=4*t,i=e.elements;return this.x=i[n],this.y=i[n+1],this.z=i[n+2],this},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},fromArray:function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t},fromAttribute:function(t,e,n){return void 0===n&&(n=0),e=e*t.itemSize+n,this.x=t.array[e],this.y=t.array[e+1],this.z=t.array[e+2],this}},THREE.Matrix4=function(){this.elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},THREE.Matrix4.prototype={constructor:THREE.Matrix4,set:function(t,e,n,i,r,o,s,a,u,c,h,l,f,d,m,p){var y=this.elements;return y[0]=t,y[4]=e,y[8]=n,y[12]=i,y[1]=r,y[5]=o,y[9]=s,y[13]=a,y[2]=u,y[6]=c,y[10]=h,y[14]=l,y[3]=f,y[7]=d,y[11]=m,y[15]=p,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},clone:function(){return(new THREE.Matrix4).fromArray(this.elements)},copy:function(t){return this.elements.set(t.elements),this},extractPosition:function(t){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(t)},copyPosition:function(t){var e=this.elements,n=t.elements;return e[12]=n[12],e[13]=n[13],e[14]=n[14],this},extractBasis:function(t,e,n){var i=this.elements;return t.set(i[0],i[1],i[2]),e.set(i[4],i[5],i[6]),n.set(i[8],i[9],i[10]),this},makeBasis:function(t,e,n){return this.set(t.x,e.x,n.x,0,t.y,e.y,n.y,0,t.z,e.z,n.z,0,0,0,0,1),this},extractRotation:function(){var t;return function(e){void 0===t&&(t=new THREE.Vector3);var n=this.elements,i=e.elements,r=1/t.set(i[0],i[1],i[2]).length(),o=1/t.set(i[4],i[5],i[6]).length(),s=1/t.set(i[8],i[9],i[10]).length();return n[0]=i[0]*r,n[1]=i[1]*r,n[2]=i[2]*r,n[4]=i[4]*o,n[5]=i[5]*o,n[6]=i[6]*o,n[8]=i[8]*s,n[9]=i[9]*s,n[10]=i[10]*s,this}}(),makeRotationFromEuler:function(t){t instanceof THREE.Euler==!1&&console.error("THREE.Matrix: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var e=this.elements,n=t.x,i=t.y,r=t.z,o=Math.cos(n),s=Math.sin(n),a=Math.cos(i),u=Math.sin(i),c=Math.cos(r),h=Math.sin(r);if("XYZ"===t.order){var l=o*c,f=o*h,d=s*c,m=s*h;e[0]=a*c,e[4]=-a*h,e[8]=u,e[1]=f+d*u,e[5]=l-m*u,e[9]=-s*a,e[2]=m-l*u,e[6]=d+f*u,e[10]=o*a}else if("YXZ"===t.order){var p=a*c,y=a*h,g=u*c,v=u*h;e[0]=p+v*s,e[4]=g*s-y,e[8]=o*u,e[1]=o*h,e[5]=o*c,e[9]=-s,e[2]=y*s-g,e[6]=v+p*s,e[10]=o*a}else if("ZXY"===t.order){var p=a*c,y=a*h,g=u*c,v=u*h;e[0]=p-v*s,e[4]=-o*h,e[8]=g+y*s,e[1]=y+g*s,e[5]=o*c,e[9]=v-p*s,e[2]=-o*u,e[6]=s,e[10]=o*a}else if("ZYX"===t.order){var l=o*c,f=o*h,d=s*c,m=s*h;e[0]=a*c,e[4]=d*u-f,e[8]=l*u+m,e[1]=a*h,e[5]=m*u+l,e[9]=f*u-d,e[2]=-u,e[6]=s*a,e[10]=o*a}else if("YZX"===t.order){var w=o*a,b=o*u,x=s*a,P=s*u;e[0]=a*c,e[4]=P-w*h,e[8]=x*h+b,e[1]=h,e[5]=o*c,e[9]=-s*c,e[2]=-u*c,e[6]=b*h+x,e[10]=w-P*h}else if("XZY"===t.order){var w=o*a,b=o*u,x=s*a,P=s*u;e[0]=a*c,e[4]=-h,e[8]=u*c,e[1]=w*h+P,e[5]=o*c,e[9]=b*h-x,e[2]=x*h-b,e[6]=s*c,e[10]=P*h+w}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},setRotationFromQuaternion:function(t){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(t)},makeRotationFromQuaternion:function(t){var e=this.elements,n=t.x,i=t.y,r=t.z,o=t.w,s=n+n,a=i+i,u=r+r,c=n*s,h=n*a,l=n*u,f=i*a,d=i*u,m=r*u,p=o*s,y=o*a,g=o*u;return e[0]=1-(f+m),e[4]=h-g,e[8]=l+y,e[1]=h+g,e[5]=1-(c+m),e[9]=d-p,e[2]=l-y,e[6]=d+p,e[10]=1-(c+f),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},lookAt:function(){var t,e,n;return function(i,r,o){void 0===t&&(t=new THREE.Vector3),void 0===e&&(e=new THREE.Vector3),void 0===n&&(n=new THREE.Vector3);var s=this.elements;return n.subVectors(i,r).normalize(),0===n.length()&&(n.z=1),t.crossVectors(o,n).normalize(),0===t.length()&&(n.x+=1e-4,t.crossVectors(o,n).normalize()),e.crossVectors(n,t),s[0]=t.x,s[4]=e.x,s[8]=n.x,s[1]=t.y,s[5]=e.y,s[9]=n.y,s[2]=t.z,s[6]=e.z,s[10]=n.z,this}}(),multiply:function(t,e){return void 0!==e?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(t,e)):this.multiplyMatrices(this,t)},multiplyMatrices:function(t,e){var n=t.elements,i=e.elements,r=this.elements,o=n[0],s=n[4],a=n[8],u=n[12],c=n[1],h=n[5],l=n[9],f=n[13],d=n[2],m=n[6],p=n[10],y=n[14],g=n[3],v=n[7],w=n[11],b=n[15],x=i[0],P=i[4],E=i[8],T=i[12],_=i[1],R=i[5],k=i[9],C=i[13],M=i[2],O=i[6],S=i[10],I=i[14],N=i[3],A=i[7],D=i[11],F=i[15];return r[0]=o*x+s*_+a*M+u*N,r[4]=o*P+s*R+a*O+u*A,r[8]=o*E+s*k+a*S+u*D,r[12]=o*T+s*C+a*I+u*F,r[1]=c*x+h*_+l*M+f*N,r[5]=c*P+h*R+l*O+f*A,r[9]=c*E+h*k+l*S+f*D,r[13]=c*T+h*C+l*I+f*F,r[2]=d*x+m*_+p*M+y*N,r[6]=d*P+m*R+p*O+y*A,r[10]=d*E+m*k+p*S+y*D,r[14]=d*T+m*C+p*I+y*F,r[3]=g*x+v*_+w*M+b*N,r[7]=g*P+v*R+w*O+b*A,r[11]=g*E+v*k+w*S+b*D,r[15]=g*T+v*C+w*I+b*F,this},multiplyToArray:function(t,e,n){var i=this.elements;return this.multiplyMatrices(t,e),n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=i[3],n[4]=i[4],n[5]=i[5],n[6]=i[6],n[7]=i[7],n[8]=i[8],n[9]=i[9],n[10]=i[10],n[11]=i[11],n[12]=i[12],n[13]=i[13],n[14]=i[14],n[15]=i[15],this},multiplyScalar:function(t){var e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this},multiplyVector3:function(t){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) or vector.applyProjection( matrix ) instead."),t.applyProjection(this)},multiplyVector4:function(t){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},multiplyVector3Array:function(t){return console.warn("THREE.Matrix4: .multiplyVector3Array() has been renamed. Use matrix.applyToVector3Array( array ) instead."),this.applyToVector3Array(t)},applyToVector3Array:function(){var t;return function(e,n,i){void 0===t&&(t=new THREE.Vector3),void 0===n&&(n=0),void 0===i&&(i=e.length);for(var r=0,o=n;r<i;r+=3,o+=3)t.fromArray(e,o),t.applyMatrix4(this),t.toArray(e,o);return e}}(),applyToBuffer:function(){var t;return function(e,n,i){void 0===t&&(t=new THREE.Vector3),void 0===n&&(n=0),void 0===i&&(i=e.length/e.itemSize);for(var r=0,o=n;r<i;r++,o++)t.x=e.getX(o),t.y=e.getY(o),t.z=e.getZ(o),t.applyMatrix4(this),e.setXYZ(t.x,t.y,t.z);return e}}(),rotateAxis:function(t){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),t.transformDirection(this)},crossVector:function(t){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},determinant:function(){var t=this.elements,e=t[0],n=t[4],i=t[8],r=t[12],o=t[1],s=t[5],a=t[9],u=t[13],c=t[2],h=t[6],l=t[10],f=t[14],d=t[3],m=t[7],p=t[11],y=t[15];return d*(+r*a*h-i*u*h-r*s*l+n*u*l+i*s*f-n*a*f)+m*(+e*a*f-e*u*l+r*o*l-i*o*f+i*u*c-r*a*c)+p*(+e*u*h-e*s*f-r*o*h+n*o*f+r*s*c-n*u*c)+y*(-i*s*c-e*a*h+e*s*l+i*o*h-n*o*l+n*a*c)},transpose:function(){var t,e=this.elements;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},flattenToArrayOffset:function(t,e){var n=this.elements;return t[e]=n[0],t[e+1]=n[1],t[e+2]=n[2],t[e+3]=n[3],t[e+4]=n[4],t[e+5]=n[5],t[e+6]=n[6],t[e+7]=n[7],t[e+8]=n[8],t[e+9]=n[9],t[e+10]=n[10],t[e+11]=n[11],t[e+12]=n[12],t[e+13]=n[13],t[e+14]=n[14],t[e+15]=n[15],t},getPosition:function(){var t;return function(){void 0===t&&(t=new THREE.Vector3),console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead.");var e=this.elements;return t.set(e[12],e[13],e[14])}}(),setPosition:function(t){var e=this.elements;return e[12]=t.x,e[13]=t.y,e[14]=t.z,this},getInverse:function(t,e){var n=this.elements,i=t.elements,r=i[0],o=i[4],s=i[8],a=i[12],u=i[1],c=i[5],h=i[9],l=i[13],f=i[2],d=i[6],m=i[10],p=i[14],y=i[3],g=i[7],v=i[11],w=i[15];n[0]=h*p*g-l*m*g+l*d*v-c*p*v-h*d*w+c*m*w,n[4]=a*m*g-s*p*g-a*d*v+o*p*v+s*d*w-o*m*w,n[8]=s*l*g-a*h*g+a*c*v-o*l*v-s*c*w+o*h*w,n[12]=a*h*d-s*l*d-a*c*m+o*l*m+s*c*p-o*h*p,n[1]=l*m*y-h*p*y-l*f*v+u*p*v+h*f*w-u*m*w,n[5]=s*p*y-a*m*y+a*f*v-r*p*v-s*f*w+r*m*w,n[9]=a*h*y-s*l*y-a*u*v+r*l*v+s*u*w-r*h*w,n[13]=s*l*f-a*h*f+a*u*m-r*l*m-s*u*p+r*h*p,n[2]=c*p*y-l*d*y+l*f*g-u*p*g-c*f*w+u*d*w,n[6]=a*d*y-o*p*y-a*f*g+r*p*g+o*f*w-r*d*w,n[10]=o*l*y-a*c*y+a*u*g-r*l*g-o*u*w+r*c*w,n[14]=a*c*f-o*l*f-a*u*d+r*l*d+o*u*p-r*c*p,n[3]=h*d*y-c*m*y-h*f*g+u*m*g+c*f*v-u*d*v,n[7]=o*m*y-s*d*y+s*f*g-r*m*g-o*f*v+r*d*v,n[11]=s*c*y-o*h*y-s*u*g+r*h*g+o*u*v-r*c*v,n[15]=o*h*f-s*c*f+s*u*d-r*h*d-o*u*m+r*c*m;var b=r*n[0]+u*n[4]+f*n[8]+y*n[12];if(0===b){var x="THREE.Matrix4.getInverse(): can't invert matrix, determinant is 0";if(e)throw new Error(x);return console.warn(x),this.identity(),this}return this.multiplyScalar(1/b),this},translate:function(t){console.error("THREE.Matrix4: .translate() has been removed.")},rotateX:function(t){console.error("THREE.Matrix4: .rotateX() has been removed.")},rotateY:function(t){console.error("THREE.Matrix4: .rotateY() has been removed.")},rotateZ:function(t){console.error("THREE.Matrix4: .rotateZ() has been removed.")},rotateByAxis:function(t,e){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")},scale:function(t){var e=this.elements,n=t.x,i=t.y,r=t.z;return e[0]*=n,e[4]*=i,e[8]*=r,e[1]*=n,e[5]*=i,e[9]*=r,e[2]*=n,e[6]*=i,e[10]*=r,e[3]*=n,e[7]*=i,e[11]*=r,this},getMaxScaleOnAxis:function(){var t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],n=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],i=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,Math.max(n,i)))},makeTranslation:function(t,e,n){return this.set(1,0,0,t,0,1,0,e,0,0,1,n,0,0,0,1),this},makeRotationX:function(t){var e=Math.cos(t),n=Math.sin(t);return this.set(1,0,0,0,0,e,-n,0,0,n,e,0,0,0,0,1),this},makeRotationY:function(t){var e=Math.cos(t),n=Math.sin(t);return this.set(e,0,n,0,0,1,0,0,-n,0,e,0,0,0,0,1),this},makeRotationZ:function(t){var e=Math.cos(t),n=Math.sin(t);return this.set(e,-n,0,0,n,e,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(t,e){var n=Math.cos(e),i=Math.sin(e),r=1-n,o=t.x,s=t.y,a=t.z,u=r*o,c=r*s;return this.set(u*o+n,u*s-i*a,u*a+i*s,0,u*s+i*a,c*s+n,c*a-i*o,0,u*a-i*s,c*a+i*o,r*a*a+n,0,0,0,0,1),this},makeScale:function(t,e,n){return this.set(t,0,0,0,0,e,0,0,0,0,n,0,0,0,0,1),this},compose:function(t,e,n){return this.makeRotationFromQuaternion(e),this.scale(n),this.setPosition(t),this},decompose:function(){var t,e;return function(n,i,r){void 0===t&&(t=new THREE.Vector3),void 0===e&&(e=new THREE.Matrix4);var o=this.elements,s=t.set(o[0],o[1],o[2]).length(),a=t.set(o[4],o[5],o[6]).length(),u=t.set(o[8],o[9],o[10]).length(),c=this.determinant();c<0&&(s=-s),n.x=o[12],n.y=o[13],n.z=o[14],e.elements.set(this.elements);var h=1/s,l=1/a,f=1/u;return e.elements[0]*=h,e.elements[1]*=h,e.elements[2]*=h,e.elements[4]*=l,e.elements[5]*=l,e.elements[6]*=l,e.elements[8]*=f,e.elements[9]*=f,e.elements[10]*=f,i.setFromRotationMatrix(e),r.x=s,r.y=a,r.z=u,this}}(),makeFrustum:function(t,e,n,i,r,o){var s=this.elements,a=2*r/(e-t),u=2*r/(i-n),c=(e+t)/(e-t),h=(i+n)/(i-n),l=-(o+r)/(o-r),f=-2*o*r/(o-r);return s[0]=a,s[4]=0,s[8]=c,s[12]=0,s[1]=0,s[5]=u,s[9]=h,s[13]=0,s[2]=0,s[6]=0,s[10]=l,s[14]=f,s[3]=0,s[7]=0,s[11]=-1,s[15]=0,this},makePerspective:function(t,e,n,i){var r=n*Math.tan(THREE.Math.degToRad(.5*t)),o=-r,s=o*e,a=r*e;return this.makeFrustum(s,a,o,r,n,i)},makeOrthographic:function(t,e,n,i,r,o){var s=this.elements,a=e-t,u=n-i,c=o-r,h=(e+t)/a,l=(n+i)/u,f=(o+r)/c;return s[0]=2/a,s[4]=0,s[8]=0,s[12]=-h,s[1]=0,s[5]=2/u,s[9]=0,s[13]=-l,s[2]=0,s[6]=0,s[10]=-2/c,s[14]=-f,s[3]=0,s[7]=0,s[11]=0,s[15]=1,this},equals:function(t){for(var e=this.elements,n=t.elements,i=0;i<16;i++)if(e[i]!==n[i])return!1;return!0},fromArray:function(t){return this.elements.set(t),this},toArray:function(){var t=this.elements;return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]}},THREE.Math={generateUUID:function(){var t,e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),n=new Array(36),i=0;return function(){for(var r=0;r<36;r++)8===r||13===r||18===r||23===r?n[r]="-":14===r?n[r]="4":(i<=2&&(i=33554432+16777216*Math.random()|0),t=15&i,i>>=4,n[r]=e[19===r?3&t|8:t]);return n.join("")}}(),clamp:function(t,e,n){return t<e?e:t>n?n:t},clampBottom:function(t,e){return t<e?e:t},euclideanModulo:function(t,e){return(t%e+e)%e},mapLinear:function(t,e,n,i,r){return i+(t-e)*(r-i)/(n-e)},smoothstep:function(t,e,n){return t<=e?0:t>=n?1:(t=(t-e)/(n-e),t*t*(3-2*t))},smootherstep:function(t,e,n){return t<=e?0:t>=n?1:(t=(t-e)/(n-e),t*t*t*(t*(6*t-15)+10))},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},degToRad:function(){var t=Math.PI/180;return function(e){return e*t}}(),radToDeg:function(){var t=180/Math.PI;return function(e){return e*t}}(),isPowerOfTwo:function(t){return 0===(t&t-1)&&0!==t},nextPowerOfTwo:function(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,t++,t}})}(),this.objectIDs=[],this.objects={},this.geometryCache={},this.a=new THREE.Vector3,this.b=new THREE.Vector3,this.c=new THREE.Vector3,this.d=new THREE.Vector3,this.from=new THREE.Vector3,this.to=new THREE.Vector3,this.m=new THREE.Matrix4,this.listeners={hit:[]},this.ready=!0}t.prototype.addEventListener=function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)},t.prototype._emit=emit,t.prototype._transform=function(t,e){return e.clone().applyMatrix4(t.matrix)},t.prototype._getVerts=function(t){for(var e=[],n=this.geometryCache[t.geomID],i=n.vertices,r=0;r<i.length;++r)e[r]=this._transform(t,i[r]);return e},t.prototype.setObject=function(t){this.objectIDs.push(t.uuid),this.objects[t.uuid]=t,t.matrix=(new THREE.Matrix4).fromArray(t.matrix);var e=t.geometry.uvs,n=Number.MAX_VALUE,i=Number.MAX_VALUE,r=Number.MIN_VALUE,o=Number.MIN_VALUE;if(e&&e.length>0)for(var s=0;s<e.length;++s){var a=e[s];if(a){var u=a[0],c=a[1];n=Math.min(n,u),r=Math.max(r,u),i=Math.min(i,c),o=Math.max(o,c)}}else n=0,r=1,i=0,o=1;if(this.setProperty(t.uuid,"minU",n),this.setProperty(t.uuid,"maxU",r),this.setProperty(t.uuid,"minV",i),this.setProperty(t.uuid,"maxV",o),this.setProperty(t.uuid,"geomID",t.geometry.uuid),!this.geometryCache[t.geometry.uuid]){this.geometryCache[t.geometry.uuid]=t.geometry;for(var h=0,l=t.geometry.vertices,f=l.length;h<f;++h)l[h]=(new THREE.Vector3).fromArray(l[h])}this.updateObjects([t])},t.prototype.updateObjects=function(t){for(var e=0;e<t.length;++e){var n=t[e];if(n.inScene!==!1){var i=this.objects[n.uuid];null!==n.matrix&&i.matrix.fromArray(n.matrix),null!==n.visible&&this.setProperty(n.uuid,"visible",n.visible),null!==n.disabled&&this.setProperty(n.uuid,"disabled",n.disabled)}else{delete this.objects[n.uuid];for(var r=!1,o=0;!r&&o<this.objectIDs.length;++o){var s=this.objects[this.objectIDs[o]];r=r||s&&s.geomID===n.geomID}r||delete this.geometryCache[n.geomID],this.objectIDs.splice(this.objectIDs.indexOf(n.uuid),1)}}},t.prototype.setProperty=function(t,e,n){for(var i=this.objects[t],r=e.split(".");r.length>1;)e=r.shift(),i[e]||(i[e]={}),i=i[e];1===r.length&&(e=r[0],i[r[0]]=n)},t.prototype.projectPointers=function(t){for(var e={},n=0;n<t.length;++n){var i=t[n],r=i[0],o=i[1],s=i[2],a=null;this.from.fromArray(o),this.to.fromArray(s);for(var u=0;u<this.objectIDs.length;++u){var c=this.objectIDs[u],h=this.objects[c];if(!h.disabled)for(var l=this._getVerts(h),f=h.geometry.faces,d=h.geometry.uvs,m=0;m<f.length;++m){var p=f[m],y=l[p[0]%l.length],g=l[p[1]%l.length],v=l[p[2]%l.length];if(this.a.subVectors(g,y),this.b.subVectors(v,y),this.c.subVectors(this.to,this.from),this.m.set(this.a.x,this.b.x,-this.c.x,0,this.a.y,this.b.y,-this.c.y,0,this.a.z,this.b.z,-this.c.z,0,0,0,0,1),Math.abs(this.m.determinant())>1e-10&&(this.m.getInverse(this.m),this.d.subVectors(this.from,y).applyMatrix4(this.m),0<=this.d.x&&this.d.x<=1&&0<=this.d.y&&this.d.y<=1&&this.d.z>0)){this.c.multiplyScalar(this.d.z).add(this.from);var w=Math.sign(this.d.z)*this.to.distanceTo(this.c);if((!a||w<a.distance)&&(a={name:r,objectID:c,distance:w,faceIndex:m,facePoint:this.c.toArray(),faceNormal:this.d.toArray()},d)){y=d[p[0]%d.length],g=d[p[1]%d.length],v=d[p[2]%d.length];var b=this.d.x*(g[0]-y[0])+this.d.y*(v[0]-y[0])+y[0],x=this.d.x*(g[1]-y[1])+this.d.y*(v[1]-y[1])+y[1];h.minU<=b&&b<=h.maxU&&h.minV<=x&&x<h.maxV?a.point=[b,x]:a=null}}}}a&&(e[r]=a)}this._emit("hit",e)},window.Primrose.Projector=t}(),function(){"use strict";var t={};window.Primrose.Random=t}(),function(){"use strict";var t=["#FFDFC4","#F0D5BE","#EECEB3","#E1B899","#E5C298","#FFDCB2","#E5B887","#E5A073","#E79E6D","#DB9065","#CE967C","#C67856","#BA6C49","#A57257","#F0C8C9","#DDA8A0","#B97C6D","#A8756C","#AD6452","#5C3836","#CB8442","#BD723C","#704139","#A3866A","#870400","#710101","#430000","#5B0001","#302E2E"];window.Primrose.SKINS=t}(),function(){"use strict";var t=Primrose.SKINS.map(function(t){return parseInt(t.substring(1),16)});window.Primrose.SKINS_VALUES=t}(),function(){"use strict";var t="-apple-system, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif";window.Primrose.SYS_FONTS=t}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},r=function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,i)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(i)},o=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),s=0,a=function(a){function u(n){t(this,u);var r=e(this,Object.getPrototypeOf(u).call(this));if(r.options=patch(n,{id:"Primrose.Surface["+s++ +"]",bounds:new Primrose.Text.Rectangle}),r.listeners.move=[],r.bounds=r.options.bounds,r.canvas=null,r.context=null,r._opacity=1,r.style={},Object.defineProperties(r.style,{width:{get:function(){return r.bounds.width},set:function(t){r.bounds.width=t,r.resize()}},height:{get:function(){return r.bounds.height},set:function(t){r.bounds.height=t,r.resize()}},left:{get:function(){return r.bounds.left},set:function(t){r.bounds.left=t}},top:{get:function(){return r.bounds.top},set:function(t){r.bounds.top=t}},opacity:{get:function(){return r._opacity},set:function(t){r._opacity=t}},fontSize:{get:function(){return r.fontSize},set:function(t){r.fontSize=t}},backgroundColor:{get:function(){return r.backgroundColor},set:function(t){r.backgroundColor=t}},color:{get:function(){return r.color},set:function(t){r.color=t}}}),r.options.id instanceof u)throw new Error("Object is already a Surface. Please don't try to wrap them.");if(r.options.id instanceof CanvasRenderingContext2D?(r.context=r.options.id,r.canvas=r.context.canvas):r.options.id instanceof HTMLCanvasElement?r.canvas=r.options.id:("string"==typeof r.options.id||r.options.id instanceof String)&&(r.canvas=document.getElementById(r.options.id),null===r.canvas?(r.canvas=document.createElement("canvas"),r.canvas.id=r.options.id):"CANVAS"!==r.canvas.tagName&&(r.canvas=null)),null===r.canvas)throw console.error(i(r.options.id)),console.error(r.options.id),new Error(r.options.id+" does not refer to a valid canvas element.");return r.id=r.canvas.id,0===r.bounds.width&&(r.bounds.width=r.imageWidth,r.bounds.height=r.imageHeight),r.imageWidth=r.bounds.width,r.imageHeight=r.bounds.height,null===r.context&&(r.context=r.canvas.getContext("2d")),r.canvas.style.imageRendering=isChrome?"pixelated":"optimizespeed",r.context.imageSmoothingEnabled=!1,r.context.textBaseline="top",r._texture=null,r._material=null,r}return n(u,a),o(u,null,[{key:"create",value:function(){return new u}}]),o(u,[{key:"addToBrowserEnvironment",value:function(t,e){var n="shell"===this.className?shell(3,10,10):quad(2,2),i=textured(n,this,{opacity:this._opacity});return e.add(i),t.registerPickableObject(i),i}},{key:"invalidate",value:function(t){t?t instanceof Primrose.Text.Rectangle&&(t=t.clone()):(t=this.bounds.clone(),t.left=0,t.top=0);for(var e=0;e<this.children.length;++e){var n=this.children[e],i=t.overlap(n.bounds);if(i){var r=i.left-n.bounds.left,o=i.top-n.bounds.top;this.context.drawImage(n.canvas,r,o,i.width,i.height,i.x,i.y,i.width,i.height)}}this._texture&&(this._texture.needsUpdate=!0),this._material&&(this._material.needsUpdate=!0),this.parent&&this.parent.invalidate&&(t.left+=this.bounds.left,t.top+=this.bounds.top,this.parent.invalidate(t))}},{key:"render",value:function(){this.invalidate()}},{key:"resize",value:function(){this.setSize(this.surfaceWidth,this.surfaceHeight)}},{key:"setSize",value:function(t,e){var n=this.context.textBaseline,i=this.context.textAlign;this.imageWidth=t,this.imageHeight=e,this.context.textBaseline=n,this.context.textAlign=i}},{key:"appendChild",value:function(t){if(!(t instanceof u))throw new Error("Can only append other Surfaces to a Surface. You gave: "+t);r(Object.getPrototypeOf(u.prototype),"appendChild",this).call(this,t),this.invalidate()}},{key:"mapUV",value:function(t){return{x:t[0]*this.imageWidth,y:(1-t[1])*this.imageHeight}}},{key:"unmapUV",value:function(t){return[t.x/this.imageWidth,1-t.y/this.imageHeight]}},{key:"_findChild",value:function(t,e,n){for(var i=this.inBounds(t,e),r=null,o=this.children.length-1;o>=0;--o){var s=this.children[o];!r&&s.inBounds(t-this.bounds.left,e-this.bounds.top)?r=s:s.focused&&s.blur()}return r||i&&this}},{key:"DOMInBounds",value:function(t,e){return this.inBounds(t*devicePixelRatio,e*devicePixelRatio)}},{key:"UVInBounds",value:function(t){return this.inBounds(t[0]*this.imageWidth,(1-t[1])*this.imageHeight)}},{key:"inBounds",value:function(t,e){return this.bounds.left<=t&&t<this.bounds.right&&this.bounds.top<=e&&e<this.bounds.bottom}},{key:"startDOMPointer",value:function(t){this.startPointer(x*devicePixelRatio,y*devicePixelRatio)}},{key:"moveDOMPointer",value:function(t){this.movePointer(x*devicePixelRatio,y*devicePixelRatio)}},{key:"startPointer",value:function(t,e){if(this.inBounds(t,e)){var n=this._findChild(t,e,function(t,e,n){return t.startPointer(e,n)});n?(this.focused||this.focus(),emit.call(this,"click",{target:n,x:t,y:e}),n!==this&&n.startPointer(t-this.bounds.left,e-this.bounds.top)):this.focused&&this.blur()}}},{key:"movePointer",value:function(t,e){var n=this._findChild(t,e,function(t,e,n){return t.startPointer(e,n)});n&&(emit.call(this,"move",{target:n,x:t,y:e}),n!==this&&n.movePointer(t-this.bounds.left,e-this.bounds.top))}},{key:"startUV",value:function(t){var e=this.mapUV(t);this.startPointer(e.x,e.y)}},{key:"moveUV",value:function(t){var e=this.mapUV(t);this.movePointer(e.x,e.y)}},{key:"imageWidth",get:function(){return this.canvas.width},set:function(t){this.canvas.width=t,this.bounds.width=t}},{key:"imageHeight",get:function(){return this.canvas.height},set:function(t){this.canvas.height=t,this.bounds.height=t}},{key:"elementWidth",get:function(){return this.canvas.clientWidth*devicePixelRatio},set:function(t){this.canvas.style.width=t/devicePixelRatio+"px"}},{key:"elementHeight",get:function(){return this.canvas.clientHeight*devicePixelRatio},set:function(t){this.canvas.style.height=t/devicePixelRatio+"px"}},{key:"surfaceWidth",get:function(){return this.canvas.parentElement?this.elementWidth:this.bounds.width}},{key:"surfaceHeight",get:function(){return this.canvas.parentElement?this.elementHeight:this.bounds.height}},{key:"resized",get:function(){return this.imageWidth!==this.surfaceWidth||this.imageHeight!==this.surfaceHeight}},{key:"texture",get:function(){return this._texture||(this._texture=new THREE.Texture(this.canvas)),this._texture}}]),u}(Primrose.Entity);window.Primrose.Surface=a}(),function(){"use strict";var t={};window.Primrose.Text=t}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t){for(var e=t.getMilliseconds().toString();e.length<3;)e="0"+e;return t.toLocaleTimeString().replace(/(\d+:\d+:\d+)/,function(t,n){return n+"."+e})}var n=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();window.RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,window.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate,window.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription;var i=[{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"}],r=0,o=function(){function o(n,s,a,u,c,h,l){var f=this;t(this,o);var d=0,m=++r,p=function(t,n,i){if(n<d){for(var o=new Date,s=["[%s:%s %s] "+i,r,m,e(o)],a=3;a<arguments.length;++a)s.push(arguments[a]);console[t].apply(console,s)}return arguments[3]};this._log=p.bind(null,"log"),this._error=p.bind(null,"error",0),Object.defineProperty(this,"proxyServer",{get:function(){return s}}),Object.defineProperty(this,"fromUserName",{get:function(){return a}}),Object.defineProperty(this,"fromUserIndex",{get:function(){return u}}),Object.defineProperty(this,"toUserName",{get:function(){return c}}),Object.defineProperty(this,"toUserIndex",{get:function(){return h}});var y=i.concat(n);isFirefox&&(y=[{urls:y.map(function(t){return t.url})}]),this._log(1,y);var g=new RTCPeerConnection({iceServers:y});Object.defineProperty(this,"rtc",{get:function(){return g}});var v={offer:{created:!1,received:!1},answer:{created:!1,recieved:!1}};Object.defineProperty(this,"progress",{get:function(){return v}}),Object.defineProperty(this,"goFirst",{get:function(){return!l}}),window.addEventListener("unload",this.close.bind(this)),this.ready=new Promise(function(t,e){var n=function(){f._log(2,"Tearing down event handlers"),f.proxyServer.off("peer",c),f.proxyServer.off("offer",a),f.proxyServer.off("ice",u),f.proxyServer.off("answer",r),f.rtc.onsignalingstatechange=null,f.rtc.oniceconnectionstatechange=null,f.rtc.onnegotiationneeded=null,f.rtc.onicecandidate=null,f.teardown()},i=function(e){return f.complete&&(n(),t()),e},r=function(t){if(f._log(1,"description",t),f.isExpected(t.item.type,t))return f.recordProgress(t.item,"received"),f.rtc.setRemoteDescription(new RTCSessionDescription(t.item)).then(i).catch(s)},o=function(t){return f.recordProgress(t,"created"),f.rtc.setLocalDescription(t).then(function(){return f.proxyServer.emit(t.type,f.wrap(t))}).then(i).catch(s)},s=function(t){f._error(t),n(),e(t)},a=function(t){f._log(1,"offer",t);var e=r(t);if(e)return e.then(function(){return f.rtc.createAnswer()}).then(o)},u=function(t){if(f._log(1,"ice",t),f.isExpected("ice",t)){var e=new RTCIceCandidate(t.item);return f.rtc.addIceCandidate(e).catch(f._error)}},c=function(t){f.isExpected("new user",t)&&(f.proxyServer.on("answer",r),f.proxyServer.on("offer",a),f.proxyServer.on("ice",u),f.rtc.onsignalingstatechange=function(t){return f._log(1,"[%s] Signal State: %s",m,f.rtc.signalingState)},f.rtc.oniceconnectionstatechange=function(t){return f._log(1,"[%s] ICE Connection/Gathering State: %s/%s",m,f.rtc.iceConnectionState,f.rtc.iceGatheringState)},f.rtc.onnegotiationneeded=function(t){return f.createOffer().then(o)},f.rtc.onicecandidate=function(t){t.candidate&&f.proxyServer.emit("ice",f.wrap(t.candidate))},f.issueRequest())};f.proxyServer.on("peer",c),setTimeout(function(){return f.proxyServer.emit("peer",f.wrap())},250)})}return n(o,[{key:"createOffer",value:function(){return this.rtc.createOffer()}},{key:"recordProgress",value:function(t,e){this.progress[t.type][e]=!0}},{key:"wrap",value:function(t){return{fromUserName:this.fromUserName,fromUserIndex:this.fromUserIndex,toUserName:this.toUserName,toUserIndex:this.toUserIndex,item:t}}},{key:"isExpected",value:function t(e,n){var i=!this.complete,r=n.fromUserName===this.toUserName,o=n.fromUserIndex===this.toUserIndex,s=n.toUserName===this.fromUserName,a=n.toUserIndex===this.fromUserIndex,t=i&&r&&o&&s&&a;return this._log(1,"[%s->%s] I %s || FROM %s==%s (%s), %s==%s (%s) || TO %s==%s (%s), %s==%s (%s)",e,t,i,n.fromUserName,this.toUserName,r,n.fromUserIndex,this.toUserIndex,o,n.toUserName,this.fromUserName,s,n.toUserIndex,this.fromUserIndex,a),this._log(2,n),t}},{key:"close",value:function(){"closed"!==this.rtc.signalingState&&this.rtc.close()}},{key:"teardown",value:function(){throw new Error("Not implemented.")}},{key:"issueRequest",value:function(){throw new Error("Not implemented")}},{key:"complete",get:function(){return!this.rtc||"closed"===this.rtc.signalingState}}]),o}();window.Primrose.WebRTCSocket=o}(),function(){"use strict";function t(e){var n,i=this,r=e.toString(),o=r.match(/function\s+(\w+)\s*\(/),s=o[1];for(n in e.prototype)r+="\n\n"+s+".prototype."+n+" = "+e.prototype[n].toString()+";";r+="\n\n(function(){\n  var instance = new "+s+"(true);",r+="\n  if(instance.addEventListener){\n    self.args = [null, null];\n    for(var k in instance.listeners) {\n      instance.addEventListener(k, function(eventName, args){\n        self.args[0] = eventName;\n        self.args[1] = args;\n        postMessage(self.args);\n      }.bind(this, k));\n    }\n  }",
r+="\n\n  onmessage = function(evt){\n    var f = evt.data[0],\n        t = instance[f];\n    if(t){\n      t.call(instance, evt.data[1]);\n    }\n  };\n\n})();",this.worker=t.createWorker(r,!1),this.args=[null,null],this.listeners={},this.worker.onmessage=function(t){return emit.call(i,t.data[0],t.data[1])};for(n in e.prototype)"addEventListener"!==n&&"_"!==n[0]&&(this[n]=this.methodShim.bind(this,n));this.ready=!0}t.prototype.methodShim=function(t,e){this.args[0]=t,this.args[1]=e,this.worker.postMessage(this.args)},t.prototype.addEventListener=function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)},t.createWorker=function(t,e){if("function"==typeof t&&(t=t.toString()),e){t=t.trim();var n=t.indexOf("{");t=t.substring(n+1,t.length-1)}var i=new Blob([t],{type:"text/javascript"}),r=URL.createObjectURL(i);return new Worker(r)},window.Primrose.Workerize=t}(),function(){"use strict";var t={};window.Primrose.X=t}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=0,o=function(o){function s(n){t(this,s);var i=e(this,Object.getPrototypeOf(s).call(this,patch(n,{id:"Primrose.Controls.AbstractLabel["+r++ +"]"})));return i._lastFont=null,i._lastText=null,i._lastCharacterWidth=null,i._lastCharacterHeight=null,i._lastPadding=null,i._lastWidth=-1,i._lastHeight=-1,i._lastTextAlign=null,i.textAlign=i.options.textAlign,i.character=new Primrose.Text.Size,i.theme=i.options.theme,i.fontSize=i.options.fontSize||16,i.refreshCharacter(),i.backgroundColor=i.options.backgroundColor||i.theme.regular.backColor,i.color=i.options.color||i.theme.regular.foreColor,i.value=i.options.value,i}return n(s,o),i(s,[{key:"refreshCharacter",value:function(){this.character.height=this.fontSize,this.context.font=this.character.height+"px "+this.theme.fontFamily,this.character.width=this.context.measureText("MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM").width/100}},{key:"_isChanged",value:function(){var t=this._lastText!==this.value,e=this.character.width!==this._lastCharacterWidth,n=this.character.height!==this._lastCharacterHeight,i=this.context.font!==this._lastFont,r=this.textAlign!==this._lastTextAlign,o=this.resized||t||e||n||this.resized||i||r;return o}},{key:"render",value:function(){if(this.resized&&this.resize(),this.theme&&this._isChanged){this._lastText=this.value,this._lastCharacterWidth=this.character.width,this._lastCharacterHeight=this.character.height,this._lastWidth=this.imageWidth,this._lastHeight=this.imageHeight,this._lastFont=this.context.font,this._lastTextAlign=this.textAlign,this.context.textAlign=this.textAlign||"left";var t=this.backgroundColor?"fillRect":"clearRect";if(this.theme.regular.backColor&&(this.context.fillStyle=this.backgroundColor),this.context[t](0,0,this.imageWidth,this.imageHeight),this.value)for(var e=this.value.split("\n"),n=0;n<e.length;++n){var i=e[n],r=(this.imageHeight-e.length*this.character.height)/2+n*this.character.height,o=null;switch(this.textAlign){case"right":o=this.imageWidth;break;case"center":o=this.imageWidth/2;break;default:o=0}var s=(this.theme.regular.fontWeight||"")+" "+(this.theme.regular.fontStyle||"")+" "+this.character.height+"px "+this.theme.fontFamily;this.context.font=s.trim(),this.context.fillStyle=this.color,this.context.fillText(i,o,r)}this.renderCanvasTrim(),this.invalidate()}}},{key:"renderCanvasTrim",value:function(){}},{key:"textAlign",get:function(){return this.context.textAlign},set:function(t){this.context.textAlign=t,this.render()}},{key:"value",get:function(){return this._value},set:function(t){t=t||"",this._value=t.replace(/\r\n/g,"\n"),this.render()}},{key:"theme",get:function(){return this._theme},set:function(t){this._theme=clone(t||Primrose.Text.Themes.Default),this._theme.fontSize=this.fontSize,this.refreshCharacter(),this.render()}}]),s}(Primrose.Surface);window.Primrose.Controls.AbstractLabel=o}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,i)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(i)},r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),o=0,s=function(s){function a(n){t(this,a);var i=e(this,Object.getPrototypeOf(a).call(this,patch(n,{id:"Primrose.Controls.Button2D["+o++ +"]",textAlign:"center"})));return i._lastActivated=null,i}return n(a,s),r(a,null,[{key:"create",value:function(){return new a}}]),r(a,[{key:"addToBrowserEnvironment",value:function(t,e){var n=t.buttonFactory.create();return n.listeners=this.listeners,t.appendChild(n)}},{key:"startPointer",value:function(t,e){this.focus(),this._activated=!0,this.render()}},{key:"endPointer",value:function(){this._activated&&(this._activated=!1,emit.call(this,"click",{target:this}),this.render())}},{key:"_isChanged",value:function(){var t=this._activated!==this._lastActivated,e=i(Object.getPrototypeOf(a.prototype),"_isChanged",this)||t;return e}},{key:"renderCanvasTrim",value:function(){this.context.lineWidth=this._activated?4:2,this.context.strokeStyle=this.theme.regular.foreColor||Primrose.Text.Themes.Default.regular.foreColor,this.context.strokeRect(0,0,this.imageWidth,this.imageHeight)}}]),a}(Primrose.Controls.AbstractLabel);window.Primrose.Controls.Button2D=s}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=function(r){function o(n,i,r){t(this,o);var s=e(this,Object.getPrototypeOf(o).call(this));return r=patch(r,o),r.minDeflection=Math.cos(r.minDeflection),r.colorUnpressed=new THREE.Color(r.colorUnpressed),r.colorPressed=new THREE.Color(r.colorPressed),s.listeners.click=[],s.listeners.release=[],s.base=n.children[1],s.cap=n.children[0],s.cap.name=i,s.cap.material=s.cap.material.clone(),s.cap.button=s,s.cap.base=s.base,s.container=new THREE.Object3D,s.container.add(s.base),s.container.add(s.cap),s.color=s.cap.material.color,s.name=i,s.element=null,s.startUV=function(){this.color.copy(r.colorPressed),this.element?this.element.click():emit.call(this,"click")},s.moveUV=function(){},s.endPointer=function(){this.color.copy(r.colorUnpressed),emit.call(this,"release")},s}return n(o,r),i(o,[{key:"addToBrowserEnvironment",value:function(t,e){return e.add(this.container),t.registerPickableObject(this.cap),this.container}},{key:"position",get:function(){return this.container.position}}]),o}(Primrose.BaseControl);r.DEFAULTS={maxThrow:.1,minDeflection:10,colorUnpressed:8323072,colorPressed:32512,toggle:!0},window.Primrose.Controls.Button3D=r}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=0,o=function(o){function s(n){t(this,s);var i=e(this,Object.getPrototypeOf(s).call(this,patch(n,{id:"Primrose.Controls.Form["+r++ +"]"})));return i._mesh=textured(quad(1,i.bounds.height/i.bounds.width),i),i._mesh.name=i.id+"-mesh",Object.defineProperties(i.style,{display:{get:function(){return i._mesh.visible?"":"none"},set:function(t){"none"===t?i.hide():i.show()}},visible:{get:function(){return i._mesh.visible?"":"hidden"},set:function(t){return i.visible="hidden"!==t}}}),i}return n(s,o),i(s,null,[{key:"create",value:function(){return new s}}]),i(s,[{key:"addToBrowserEnvironment",value:function(t,e){return e.add(this._mesh),t.registerPickableObject(this._mesh),this._mesh}},{key:"hide",value:function(){this.visible=!1,this.disabled=!0}},{key:"show",value:function(){this.visible=!0,this.disabled=!1}},{key:"position",get:function(){return this._mesh.position}},{key:"visible",get:function(){return this._mesh.visible},set:function(t){this._mesh.visible=t}},{key:"disabled",get:function(){return this._mesh.disabled},set:function(t){this._mesh.disabled=t}},{key:"enabled",get:function(){return!this.disabled},set:function(t){this.disabled=!t}}]),s}(Primrose.Surface);window.Primrose.Controls.Form=o}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=0,o=function(o){function s(n){t(this,s);var i=e(this,Object.getPrototypeOf(s).call(this,patch(n,{id:"Primrose.Controls.HtmlDoc["+r++ +"]"})));return"string"==typeof n?i.options={element:i.options}:i.options=n||{},i._lastImage=null,i._image=null,i.element=i.options.element,i}return n(s,o),i(s,null,[{key:"create",value:function(){return new s}}]),i(s,[{key:"addToBrowserEnvironment",value:function(t,e){var n=textured(quad(2,2),this);return e.add(n),t.registerPickableObject(n),n}},{key:"_render",value:function(){var t=this;html2canvas(this._element,{onrendered:function(e){t._image=e,t.setSize(e.width,e.height),t.render()}})}},{key:"render",value:function(){this._image!==this._lastImage&&(this._lastImage=this._image,this.context.fillStyle="white",this.context.fillRect(0,0,this.imageWidth,this.imageHeight),this.context.drawImage(this._image,0,0),this.invalidate())}},{key:"element",get:function(){return this._element},set:function(t){t&&(this._element=Primrose.DOM.cascadeElement(t,"DIV",HTMLDivElement),this._element.style.position="absolute",this._element.style.display="",this._element.style.width=this.bounds.width+"px",this._element.style.height=this.bounds.height+"px",document.body.appendChild(Primrose.DOM.makeHidingContainer(this.id+"-hider",this._element)),this._render())}},{key:"value",get:function(){return this._element.innerHTML},set:function(t){t!==this._element.innerHTML&&(this._element.innerHTML=t,this._render())}}]),s}(Primrose.Surface);window.Primrose.Controls.HtmlDoc=o}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=0,o=window.Image,s={},a=function(a){function u(n){t(this,u),n=n||{},"string"==typeof n&&(n={value:n});var i=e(this,Object.getPrototypeOf(u).call(this,patch(n,{id:"Primrose.Controls.Image["+r++ +"]",bounds:new Primrose.Text.Rectangle(0,0,1,1)})));return i.listeners.load=[],i._lastWidth=-1,i._lastHeight=-1,i._lastImage=null,i._images=[],i._currentImageIndex=0,i.className="",setTimeout(function(){n.value&&(/\.stereo\./.test(n.value)?i.loadStereoImage(n.value):i.loadImage(n.value))}),i}return n(u,a),i(u,null,[{key:"create",value:function(){return new u}}]),i(u,[{key:"addToBrowserEnvironment",value:function(t,e){var n=textured(quad(.5,.5*this.imageHeight/this.imageWidth),this);return e.add(n),t.registerPickableObject(n),n}},{key:"loadImage",value:function(t,e){var n=this;return"number"==typeof t||t instanceof Number||(e=t,t=0),new Promise(function(t,n){if(s[e])t(s[e]);else if(e){var i=new o;i.addEventListener("load",function(){s[e]=i,t(s[e])},!1),i.addEventListener("error",function(){n("error loading image")},!1),i.src=e}else n("Image was null")}).then(function(e){return n.setImage(t,e),e}).catch(function(i){console.error("Failed to load image "+e),console.error(i),n.setImage(t,null)})}},{key:"loadStereoImage",value:function(t){var e=this;return this.loadImage(t).then(function(t){var n=new Primrose.Text.Rectangle(0,0,t.width/2,t.height),i=new Primrose.Surface({id:e.id+"-left",bounds:n}),r=new Primrose.Surface({id:e.id+"-right",bounds:n});return i.context.drawImage(t,0,0),r.context.drawImage(t,-n.width,0),e.setImage(0,i.canvas),e.setImage(1,r.canvas),e.bounds.width=n.width,e.bounds.height=n.height,e.render(),emit.call(e,"load",{target:e}),e})}},{key:"getImage",value:function(t){return this._images[t%this._images.length]}},{key:"setImage",value:function(t,e){this._images[t]=e,this.render()}},{key:"eyeBlank",value:function(t){this._currentImageIndex=t,this.render()}},{key:"render",value:function(t){(this._changed||t)&&(this.resized?this.resize():this.image!==this._lastImage&&this.context.clearRect(0,0,this.imageWidth,this.imageHeight),this.image&&this.context.drawImage(this.image,0,0),this._lastWidth=this.imageWidth,this._lastHeight=this.imageHeight,this._lastImage=this.image,this.invalidate())}},{key:"src",get:function(){return this.getImage(this._currentImageIndex).src},set:function(t){"stereo"===this.className?this.loadStereoImage(t):this.loadImage(0,src)}},{key:"image",get:function(){return this.getImage(this._currentImageIndex)},set:function(t){this.setImage(this._currentImageIndex,t)}},{key:"_changed",get:function(){return this.resized||this.image!==this._lastImage}}]),u}(Primrose.Surface);window.Primrose.Controls.Image=a}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=0,o=function(o){function s(n,i){t(this,s),i=i||{},"string"==typeof i&&(i={value:i});var o=e(this,Object.getPrototypeOf(s).call(this,patch(i,{id:"Primrose.Controls.VUMeter["+r++ +"]",bounds:new Primrose.Text.Rectangle(0,0,512,256),backgroundColor:0,foregroundColor:16777215})));return o.analyzer=n,o.analyzer.fftSize=o.bounds.width,o.buffer=new Uint8Array(o.analyzer.frequencyBinCount),o}return n(s,o),i(s,[{key:"addToBrowserEnvironment",value:function(t,e){var n=textured(quad(.5,.5*this.imageHeight/this.imageWidth),this);return e.add(n),t.registerPickableObject(n),n}},{key:"render",value:function(){this.resized&&this.resize(),this.analyzer.getByteTimeDomainData(this.buffer),this.context.fillStyle=this.options.backgroundColor,this.context.fillRect(0,0,this.bounds.width,this.bounds.height),this.context.lineWidth=2,this.context.strokeStyle=this.options.foregroundColor,this.context.beginPath();for(var t=0;t<this.buffer.length;++t){var e=t*this.bounds.width/this.buffer.length,n=this.buffer[t]*this.bounds.height/256,i=t>0?"lineTo":"moveTo";this.context[i](e,n)}this.context.stroke(),this.invalidate()}}]),s}(Primrose.Surface);window.Primrose.Controls.VUMeter=o}(),function(){"use strict";function t(t,e,n,i){var r=null;if(null===t?(r=document.createElement(e),r.id=t="auto_"+e+Date.now()):void 0===n||t instanceof n?r=t:"string"==typeof t&&(r=document.getElementById(t),null===r?(r=document.createElement(e),r.id=t,i&&document.body.appendChild(r)):r.tagName!==e.toUpperCase()&&(r=null)),null===r)throw new Error(t+" does not refer to a valid "+e+" element.");return r}window.Primrose.DOM.cascadeElement=t}(),function(){"use strict";function t(t,e){t=t||document,e=e||{};for(var n=t.querySelectorAll("*"),i=0;i<n.length;++i){var r=n[i];r.id&&r.id.length>0&&(e[r.id]=r,r.parentElement&&(r.parentElement[r.id]=r))}return e}window.Primrose.DOM.findEverything=t}(),function(){"use strict";function t(t,e){var n=Primrose.DOM.cascadeElement(t,"div",window.HTMLDivElement);return n.style.position="absolute",n.style.left=0,n.style.top=0,n.style.width=0,n.style.height=0,n.style.overflow="hidden",n.appendChild(e),n}window.Primrose.DOM.makeHidingContainer=t}(),function(){"use strict";function t(t,e,n,i){return new Promise(function(r,o){i=i||{},i.headers=i.headers||{},"POST"===t&&(i.headers["Content-Type"]=i.headers["Content-Type"]||e);var s=new XMLHttpRequest;s.onerror=function(t){return o(new Error("Request error: "+t.message))},s.onabort=function(t){return o(new Error("Request abort: "+t.message))},s.onload=function(){s.status<400?r(s.response):o(s)},s.open(t,n),e&&(s.responseType=e),s.onprogress=i.progress;for(var a in i.headers)s.setRequestHeader(a,i.headers[a]);s.withCredentials=!!i.withCredentials,i.data?s.send(JSON.stringify(i.data)):s.send()})}window.Primrose.HTTP.XHR=t}(),function(){"use strict";function t(t,e,n){return Primrose.HTTP.XHR("DELETE",t,e,n)}window.Primrose.HTTP.del=t}(),function(){"use strict";function t(t,e){return Primrose.HTTP.del("json",t,e)}window.Primrose.HTTP.delObject=t}(),function(){"use strict";function t(t,e,n){return Primrose.HTTP.XHR("GET",t||"text",e,n)}window.Primrose.HTTP.get=t}(),function(){"use strict";function t(t,e){return Primrose.HTTP.get("arraybuffer",t,e)}window.Primrose.HTTP.getBuffer=t}(),function(){"use strict";function t(t,e){return Primrose.HTTP.get("json",t,e)}window.Primrose.HTTP.getObject=t}(),function(){"use strict";function t(t,e){return Primrose.HTTP.get("text",t,e)}window.Primrose.HTTP.getText=t}(),function(){"use strict";function t(t,e,n){return Primrose.HTTP.XHR("POST",t,e,n)}window.Primrose.HTTP.post=t}(),function(){"use strict";function t(t,e){return Primrose.HTTP.post("json",t,e)}window.Primrose.HTTP.postObject=t}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var e=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),n=new THREE.Vector3,i=new THREE.Euler,r=Math.PI/3,o=function(){function o(e,n){var i=this;t(this,o),e=e||window,this.options=n,this.listeners={zero:[],motioncontroller:[],gamepad:[]},this.managers=[],this.newState=[],this.pointers=[],this.motionDevices=[],this.velocity=new THREE.Vector3,this.matrix=new THREE.Matrix4;var r=function(t){return i.currentControl&&i.currentControl.keyUp&&i.currentControl.keyUp(t)},s=function(t){return i.Keyboard.doTyping(i.currentControl&&i.currentControl.focusedElement,t)};this.add(new Primrose.Input.Keyboard(this,null,{strafeLeft:{buttons:[-Primrose.Keys.A,-Primrose.Keys.LEFTARROW]},strafeRight:{buttons:[Primrose.Keys.D,Primrose.Keys.RIGHTARROW]},strafe:{commands:["strafeLeft","strafeRight"]},boost:{buttons:[Primrose.Keys.E],scale:.2},driveForward:{buttons:[-Primrose.Keys.W,-Primrose.Keys.UPARROW]},driveBack:{buttons:[Primrose.Keys.S,Primrose.Keys.DOWNARROW]},drive:{commands:["driveForward","driveBack"]},select:{buttons:[Primrose.Keys.ENTER]},dSelect:{buttons:[Primrose.Keys.ENTER],delta:!0},zero:{buttons:[Primrose.Keys.Z],metaKeys:[-Primrose.Keys.CTRL,-Primrose.Keys.ALT,-Primrose.Keys.SHIFT,-Primrose.Keys.META],commandUp:emit.bind(this,"zero")}})),this.Keyboard.addEventListener("keydown",s),this.Keyboard.addEventListener("keyup",r),this.add(new Primrose.Input.Touch(e,this.Keyboard,{buttons:{axes:[Primrose.Input.Touch.FINGERS]},dButtons:{axes:[Primrose.Input.Touch.FINGERS],delta:!0},dx:{axes:[-Primrose.Input.Touch.X0],delta:!0,scale:.005,min:-5,max:5},heading:{commands:["dx"],integrate:!0},dy:{axes:[-Primrose.Input.Touch.Y0],delta:!0,scale:.005,min:-5,max:5},pitch:{commands:["dy"],integrate:!0,min:.5*-Math.PI,max:.5*Math.PI}})),this.add(new Primrose.Input.Mouse(e,this.Keyboard,{buttons:{axes:[Primrose.Input.Mouse.BUTTONS]},dButtons:{axes:[Primrose.Input.Mouse.BUTTONS],delta:!0},dx:{axes:[-Primrose.Input.Mouse.X],delta:!0,scale:.005,min:-5,max:5},heading:{commands:["dx"],integrate:!0},dy:{axes:[-Primrose.Input.Mouse.Y],delta:!0,scale:.005,min:-5,max:5},pitch:{commands:["dy"],integrate:!0,min:.5*-Math.PI,max:.5*Math.PI},pointerPitch:{commands:["dy"],integrate:!0,min:.25*-Math.PI,max:.25*Math.PI}})),this.add(new Primrose.Input.VR(this.options.avatarHeight,isMobile?this.Touch:this.Mouse)),this.motionDevices.push(this.VR),Primrose.Input.Gamepad.addEventListener("gamepadconnected",function(t){var e=Primrose.Input.Gamepad.ID(t),n=0===e.indexOf("Vive"),r=null,o=0;if("Unknown"!==e&&"Rift"!==e){if(n){r={buttons:{axes:[Primrose.Input.Gamepad.BUTTONS]},dButtons:{axes:[Primrose.Input.Gamepad.BUTTONS],delta:!0},zero:{buttons:[Primrose.Input.Gamepad.VIVE_BUTTONS.GRIP_PRESSED],commandUp:emit.bind(i,"zero")}};for(var s=0;s<i.managers.length;++s){var a=i.managers[s];a.currentPad&&a.currentPad.id===t.id&&++o}}else r={buttons:{axes:[Primrose.Input.Gamepad.BUTTONS]},dButtons:{axes:[Primrose.Input.Gamepad.BUTTONS],delta:!0},strafe:{axes:[Primrose.Input.Gamepad.LSX],deadzone:.2},drive:{axes:[Primrose.Input.Gamepad.LSY],deadzone:.2},heading:{axes:[-Primrose.Input.Gamepad.RSX],deadzone:.2,integrate:!0},dHeading:{commands:["heading"],delta:!0},pitch:{axes:[-Primrose.Input.Gamepad.RSY],deadzone:.2,integrate:!0},zero:{buttons:[Primrose.Input.Gamepad.XBOX_ONE_BUTTONS.BACK],commandUp:emit.bind(i,"zero")}};var a=new Primrose.Input.Gamepad(t,o,r);if(i.add(a),n){a.parent=i.VR,i.motionDevices.push(a);var u=8*(i.motionDevices.length-2),c=new Primrose.Pointer(e+"Pointer",255<<u,127<<u,(!0),a);i.pointers.push(c),c.addToBrowserEnvironment(null,i.options.scene),c.addEventListener("teleport",function(t){return i.moveStage(t.position)})}else i.Keyboard.parent=a}}),Primrose.Input.Gamepad.addEventListener("gamepaddisconnected",this.remove.bind(this)),this.stage=new THREE.Object3D,this.mousePointer=new Primrose.Pointer("MousePointer",16711680,8323072,(!1),this.Mouse,this.VR),this.pointers.push(this.mousePointer),this.mousePointer.addToBrowserEnvironment(null,this.options.scene),this.head=new Primrose.Pointer("GazePointer",16776960,8355584,(!1),this.VR),this.pointers.push(this.head),this.head.addToBrowserEnvironment(null,this.options.scene),this.pointers.forEach(function(t){return t.addEventListener("teleport",function(t){return i.moveStage(t.position)})}),this.ready=Promise.all(this.managers.map(function(t){return t.ready}).filter(identity))}return e(o,[{key:"remove",value:function(t){var e=this[t],n=this.managers.indexOf(e);n>-1&&(this.managers.splice(n,1),delete this[t]),console.log("removed",e)}},{key:"add",value:function(t){for(var e=this.managers.length-1;e>=0;--e)this.managers[e].name===t.name&&this.managers.splice(e,1);this.managers.push(t),this[t.name]=t}},{key:"zero",value:function(){for(var t=0;t<this.managers.length;++t)this.managers[t].zero()}},{key:"submitFrame",value:function(){this.VR.submitFrame()}},{key:"update",value:function(t){this.Keyboard.enabled=this.Touch.enabled=this.Mouse.enabled=!this.hasMotionControllers,this.Gamepad_0&&(this.Gamepad_0.enabled=!this.hasMotionControllers);var e=this.hasGamepad;Primrose.Input.Gamepad.poll();for(var n=0;n<this.managers.length;++n)this.managers[n].update(t);!e&&this.hasGamepad&&(this.Mouse.inPhysicalUse=!1),this.updateStage(t),this.stage.updateMatrix(),this.matrix.multiplyMatrices(this.stage.matrix,this.VR.stage.matrix);for(var n=0;n<this.motionDevices.length;++n)this.motionDevices[n].updateStage(this.matrix);for(var n=0;n<this.pointers.length;++n)this.pointers[n].update();this.VR.hasOrientation?(this.mousePointer.showPointer=(this.hasMouse||this.hasGamepad)&&!(this.hasTouch||this.hasMotionControllers),this.head.showPointer=!(this.mousePointer.showPointer||this.hasMotionControllers)):(this.head.quaternion.copy(this.mousePointer.quaternion),this.head.showPointer=!1,this.mousePointer.showPointer=!0),this.newState=[],this.head.updateMatrix(),this.stage.updateMatrix(),this.head.position.toArray(this.newState,0),this.stage.quaternion.toArray(this.newState,3),this.head.quaternion.toArray(this.newState,7)}},{key:"updateStage",value:function(t){for(var e=0,o=0,s=0,a=0;a<this.managers.length;++a){var u=this.managers[a];e+=u.getValue("heading"),o+=u.getValue("strafe"),s+=u.getValue("drive")}this.VR.hasOrientation&&(e=r*Math.floor(e/r+.5)),i.set(0,e,0,"YXZ"),this.stage.quaternion.setFromEuler(i),this.velocity.x=o,this.velocity.z=s,this.stage.isOnGround||(this.velocity.y-=this.options.gravity*t,this.stage.position.y<0&&(this.velocity.y=0,this.stage.position.y=0,this.stage.isOnGround=!0)),this.moveStage(n.copy(this.velocity).multiplyScalar(t).applyQuaternion(this.stage.quaternion).add(this.head.position))}},{key:"moveStage",value:function(t){n.copy(t).sub(this.head.position),this.stage.position.x+=n.x,this.stage.position.z+=n.z}},{key:"resolvePicking",value:function(t,e,n){for(var i=0;i<this.pointers.length;++i)this.pointers[i].resolvePicking(t,e,n)}},{key:"addEventListener",value:function(t,e,n){if(this.listeners[t])this.listeners[t].push(e);else for(var i=0;i<this.managers.length;++i)this.managers[i].addEventListener(t,e,n)}},{key:"hasMotionControllers",get:function(){return!!(this.Vive_0&&this.Vive_0.enabled&&this.Vive_0.inPhysicalUse||this.Vive_1&&this.Vive_1.enabled&&this.Vive_1.inPhysicalUse)}},{key:"hasGamepad",get:function(){return!!(this.Gamepad_0&&this.Gamepad_0.enabled&&this.Gamepad_0.inPhysicalUse)}},{key:"hasMouse",get:function(){return!!(this.Mouse&&this.Mouse.enabled&&this.Mouse.inPhysicalUse)}},{key:"hasTouch",get:function(){return!!(this.Touch&&this.Touch.enabled&&this.Touch.inPhysicalUse)}},{key:"segments",get:function(){for(var t=[],e=0;e<this.pointers.length;++e){var n=this.pointers[e].segment;n&&t.push(n)}return t}},{key:"lockMovement",get:function(){for(var t=0;t<this.pointers.length;++t){var e=this.pointers[t];if(e.lockMovement)return!0}return!1}},{key:"currentControl",get:function(){for(var t=0;t<this.pointers.length;++t){var e=this.pointers[t];if(e.currentControl)return e.currentControl}}}]),o}();window.Primrose.Input.FPSInput=o}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();navigator.getGamepads=navigator.getGamepads||navigator.webkitGetGamepads;var r={gamepadconnected:[],gamepaddisconnected:[]},o=[],s=[],a={},u=function(u){function c(n,i,r,o,s){t(this,c);var u=c.ID(n),h=e(this,Object.getPrototypeOf(c).call(this,u,s,r,o,c.AXES));return a[u]=h,h.currentDevice=n,h.axisOffset=i,h}return n(c,u),i(c,null,[{key:"ID",value:function(t){var e=t.id;return"OpenVR Gamepad"===e?e="Vive":0===e.indexOf("Xbox")?e="Gamepad":0===e.indexOf("Rift")?e="Rift":0===e.indexOf("Unknown")&&(e="Unknown"),e=(e+"_"+(t.index||0)).replace(/\s+/g,"_")}},{key:"poll",value:function(){var t,e=navigator.getGamepads(),n=[],i=[],r=[],u=[];if(e)for(t=0;t<e.length;++t){var h=e[t];if(h){var l=c.ID(h),f=o.indexOf(l);n.push(h),i.push(l),f===-1?(r.push(h),o.push(l),s.push(h),delete a[l]):s[f]=h}}for(t=o.length-1;t>=0;--t){var l=o[t],d=a[l],m=s[t];i.indexOf(l)===-1?(u.push(l),s.splice(t,1),o.splice(t,1)):d&&d.checkDevice(m)}r.forEach(emit.bind(c,"gamepadconnected")),u.forEach(emit.bind(c,"gamepaddisconnected"))}},{key:"addEventListener",value:function(t,e){r[t]&&r[t].push(e)}},{key:"pads",get:function(){return s}},{key:"listeners",get:function(){return r}}]),i(c,[{key:"checkDevice",value:function(t){var e,n=0;for(this.currentDevice=t,this.currentPose=this.currentDevice.pose,e=0;e<t.buttons.length;++e){var i=t.buttons[e];this.setButton(e,i.pressed),i.pressed&&(n|=1<<e),this.setButton(e+t.buttons.length,i.touched)}for(this.setAxis("BUTTONS",n),e=0;e<t.axes.length;++e){var r=this.axisNames[this.axisOffset*t.axes.length+e];
this.setAxis(r,t.axes[e])}}},{key:"vibrate",value:function(t){this.currentDevice&&this.currentDevice.vibrate&&this.currentDevice.vibrate(t)}}]),c}(Primrose.PoseInputProcessor);Primrose.InputProcessor.defineAxisProperties(u,["LSX","LSY","RSX","RSY","IDK1","IDK2","Z","BUTTONS"]),u.XBOX_360_BUTTONS={A:1,B:2,X:3,Y:4,LEFT_BUMPER:5,RIGHT_BUMPER:6,LEFT_TRIGGER:7,RIGHT_TRIGGER:8,BACK:9,START:10,LEFT_STICK:11,RIGHT_STICK:12,UP_DPAD:13,DOWN_DPAD:14,LEFT_DPAD:15,RIGHT_DPAD:16},u.XBOX_ONE_BUTTONS={A:1,B:2,X:3,Y:4,LEFT_BUMPER:5,RIGHT_BUMPER:6,LEFT_TRIGGER:7,RIGHT_TRIGGER:8,BACK:9,START:10,LEFT_STICK:11,RIGHT_STICK:12,UP_DPAD:13,DOWN_DPAD:14,LEFT_DPAD:15,RIGHT_DPAD:16},u.VIVE_BUTTONS={TOUCHPAD_PRESSED:0,TRIGGER_PRESSED:1,GRIP_PRESSED:2,MENU_PRESSED:3,TOUCHPAD_TOUCHED:4,GRIP_TOUCHED:6,MENU_TOUCHED:7},window.Primrose.Input.Gamepad=u}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=function(r){function o(n,i,r,s){t(this,o);var a=e(this,Object.getPrototypeOf(o).call(this,"Keyboard",i,r,s));a.listeners.clipboard=[],a.listeners.keydown=[],a.listeners.keyup=[],a._operatingSystem=null,a.browser=isChrome?"CHROMIUM":isFirefox?"FIREFOX":isIE?"IE":isOpera?"OPERA":isSafari?"SAFARI":"UNKNOWN",a._codePage=null;var u=function(t){n.lockMovement?emit.call(a,t.type,t):a.setButton(t.keyCode,"keydown"===t.type)},c=function(t){if(a.lockMovement){var e=a.operatingSystem.makeCommandName(t,a.codePage);"CUT"!==e&&"COPY"!==e||(l.style.display="block",l.focus())}},h=function(t){a.currentControl&&(a.currentControl[t.type+"SelectedText"](t),t.returnValue||t.preventDefault(),l.style.display="none",a.currentControl.focus())},l=Primrose.DOM.cascadeElement("primrose-surrogate-textarea","textarea",HTMLTextAreaElement),f=Primrose.DOM.makeHidingContainer("primrose-surrogate-textarea-container",l);return f.style.position="absolute",f.style.overflow="hidden",f.style.width=0,f.style.height=0,l.addEventListener("beforecopy",setFalse,!1),l.addEventListener("copy",h,!1),l.addEventListener("beforecut",setFalse,!1),l.addEventListener("cut",h,!1),document.body.insertBefore(f,document.body.children[0]),window.addEventListener("beforepaste",setFalse,!1),window.addEventListener("keydown",c,!0),window.addEventListener("keydown",u,!1),window.addEventListener("keyup",u,!1),a}return n(o,r),i(o,[{key:"doTyping",value:function(t,e){if(t)if(t.execCommand&&this.operatingSystem&&this.browser&&this.codePage){var n=this.operatingSystem._deadKeyState,i=this.operatingSystem.makeCommandName(e,this.codePage);t.execCommand(this.browser,this.codePage,i)&&e.preventDefault(),this.operatingSystem._deadKeyState===n&&(this.operatingSystem._deadKeyState="")}else t.keyDown(e)}},{key:"withCurrentControl",value:function(t){var e=this;return function(n){e.currentControl&&(e.currentControl[t]?e.currentControl[t](n):console.warn("Couldn't find %s on %o",t,e.currentControl))}}},{key:"operatingSystem",get:function(){return this._operatingSystem},set:function(t){this._operatingSystem=t||(isOSX?Primrose.Text.OperatingSystems.OSX:Primrose.Text.OperatingSystems.Windows)}},{key:"codePage",get:function(){return this._codePage},set:function(t){var e;if(this._codePage=t,!this._codePage){var n=navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage||navigator.browserLanguage;n&&"en"!==n||(n="en-US");for(e in Primrose.Text.CodePages)if(t=Primrose.Text.CodePages[e],t.language===n){this._codePage=t;break}this._codePage||(this._codePage=Primrose.Text.CodePages.EN_US)}}}]),o}(Primrose.InputProcessor);window.Primrose.Input.Keyboard=r}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=function(r){function o(n,i){t(this,o);var r=e(this,Object.getPrototypeOf(o).call(this,"LeapMotion",null,n,i));return r.isStreaming=!1,r.controller=new Leap.Controller({enableGestures:!0}),r}return n(o,r),i(o,[{key:"E",value:function(t,e){e?this.controller.on(t,e):this.controller.on(t,console.log.bind(console,"Leap Motion Event: "+t))}},{key:"start",value:function(t){var e=this;if(this.isEnabled()){var n=null,i=null;if(t){var r=function e(n){requestAnimationFrame(e),t(n)};i=requestAnimationFrame.bind(window,r);var s=setTimeout(i,o.CONNECTION_TIMEOUT);n=function(){clearTimeout(s),e.isStreaming=!0},this.E("deviceStreaming",n),this.E("streamingStarted",n),this.E("streamingStopped",i)}this.E("connect"),this.E("deviceStopped"),this.E("disconnect"),this.E("frame",this.setState.bind(this,t)),this.controller.connect()}}},{key:"setState",value:function(t,e){var n,i,r=this.controller.history.get(1);if(!r||e.hands.length!==r.hands.length)for(n=0;n<this.commands.length;++n)this.enable(this.commands[n].name,e.hands.length>0);for(n=0;n<e.hands.length;++n){var s=e.hands[n].palmPosition,a="HAND"+n;for(i=0;i<o.COMPONENTS.length;++i)this.setAxis(a+o.COMPONENTS[i],s[i])}for(n=0;n<e.fingers.length;++n){var u=e.fingers[n],c="FINGER"+n;for(i=0;i<o.FINGER_PARTS.length;++i)for(var h=u[o.FINGER_PARTS[i]+"Position"],l=c+o.FINGER_PARTS[i].toUpperCase(),f=0;f<o.COMPONENTS.length;++f)this.setAxis(l+o.COMPONENTS[f],h[f])}t&&t(.001*e.timestamp),this.update()}}]),o}(Primrose.InputProcessor);r.COMPONENTS=["X","Y","Z"],r.NUM_HANDS=2,r.NUM_FINGERS=10,r.FINGER_PARTS=["tip","dip","pip","mcp","carp"],Primrose.InputProcessor.defineAxisProperties(r,["X0","Y0","Z0","X1","Y1","Z1","FINGER0TIPX","FINGER0TIPY","FINGER0DIPX","FINGER0DIPY","FINGER0PIPX","FINGER0PIPY","FINGER0MCPX","FINGER0MCPY","FINGER0CARPX","FINGER0CARPY","FINGER1TIPX","FINGER1TIPY","FINGER1DIPX","FINGER1DIPY","FINGER1PIPX","FINGER1PIPY","FINGER1MCPX","FINGER1MCPY","FINGER1CARPX","FINGER1CARPY","FINGER2TIPX","FINGER2TIPY","FINGER2DIPX","FINGER2DIPY","FINGER2PIPX","FINGER2PIPY","FINGER2MCPX","FINGER2MCPY","FINGER2CARPX","FINGER2CARPY","FINGER3TIPX","FINGER3TIPY","FINGER3DIPX","FINGER3DIPY","FINGER3PIPX","FINGER3PIPY","FINGER3MCPX","FINGER3MCPY","FINGER3CARPX","FINGER3CARPY","FINGER4TIPX","FINGER4TIPY","FINGER4DIPX","FINGER4DIPY","FINGER4PIPX","FINGER4PIPY","FINGER4MCPX","FINGER4MCPY","FINGER4CARPX","FINGER4CARPY","FINGER5TIPX","FINGER5TIPY","FINGER5DIPX","FINGER5DIPY","FINGER5PIPX","FINGER5PIPY","FINGER5MCPX","FINGER5MCPY","FINGER5CARPX","FINGER5CARPY","FINGER6TIPX","FINGER6TIPY","FINGER6DIPX","FINGER6DIPY","FINGER6PIPX","FINGER6PIPY","FINGER6MCPX","FINGER6MCPY","FINGER6CARPX","FINGER6CARPY","FINGER7TIPX","FINGER7TIPY","FINGER7DIPX","FINGER7DIPY","FINGER7PIPX","FINGER7PIPY","FINGER7MCPX","FINGER7MCPY","FINGER7CARPX","FINGER7CARPY","FINGER8TIPX","FINGER8TIPY","FINGER8DIPX","FINGER8DIPY","FINGER8PIPX","FINGER8PIPY","FINGER8MCPX","FINGER8MCPY","FINGER8CARPX","FINGER8CARPY","FINGER9TIPX","FINGER9TIPY","FINGER9DIPX","FINGER9DIPY","FINGER9PIPX","FINGER9PIPY","FINGER9MCPX","FINGER9MCPY","FINGER9CARPX","FINGER9CARPY"]),r.CONNECTION_TIMEOUT=5e3,window.Primrose.Input.LeapMotion=r}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=function(r){function o(n,i,r){t(this,o);var s=e(this,Object.getPrototypeOf(o).call(this,"Location",null,n,i));return s.options=patch(r,o.DEFAULTS),s.available=!!navigator.geolocation,s.available&&navigator.geolocation.watchPosition(s.setState.bind(s),function(){return s.available=!1},s.options),s}return n(o,r),i(o,[{key:"setState",value:function(t){for(var e in t.coords){var n=e.toUpperCase();o.AXES.indexOf(n)>-1&&this.setAxis(n,t.coords[e])}this.update()}}]),o}(Primrose.InputProcessor);Primrose.InputProcessor.defineAxisProperties(r,["LONGITUDE","LATITUDE","ALTITUDE","HEADING","SPEED"]),r.DEFAULTS={enableHighAccuracy:!0,maximumAge:3e4,timeout:25e3},window.Primrose.Input.Location=r}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function i(t,e){var n=Math.max(screen.width,screen.height),i=Math.min(screen.width,screen.height),r=Math.floor(n*devicePixelRatio/2),o=Math.floor(i*devicePixelRatio),s=(e+1)/2;window.THREE&&(t.transform=(new THREE.Matrix4).makeTranslation(.034*e,0,0)),t.viewport={x:s*r,y:0,width:r,height:o,top:0,right:(s+1)*r,bottom:o,left:s*r},t.fov=75}var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),o=function(i){function o(n,i){t(this,o);var r=e(this,Object.getPrototypeOf(o).call(this,"Motion",null,n,i)),s=new MotionCorrector,a=new THREE.Quaternion,u=new THREE.Quaternion,c=new THREE.Vector3(1,0,0),h=new THREE.Vector3(0,1,0),l=new THREE.Vector3(0,0,(-1));return s.addEventListener("deviceorientation",function(t){for(var e=0;e<o.AXES.length;++e){var n=o.AXES[e];r.setAxis(n,t[n])}a.set(0,0,0,1).multiply(u.setFromAxisAngle(h,t.HEADING)).multiply(u.setFromAxisAngle(c,t.PITCH)).multiply(u.setFromAxisAngle(l,t.ROLL)),r.headRX=a.x,r.headRY=a.y,r.headRZ=a.z,r.headRW=a.w,r.update()}),r.zeroAxes=s.zeroAxes.bind(s),r}return n(o,i),r(o,[{key:"getOrientation",value:function(t){return t=t||new THREE.Quaternion,t.set(this.getValue("headRX"),this.getValue("headRY"),this.getValue("headRZ"),this.getValue("headRW")),t}}]),o}(Primrose.InputProcessor);Primrose.InputProcessor.defineAxisProperties(o,["HEADING","PITCH","ROLL","D_HEADING","D_PITCH","D_ROLL","headAX","headAY","headAZ","headRX","headRY","headRZ","headRW"]),o.DEFAULT_TRANSFORMS=[{},{}],i(o.DEFAULT_TRANSFORMS[0],-1),i(o.DEFAULT_TRANSFORMS[1],1),window.Primrose.Input.Motion=o}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=function(r){function o(n,i,r,s){t(this,o);var a=e(this,Object.getPrototypeOf(o).call(this,"Mouse",i,r,s));return a.timer=null,n=n||window,n.addEventListener("mousedown",function(t){a.setButton(t.button,!0),a.BUTTONS=t.buttons<<10},!1),n.addEventListener("mouseup",function(t){a.setButton(t.button,!1),a.BUTTONS=t.buttons<<10},!1),n.addEventListener("mousemove",function(t){if(a.BUTTONS=t.buttons<<10,PointerLock.isActive){var e=t.movementX,n=t.movementY;void 0===e&&(e=t.webkitMovementX||t.mozMovementX||0,n=t.webkitMovementY||t.mozMovementY||0),a.setMovement(e,n)}else a.setLocation(t.layerX,t.layerY)},!1),n.addEventListener("wheel",function(t){isChrome?(a.W+=t.deltaX,a.Z+=t.deltaY):t.shiftKey?a.W+=t.deltaY:a.Z+=t.deltaY,t.preventDefault()},!1),a}return n(o,r),i(o,[{key:"setLocation",value:function(t,e){this.X=t,this.Y=e}},{key:"setMovement",value:function(t,e){this.X+=t,this.Y+=e}}]),o}(Primrose.InputProcessor);Primrose.InputProcessor.defineAxisProperties(r,["X","Y","Z","W","BUTTONS"]),window.Primrose.Input.Mouse=r}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,i)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(i)},o=function(o){function s(n,i){function r(){var t="Failed to initialize speech engine. Reason: "+l.message;return console.error(t),!1}function o(){return available?!c&&(c=!0,h.start(),!0):r()}function a(){return available?!!c&&(h.stop(),!0):r()}t(this,s);var u=e(this,Object.getPrototypeOf(s).call(this,"Speech",null,n,i)),c=!1,h=null,l=null;u.check=function(){this.enabled&&!c?o():!this.enabled&&c&&a()},u.getErrorMessage=function(){return l};try{h=window.SpeechRecognition?new SpeechRecognition:new webkitSpeechRecognition,h.continuous=!0,h.interimResults=!0,h.lang="en-US";var f=!1;h.addEventListener("start",function(){console.log("speech started"),command=""}.bind(u),!0),h.addEventListener("error",function(t){f=!0,console.log("speech error",t),c=!1,command="speech error"}.bind(u),!0),h.addEventListener("end",function(t){console.log("speech ended",t),c=!1,command="speech ended",f&&(f=!1,this.enable(!0))}.bind(u),!0),h.addEventListener("result",function(t){var e=[],n=t.results[t.resultIndex],i=0,r=-1;if(n&&n.isFinal)for(var o=0;o<n.length;++o){var s=n[o];s.confidence>i&&(i=s.confidence,r=o)}i>.85&&e.push(n[r].transcript.trim()),e=e.join(" "),e!==this.inputState&&(this.inputState.text=e),this.update()}.bind(u),!0),available=!0}catch(t){console.error(t),l=t,available=!1}return u}return n(s,o),i(s,[{key:"cloneCommand",value:function(t){return{name:t.name,preamble:t.preamble,keywords:s.maybeClone(t.keywords),commandUp:t.commandUp,disabled:t.disabled}}},{key:"evalCommand",value:function(t,e,n,i){if(n&&this.inputState.text)for(var r=0;r<t.keywords.length;++r)0!==this.inputState.text.indexOf(t.keywords[r])||!t.preamble&&t.keywords[r].length!==this.inputState.text.length||(e.pressed=!0,e.value=this.inputState.text.substring(t.keywords[r].length).trim(),this.inputState.text=null)}},{key:"enable",value:function(t,e){r(Object.getPrototypeOf(s.prototype),"enable",this).call(this,t,e),this.check()}},{key:"transmit",value:function(t){r(Object.getPrototypeOf(s.prototype),"transmit",this).call(this,t),this.check()}}],[{key:"maybeClone",value:function(t){return t&&t.slice()||[]}}]),s}(Primrose.InputProcessor);window.Primrose.Input.Speech=o}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(i){function r(n,i,o,s){function a(t,e,n){var i=n.changedTouches,r=0,o=null;for(r=0;r<i.length;++r)o=i[r],e?(this.setAxis("X"+o.identifier,o.pageX),this.setAxis("Y"+o.identifier,o.pageY)):(this.setAxis("LX"+o.identifier,o.pageX),this.setAxis("LY"+o.identifier,o.pageY)),this.setButton("FINGER"+o.identifier,t);i=n.touches;var s=0;for(r=0;r<i.length;++r)s|=1<<o.identifier;this.FINGERS=s,n.preventDefault()}t(this,r);var u=e(this,Object.getPrototypeOf(r).call(this,"Touch",i,o,s));return n=n||window,n.addEventListener("touchstart",a.bind(u,!0,!1),!1),n.addEventListener("touchend",a.bind(u,!1,!0),!1),n.addEventListener("touchmove",a.bind(u,!0,!0),!1),u}return n(r,i),r}(Primrose.InputProcessor);if(navigator.maxTouchPoints){for(var r=["FINGERS"],o=0;o<navigator.maxTouchPoints;++o)r.push("X"+o),r.push("Y"+o);Primrose.InputProcessor.defineAxisProperties(i,r)}window.Primrose.Input.Touch=i}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),o=function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,i)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(i)},s=3e3,a=function(a){function u(n,i,r){t(this,u);var o=e(this,Object.getPrototypeOf(u).call(this,"VR",i,null,r));return o.displays=[],o._transformers=[],o.currentDeviceIndex=-1,o.movePlayer=new THREE.Matrix4,o.defaultAvatarHeight=n,o.stage=null,o.lastStageWidth=null,o.lastStageDepth=null,console.info("Checking for displays..."),o.ready=navigator.getVRDisplays().then(function(t){return console.log("Displays found:",t.length),o.displays.push.apply(o.displays,t),o.displays}),o}return n(u,a),r(u,[{key:"connect",value:function(t){if(this.currentDevice=null,this.currentDeviceIndex=t,this.currentPose=null,0<=t&&t<=this.displays.length){this.currentDevice=this.displays[t],this.currentPose=this.currentDevice.getPose();var e=this.currentDevice.getEyeParameters("left"),n=e.fieldOfView;this.rotationAngle=Math.PI*(n.leftDegrees+n.rightDegrees)/360}}},{key:"requestPresent",value:function(t){var e=this;if(!this.currentDevice)return Promise.reject("No display");var n,r,o=function(){var i=t;return i instanceof Array||(i=[i]),e.isNativeMobileWebVR&&(i=i[0]),n=t[0].source,r=FullScreen.request(n).catch(function(t){return console.warn("FullScreen",t)}).then(function(){return PointerLock.request(n)}).catch(function(t){return console.warn("PointerLock",t)}).then(function(){return e.currentDevice.requestPresent(i)}).catch(function(t){return console.warn("requstPresent",t)}),e.isNativeMobileWebVR&&(r=r.then(Orientation.lock).catch(function(t){return console.warn("OrientationLock",t)})),{v:r}}();return"object"===("undefined"==typeof o?"undefined":i(o))?o.v:void 0}},{key:"cancel",value:function(){var t=this,e=null;return this.isPresenting?(e=this.currentDevice.exitPresent(),this.currentDevice=null,this.currentDeviceIndex=-1,this.currentPose=null):e=Promise.resolve(),this.isNativeMobileWebVR&&(e=e.then(Orientation.unlock)),e.then(PointerLock.exit).then(function(){return t.connect(0)})}},{key:"zero",value:function(){o(Object.getPrototypeOf(u.prototype),"zero",this).call(this),this.currentDevice&&this.currentDevice.resetPose()}},{key:"update",value:function(t){o(Object.getPrototypeOf(u.prototype),"update",this).call(this,t);var e=0,n=0,i=null;this.currentDevice&&(this.currentPose=this.currentDevice.getPose(),i=this.currentDevice.stageParameters),i?(this.movePlayer.fromArray(i.sittingToStandingTransform),e=i.sizeX,n=i.sizeZ):this.movePlayer.makeTranslation(0,this.defaultAvatarHeight,0);var r={matrix:this.movePlayer,sizeX:e,sizeZ:n};this.stage&&r.sizeX===this.stage.sizeX&&r.sizeZ===this.stage.sizeZ||(this.stage=r)}},{key:"submitFrame",value:function(){this.currentDevice&&this.currentDevice.submitFrame(this.currentPose)}},{key:"resolvePicking",value:function(t,e,n){o(Object.getPrototypeOf(u.prototype),"resolvePicking",this).call(this,t,e,n);var i,r,a=t.VR,c=e&&e.VR;c&&a&&c.objectID===a.objectID?(a.startTime=c.startTime,a.gazeFired=c.gazeFired,i=r-a.startTime,i>=s&&!a.gazeFired&&(a.gazeFired=!0,emit.call(this,"gazecomplete",a),emit.call(this.pickableObjects[a.objectID],"click","Gaze"))):(c&&(i=r-c.startTime,i<s&&emit.call(this,"gazecancel",c)),a&&(a.startTime=r,a.gazeFired=!1,emit.call(this,"gazestart",a)))}},{key:"getTransforms",value:function(t,e){if(this.currentDevice)return this._transformers[this.currentDeviceIndex]||(this._transformers[this.currentDeviceIndex]=new ViewCameraTransform(this.currentDevice)),this._transformers[this.currentDeviceIndex].getTransforms(t,e)}},{key:"isNativeMobileWebVR",get:function(){return!(this.currentDevice&&this.currentDevice.isPolyfilled)&&isChrome&&isMobile}},{key:"hasStage",get:function(){return this.stage&&this.stage.sizeX*this.stage.sizeZ>0}},{key:"canMirror",get:function(){return this.currentDevice&&this.currentDevice.capabilities.hasExternalDisplay}},{key:"isPolyfilled",get:function(){return this.currentDevice&&this.currentDevice.isPolyfilled}},{key:"isPresenting",get:function(){return this.currentDevice&&this.currentDevice.isPresenting}},{key:"hasOrientation",get:function(){return this.currentDevice&&this.currentDevice.capabilities.hasOrientation}},{key:"currentCanvas",get:function(){return this.isPresenting&&this.currentDevice.getLayers()[0].source}}]),u}(Primrose.PoseInputProcessor);window.Primrose.Input.VR=a}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,i)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(i)},o=!0;navigator.mediaDevices||(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia||(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.oGetUserMedia,navigator.mediaDevices.getUserMedia=function(t){return new Promise(function(e,n){return navigator.getUserMedia(t,e,n)})});var s=function(){function t(t){if(o){for(var r=t.sdp,s=r.split("\r\n"),a=null,u=0;u<s.length;u++)if(s[u].search("m=audio")!==-1){a=u;break}if(null===a)return r;for(var c=0;c<s.length;c++)if(s[c].search("opus/48000")!==-1){var h=e(s[c],/:(\d+) opus\/48000/i);h&&(s[a]=n(s[a],h));break}s=i(s,a),t.sdp=s.join("\r\n")}return t}function e(t,e){var n=t.match(e);return n&&2==n.length?n[1]:null}function n(t,e){for(var n=t.split(" "),i=[],r=0,o=0;o<n.length;o++)3===r&&(i[r++]=e),n[o]!==e&&(i[r++]=n[o]);return i.join(" ")}function i(t,n){for(var i=t[n].split(" "),r=t.length-1;r>=0;r--){var o=e(t[r],/a=rtpmap:(\d+) CN\/\d+/i);if(o){var s=i.indexOf(o);s!==-1&&i.splice(s,1),t.splice(r,1)}}return t[n]=i.join(" "),t}return t}(),a=function(o){function a(n,i,r,o,s,u){t(this,a);var c=e(this,Object.getPrototypeOf(a).call(this,n,i,r,0,o,0,u));return Object.defineProperty(c,"outAudio",{get:function(){return s}}),c.inAudio=null,c}return n(a,o),i(a,[{key:"issueRequest",value:function(){var t=this,e=function(){t._log(0,"adding stream",t.outAudio),t.outAudio&&(isFirefox?t.outAudio.getAudioTracks().forEach(function(e){return t.rtc.addTrack(e,t.outAudio)}):t.rtc.addStream(t.outAudio))},n=function(n){t.inAudio=n,t.goFirst||(t._log(0,"Creating the second stream from %s to %s",t.fromUserName,t.toUserName),e())};isFirefox?this.rtc.ontrack=function(t){return n(t.streams[0])}:this.rtc.onaddstream=function(t){return n(t.stream)},this.goFirst&&(this._log(0,"Creating the first stream from %s to %s",this.fromUserName,this.toUserName),e())}},{key:"teardown",value:function(){isFirefox?this.rtc.ontrack=null:this.rtc.onaddstream=null}},{key:"createOffer",value:function(){return r(Object.getPrototypeOf(a.prototype),"createOffer",this).call(this).then(s)}},{key:"complete",get:function(){return this.goFirst?this._log(1,"[First]: OC %s -> AR %s -> OR %s -> AC %s.",this.progress.offer.created,this.progress.answer.received,this.progress.offer.received,this.progress.answer.created):this._log(1,"[Second]: OR %s -> AC %s -> OC %s -> AR %s.",this.progress.offer.received,this.progress.answer.created,this.progress.offer.created,this.progress.answer.received),r(Object.getPrototypeOf(a.prototype),"complete",this)||this.progress.offer.received&&this.progress.offer.created&&this.progress.answer.received&&this.progress.answer.created}}]),a}(Primrose.WebRTCSocket);window.Primrose.Network.AudioChannel=a}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,i)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(i)},o=function(o){function s(n,i,r,o,a,u,c){t(this,s);var h=e(this,Object.getPrototypeOf(s).call(this,n,i,r,o,a,u,c));return h.dataChannel=null,h}return n(s,o),i(s,[{key:"issueRequest",value:function(){var t=this;goFirst?(this._log(0,"Creating data channel"),this.dataChannel=this.rtc.createDataChannel()):this.ondatachannel=function(e){t._log(0,"Receving data channel"),t.dataChannel=e.channel}}},{key:"teardown",value:function(){this.rtc.ondatachannel=null}},{key:"complete",get:function(){return this.goFirst?this._log(1,"[First]: OC %s -> AR %s.",this.progress.offer.created,this.progress.answer.received):this._log(1,"[Second]: OC %s -> AR %s.",this.progress.offer.created,this.progress.answer.received),r(Object.getPrototypeOf(s.prototype),"complete",this)||this.goFirst&&this.progress.offer.created&&this.progress.answer.received||!this.goFirst&&this.progress.offer.recieved&&this.progress.answer.created}}]),s}(Primrose.WebRTCSocket);window.Primrose.Network.DataChannel=o}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=function(r){function o(n,i,r,s){t(this,o);var a=e(this,Object.getPrototypeOf(o).call(this));return a.localUser=n,a.audio=i,a.factories=r,a.options=s,a.lastNetworkUpdate=0,a.oldState=[],a.users={},a.extraIceServers=[],s.webRTC?a.waitForLastUser=s.webRTC.then(function(t){t&&a.extraIceServers.push.apply(a.extraIceServers,t.iceServers)}):a.waitForLastUser=Promise.resolve(),a._socket=null,a.userName=null,a.microphone=null,a}return n(o,r),i(o,[{key:"update",value:function(t){if(this._socket&&0===this.deviceIndex&&(this.lastNetworkUpdate+=t,this.lastNetworkUpdate>=Primrose.Network.RemoteUser.NETWORK_DT)){this.lastNetworkUpdate-=Primrose.Network.RemoteUser.NETWORK_DT;for(var e=0;e<this.localUser.newState.length;++e)if(this.oldState[e]!==this.localUser.newState[e]){this._socket.emit("userState",this.localUser.newState),this.oldState=this.localUser.newState;break}}for(var n in this.users){var i=this.users[n];i.update(t)}}},{key:"updateUser",
value:function(t){var e=t[0];if(e!==this.userName){var n=this.users[e];n?n.state=t:console.error("Unknown user",e)}else this.deviceIndex>0&&(this.localUser.stage.mesh.position.fromArray(t,1),this.localUser.stage.mesh.quaternion.fromArray(t,4),this.localUser.head.mesh.position.fromArray(t,8),this.localUser.head.mesh.quaternion.fromArray(t,11))}},{key:"connect",value:function(t,e){this.userName=e.toLocaleUpperCase(),this.microphone||(this.microphone=navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(Primrose.Output.Audio3D.setAudioStream).catch(console.warn.bind(console,"Can't get audio"))),this._socket||(this._socket=t,this._socket.on("userList",this.listUsers.bind(this)),this._socket.on("userJoin",this.addUser.bind(this)),this._socket.on("deviceAdded",this.addDevice.bind(this)),this._socket.on("deviceIndex",this.setDeviceIndex.bind(this)),this._socket.on("chat",this.receiveChat.bind(this)),this._socket.on("userState",this.updateUser.bind(this)),this._socket.on("userLeft",this.removeUser.bind(this)),this._socket.on("connection_lost",this.lostConnection.bind(this)),this._socket.emit("listUsers"),this._socket.emit("getDeviceIndex"))}},{key:"disconnect",value:function(){this.userName=null,this._socket.close(),this._socket=null}},{key:"addUser",value:function(t,e){var n=this;console.log("User %s logging on.",t[0]);var i=t[0],r=new Primrose.Network.RemoteUser(i,this.factories.avatar,this.options.foregroundColor);this.users[i]=r,this.updateUser(t),this.emit("addavatar",r),this.waitForLastUser=this.waitForLastUser.then(function(){return r.peer(n.extraIceServers,n._socket,n.microphone,n.userName,n.audio,e)}).then(function(){return console.log("%s is peered with %s",n.userName,i)}).catch(function(t){return console.error("Couldn't load user: "+name,t)})}},{key:"removeUser",value:function(t){console.log("User %s logging off.",t);var e=this.users[t];e&&(e.unpeer(),delete this.users[t],this.emit("removeavatar",e))}},{key:"listUsers",value:function(t){for(Object.keys(this.users).forEach(this.removeUser.bind(this));t.length>0;)this.addUser(t.shift(),!0);this.emit("authorizationsucceeded")}},{key:"receiveChat",value:function(t){console.log("chat",t)}},{key:"lostConnection",value:function(){this.deviceIndex=null}},{key:"addDevice",value:function(t){console.log("addDevice",t)}},{key:"setDeviceIndex",value:function(t){this.deviceIndex=t}}]),o}(Primrose.AbstractEventEmitter);window.Primrose.Network.Manager=r}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var e=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),n=function(){function n(e,i,r){var o=this;t(this,n),this.time=0,this.userName=e,this.stage=i.clone(),this.stage.traverse(function(t){"AvatarBelt"===t.name?textured(t,Primrose.Random.color()):"AvatarHead"===t.name&&(o.head=t)}),this.nameObject=textured(text3D(.1,e),r);var s=this.nameObject.geometry.boundingBox.max;this.nameObject.rotation.set(0,Math.PI,0),this.nameObject.position.set(s.x/2,s.y,0),this.head.add(this.nameObject),this.dStageQuaternion=new THREE.Quaternion,this.dHeadPosition=new THREE.Vector3,this.dHeadQuaternion=new THREE.Quaternion,this.lastStageQuaternion=new THREE.Quaternion,this.lastHeadPosition=new THREE.Vector3,this.lastHeadQuaternion=new THREE.Quaternion,this.stageQuaternion={arr1:[],arr2:[],last:this.lastStageQuaternion,delta:this.dStageQuaternion,curr:this.stage.quaternion},this.headPosition={arr1:[],arr2:[],last:this.lastHeadPosition,delta:this.dHeadPosition,curr:this.head.position},this.headQuaternion={arr1:[],arr2:[],last:this.lastHeadQuaternion,delta:this.dHeadQuaternion,curr:this.head.quaternion},this.audioChannel=null,this.audioElement=null,this.audioStream=null,this.gain=null,this.panner=null,this.analyzer=null}return e(n,[{key:"peer",value:function(t,e,n,i,r,o){var s=this;return n.then(function(n){return s.audioChannel=new Primrose.Network.AudioChannel(t,e,i,s.userName,n,o),s.audioChannel.ready.then(function(){if(!s.audioChannel.inAudio)throw new Error("Didn't get an audio channel for "+s.userName);s.audioElement=new Audio,Primrose.Output.Audio3D.setAudioStream(s.audioChannel.inAudio),s.audioElement.controls=!1,s.audioElement.autoplay=!0,s.audioElement.crossOrigin="anonymous",document.body.appendChild(s.audioElement),s.audioStream=r.context.createMediaStreamSource(s.audioChannel.inAudio),s.gain=r.context.createGain(),s.panner=r.context.createPanner(),s.audioStream.connect(s.gain),s.gain.connect(s.panner),s.panner.connect(r.mainVolume),s.panner.coneInnerAngle=180,s.panner.coneOuterAngle=360,s.panner.coneOuterGain=.1,s.panner.panningModel="HRTF",s.panner.distanceModel="exponential"})})}},{key:"unpeer",value:function(){this.audioChannel&&(this.audioChannel.close(),this.audioElement&&(document.body.removeChild(this.audioElement),this.panner&&(this.panner.disconnect(),this.gain.disconnect(),this.audioStream.disconnect())))}},{key:"_updateV",value:function(t,e,i){t.curr.toArray(t.arr1),t.delta.toArray(t.arr2);for(var r=0;r<t.arr1.length;++r)i&&(t.arr2[r]*=n.FADE_FACTOR),t.arr1[r]+=t.arr2[r]*e;t.curr.fromArray(t.arr1),t.delta.fromArray(t.arr2)}},{key:"_predict",value:function(t,e,i){t.delta.fromArray(e,i),t.delta.toArray(t.arr1),t.curr.toArray(t.arr2);for(var r=0;r<t.arr1.length;++r)t.arr1[r]=(t.arr1[r]-t.arr2[r])*n.NETWORK_DT_INV;t.delta.fromArray(t.arr1)}},{key:"update",value:function(t){this.time+=t;var e=this.time>=n.NETWORK_DT;this._updateV(this.headPosition,t,e),this._updateV(this.stageQuaternion,t,e),this._updateV(this.headQuaternion,t,e),this.stage.position.copy(this.headPosition.curr),this.stage.position.y=0,this.panner&&(this.panner.setPosition(this.stage.position.x,this.stage.position.y,this.stage.position.z),this.panner.setOrientation(Math.sin(this.stage.rotation.y),0,Math.cos(this.stage.rotation.y)))}},{key:"toString",value:function(t){return this.stage.position.curr.toString(t)+" "+this.headPosition.curr.toString(t)}},{key:"state",set:function(t){this.time=0,this._predict(this.headPosition,t,1),this._predict(this.stageQuaternion,t,4),this._predict(this.headQuaternion,t,8)}}]),n}();n.FADE_FACTOR=.5,n.NETWORK_DT=.1,n.NETWORK_DT_INV=1/n.NETWORK_DT,window.Primrose.Network.RemoteUser=n}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var e=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();Window.prototype.AudioContext=Window.prototype.AudioContext||Window.prototype.webkitAudioContext||function(){};var n=function(){function n(){var e=this;t(this,n);try{this.context=new AudioContext,this.sampleRate=this.context.sampleRate,this.mainVolume=this.context.createGain();var i=new THREE.Vector3,r=new THREE.Vector3,o=(new THREE.Matrix4).identity(),s=(new THREE.Matrix4).identity(),a=null;this.setVelocity=this.context.listener.setVelocity.bind(this.context.listener),this.setPlayer=function(t){var n=t;for(o.identity(),s.identity();null!==n;)o.fromArray(n.matrix.elements),o.multiply(s),a=o,o=s,s=a,n=n.parent;a=o;var u=a.elements[12],c=a.elements[13],h=a.elements[14];a.elements[12]=a.elements[13]=a.elements[14]=0,e.context.listener.setPosition(u,c,h),i.set(0,0,1),i.applyProjection(s),i.normalize(),r.set(0,-1,0),r.applyProjection(s),r.normalize(),e.context.listener.setOrientation(i.x,i.y,i.z,r.x,r.y,r.z),s.elements[12]=u,s.elements[13]=c,s.elements[14]=h},this.isAvailable=!0,this.start()}catch(t){console.error(t),console.error("AudioContext not available."),this.isAvailable=!1,this.setPlayer=function(){},this.setVelocity=function(){},this.start=function(){},this.stop=function(){},this.error=t}}return e(n,[{key:"start",value:function(){this.mainVolume.connect(this.context.destination)}},{key:"stop",value:function(){this.mainVolume.disconnect()}},{key:"loadURL",value:function(t){var e=this;return Primrose.HTTP.getBuffer(t).then(function(t){return new Promise(function(n,i){return e.context.decodeAudioData(t,n,i)})})}},{key:"loadURLCascadeSrcList",value:function(t,e){var n=this;return e=e||0,e>=t.length?Promise.reject("Failed to load a file from "+t.length+" files."):this.loadURL(t[e]).catch(function(i){return console.error(i),n.loadURLCascadeSrcList(t,e+1)})}},{key:"createRawSound",value:function(t){if(1!==t.length&&2!==t.length)throw new Error("Incorrect number of channels. Expected 1 or 2, got "+t.length);var e=t[0].length;if(t.length>1&&t[1].length!==e)throw new Error("Second channel is not the same length as the first channel. Expected "+e+", but was "+t[1].length);for(var n=this.context.createBuffer(t.length,e,this.sampleRate),i=0;i<t.length;++i)for(var r=n.getChannelData(i),o=0;o<e;++o)r[o]=t[i][o];return n}},{key:"createSound",value:function(t,e){var n={volume:this.context.createGain(),source:this.context.createBufferSource()};return n.source.buffer=e,n.source.loop=t,n.source.connect(n.volume),n}},{key:"create3DMediaStream",value:function(t,e,n,i){console.log(i);var r=document.createElement("audio"),o={audio:r,source:this.context.createMediaElementSource(r)};return isChrome?r.src=URL.createObjectURL(i):r.srcObject=i,r.autoplay=!0,r.controls=!0,r.muted=!0,o.source.connect(this.mainVolume),o}},{key:"create3DSound",value:function(t,e,n,i){return i.panner=this.context.createPanner(),i.panner.setPosition(t,e,n),i.panner.connect(this.mainVolume),i.volume.connect(i.panner),i}},{key:"createFixedSound",value:function(t){return t.volume.connect(this.mainVolume),t}},{key:"loadSource",value:function(t,e){var n=this;return new Promise(function(i,r){t instanceof Array||(t=[t]);var o=document.createElement("audio");o.autoplay=!0,o.loop=e,t.map(function(t){var e=document.createElement("source");return e.src=t,e}).forEach(o.appendChild.bind(o)),o.oncanplay=function(){if(n.context){o.oncanplay=null;var t={volume:n.context.createGain(),source:n.context.createMediaElementSource(o)};t.source.connect(t.volume)}i(t)},o.onerror=r,document.body.appendChild(o)})}},{key:"load3DSound",value:function(t,e,n,i,r){return this.loadSource(t,e).then(this.create3DSound.bind(this,n,i,r))}},{key:"loadFixedSound",value:function(t,e){return this.loadSource(t,e).then(this.createFixedSound.bind(this))}},{key:"playBufferImmediate",value:function(t,e){var n=this,i=this.createSound(!1,t);return i=this.createFixedSound(i),i.volume.gain.value=e,i.source.addEventListener("ended",function(t){i.volume.disconnect(n.mainVolume)}),i.source.start(0),i}}],[{key:"setAudioStream",value:function(t){var e=document.querySelectorAll("audio").length,n=Primrose.DOM.cascadeElement("audioStream"+e,"audio",HTMLAudioElement,!0);return n.autoplay=!0,isFirefox?n.srcObject=t:n.src=URL.createObjectURL(t),n.setAttribute("muted",""),t}}]),n}();window.Primrose.Output.Audio3D=n}(),function(){"use strict";function t(e){function n(t){if(t.valid){i=t.hands.length>0;for(var n=0;n<e.hands&&n<t.hands.length;++n)for(var r=t.hands[n],o=0;o<e.fingers;++o)for(var a=r.fingers[o],u=0;u<e.joints;++u){var c=n*e.fingers*e.joints+o*e.joints+u;if(c<this.tips.length){var h=a[s[u]],l=this.tips[c];l.position.set(h[0],h[1],h[2])}}}}e.port=e.port||t.DEFAULT_PORT,e.addr=e.addr||t.DEFAULT_HOST,this.tips=[],this.numJoints=e.hands*e.fingers*e.joints;var i=!1,r=!1;Leap.loop(),this.setEnvironment=function(t){e.world=t.world,e.scene=t.scene,e.camera=t.camera,Leap.loopController.on("frame",n.bind(this))};var o,s=["tipPosition","dipPosition","pipPosition","mcpPosition","carpPosition"],a=0;80!==e.port&&(e.addr+=":"+e.port),o=io.connect(e.addr,{reconnect:!0,"reconnection delay":1e3,"max reconnection attempts":5}),o.on("connect",function(){r=!0,console.log("Connected!")}),o.on("disconnect",function(){r=!1,console.log("Disconnected!")}),this.readContacts=function(t){for(var n=0,r=0;i&&n<2&&r<t.length;++r)for(var o=t[r],s=0;s<e.hands&&n<2;++s)for(var a=0;a<e.fingers;++a){var u=this.tips[a],c=!1;o.bi===u&&o.bj.graphics&&o.bj.graphics.isSolid&&(this.setFingerState(a,!0),c=!0,++n),c||this.setFingerState(a,!1)}},this.setFingerState=function(t,e){var n=1<<t;e?a|=n:a=a&~n&31,r&&o.emit("data",a)}}t.DEFAULT_PORT=8383,t.DEFAULT_HOST=document.location.hostname,window.Primrose.Output.HapticGlove=t}(),function(){"use strict";function t(t){return 440*Math.pow(n,t-49)}function e(t,e,n){if(this.audio=t||new AudioContext,this.audio&&this.audio.createGain){void 0===n&&(n=i),void 0===e&&(e="sawtooth"),this.available=!0,this.mainVolume=this.audio.createGain(),this.mainVolume.connect(this.audio.destination),this.numNotes=n,this.oscillators=[];for(var r=0;r<this.numNotes;++r){var o=this.audio.createOscillator(),s=this.audio.createGain();o.type=e,o.frequency.value=0,o.connect(s),o.start(),s.connect(this.mainVolume),this.oscillators.push({osc:o,gn:s,timeout:null})}}else this.available=!1}Window.prototype.AudioContext=Window.prototype.AudioContext||Window.prototype.webkitAudioContext||function(){};var n=Math.pow(2,1/12),i=(navigator.maxTouchPoints||10)+1;e.prototype.noteOn=function(e,n,i){if(this.available){void 0===i&&(i=0);var r=this.oscillators[i%this.numNotes],o=t(parseFloat(n)+1);return r.gn.gain.value=e,r.osc.frequency.setValueAtTime(o,0),r}},e.prototype.noteOff=function(t){if(this.available){void 0===t&&(t=0);var e=this.oscillators[t%this.numNotes];e.osc.frequency.setValueAtTime(0,0)}},e.prototype.play=function(t,e,n,i){if(this.available){"number"!=typeof i&&(i=0);var r=this.noteOn(e,t,i);r.timeout&&(clearTimeout(r.timeout),r.timeout=null),r.timeout=setTimeout(function(t,e){this.noteOff(t),e.timeout=null}.bind(this,i,r),1e3*n)}},window.Primrose.Output.Music=e}(),function(){"use strict";function t(t,e,n,i){return void 0===t[e]?t[e]=n+(i-n)*Math.random():t[e]=Math.min(i,Math.max(n,t[e])),t[e]}var e=null;try{e=function(e){e=e||{};var n=speechSynthesis.getVoices().filter(function(t){return t.default||t.localService}.bind(this)),i=n[Math.floor(t(e,"voice",0,n.length))];this.speak=function(n,r){var o=new SpeechSynthesisUtterance;o.voice=i,o.volume=t(e,"volume",1,1),o.rate=t(e,"rate",.1,5),o.pitch=t(e,"pitch",0,2),o.text=n,o.onend=r,speechSynthesis.speak(o)}}}catch(t){console.error(t),e=function(){this.speak=function(){}}}window.Primrose.Output.Speech=e}(),function(){"use strict";function t(){return(Math.random()*Math.log(Number.MAX_VALUE)).toString(36).replace(".","")}window.Primrose.Random.ID=t}(),function(){"use strict";function t(){var t=Primrose.Random.int(0,256),e=Primrose.Random.int(0,256),n=Primrose.Random.int(0,256);return t<<16|e<<8|n}window.Primrose.Random.color=t}(),function(){"use strict";function t(t,e,n){n=n||1,void 0===e&&(e=t,t=0);var i=e-t,r=Math.pow(Math.random(),n);return Math.floor(t+r*i)}window.Primrose.Random.int=t}(),function(){"use strict";function t(t){return t[Primrose.Random.int(t.length)]}window.Primrose.Random.item=t}(),function(){"use strict";function t(t,e){return Math.random()*(e-t)+t}window.Primrose.Random.number=t}(),function(){"use strict";function t(t,e,n){return t+Primrose.Random.int(0,(1+e-t)/n)*n}window.Primrose.Random.steps=t}(),function(){"use strict";function t(t,n,i){function r(t,e,n){e.selectedText=t}this.name=t,this.language=n;var o={NORMAL:{65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z"},SHIFT:{65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z"}};copyObject(o,i);for(var s,a,u,c=0;c<=9;++c)a=Primrose.Keys["NUMPAD"+c],o.NORMAL[a]=c.toString();o.NORMAL[Primrose.Keys.MULTIPLY]="*",o.NORMAL[Primrose.Keys.ADD]="+",o.NORMAL[Primrose.Keys.SUBTRACT]="-",o.NORMAL[Primrose.Keys.DECIMALPOINT]=".",o.NORMAL[Primrose.Keys.DIVIDE]="/",this.keyNames={},this.commandNames=[];for(s in Primrose.Keys)a=Primrose.Keys[s],isNaN(a)||(this.keyNames[a]=s);for(var h in o){var l=o[h];if("object"===("undefined"==typeof l?"undefined":e(l)))for(a in l){if(a.indexOf("_")>-1){var f=a.split(" "),d=f[0];a=f[1],s=o.NORMAL[a],u=d+"_"+h+" "+s}else s=o.NORMAL[a],u=h+"_"+s;this.commandNames.push(u),this.keyNames[a]=s;var m=l[a];"function"!=typeof m&&(m=r.bind(null,m)),this[u]=m}}}var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};t.DEAD=function(t){return function(e){e.setDeadKeyState("DEAD"+t)}},window.Primrose.Text.CodePage=t}(),function(){"use strict";var t={};window.Primrose.Text.CodePages=t}(),function(){"use strict";function t(t,e){this.name=t,copyObject(this,e)}window.Primrose.Text.CommandPack=t}(),function(){"use strict";var t={};window.Primrose.Text.CommandPacks=t}(),function(){"use strict";var t={};window.Primrose.Text.Controls=t}(),function(){"use strict";function t(t,e,n){this.i=t||0,this.x=e||0,this.y=n||0,this.moved=!0}var e=function(){function t(i){i=i.replace(e,function(e,n,i){return t(i)+n}).replace(n,"$2$1");for(var r="",o=i.length-1;o>=0;--o)r+=i[o];return r}var e=/(<%= allExceptCombiningMarks %>)(<%= combiningMarks %>+)/g,n=/(<%= highSurrogates %>)(<%= lowSurrogates %>)/g;return t}();t.min=function(t,e){return t.i<=e.i?t:e},t.max=function(t,e){return t.i>e.i?t:e},t.prototype.clone=function(){return new t(this.i,this.x,this.y)},t.prototype.toString=function(){return"[i:"+this.i+" x:"+this.x+" y:"+this.y+"]"},t.prototype.copy=function(t){this.i=t.i,this.x=t.x,this.y=t.y,this.moved=!1},t.prototype.fullhome=function(){this.i=0,this.x=0,this.y=0,this.moved=!0},t.prototype.fullend=function(t){this.i=0;for(var e=0,n=0;n<t.length;++n){var i=t[n];e=i.length,this.i+=e}this.y=t.length-1,this.x=e,this.moved=!0},t.prototype.skipleft=function(t){if(0===this.x)this.left(t);else{var n=this.x-1,i=t[this.y],r=e(i.substring(0,n)),o=r.match(/(\s|\W)+/),s=o?o.index+o[0].length+1:r.length;this.i-=s,this.x-=s}this.moved=!0},t.prototype.left=function(t){if(this.i>0){if(--this.i,--this.x,this.x<0){--this.y;var e=t[this.y];this.x=e.length}this.reverseFromNewline(t)&&++this.i}this.moved=!0},t.prototype.skipright=function(t){var e=t[this.y];if(this.x===e.length||"\n"===e[this.x])this.right(t);else{var n=this.x+1;e=e.substring(n);var i=e.match(/(\s|\W)+/),r=i?i.index+i[0].length+1:e.length-this.x;this.i+=r,this.x+=r,this.reverseFromNewline(t)}this.moved=!0},t.prototype.fixCursor=function(t){this.x=this.i,this.y=0;for(var e=0,n=t[this.y];this.x>n.length;){if(this.x-=n.length,e+=n.length,this.y>=t.length-1){this.i=e,this.x=n.length,this.moved=!0;break}++this.y,n=t[this.y]}return this.moved},t.prototype.right=function(t){this.advanceN(t,1)},t.prototype.advanceN=function(t,e){var n=t[this.y];(this.y<t.length-1||this.x<n.length)&&(this.i+=e,this.fixCursor(t),n=t[this.y],this.x>0&&"\n"===n[this.x-1]&&(++this.y,this.x=0)),this.moved=!0},t.prototype.home=function(){this.i-=this.x,this.x=0,this.moved=!0},t.prototype.end=function(t){var e=t[this.y],n=e.length-this.x;this.i+=n,this.x+=n,this.reverseFromNewline(t),this.moved=!0},t.prototype.up=function(t){if(this.y>0){--this.y;var e=t[this.y],n=Math.min(0,e.length-this.x);this.x+=n,this.i-=e.length-n,this.reverseFromNewline(t)}this.moved=!0},t.prototype.down=function(t){if(this.y<t.length-1){++this.y;var e=t[this.y],n=t[this.y-1],i=Math.min(0,e.length-this.x);this.x+=i,this.i+=n.length+i,this.reverseFromNewline(t)}this.moved=!0},t.prototype.incY=function(t,e){this.y=Math.max(0,Math.min(e.length-1,this.y+t));var n=e[this.y];this.x=Math.max(0,Math.min(n.length,this.x)),this.i=this.x;for(var i=0;i<this.y;++i)this.i+=e[i].length;this.reverseFromNewline(e),this.moved=!0},t.prototype.setXY=function(t,e,n){this.y=Math.max(0,Math.min(n.length-1,e));var i=n[this.y];this.x=Math.max(0,Math.min(i.length,t)),this.i=this.x;for(var r=0;r<this.y;++r)this.i+=n[r].length;this.reverseFromNewline(n),this.moved=!0},t.prototype.setI=function(t,e){this.i=t,this.fixCursor(e),this.moved=!0},t.prototype.reverseFromNewline=function(t){var e=t[this.y];return this.x>0&&"\n"===e[this.x-1]&&(--this.x,--this.i,!0)},window.Primrose.Text.Cursor=t}(),function(){"use strict";function t(e,n){function i(t){var e,n,i=null,r=null,o=0;for(e=0;e<t.length;++e)n=t[e],n.line=o,"newlines"===n.type&&++o,r?("stringDelim"!==n.type||n.value!==r||0!==e&&"\\"===t[e-1].value[t[e-1].value.length-1]||(r=null),"newlines"!==n.type&&(n.type="strings")):i?(("startBlockComments"===i&&"endBlockComments"===n.type||"startLineComments"===i&&"newlines"===n.type)&&(i=null),"newlines"!==n.type&&(n.type="comments")):"stringDelim"===n.type?(r=n.value,n.type="strings"):"startBlockComments"!==n.type&&"startLineComments"!==n.type||(i=n.type,n.type="comments");for(e=t.length-1;e>0;--e){var s=t[e-1];n=t[e],s.type===n.type&&"newlines"!==s.type&&(s.value+=n.value,t.splice(e,1))}}this.name=e,this.grammar=n.map(function(t){return new Primrose.Text.Rule(t[0],t[1])}),t.prototype.toHTML=function(t,e){e=e||Primrose.Text.Themes.Default;for(var n=this.tokenize(t),i=document.createElement("div"),r=0;r<n.length;++r){var o=n[r];if("newlines"===o.type)i.appendChild(document.createElement("br"));else{var s=e[o.type]||{},a=document.createElement("span");a.style.fontWeight=s.fontWeight||e.regular.fontWeight,a.style.fontStyle=s.fontStyle||e.regular.fontStyle||"",a.style.color=s.foreColor||e.regular.foreColor,a.style.backgroundColor=s.backColor||e.regular.backColor,a.style.fontFamily=s.fontFamily||e.fontFamily,a.appendChild(document.createTextNode(o.value)),i.appendChild(a)}}return i.innerHTML},this.tokenize=function(t){for(var e=[new Primrose.Text.Token(t,"regular",0)],n=0;n<this.grammar.length;++n)for(var r=this.grammar[n],o=0;o<e.length;++o)r.carveOutMatchedToken(e,o);return i(e),e}}window.Primrose.Text.Grammar=t}(),function(){"use strict";var t={};window.Primrose.Text.Grammars=t}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var e=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),n=function(){function n(e,i,r,o,s,a,u,c,h,l){t(this,n);var f=s;s=s.length>0?s:"NORMAL",this[i+"_a"]="SELECT_ALL",this[i+"_c"]="COPY",this[i+"_x"]="CUT",this[i+"_v"]="PASTE",this[o]="REDO",this[i+"_z"]="UNDO",this[i+"_DOWNARROW"]="WINDOW_SCROLL_DOWN",this[i+"_UPARROW"]="WINDOW_SCROLL_UP",this[r+"_LEFTARROW"]="NORMAL_SKIPLEFT",this[r+"SHIFT_LEFTARROW"]="SHIFT_SKIPLEFT",this[r+"_RIGHTARROW"]="NORMAL_SKIPRIGHT",this[r+"SHIFT_RIGHTARROW"]="SHIFT_SKIPRIGHT",this[s+"_HOME"]="NORMAL_HOME",this[f+"SHIFT_HOME"]="SHIFT_HOME",this[s+"_END"]="NORMAL_END",this[f+"SHIFT_END"]="SHIFT_END",this[c+"_HOME"]="CTRL_HOME",this[c+"SHIFT_HOME"]="CTRLSHIFT_HOME",this[c+"_END"]="CTRL_END",this[c+"SHIFT_END"]="CTRLSHIFT_END",this._deadKeyState=""}return e(n,[{key:"makeCommandName",value:function(t,e){var n=t.keyCode;if(n!==Primrose.Keys.CTRL&&n!==Primrose.Keys.ALT&&n!==Primrose.Keys.META_L&&n!==Primrose.Keys.META_R&&n!==Primrose.Keys.SHIFT){var i=(this._deadKeyState,this._deadKeyState);return t.ctrlKey&&(i+="CTRL"),t.altKey&&(i+="ALT"),t.metaKey&&(i+="META"),t.shiftKey&&(i+="SHIFT"),i===this._deadKeyState&&(i+="NORMAL"),i+="_"+e.keyNames[n],this[i]||i}}}]),n}();window.Primrose.Text.OperatingSystem=n}(),function(){"use strict";var t={};window.Primrose.Text.OperatingSystems=t}(),function(){"use strict";function t(t,e){this.set(t||0,e||0)}t.prototype.set=function(t,e){this.x=t,this.y=e},t.prototype.copy=function(t){t&&(this.x=t.x,this.y=t.y)},t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.toString=function(){return"(x:"+this.x+", y:"+this.y+")"},window.Primrose.Text.Point=t}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var e=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),n=function(){function n(e,i,r,o){t(this,n),this.point=new Primrose.Text.Point(e,i),this.size=new Primrose.Text.Size(r,o)}return e(n,[{key:"set",value:function(t,e,n,i){this.point.set(t,e),this.size.set(n,i)}},{key:"copy",value:function(t){t&&(this.point.copy(t.point),this.size.copy(t.size))}},{key:"clone",value:function(){return new n(this.point.x,this.point.y,this.size.width,this.size.height)}},{key:"toString",value:function(){return"["+this.point.toString()+" x "+this.size.toString()+"]"}},{key:"overlap",value:function(t){var e=Math.max(this.left,t.left),i=Math.max(this.top,t.top),r=Math.min(this.right,t.right),o=Math.min(this.bottom,t.bottom);if(r>e&&o>i)return new n(e,i,r-e,o-i)}},{key:"x",get:function(){return this.point.x},set:function(t){this.point.x=t}},{key:"left",get:function(){return this.point.x},set:function(t){this.point.x=t}},{key:"width",get:function(){return this.size.width},set:function(t){this.size.width=t}},{key:"right",get:function(){return this.point.x+this.size.width},set:function(t){this.point.x=t-this.size.width}},{key:"y",get:function(){return this.point.y},set:function(t){this.point.y=t}},{key:"top",get:function(){return this.point.y},set:function(t){this.point.y=t}},{key:"height",get:function(){return this.size.height},set:function(t){this.size.height=t}},{key:"bottom",get:function(){return this.point.y+this.size.height},set:function(t){this.point.y=t-this.size.height}},{key:"area",get:function(){return this.width*this.height}}]),n}();window.Primrose.Text.Rectangle=n}(),function(){"use strict";function t(t,e){this.name=t,this.test=e}t.prototype.carveOutMatchedToken=function(t,e){var n=t[e];if("regular"===n.type){var i=this.test.exec(n.value);if(i){var r=i[i.length-1],o=i.input.indexOf(r),s=o+r.length;if(0===o){if(n.type=this.name,s<n.value.length){var a=n.splitAt(s);a.type="regular",t.splice(e+1,0,a)}}else{var u=n.splitAt(o);if(r.length<u.value.length){var c=u.splitAt(r.length);t.splice(e+1,0,c)}u.type=this.name,t.splice(e+1,0,u)}}}},window.Primrose.Text.Rule=t}(),function(){"use strict";function t(t,e){this.set(t||0,e||0)}t.prototype.set=function(t,e){this.width=t,this.height=e},t.prototype.copy=function(t){t&&(this.width=t.width,this.height=t.height)},t.prototype.clone=function(){return new t(this.width,this.height)},t.prototype.toString=function(){return"<w:"+this.width+", h:"+this.height+">"},window.Primrose.Text.Size=t}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var e=function e(n,i){function r(t){t.selectionStart=t.selectionEnd=t.value.length,t.scrollIntoView(t.frontCursor)}function o(){v.running&&(a(),v.running=!1,g&&(n.tokenizer=f,n.value=l),r(n))}function s(){return i.selectionStart=i.selectionEnd=0,i.value="",!0}function a(){if(y.length>0){for(var t=y.split("\n"),e=0;e<m&&t.length>0;++e)p.push(t.shift());t.length>0&&p.push(" ----- more -----"),y=t.join("\n")}}function u(t){h=t,v.waitingForInput=!0,a()}function c(t){y+=t}t(this,e),i=i||n;var h=null,l=null,f=null,d=0,m=40,p=[],y="",g=n===i,v=this;this.running=!1,this.waitingForInput=!1,this.sendInput=function(t){if(y.length>0)a();else{i.keyDown(t);var e=i.value.substring(d);h(e.trim()),h=null,this.waitingForInput=!1}},this.execute=function(){if(m=10,f=n.tokenizer,f&&f.interpret){this.running=!0;var t,e=function(){v.running&&setTimeout(t,1)};l=n.value,t=f.interpret(l,u,c,c,e,s,this.loadFile.bind(this),o),i.tokenizer=Primrose.Text.Grammars.PlainText,s(),e()}},this.loadFile=function(t){return Primrose.HTTP.getText(t.toLowerCase()).then(function(t){return isOSX&&(t=t.replace("CTRL+SHIFT+SPACE","CMD+OPT+E")),n.value=l=t,t})},this.update=function(){p.length>0&&(i.value+=p.shift()+"\n",r(i),d=i.selectionStart)}};window.Primrose.Text.Terminal=e}(),function(){"use strict";var t={};window.Primrose.Text.Themes=t}(),function(){"use strict";function t(t,e,n,i){this.value=t,this.type=e,this.index=n,this.line=i}t.prototype.clone=function(){return new t(this.value,this.type,this.index,this.line)},t.prototype.splitAt=function(e){var n=this.value.substring(e);return this.value=this.value.substring(0,e),new t(n,this.type,this.index+e,this.line)},t.prototype.toString=function(){return"["+this.type+": "+this.value+"]"},window.Primrose.Text.Token=t}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=0,o=512,s=150,a=function(a){function u(){t(this,u);var n=e(this,Object.getPrototypeOf(u).call(this,{id:"Primrose.X.LoginForm["+r++ +"]",bounds:new Primrose.Text.Rectangle(0,0,o,s)}));return n.listeners.login=[],n.listeners.signup=[],n.labelUserName=new Primrose.Controls.AbstractLabel({id:n.id+"-labelUserName",bounds:new Primrose.Text.Rectangle(0,0,o/2,s/3),fontSize:32,value:"User name:",textAlign:"right"}),n.userName=new Primrose.Text.Controls.TextInput({id:n.id+"-userName",bounds:new Primrose.Text.Rectangle(o/2,0,o/2,s/3),fontSize:32}),n.labelPassword=new Primrose.Controls.AbstractLabel({id:n.id+"-labelPassword",bounds:new Primrose.Text.Rectangle(0,s/3,o/2,s/3),fontSize:32,value:"Password:",textAlign:"right"}),n.password=new Primrose.Text.Controls.TextInput({id:n.id+"-password",bounds:new Primrose.Text.Rectangle(o/2,s/3,o/2,s/3),fontSize:32,passwordCharacter:"*"}),n.signupButton=new Primrose.Controls.Button2D({id:n.id+"-signupButton",bounds:new Primrose.Text.Rectangle(0,2*s/3,o/2,s/3),fontSize:32,value:"Sign up"}),n.loginButton=new Primrose.Controls.Button2D({id:n.id+"-loginButton",bounds:new Primrose.Text.Rectangle(o/2,2*s/3,o/2,s/3),fontSize:32,value:"Login"}),n.loginButton.addEventListener("click",function(t){return emit.call(n,"login",{target:n})},!1),n.signupButton.addEventListener("click",function(t){return emit.call(n,"signup",{target:n})},!1),n.appendChild(n.labelUserName),n.appendChild(n.userName),n.appendChild(n.labelPassword),n.appendChild(n.password),n.appendChild(n.signupButton),n.appendChild(n.loginButton),n}return n(u,a),i(u,null,[{key:"create",value:function(){return new u}}]),u}(Primrose.Controls.Form);window.Primrose.X.LoginForm=a}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=512,r=200,o=0,s=function(s){function a(){t(this,a);var n=e(this,Object.getPrototypeOf(a).call(this,{id:"Primrose.X.SignupForm["+o++ +"]",bounds:new Primrose.Text.Rectangle(0,0,i,r)}));return n.listeners.login=[],n.listeners.signup=[],
n.labelEmail=new Primrose.Controls.AbstractLabel({id:n.id+"-labelEmail",bounds:new Primrose.Text.Rectangle(0,0,i/2,r/4),fontSize:32,value:"Email:",textAlign:"right"}),n.email=new Primrose.Text.Controls.TextInput({id:n.id+"-email",bounds:new Primrose.Text.Rectangle(i/2,0,i/2,r/4),fontSize:32}),n.labelUserName=new Primrose.Controls.AbstractLabel({id:n.id+"-labelUserName",bounds:new Primrose.Text.Rectangle(0,r/4,i/2,r/4),fontSize:32,value:"User name:",textAlign:"right"}),n.userName=new Primrose.Text.Controls.TextInput({id:n.id+"-userName",bounds:new Primrose.Text.Rectangle(i/2,r/4,i/2,r/4),fontSize:32}),n.labelPassword=new Primrose.Controls.AbstractLabel({id:n.id+"-labelPassword",bounds:new Primrose.Text.Rectangle(0,r/2,i/2,r/4),fontSize:32,value:"Password:",textAlign:"right"}),n.password=new Primrose.Text.Controls.TextInput({id:n.id+"-password",bounds:new Primrose.Text.Rectangle(i/2,r/2,i/2,r/4),fontSize:32,passwordCharacter:"*"}),n.loginButton=new Primrose.Controls.Button2D({id:n.id+"-loginButton",bounds:new Primrose.Text.Rectangle(0,3*r/4,i/2,r/4),fontSize:32,value:"Log in"}),n.signupButton=new Primrose.Controls.Button2D({id:n.id+"-signupButton",bounds:new Primrose.Text.Rectangle(i/2,3*r/4,i/2,r/4),fontSize:32,value:"Sign up"}),n.loginButton.addEventListener("click",function(t){return emit.call(n,"login",{target:n})},!1),n.signupButton.addEventListener("click",function(t){return emit.call(n,"signup",{target:n})},!1),n.appendChild(n.labelUserName),n.appendChild(n.userName),n.appendChild(n.labelEmail),n.appendChild(n.email),n.appendChild(n.labelPassword),n.appendChild(n.password),n.appendChild(n.loginButton),n.appendChild(n.signupButton),n}return n(a,s),a}(Primrose.Controls.Form);window.Primrose.X.SignupForm=s}(),function(){"use strict";var t=Primrose.Text.CodePage,e=new t("Deutsch: QWERTZ","de",{deadKeys:[220,221,160,192],NORMAL:{32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",60:"<",63:"",160:t.DEAD(3),163:"#",171:"+",173:"-",186:"",187:"+",188:",",189:"-",190:".",191:"#",192:t.DEAD(4),219:"",220:t.DEAD(1),221:t.DEAD(2),222:"",226:"<"},DEAD1NORMAL:{65:"",69:"",73:"",79:"",85:"",190:"."},DEAD2NORMAL:{65:"",69:"",73:"",79:"",83:"s",85:"",89:""},SHIFT:{32:" ",48:"=",49:"!",50:'"',51:"",52:"$",53:"%",54:"&",55:"/",56:"(",57:")",60:">",63:"?",163:"'",171:"*",173:"_",186:"",187:"*",188:";",189:"_",190:":",191:"'",192:"",219:"?",222:"",226:">"},CTRLALT:{48:"}",50:"",51:"",55:"{",56:"[",57:"]",60:"|",63:"\\",69:"",77:"",81:"@",171:"~",187:"~",219:"\\",226:"|"},CTRLALTSHIFT:{63:"",219:""},DEAD3NORMAL:{65:"a",69:"e",73:"i",79:"o",85:"u",190:"."},DEAD4NORMAL:{65:"a",69:"e",73:"i",79:"o",83:"s",85:"u",89:"y"}});window.Primrose.Text.CodePages.DE_QWERTZ=e}(),function(){"use strict";var t=Primrose.Text.CodePage,e=new t("English: UK Extended","en-GB",{CTRLALT:{52:"",65:"",69:"",73:"",79:"",85:"",163:"\\",192:"",222:"\\",223:""},CTRLALTSHIFT:{65:"",69:"",73:"",79:"",85:"",222:"|"},NORMAL:{32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",163:"#",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"'",219:"[",220:"\\",221:"]",222:"#",223:"`"},SHIFT:{32:" ",48:")",49:"!",50:'"',51:"",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",163:"~",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"@",219:"{",220:"|",221:"}",222:"~",223:""}});window.Primrose.Text.CodePages.EN_UKX=e}(),function(){"use strict";var t=Primrose.Text.CodePage,e=new t("English: USA","en-US",{NORMAL:{32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'"},SHIFT:{32:" ",48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",219:"{",220:"|",221:"}",222:'"'}});window.Primrose.Text.CodePages.EN_US=e}(),function(){"use strict";var t=Primrose.Text.CodePage,e=new t("Franais: AZERTY","fr",{deadKeys:[221,50,55],NORMAL:{32:" ",48:"",49:"&",50:"",51:'"',52:"'",53:"(",54:"-",55:"",56:"_",57:"",186:"$",187:"=",188:",",190:";",191:":",192:"",219:")",220:"*",221:t.DEAD(1),222:"",223:"!",226:"<"},SHIFT:{32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",186:"",187:"+",188:"?",190:".",191:"/",192:"%",219:"",220:"",223:"",226:">"},CTRLALT:{48:"@",50:t.DEAD(2),51:"#",52:"{",53:"[",54:"|",55:t.DEAD(3),56:"\\",57:"^",69:"",186:"",187:"}",219:"]"},DEAD1NORMAL:{65:"",69:"",73:"",79:"",85:""},DEAD2NORMAL:{65:"",78:"",79:""},DEAD3NORMAL:{48:"",50:"",55:"",65:"",69:"",73:"",79:"",85:""}});window.Primrose.Text.CodePages.FR_AZERTY=e}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(i){function r(n,i){t(this,r);var o={NORMAL_LEFTARROW:function(t,e){t.cursorLeft(e,t.frontCursor)},NORMAL_SKIPLEFT:function(t,e){t.cursorSkipLeft(e,t.frontCursor)},NORMAL_RIGHTARROW:function(t,e){t.cursorRight(e,t.frontCursor)},NORMAL_SKIPRIGHT:function(t,e){t.cursorSkipRight(e,t.frontCursor)},NORMAL_HOME:function(t,e){t.cursorHome(e,t.frontCursor)},NORMAL_END:function(t,e){t.cursorEnd(e,t.frontCursor)},NORMAL_BACKSPACE:function(t,e){t.frontCursor.i===t.backCursor.i&&t.frontCursor.left(e),t.selectedText="",t.scrollIntoView(t.frontCursor)},NORMAL_ENTER:function(t,e,n){emit.call(t,"change",{target:t})},NORMAL_DELETE:function(t,e){t.frontCursor.i===t.backCursor.i&&t.backCursor.right(e),t.selectedText="",t.scrollIntoView(t.frontCursor)},NORMAL_TAB:function(t,e){t.selectedText=t.tabString},SHIFT_LEFTARROW:function(t,e){t.cursorLeft(e,t.backCursor)},SHIFT_SKIPLEFT:function(t,e){t.cursorSkipLeft(e,t.backCursor)},SHIFT_RIGHTARROW:function(t,e){t.cursorRight(e,t.backCursor)},SHIFT_SKIPRIGHT:function(t,e){t.cursorSkipRight(e,t.backCursor)},SHIFT_HOME:function(t,e){t.cursorHome(e,t.backCursor)},SHIFT_END:function(t,e){t.cursorEnd(e,t.backCursor)},SHIFT_DELETE:function(t,e){t.frontCursor.i===t.backCursor.i&&(t.frontCursor.home(e),t.backCursor.end(e)),t.selectedText="",t.scrollIntoView(t.frontCursor)},CTRL_HOME:function(t,e){t.cursorFullHome(e,t.frontCursor)},CTRL_END:function(t,e){t.cursorFullEnd(e,t.frontCursor)},CTRLSHIFT_HOME:function(t,e){t.cursorFullHome(e,t.backCursor)},CTRLSHIFT_END:function(t,e){t.cursorFullEnd(e,t.backCursor)},SELECT_ALL:function(t,e){t.frontCursor.fullhome(e),t.backCursor.fullend(e)},REDO:function(t,e){t.redo(),t.scrollIntoView(t.frontCursor)},UNDO:function(t,e){t.undo(),t.scrollIntoView(t.frontCursor)}};if(i)for(var s in i)o[s]=i[s];return e(this,Object.getPrototypeOf(r).call(this,n||"Text editor commands",o))}return n(r,i),r}(Primrose.Text.CommandPack);window.Primrose.Text.CommandPacks.BasicTextInput=i}(),function(){"use strict";var t=new Primrose.Text.CommandPacks.BasicTextInput("Text Area input commands",{NORMAL_UPARROW:function(t,e){t.cursorUp(e,t.frontCursor)},NORMAL_DOWNARROW:function(t,e){t.cursorDown(e,t.frontCursor)},NORMAL_PAGEUP:function(t,e){t.cursorPageUp(e,t.frontCursor)},NORMAL_PAGEDOWN:function(t,e){t.cursorPageDown(e,t.frontCursor)},NORMAL_ENTER:function(t,e,n){var i="",r=e[t.frontCursor.y];r.length>0&&"whitespace"===r[0].type&&(i=r[0].value),t.selectedText="\n"+i,t.scrollIntoView(t.frontCursor)},SHIFT_UPARROW:function(t,e){t.cursorUp(e,t.backCursor)},SHIFT_DOWNARROW:function(t,e){t.cursorDown(e,t.backCursor)},SHIFT_PAGEUP:function(t,e){t.cursorPageUp(e,t.backCursor)},SHIFT_PAGEDOWN:function(t,e){t.cursorPageDown(e,t.backCursor)},WINDOW_SCROLL_DOWN:function(t,e){t.scroll.y<e.length&&++t.scroll.y},WINDOW_SCROLL_UP:function(t,e){t.scroll.y>0&&--t.scroll.y}});window.Primrose.Text.CommandPacks.TextEditor=t}(),function(){"use strict";var t=new Primrose.Text.CommandPacks.BasicTextInput("Text Line input commands");window.Primrose.Text.CommandPacks.TextInput=t}(),function(){"use strict";function t(t,e,n,i,r,o,s,a){t=t.replace(/\r\n/g,"\n");var u=t.split("\n");a=a||"center";var c=1e3*e,h=c*u.length,l=document.createElement("canvas"),f=l.getContext("2d");f.font=c+"px Arial";var d=f.measureText(t).width;l.width=d,l.height=h,f.font=.8*c+"px Arial","transparent"!==i&&(f.fillStyle=i,f.fillRect(0,0,l.width,l.height)),f.fillStyle=n;for(var m=0;m<u.length;++m)f.fillText(u[m],0,m*c);var p=new THREE.Texture(l);p.needsUpdate=!0;var y=new THREE.MeshBasicMaterial({map:p,transparent:"transparent"===i,useScreenCoordinates:!1,color:16777215,shading:THREE.FlatShading}),g=new THREE.PlaneGeometry(e*d/c,e*u.length);g.computeBoundingBox(),g.computeVertexNormals();var v=new THREE.Mesh(g,y);return"left"===a?r-=g.boundingBox.min.x:"right"===a&&(r+=g.boundingBox.min.x),v.position.set(r,o,s),v}window.Primrose.Text.Controls.PlainText=t}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,i)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(i)},r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),o=isFirefox?3:100,s=0,a=5,u=function(u){function c(n){t(this,c);var i=e(this,Object.getPrototypeOf(c).call(this,patch(n,{id:"Primrose.Text.Controls.TextBox["+s++ +"]"})));i.listeners.change=[],"string"==typeof n?i.options={value:i.options}:i.options=n||{},i.useCaching=!isFirefox||!isMobile;var r=function(t){var e=t.toLowerCase();this["cursor"+t]=function(t,n){n[e](t),this.scrollIntoView(n)}};["Left","Right","SkipLeft","SkipRight","Up","Down","Home","End","FullHome","FullEnd"].map(r.bind(i)),i.tokens=null,i.lines=null,i._commandPack=null,i._tokenRows=null,i._tokenHashes=null,i._tabString=null,i._currentTouchID=null,i._lineCountWidth=null,i._lastFont=null,i._lastText=null,i._lastCharacterWidth=null,i._lastCharacterHeight=null,i._lastGridBounds=null,i._lastPadding=null,i._lastFrontCursor=null,i._lastBackCursor=null,i._lastWidth=-1,i._lastHeight=-1,i._lastScrollX=-1,i._lastScrollY=-1,i._lastFocused=!1,i._lastThemeName=null,i._lastPointer=new Primrose.Text.Point,i._browser=isChrome?"CHROMIUM":isFirefox?"FIREFOX":isIE?"IE":isOpera?"OPERA":isSafari?"SAFARI":"UNKNOWN",i._pointer=new Primrose.Text.Point,i._deadKeyState="",i._history=[],i._historyFrame=-1,i._topLeftGutter=new Primrose.Text.Size,i._bottomRightGutter=new Primrose.Text.Size,i._dragging=!1,i._scrolling=!1,i._wheelScrollSpeed=4;var o=new Primrose.Text.Rectangle(0,0,i.bounds.width,i.bounds.height);return i._fg=new Primrose.Surface({id:i.id+"-fore",bounds:o}),i._fgCanvas=i._fg.canvas,i._fgfx=i._fg.context,i._bg=new Primrose.Surface({id:i.id+"-back",bounds:o}),i._bgCanvas=i._bg.canvas,i._bgfx=i._bg.context,i._trim=new Primrose.Surface({id:i.id+"-trim",bounds:o}),i._trimCanvas=i._trim.canvas,i._tgfx=i._trim.context,i._rowCache={},i._VSCROLL_WIDTH=2,i.tabWidth=i.options.tabWidth,i.showLineNumbers=!i.options.hideLineNumbers,i.showScrollBars=!i.options.hideScrollBars,i.wordWrap=!i.options.disableWordWrap,i.readOnly=!!i.options.readOnly,i.multiline=!i.options.singleLine,i.gridBounds=new Primrose.Text.Rectangle,i.frontCursor=new Primrose.Text.Cursor,i.backCursor=new Primrose.Text.Cursor,i.scroll=new Primrose.Text.Point,i.character=new Primrose.Text.Size,i.theme=i.options.theme,i.fontSize=i.options.fontSize,i.tokenizer=i.options.tokenizer,i.commandPack=i.options.commands||Primrose.Text.CommandPacks.TextEditor,i.value=i.options.value,i.padding=i.options.padding||1,i.addEventListener("focus",i.render.bind(i),!1),i.addEventListener("blur",i.render.bind(i),!1),i}return n(c,u),r(c,null,[{key:"create",value:function(){return new c}}]),r(c,[{key:"cursorPageUp",value:function(t,e){e.incY(-this.gridBounds.height,t),this.scrollIntoView(e)}},{key:"cursorPageDown",value:function(t,e){e.incY(this.gridBounds.height,t),this.scrollIntoView(e)}},{key:"setDeadKeyState",value:function(t){this._deadKeyState=t||""}},{key:"pushUndo",value:function(t){this._historyFrame<this._history.length-1&&this._history.splice(this._historyFrame+1),this._history.push(t),this._historyFrame=this._history.length-1,this.refreshTokens(),this.render()}},{key:"redo",value:function(){this._historyFrame<this._history.length-1&&++this._historyFrame,this.refreshTokens(),this.fixCursor(),this.render()}},{key:"undo",value:function(){this._historyFrame>0&&--this._historyFrame,this.refreshTokens(),this.fixCursor(),this.render()}},{key:"scrollIntoView",value:function(t){this.scroll.y+=this.minDelta(t.y,this.scroll.y,this.scroll.y+this.gridBounds.height),this.wordWrap||(this.scroll.x+=this.minDelta(t.x,this.scroll.x,this.scroll.x+this.gridBounds.width)),this.clampScroll()}},{key:"readWheel",value:function(t){this.focused&&((t.shiftKey||isChrome)&&(this.fontSize+=-t.deltaX/o),t.shiftKey&&!isChrome||(this.scroll.y+=Math.floor(t.deltaY*this._wheelScrollSpeed/o)),this.clampScroll(),this.render(),t.preventDefault())}},{key:"startPointer",value:function(t,e){i(Object.getPrototypeOf(c.prototype),"startPointer",this).call(this,t,e)||(this._dragging=!0,this.setCursorXY(this.frontCursor,t,e))}},{key:"movePointer",value:function(t,e){this._dragging&&this.setCursorXY(this.backCursor,t,e)}},{key:"endPointer",value:function(){i(Object.getPrototypeOf(c.prototype),"endPointer",this).call(this),this._dragging=!1,this._scrolling=!1}},{key:"copySelectedText",value:function(t){if(this.focused&&this.frontCursor.i!==this.backCursor.i){var e=t.clipboardData||window.clipboardData;e.setData(window.clipboardData?"Text":"text/plain",this.selectedText),t.returnValue=!1}}},{key:"cutSelectedText",value:function(t){this.focused&&(this.copySelectedText(t),this.readOnly||(this.selectedText=""))}},{key:"execCommand",value:function(t,e,n){if(n&&this.focused&&!this.readOnly){var i=t+"_"+n,r=this.commandPack[i]||this.commandPack[n]||e[i]||e[n];return(r instanceof String||"string"==typeof r)&&(console.log("okay"),r=this.commandPack[r]||this.commandPack[r]||r),void 0!==r&&(this.frontCursor.moved=!1,this.backCursor.moved=!1,r instanceof Function?r(this,this.lines):(r instanceof String||"string"==typeof r)&&(console.log(r),this.selectedText=r),this.frontCursor.moved&&!this.backCursor.moved&&this.backCursor.copy(this.frontCursor),this.clampScroll(),this.render(),!0)}}},{key:"readClipboard",value:function(t){if(this.focused&&!this.readOnly){t.returnValue=!1;var e=t.clipboardData||window.clipboardData,n=e.getData(window.clipboardData?"Text":"text/plain");n&&(this.selectedText=n)}}},{key:"resize",value:function(){i(Object.getPrototypeOf(c.prototype),"resize",this).call(this),this._bg.setSize(this.surfaceWidth,this.surfaceHeight),this._fg.setSize(this.surfaceWidth,this.surfaceHeight),this._trim.setSize(this.surfaceWidth,this.surfaceHeight),this.theme&&(this.character.height=this.fontSize,this.context.font=this.character.height+"px "+this.theme.fontFamily,this.character.width=this.context.measureText("MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM").width/100),this.render()}},{key:"pixel2cell",value:function(t){t.x*this.imageWidth/this.surfaceWidth,t.y*this.imageHeight/this.surfaceHeight;t.set(Math.round(t.x/this.character.width)+this.scroll.x-this.gridBounds.x,Math.floor(t.y/this.character.height-.25)+this.scroll.y)}},{key:"clampScroll",value:function(){if(this.scroll.y<0)this.scroll.y=0;else for(;0<this.scroll.y&&this.scroll.y>this.lines.length-this.gridBounds.height;)--this.scroll.y}},{key:"refreshTokens",value:function(){this.tokens=this.tokenizer.tokenize(this.value)}},{key:"fixCursor",value:function(){var t=this.frontCursor.fixCursor(this.lines)||this.backCursor.fixCursor(this.lines);t&&this.render()}},{key:"setCursorXY",value:function(t,e,n){e=Math.round(e),n=Math.round(n),this._pointer.set(e,n),this.pixel2cell(this._pointer,this.scroll,this.gridBounds);var i=this._pointer.x-this.scroll.x,r=this._pointer.y-this.scroll.y,o=r>=this.gridBounds.height,s=i<0,a=this._pointer.x>=this.gridBounds.width;if(this._scrolling||o||s||a){if(this._scrolling||a&&!o){this._scrolling=!0;var u=this.lines.length-this.gridBounds.height;if(r>=0&&u>=0){var c=r*u/this.gridBounds.height;this.scroll.y=Math.floor(c)}}else if(o&&!s){for(var h=0,l=0;l<this.lines.length;++l)h=Math.max(h,this.lines[l].length);var f=h-this.gridBounds.width;if(i>=0&&f>=0){var d=i*f/this.gridBounds.width;this.scroll.x=Math.floor(d)}}}else t.setXY(this._pointer.x,this._pointer.y,this.lines),this.backCursor.copy(t);this._lastPointer.copy(this._pointer),this.render()}},{key:"mouseButtonDown",value:function(t){0===t.button&&(this.startDOMPointer(t),t.preventDefault())}},{key:"mouseMove",value:function(t){this.focused&&this.moveDOMPointer(t)}},{key:"mouseButtonUp",value:function(t){this.focused&&0===t.button&&this.endPointer()}},{key:"touchStart",value:function(t){if(this.focused&&t.touches.length>0&&!this._dragging){var e=t.touches[0];this.startDOMPointer(e),this._currentTouchID=e.identifier}}},{key:"touchMove",value:function(t){for(var e=0;e<t.changedTouches.length&&this._dragging;++e){var n=t.changedTouches[e];if(n.identifier===this._currentTouchID){this.moveDOMPointer(n);break}}}},{key:"touchEnd",value:function(t){for(var e=0;e<t.changedTouches.length&&this._dragging;++e){var n=t.changedTouches[e];n.identifier===this._currentTouchID&&this.endPointer()}}},{key:"setGutter",value:function(){this.showLineNumbers?this._topLeftGutter.width=1:this._topLeftGutter.width=0,this.showScrollBars?this.wordWrap?this._bottomRightGutter.set(this._VSCROLL_WIDTH,0):this._bottomRightGutter.set(this._VSCROLL_WIDTH,1):this._bottomRightGutter.set(0,0)}},{key:"refreshGridBounds",value:function(){this._lineCountWidth=0,this.showLineNumbers&&(this._lineCountWidth=Math.max(1,Math.ceil(Math.log(this._history[this._historyFrame].length)/Math.LN10)));var t=Math.floor(this._topLeftGutter.width+this._lineCountWidth+this.padding/this.character.width),e=Math.floor(this.padding/this.character.height),n=Math.floor((this.imageWidth-2*this.padding)/this.character.width)-t-this._bottomRightGutter.width,i=Math.floor((this.imageHeight-2*this.padding)/this.character.height)-e-this._bottomRightGutter.height;this.gridBounds.set(t,e,n,i)}},{key:"performLayout",value:function(){this._tokenRows=[[]],this._tokenHashes=[""],this.lines=[""];for(var t=0,e=this.tokens.slice(),n=0;n<e.length;++n){var i=e[n].clone(),r=this.gridBounds.width-t,o=this.wordWrap&&"newlines"!==i.type&&i.value.length>r,s="newlines"===i.type||o;if(o){var a=i.value.length>this.gridBounds.width?r:0;e.splice(n+1,0,i.splitAt(a))}i.value.length>0&&(this._tokenRows[this._tokenRows.length-1].push(i),this._tokenHashes[this._tokenHashes.length-1]+=JSON.stringify(i),this.lines[this.lines.length-1]+=i.value,t+=i.value.length),s&&(this._tokenRows.push([]),this._tokenHashes.push(""),this.lines.push(""),t=0)}}},{key:"minDelta",value:function(t,e,n){var i=t-e,r=t-n+5,o=0;return(i<0||r>=0)&&(o=Math.abs(i)<Math.abs(r)?i:r),o}},{key:"fillRect",value:function(t,e,n,i,r,o){t.fillStyle=e,t.fillRect(n*this.character.width,i*this.character.height,r*this.character.width+1,o*this.character.height+1)}},{key:"strokeRect",value:function(t,e,n,i,r,o){t.strokeStyle=e,t.strokeRect(n*this.character.width,i*this.character.height,r*this.character.width+1,o*this.character.height+1)}},{key:"renderCanvasBackground",value:function(){var t=Primrose.Text.Cursor.min(this.frontCursor,this.backCursor),e=Primrose.Text.Cursor.max(this.frontCursor,this.backCursor),n=new Primrose.Text.Cursor,i=new Primrose.Text.Cursor,r=this.theme.regular.backColor?"fillRect":"clearRect",o=a/this.character.height;this.theme.regular.backColor&&(this._bgfx.fillStyle=this.theme.regular.backColor),this._bgfx[r](0,0,this.imageWidth,this.imageHeight),this._bgfx.save(),this._bgfx.translate((this.gridBounds.x-this.scroll.x)*this.character.width+this.padding,-this.scroll.y*this.character.height+this.padding),this.focused&&this.fillRect(this._bgfx,this.theme.regular.currentRowBackColor||Primrose.Text.Themes.Default.regular.currentRowBackColor,0,t.y+o,this.gridBounds.width,e.y-t.y+1);for(var s=0;s<this._tokenRows.length;++s){for(var u=this._tokenRows[s],c=0;c<u.length;++c){var h=u[c];if(i.x+=h.value.length,i.i+=h.value.length,this.scroll.y<=s&&s<this.scroll.y+this.gridBounds.height&&this.scroll.x<=i.x&&n.x<this.scroll.x+this.gridBounds.width){var l=t.i<=i.i&&n.i<e.i;if(l){var f=Primrose.Text.Cursor.max(t,n),d=Primrose.Text.Cursor.min(e,i),m=d.i-f.i;this.fillRect(this._bgfx,this.theme.regular.selectedBackColor||Primrose.Text.Themes.Default.regular.selectedBackColor,f.x,f.y+o,m,1)}}n.copy(i)}n.x=0,++n.y,i.copy(n)}if(this.focused){var p=this.theme.cursorColor||"black",y=1/this.character.width;this.fillRect(this._bgfx,p,t.x,t.y+o,y,1),this.fillRect(this._bgfx,p,e.x,e.y+o,y,1)}this._bgfx.restore()}},{key:"renderCanvasForeground",value:function(){var t=new Primrose.Text.Cursor,e=new Primrose.Text.Cursor;this._fgfx.clearRect(0,0,this.imageWidth,this.imageHeight),this._fgfx.save(),this._fgfx.translate((this.gridBounds.x-this.scroll.x)*this.character.width+this.padding,this.padding);for(var n=0;n<this._tokenRows.length;++n){for(var i=this.lines[n]+this.padding,r=this._tokenRows[n],o=!1,s=(n-this.scroll.y)*this.character.height,u=0;u<r.length;++u){var c=r[u];if(e.x+=c.value.length,e.i+=c.value.length,this.scroll.y<=n&&n<this.scroll.y+this.gridBounds.height&&this.scroll.x<=e.x&&t.x<this.scroll.x+this.gridBounds.width)if(this.useCaching&&void 0!==this._rowCache[i])0===u&&this._fgfx.putImageData(this._rowCache[i],this.padding,s+this.padding+a);else{var h=this.theme[c.type]||{},l=(h.fontWeight||this.theme.regular.fontWeight||"")+" "+(h.fontStyle||this.theme.regular.fontStyle||"")+" "+this.character.height+"px "+this.theme.fontFamily;this._fgfx.font=l.trim(),this._fgfx.fillStyle=h.foreColor||this.theme.regular.foreColor,this.drawText(this._fgfx,c.value,t.x*this.character.width,s),o=!0}t.copy(e)}t.x=0,++t.y,e.copy(t),this.useCaching&&o&&void 0===this._rowCache[i]&&(this._rowCache[i]=this._fgfx.getImageData(this.padding,s+this.padding+a,this.imageWidth-2*this.padding,this.character.height))}this._fgfx.restore()}},{key:"drawText",value:function(t,e,n,i){t.fillText(e,n,i)}},{key:"renderCanvasTrim",value:function(){var t=new Primrose.Text.Cursor,e=new Primrose.Text.Cursor,n=0;this._tgfx.clearRect(0,0,this.imageWidth,this.imageHeight),this._tgfx.save(),this._tgfx.translate(this.padding,this.padding),this._tgfx.save(),this._tgfx.lineWidth=2,this._tgfx.translate(0,-this.scroll.y*this.character.height);for(var i=0,r=-1;i<this._tokenRows.length;++i){for(var o=this._tokenRows[i],s=0;s<o.length;++s){var a=o[s];e.x+=a.value.length,e.i+=a.value.length,t.copy(e)}if(n=Math.max(n,e.x),t.x=0,++t.y,e.copy(t),this.showLineNumbers&&this.scroll.y<=i&&i<this.scroll.y+this.gridBounds.height){for(var u=o.length>0?o[0].line:r+1,c=u.toString();c.length<this._lineCountWidth;)c=" "+c;this.fillRect(this._tgfx,this.theme.regular.selectedBackColor||Primrose.Text.Themes.Default.regular.selectedBackColor,0,i,this.gridBounds.x,1),this._tgfx.font="bold "+this.character.height+"px "+this.theme.fontFamily,u>r&&(this._tgfx.fillStyle=this.theme.regular.foreColor,this._tgfx.fillText(c,0,i*this.character.height)),r=u}}if(this._tgfx.restore(),this.showLineNumbers&&this.strokeRect(this._tgfx,this.theme.regular.foreColor||Primrose.Text.Themes.Default.regular.foreColor,0,0,this.gridBounds.x,this.gridBounds.height),this.showScrollBars){var h=this.gridBounds.width*this.character.width-this.padding,l=this.gridBounds.height*this.character.height,f=this.scroll.x*h/n+this.gridBounds.x*this.character.width,d=this.scroll.y*l/this._tokenRows.length;this._tgfx.fillStyle=this.theme.regular.selectedBackColor||Primrose.Text.Themes.Default.regular.selectedBackColor;var m;if(!this.wordWrap&&n>this.gridBounds.width){var p=h*(this.gridBounds.width/n),y=this.gridBounds.height*this.character.height;m=Math.max(this.character.width,p),this._tgfx.fillRect(f,y,m,this.character.height),this._tgfx.strokeRect(f,y,m,this.character.height)}if(this._tokenRows.length>this.gridBounds.height){var g=l*(this.gridBounds.height/this._tokenRows.length),v=this.image-this._VSCROLL_WIDTH*this.character.width-2*this.padding,w=Math.max(this.character.height,g);m=this._VSCROLL_WIDTH*this.character.width,this._tgfx.fillRect(v,d,m,w),this._tgfx.strokeRect(v,d,m,w)}}this._tgfx.lineWidth=2,this._tgfx.restore(),this._tgfx.strokeRect(1,1,this.imageWidth-2,this.imageHeight-2),this.focused||(this._tgfx.fillStyle=this.theme.regular.unfocused||Primrose.Text.Themes.Default.regular.unfocused,this._tgfx.fillRect(0,0,this.imageWidth,this.imageHeight))}},{key:"render",value:function(){if(this.tokens&&this.theme){this.refreshGridBounds();var t=this.gridBounds.toString()!==this._lastGridBounds,e=this._lastText!==this.value,n=this.character.width!==this._lastCharacterWidth,i=this.character.height!==this._lastCharacterHeight,r=this.padding!==this._lastPadding,o=!this._lastFrontCursor||!this._lastBackCursor||this.frontCursor.i!==this._lastFrontCursor.i||this._lastBackCursor.i!==this.backCursor.i,s=this.scroll.x!==this._lastScrollX||this.scroll.y!==this._lastScrollY,a=(this.context.font!==this._lastFont,this.theme.name!==this._lastThemeName),u=this.focused!==this._lastFocused,c=null,h=this.resized||t||e||n||i||r,l=h||o||s||a,f=l||e,d=l||u,m=f||l||d;if(h&&(this.performLayout(this.gridBounds),this._rowCache={}),m){if(o&&!(h||s||a||u)){var p=Math.min(this.frontCursor.y,this._lastFrontCursor.y,this.backCursor.y,this._lastBackCursor.y)-this.scroll.y+this.gridBounds.y,y=Math.max(this.frontCursor.y,this._lastFrontCursor.y,this.backCursor.y,this._lastBackCursor.y)-this.scroll.y+1;c=new Primrose.Text.Rectangle(0,p*this.character.height,this.bounds.width,(y-p)*this.character.height+2)}l&&this.renderCanvasBackground(),f&&this.renderCanvasForeground(),d&&this.renderCanvasTrim(),this.context.clearRect(0,0,this.imageWidth,this.imageHeight),this.context.drawImage(this._bgCanvas,0,0),this.context.drawImage(this._fgCanvas,0,0),this.context.drawImage(this._trimCanvas,0,0),this.invalidate(c)}this._lastGridBounds=this.gridBounds.toString(),this._lastText=this.value,this._lastCharacterWidth=this.character.width,this._lastCharacterHeight=this.character.height,this._lastWidth=this.imageWidth,this._lastHeight=this.imageHeight,this._lastPadding=this.padding,this._lastFrontCursor=this.frontCursor.clone(),this._lastBackCursor=this.backCursor.clone(),this._lastFocused=this.focused,this._lastFont=this.context.font,this._lastThemeName=this.theme.name,this._lastScrollX=this.scroll.x,this._lastScrollY=this.scroll.y}}},{key:"value",get:function(){return this._history[this._historyFrame].join("\n")},set:function(t){t=t||"",t=t.replace(/\r\n/g,"\n"),this.multiline||(t=t.replace(/\n/g,""));var e=t.split("\n");this.pushUndo(e),this.render(),emit.call(this,"change",{target:this})}},{key:"selectedText",get:function(){var t=Primrose.Text.Cursor.min(this.frontCursor,this.backCursor),e=Primrose.Text.Cursor.max(this.frontCursor,this.backCursor);return this.value.substring(t.i,e.i)},set:function(t){if(t=t||"",t=t.replace(/\r\n/g,"\n"),this.frontCursor.i!==this.backCursor.i||t.length>0){var e=Primrose.Text.Cursor.min(this.frontCursor,this.backCursor),n=Primrose.Text.Cursor.max(this.frontCursor,this.backCursor),i=this.value,r=i.substring(0,e.i),o=i.substring(n.i),s=r+t+o;this.value=s,this.refreshGridBounds(),this.performLayout(),e.advanceN(this.lines,Math.max(0,t.length)),this.scrollIntoView(n),this.clampScroll(),n.copy(e),this.render()}}},{key:"padding",get:function(){return this._padding},set:function(t){this._padding=t,this.render()}},{key:"wordWrap",get:function(){return this._wordWrap},set:function(t){this._wordWrap=t||!1,this.setGutter()}},{key:"showLineNumbers",get:function(){return this._showLineNumbers},set:function(t){this._showLineNumbers=t,this.setGutter()}},{key:"showScrollBars",get:function(){return this._showScrollBars},set:function(t){this._showScrollBars=t,this.setGutter()}},{key:"theme",get:function(){return this._theme},set:function(t){this._theme=clone(t||Primrose.Text.Themes.Default),this._theme.fontSize=this.fontSize,this._rowCache={},this.render()}},{key:"commandPack",get:function(){return this._commandPack},set:function(t){this._commandPack=t}},{key:"selectionStart",get:function(){return this.frontCursor.i},set:function(t){this.frontCursor.setI(t,this.lines)}},{key:"selectionEnd",get:function(){return this.backCursor.i},set:function(t){this.backCursor.setI(t,this.lines)}},{key:"selectionDirection",get:function(){return this.frontCursor.i<=this.backCursor.i?"forward":"backward"}},{key:"tokenizer",get:function(){return this._tokenizer},set:function(t){this._tokenizer=t||Primrose.Text.Grammars.JavaScript,this._history&&this._history.length>0&&(this.refreshTokens(),this.render())}},{key:"tabWidth",get:function(){return this._tabWidth},set:function(t){this._tabWidth=t||2,this._tabString="";for(var e=0;e<this._tabWidth;++e)this._tabString+=" "}},{key:"tabString",get:function(){return this._tabString}},{key:"fontSize",get:function(){return this._fontSize||16},set:function(t){t=t||16,this._fontSize=t,this.theme&&(this.theme.fontSize=this._fontSize,this.resize(),this.render())}},{key:"lockMovement",get:function(){return this.focused&&!this.readOnly}}]),c}(Primrose.Surface);window.Primrose.Text.Controls.TextBox=u}(),function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=function t(e,n,i,r){var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var s=Object.getPrototypeOf(e);null!==s&&t(s,n,i,r)}else if("value"in o&&o.writable)o.value=i;else{var a=o.set;void 0!==a&&a.call(r,i)}return i},o=function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,i)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(i)},s=0,a=function(a){function u(n){t(this,u);var i=e(this,Object.getPrototypeOf(u).call(this,copyObject(patch(n,{id:"Primrose.Text.Controls.TextInput["+s++ +"]",padding:5}),{singleLine:!0,
disableWordWrap:!0,hideLineNumbers:!0,hideScrollBars:!0,tabWidth:1,tokenizer:Primrose.Text.Grammars.PlainText,commands:Primrose.Text.CommandPacks.TextInput},!0)));return i.passwordCharacter=i.options.passwordCharacter,i}return n(u,a),i(u,[{key:"drawText",value:function(t,e,n,i){if(this.passwordCharacter){for(var r="",s=0;s<e.length;++s)r+=this.passwordCharacter;e=r}o(Object.getPrototypeOf(u.prototype),"drawText",this).call(this,t,e,n,i)}},{key:"value",get:function(){return o(Object.getPrototypeOf(u.prototype),"value",this)},set:function(t){t=t||"",t=t.replace(/\r?\n/g,""),r(Object.getPrototypeOf(u.prototype),"value",t,this)}},{key:"selectedText",get:function(){return o(Object.getPrototypeOf(u.prototype),"selectedText",this)},set:function(t){t=t||"",t=t.replace(/\r?\n/g,""),r(Object.getPrototypeOf(u.prototype),"selectedText",t,this)}}]),u}(Primrose.Text.Controls.TextBox);window.Primrose.Text.Controls.TextInput=a}(),function(){"use strict";var Basic=new Primrose.Text.Grammar("BASIC",[["newlines",/(?:\r\n|\r|\n)/],["lineNumbers",/^\d+\s+/],["startLineComments",/^REM\s/],["strings",/"(?:\\"|[^"])*"/],["strings",/'(?:\\'|[^'])*'/],["numbers",/-?(?:(?:\b\d*)?\.)?\b\d+\b/],["keywords",/\b(?:RESTORE|REPEAT|RETURN|LOAD|LABEL|DATA|READ|THEN|ELSE|FOR|DIM|LET|IF|TO|STEP|NEXT|WHILE|WEND|UNTIL|GOTO|GOSUB|ON|TAB|AT|END|STOP|PRINT|INPUT|RND|INT|CLS|CLK|LEN)\b/],["keywords",/^DEF FN/],["operators",/(?:\+|;|,|-|\*\*|\*|\/|>=|<=|=|<>|<|>|OR|AND|NOT|MOD|\(|\)|\[|\])/],["identifiers",/\w+\$?/]]),oldTokenize=Basic.tokenize;Basic.tokenize=function(t){return oldTokenize.call(this,t.toUpperCase())},Basic.interpret=function(sourceCode,input,output,errorOut,next,clearScreen,loadFile,done){function toNum(t){return new Primrose.Text.Token(t.toString(),"numbers")}function toStr(t){return new Primrose.Text.Token('"'+t.replace("\n","\\n").replace('"','\\"')+'"',"strings")}function process(t){if(t&&t.length>0){var e=t.shift();if(e){if(commands.hasOwnProperty(e.value))return commands[e.value](t);if(!isNaN(e.value))return setProgramCounter([e]);if(state[e.value]||t.length>0&&"operators"===t[0].type&&"="===t[0].value)return t.unshift(e),translate(t);error("Unknown command. >>> "+e.value)}}return pauseBeforeComplete()}function error(t){errorOut("At line "+lineNumbers[counter]+": "+t)}function getLine(t){var e=lineNumbers[t],n=program[e];return n&&n.slice()}function evaluate(line){for(var script="",i=0;i<line.length;++i){var t=line[i],nest=0;if("identifiers"===t.type&&"function"!=typeof state[t.value]&&i<line.length-1&&"("===line[i+1].value)for(var j=i+1;j<line.length;++j){var t2=line[j];if("("===t2.value?(0===nest&&(t2.value="["),++nest):")"===t2.value?(--nest,0===nest&&(t2.value="]")):","===t2.value&&1===nest&&(t2.value="]["),0===nest)break}script+=t.value}try{return eval(script)}catch(t){console.error(t),console.debug(line.join(", ")),console.error(script),error(t.message+": "+script)}}function declareVariable(t){var e,n=[],i=[n],r=0;for(e=0;e<t.length;++e){var o=t[e];"("===o.value?++r:")"===o.value&&--r,0===r&&","===o.value?(n=[],i.push(n)):n.push(o)}for(e=0;e<i.length;++e){n=i[e];var s=n.shift();if("identifiers"===s.type){var a,u=null;if(s=s.value,"("===n[0].value&&")"===n[n.length-1].value){var c=[];for(a=1;a<n.length-1;++a)"numbers"===n[a].type&&c.push(0|n[a].value);if(0===c.length)u=[];else{u=new Array(c[0]);var h=[u];for(a=1;a<c.length;++a)for(var l=c[a],f=0,d=h.length;f<d;++f)for(var m=h.shift(),p=0;p<m.length;++p)m[p]=new Array(l),a<c.length-1&&h.push(m[p])}}return state[s]=u,!0}error("Identifier expected: "+s.value)}}function print(t){var e="\n",n=0;t=t.map(function(i,r){return i=i.clone(),"operators"===i.type&&(","===i.value?0===n&&(i.value='+ ", " + '):";"===i.value?(i.value='+ " "',r<t.length-1?i.value+=" + ":e=""):"("===i.value?++n:")"===i.value&&--n),i});var i=evaluate(t);return void 0===i&&(i=""),output(i+e),!0}function setProgramCounter(t){var e=parseFloat(evaluate(t));for(counter=-1;counter<lineNumbers.length-1&&lineNumbers[counter+1]<e;)++counter;return!0}function checkConditional(t){var e,n=-1,i=-1;for(e=0;e<t.length;++e)"keywords"===t[e].type&&"THEN"===t[e].value?n=e:"keywords"===t[e].type&&"ELSE"===t[e].value&&(i=e);if(n===-1)error("Expected THEN clause.");else{var r=t.slice(0,n);for(e=0;e<r.length;++e){var o=r[e];"operators"===o.type&&"="===o.value&&(o.value="==")}var s,a;if(i===-1?s=t.slice(n+1):(s=t.slice(n+1,i),a=t.slice(i+1)),evaluate(r))return process(s);if(a)return process(a)}return!0}function pauseBeforeComplete(){return output("PROGRAM COMPLETE - PRESS RETURN TO FINISH."),input(function(){isDone=!0,done&&done()}),!1}function labelLine(t){return t.push(EQUAL_SIGN),t.push(toNum(lineNumbers[counter])),translate(t)}function waitForInput(t){var e=t.pop();return t.length>0&&print(t),input(function(t){t=t.toUpperCase();var n=null;n=isNaN(t)?toStr(t):toNum(t),evaluate([e,EQUAL_SIGN,n]),next&&next()}),!1}function onStatement(t){var e=[],n=null,i=[];try{for(;t.length>0&&("keywords"!==t[0].type||"GOTO"!==t[0].value);)e.push(t.shift());if(t.length>0){t.shift();for(var r=0;r<t.length;++r){var o=t[r];"operators"===o.type&&","===o.value||i.push(o)}if(n=evaluate(e)-1,0<=n&&n<i.length)return setProgramCounter([i[n]])}}catch(t){console.error(t)}return!0}function gotoSubroutine(t){return returnStack.push(toNum(lineNumbers[counter+1])),setProgramCounter(t)}function setRepeat(){return returnStack.push(toNum(lineNumbers[counter])),!0}function conditionalReturn(t){var e=!0,n=returnStack.pop();return n&&t&&(e=setProgramCounter([n])),e}function untilLoop(t){var e=!evaluate(t);return conditionalReturn(e)}function findNext(t){for(i=counter+1;i<lineNumbers.length;++i){var e=getLine(i);if(e[0].value===t)return i}return lineNumbers.length}function whileLoop(t){var e=evaluate(t);return e?returnStack.push(toNum(lineNumbers[counter])):counter=findNext("WEND"),!0}function forLoop(t){var e=lineNumbers[counter],n=[],i=[],r=[],o=[],s=[n,i,r,o],a=0,u=0;for(u=0;u<t.length;++u){var c=t[u];c.value===FOR_LOOP_DELIMS[a]?(0===a&&n.push(c),++a):s[a].push(c)}var h=1;o.length>0&&(h=evaluate(o)),void 0===forLoopCounters[e]&&(forLoopCounters[e]=evaluate(i));var l=evaluate(r),f=forLoopCounters[e]<=l;return f?(n.push(toNum(forLoopCounters[e])),process(n),forLoopCounters[e]+=h,returnStack.push(toNum(lineNumbers[counter]))):(delete forLoopCounters[e],counter=findNext("NEXT")),!0}function stackReturn(){return conditionalReturn(!0)}function loadCodeFile(t){return loadFile(evaluate(t)).then(next),!1}function noop(){return!0}function loadData(t){for(;t.length>0;){var e=t.shift();"operators"!==e.type&&data.push(e.value)}return!0}function readData(t){if(0===data.length){var e=findNext("DATA");process(getLine(e))}var n=data[dataCounter];return++dataCounter,t.push(EQUAL_SIGN),t.push(toNum(n)),translate(t)}function restoreData(){return dataCounter=0,!0}function defineFunction(line){for(var name=line.shift().value,signature="",body="",fillSig=!0,i=0;i<line.length;++i){var t=line[i];"operators"===t.type&&"="===t.value?fillSig=!1:fillSig?signature+=t.value:body+=t.value}name="FN"+name;var script="(function "+name+signature+"{ return "+body+"; })";return state[name]=eval(script),!0}function translate(t){return evaluate(t),!0}for(var tokens=this.tokenize(sourceCode),EQUAL_SIGN=new Primrose.Text.Token("=","operators"),counter=0,isDone=!1,program={},lineNumbers=[],currentLine=[],lines=[currentLine],data=[],returnStack=[],forLoopCounters={},dataCounter=0,state={INT:function(t){return 0|t},RND:function(){return Math.random()},CLK:function(){return Date.now()/36e5},LEN:function(t){return t.length},LINE:function(){return lineNumbers[counter]},TAB:function(t){for(var e="",n=0;n<t;++n)e+=" ";return e},POW:function(t,e){return Math.pow(t,e)}},tokenMap={OR:"||",AND:"&&",NOT:"!",MOD:"%","<>":"!="};tokens.length>0;){var token=tokens.shift();"newlines"===token.type?(currentLine=[],lines.push(currentLine)):"regular"!==token.type&&"comments"!==token.type&&(token.value=tokenMap[token.value]||token.value,currentLine.push(token))}for(var i=0;i<lines.length;++i){var line=lines[i];if(line.length>0){var lastLine=lineNumbers[lineNumbers.length-1],lineNumber=line.shift();if("lineNumbers"!==lineNumber.type&&(line.unshift(lineNumber),void 0===lastLine&&(lastLine=-1),lineNumber=toNum(lastLine+1)),lineNumber=parseFloat(lineNumber.value),lastLine&&lineNumber<=lastLine)throw new Error("expected line number greater than "+lastLine+", but received "+lineNumber+".");line.length>0&&(lineNumbers.push(lineNumber),program[lineNumber]=line)}}var FOR_LOOP_DELIMS=["=","TO","STEP"],commands={DIM:declareVariable,LET:translate,PRINT:print,GOTO:setProgramCounter,IF:checkConditional,INPUT:waitForInput,END:pauseBeforeComplete,STOP:pauseBeforeComplete,REM:noop,"'":noop,CLS:clearScreen,ON:onStatement,GOSUB:gotoSubroutine,RETURN:stackReturn,LOAD:loadCodeFile,DATA:loadData,READ:readData,RESTORE:restoreData,REPEAT:setRepeat,UNTIL:untilLoop,"DEF FN":defineFunction,WHILE:whileLoop,WEND:stackReturn,FOR:forLoop,NEXT:stackReturn,LABEL:labelLine};return function(){if(!isDone)for(var t=!0;t;){var e=getLine(counter);t=process(e),++counter}}},window.Primrose.Text.Grammars.Basic=Basic}(),function(){"use strict";var t=new Primrose.Text.Grammar("JavaScript",[["newlines",/(?:\r\n|\r|\n)/],["startBlockComments",/\/\*/],["endBlockComments",/\*\//],["regexes",/(?:^|,|;|\(|\[|\{)(?:\s*)(\/(?:\\\/|[^\n\/])+\/)/],["stringDelim",/("|')/],["startLineComments",/\/\/.*$/m],["numbers",/-?(?:(?:\b\d*)?\.)?\b\d+\b/],["keywords",/\b(?:break|case|catch|const|continue|debugger|default|delete|do|else|export|finally|for|function|if|import|in|instanceof|let|new|return|super|switch|this|throw|try|typeof|var|void|while|with)\b/],["functions",/(\w+)(?:\s*\()/],["members",/(\w+)\./],["members",/((\w+\.)+)(\w+)/]]);window.Primrose.Text.Grammars.JavaScript=t}(),function(){"use strict";var t=new Primrose.Text.Grammar("PlainText",[["newlines",/(?:\r\n|\r|\n)/]]);window.Primrose.Text.Grammars.PlainText=t}(),function(){"use strict";var t=new Primrose.Text.Grammar("TestResults",[["newlines",/(?:\r\n|\r|\n)/,!0],["numbers",/(\[)(o+)/,!0],["numbers",/(\d+ succeeded), 0 failed/,!0],["numbers",/^    Successes:/,!0],["functions",/(x+)\]/,!0],["functions",/[1-9]\d* failed/,!0],["functions",/^    Failures:/,!0],["comments",/(\d+ms:)(.*)/,!0],["keywords",/(Test results for )(\w+):/,!0],["strings",/        \w+/,!0]]);window.Primrose.Text.Grammars.TestResults=t}(),function(){"use strict";var t=new Primrose.Text.OperatingSystem("OS X","META","ALT","METASHIFT_z","META","LEFTARROW","RIGHTARROW","META","UPARROW","DOWNARROW");window.Primrose.Text.OperatingSystems.OSX=t}(),function(){"use strict";var t=new Primrose.Text.OperatingSystem("Windows","CTRL","CTRL","CTRL_y","","HOME","END","CTRL","HOME","END");window.Primrose.Text.OperatingSystems.Windows=t}(),function(){"use strict";var t={name:"Dark",fontFamily:"'Droid Sans Mono', 'Consolas', 'Lucida Console', 'Courier New', 'Courier', monospace",cursorColor:"white",fontSize:16,lineNumbers:{foreColor:"white"},regular:{backColor:"black",foreColor:"#c0c0c0",currentRowBackColor:"#202020",selectedBackColor:"#404040",unfocused:"rgba(0, 0, 255, 0.25)"},strings:{foreColor:"#aa9900",fontStyle:"italic"},regexes:{foreColor:"#aa0099",fontStyle:"italic"},numbers:{foreColor:"green"},comments:{foreColor:"yellow",fontStyle:"italic"},keywords:{foreColor:"cyan"},functions:{foreColor:"brown",fontWeight:"bold"},members:{foreColor:"green"},error:{foreColor:"red",fontStyle:"underline italic"}};window.Primrose.Text.Themes.Dark=t}(),function(){"use strict";var t={name:"Light",fontFamily:"'Droid Sans Mono', 'Consolas', 'Lucida Console', 'Courier New', 'Courier', monospace",cursorColor:"black",fontSize:16,lineNumbers:{foreColor:"black"},regular:{backColor:"white",foreColor:"black",currentRowBackColor:"#f0f0f0",selectedBackColor:"#c0c0c0",unfocused:"rgba(0, 0, 255, 0.25)"},strings:{foreColor:"#aa9900",fontStyle:"italic"},regexes:{foreColor:"#aa0099",fontStyle:"italic"},numbers:{foreColor:"green"},comments:{foreColor:"grey",fontStyle:"italic"},keywords:{foreColor:"blue"},functions:{foreColor:"brown",fontWeight:"bold"},members:{foreColor:"green"},error:{foreColor:"red",fontStyle:"underline italic"}};window.Primrose.Text.Themes.Default=t}(),function(){"use strict";function t(t,e){var n=this.toString(e);n!==this.lastVal&&(this.lastVal=n,console.log(t+"\n"+n))}window.THREE.Matrix4.prototype.debug=t}(),function(){"use strict";function t(t){this.transpose();var e=this.toArray();void 0!==t&&(e=e.map(function(e){return e.toFixed(t)}));for(var n="",i=0;i<e.length;++i)i%4===0&&(n+="| "),n+=e[i],n+=i%4===3?" |\n":", ";return this.transpose(),n}window.THREE.Matrix4.prototype.toString=t}(),function(){"use strict";function t(t,e){var n=this;e.add(this),this.appendChild=function(e){return e.addToBrowserEnvironment?e.addToBrowserEnvironment(t,n):(n.add(e),t.registerPickableObject(e),e)}}window.THREE.Object3D.prototype.addToBrowserEnvironment=t}(),function(){"use strict";function t(t,e){var n=this.toString(e);n!==this.lastVal&&(this.lastVal=n,console.log(t,n))}window.THREE.Quaternion.prototype.debug=t}(),function(){"use strict";function t(t){var e=this.toArray();if(void 0!==t)for(var n=0;n<e.length;++n)null!==e[n]&&void 0!==e[n]?e[n]=e[n].toFixed(t):e[n]="undefined";return"{"+e.join(", ")+"}"}window.THREE.Quaternion.prototype.toString=t}(),function(){"use strict";function t(t,e){var n=this.toString(e);n!==this.lastVal&&(this.lastVal=n,console.log(t,n))}window.THREE.Vector3.prototype.debug=t}(),function(){"use strict";function t(t){var e=this.toArray();return void 0!==t&&(e=e.map(function(e){return e.toFixed(t)})),"<"+e.join(", ")+">"}window.THREE.Vector3.prototype.toString=t}();